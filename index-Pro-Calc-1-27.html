<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="description" content="Essential wastewater treatment calculations for operators">
    <meta name="author" content="Armand Frazier Sr.">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="WW Pro-Calc">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>WW Operator Pro-Calc</title>
    <style>
        :root {
            --bg: #0f172a; --card: #1e293b; --text: #f8fafc;
            --primary: #3b82f6; --accent: #f59e0b; --danger: #ef4444;
            --success: #10b981; --card-header: #334155;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            padding: 15px; 
            padding-top: env(safe-area-inset-top, 15px);
            padding-bottom: calc(80px + env(safe-area-inset-bottom, 15px));
            margin: 0; 
            min-height: 100vh;
        }
        .container { max-width: 600px; margin: auto; }
        
        /* Header */
        header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px;
            position: sticky;
            top: 0;
            background: var(--bg);
            padding: 10px 0;
            z-index: 100;
        }
        h1 { font-size: 1.3rem; color: var(--primary); margin: 0; }
        .btn-clear { 
            background: var(--danger); 
            color: white; 
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
        }
        .btn-refresh {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
        }
        .btn-refresh:active { background: #1d4ed8; }

        /* Accordion Cards */
        .card { 
            background: var(--card); 
            border-radius: 12px; 
            margin-bottom: 10px; 
            border-left: 4px solid var(--primary); 
            overflow: hidden;
        }
        .card.accent { border-left-color: var(--accent); }
        .card.success { border-left-color: var(--success); }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 18px;
            background: var(--card-header);
            cursor: pointer;
            user-select: none;
        }
        .card-header:active { background: #3d4a5c; }
        .card-header h2 { 
            font-size: 1rem; 
            margin: 0; 
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card-num {
            background: var(--primary);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            flex-shrink: 0;
        }
        .card.accent .card-num { background: var(--accent); }
        .card.success .card-num { background: var(--success); }
        
        .chevron {
            width: 20px;
            height: 20px;
            transition: transform 0.3s ease;
            color: #94a3b8;
            flex-shrink: 0;
        }
        .card.open .chevron { transform: rotate(180deg); }
        
        .card-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .card.open .card-body { max-height: 1000px; }
        .card-content { padding: 18px; padding-top: 10px; }

        /* Form Elements */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        label { font-size: 0.8rem; color: #94a3b8; display: block; margin-bottom: 4px; }
        input { 
            width: 100%; 
            padding: 12px; 
            border-radius: 6px; 
            border: 2px solid #334155; 
            background: #0f172a; 
            color: white; 
            box-sizing: border-box; 
            font-size: 16px;
            transition: border-color 0.2s;
        }
        input:focus { outline: none; border-color: var(--primary); }
        input.error { border-color: var(--danger); animation: shake 0.3s; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .field-hint { font-size: 0.7rem; color: #64748b; display: block; margin-top: 3px; }
        .field-hint.error { color: var(--danger); font-weight: bold; }
        
        .input-help { 
            font-size: 0.8rem; 
            color: #94a3b8; 
            margin-bottom: 12px; 
            padding: 8px; 
            background: rgba(59, 130, 246, 0.1); 
            border-radius: 6px; 
            border-left: 3px solid var(--primary); 
        }
        .example-box { 
            font-size: 0.75rem; 
            color: #94a3b8; 
            margin: 10px 0; 
            padding: 8px; 
            background: rgba(245, 158, 11, 0.1); 
            border-radius: 6px; 
            border-left: 3px solid var(--accent); 
        }

        /* Results */
        .result-box { 
            background: #334155; 
            padding: 15px; 
            border-radius: 8px; 
            text-align: center; 
        }
        .val { display: block; font-size: 1.5rem; font-weight: bold; color: var(--accent); }
        .status { 
            font-size: 0.85rem; 
            margin-top: 8px; 
            color: #cbd5e1; 
            line-height: 1.4; 
            text-align: left; 
            padding: 0 5px; 
        }
        .btn-copy { 
            background: var(--primary); 
            color: white; 
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-top: 10px;
            cursor: pointer;
        }
        .btn-copy:active { background: #2563eb; }
        .formula-note { 
            font-size: 0.7rem; 
            color: #64748b; 
            margin-top: 10px; 
            text-align: center; 
            font-style: italic; 
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card);
            border-top: 1px solid #334155;
            padding: 6px 0;
            padding-bottom: calc(6px + env(safe-area-inset-bottom, 0px));
            z-index: 1000;
        }
        .nav-scroll {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            padding: 0 5px;
            gap: 2px;
        }
        .nav-scroll::-webkit-scrollbar { display: none; }
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            background: none;
            border: none;
            color: #64748b;
            font-size: 0.55rem;
            padding: 4px 6px;
            border-radius: 8px;
            cursor: pointer;
            min-width: 42px;
            flex-shrink: 0;
            scroll-snap-align: start;
        }
        .nav-btn:active, .nav-btn.active { 
            color: var(--primary); 
            background: rgba(59, 130, 246, 0.1);
        }
        .nav-icon {
            width: 18px;
            height: 18px;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #334155;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 0.9rem;
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }

        /* Install Prompt */
        .install-prompt {
            display: none;
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            font-size: 0.85rem;
            align-items: center;
            gap: 10px;
        }
        .install-prompt button { 
            background: white; 
            color: var(--primary); 
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-weight: bold;
            cursor: pointer;
        }

        .version { 
            font-size: 0.7rem; 
            color: #475569; 
            text-align: center; 
            padding: 15px 0; 
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>WW Pro-Calc</h1>
        <div style="display: flex; gap: 8px;">
            <button class="btn-refresh" onclick="refreshApp()" title="Check for updates">‚Üª</button>
            <button class="btn-clear" onclick="clearAll()">Clear All</button>
        </div>
    </header>

    <!-- 1. Pounds Formula -->
    <div class="card open" id="card1" data-calc="pounds">
        <div class="card-header" onclick="toggleCard(1)">
            <h2><span class="card-num">1</span> Pounds Formula</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Convert concentration to mass loading. Use for BOD, TSS, ammonia, phosphorus.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="p_flow" oninput="calcPounds()" placeholder="1.5">
                        <span class="field-hint">Million gallons per day</span>
                    </div>
                    <div>
                        <label>Concentration (mg/L)</label>
                        <input type="number" inputmode="decimal" id="p_conc" oninput="calcPounds()" placeholder="200">
                        <span class="field-hint">Lab result</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="p_res">0.00 lbs/day</span>
                    <div id="p_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('p_res')">Copy Result</button>
                </div>
                <div class="formula-note">Flow √ó Conc √ó 8.34</div>
            </div>
        </div>
    </div>

    <!-- 2. SVI -->
    <div class="card" id="card2" data-calc="svi">
        <div class="card-header" onclick="toggleCard(2)">
            <h2><span class="card-num">2</span> SVI ‚Äì Sludge Volume Index</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Measures sludge settleability. Perform 30-min settleometer test.</div>
                <div class="grid">
                    <div>
                        <label>30-min Settled (mL/L)</label>
                        <input type="number" inputmode="decimal" id="svi_set" oninput="calcSVI()" placeholder="250">
                        <span class="field-hint" id="svi_set_hint">Max 1000 mL/L</span>
                    </div>
                    <div>
                        <label>MLSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="svi_mlss" oninput="calcSVI()" placeholder="2500">
                        <span class="field-hint">From lab</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="svi_res">0.00 mL/g</span>
                    <div id="svi_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('svi_res')">Copy Result</button>
                </div>
                <div class="formula-note">(Settled Vol √ó 1000) √∑ MLSS</div>
            </div>
        </div>
    </div>

    <!-- 3. Mass Balance -->
    <div class="card accent" id="card3" data-calc="mass">
        <div class="card-header" onclick="toggleCard(3)">
            <h2><span class="card-num">3</span> Mass Balance</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Calculate mixed concentration when two flows combine (RAS + Influent, blending).</div>
                <div class="grid">
                    <div>
                        <label>Stream A ‚Äì Flow</label>
                        <input type="number" inputmode="decimal" id="mb_qa" oninput="calcMB()" placeholder="1.0">
                        <span class="field-hint">Any flow unit</span>
                    </div>
                    <div>
                        <label>Stream A ‚Äì Conc</label>
                        <input type="number" inputmode="decimal" id="mb_ca" oninput="calcMB()" placeholder="200">
                        <span class="field-hint">mg/L</span>
                    </div>
                    <div>
                        <label>Stream B ‚Äì Flow</label>
                        <input type="number" inputmode="decimal" id="mb_qb" oninput="calcMB()" placeholder="0.5">
                        <span class="field-hint">Same unit as A</span>
                    </div>
                    <div>
                        <label>Stream B ‚Äì Conc</label>
                        <input type="number" inputmode="decimal" id="mb_cb" oninput="calcMB()" placeholder="8000">
                        <span class="field-hint">mg/L</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="mb_res">0.00 mg/L</span>
                    <div id="mb_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('mb_res')">Copy Result</button>
                </div>
                <div class="formula-note">(Q‚ÇÅ√óC‚ÇÅ + Q‚ÇÇ√óC‚ÇÇ) √∑ (Q‚ÇÅ + Q‚ÇÇ)</div>
            </div>
        </div>
    </div>

    <!-- 4. F/M Ratio -->
    <div class="card success" id="card4" data-calc="fm">
        <div class="card-header" onclick="toggleCard(4)">
            <h2><span class="card-num">4</span> F/M Ratio</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Food to Microorganism ratio. Key process control parameter.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="fm_flow" oninput="calcFM()" placeholder="1.5">
                        <span class="field-hint">Influent flow</span>
                    </div>
                    <div>
                        <label>BOD (mg/L)</label>
                        <input type="number" inputmode="decimal" id="fm_bod" oninput="calcFM()" placeholder="200">
                        <span class="field-hint">Influent BOD‚ÇÖ</span>
                    </div>
                    <div>
                        <label>Aeration Vol (MG)</label>
                        <input type="number" inputmode="decimal" id="fm_vol" oninput="calcFM()" placeholder="0.5">
                        <span class="field-hint">Million gallons</span>
                    </div>
                    <div>
                        <label>MLVSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="fm_mlvss" oninput="calcFM()" placeholder="2000">
                        <span class="field-hint">Or MLSS √ó 0.75</span>
                    </div>
                </div>
                <div class="example-box"><b>Tip:</b> MLVSS ‚âà MLSS √ó 0.75 if not measured directly</div>
                <div class="result-box">
                    <span class="val" id="fm_res">0.000</span>
                    <div id="fm_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('fm_res')">Copy Result</button>
                </div>
                <div class="formula-note">(Flow √ó BOD √ó 8.34) √∑ (Vol √ó MLVSS √ó 8.34)</div>
            </div>
        </div>
    </div>

    <!-- 5. SRT -->
    <div class="card success" id="card5" data-calc="srt">
        <div class="card-header" onclick="toggleCard(5)">
            <h2><span class="card-num">5</span> SRT ‚Äì Sludge Age</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Solids Retention Time. Critical for nitrification (need >8 days).</div>
                <div class="grid">
                    <div>
                        <label>Aeration Vol (MG)</label>
                        <input type="number" inputmode="decimal" id="srt_vol" oninput="calcSRT()" placeholder="0.5">
                        <span class="field-hint">Basin volume</span>
                    </div>
                    <div>
                        <label>MLSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="srt_mlss" oninput="calcSRT()" placeholder="3000">
                        <span class="field-hint">In aeration</span>
                    </div>
                    <div>
                        <label>WAS Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="srt_wasq" oninput="calcSRT()" placeholder="0.015">
                        <span class="field-hint">Waste sludge flow</span>
                    </div>
                    <div>
                        <label>WAS Conc (mg/L)</label>
                        <input type="number" inputmode="decimal" id="srt_wasc" oninput="calcSRT()" placeholder="8000">
                        <span class="field-hint">WAS or RAS conc</span>
                    </div>
                    <div>
                        <label>Effluent Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="srt_effq" oninput="calcSRT()" placeholder="1.5">
                        <span class="field-hint">Discharge flow</span>
                    </div>
                    <div>
                        <label>Effluent TSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="srt_effc" oninput="calcSRT()" placeholder="10">
                        <span class="field-hint">Solids over weirs</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="srt_res">0.0 days</span>
                    <div id="srt_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('srt_res')">Copy Result</button>
                </div>
                <div class="formula-note">Solids in System √∑ Solids Out per Day</div>
            </div>
        </div>
    </div>

    <!-- 6. Detention Time -->
    <div class="card success" id="card6" data-calc="dt">
        <div class="card-header" onclick="toggleCard(6)">
            <h2><span class="card-num">6</span> Detention Time</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Hydraulic retention time in any tank or process.</div>
                <div class="grid">
                    <div>
                        <label>Volume (gallons)</label>
                        <input type="number" inputmode="decimal" id="dt_vol" oninput="calcDT()" placeholder="500000">
                        <span class="field-hint">Tank volume</span>
                    </div>
                    <div>
                        <label>Flow (GPD)</label>
                        <input type="number" inputmode="decimal" id="dt_flow" oninput="calcDT()" placeholder="1500000">
                        <span class="field-hint">Gallons per day</span>
                    </div>
                </div>
                <div class="example-box"><b>Volume:</b> Rect = L√óW√óD√ó7.48 | Circ = 0.785√óD¬≤√óH√ó7.48</div>
                <div class="result-box">
                    <span class="val" id="dt_res">0.00 hours</span>
                    <div id="dt_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('dt_res')">Copy Result</button>
                </div>
                <div class="formula-note">(Volume √∑ Flow) √ó 24</div>
            </div>
        </div>
    </div>

    <!-- 7. Removal Efficiency -->
    <div class="card success" id="card7" data-calc="eff">
        <div class="card-header" onclick="toggleCard(7)">
            <h2><span class="card-num">7</span> Removal Efficiency</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Percent removal for BOD, TSS, ammonia, or any parameter.</div>
                <div class="grid">
                    <div>
                        <label>Influent (mg/L)</label>
                        <input type="number" inputmode="decimal" id="eff_in" oninput="calcEff()" placeholder="200">
                        <span class="field-hint">Before treatment</span>
                    </div>
                    <div>
                        <label>Effluent (mg/L)</label>
                        <input type="number" inputmode="decimal" id="eff_out" oninput="calcEff()" placeholder="15">
                        <span class="field-hint">After treatment</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="eff_res">0.0 %</span>
                    <div id="eff_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('eff_res')">Copy Result</button>
                </div>
                <div class="formula-note">(In - Out) √∑ In √ó 100</div>
            </div>
        </div>
    </div>

    <!-- 8. WAS Pumping Rate -->
    <div class="card" id="card8" data-calc="was">
        <div class="card-header" onclick="toggleCard(8)">
            <h2><span class="card-num">8</span> WAS Pumping Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Calculate required WAS flow to achieve target SRT. Solve for wasting rate.</div>
                <div class="grid">
                    <div>
                        <label>Aeration Vol (MG)</label>
                        <input type="number" inputmode="decimal" id="was_vol" oninput="calcWAS()" placeholder="0.5">
                        <span class="field-hint">Basin volume</span>
                    </div>
                    <div>
                        <label>MLSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="was_mlss" oninput="calcWAS()" placeholder="3000">
                        <span class="field-hint">In aeration</span>
                    </div>
                    <div>
                        <label>Target SRT (days)</label>
                        <input type="number" inputmode="decimal" id="was_srt" oninput="calcWAS()" placeholder="10">
                        <span class="field-hint">Desired sludge age</span>
                    </div>
                    <div>
                        <label>WAS Conc (mg/L)</label>
                        <input type="number" inputmode="decimal" id="was_conc" oninput="calcWAS()" placeholder="8000">
                        <span class="field-hint">WAS/RAS solids</span>
                    </div>
                </div>
                <div class="example-box"><b>Note:</b> This simplified calc ignores effluent TSS loss. For precise SRT, account for solids over weirs.</div>
                <div class="result-box">
                    <span class="val" id="was_res">0 GPD</span>
                    <div id="was_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('was_res')">Copy Result</button>
                </div>
                <div class="formula-note">WAS Flow = (Vol √ó MLSS) √∑ (SRT √ó WAS Conc)</div>
            </div>
        </div>
    </div>

    <!-- 9. RAS Return Rate -->
    <div class="card" id="card9" data-calc="ras">
        <div class="card-header" onclick="toggleCard(9)">
            <h2><span class="card-num">9</span> RAS Return Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Calculate RAS flow rate based on sludge blanket or settleability method.</div>
                <div class="grid">
                    <div>
                        <label>Influent Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="ras_flow" oninput="calcRAS()" placeholder="1.5">
                        <span class="field-hint">Plant flow</span>
                    </div>
                    <div>
                        <label>MLSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="ras_mlss" oninput="calcRAS()" placeholder="3000">
                        <span class="field-hint">In aeration</span>
                    </div>
                    <div>
                        <label>RAS Conc (mg/L)</label>
                        <input type="number" inputmode="decimal" id="ras_conc" oninput="calcRAS()" placeholder="8000">
                        <span class="field-hint">Return sludge TSS</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="ras_res">0.00 MGD</span>
                    <div id="ras_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('ras_res')">Copy Result</button>
                </div>
                <div class="formula-note">RAS = (Q √ó MLSS) √∑ (RAS Conc - MLSS)</div>
            </div>
        </div>
    </div>

    <!-- 10. Organic Loading Rate -->
    <div class="card accent" id="card10" data-calc="olr">
        <div class="card-header" onclick="toggleCard(10)">
            <h2><span class="card-num">10</span> Organic Loading Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">BOD loading per unit volume. Used for trickling filters, RBCs, and aeration basins.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="olr_flow" oninput="calcOLR()" placeholder="1.5">
                        <span class="field-hint">Influent flow</span>
                    </div>
                    <div>
                        <label>BOD (mg/L)</label>
                        <input type="number" inputmode="decimal" id="olr_bod" oninput="calcOLR()" placeholder="200">
                        <span class="field-hint">Influent BOD</span>
                    </div>
                    <div>
                        <label>Volume (1000 ft¬≥)</label>
                        <input type="number" inputmode="decimal" id="olr_vol" oninput="calcOLR()" placeholder="50">
                        <span class="field-hint">Media or basin volume</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="olr_res">0.0 lbs/day/1000ft¬≥</span>
                    <div id="olr_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('olr_res')">Copy Result</button>
                </div>
                <div class="formula-note">(Flow √ó BOD √ó 8.34) √∑ Volume in 1000 ft¬≥</div>
            </div>
        </div>
    </div>

    <!-- 11. Surface Overflow Rate -->
    <div class="card accent" id="card11" data-calc="sor">
        <div class="card-header" onclick="toggleCard(11)">
            <h2><span class="card-num">11</span> Surface Overflow Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Hydraulic loading rate for clarifiers. Flow per unit surface area.</div>
                <div class="grid">
                    <div>
                        <label>Flow (GPD)</label>
                        <input type="number" inputmode="decimal" id="sor_flow" oninput="calcSOR()" placeholder="1500000">
                        <span class="field-hint">Gallons per day</span>
                    </div>
                    <div>
                        <label>Surface Area (ft¬≤)</label>
                        <input type="number" inputmode="decimal" id="sor_area" oninput="calcSOR()" placeholder="3000">
                        <span class="field-hint">Clarifier surface area</span>
                    </div>
                </div>
                <div class="example-box"><b>Circular:</b> Area = 0.785 √ó D¬≤ | <b>Rectangular:</b> Area = L √ó W</div>
                <div class="result-box">
                    <span class="val" id="sor_res">0 GPD/ft¬≤</span>
                    <div id="sor_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('sor_res')">Copy Result</button>
                </div>
                <div class="formula-note">Flow (GPD) √∑ Surface Area (ft¬≤)</div>
            </div>
        </div>
    </div>

    <!-- 12. Weir Overflow Rate -->
    <div class="card accent" id="card12" data-calc="wor">
        <div class="card-header" onclick="toggleCard(12)">
            <h2><span class="card-num">12</span> Weir Overflow Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Flow per linear foot of weir. Important for clarifier performance.</div>
                <div class="grid">
                    <div>
                        <label>Flow (GPD)</label>
                        <input type="number" inputmode="decimal" id="wor_flow" oninput="calcWOR()" placeholder="1500000">
                        <span class="field-hint">Gallons per day</span>
                    </div>
                    <div>
                        <label>Weir Length (ft)</label>
                        <input type="number" inputmode="decimal" id="wor_len" oninput="calcWOR()" placeholder="150">
                        <span class="field-hint">Total weir length</span>
                    </div>
                </div>
                <div class="example-box"><b>Circular weir:</b> Length = œÄ √ó Diameter (3.14 √ó D)</div>
                <div class="result-box">
                    <span class="val" id="wor_res">0 GPD/ft</span>
                    <div id="wor_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('wor_res')">Copy Result</button>
                </div>
                <div class="formula-note">Flow (GPD) √∑ Weir Length (ft)</div>
            </div>
        </div>
    </div>

    <!-- 13. Solids Loading Rate -->
    <div class="card success" id="card13" data-calc="slr">
        <div class="card-header" onclick="toggleCard(13)">
            <h2><span class="card-num">13</span> Solids Loading Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Solids applied per unit clarifier area. Key for secondary clarifier design.</div>
                <div class="grid">
                    <div>
                        <label>Influent + RAS Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="slr_flow" oninput="calcSLR()" placeholder="2.0">
                        <span class="field-hint">Total flow to clarifier</span>
                    </div>
                    <div>
                        <label>MLSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="slr_mlss" oninput="calcSLR()" placeholder="3000">
                        <span class="field-hint">Mixed liquor solids</span>
                    </div>
                    <div>
                        <label>Surface Area (ft¬≤)</label>
                        <input type="number" inputmode="decimal" id="slr_area" oninput="calcSLR()" placeholder="3000">
                        <span class="field-hint">Clarifier area</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="slr_res">0.0 lbs/day/ft¬≤</span>
                    <div id="slr_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('slr_res')">Copy Result</button>
                </div>
                <div class="formula-note">(Flow √ó MLSS √ó 8.34) √∑ Surface Area</div>
            </div>
        </div>
    </div>

    <!-- 14. Chemical Dosing -->
    <div class="card success" id="card14" data-calc="chem">
        <div class="card-header" onclick="toggleCard(14)">
            <h2><span class="card-num">14</span> Chemical Dosing</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Calculate chemical feed rate. Works for chlorine, alum, polymer, lime, etc.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="chem_flow" oninput="calcChem()" placeholder="1.5">
                        <span class="field-hint">Treatment flow</span>
                    </div>
                    <div>
                        <label>Dose (mg/L)</label>
                        <input type="number" inputmode="decimal" id="chem_dose" oninput="calcChem()" placeholder="2.0">
                        <span class="field-hint">Target dosage</span>
                    </div>
                    <div>
                        <label>Chemical % Purity</label>
                        <input type="number" inputmode="decimal" id="chem_purity" oninput="calcChem()" placeholder="100">
                        <span class="field-hint">65% for HTH, 12% for bleach</span>
                    </div>
                </div>
                <div class="example-box"><b>Common:</b> Gas Cl‚ÇÇ = 100% | HTH = 65% | Bleach = 12% | Alum = 48%</div>
                <div class="result-box">
                    <span class="val" id="chem_res">0.00 lbs/day</span>
                    <div id="chem_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('chem_res')">Copy Result</button>
                </div>
                <div class="formula-note">(Flow √ó Dose √ó 8.34) √∑ (Purity √∑ 100)</div>
            </div>
        </div>
    </div>

    <!-- ========== MBR SECTION ========== -->
    <div style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(139, 92, 246, 0.15); border-radius: 8px; border-left: 4px solid #8b5cf6; font-size: 0.85rem; color: #a78bfa; font-weight: bold;">üî¨ MBR ‚Äì Membrane Bioreactor Calculators</div>

    <!-- 15. Membrane Flux Rate -->
    <div class="card" id="card15" data-calc="flux" style="border-left-color: #8b5cf6;">
        <div class="card-header" onclick="toggleCard(15)">
            <h2><span class="card-num" style="background: #8b5cf6;">15</span> Membrane Flux Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #8b5cf6;">Calculate permeate flux through the membrane. Primary MBR performance indicator ‚Äî check daily to detect fouling trends.</div>
                <div class="grid">
                    <div>
                        <label>Permeate Flow (GPD)</label>
                        <input type="number" inputmode="decimal" id="flux_flow" oninput="calcFlux()" placeholder="500000">
                        <span class="field-hint">Gallons per day through membranes</span>
                    </div>
                    <div>
                        <label>Membrane Area (ft¬≤)</label>
                        <input type="number" inputmode="decimal" id="flux_area" oninput="calcFlux()" placeholder="50000">
                        <span class="field-hint">Total active membrane area</span>
                    </div>
                </div>
                <div class="example-box"><b>Typical MBR Flux:</b> 10‚Äì15 GFD (avg) | 20‚Äì25 GFD (peak) | &lt;8 GFD = likely fouled | &gt;25 GFD = risk of damage</div>
                <div class="result-box">
                    <span class="val" id="flux_res">0.0 GFD</span>
                    <div id="flux_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('flux_res')">Copy Result</button>
                </div>
                <div class="formula-note">Flux (GFD) = Permeate Flow (GPD) √∑ Membrane Area (ft¬≤)</div>
            </div>
        </div>
    </div>

    <!-- 16. Transmembrane Pressure -->
    <div class="card" id="card16" data-calc="tmp" style="border-left-color: #8b5cf6;">
        <div class="card-header" onclick="toggleCard(16)">
            <h2><span class="card-num" style="background: #8b5cf6;">16</span> Transmembrane Pressure</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #8b5cf6;">Calculate pressure driving permeate through the membrane. TMP trending is the #1 fouling indicator and triggers CIP decisions.</div>
                <div class="grid">
                    <div>
                        <label>Feed Pressure (psi)</label>
                        <input type="number" inputmode="decimal" id="tmp_feed" oninput="calcTMP()" placeholder="6.0">
                        <span class="field-hint">Upstream of membrane</span>
                    </div>
                    <div>
                        <label>Permeate Pressure (psi)</label>
                        <input type="number" inputmode="decimal" id="tmp_perm" oninput="calcTMP()" placeholder="1.0">
                        <span class="field-hint">Downstream (often ~0 or vacuum)</span>
                    </div>
                </div>
                <div class="example-box"><b>Typical MBR TMP:</b> 1‚Äì7 psi (normal) | 7‚Äì12 psi (fouling) | >12 psi = CIP required | Submerged membranes often read in kPa (1 psi = 6.895 kPa)</div>
                <div class="result-box">
                    <span class="val" id="tmp_res">0.0 psi</span>
                    <div id="tmp_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('tmp_res')">Copy Result</button>
                </div>
                <div class="formula-note">TMP = Feed Pressure ‚àí Permeate Pressure</div>
            </div>
        </div>
    </div>

    <!-- 17. Membrane Permeability -->
    <div class="card" id="card17" data-calc="perm" style="border-left-color: #8b5cf6;">
        <div class="card-header" onclick="toggleCard(17)">
            <h2><span class="card-num" style="background: #8b5cf6;">17</span> Membrane Permeability</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #8b5cf6;">Normalizes flux per unit of driving pressure. Detects fouling even when flux appears stable ‚Äî declining permeability confirms membrane fouling.</div>
                <div class="grid">
                    <div>
                        <label>Flux (GFD)</label>
                        <input type="number" inputmode="decimal" id="perm_flux" oninput="calcPerm()" placeholder="12.0">
                        <span class="field-hint">From Flux calculator or known</span>
                    </div>
                    <div>
                        <label>TMP (psi)</label>
                        <input type="number" inputmode="decimal" id="perm_tmp" oninput="calcPerm()" placeholder="5.0">
                        <span class="field-hint">From TMP calculator or gauge</span>
                    </div>
                </div>
                <div class="example-box"><b>Typical Permeability:</b> 3‚Äì6 GFD/psi (good) | 1.5‚Äì3 GFD/psi (fouling) | &lt;1.5 GFD/psi = CIP needed | New membranes: 5‚Äì8+ GFD/psi</div>
                <div class="result-box">
                    <span class="val" id="perm_res">0.0 GFD/psi</span>
                    <div id="perm_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('perm_res')">Copy Result</button>
                </div>
                <div class="formula-note">Permeability = Flux (GFD) √∑ TMP (psi)</div>
            </div>
        </div>
    </div>

    <!-- 18. Membrane Area Sizing -->
    <div class="card" id="card18" data-calc="msize" style="border-left-color: #8b5cf6;">
        <div class="card-header" onclick="toggleCard(18)">
            <h2><span class="card-num" style="background: #8b5cf6;">18</span> Membrane Area Sizing</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #8b5cf6;">Calculate total membrane area needed for design flow. Essential for MBR retrofits, expansions, and new system evaluations.</div>
                <div class="grid">
                    <div>
                        <label>Design Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="msize_flow" oninput="calcMSize()" placeholder="1.5">
                        <span class="field-hint">Average day permitted flow</span>
                    </div>
                    <div>
                        <label>Peak Hour Factor</label>
                        <input type="number" inputmode="decimal" id="msize_pf" oninput="calcMSize()" placeholder="2.0">
                        <span class="field-hint">Typical: 1.5‚Äì3.0√ó</span>
                    </div>
                    <div>
                        <label>Target Avg Flux (GFD)</label>
                        <input type="number" inputmode="decimal" id="msize_flux" oninput="calcMSize()" placeholder="12">
                        <span class="field-hint">Design: 10‚Äì14 GFD avg</span>
                    </div>
                    <div>
                        <label>Peak Flux (GFD)</label>
                        <input type="number" inputmode="decimal" id="msize_peak" oninput="calcMSize()" placeholder="20">
                        <span class="field-hint">Peak: 18‚Äì25 GFD</span>
                    </div>
                </div>
                <div class="example-box"><b>Rule of thumb:</b> Design to avg flux for daily operation. Verify peak flux ‚â§ 25 GFD. Larger area = lower flux = longer membrane life.</div>
                <div class="result-box">
                    <span class="val" id="msize_res">0 ft¬≤</span>
                    <div id="msize_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('msize_res')">Copy Result</button>
                </div>
                <div class="formula-note">Area = Design Flow (GPD) √∑ Target Flux (GFD) ‚Äî checked against peak</div>
            </div>
        </div>
    </div>

    <!-- 19. Specific Aeration Demand -->
    <div class="card" id="card19" data-calc="sad" style="border-left-color: #8b5cf6;">
        <div class="card-header" onclick="toggleCard(19)">
            <h2><span class="card-num" style="background: #8b5cf6;">19</span> Specific Aeration Demand</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #8b5cf6;">Calculate membrane air scouring efficiency. SADm = air per membrane area. SADp = air per permeate volume. Membrane aeration is 30‚Äì50% of MBR energy cost.</div>
                <div class="grid">
                    <div>
                        <label>Air Flow (Nm¬≥/hr)</label>
                        <input type="number" inputmode="decimal" id="sad_air" oninput="calcSAD()" placeholder="500">
                        <span class="field-hint">Coarse bubble to membranes</span>
                    </div>
                    <div>
                        <label>Membrane Area (m¬≤)</label>
                        <input type="number" inputmode="decimal" id="sad_area" oninput="calcSAD()" placeholder="5000">
                        <span class="field-hint">Total active area</span>
                    </div>
                    <div>
                        <label>Permeate Flow (m¬≥/hr)</label>
                        <input type="number" inputmode="decimal" id="sad_perm" oninput="calcSAD()" placeholder="100">
                        <span class="field-hint">Permeate production rate</span>
                    </div>
                </div>
                <div class="example-box"><b>Targets:</b> SADm = 0.2‚Äì0.5 Nm¬≥/m¬≤/hr (flat sheet: 0.5‚Äì1.0) | SADp = 10‚Äì25 m¬≥air/m¬≥permeate | Lower = more efficient</div>
                <div class="result-box">
                    <span class="val" id="sad_res">‚Äî</span>
                    <div id="sad_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('sad_res')">Copy Result</button>
                </div>
                <div class="formula-note">SADm = Air Flow √∑ Membrane Area | SADp = Air Flow √∑ Permeate Flow</div>
            </div>
        </div>
    </div>

    <!-- 20. MBR Operating Range Check -->
    <div class="card" id="card20" data-calc="mbrcheck" style="border-left-color: #8b5cf6;">
        <div class="card-header" onclick="toggleCard(20)">
            <h2><span class="card-num" style="background: #8b5cf6;">20</span> MBR Operating Range Check</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #8b5cf6;">Verify MLSS, SRT, F:M, and DO are within MBR-appropriate ranges. MBR operates at drastically different setpoints than conventional activated sludge.</div>
                <div class="grid">
                    <div>
                        <label>MLSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="mbrc_mlss" oninput="calcMBRC()" placeholder="10000">
                        <span class="field-hint">MBR typical: 8,000‚Äì12,000</span>
                    </div>
                    <div>
                        <label>SRT (days)</label>
                        <input type="number" inputmode="decimal" id="mbrc_srt" oninput="calcMBRC()" placeholder="20">
                        <span class="field-hint">MBR typical: 15‚Äì40 days</span>
                    </div>
                    <div>
                        <label>F:M Ratio</label>
                        <input type="number" inputmode="decimal" id="mbrc_fm" oninput="calcMBRC()" placeholder="0.08">
                        <span class="field-hint">MBR typical: 0.05‚Äì0.15</span>
                    </div>
                    <div>
                        <label>DO (mg/L)</label>
                        <input type="number" inputmode="decimal" id="mbrc_do" oninput="calcMBRC()" placeholder="2.0">
                        <span class="field-hint">MBR typical: 1.0‚Äì3.0</span>
                    </div>
                </div>
                <div class="example-box"><b>CAS vs MBR:</b> CAS MLSS 1,500‚Äì4,000 ‚Üí MBR 8,000‚Äì12,000 | CAS SRT 5‚Äì15 d ‚Üí MBR 15‚Äì40 d | CAS F:M 0.2‚Äì0.5 ‚Üí MBR 0.05‚Äì0.15</div>
                <div class="result-box">
                    <span class="val" id="mbrc_res">‚Äî</span>
                    <div id="mbrc_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('mbrc_res')">Copy Result</button>
                </div>
                <div class="formula-note">Compares inputs against MBR-specific operating ranges</div>
            </div>
        </div>
    </div>

    <!-- 21. CIP Chemical Dosing -->
    <div class="card" id="card21" data-calc="cip" style="border-left-color: #8b5cf6;">
        <div class="card-header" onclick="toggleCard(21)">
            <h2><span class="card-num" style="background: #8b5cf6;">21</span> CIP Chemical Dosing</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #8b5cf6;">Calculate sodium hypochlorite (NaOCl) and citric acid volumes for membrane maintenance and recovery cleans. Wrong dosing can damage membranes.</div>
                <div class="grid">
                    <div>
                        <label>CIP Tank Volume (gal)</label>
                        <input type="number" inputmode="decimal" id="cip_vol" oninput="calcCIP()" placeholder="500">
                        <span class="field-hint">Membrane train clean volume</span>
                    </div>
                    <div>
                        <label>Target NaOCl (mg/L)</label>
                        <input type="number" inputmode="decimal" id="cip_nacl" oninput="calcCIP()" placeholder="1000">
                        <span class="field-hint">Maint: 200‚Äì500 | Recovery: 1000‚Äì2000</span>
                    </div>
                    <div>
                        <label>Bleach Strength (%)</label>
                        <input type="number" inputmode="decimal" id="cip_bleach" oninput="calcCIP()" placeholder="12.5">
                        <span class="field-hint">Typical: 12.5% (trade) or 10%</span>
                    </div>
                    <div>
                        <label>Target Citric Acid (mg/L)</label>
                        <input type="number" inputmode="decimal" id="cip_citric" oninput="calcCIP()" placeholder="2000">
                        <span class="field-hint">Maint: 1000‚Äì2000 | Recovery: 2000‚Äì5000</span>
                    </div>
                    <div>
                        <label>Citric Acid Strength (%)</label>
                        <input type="number" inputmode="decimal" id="cip_cstr" oninput="calcCIP()" placeholder="50">
                        <span class="field-hint">Powder dissolved: 50% typical</span>
                    </div>
                </div>
                <div class="example-box"><b>CIP Schedule:</b> Maintenance clean (MC): weekly‚Äìbiweekly | Recovery clean (RC): monthly‚Äìquarterly | Always NaOCl first, then citric acid. Never mix!</div>
                <div class="result-box">
                    <span class="val" id="cip_res">‚Äî</span>
                    <div id="cip_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('cip_res')">Copy Result</button>
                </div>
                <div class="formula-note">Volume = (Tank Vol √ó Target Conc) √∑ (Solution Strength √ó 10,000)</div>
            </div>
        </div>
    </div>

    <!-- ========== MBBR SECTION ========== -->
    <div style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(6, 182, 212, 0.15); border-radius: 8px; border-left: 4px solid #06b6d4; font-size: 0.85rem; color: #22d3ee; font-weight: bold;">üß¨ MBBR ‚Äì Moving Bed Biofilm Reactor Calculators</div>

    <!-- 22. Surface Area Loading Rate -->
    <div class="card" id="card22" data-calc="salr" style="border-left-color: #06b6d4;">
        <div class="card-header" onclick="toggleCard(22)">
            <h2><span class="card-num" style="background: #06b6d4;">22</span> Surface Area Loading Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #06b6d4;">The fundamental MBBR design parameter ‚Äî equivalent of F:M for suspended growth. Calculates organic or nitrogen load applied per unit of biofilm surface area.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="salr_flow" oninput="calcSALR()" placeholder="1.5">
                        <span class="field-hint">Influent flow to MBBR</span>
                    </div>
                    <div>
                        <label>Concentration (mg/L)</label>
                        <input type="number" inputmode="decimal" id="salr_conc" oninput="calcSALR()" placeholder="150">
                        <span class="field-hint">BOD‚ÇÖ or NH‚ÇÉ-N</span>
                    </div>
                    <div>
                        <label>Biofilm Area (m¬≤)</label>
                        <input type="number" inputmode="decimal" id="salr_area" oninput="calcSALR()" placeholder="50000">
                        <span class="field-hint">Total protected surface area</span>
                    </div>
                </div>
                <div class="example-box"><b>SALR Targets:</b> BOD removal: 5‚Äì20 g/m¬≤/d | Nitrification: 0.5‚Äì1.5 g NH‚ÇÉ-N/m¬≤/d | Pre-denitrification: 1‚Äì3 g NO‚ÇÉ-N/m¬≤/d</div>
                <div class="result-box">
                    <span class="val" id="salr_res">0.0 g/m¬≤/d</span>
                    <div id="salr_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('salr_res')">Copy Result</button>
                </div>
                <div class="formula-note">SALR = (Flow √ó Conc √ó 3.785) √∑ Biofilm Area (g/m¬≤/day)</div>
            </div>
        </div>
    </div>

    <!-- 23. Effective Biofilm Area -->
    <div class="card" id="card23" data-calc="bioarea" style="border-left-color: #06b6d4;">
        <div class="card-header" onclick="toggleCard(23)">
            <h2><span class="card-num" style="background: #06b6d4;">23</span> Effective Biofilm Area</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #06b6d4;">Calculate total protected biofilm surface area from reactor volume, media fill fraction, and carrier specific surface area. Needed to verify actual loading rates.</div>
                <div class="grid">
                    <div>
                        <label>Reactor Volume (ft¬≥)</label>
                        <input type="number" inputmode="decimal" id="bio_vol" oninput="calcBioArea()" placeholder="10000">
                        <span class="field-hint">Liquid volume of MBBR zone</span>
                    </div>
                    <div>
                        <label>Fill Fraction (%)</label>
                        <input type="number" inputmode="decimal" id="bio_fill" oninput="calcBioArea()" placeholder="50">
                        <span class="field-hint">Typical: 40‚Äì67%</span>
                    </div>
                    <div>
                        <label>Specific Surface Area (m¬≤/m¬≥)</label>
                        <input type="number" inputmode="decimal" id="bio_ssa" oninput="calcBioArea()" placeholder="500">
                        <span class="field-hint">From media spec sheet</span>
                    </div>
                </div>
                <div class="example-box"><b>Common Media SSA:</b> K1 Kaldnes = 500 m¬≤/m¬≥ | K3 = 500 | K5 = 800 | AnoxKaldnes‚Ñ¢ BiofilmChip‚Ñ¢ = 900+ | Typical fill: 50‚Äì60%</div>
                <div class="result-box">
                    <span class="val" id="bio_res">0 m¬≤</span>
                    <div id="bio_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('bio_res')">Copy Result</button>
                </div>
                <div class="formula-note">Area = Reactor Vol (m¬≥) √ó Fill% √ó Specific Surface Area (m¬≤/m¬≥)</div>
            </div>
        </div>
    </div>

    <!-- 24. Media Fill Volume -->
    <div class="card" id="card24" data-calc="mediavol" style="border-left-color: #06b6d4;">
        <div class="card-header" onclick="toggleCard(24)">
            <h2><span class="card-num" style="background: #06b6d4;">24</span> Media Fill Volume</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #06b6d4;">Calculate required carrier media volume from target SALR, influent load, and media specific surface area. Critical for sizing new MBBR systems or expansions.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="mv_flow" oninput="calcMediaVol()" placeholder="1.5">
                        <span class="field-hint">Influent flow</span>
                    </div>
                    <div>
                        <label>Concentration (mg/L)</label>
                        <input type="number" inputmode="decimal" id="mv_conc" oninput="calcMediaVol()" placeholder="150">
                        <span class="field-hint">BOD‚ÇÖ or NH‚ÇÉ-N</span>
                    </div>
                    <div>
                        <label>Target SALR (g/m¬≤/d)</label>
                        <input type="number" inputmode="decimal" id="mv_salr" oninput="calcMediaVol()" placeholder="10">
                        <span class="field-hint">BOD: 5‚Äì20 | NH‚ÇÉ: 0.5‚Äì1.5</span>
                    </div>
                    <div>
                        <label>Media SSA (m¬≤/m¬≥)</label>
                        <input type="number" inputmode="decimal" id="mv_ssa" oninput="calcMediaVol()" placeholder="500">
                        <span class="field-hint">From spec sheet</span>
                    </div>
                </div>
                <div class="example-box"><b>Sizing Logic:</b> Required area = Load √∑ SALR ‚Üí Media volume = Area √∑ SSA ‚Üí Check fill fraction stays 40‚Äì67%</div>
                <div class="result-box">
                    <span class="val" id="mv_res">0 m¬≥</span>
                    <div id="mv_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('mv_res')">Copy Result</button>
                </div>
                <div class="formula-note">Media Vol = (Flow √ó Conc √ó 3.785) √∑ (Target SALR √ó SSA)</div>
            </div>
        </div>
    </div>

    <!-- 25. MBBR Reactor Sizing -->
    <div class="card" id="card25" data-calc="mbbrsz" style="border-left-color: #06b6d4;">
        <div class="card-header" onclick="toggleCard(25)">
            <h2><span class="card-num" style="background: #06b6d4;">25</span> MBBR Reactor Sizing</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #06b6d4;">Calculate required reactor volume from media volume and fill fraction. Verifies HRT and ensures adequate empty-bed volume for proper media circulation.</div>
                <div class="grid">
                    <div>
                        <label>Media Volume (m¬≥)</label>
                        <input type="number" inputmode="decimal" id="rsz_media" oninput="calcRSZ()" placeholder="150">
                        <span class="field-hint">From Media Fill calc or known</span>
                    </div>
                    <div>
                        <label>Fill Fraction (%)</label>
                        <input type="number" inputmode="decimal" id="rsz_fill" oninput="calcRSZ()" placeholder="55">
                        <span class="field-hint">Target: 40‚Äì67% max</span>
                    </div>
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="rsz_flow" oninput="calcRSZ()" placeholder="1.5">
                        <span class="field-hint">For HRT calculation</span>
                    </div>
                </div>
                <div class="example-box"><b>Design Notes:</b> Max fill 67% ‚Äî above this media cannot circulate. Typical HRT: 1‚Äì3 hrs BOD removal | 3‚Äì6 hrs nitrification. Provide adequate mixing energy.</div>
                <div class="result-box">
                    <span class="val" id="rsz_res">0 m¬≥</span>
                    <div id="rsz_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('rsz_res')">Copy Result</button>
                </div>
                <div class="formula-note">Reactor Vol = Media Vol √∑ (Fill% √∑ 100)</div>
            </div>
        </div>
    </div>

    <!-- 26. MBBR Dissolved Oxygen Demand -->
    <div class="card" id="card26" data-calc="mbbrdo" style="border-left-color: #06b6d4;">
        <div class="card-header" onclick="toggleCard(26)">
            <h2><span class="card-num" style="background: #06b6d4;">26</span> MBBR Oxygen Demand</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #06b6d4;">Calculate O‚ÇÇ transfer needed for BOD removal and nitrification in MBBR. Biofilm systems need higher DO (4‚Äì6 mg/L) than CAS (~2 mg/L) due to boundary layer diffusion.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="mdo_flow" oninput="calcMDO()" placeholder="1.5">
                        <span class="field-hint">Influent flow</span>
                    </div>
                    <div>
                        <label>BOD Removed (mg/L)</label>
                        <input type="number" inputmode="decimal" id="mdo_bod" oninput="calcMDO()" placeholder="130">
                        <span class="field-hint">Influent ‚Äì Effluent BOD</span>
                    </div>
                    <div>
                        <label>NH‚ÇÉ-N Removed (mg/L)</label>
                        <input type="number" inputmode="decimal" id="mdo_nh3" oninput="calcMDO()" placeholder="20">
                        <span class="field-hint">0 if no nitrification</span>
                    </div>
                </div>
                <div class="example-box"><b>O‚ÇÇ Factors:</b> ~1.5 lb O‚ÇÇ/lb BOD removed | ~4.6 lb O‚ÇÇ/lb NH‚ÇÉ-N oxidized | MBBR target DO: 4‚Äì6 mg/L (vs CAS 1.5‚Äì2.5 mg/L)</div>
                <div class="result-box">
                    <span class="val" id="mdo_res">0 lbs O‚ÇÇ/day</span>
                    <div id="mdo_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('mdo_res')">Copy Result</button>
                </div>
                <div class="formula-note">O‚ÇÇ = (Flow √ó ŒîBOD √ó 8.34 √ó 1.5) + (Flow √ó ŒîNH‚ÇÉ √ó 8.34 √ó 4.6)</div>
            </div>
        </div>
    </div>

    <!-- 27. MBBR vs CAS Comparison -->
    <div class="card" id="card27" data-calc="mbbrcas" style="border-left-color: #06b6d4;">
        <div class="card-header" onclick="toggleCard(27)">
            <h2><span class="card-num" style="background: #06b6d4;">27</span> MBBR vs CAS Comparison</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #06b6d4;">Side-by-side comparison of MBBR vs conventional activated sludge for the same flow and load. Useful for technology selection and consulting evaluations.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="cmp_flow" oninput="calcCMP()" placeholder="1.5">
                        <span class="field-hint">Design flow</span>
                    </div>
                    <div>
                        <label>Influent BOD (mg/L)</label>
                        <input type="number" inputmode="decimal" id="cmp_bod" oninput="calcCMP()" placeholder="200">
                        <span class="field-hint">Raw or primary effluent BOD</span>
                    </div>
                </div>
                <div class="example-box"><b>Comparison basis:</b> CAS: F:M=0.3, MLSS=3000, SRT=10d | MBBR: SALR=10 g/m¬≤/d, K3 media 500 m¬≤/m¬≥, 55% fill</div>
                <div class="result-box">
                    <span class="val" id="cmp_res">‚Äî</span>
                    <div id="cmp_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('cmp_res')">Copy Result</button>
                </div>
                <div class="formula-note">CAS Vol = (Flow √ó BOD √ó 8.34) √∑ (F:M √ó MLSS) | MBBR Vol = Media √∑ Fill%</div>
            </div>
        </div>
    </div>

    <div class="version">
        <div style="font-size: 0.85rem; color: #94a3b8; margin-bottom: 4px;">Built by <b>Armand Frazier Sr.</b> | Houston, TX</div>
        WW Pro-Calc v5.0 ‚Äì 27 Calculators
    </div>
</div>

<!-- Bottom Navigation -->
<nav class="bottom-nav">
    <div class="nav-scroll">
        <button class="nav-btn active" onclick="goToCard(1)" id="nav1">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 3v18M5 8l7-5 7 5M5 12h14"/>
            </svg>
            <span>Lbs</span>
        </button>
        <button class="nav-btn" onclick="goToCard(2)" id="nav2">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="4" y="4" width="16" height="16" rx="2"/><path d="M8 20V10M12 20V6M16 20V14"/>
            </svg>
            <span>SVI</span>
        </button>
        <button class="nav-btn" onclick="goToCard(3)" id="nav3">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="8" cy="12" r="4"/><circle cx="16" cy="12" r="4"/>
            </svg>
            <span>Mix</span>
        </button>
        <button class="nav-btn" onclick="goToCard(4)" id="nav4">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
            <span>F/M</span>
        </button>
        <button class="nav-btn" onclick="goToCard(5)" id="nav5">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="16" rx="2"/><path d="M8 2v4M16 2v4M3 10h18"/>
            </svg>
            <span>SRT</span>
        </button>
        <button class="nav-btn" onclick="goToCard(6)" id="nav6">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
            </svg>
            <span>DT</span>
        </button>
        <button class="nav-btn" onclick="goToCard(7)" id="nav7">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 3v18h18"/><path d="M7 16l4-8 4 4 5-9"/>
            </svg>
            <span>Eff%</span>
        </button>
        <button class="nav-btn" onclick="goToCard(8)" id="nav8">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2v20M2 12h20"/><circle cx="12" cy="12" r="3"/>
            </svg>
            <span>WAS</span>
        </button>
        <button class="nav-btn" onclick="goToCard(9)" id="nav9">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 12h16M4 12l4-4M4 12l4 4M20 12l-4-4M20 12l-4 4"/>
            </svg>
            <span>RAS</span>
        </button>
        <button class="nav-btn" onclick="goToCard(10)" id="nav10">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 3v18"/>
            </svg>
            <span>OLR</span>
        </button>
        <button class="nav-btn" onclick="goToCard(11)" id="nav11">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><path d="M2 12h20"/>
            </svg>
            <span>SOR</span>
        </button>
        <button class="nav-btn" onclick="goToCard(12)" id="nav12">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 4h16v4H4zM4 12h16"/><path d="M12 12v8"/>
            </svg>
            <span>WOR</span>
        </button>
        <button class="nav-btn" onclick="goToCard(13)" id="nav13">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="4" y="4" width="16" height="16" rx="2"/><path d="M4 14h16M9 4v16"/>
            </svg>
            <span>SLR</span>
        </button>
        <button class="nav-btn" onclick="goToCard(14)" id="nav14">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 3h6v6H9zM12 9v12M8 21h8"/>
            </svg>
            <span>Chem</span>
        </button>
        <button class="nav-btn" onclick="goToCard(15)" id="nav15">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="6" width="18" height="12" rx="1"/><path d="M3 10h18M3 14h18M7 6v12M11 6v12M15 6v12M19 6v12"/>
            </svg>
            <span>Flux</span>
        </button>
        <button class="nav-btn" onclick="goToCard(16)" id="nav16">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2v20"/><path d="M5 5l14 14"/><path d="M19 5L5 19"/><circle cx="12" cy="12" r="3"/>
            </svg>
            <span>TMP</span>
        </button>
        <button class="nav-btn" onclick="goToCard(17)" id="nav17">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 12h16"/><path d="M4 6h16"/><path d="M4 18h16"/><circle cx="12" cy="12" r="2"/>
            </svg>
            <span>Perm</span>
        </button>
        <button class="nav-btn" onclick="goToCard(18)" id="nav18">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="2" y="4" width="20" height="16" rx="2"/><path d="M2 10h20M8 4v16M14 4v16"/>
            </svg>
            <span>MArea</span>
        </button>
        <button class="nav-btn" onclick="goToCard(19)" id="nav19">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="16" r="2"/><path d="M12 14V4"/><path d="M8 8l4-4 4 4"/><path d="M6 20h12"/>
            </svg>
            <span>SAD</span>
        </button>
        <button class="nav-btn" onclick="goToCard(20)" id="nav20">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 11l3 3 8-8"/><circle cx="12" cy="12" r="10"/>
            </svg>
            <span>MBR‚úì</span>
        </button>
        <button class="nav-btn" onclick="goToCard(21)" id="nav21">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M8 2h8l2 6H6l2-6z"/><rect x="6" y="8" width="12" height="12" rx="1"/><path d="M10 12v4M14 12v4"/>
            </svg>
            <span>CIP</span>
        </button>
        <button class="nav-btn" onclick="goToCard(22)" id="nav22">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 3v18"/>
            </svg>
            <span>SALR</span>
        </button>
        <button class="nav-btn" onclick="goToCard(23)" id="nav23">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="8" cy="8" r="3"/><circle cx="16" cy="8" r="3"/><circle cx="8" cy="16" r="3"/><circle cx="16" cy="16" r="3"/>
            </svg>
            <span>BioA</span>
        </button>
        <button class="nav-btn" onclick="goToCard(24)" id="nav24">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="4" y="4" width="16" height="16" rx="2"/><path d="M8 8h8v8H8z"/>
            </svg>
            <span>MVol</span>
        </button>
        <button class="nav-btn" onclick="goToCard(25)" id="nav25">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="6" width="18" height="12" rx="2"/><path d="M3 12h18"/>
            </svg>
            <span>RSiz</span>
        </button>
        <button class="nav-btn" onclick="goToCard(26)" id="nav26">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="8"/><path d="M12 8v4l2 2"/>
            </svg>
            <span>O‚ÇÇ</span>
        </button>
        <button class="nav-btn" onclick="goToCard(27)" id="nav27">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 4v16h16"/><rect x="7" y="10" width="4" height="8"/><rect x="13" y="6" width="4" height="12"/>
            </svg>
            <span>CvM</span>
        </button>
    </div>
</nav>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Install Prompt -->
<div class="install-prompt" id="installPrompt">
    üì≤ Install App
    <button onclick="installApp()">Install</button>
    <button onclick="dismissInstall()" style="background:transparent;color:white;font-size:1.2rem;">√ó</button>
</div>

<script>
    // ==================== STATE ====================
    const STORAGE_KEY = 'wwProCalcData';
    let currentCard = 1;
    
    // All input IDs for saving/restoring
    const inputIds = [
        'p_flow', 'p_conc',
        'svi_set', 'svi_mlss',
        'mb_qa', 'mb_ca', 'mb_qb', 'mb_cb',
        'fm_flow', 'fm_bod', 'fm_vol', 'fm_mlvss',
        'srt_vol', 'srt_mlss', 'srt_wasq', 'srt_wasc', 'srt_effq', 'srt_effc',
        'dt_vol', 'dt_flow',
        'eff_in', 'eff_out',
        'was_vol', 'was_mlss', 'was_srt', 'was_conc',
        'ras_flow', 'ras_mlss', 'ras_conc',
        'olr_flow', 'olr_bod', 'olr_vol',
        'sor_flow', 'sor_area',
        'wor_flow', 'wor_len',
        'slr_flow', 'slr_mlss', 'slr_area',
        'chem_flow', 'chem_dose', 'chem_purity',
        'flux_flow', 'flux_area',
        'tmp_feed', 'tmp_perm',
        'perm_flux', 'perm_tmp',
        'msize_flow', 'msize_pf', 'msize_flux', 'msize_peak',
        'sad_air', 'sad_area', 'sad_perm',
        'mbrc_mlss', 'mbrc_srt', 'mbrc_fm', 'mbrc_do',
        'cip_vol', 'cip_nacl', 'cip_bleach', 'cip_citric', 'cip_cstr',
        'salr_flow', 'salr_conc', 'salr_area',
        'bio_vol', 'bio_fill', 'bio_ssa',
        'mv_flow', 'mv_conc', 'mv_salr', 'mv_ssa',
        'rsz_media', 'rsz_fill', 'rsz_flow',
        'mdo_flow', 'mdo_bod', 'mdo_nh3',
        'cmp_flow', 'cmp_bod'
    ];

    // ==================== ACCORDION ====================
    function toggleCard(num) {
        const card = document.getElementById('card' + num);
        const wasOpen = card.classList.contains('open');
        
        // Close all cards
        document.querySelectorAll('.card').forEach(c => c.classList.remove('open'));
        
        // Open clicked card if it wasn't open
        if (!wasOpen) {
            card.classList.add('open');
            currentCard = num;
            updateNav();
            // Scroll to card
            setTimeout(() => {
                card.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }
        
        vibrate();
    }
    
    function goToCard(num) {
        const card = document.getElementById('card' + num);
        document.querySelectorAll('.card').forEach(c => c.classList.remove('open'));
        card.classList.add('open');
        currentCard = num;
        updateNav();
        card.scrollIntoView({ behavior: 'smooth', block: 'start' });
        vibrate();
    }
    
    function updateNav() {
        document.querySelectorAll('.nav-btn').forEach((btn, i) => {
            btn.classList.toggle('active', i + 1 === currentCard);
        });
    }

    // ==================== HAPTIC FEEDBACK ====================
    function vibrate() {
        if (navigator.vibrate) navigator.vibrate(10);
    }

    // ==================== TOAST ====================
    function showToast(message, type = '') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'toast show ' + type;
        setTimeout(() => toast.classList.remove('show'), 2000);
    }

    // ==================== COPY ====================
    function copyVal(id) {
        const text = document.getElementById(id).innerText;
        navigator.clipboard.writeText(text).then(() => {
            showToast('‚úì Copied: ' + text, 'success');
            vibrate();
        });
    }

    // ==================== CLEAR ALL ====================
    function clearAll() {
        if (confirm('Clear all values?')) {
            inputIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.value = '';
                    el.classList.remove('error');
                }
            });
            localStorage.removeItem(STORAGE_KEY);
            // Reset all results
            document.getElementById('p_res').innerText = '0.00 lbs/day';
            document.getElementById('svi_res').innerText = '0.00 mL/g';
            document.getElementById('mb_res').innerText = '0.00 mg/L';
            document.getElementById('fm_res').innerText = '0.000';
            document.getElementById('srt_res').innerText = '0.0 days';
            document.getElementById('dt_res').innerText = '0.00 hours';
            document.getElementById('eff_res').innerText = '0.0 %';
            document.getElementById('was_res').innerText = '0 GPD';
            document.getElementById('ras_res').innerText = '0.00 MGD';
            document.getElementById('olr_res').innerText = '0.0 lbs/day/1000ft¬≥';
            document.getElementById('sor_res').innerText = '0 GPD/ft¬≤';
            document.getElementById('wor_res').innerText = '0 GPD/ft';
            document.getElementById('slr_res').innerText = '0.0 lbs/day/ft¬≤';
            document.getElementById('chem_res').innerText = '0.00 lbs/day';
            document.getElementById('flux_res').innerText = '0.0 GFD';
            document.getElementById('tmp_res').innerText = '0.0 psi';
            document.getElementById('perm_res').innerText = '0.0 GFD/psi';
            document.getElementById('msize_res').innerText = '0 ft¬≤';
            document.getElementById('sad_res').innerText = '‚Äî';
            document.getElementById('mbrc_res').innerText = '‚Äî';
            document.getElementById('cip_res').innerText = '‚Äî';
            document.getElementById('salr_res').innerText = '0.0 g/m¬≤/d';
            document.getElementById('bio_res').innerText = '0 m¬≤';
            document.getElementById('mv_res').innerText = '0 m¬≥';
            document.getElementById('rsz_res').innerText = '0 m¬≥';
            document.getElementById('mdo_res').innerText = '0 lbs O‚ÇÇ/day';
            document.getElementById('cmp_res').innerText = '‚Äî';
            // Reset statuses
            document.querySelectorAll('.status').forEach(s => {
                s.innerText = 'Enter data...';
                s.style.color = '#64748b';
            });
            // Reset hints
            document.querySelectorAll('.field-hint').forEach(h => h.classList.remove('error'));
            const sviHint = document.getElementById('svi_set_hint');
            if (sviHint) sviHint.textContent = 'Max 1000 mL/L';
            
            showToast('‚úì All cleared', 'success');
            vibrate();
        }
    }

    // ==================== SAVE/RESTORE ====================
    function saveData() {
        const data = {};
        inputIds.forEach(id => {
            const el = document.getElementById(id);
            if (el && el.value) data[id] = el.value;
        });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }
    
    function restoreData() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            const data = JSON.parse(saved);
            inputIds.forEach(id => {
                const el = document.getElementById(id);
                if (el && data[id]) el.value = data[id];
            });
            // Trigger all calculations
            calcPounds(); calcSVI(); calcMB(); calcFM(); calcSRT(); calcDT(); calcEff();
            calcWAS(); calcRAS(); calcOLR(); calcSOR(); calcWOR(); calcSLR(); calcChem();
            calcFlux();
            calcTMP();
            calcPerm();
            calcMSize();
            calcSAD();
            calcMBRC();
            calcCIP();
            calcSALR(); calcBioArea(); calcMediaVol(); calcRSZ(); calcMDO(); calcCMP();
        }
    }
    
    // Auto-save on input with debounce
    let saveTimeout;
    document.addEventListener('input', () => {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(saveData, 500);
    });

    // ==================== VALIDATION ====================
    function validateInput(inputId, value, min, max, defaultHint) {
        const input = document.getElementById(inputId);
        const hintEl = document.getElementById(inputId + '_hint');
        
        if (value > max) {
            input.classList.add('error');
            if (hintEl) {
                hintEl.classList.add('error');
                hintEl.textContent = '‚ö†Ô∏è Max is ' + max;
            }
            vibrate();
            return false;
        } else if (value < min) {
            input.classList.add('error');
            if (hintEl) {
                hintEl.classList.add('error');
                hintEl.textContent = '‚ö†Ô∏è Min is ' + min;
            }
            vibrate();
            return false;
        } else {
            input.classList.remove('error');
            if (hintEl) {
                hintEl.classList.remove('error');
                hintEl.textContent = defaultHint;
            }
            return true;
        }
    }

    // ==================== CALCULATIONS ====================
    
    // 1. Pounds Formula
    function calcPounds() {
        const f = parseFloat(document.getElementById('p_flow').value) || 0;
        const c = parseFloat(document.getElementById('p_conc').value) || 0;
        const res = f * c * 8.34;
        document.getElementById('p_res').innerText = res.toFixed(2) + " lbs/day";
        const stat = document.getElementById('p_status');
        if (f > 0 && c > 0) {
            stat.innerHTML = "üìä <b>" + (c * 8.34).toFixed(1) + " lbs per MG</b> at this concentration";
            stat.style.color = "#94a3b8";
        } else {
            stat.innerText = "Enter data...";
            stat.style.color = "#64748b";
        }
    }

    // 2. SVI with validation
    function calcSVI() {
        const s = parseFloat(document.getElementById('svi_set').value) || 0;
        const m = parseFloat(document.getElementById('svi_mlss').value) || 0;
        
        // Validate settled volume (max 1000 mL/L for a settleometer)
        const valid = validateInput('svi_set', s, 0, 1000, 'Max 1000 mL/L');
        
        if (m > 0 && valid) {
            const res = (s * 1000) / m;
            document.getElementById('svi_res').innerText = res.toFixed(2) + " mL/g";
            const stat = document.getElementById('svi_status');
            
            if (res > 250) { 
                stat.innerHTML = "üö® <b>Severe Bulking</b> ‚Äì Check for Nocardia/M. parvicella. Consider RAS chlorination, reduce SRT."; 
                stat.style.color = "var(--danger)"; 
            } else if (res > 150) { 
                stat.innerHTML = "‚ö†Ô∏è <b>Bulking Sludge</b> ‚Äì Review F/M, DO levels, nutrient balance. Increase wasting."; 
                stat.style.color = "var(--accent)"; 
            } else if (res < 50) { 
                stat.innerHTML = "‚ö° <b>Pin Floc/Dispersed</b> ‚Äì Old sludge or toxic shock. Reduce SRT."; 
                stat.style.color = "var(--accent)"; 
            } else if (res < 80) { 
                stat.innerHTML = "‚ö° <b>Fast Settling</b> ‚Äì Monitor for pin floc. May indicate over-wasting."; 
                stat.style.color = "var(--primary)"; 
            } else { 
                stat.innerHTML = "‚úì <b>Optimal (80-150)</b> ‚Äì Good floc formation. Maintain operations."; 
                stat.style.color = "#4ade80"; 
            }
        } else if (!valid) {
            document.getElementById('svi_status').innerHTML = "‚ö†Ô∏è <b>Check Input</b> ‚Äì Settled volume cannot exceed 1000 mL/L";
            document.getElementById('svi_status').style.color = "var(--danger)";
        }
    }

    // 3. Mass Balance
    function calcMB() {
        const qa = parseFloat(document.getElementById('mb_qa').value) || 0;
        const ca = parseFloat(document.getElementById('mb_ca').value) || 0;
        const qb = parseFloat(document.getElementById('mb_qb').value) || 0;
        const cb = parseFloat(document.getElementById('mb_cb').value) || 0;
        
        if ((qa + qb) > 0) {
            const res = ((qa * ca) + (qb * cb)) / (qa + qb);
            document.getElementById('mb_res').innerText = res.toFixed(2) + " mg/L";
            const stat = document.getElementById('mb_status');
            const ratioA = (qa / (qa + qb) * 100).toFixed(0);
            const ratioB = (qb / (qa + qb) * 100).toFixed(0);
            stat.innerHTML = "üìä <b>Flow Mix:</b> A = " + ratioA + "% | B = " + ratioB + "%";
            stat.style.color = "#94a3b8";
        }
    }

    // 4. F/M Ratio
    function calcFM() {
        const flow = parseFloat(document.getElementById('fm_flow').value) || 0;
        const bod = parseFloat(document.getElementById('fm_bod').value) || 0;
        const vol = parseFloat(document.getElementById('fm_vol').value) || 0;
        const mlvss = parseFloat(document.getElementById('fm_mlvss').value) || 0;
        
        if (vol > 0 && mlvss > 0) {
            const res = (flow * bod) / (vol * mlvss);
            document.getElementById('fm_res').innerText = res.toFixed(3);
            const stat = document.getElementById('fm_status');
            
            if (res < 0.02) { 
                stat.innerHTML = "üö® <b>Starvation</b> ‚Äì Bacteria consuming themselves. Reduce MLSS."; 
                stat.style.color = "var(--danger)"; 
            } else if (res < 0.05) { 
                stat.innerHTML = "‚ö†Ô∏è <b>Very Low</b> ‚Äì Watch for old sludge, denitrification in clarifier."; 
                stat.style.color = "var(--accent)"; 
            } else if (res <= 0.15) { 
                stat.innerHTML = "‚úì <b>Extended Aeration (0.05-0.15)</b> ‚Äì Good nitrification potential."; 
                stat.style.color = "#4ade80"; 
            } else if (res <= 0.5) { 
                stat.innerHTML = "‚úì <b>Conventional (0.15-0.5)</b> ‚Äì Standard activated sludge."; 
                stat.style.color = "#4ade80"; 
            } else if (res <= 1.0) { 
                stat.innerHTML = "‚ö° <b>High Rate (0.5-1.0)</b> ‚Äì Short SRT, high sludge yield."; 
                stat.style.color = "var(--accent)"; 
            } else { 
                stat.innerHTML = "üö® <b>Overloaded (>1.0)</b> ‚Äì BOD breakthrough risk. Increase MLSS."; 
                stat.style.color = "var(--danger)"; 
            }
        }
    }

    // 5. SRT
    function calcSRT() {
        const vol = parseFloat(document.getElementById('srt_vol').value) || 0;
        const mlss = parseFloat(document.getElementById('srt_mlss').value) || 0;
        const wasQ = parseFloat(document.getElementById('srt_wasq').value) || 0;
        const wasC = parseFloat(document.getElementById('srt_wasc').value) || 0;
        const effQ = parseFloat(document.getElementById('srt_effq').value) || 0;
        const effC = parseFloat(document.getElementById('srt_effc').value) || 0;
        
        const sludgeIn = vol * mlss * 8.34;
        const sludgeOut = (wasQ * wasC * 8.34) + (effQ * effC * 8.34);
        
        if (sludgeOut > 0) {
            const res = sludgeIn / sludgeOut;
            document.getElementById('srt_res').innerText = res.toFixed(1) + " days";
            const stat = document.getElementById('srt_status');
            
            if (res < 2) { 
                stat.innerHTML = "üö® <b>Washout Risk</b> ‚Äì Reduce WAS immediately!"; 
                stat.style.color = "var(--danger)"; 
            } else if (res < 4) { 
                stat.innerHTML = "‚ö†Ô∏è <b>Low (2-4 days)</b> ‚Äì Young sludge, limited nitrification."; 
                stat.style.color = "var(--accent)"; 
            } else if (res < 8) { 
                stat.innerHTML = "‚úì <b>Conventional (4-8 days)</b> ‚Äì Good BOD removal."; 
                stat.style.color = "#4ade80"; 
            } else if (res <= 15) { 
                stat.innerHTML = "‚úì <b>Extended (8-15 days)</b> ‚Äì Full nitrification, stable."; 
                stat.style.color = "#4ade80"; 
            } else if (res <= 25) { 
                stat.innerHTML = "‚ö° <b>Long (15-25 days)</b> ‚Äì Watch for old sludge issues."; 
                stat.style.color = "var(--primary)"; 
            } else { 
                stat.innerHTML = "‚ö†Ô∏è <b>Excessive (>25 days)</b> ‚Äì Increase wasting."; 
                stat.style.color = "var(--accent)"; 
            }
        }
    }

    // 6. Detention Time
    function calcDT() {
        const vol = parseFloat(document.getElementById('dt_vol').value) || 0;
        const flow = parseFloat(document.getElementById('dt_flow').value) || 0;
        
        if (flow > 0) {
            const res = (vol / flow) * 24;
            document.getElementById('dt_res').innerText = res.toFixed(2) + " hours";
            const stat = document.getElementById('dt_status');
            
            if (res < 2) { 
                stat.innerHTML = "‚ö° <b>Very Short (<2 hrs)</b> ‚Äì Contact tank or high-rate process."; 
                stat.style.color = "var(--accent)"; 
            } else if (res < 4) { 
                stat.innerHTML = "‚úì <b>Clarifier Range (2-4 hrs)</b> ‚Äì Typical for secondary clarifiers."; 
                stat.style.color = "#4ade80"; 
            } else if (res < 8) { 
                stat.innerHTML = "‚úì <b>Conventional (4-8 hrs)</b> ‚Äì Standard aeration basin."; 
                stat.style.color = "#4ade80"; 
            } else if (res <= 24) { 
                stat.innerHTML = "‚úì <b>Extended (8-24 hrs)</b> ‚Äì Good for nitrification."; 
                stat.style.color = "#4ade80"; 
            } else if (res <= 48) { 
                stat.innerHTML = "‚ö° <b>Long (24-48 hrs)</b> ‚Äì EQ basin or oxidation ditch."; 
                stat.style.color = "var(--primary)"; 
            } else { 
                stat.innerHTML = "‚ö†Ô∏è <b>Very Long (>48 hrs)</b> ‚Äì Lagoon range."; 
                stat.style.color = "var(--accent)"; 
            }
        }
    }

    // 7. Removal Efficiency
    function calcEff() {
        const inf = parseFloat(document.getElementById('eff_in').value) || 0;
        const eff = parseFloat(document.getElementById('eff_out').value) || 0;
        
        if (inf > 0) {
            const res = ((inf - eff) / inf) * 100;
            document.getElementById('eff_res').innerText = res.toFixed(1) + " %";
            const stat = document.getElementById('eff_status');
            
            if (res >= 95) { 
                stat.innerHTML = "üåü <b>Excellent (‚â•95%)</b> ‚Äì Outstanding performance."; 
                stat.style.color = "#4ade80"; 
            } else if (res >= 90) { 
                stat.innerHTML = "‚úì <b>Very Good (90-95%)</b> ‚Äì Exceeds most permits."; 
                stat.style.color = "#4ade80"; 
            } else if (res >= 85) { 
                stat.innerHTML = "‚úì <b>Good (85-90%)</b> ‚Äì Meeting standard goals."; 
                stat.style.color = "#4ade80"; 
            } else if (res >= 75) { 
                stat.innerHTML = "‚ö° <b>Moderate (75-85%)</b> ‚Äì Review for optimization."; 
                stat.style.color = "var(--accent)"; 
            } else if (res >= 50) { 
                stat.innerHTML = "‚ö†Ô∏è <b>Below Target (50-75%)</b> ‚Äì Investigate cause."; 
                stat.style.color = "var(--danger)"; 
            } else if (res >= 0) { 
                stat.innerHTML = "üö® <b>Poor (<50%)</b> ‚Äì Process upset likely."; 
                stat.style.color = "var(--danger)"; 
            } else { 
                stat.innerHTML = "üö® <b>Negative</b> ‚Äì Effluent worse than influent!"; 
                stat.style.color = "var(--danger)"; 
            }
        }
    }

    // 8. WAS Pumping Rate
    function calcWAS() {
        const vol = parseFloat(document.getElementById('was_vol').value) || 0;
        const mlss = parseFloat(document.getElementById('was_mlss').value) || 0;
        const srt = parseFloat(document.getElementById('was_srt').value) || 0;
        const conc = parseFloat(document.getElementById('was_conc').value) || 0;
        
        if (srt > 0 && conc > 0) {
            // WAS Flow (MG) = (Vol √ó MLSS) √∑ (SRT √ó WAS Conc)
            const wasMGD = (vol * mlss) / (srt * conc);
            const wasGPD = wasMGD * 1000000;
            document.getElementById('was_res').innerText = wasGPD.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPD";
            const stat = document.getElementById('was_status');
            const wasGPM = wasGPD / 1440;
            stat.innerHTML = "üìä <b>" + wasGPM.toFixed(1) + " GPM</b> continuous, or <b>" + (wasGPM * 2).toFixed(1) + " GPM</b> for 12 hrs/day";
            stat.style.color = "#94a3b8";
        }
    }

    // 9. RAS Return Rate
    function calcRAS() {
        const flow = parseFloat(document.getElementById('ras_flow').value) || 0;
        const mlss = parseFloat(document.getElementById('ras_mlss').value) || 0;
        const conc = parseFloat(document.getElementById('ras_conc').value) || 0;
        
        if (conc > mlss && conc > 0) {
            // RAS = (Q √ó MLSS) √∑ (RAS Conc - MLSS)
            const ras = (flow * mlss) / (conc - mlss);
            document.getElementById('ras_res').innerText = ras.toFixed(3) + " MGD";
            const stat = document.getElementById('ras_status');
            const ratio = (ras / flow * 100).toFixed(0);
            if (ratio < 25) {
                stat.innerHTML = "‚ö° <b>" + ratio + "% RAS Ratio</b> ‚Äì Low return rate. Verify blanket depth.";
                stat.style.color = "var(--accent)";
            } else if (ratio <= 100) {
                stat.innerHTML = "‚úì <b>" + ratio + "% RAS Ratio</b> ‚Äì Normal operating range (25-100%).";
                stat.style.color = "#4ade80";
            } else {
                stat.innerHTML = "‚ö†Ô∏è <b>" + ratio + "% RAS Ratio</b> ‚Äì High return. Check RAS concentration.";
                stat.style.color = "var(--accent)";
            }
        } else if (conc <= mlss && conc > 0) {
            document.getElementById('ras_status').innerHTML = "‚ö†Ô∏è <b>Check Values</b> ‚Äì RAS conc must be higher than MLSS";
            document.getElementById('ras_status').style.color = "var(--danger)";
        }
    }

    // 10. Organic Loading Rate
    function calcOLR() {
        const flow = parseFloat(document.getElementById('olr_flow').value) || 0;
        const bod = parseFloat(document.getElementById('olr_bod').value) || 0;
        const vol = parseFloat(document.getElementById('olr_vol').value) || 0;
        
        if (vol > 0) {
            // OLR = (Flow √ó BOD √ó 8.34) √∑ Volume (1000 ft¬≥)
            const olr = (flow * bod * 8.34) / vol;
            document.getElementById('olr_res').innerText = olr.toFixed(1) + " lbs/day/1000ft¬≥";
            const stat = document.getElementById('olr_status');
            
            if (olr < 5) {
                stat.innerHTML = "‚ö° <b>Low Rate (<5)</b> ‚Äì Under-loaded, may have operational issues.";
                stat.style.color = "var(--accent)";
            } else if (olr <= 25) {
                stat.innerHTML = "‚úì <b>Low-Rate TF (5-25)</b> ‚Äì Standard trickling filter range.";
                stat.style.color = "#4ade80";
            } else if (olr <= 100) {
                stat.innerHTML = "‚úì <b>High-Rate TF (25-100)</b> ‚Äì Higher loading, needs recirculation.";
                stat.style.color = "#4ade80";
            } else if (olr <= 300) {
                stat.innerHTML = "‚ö° <b>Roughing Filter (100-300)</b> ‚Äì Very high rate, partial treatment only.";
                stat.style.color = "var(--accent)";
            } else {
                stat.innerHTML = "‚ö†Ô∏è <b>Overloaded (>300)</b> ‚Äì Exceeds typical design limits.";
                stat.style.color = "var(--danger)";
            }
        }
    }

    // 11. Surface Overflow Rate
    function calcSOR() {
        const flow = parseFloat(document.getElementById('sor_flow').value) || 0;
        const area = parseFloat(document.getElementById('sor_area').value) || 0;
        
        if (area > 0) {
            const sor = flow / area;
            document.getElementById('sor_res').innerText = sor.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPD/ft¬≤";
            const stat = document.getElementById('sor_status');
            
            if (sor < 300) {
                stat.innerHTML = "‚ö° <b>Very Low (<300)</b> ‚Äì Under-utilized clarifier.";
                stat.style.color = "var(--primary)";
            } else if (sor <= 600) {
                stat.innerHTML = "‚úì <b>Primary SOR (300-600)</b> ‚Äì Good for primary settling.";
                stat.style.color = "#4ade80";
            } else if (sor <= 800) {
                stat.innerHTML = "‚úì <b>Secondary SOR (400-800)</b> ‚Äì Typical for activated sludge.";
                stat.style.color = "#4ade80";
            } else if (sor <= 1200) {
                stat.innerHTML = "‚ö†Ô∏è <b>High (800-1200)</b> ‚Äì Peak flow range. Monitor effluent TSS.";
                stat.style.color = "var(--accent)";
            } else {
                stat.innerHTML = "üö® <b>Overloaded (>1200)</b> ‚Äì Risk of solids carryover.";
                stat.style.color = "var(--danger)";
            }
        }
    }

    // 12. Weir Overflow Rate
    function calcWOR() {
        const flow = parseFloat(document.getElementById('wor_flow').value) || 0;
        const len = parseFloat(document.getElementById('wor_len').value) || 0;
        
        if (len > 0) {
            const wor = flow / len;
            document.getElementById('wor_res').innerText = wor.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPD/ft";
            const stat = document.getElementById('wor_status');
            
            if (wor <= 10000) {
                stat.innerHTML = "‚úì <b>Excellent (‚â§10,000)</b> ‚Äì Low turbulence, good settling.";
                stat.style.color = "#4ade80";
            } else if (wor <= 15000) {
                stat.innerHTML = "‚úì <b>Good (10,000-15,000)</b> ‚Äì Acceptable for most clarifiers.";
                stat.style.color = "#4ade80";
            } else if (wor <= 20000) {
                stat.innerHTML = "‚ö†Ô∏è <b>High (15,000-20,000)</b> ‚Äì May cause turbulence. Monitor TSS.";
                stat.style.color = "var(--accent)";
            } else {
                stat.innerHTML = "üö® <b>Excessive (>20,000)</b> ‚Äì Risk of floc disruption and carryover.";
                stat.style.color = "var(--danger)";
            }
        }
    }

    // 13. Solids Loading Rate
    function calcSLR() {
        const flow = parseFloat(document.getElementById('slr_flow').value) || 0;
        const mlss = parseFloat(document.getElementById('slr_mlss').value) || 0;
        const area = parseFloat(document.getElementById('slr_area').value) || 0;
        
        if (area > 0) {
            // SLR = (Flow √ó MLSS √ó 8.34) √∑ Area
            const slr = (flow * mlss * 8.34) / area;
            document.getElementById('slr_res').innerText = slr.toFixed(2) + " lbs/day/ft¬≤";
            const stat = document.getElementById('slr_status');
            
            if (slr < 10) {
                stat.innerHTML = "‚ö° <b>Low (<10)</b> ‚Äì Under-loaded clarifier. Good settling expected.";
                stat.style.color = "var(--primary)";
            } else if (slr <= 25) {
                stat.innerHTML = "‚úì <b>Normal (10-25)</b> ‚Äì Typical for secondary clarifiers.";
                stat.style.color = "#4ade80";
            } else if (slr <= 35) {
                stat.innerHTML = "‚ö†Ô∏è <b>High (25-35)</b> ‚Äì Peak flow range. Watch blanket depth.";
                stat.style.color = "var(--accent)";
            } else {
                stat.innerHTML = "üö® <b>Overloaded (>35)</b> ‚Äì Risk of solids loss. Reduce RAS or increase area.";
                stat.style.color = "var(--danger)";
            }
        }
    }

    // 14. Chemical Dosing
    function calcChem() {
        const flow = parseFloat(document.getElementById('chem_flow').value) || 0;
        const dose = parseFloat(document.getElementById('chem_dose').value) || 0;
        const purity = parseFloat(document.getElementById('chem_purity').value) || 100;
        
        if (purity > 0) {
            // lbs/day = (Flow √ó Dose √ó 8.34) √∑ (Purity/100)
            const lbs = (flow * dose * 8.34) / (purity / 100);
            document.getElementById('chem_res').innerText = lbs.toFixed(2) + " lbs/day";
            const stat = document.getElementById('chem_status');
            const gallons = lbs / 8.34; // Approximate for liquids
            stat.innerHTML = "üìä <b>" + lbs.toFixed(1) + " lbs/day</b> of chemical product | ~" + gallons.toFixed(1) + " gal/day if liquid";
            stat.style.color = "#94a3b8";
        }
    }

    // ==================== MBR CALCULATIONS ====================

    // 15. Membrane Flux Rate
    function calcFlux() {
        const flow = parseFloat(document.getElementById('flux_flow').value) || 0;
        const area = parseFloat(document.getElementById('flux_area').value) || 0;
        
        if (area > 0) {
            const gfd = flow / area;
            document.getElementById('flux_res').innerText = gfd.toFixed(1) + " GFD";
            const stat = document.getElementById('flux_status');
            
            // Also show LMH for international reference
            const lmh = gfd * 1.6985;
            
            if (gfd < 5) {
                stat.innerHTML = "üö® <b>Very Low (<5 GFD)</b> ‚Äì Severe fouling likely. Initiate recovery clean (CIP). Check TMP.";
                stat.style.color = "var(--danger)";
            } else if (gfd < 8) {
                stat.innerHTML = "‚ö†Ô∏è <b>Low (5‚Äì8 GFD)</b> ‚Äì Fouling developing. Schedule maintenance clean. (" + lmh.toFixed(1) + " LMH)";
                stat.style.color = "var(--accent)";
            } else if (gfd <= 15) {
                stat.innerHTML = "‚úì <b>Normal (8‚Äì15 GFD)</b> ‚Äì Healthy operating range. (" + lmh.toFixed(1) + " LMH)";
                stat.style.color = "#4ade80";
            } else if (gfd <= 25) {
                stat.innerHTML = "‚ö° <b>High (15‚Äì25 GFD)</b> ‚Äì Peak flow range acceptable short-term. (" + lmh.toFixed(1) + " LMH)";
                stat.style.color = "var(--accent)";
            } else {
                stat.innerHTML = "üö® <b>Excessive (>25 GFD)</b> ‚Äì Risk of irreversible membrane damage. Reduce flow immediately.";
                stat.style.color = "var(--danger)";
            }
        }
    }

    // 16. Transmembrane Pressure
    function calcTMP() {
        const feed = parseFloat(document.getElementById('tmp_feed').value) || 0;
        const perm = parseFloat(document.getElementById('tmp_perm').value) || 0;
        
        if (feed > 0 || perm > 0) {
            const tmp = feed - perm;
            const kpa = tmp * 6.895;
            document.getElementById('tmp_res').innerText = tmp.toFixed(1) + " psi";
            const stat = document.getElementById('tmp_status');
            
            if (tmp < 0) {
                stat.innerHTML = "‚ö†Ô∏è <b>Negative TMP</b> ‚Äì Check pressure gauge readings. Feed should be > Permeate.";
                stat.style.color = "var(--danger)";
            } else if (tmp <= 3) {
                stat.innerHTML = "‚úì <b>Excellent (0‚Äì3 psi)</b> ‚Äì Clean membranes, low resistance. (" + kpa.toFixed(1) + " kPa)";
                stat.style.color = "#4ade80";
            } else if (tmp <= 7) {
                stat.innerHTML = "‚úì <b>Normal (3‚Äì7 psi)</b> ‚Äì Typical operating range. Monitor trend. (" + kpa.toFixed(1) + " kPa)";
                stat.style.color = "#4ade80";
            } else if (tmp <= 12) {
                stat.innerHTML = "‚ö†Ô∏è <b>Elevated (7‚Äì12 psi)</b> ‚Äì Fouling developing. Schedule maintenance clean. (" + kpa.toFixed(1) + " kPa)";
                stat.style.color = "var(--accent)";
            } else {
                stat.innerHTML = "üö® <b>High (>12 psi)</b> ‚Äì Recovery CIP required. Risk of membrane damage if sustained. (" + kpa.toFixed(1) + " kPa)";
                stat.style.color = "var(--danger)";
            }
        }
    }

    // 17. Membrane Permeability
    function calcPerm() {
        const flux = parseFloat(document.getElementById('perm_flux').value) || 0;
        const tmp = parseFloat(document.getElementById('perm_tmp').value) || 0;
        
        if (tmp > 0) {
            const perm = flux / tmp;
            const lmhBar = perm * 1.6985 / 0.0689476; // Convert GFD/psi to LMH/bar
            document.getElementById('perm_res').innerText = perm.toFixed(2) + " GFD/psi";
            const stat = document.getElementById('perm_status');
            
            if (perm >= 5) {
                stat.innerHTML = "‚úì <b>Excellent (‚â•5)</b> ‚Äì Clean membrane performance. (" + lmhBar.toFixed(1) + " LMH/bar)";
                stat.style.color = "#4ade80";
            } else if (perm >= 3) {
                stat.innerHTML = "‚úì <b>Good (3‚Äì5)</b> ‚Äì Normal operating condition. (" + lmhBar.toFixed(1) + " LMH/bar)";
                stat.style.color = "#4ade80";
            } else if (perm >= 1.5) {
                stat.innerHTML = "‚ö†Ô∏è <b>Declining (1.5‚Äì3)</b> ‚Äì Fouling progressing. Plan maintenance clean. (" + lmhBar.toFixed(1) + " LMH/bar)";
                stat.style.color = "var(--accent)";
            } else {
                stat.innerHTML = "üö® <b>Poor (<1.5)</b> ‚Äì Significant fouling. Recovery CIP required. (" + lmhBar.toFixed(1) + " LMH/bar)";
                stat.style.color = "var(--danger)";
            }
        } else if (flux > 0 && tmp === 0) {
            document.getElementById('perm_status').innerHTML = "‚ö†Ô∏è TMP cannot be zero ‚Äî enter measured pressure.";
            document.getElementById('perm_status').style.color = "var(--danger)";
        }
    }

    // 18. Membrane Area Sizing
    function calcMSize() {
        const flow = parseFloat(document.getElementById('msize_flow').value) || 0;
        const pf = parseFloat(document.getElementById('msize_pf').value) || 0;
        const avgFlux = parseFloat(document.getElementById('msize_flux').value) || 0;
        const peakFlux = parseFloat(document.getElementById('msize_peak').value) || 0;
        
        if (flow > 0 && avgFlux > 0) {
            const flowGPD = flow * 1000000;
            const areaAvg = flowGPD / avgFlux;
            let areaPeak = 0;
            let peakCheck = "";
            
            if (pf > 0 && peakFlux > 0) {
                areaPeak = (flowGPD * pf) / peakFlux;
                const actualPeakFlux = (flowGPD * pf) / areaAvg;
                if (actualPeakFlux > 25) {
                    peakCheck = "<br>‚ö†Ô∏è Peak flux on avg-sized area = " + actualPeakFlux.toFixed(1) + " GFD ‚Äî exceeds 25 GFD limit!";
                } else {
                    peakCheck = "<br>‚úì Peak flux on avg-sized area = " + actualPeakFlux.toFixed(1) + " GFD ‚Äî within limits.";
                }
            }
            
            const designArea = Math.max(areaAvg, areaPeak);
            const fmt = designArea.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            document.getElementById('msize_res').innerText = fmt + " ft¬≤";
            const stat = document.getElementById('msize_status');
            
            stat.innerHTML = "üìä <b>Avg design:</b> " + areaAvg.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " ft¬≤" +
                (areaPeak > 0 ? " | <b>Peak design:</b> " + areaPeak.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " ft¬≤" : "") +
                peakCheck + "<br>Governing area: <b>" + fmt + " ft¬≤</b> (" + (designArea / 1000).toFixed(1) + "k ft¬≤)";
            stat.style.color = "#94a3b8";
        }
    }

    // 19. Specific Aeration Demand
    function calcSAD() {
        const air = parseFloat(document.getElementById('sad_air').value) || 0;
        const area = parseFloat(document.getElementById('sad_area').value) || 0;
        const perm = parseFloat(document.getElementById('sad_perm').value) || 0;
        
        if (air > 0 && (area > 0 || perm > 0)) {
            let results = [];
            let sadmVal = 0, sadpVal = 0;
            const stat = document.getElementById('sad_status');
            
            if (area > 0) {
                sadmVal = air / area;
                results.push("SADm = " + sadmVal.toFixed(3) + " Nm¬≥/m¬≤/hr");
            }
            if (perm > 0) {
                sadpVal = air / perm;
                results.push("SADp = " + sadpVal.toFixed(1) + " m¬≥air/m¬≥perm");
            }
            
            document.getElementById('sad_res').innerText = results.join(" | ");
            
            let assessment = [];
            if (sadmVal > 0) {
                if (sadmVal < 0.2) assessment.push("‚ö° SADm very low ‚Äî verify adequate scouring");
                else if (sadmVal <= 0.5) assessment.push("‚úì SADm in hollow fiber range (0.2‚Äì0.5)");
                else if (sadmVal <= 1.0) assessment.push("‚úì SADm in flat sheet range (0.5‚Äì1.0)");
                else assessment.push("‚ö†Ô∏è SADm high ‚Äî excessive air scouring energy");
            }
            if (sadpVal > 0) {
                if (sadpVal < 10) assessment.push("‚úì SADp efficient (<10)");
                else if (sadpVal <= 25) assessment.push("‚úì SADp typical (10‚Äì25)");
                else assessment.push("‚ö†Ô∏è SADp high (>25) ‚Äî energy optimization opportunity");
            }
            
            stat.innerHTML = assessment.join("<br>");
            stat.style.color = (sadmVal > 1.0 || sadpVal > 25) ? "var(--accent)" : "#4ade80";
        }
    }

    // 20. MBR Operating Range Check
    function calcMBRC() {
        const mlss = parseFloat(document.getElementById('mbrc_mlss').value) || 0;
        const srt = parseFloat(document.getElementById('mbrc_srt').value) || 0;
        const fm = parseFloat(document.getElementById('mbrc_fm').value) || 0;
        const doVal = parseFloat(document.getElementById('mbrc_do').value) || 0;
        
        let checks = [];
        let issues = 0;
        let entered = 0;
        
        if (mlss > 0) {
            entered++;
            if (mlss < 6000) { checks.push("üö® <b>MLSS " + mlss + "</b> ‚Äì Too low for MBR. Target 8,000‚Äì12,000 mg/L."); issues++; }
            else if (mlss < 8000) { checks.push("‚ö†Ô∏è <b>MLSS " + mlss + "</b> ‚Äì Below MBR range. May reduce membrane protection."); issues++; }
            else if (mlss <= 12000) { checks.push("‚úì <b>MLSS " + mlss + "</b> ‚Äì Within MBR range (8,000‚Äì12,000)."); }
            else if (mlss <= 15000) { checks.push("‚ö†Ô∏è <b>MLSS " + mlss + "</b> ‚Äì High. Increases viscosity & TMP."); issues++; }
            else { checks.push("üö® <b>MLSS " + mlss + "</b> ‚Äì Excessive. Rapid fouling risk. Increase wasting."); issues++; }
        }
        
        if (srt > 0) {
            entered++;
            if (srt < 10) { checks.push("üö® <b>SRT " + srt + "d</b> ‚Äì Too low for MBR. Target 15‚Äì40 days."); issues++; }
            else if (srt < 15) { checks.push("‚ö†Ô∏è <b>SRT " + srt + "d</b> ‚Äì Below typical MBR. May lose nitrifiers."); issues++; }
            else if (srt <= 40) { checks.push("‚úì <b>SRT " + srt + "d</b> ‚Äì Within MBR range (15‚Äì40 days)."); }
            else { checks.push("‚ö†Ô∏è <b>SRT " + srt + "d</b> ‚Äì Very high. Risk of EPS buildup & fouling."); issues++; }
        }
        
        if (fm > 0) {
            entered++;
            if (fm < 0.04) { checks.push("‚ö†Ô∏è <b>F:M " + fm + "</b> ‚Äì Very low. Endogenous conditions, possible pin floc."); issues++; }
            else if (fm <= 0.15) { checks.push("‚úì <b>F:M " + fm + "</b> ‚Äì Within MBR range (0.05‚Äì0.15)."); }
            else if (fm <= 0.25) { checks.push("‚ö†Ô∏è <b>F:M " + fm + "</b> ‚Äì High for MBR. More typical of CAS."); issues++; }
            else { checks.push("üö® <b>F:M " + fm + "</b> ‚Äì Exceeds MBR range. This is CAS territory (>0.2)."); issues++; }
        }
        
        if (doVal > 0) {
            entered++;
            if (doVal < 0.5) { checks.push("üö® <b>DO " + doVal + "</b> ‚Äì Critically low. Risk of filaments & poor nitrification."); issues++; }
            else if (doVal < 1.0) { checks.push("‚ö†Ô∏è <b>DO " + doVal + "</b> ‚Äì Below MBR minimum. Increase aeration."); issues++; }
            else if (doVal <= 3.0) { checks.push("‚úì <b>DO " + doVal + "</b> ‚Äì Within MBR range (1.0‚Äì3.0 mg/L)."); }
            else { checks.push("‚ö° <b>DO " + doVal + "</b> ‚Äì Higher than needed. Energy savings opportunity."); }
        }
        
        if (entered > 0) {
            const score = entered - issues;
            document.getElementById('mbrc_res').innerText = score + "/" + entered + " In Range";
            const stat = document.getElementById('mbrc_status');
            stat.innerHTML = checks.join("<br>");
            stat.style.color = issues === 0 ? "#4ade80" : (issues >= entered/2 ? "var(--danger)" : "var(--accent)");
        }
    }

    // 21. CIP Chemical Dosing
    function calcCIP() {
        const vol = parseFloat(document.getElementById('cip_vol').value) || 0;
        const naclTarget = parseFloat(document.getElementById('cip_nacl').value) || 0;
        const bleachPct = parseFloat(document.getElementById('cip_bleach').value) || 0;
        const citTarget = parseFloat(document.getElementById('cip_citric').value) || 0;
        const citPct = parseFloat(document.getElementById('cip_cstr').value) || 0;
        
        if (vol > 0) {
            let results = [];
            let details = [];
            const volLiters = vol * 3.785;
            
            // NaOCl calculation
            if (naclTarget > 0 && bleachPct > 0) {
                // Volume (gal) = (Tank gal √ó Target mg/L) √∑ (Strength% √ó 10,000)
                const naclGal = (vol * naclTarget) / (bleachPct * 10000);
                const naclOz = naclGal * 128;
                results.push("NaOCl: " + naclGal.toFixed(2) + " gal");
                
                let cleanType = "";
                if (naclTarget <= 500) cleanType = "Maintenance Clean range";
                else if (naclTarget <= 2000) cleanType = "Recovery Clean range";
                else cleanType = "‚ö†Ô∏è Exceeds typical ‚Äî verify with membrane manufacturer";
                
                details.push("üß™ <b>NaOCl:</b> " + naclGal.toFixed(2) + " gal (" + naclOz.toFixed(0) + " fl oz) of " + bleachPct + "% bleach ‚Üí " + naclTarget + " mg/L ‚Äî " + cleanType);
            }
            
            // Citric acid calculation
            if (citTarget > 0 && citPct > 0) {
                const citGal = (vol * citTarget) / (citPct * 10000);
                const citLbs = citGal * 8.34 * (citPct / 100);
                results.push("Citric: " + citGal.toFixed(2) + " gal");
                
                let cleanType = "";
                if (citTarget <= 2000) cleanType = "Maintenance Clean range";
                else if (citTarget <= 5000) cleanType = "Recovery Clean range";
                else cleanType = "‚ö†Ô∏è Exceeds typical ‚Äî verify dosage";
                
                details.push("üß™ <b>Citric Acid:</b> " + citGal.toFixed(2) + " gal of " + citPct + "% solution ‚Üí " + citTarget + " mg/L ‚Äî " + cleanType);
            }
            
            if (results.length > 0) {
                document.getElementById('cip_res').innerText = results.join(" | ");
                const stat = document.getElementById('cip_status');
                details.push("<br>‚ö†Ô∏è <b>Safety:</b> Never mix NaOCl and citric acid. Rinse between steps. Soak 4‚Äì6 hrs typical.");
                stat.innerHTML = details.join("<br>");
                stat.style.color = "#94a3b8";
            }
        }
    }

    // ==================== MBBR CALCULATIONS ====================

    // 22. Surface Area Loading Rate
    function calcSALR() {
        const flow = parseFloat(document.getElementById('salr_flow').value) || 0;
        const conc = parseFloat(document.getElementById('salr_conc').value) || 0;
        const area = parseFloat(document.getElementById('salr_area').value) || 0;
        
        if (area > 0 && flow > 0 && conc > 0) {
            // Load (g/day) = Flow (MGD) √ó Conc (mg/L) √ó 3,785,412 (L/MG) / 1000 (mg/g)
            // SALR = Load / Area
            const loadGday = flow * conc * 3785.412;
            const salr = loadGday / area;
            document.getElementById('salr_res').innerText = salr.toFixed(1) + " g/m¬≤/d";
            const stat = document.getElementById('salr_status');
            
            const loadLbs = flow * conc * 8.34;
            
            if (conc > 50) {
                // BOD loading interpretation
                if (salr < 5) {
                    stat.innerHTML = "‚ö° <b>Low SALR (<5)</b> ‚Äì Under-loaded biofilm. Media may be oversized. Load: " + loadLbs.toFixed(0) + " lbs/day";
                    stat.style.color = "var(--primary)";
                } else if (salr <= 10) {
                    stat.innerHTML = "‚úì <b>Moderate (5‚Äì10)</b> ‚Äì Conservative BOD removal. Good for cold climate. Load: " + loadLbs.toFixed(0) + " lbs/day";
                    stat.style.color = "#4ade80";
                } else if (salr <= 20) {
                    stat.innerHTML = "‚úì <b>Typical (10‚Äì20)</b> ‚Äì Standard BOD removal range. Load: " + loadLbs.toFixed(0) + " lbs/day";
                    stat.style.color = "#4ade80";
                } else {
                    stat.innerHTML = "‚ö†Ô∏è <b>High (>20)</b> ‚Äì May exceed biofilm capacity. Check effluent quality. Load: " + loadLbs.toFixed(0) + " lbs/day";
                    stat.style.color = "var(--accent)";
                }
            } else {
                // NH3 loading interpretation
                if (salr < 0.5) {
                    stat.innerHTML = "‚ö° <b>Low (<0.5)</b> ‚Äì Under-loaded for nitrification. Load: " + loadLbs.toFixed(1) + " lbs/day";
                    stat.style.color = "var(--primary)";
                } else if (salr <= 1.5) {
                    stat.innerHTML = "‚úì <b>Typical (0.5‚Äì1.5)</b> ‚Äì Standard nitrification range. Load: " + loadLbs.toFixed(1) + " lbs/day";
                    stat.style.color = "#4ade80";
                } else {
                    stat.innerHTML = "‚ö†Ô∏è <b>High (>1.5)</b> ‚Äì May need additional area for full nitrification. Load: " + loadLbs.toFixed(1) + " lbs/day";
                    stat.style.color = "var(--accent)";
                }
            }
        }
    }

    // 23. Effective Biofilm Area
    function calcBioArea() {
        const vol = parseFloat(document.getElementById('bio_vol').value) || 0;
        const fill = parseFloat(document.getElementById('bio_fill').value) || 0;
        const ssa = parseFloat(document.getElementById('bio_ssa').value) || 0;
        
        if (vol > 0 && fill > 0 && ssa > 0) {
            const volM3 = vol * 0.0283168; // ft¬≥ to m¬≥
            const mediaM3 = volM3 * (fill / 100);
            const area = mediaM3 * ssa;
            const fmt = area.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            document.getElementById('bio_res').innerText = fmt + " m¬≤";
            const stat = document.getElementById('bio_status');
            
            const areaFt2 = area * 10.764;
            
            let fillCheck = "";
            if (fill < 40) fillCheck = "‚ö†Ô∏è Fill below 40% ‚Äî under-utilizing reactor volume.";
            else if (fill <= 67) fillCheck = "‚úì Fill " + fill + "% within design range (40‚Äì67%).";
            else fillCheck = "üö® Fill " + fill + "% exceeds 67% max ‚Äî media cannot circulate properly!";
            
            stat.innerHTML = "üìä <b>" + fmt + " m¬≤</b> (" + areaFt2.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " ft¬≤) protected biofilm area" +
                "<br>Media volume: " + mediaM3.toFixed(1) + " m¬≥ (" + (mediaM3 * 35.3147).toFixed(0) + " ft¬≥)" +
                "<br>" + fillCheck;
            stat.style.color = fill > 67 ? "var(--danger)" : "#4ade80";
        }
    }

    // 24. Media Fill Volume
    function calcMediaVol() {
        const flow = parseFloat(document.getElementById('mv_flow').value) || 0;
        const conc = parseFloat(document.getElementById('mv_conc').value) || 0;
        const salr = parseFloat(document.getElementById('mv_salr').value) || 0;
        const ssa = parseFloat(document.getElementById('mv_ssa').value) || 0;
        
        if (flow > 0 && conc > 0 && salr > 0 && ssa > 0) {
            const loadGday = flow * conc * 3785.412;
            const reqArea = loadGday / salr;
            const mediaVol = reqArea / ssa;
            const mediaFt3 = mediaVol * 35.3147;
            document.getElementById('mv_res').innerText = mediaVol.toFixed(1) + " m¬≥";
            const stat = document.getElementById('mv_status');
            
            // Show reactor sizes at different fill fractions
            const r50 = mediaVol / 0.50;
            const r55 = mediaVol / 0.55;
            const r60 = mediaVol / 0.60;
            
            stat.innerHTML = "üìä Required biofilm area: <b>" + reqArea.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " m¬≤</b>" +
                "<br>Media volume: <b>" + mediaVol.toFixed(1) + " m¬≥</b> (" + mediaFt3.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " ft¬≥)" +
                "<br>Reactor needed @ 50% fill: " + r50.toFixed(1) + " m¬≥ | 55%: " + r55.toFixed(1) + " m¬≥ | 60%: " + r60.toFixed(1) + " m¬≥";
            stat.style.color = "#94a3b8";
        }
    }

    // 25. MBBR Reactor Sizing
    function calcRSZ() {
        const media = parseFloat(document.getElementById('rsz_media').value) || 0;
        const fill = parseFloat(document.getElementById('rsz_fill').value) || 0;
        const flow = parseFloat(document.getElementById('rsz_flow').value) || 0;
        
        if (media > 0 && fill > 0) {
            const reactor = media / (fill / 100);
            const reactorFt3 = reactor * 35.3147;
            const reactorGal = reactor * 264.172;
            document.getElementById('rsz_res').innerText = reactor.toFixed(1) + " m¬≥";
            const stat = document.getElementById('rsz_status');
            
            let hrtInfo = "";
            if (flow > 0) {
                const flowM3hr = flow * 3785.412 / 24;
                const hrt = reactor / flowM3hr;
                hrtInfo = "<br>HRT: <b>" + hrt.toFixed(1) + " hrs</b>";
                if (hrt < 1) hrtInfo += " ‚Äî ‚ö†Ô∏è Very short, may need larger reactor";
                else if (hrt <= 3) hrtInfo += " ‚Äî Typical for BOD removal";
                else if (hrt <= 6) hrtInfo += " ‚Äî Good for nitrification";
                else hrtInfo += " ‚Äî Long HRT, may be oversized";
            }
            
            let fillCheck = "";
            if (fill > 67) fillCheck = "<br>üö® Fill " + fill + "% exceeds 67% max ‚Äî media cannot circulate!";
            else if (fill < 40) fillCheck = "<br>‚ö†Ô∏è Fill " + fill + "% below 40% ‚Äî reactor volume under-utilized";
            else fillCheck = "<br>‚úì Fill " + fill + "% in design range";
            
            stat.innerHTML = "üìä Reactor: <b>" + reactor.toFixed(1) + " m¬≥</b> (" + reactorFt3.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " ft¬≥ | " + 
                reactorGal.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " gal)" + hrtInfo + fillCheck;
            stat.style.color = fill > 67 ? "var(--danger)" : "#4ade80";
        }
    }

    // 26. MBBR Dissolved Oxygen Demand
    function calcMDO() {
        const flow = parseFloat(document.getElementById('mdo_flow').value) || 0;
        const bod = parseFloat(document.getElementById('mdo_bod').value) || 0;
        const nh3 = parseFloat(document.getElementById('mdo_nh3').value) || 0;
        
        if (flow > 0 && (bod > 0 || nh3 > 0)) {
            const o2bod = flow * bod * 8.34 * 1.5;
            const o2nh3 = flow * nh3 * 8.34 * 4.6;
            const total = o2bod + o2nh3;
            document.getElementById('mdo_res').innerText = total.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs O‚ÇÇ/day";
            const stat = document.getElementById('mdo_status');
            
            const totalKg = total / 2.205;
            
            stat.innerHTML = "üìä <b>BOD oxidation:</b> " + o2bod.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs/day (1.5√ó BOD removed)" +
                "<br><b>Nitrification:</b> " + o2nh3.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs/day (4.6√ó NH‚ÇÉ-N oxidized)" +
                "<br><b>Total:</b> " + total.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs/day (" + totalKg.toFixed(0) + " kg/day)" +
                "<br>‚ö° Maintain DO ‚â• 4 mg/L in MBBR zone (vs ~2 mg/L for CAS)";
            stat.style.color = "#94a3b8";
        }
    }

    // 27. MBBR vs CAS Comparison
    function calcCMP() {
        const flow = parseFloat(document.getElementById('cmp_flow').value) || 0;
        const bod = parseFloat(document.getElementById('cmp_bod').value) || 0;
        
        if (flow > 0 && bod > 0) {
            // CAS assumptions: F:M=0.3, MLSS=3000 mg/L
            const casLoad = flow * bod * 8.34;
            const casVol = (casLoad / (0.3 * 3000)) * 1000000; // gallons
            const casVolFt3 = casVol / 7.481;
            const casHRT = casVol / (flow * 1000000) * 24;
            
            // MBBR assumptions: SALR=10 g/m¬≤/d, K3 500 m¬≤/m¬≥, 55% fill
            const loadGday = flow * bod * 3785.412;
            const reqArea = loadGday / 10;
            const mediaVol = reqArea / 500;
            const mbbrVol = mediaVol / 0.55;
            const mbbrVolGal = mbbrVol * 264.172;
            const mbbrVolFt3 = mbbrVol * 35.3147;
            const mbbrHRT = mbbrVol / (flow * 3785.412 / 24);
            
            const savings = ((1 - mbbrVolFt3 / casVolFt3) * 100);
            
            document.getElementById('cmp_res').innerText = "MBBR " + (savings > 0 ? savings.toFixed(0) + "% smaller" : Math.abs(savings).toFixed(0) + "% larger");
            const stat = document.getElementById('cmp_status');
            
            stat.innerHTML = "<b>‚îÅ‚îÅ CAS (Conventional) ‚îÅ‚îÅ</b>" +
                "<br>F:M=0.3 | MLSS=3,000 | SRT~10d" +
                "<br>Volume: " + (casVolFt3/1000).toFixed(1) + "k ft¬≥ (" + (casVol/1000).toFixed(0) + "k gal)" +
                "<br>HRT: " + casHRT.toFixed(1) + " hrs" +
                "<br><br><b>‚îÅ‚îÅ MBBR (Biofilm) ‚îÅ‚îÅ</b>" +
                "<br>SALR=10 g/m¬≤/d | K3 500 m¬≤/m¬≥ | 55% fill" +
                "<br>Volume: " + (mbbrVolFt3/1000).toFixed(1) + "k ft¬≥ (" + (mbbrVolGal/1000).toFixed(0) + "k gal)" +
                "<br>HRT: " + mbbrHRT.toFixed(1) + " hrs | Media: " + mediaVol.toFixed(0) + " m¬≥" +
                "<br><br>üîÑ <b>MBBR is " + Math.abs(savings).toFixed(0) + "% " + (savings > 0 ? "smaller" : "larger") + " footprint</b> than CAS for same load";
            stat.style.color = "#94a3b8";
        }
    }

    // ==================== PWA ====================
    let deferredPrompt;
    
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .catch(err => console.log('SW error:', err));
        });
    }

    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        document.getElementById('installPrompt').style.display = 'flex';
    });

    function installApp() {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then(() => {
                deferredPrompt = null;
                document.getElementById('installPrompt').style.display = 'none';
            });
        }
    }

    function dismissInstall() {
        document.getElementById('installPrompt').style.display = 'none';
    }

    // Refresh app - clear cache and reload
    function refreshApp() {
        showToast('Checking for updates...', '');
        vibrate();
        
        if ('serviceWorker' in navigator && 'caches' in window) {
            // Clear all caches
            caches.keys().then(names => {
                names.forEach(name => caches.delete(name));
            });
            
            // Unregister service worker and reload
            navigator.serviceWorker.getRegistrations().then(registrations => {
                registrations.forEach(registration => registration.unregister());
            }).then(() => {
                setTimeout(() => {
                    window.location.reload(true);
                }, 500);
            });
        } else {
            window.location.reload(true);
        }
    }

    // ==================== INIT ====================
    window.addEventListener('load', () => {
        restoreData();
        updateNav();
    });
</script>
</body>
</html>
