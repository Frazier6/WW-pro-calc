<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="description" content="Essential wastewater treatment calculations for operators">
    <meta name="author" content="Armand Frazier Sr.">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="WW Pro-Calc">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>WW Operator Pro-Calc</title>
    <style>
        :root {
            --bg: #0f172a; --card: #1e293b; --text: #f8fafc;
            --primary: #3b82f6; --accent: #f59e0b; --danger: #ef4444;
            --success: #10b981; --card-header: #334155;
        }
        body.light-theme {
            --bg: #f1f5f9; --card: #ffffff; --text: #1e293b;
            --card-header: #e2e8f0;
        }
        body.light-theme { color: var(--text); }
        body.light-theme .card { border-color: #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        body.light-theme .card-header { background: var(--card-header); }
        body.light-theme .card-header h2 { color: #1e293b; }
        body.light-theme input, body.light-theme select { background: #f8fafc; border-color: #cbd5e1; color: #1e293b; }
        body.light-theme .result-box { background: #f8fafc; border-color: #e2e8f0; }
        body.light-theme .status { color: #475569; }
        body.light-theme .val { color: #1e293b; }
        body.light-theme .formula-note { color: #64748b; }
        body.light-theme .field-hint { color: #94a3b8; }
        body.light-theme .input-help { background: #f8fafc; border-color: #e2e8f0; color: #475569; }
        body.light-theme .search-bar { background: #fff; border-color: #cbd5e1; }
        body.light-theme .search-bar input { color: #1e293b; }
        body.light-theme .filter-chip { border-color: #cbd5e1; color: #64748b; }
        body.light-theme .nav-bar { background: #fff; border-top-color: #e2e8f0; }
        body.light-theme .nav-btn { color: #64748b; }
        body.light-theme .nav-btn.active { color: var(--primary); }
        body.light-theme .example-box { background: #f8fafc; border-color: #e2e8f0; color: #475569; }
        body.light-theme .version { color: #94a3b8; }
        body.light-theme .grid > div > label { color: #475569; }
        .theme-btn {
            padding: 5px 8px; border-radius: 8px; border: 1px solid #475569;
            background: transparent; font-size: 1rem; cursor: pointer; line-height: 1;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        .search-wrap {
            position: sticky; top: 0; z-index: 100; background: var(--bg);
            padding: 0 0 10px; margin: 0 -2px;
        }
        .search-bar {
            display: flex; align-items: center; gap: 8px;
            background: var(--card); border: 1px solid #475569; border-radius: 10px;
            padding: 10px 14px; transition: border-color 0.2s;
        }
        .search-bar:focus-within { border-color: var(--primary); }
        .search-bar svg { width: 18px; height: 18px; color: #64748b; flex-shrink: 0; }
        .search-bar input {
            flex: 1; background: none; border: none; outline: none;
            color: var(--text); font-size: 0.95rem; font-family: inherit;
        }
        .search-bar input::placeholder { color: #64748b; }
        .search-clear {
            display: none; background: none; border: none; color: #94a3b8;
            font-size: 1.2rem; cursor: pointer; padding: 0 2px; line-height: 1;
        }
        .search-count {
            font-size: 0.7rem; color: #64748b; white-space: nowrap;
        }
        .card.search-hidden, .section-header.search-hidden { display: none !important; }
        .whatsnew-overlay {
            display: none; position: fixed; inset: 0; z-index: 999;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
            align-items: center; justify-content: center; padding: 20px;
        }
        .whatsnew-overlay.active { display: flex; }
        .whatsnew-box {
            background: #1e293b; border-radius: 14px; max-width: 420px; width: 100%;
            max-height: 80vh; overflow-y: auto; border: 1px solid #475569;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .whatsnew-header {
            padding: 18px 20px 12px; border-bottom: 1px solid #334155;
            display: flex; align-items: center; justify-content: space-between;
        }
        .whatsnew-header h3 { margin: 0; font-size: 1.1rem; color: #f8fafc; }
        .whatsnew-ver { font-size: 0.7rem; background: var(--primary); color: #fff; padding: 2px 8px; border-radius: 10px; font-weight: bold; }
        .whatsnew-body { padding: 16px 20px; }
        .whatsnew-item {
            padding: 10px 0; border-bottom: 1px solid #1e293b;
            cursor: pointer; transition: background 0.15s;
        }
        .whatsnew-item:hover { background: rgba(59,130,246,0.05); margin: 0 -20px; padding: 10px 20px; }
        .whatsnew-item:last-child { border: none; }
        .whatsnew-item .wn-badge {
            display: inline-block; font-size: 0.6rem; font-weight: bold; padding: 1px 6px;
            border-radius: 4px; margin-right: 6px; vertical-align: middle;
        }
        .whatsnew-item .wn-title { font-weight: bold; font-size: 0.88rem; color: #f8fafc; }
        .whatsnew-item .wn-desc { font-size: 0.78rem; color: #94a3b8; margin-top: 3px; line-height: 1.4; }
        .whatsnew-close {
            display: block; width: calc(100% - 40px); margin: 4px 20px 16px; padding: 12px;
            background: var(--primary); color: #fff; border: none; border-radius: 8px;
            font-size: 0.95rem; font-weight: bold; cursor: pointer;
        }
        .wn-header-badge {
            background: var(--accent); color: #0f172a; font-size: 0.55rem; font-weight: bold;
            padding: 1px 5px; border-radius: 6px; margin-left: 6px; cursor: pointer;
            vertical-align: super; animation: wn-pulse 2s ease-in-out 3;
        }
        @keyframes wn-pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
        .filter-bar {
            display: flex; gap: 6px; overflow-x: auto; padding: 2px 0 10px;
            -webkit-overflow-scrolling: touch; scrollbar-width: none;
        }
        .filter-bar::-webkit-scrollbar { display: none; }
        .filter-chip {
            flex-shrink: 0; padding: 5px 12px; border-radius: 20px;
            border: 1px solid #475569; background: transparent; color: #94a3b8;
            font-size: 0.72rem; font-weight: 600; cursor: pointer;
            transition: all 0.15s; white-space: nowrap;
        }
        .filter-chip:hover { border-color: #64748b; color: #cbd5e1; }
        .filter-chip.active { background: var(--primary); border-color: var(--primary); color: #fff; }
        .fav-btn {
            background: none; border: none; cursor: pointer; font-size: 1.1rem;
            padding: 0 4px; line-height: 1; opacity: 0.3; transition: opacity 0.15s, transform 0.15s;
        }
        .fav-btn:hover { opacity: 0.6; }
        .fav-btn.favorited { opacity: 1; transform: scale(1.1); }
        .fav-section {
            display: none; margin-bottom: 12px; padding: 10px 14px;
            background: rgba(251,191,36,0.08); border: 1px dashed rgba(251,191,36,0.3);
            border-radius: 10px;
        }
        .fav-section.has-favs { display: block; }
        .fav-section-title {
            font-size: 0.75rem; font-weight: bold; color: #fbbf24;
            margin-bottom: 8px; display: flex; align-items: center; gap: 6px;
        }
        .fav-links { display: flex; flex-wrap: wrap; gap: 6px; }
        .fav-link {
            padding: 4px 10px; border-radius: 6px; font-size: 0.72rem; font-weight: 600;
            background: rgba(251,191,36,0.12); color: #fcd34d; border: 1px solid rgba(251,191,36,0.2);
            cursor: pointer; transition: background 0.15s;
        }
        .fav-link:hover { background: rgba(251,191,36,0.25); }
        input.input-warn {
            border-color: var(--accent) !important;
            box-shadow: 0 0 0 2px rgba(245,158,11,0.2);
        }
        input.input-error {
            border-color: var(--danger) !important;
            box-shadow: 0 0 0 2px rgba(239,68,68,0.2);
        }
        .input-val-msg {
            font-size: 0.65rem; margin-top: 2px; line-height: 1.3;
        }
        .input-val-msg.warn { color: var(--accent); }
        .input-val-msg.error { color: var(--danger); }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            padding: 15px; 
            padding-top: env(safe-area-inset-top, 15px);
            padding-bottom: calc(80px + env(safe-area-inset-bottom, 15px));
            margin: 0; 
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: auto; }
        @media (min-width: 768px) {
            .container { padding: 0 20px; }
            .card-grid-wrap {
                display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
            }
            .card-grid-wrap > .section-header {
                grid-column: 1 / -1;
            }
            .card-grid-wrap > .fav-section {
                grid-column: 1 / -1;
            }
            .search-wrap { max-width: 100%; }
            header { max-width: 100%; }
        }
        @media (max-width: 767px) {
            .container { max-width: 600px; }
        }
        
        /* Header */
        header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px;
            position: sticky;
            top: 0;
            background: var(--bg);
            padding: 10px 0;
            z-index: 100;
        }
        h1 { font-size: 1.3rem; color: var(--primary); margin: 0; }
        .btn-clear { 
            background: var(--danger); 
            color: white; 
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
        }
        .btn-refresh {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
        }
        .btn-refresh:active { background: #1d4ed8; }
        .btn-toggle-all {
            padding: 7px 12px; border-radius: 8px; border: 1px solid #475569;
            background: transparent; color: #94a3b8; font-size: 0.75rem;
            font-weight: 600; cursor: pointer; white-space: nowrap;
        }
        .btn-toggle-all:active { background: #334155; }
        .exam-fab {
            position: fixed; bottom: calc(75px + env(safe-area-inset-bottom, 8px)); right: 14px;
            z-index: 90; background: #dc2626; color: #fff; border: none; border-radius: 50%;
            width: 48px; height: 48px; font-size: 0.65rem; font-weight: bold;
            cursor: pointer; box-shadow: 0 4px 12px rgba(220,38,38,0.4);
            display: flex; align-items: center; justify-content: center; line-height: 1.1; text-align: center;
        }
        .exam-fab:active { transform: scale(0.95); }
        .exam-overlay {
            display: none; position: fixed; inset: 0; z-index: 998;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(4px);
            align-items: center; justify-content: center; padding: 16px;
        }
        .exam-overlay.active { display: flex; }
        .exam-box {
            background: #1e293b; border-radius: 14px; max-width: 440px; width: 100%;
            max-height: 85vh; overflow-y: auto; border: 1px solid #dc2626;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .exam-hdr {
            padding: 16px 18px; border-bottom: 1px solid #334155;
            display: flex; align-items: center; justify-content: space-between;
        }
        .exam-hdr h3 { margin: 0; font-size: 1rem; color: #f8fafc; }
        .exam-score { font-size: 0.75rem; color: #4ade80; font-weight: bold; }
        .exam-body { padding: 18px; }
        .exam-q { font-size: 0.92rem; color: #f8fafc; line-height: 1.6; margin-bottom: 14px; }
        .exam-q b { color: #fbbf24; }
        .exam-input-row { display: flex; gap: 8px; margin-bottom: 12px; }
        .exam-input {
            flex: 1; padding: 10px 14px; border-radius: 8px; border: 1px solid #475569;
            background: #0f172a; color: #f8fafc; font-size: 1rem; font-family: inherit;
        }
        .exam-submit {
            padding: 10px 18px; border-radius: 8px; border: none;
            background: var(--primary); color: #fff; font-weight: bold; cursor: pointer; font-size: 0.9rem;
        }
        .exam-feedback {
            padding: 12px; border-radius: 8px; margin-bottom: 12px; font-size: 0.85rem; line-height: 1.5;
        }
        .exam-feedback.correct { background: rgba(74,222,128,0.1); border: 1px solid #4ade80; color: #4ade80; }
        .exam-feedback.wrong { background: rgba(239,68,68,0.1); border: 1px solid #ef4444; color: #f8fafc; }
        .exam-next {
            width: 100%; padding: 12px; border-radius: 8px; border: none;
            background: #dc2626; color: #fff; font-weight: bold; cursor: pointer; font-size: 0.9rem;
        }
        .exam-close {
            background: none; border: none; color: #94a3b8; font-size: 1.4rem; cursor: pointer;
        }
        .exam-cat { font-size: 0.65rem; color: #94a3b8; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
        .export-btn {
            padding: 7px 12px; border-radius: 8px; border: 1px solid #475569;
            background: transparent; color: #94a3b8; font-size: 0.75rem;
            font-weight: 600; cursor: pointer; white-space: nowrap;
        }
        .export-btn:active { background: #334155; }
        @media print {
            .search-wrap, .filter-bar, .nav-bar, .exam-fab, header, .fav-section,
            .btn-copy, button, .whatsnew-overlay, .exam-overlay, .export-btn,
            .btn-toggle-all, .btn-refresh, .btn-clear, .chevron { display: none !important; }
            body { background: #fff !important; color: #000 !important; padding: 10px !important; }
            .container { max-width: 100% !important; }
            .card { border: 1px solid #ccc !important; break-inside: avoid; margin: 8px 0 !important; }
            .card-body { max-height: none !important; overflow: visible !important; }
            .card.open .card-body { padding: 10px !important; }
            .card:not(.open) { display: none !important; }
            .card-header { background: #f0f0f0 !important; color: #000 !important; }
            .result-box { background: #f8f8f8 !important; color: #000 !important; border: 1px solid #ccc !important; }
            .status { color: #333 !important; }
            .val { color: #000 !important; }
            .card-grid-wrap { display: block !important; }
            .version { color: #666 !important; }
        }

        /* Accordion Cards */
        .card { 
            background: var(--card); 
            border-radius: 12px; 
            margin-bottom: 10px; 
            border-left: 4px solid var(--primary); 
            overflow: hidden;
        }
        .card.accent { border-left-color: var(--accent); }
        .card.success { border-left-color: var(--success); }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 18px;
            background: var(--card-header);
            cursor: pointer;
            user-select: none;
        }
        .card-header:active { background: #3d4a5c; }
        .card-header h2 { 
            font-size: 1rem; 
            margin: 0; 
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card-num {
            background: var(--primary);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            flex-shrink: 0;
        }
        .card.accent .card-num { background: var(--accent); }
        .card.success .card-num { background: var(--success); }
        
        .chevron {
            width: 20px;
            height: 20px;
            transition: transform 0.3s ease;
            color: #94a3b8;
            flex-shrink: 0;
        }
        .card.open .chevron { transform: rotate(180deg); }
        
        .card-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .card.open .card-body { max-height: 1000px; }
        .card-content { padding: 18px; padding-top: 10px; }

        /* Form Elements */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        label { font-size: 0.8rem; color: #94a3b8; display: block; margin-bottom: 4px; }
        input { 
            width: 100%; 
            padding: 12px; 
            border-radius: 6px; 
            border: 2px solid #334155; 
            background: #0f172a; 
            color: white; 
            box-sizing: border-box; 
            font-size: 16px;
            transition: border-color 0.2s;
        }
        input:focus { outline: none; border-color: var(--primary); }
        input.error { border-color: var(--danger); animation: shake 0.3s; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .field-hint { font-size: 0.7rem; color: #64748b; display: block; margin-top: 3px; }
        .field-hint.error { color: var(--danger); font-weight: bold; }
        
        .input-help { 
            font-size: 0.8rem; 
            color: #94a3b8; 
            margin-bottom: 12px; 
            padding: 8px; 
            background: rgba(59, 130, 246, 0.1); 
            border-radius: 6px; 
            border-left: 3px solid var(--primary); 
        }
        .example-box { 
            font-size: 0.75rem; 
            color: #94a3b8; 
            margin: 10px 0; 
            padding: 8px; 
            background: rgba(245, 158, 11, 0.1); 
            border-radius: 6px; 
            border-left: 3px solid var(--accent); 
        }

        /* Results */
        .result-box { 
            background: #334155; 
            padding: 15px; 
            border-radius: 8px; 
            text-align: center; 
        }
        .val { display: block; font-size: 1.5rem; font-weight: bold; color: var(--accent); }
        .status { 
            font-size: 0.85rem; 
            margin-top: 8px; 
            color: #cbd5e1; 
            line-height: 1.4; 
            text-align: left; 
            padding: 0 5px; 
        }
        .btn-copy { 
            background: var(--primary); 
            color: white; 
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-top: 10px;
            cursor: pointer;
        }
        .btn-copy:active { background: #2563eb; }
        .formula-note { 
            font-size: 0.7rem; 
            color: #64748b; 
            margin-top: 10px; 
            text-align: center; 
            font-style: italic; 
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card);
            border-top: 1px solid #334155;
            padding: 6px 0;
            padding-bottom: calc(6px + env(safe-area-inset-bottom, 0px));
            z-index: 1000;
        }
        .nav-scroll {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            padding: 0 5px;
            gap: 2px;
        }
        .nav-scroll::-webkit-scrollbar { display: none; }
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            background: none;
            border: none;
            color: #64748b;
            font-size: 0.55rem;
            padding: 4px 6px;
            border-radius: 8px;
            cursor: pointer;
            min-width: 42px;
            flex-shrink: 0;
            scroll-snap-align: start;
        }
        .nav-btn:active, .nav-btn.active { 
            color: var(--primary); 
            background: rgba(59, 130, 246, 0.1);
        }
        .nav-icon {
            width: 18px;
            height: 18px;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #334155;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 0.9rem;
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }

        /* Install Prompt */
        .install-prompt {
            display: none;
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            font-size: 0.85rem;
            align-items: center;
            gap: 10px;
        }
        .install-prompt button { 
            background: white; 
            color: var(--primary); 
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-weight: bold;
            cursor: pointer;
        }

        .version { 
            font-size: 0.7rem; 
            color: #475569; 
            text-align: center; 
            padding: 15px 0; 
        }

        /* ========== ADVANCED DATA ANALYTICS & TRENDING ========== */
        .trending-dashboard {
            background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(99,102,241,0.05));
            border: 1px solid rgba(139,92,246,0.3);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 15px;
        }
        .trending-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .trending-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #a78bfa;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .trending-tabs {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .trend-tab {
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid #6366f1;
            background: transparent;
            color: #a5b4fc;
            font-size: 0.72rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .trend-tab:hover { background: rgba(99,102,241,0.2); }
        .trend-tab.active { background: #6366f1; color: #fff; }
        .trend-panel { display: none; }
        .trend-panel.active { display: block; }
        .trend-chart-wrap {
            background: #1e293b;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
            min-height: 220px;
            position: relative;
        }
        .trend-chart-title {
            font-size: 0.8rem;
            font-weight: bold;
            color: #e2e8f0;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .trend-chart-title .chart-badge {
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }
        .trend-chart-title .badge-good { background: #10b981; color: #fff; }
        .trend-chart-title .badge-warn { background: #f59e0b; color: #0f172a; }
        .trend-chart-title .badge-alert { background: #ef4444; color: #fff; }
        .trend-stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
            margin-bottom: 12px;
        }
        .trend-stat-box {
            background: #0f172a;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            border: 1px solid #334155;
        }
        .trend-stat-label {
            font-size: 0.6rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .trend-stat-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #f8fafc;
            margin-top: 2px;
        }
        .trend-stat-delta {
            font-size: 0.65rem;
            margin-top: 2px;
        }
        .trend-stat-delta.up { color: #ef4444; }
        .trend-stat-delta.down { color: #10b981; }
        .trend-stat-delta.stable { color: #94a3b8; }
        .trend-data-entry {
            background: #0f172a;
            border-radius: 10px;
            padding: 14px;
            margin-top: 12px;
        }
        .trend-entry-title {
            font-size: 0.8rem;
            font-weight: bold;
            color: #c4b5fd;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .trend-entry-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }
        .trend-entry-field label {
            font-size: 0.7rem;
            color: #94a3b8;
            display: block;
            margin-bottom: 3px;
        }
        .trend-entry-field input, .trend-entry-field select {
            width: 100%;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid #475569;
            background: #1e293b;
            color: #f8fafc;
            font-size: 0.85rem;
        }
        .trend-entry-field input:focus, .trend-entry-field select:focus {
            border-color: #8b5cf6;
            outline: none;
        }
        .trend-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .trend-btn-primary {
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            color: #fff;
        }
        .trend-btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(139,92,246,0.4); }
        .trend-btn-secondary {
            background: #334155;
            color: #e2e8f0;
        }
        .trend-btn-danger {
            background: #ef4444;
            color: #fff;
        }
        .trend-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }
        .trend-alert-box {
            background: rgba(239,68,68,0.1);
            border: 1px solid rgba(239,68,68,0.3);
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        .trend-alert-box.warn {
            background: rgba(245,158,11,0.1);
            border-color: rgba(245,158,11,0.3);
        }
        .trend-alert-box.info {
            background: rgba(59,130,246,0.1);
            border-color: rgba(59,130,246,0.3);
        }
        .trend-alert-icon { font-size: 1rem; }
        .trend-alert-content { flex: 1; }
        .trend-alert-title { font-size: 0.8rem; font-weight: bold; color: #f8fafc; }
        .trend-alert-desc { font-size: 0.72rem; color: #94a3b8; margin-top: 2px; }
        .trend-history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
            margin-top: 10px;
        }
        .trend-history-table th {
            background: #334155;
            color: #e2e8f0;
            padding: 8px 6px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        .trend-history-table td {
            padding: 6px;
            border-bottom: 1px solid #334155;
            color: #cbd5e1;
        }
        .trend-history-table tr:hover td {
            background: rgba(99,102,241,0.1);
        }
        .trend-history-wrap {
            max-height: 200px;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid #334155;
        }
        .trend-range-selector {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        .trend-range-btn {
            padding: 4px 10px;
            border-radius: 4px;
            border: 1px solid #475569;
            background: transparent;
            color: #94a3b8;
            font-size: 0.68rem;
            cursor: pointer;
        }
        .trend-range-btn.active, .trend-range-btn:hover {
            background: #6366f1;
            border-color: #6366f1;
            color: #fff;
        }
        .trend-no-data {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }
        .trend-no-data-icon { font-size: 2.5rem; opacity: 0.5; margin-bottom: 10px; }
        .trend-no-data-text { font-size: 0.85rem; }
        .trend-thresholds {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #334155;
        }
        .trend-threshold-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.68rem;
            color: #94a3b8;
        }
        .trend-threshold-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .control-limit-line { stroke-dasharray: 5, 5; }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>WW Pro-Calc <span class="wn-header-badge" id="wnBadge" onclick="openWhatsNew()" style="display:none">NEW</span></h1>
        <div style="display: flex; gap: 8px;">
            <button class="theme-btn" id="themeBtn" onclick="toggleTheme()" title="Toggle light/dark theme">üåô</button>
            <button class="export-btn" onclick="exportResults()" title="Print / Export PDF">üñ®Ô∏è</button>
            <button class="btn-toggle-all" id="btnToggleAll" onclick="toggleAll()">Expand All</button>
            <button class="btn-refresh" onclick="refreshApp()" title="Check for updates">‚Üª</button>
            <button class="btn-clear" onclick="clearAll()">Clear All</button>
        </div>
    </header>

    <!-- What's New Modal -->
    <div class="whatsnew-overlay" id="wnOverlay" onclick="if(event.target===this)closeWhatsNew()">
        <div class="whatsnew-box">
            <div class="whatsnew-header">
                <h3>üöÄ What's New</h3>
                <span class="whatsnew-ver">v9.2</span>
            </div>
            <div class="whatsnew-body">
                <div class="whatsnew-item" onclick="closeWhatsNew();filterCat('trending',document.querySelector('[data-filter=trending]'))">
                    <div><span class="wn-badge" style="background:linear-gradient(135deg,#8b5cf6,#6366f1);color:#fff">üî• NEW</span><span class="wn-title">üìà Advanced Data Analytics & Trending</span></div>
                    <div class="wn-desc">Log daily process data, track SVI/F:M/MBR trends with Chart.js, proactive fouling alerts, seasonal pattern detection, CSV import/export. Click "üìà Trending" filter chip.</div>
                </div>
                <div class="whatsnew-item" onclick="closeWhatsNew();goToCard(62)">
                    <div><span class="wn-badge" style="background:#4ade80;color:#0f172a">NEW</span><span class="wn-title">Parshall Flume (#62)</span></div>
                    <div class="wn-desc">11 throat widths, free-flow + submergence detection. Standard TCEQ exam topic.</div>
                </div>
                <div class="whatsnew-item" onclick="closeWhatsNew();goToCard(63)">
                    <div><span class="wn-badge" style="background:#4ade80;color:#0f172a">NEW</span><span class="wn-title">Tank Volume (#63)</span></div>
                    <div class="wn-desc">Circular, rectangular, and cone-bottom. Output in gallons, ft¬≥, MG, and m¬≥.</div>
                </div>
                <div class="whatsnew-item" onclick="closeWhatsNew();goToCard(64)">
                    <div><span class="wn-badge" style="background:#4ade80;color:#0f172a">NEW</span><span class="wn-title">Pond Detention Time (#64)</span></div>
                    <div class="wn-desc">Sludge accumulation impact on HRT, cross-section visual, short-circuiting by cell count.</div>
                </div>
                <div class="whatsnew-item" onclick="closeWhatsNew();goToCard(65)">
                    <div><span class="wn-badge" style="background:#4ade80;color:#0f172a">NEW</span><span class="wn-title">Blower Air Requirement (#65)</span></div>
                    <div class="wn-desc">SCFM from O‚ÇÇ demand + OTE. BHP estimate and annual energy cost projection.</div>
                </div>
                <div class="whatsnew-item" onclick="closeWhatsNew();goToCard(66)">
                    <div><span class="wn-badge" style="background:#4ade80;color:#0f172a">NEW</span><span class="wn-title">Plant Available Nitrogen (#66)</span></div>
                    <div class="wn-desc">PAN from NH‚ÇÉ/NO‚ÇÉ/Org-N fractions with volatilization and mineralization.</div>
                </div>
                <div class="whatsnew-item" onclick="closeWhatsNew();goToCard(67)">
                    <div><span class="wn-badge" style="background:#4ade80;color:#0f172a">NEW</span><span class="wn-title">Land Application Rate (#67)</span></div>
                    <div class="wn-desc">Agronomic rate, site capacity, hauling estimates. 40 CFR 503 compliant.</div>
                </div>
                <div class="whatsnew-item" onclick="closeWhatsNew();goToCard(61)">
                    <div><span class="wn-badge" style="background:#d946ef;color:#fff">UPG</span><span class="wn-title">Population Equivalent Enhanced (#61)</span></div>
                    <div class="wn-desc">TKN-based PE, peaking factors, EDU conversion, industrial load split, growth timeline, TCEQ report export.</div>
                </div>
                <div class="whatsnew-item">
                    <div><span class="wn-badge" style="background:#3b82f6;color:#fff">UX</span><span class="wn-title">Search Bar</span></div>
                    <div class="wn-desc">Find any of 67 calculators instantly by keyword. Sticky at top of page.</div>
                </div>
                <div class="whatsnew-item">
                    <div><span class="wn-badge" style="background:#818cf8;color:#fff">GUIDE</span><span class="wn-title">13 How to Use Guides</span></div>
                    <div class="wn-desc">Collapsible operator guides with TCEQ exam tips on SBR, Manning's, NRC, SOTR‚ÜíAOTR, CT, TDH, Flume, Tank Vol, Pond HRT, Blower, PAN, Land App, and PE.</div>
                </div>
                <div class="whatsnew-item">
                    <div><span class="wn-badge" style="background:#818cf8;color:#fff">GUIDE</span><span class="wn-title">52 Total Operator Guides</span></div>
                    <div class="wn-desc">How to Use guides now on 52 of 67 calculators ‚Äî F:M, SRT, SVI, Chemical Dosing, MBR, MBBR, Sludge, Nutrients, Hydraulics, and more.</div>
                </div>
                <div class="whatsnew-item">
                    <div><span class="wn-badge" style="background:#22c55e;color:#fff">NEW</span><span class="wn-title">Dark/Light Theme</span></div>
                    <div class="wn-desc">Toggle between dark and light modes with the üåô button. Preference saved automatically.</div>
                </div>
                <div class="whatsnew-item">
                    <div><span class="wn-badge" style="background:#22c55e;color:#fff">NEW</span><span class="wn-title">Print / PDF Export</span></div>
                    <div class="wn-desc">üñ®Ô∏è button generates a printable report of all calculated results. Print to PDF from any browser.</div>
                </div>
                <div class="whatsnew-item">
                    <div><span class="wn-badge" style="background:#22c55e;color:#fff">NEW</span><span class="wn-title">QR Code Sharing</span></div>
                    <div class="wn-desc">Share the app with coworkers via QR code ‚Äî scan with any phone camera.</div>
                </div>
            </div>
            <button class="whatsnew-close" onclick="closeWhatsNew()">Got it ‚Äî Let's Calculate üí™</button>
        </div>
    </div>

    <!-- Search Bar -->
    <div class="search-wrap" id="searchWrap">
        <div class="search-bar">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
            <input type="text" id="searchInput" placeholder="Search 67 calculators..." oninput="searchCalcs()" autocomplete="off" autocorrect="off" spellcheck="false">
            <span class="search-count" id="searchCount"></span>
            <button class="search-clear" id="searchClear" onclick="clearSearch()">‚úï</button>
        </div>
        <div class="filter-bar" id="filterBar">
            <button class="filter-chip active" data-filter="all" onclick="filterCat('all',this)">All (67)</button>
            <button class="filter-chip" data-filter="cas" onclick="filterCat('cas',this)">CAS Core</button>
            <button class="filter-chip" data-filter="mbr" onclick="filterCat('mbr',this)">MBR</button>
            <button class="filter-chip" data-filter="mbbr" onclick="filterCat('mbbr',this)">MBBR</button>
            <button class="filter-chip" data-filter="sbr" onclick="filterCat('sbr',this)">SBR</button>
            <button class="filter-chip" data-filter="disinf" onclick="filterCat('disinf',this)">Disinfection</button>
            <button class="filter-chip" data-filter="sludge" onclick="filterCat('sludge',this)">Sludge</button>
            <button class="filter-chip" data-filter="nutrients" onclick="filterCat('nutrients',this)">Nutrients</button>
            <button class="filter-chip" data-filter="hydraulics" onclick="filterCat('hydraulics',this)">Hydraulics</button>
            <button class="filter-chip" data-filter="compliance" onclick="filterCat('compliance',this)">Compliance</button>
            <button class="filter-chip" data-filter="collection" onclick="filterCat('collection',this)">Collection</button>
            <button class="filter-chip" data-filter="flow" onclick="filterCat('flow',this)">Flow Meas.</button>
            <button class="filter-chip" data-filter="tf" onclick="filterCat('tf',this)">Trickling Filter</button>
            <button class="filter-chip" data-filter="lagoon" onclick="filterCat('lagoon',this)">Lagoon</button>
            <button class="filter-chip" data-filter="aeration" onclick="filterCat('aeration',this)">Aeration</button>
            <button class="filter-chip" data-filter="receiving" onclick="filterCat('receiving',this)">Receiving</button>
            <button class="filter-chip" data-filter="population" onclick="filterCat('population',this)">Population</button>
            <button class="filter-chip" data-filter="tank" onclick="filterCat('tank',this)">Tank</button>
            <button class="filter-chip" data-filter="landapp" onclick="filterCat('landapp',this)">Land App</button>
            <button class="filter-chip" data-filter="convert" onclick="filterCat('convert',this)">Conversions</button>
            <button class="filter-chip" data-filter="trending" onclick="filterCat('trending',this)" style="background:linear-gradient(135deg,#8b5cf6,#6366f1);border-color:#8b5cf6;color:#fff;">üìà Trending</button>
        </div>
    </div>

    <!-- Favorites Section -->
    <div class="card-grid-wrap">
    <div class="fav-section" id="favSection">
        <div class="fav-section-title">‚≠ê My Favorites <span style="font-weight:normal;color:#94a3b8;font-size:0.65rem">(tap star in any card header)</span></div>
        <div class="fav-links" id="favLinks"></div>
    </div>

    <!-- ========== ADVANCED DATA ANALYTICS & TRENDING DASHBOARD ========== -->
    <div class="trending-dashboard" id="trendingDashboard" data-cat="trending" style="display:none;">
        <div class="trending-header">
            <div class="trending-title">
                üìà Advanced Data Analytics & Trending
                <span style="font-size:0.65rem;background:#8b5cf6;color:#fff;padding:2px 8px;border-radius:10px;">BETA</span>
            </div>
            <div class="trend-range-selector">
                <button class="trend-range-btn active" onclick="setTrendRange(7, this)">7D</button>
                <button class="trend-range-btn" onclick="setTrendRange(14, this)">14D</button>
                <button class="trend-range-btn" onclick="setTrendRange(30, this)">30D</button>
                <button class="trend-range-btn" onclick="setTrendRange(90, this)">90D</button>
            </div>
        </div>

        <!-- Alert Banner Area -->
        <div id="trendAlerts"></div>

        <!-- Navigation Tabs -->
        <div class="trending-tabs">
            <button class="trend-tab active" onclick="showTrendPanel('overview', this)">üìä Overview</button>
            <button class="trend-tab" onclick="showTrendPanel('svi', this)">üß´ SVI</button>
            <button class="trend-tab" onclick="showTrendPanel('fm', this)">‚öñÔ∏è F/M</button>
            <button class="trend-tab" onclick="showTrendPanel('mbr', this)">üî¨ MBR</button>
            <button class="trend-tab" onclick="showTrendPanel('effluent', this)">üíß Effluent</button>
            <button class="trend-tab" onclick="showTrendPanel('entry', this)">‚úèÔ∏è Log Data</button>
            <button class="trend-tab" onclick="showTrendPanel('history', this)">üìã History</button>
        </div>

        <!-- OVERVIEW PANEL -->
        <div class="trend-panel active" id="panel-overview">
            <div class="trend-stats-row">
                <div class="trend-stat-box">
                    <div class="trend-stat-label">Data Points</div>
                    <div class="trend-stat-value" id="stat-datapoints">0</div>
                </div>
                <div class="trend-stat-box">
                    <div class="trend-stat-label">Latest SVI</div>
                    <div class="trend-stat-value" id="stat-svi">‚Äî</div>
                    <div class="trend-stat-delta stable" id="stat-svi-delta"></div>
                </div>
                <div class="trend-stat-box">
                    <div class="trend-stat-label">Latest F/M</div>
                    <div class="trend-stat-value" id="stat-fm">‚Äî</div>
                    <div class="trend-stat-delta stable" id="stat-fm-delta"></div>
                </div>
                <div class="trend-stat-box">
                    <div class="trend-stat-label">Avg MLSS</div>
                    <div class="trend-stat-value" id="stat-mlss">‚Äî</div>
                </div>
                <div class="trend-stat-box">
                    <div class="trend-stat-label">Process Score</div>
                    <div class="trend-stat-value" id="stat-score" style="color:#4ade80">‚Äî</div>
                </div>
            </div>
            <div class="trend-chart-wrap">
                <div class="trend-chart-title">
                    Multi-Parameter Trend Overview
                    <span class="chart-badge badge-good" id="overview-badge">STABLE</span>
                </div>
                <canvas id="chartOverview" height="200"></canvas>
                <div class="trend-thresholds">
                    <div class="trend-threshold-item"><div class="trend-threshold-dot" style="background:#8b5cf6"></div>SVI (mL/g)</div>
                    <div class="trend-threshold-item"><div class="trend-threshold-dot" style="background:#10b981"></div>F/M √ó 1000</div>
                    <div class="trend-threshold-item"><div class="trend-threshold-dot" style="background:#3b82f6"></div>MLSS √∑ 100</div>
                    <div class="trend-threshold-item"><div class="trend-threshold-dot" style="background:#f59e0b"></div>DO √ó 10</div>
                </div>
            </div>
        </div>

        <!-- SVI PANEL -->
        <div class="trend-panel" id="panel-svi">
            <div class="trend-stats-row">
                <div class="trend-stat-box">
                    <div class="trend-stat-label">Current SVI</div>
                    <div class="trend-stat-value" id="svi-current">‚Äî</div>
                </div>
                <div class="trend-stat-box">
                    <div class="trend-stat-label">7-Day Avg</div>
                    <div class="trend-stat-value" id="svi-avg7">‚Äî</div>
                </div>
                <div class="trend-stat-box">
                    <div class="trend-stat-label">Trend</div>
                    <div class="trend-stat-value" id="svi-trend">‚Äî</div>
                </div>
                <div class="trend-stat-box">
                    <div class="trend-stat-label">Days >150</div>
                    <div class="trend-stat-value" id="svi-highdays">0</div>
                </div>
            </div>
            <div class="trend-chart-wrap">
                <div class="trend-chart-title">
                    SVI Trend with Control Limits
                    <span class="chart-badge badge-good" id="svi-badge">NORMAL</span>
                </div>
                <canvas id="chartSVI" height="200"></canvas>
                <div class="trend-thresholds">
                    <div class="trend-threshold-item"><div class="trend-threshold-dot" style="background:#8b5cf6"></div>SVI</div>
                    <div class="trend-threshold-item"><div class="trend-threshold-dot" style="background:#f59e0b;opacity:0.5"></div>Warning (150)</div>
                    <div class="trend-threshold-item"><div class="trend-threshold-dot" style="background:#ef4444;opacity:0.5"></div>Bulking (200)</div>
                    <div class="trend-threshold-item"><div class="trend-threshold-dot" style="background:#3b82f6;opacity:0.5"></div>Pin Floc (80)</div>
                </div>
            </div>
            <div class="input-help" style="margin-top:10px;border-left-color:#8b5cf6;">
                <b>SVI Interpretation:</b> 80‚Äì150 mL/g = good settling | >150 = bulking risk | >200 = severe bulking | <80 = pin floc/old sludge. Track 7-day trends to catch developing problems early.
            </div>
        </div>

        <!-- F/M PANEL -->
        <div class="trend-panel" id="panel-fm">
            <div class="trend-stats-row">
                <div class="trend-stat-box">
                    <div class="trend-stat-label">Current F/M</div>
                    <div class="trend-stat-value" id="fm-current">‚Äî</div>
                </div>
                <div class="trend-stat-box">
                    <div class="trend-stat-label">Target Range</div>
                    <div class="trend-stat-value" id="fm-target" style="font-size:0.9rem">0.2‚Äì0.5</div>
                </div>
                <div class="trend-stat-box">
                    <div class="trend-stat-label">Std Dev</div>
                    <div class="trend-stat-value" id="fm-stddev">‚Äî</div>
                </div>
                <div class="trend-stat-box">
                    <div class="trend-stat-label">In Range %</div>
                    <div class="trend-stat-value" id="fm-inrange">‚Äî</div>
                </div>
            </div>
            <div class="trend-chart-wrap">
                <div class="trend-chart-title">
                    F/M Ratio with Optimal Band
                    <span class="chart-badge badge-good" id="fm-badge">IN RANGE</span>
                </div>
                <canvas id="chartFM" height="200"></canvas>
                <div class="trend-thresholds">
                    <div class="trend-threshold-item"><div class="trend-threshold-dot" style="background:#10b981"></div>F/M Ratio</div>
                    <div class="trend-threshold-item"><div class="trend-threshold-dot" style="background:rgba(16,185,129,0.2)"></div>Optimal (0.2‚Äì0.5)</div>
                    <div class="trend-threshold-item"><div class="trend-threshold-dot" style="background:#6366f1"></div>Moving Avg</div>
                </div>
            </div>
        </div>

        <!-- MBR PANEL -->
        <div class="trend-panel" id="panel-mbr">
            <div class="trend-stats-row">
                <div class="trend-stat-box">
                    <div class="trend-stat-label">Flux</div>
                    <div class="trend-stat-value" id="mbr-flux">‚Äî</div>
                </div>
                <div class="trend-stat-box">
                    <div class="trend-stat-label">TMP</div>
                    <div class="trend-stat-value" id="mbr-tmp">‚Äî</div>
                </div>
                <div class="trend-stat-box">
                    <div class="trend-stat-label">Permeability</div>
                    <div class="trend-stat-value" id="mbr-perm">‚Äî</div>
                </div>
                <div class="trend-stat-box">
                    <div class="trend-stat-label">Fouling Rate</div>
                    <div class="trend-stat-value" id="mbr-fouling">‚Äî</div>
                </div>
            </div>
            <div class="trend-chart-wrap">
                <div class="trend-chart-title">
                    Membrane Performance (Flux & TMP)
                    <span class="chart-badge badge-good" id="mbr-badge">CLEAN</span>
                </div>
                <canvas id="chartMBR" height="200"></canvas>
                <div class="trend-thresholds">
                    <div class="trend-threshold-item"><div class="trend-threshold-dot" style="background:#3b82f6"></div>Flux (GFD)</div>
                    <div class="trend-threshold-item"><div class="trend-threshold-dot" style="background:#ef4444"></div>TMP (psi)</div>
                    <div class="trend-threshold-item"><div class="trend-threshold-dot" style="background:#10b981"></div>Permeability</div>
                </div>
            </div>
            <div class="input-help" style="margin-top:10px;border-left-color:#3b82f6;">
                <b>Fouling Detection:</b> Rising TMP at constant flux = fouling. Permeability decline >20% from baseline = schedule CIP. Sudden TMP spike = possible membrane damage.
            </div>
        </div>

        <!-- EFFLUENT PANEL -->
        <div class="trend-panel" id="panel-effluent">
            <div class="trend-stats-row">
                <div class="trend-stat-box">
                    <div class="trend-stat-label">BOD Eff</div>
                    <div class="trend-stat-value" id="eff-bod">‚Äî</div>
                </div>
                <div class="trend-stat-box">
                    <div class="trend-stat-label">TSS Eff</div>
                    <div class="trend-stat-value" id="eff-tss">‚Äî</div>
                </div>
                <div class="trend-stat-box">
                    <div class="trend-stat-label">NH‚ÇÉ-N</div>
                    <div class="trend-stat-value" id="eff-nh3">‚Äî</div>
                </div>
                <div class="trend-stat-box">
                    <div class="trend-stat-label">Removal %</div>
                    <div class="trend-stat-value" id="eff-removal" style="color:#4ade80">‚Äî</div>
                </div>
            </div>
            <div class="trend-chart-wrap">
                <div class="trend-chart-title">
                    Effluent Quality Trending
                    <span class="chart-badge badge-good" id="eff-badge">COMPLIANT</span>
                </div>
                <canvas id="chartEffluent" height="200"></canvas>
                <div class="trend-thresholds">
                    <div class="trend-threshold-item"><div class="trend-threshold-dot" style="background:#f59e0b"></div>BOD (mg/L)</div>
                    <div class="trend-threshold-item"><div class="trend-threshold-dot" style="background:#8b5cf6"></div>TSS (mg/L)</div>
                    <div class="trend-threshold-item"><div class="trend-threshold-dot" style="background:#10b981"></div>NH‚ÇÉ-N (mg/L)</div>
                </div>
            </div>
        </div>

        <!-- DATA ENTRY PANEL -->
        <div class="trend-panel" id="panel-entry">
            <div class="trend-data-entry">
                <div class="trend-entry-title">‚úèÔ∏è Log Daily Process Data</div>
                <div class="trend-entry-grid">
                    <div class="trend-entry-field">
                        <label>Date</label>
                        <input type="date" id="log_date">
                    </div>
                    <div class="trend-entry-field">
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="log_flow" placeholder="1.5">
                    </div>
                    <div class="trend-entry-field">
                        <label>Inf BOD (mg/L)</label>
                        <input type="number" inputmode="decimal" id="log_inf_bod" placeholder="200">
                    </div>
                    <div class="trend-entry-field">
                        <label>Eff BOD (mg/L)</label>
                        <input type="number" inputmode="decimal" id="log_eff_bod" placeholder="10">
                    </div>
                    <div class="trend-entry-field">
                        <label>Eff TSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="log_eff_tss" placeholder="10">
                    </div>
                    <div class="trend-entry-field">
                        <label>Eff NH‚ÇÉ (mg/L)</label>
                        <input type="number" inputmode="decimal" id="log_eff_nh3" placeholder="1.0">
                    </div>
                    <div class="trend-entry-field">
                        <label>MLSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="log_mlss" placeholder="3000">
                    </div>
                    <div class="trend-entry-field">
                        <label>30-min Settle (mL)</label>
                        <input type="number" inputmode="decimal" id="log_settle" placeholder="300">
                    </div>
                    <div class="trend-entry-field">
                        <label>DO (mg/L)</label>
                        <input type="number" inputmode="decimal" id="log_do" placeholder="2.0">
                    </div>
                    <div class="trend-entry-field">
                        <label>Aer Vol (MG)</label>
                        <input type="number" inputmode="decimal" id="log_aer_vol" placeholder="0.5">
                    </div>
                    <div class="trend-entry-field">
                        <label>Flux (GFD)</label>
                        <input type="number" inputmode="decimal" id="log_flux" placeholder="12">
                    </div>
                    <div class="trend-entry-field">
                        <label>TMP (psi)</label>
                        <input type="number" inputmode="decimal" id="log_tmp" placeholder="5">
                    </div>
                </div>
                <div class="trend-actions">
                    <button class="trend-btn trend-btn-primary" onclick="logTrendData()">üíæ Save Entry</button>
                    <button class="trend-btn trend-btn-secondary" onclick="autoFillFromCalcs()">üîÑ Auto-Fill from Calcs</button>
                    <button class="trend-btn trend-btn-secondary" onclick="importCSV()">üì• Import CSV</button>
                    <button class="trend-btn trend-btn-secondary" onclick="exportTrendData()">üì§ Export Data</button>
                </div>
            </div>
            <div class="input-help" style="margin-top:12px;border-left-color:#a78bfa;">
                <b>Tip:</b> Log data daily for best trend analysis. Use "Auto-Fill from Calcs" to pull current values from your calculator inputs. SVI is auto-calculated from Settle/MLSS.
            </div>
        </div>

        <!-- HISTORY PANEL -->
        <div class="trend-panel" id="panel-history">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <div class="trend-entry-title" style="margin:0;">üìã Data History</div>
                <button class="trend-btn trend-btn-danger" onclick="clearTrendData()" style="padding:6px 12px;font-size:0.7rem;">üóëÔ∏è Clear All</button>
            </div>
            <div class="trend-history-wrap" id="historyTableWrap">
                <table class="trend-history-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Flow</th>
                            <th>MLSS</th>
                            <th>SVI</th>
                            <th>F/M</th>
                            <th>BOD</th>
                            <th>TSS</th>
                            <th>‚öôÔ∏è</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                        <tr><td colspan="8" style="text-align:center;color:#64748b;padding:20px;">No data logged yet</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 1. Pounds Formula -->
    <div class="card open" id="card1" data-calc="pounds">
        <div class="card-header" onclick="toggleCard(1)">
            <h2><span class="card-num">1</span> Pounds Formula</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Convert concentration to mass loading. Use for BOD, TSS, ammonia, phosphorus.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="p_flow" oninput="calcPounds()" placeholder="1.5">
                        <span class="field-hint">Million gallons per day</span>
                    </div>
                    <div>
                        <label>Concentration (mg/L)</label>
                        <input type="number" inputmode="decimal" id="p_conc" oninput="calcPounds()" placeholder="200">
                        <span class="field-hint">Lab result</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="p_res">0.00 lbs/day</span>
                    <div id="p_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('p_res')">Copy Result</button>
                </div>
                <div class="formula-note">Flow √ó Conc √ó 8.34</div>
            </div>
        </div>
    </div>

    <!-- 2. SVI -->
    <div class="card" id="card2" data-calc="svi">
        <div class="card-header" onclick="toggleCard(2)">
            <h2><span class="card-num">2</span> SVI ‚Äì Sludge Volume Index</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Measures sludge settleability. Perform 30-min settleometer test.</div>
                <div class="grid">
                    <div>
                        <label>30-min Settled (mL/L)</label>
                        <input type="number" inputmode="decimal" id="svi_set" oninput="calcSVI()" placeholder="250">
                        <span class="field-hint" id="svi_set_hint">Max 1000 mL/L</span>
                    </div>
                    <div>
                        <label>MLSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="svi_mlss" oninput="calcSVI()" placeholder="2500">
                        <span class="field-hint">From lab</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="svi_res">0.00 mL/g</span>
                    <div id="svi_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('svi_res')">Copy Result</button>
                </div>
                <div class="formula-note">(Settled Vol √ó 1000) √∑ MLSS</div>
            </div>
        </div>
    </div>

    <!-- 3. Mass Balance -->
    <div class="card accent" id="card3" data-calc="mass">
        <div class="card-header" onclick="toggleCard(3)">
            <h2><span class="card-num">3</span> Mass Balance</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Calculate mixed concentration when two flows combine (RAS + Influent, blending).</div>
                <div class="grid">
                    <div>
                        <label>Stream A ‚Äì Flow</label>
                        <input type="number" inputmode="decimal" id="mb_qa" oninput="calcMB()" placeholder="1.0">
                        <span class="field-hint">Any flow unit</span>
                    </div>
                    <div>
                        <label>Stream A ‚Äì Conc</label>
                        <input type="number" inputmode="decimal" id="mb_ca" oninput="calcMB()" placeholder="200">
                        <span class="field-hint">mg/L</span>
                    </div>
                    <div>
                        <label>Stream B ‚Äì Flow</label>
                        <input type="number" inputmode="decimal" id="mb_qb" oninput="calcMB()" placeholder="0.5">
                        <span class="field-hint">Same unit as A</span>
                    </div>
                    <div>
                        <label>Stream B ‚Äì Conc</label>
                        <input type="number" inputmode="decimal" id="mb_cb" oninput="calcMB()" placeholder="8000">
                        <span class="field-hint">mg/L</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="mb_res">0.00 mg/L</span>
                    <div id="mb_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('mb_res')">Copy Result</button>
                </div>
                <div class="formula-note">(Q‚ÇÅ√óC‚ÇÅ + Q‚ÇÇ√óC‚ÇÇ) √∑ (Q‚ÇÅ + Q‚ÇÇ)</div>
            </div>
        </div>
    </div>

    <!-- 4. F/M Ratio -->
    <div class="card success" id="card4" data-calc="fm">
        <div class="card-header" onclick="toggleCard(4)">
            <h2><span class="card-num">4</span> F/M Ratio</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Food to Microorganism ratio. Key process control parameter.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="fm_flow" oninput="calcFM()" placeholder="1.5">
                        <span class="field-hint">Influent flow</span>
                    </div>
                    <div>
                        <label>BOD (mg/L)</label>
                        <input type="number" inputmode="decimal" id="fm_bod" oninput="calcFM()" placeholder="200">
                        <span class="field-hint">Influent BOD‚ÇÖ</span>
                    </div>
                    <div>
                        <label>Aeration Vol (MG)</label>
                        <input type="number" inputmode="decimal" id="fm_vol" oninput="calcFM()" placeholder="0.5">
                        <span class="field-hint">Million gallons</span>
                    </div>
                    <div>
                        <label>MLVSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="fm_mlvss" oninput="calcFM()" placeholder="2000">
                        <span class="field-hint">Or MLSS √ó 0.75</span>
                    </div>
                </div>
                <div class="example-box"><b>Tip:</b> MLVSS ‚âà MLSS √ó 0.75 if not measured directly</div>
                <div class="result-box">
                    <span class="val" id="fm_res">0.000</span>
                    <div id="fm_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('fm_res')">Copy Result</button>
                </div>
                <div class="formula-note">(Flow √ó BOD √ó 8.34) √∑ (Vol √ó MLVSS √ó 8.34)</div>
            </div>
        </div>
    </div>

    <!-- 5. SRT -->
    <div class="card success" id="card5" data-calc="srt">
        <div class="card-header" onclick="toggleCard(5)">
            <h2><span class="card-num">5</span> SRT ‚Äì Sludge Age</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Solids Retention Time. Critical for nitrification (need >8 days).</div>
                <div class="grid">
                    <div>
                        <label>Aeration Vol (MG)</label>
                        <input type="number" inputmode="decimal" id="srt_vol" oninput="calcSRT()" placeholder="0.5">
                        <span class="field-hint">Basin volume</span>
                    </div>
                    <div>
                        <label>MLSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="srt_mlss" oninput="calcSRT()" placeholder="3000">
                        <span class="field-hint">In aeration</span>
                    </div>
                    <div>
                        <label>WAS Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="srt_wasq" oninput="calcSRT()" placeholder="0.015">
                        <span class="field-hint">Waste sludge flow</span>
                    </div>
                    <div>
                        <label>WAS Conc (mg/L)</label>
                        <input type="number" inputmode="decimal" id="srt_wasc" oninput="calcSRT()" placeholder="8000">
                        <span class="field-hint">WAS or RAS conc</span>
                    </div>
                    <div>
                        <label>Effluent Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="srt_effq" oninput="calcSRT()" placeholder="1.5">
                        <span class="field-hint">Discharge flow</span>
                    </div>
                    <div>
                        <label>Effluent TSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="srt_effc" oninput="calcSRT()" placeholder="10">
                        <span class="field-hint">Solids over weirs</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="srt_res">0.0 days</span>
                    <div id="srt_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('srt_res')">Copy Result</button>
                </div>
                <div class="formula-note">Solids in System √∑ Solids Out per Day</div>
            </div>
        </div>
    </div>

    <!-- 6. Detention Time -->
    <div class="card success" id="card6" data-calc="dt">
        <div class="card-header" onclick="toggleCard(6)">
            <h2><span class="card-num">6</span> Detention Time</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Hydraulic retention time in any tank or process.</div>
                <div class="grid">
                    <div>
                        <label>Volume (gallons)</label>
                        <input type="number" inputmode="decimal" id="dt_vol" oninput="calcDT()" placeholder="500000">
                        <span class="field-hint">Tank volume</span>
                    </div>
                    <div>
                        <label>Flow (GPD)</label>
                        <input type="number" inputmode="decimal" id="dt_flow" oninput="calcDT()" placeholder="1500000">
                        <span class="field-hint">Gallons per day</span>
                    </div>
                </div>
                <div class="example-box"><b>Volume:</b> Rect = L√óW√óD√ó7.48 | Circ = 0.785√óD¬≤√óH√ó7.48</div>
                <div class="result-box">
                    <span class="val" id="dt_res">0.00 hours</span>
                    <div id="dt_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('dt_res')">Copy Result</button>
                </div>
                <div class="formula-note">(Volume √∑ Flow) √ó 24</div>
            </div>
        </div>
    </div>

    <!-- 7. Removal Efficiency -->
    <div class="card success" id="card7" data-calc="eff">
        <div class="card-header" onclick="toggleCard(7)">
            <h2><span class="card-num">7</span> Removal Efficiency</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Percent removal for BOD, TSS, ammonia, or any parameter.</div>
                <div class="grid">
                    <div>
                        <label>Influent (mg/L)</label>
                        <input type="number" inputmode="decimal" id="eff_in" oninput="calcEff()" placeholder="200">
                        <span class="field-hint">Before treatment</span>
                    </div>
                    <div>
                        <label>Effluent (mg/L)</label>
                        <input type="number" inputmode="decimal" id="eff_out" oninput="calcEff()" placeholder="15">
                        <span class="field-hint">After treatment</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="eff_res">0.0 %</span>
                    <div id="eff_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('eff_res')">Copy Result</button>
                </div>
                <div class="formula-note">(In - Out) √∑ In √ó 100</div>
            </div>
        </div>
    </div>

    <!-- 8. WAS Pumping Rate -->
    <div class="card" id="card8" data-calc="was">
        <div class="card-header" onclick="toggleCard(8)">
            <h2><span class="card-num">8</span> WAS Pumping Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Calculate required WAS flow to achieve target SRT. Solve for wasting rate.</div>
                <div class="grid">
                    <div>
                        <label>Aeration Vol (MG)</label>
                        <input type="number" inputmode="decimal" id="was_vol" oninput="calcWAS()" placeholder="0.5">
                        <span class="field-hint">Basin volume</span>
                    </div>
                    <div>
                        <label>MLSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="was_mlss" oninput="calcWAS()" placeholder="3000">
                        <span class="field-hint">In aeration</span>
                    </div>
                    <div>
                        <label>Target SRT (days)</label>
                        <input type="number" inputmode="decimal" id="was_srt" oninput="calcWAS()" placeholder="10">
                        <span class="field-hint">Desired sludge age</span>
                    </div>
                    <div>
                        <label>WAS Conc (mg/L)</label>
                        <input type="number" inputmode="decimal" id="was_conc" oninput="calcWAS()" placeholder="8000">
                        <span class="field-hint">WAS/RAS solids</span>
                    </div>
                </div>
                <div class="example-box"><b>Note:</b> This simplified calc ignores effluent TSS loss. For precise SRT, account for solids over weirs.</div>
                <div class="result-box">
                    <span class="val" id="was_res">0 GPD</span>
                    <div id="was_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('was_res')">Copy Result</button>
                </div>
                <div class="formula-note">WAS Flow = (Vol √ó MLSS) √∑ (SRT √ó WAS Conc)</div>
            </div>
        </div>
    </div>

    <!-- 9. RAS Return Rate -->
    <div class="card" id="card9" data-calc="ras">
        <div class="card-header" onclick="toggleCard(9)">
            <h2><span class="card-num">9</span> RAS Return Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Calculate RAS flow rate based on sludge blanket or settleability method.</div>
                <div class="grid">
                    <div>
                        <label>Influent Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="ras_flow" oninput="calcRAS()" placeholder="1.5">
                        <span class="field-hint">Plant flow</span>
                    </div>
                    <div>
                        <label>MLSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="ras_mlss" oninput="calcRAS()" placeholder="3000">
                        <span class="field-hint">In aeration</span>
                    </div>
                    <div>
                        <label>RAS Conc (mg/L)</label>
                        <input type="number" inputmode="decimal" id="ras_conc" oninput="calcRAS()" placeholder="8000">
                        <span class="field-hint">Return sludge TSS</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="ras_res">0.00 MGD</span>
                    <div id="ras_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('ras_res')">Copy Result</button>
                </div>
                <div class="formula-note">RAS = (Q √ó MLSS) √∑ (RAS Conc - MLSS)</div>
            </div>
        </div>
    </div>

    <!-- 10. Organic Loading Rate -->
    <div class="card accent" id="card10" data-calc="olr">
        <div class="card-header" onclick="toggleCard(10)">
            <h2><span class="card-num">10</span> Organic Loading Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">BOD loading per unit volume. Used for trickling filters, RBCs, and aeration basins.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="olr_flow" oninput="calcOLR()" placeholder="1.5">
                        <span class="field-hint">Influent flow</span>
                    </div>
                    <div>
                        <label>BOD (mg/L)</label>
                        <input type="number" inputmode="decimal" id="olr_bod" oninput="calcOLR()" placeholder="200">
                        <span class="field-hint">Influent BOD</span>
                    </div>
                    <div>
                        <label>Volume (1000 ft¬≥)</label>
                        <input type="number" inputmode="decimal" id="olr_vol" oninput="calcOLR()" placeholder="50">
                        <span class="field-hint">Media or basin volume</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="olr_res">0.0 lbs/day/1000ft¬≥</span>
                    <div id="olr_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('olr_res')">Copy Result</button>
                </div>
                <div class="formula-note">(Flow √ó BOD √ó 8.34) √∑ Volume in 1000 ft¬≥</div>
            </div>
        </div>
    </div>

    <!-- 11. Surface Overflow Rate -->
    <div class="card accent" id="card11" data-calc="sor">
        <div class="card-header" onclick="toggleCard(11)">
            <h2><span class="card-num">11</span> Surface Overflow Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Hydraulic loading rate for clarifiers. Flow per unit surface area.</div>
                <div class="grid">
                    <div>
                        <label>Flow (GPD)</label>
                        <input type="number" inputmode="decimal" id="sor_flow" oninput="calcSOR()" placeholder="1500000">
                        <span class="field-hint">Gallons per day</span>
                    </div>
                    <div>
                        <label>Surface Area (ft¬≤)</label>
                        <input type="number" inputmode="decimal" id="sor_area" oninput="calcSOR()" placeholder="3000">
                        <span class="field-hint">Clarifier surface area</span>
                    </div>
                </div>
                <div class="example-box"><b>Circular:</b> Area = 0.785 √ó D¬≤ | <b>Rectangular:</b> Area = L √ó W</div>
                <div class="result-box">
                    <span class="val" id="sor_res">0 GPD/ft¬≤</span>
                    <div id="sor_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('sor_res')">Copy Result</button>
                </div>
                <div class="formula-note">Flow (GPD) √∑ Surface Area (ft¬≤)</div>
            </div>
        </div>
    </div>

    <!-- 12. Weir Overflow Rate -->
    <div class="card accent" id="card12" data-calc="wor">
        <div class="card-header" onclick="toggleCard(12)">
            <h2><span class="card-num">12</span> Weir Overflow Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Flow per linear foot of weir. Important for clarifier performance.</div>
                <div class="grid">
                    <div>
                        <label>Flow (GPD)</label>
                        <input type="number" inputmode="decimal" id="wor_flow" oninput="calcWOR()" placeholder="1500000">
                        <span class="field-hint">Gallons per day</span>
                    </div>
                    <div>
                        <label>Weir Length (ft)</label>
                        <input type="number" inputmode="decimal" id="wor_len" oninput="calcWOR()" placeholder="150">
                        <span class="field-hint">Total weir length</span>
                    </div>
                </div>
                <div class="example-box"><b>Circular weir:</b> Length = œÄ √ó Diameter (3.14 √ó D)</div>
                <div class="result-box">
                    <span class="val" id="wor_res">0 GPD/ft</span>
                    <div id="wor_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('wor_res')">Copy Result</button>
                </div>
                <div class="formula-note">Flow (GPD) √∑ Weir Length (ft)</div>
            </div>
        </div>
    </div>

    <!-- 13. Solids Loading Rate -->
    <div class="card success" id="card13" data-calc="slr">
        <div class="card-header" onclick="toggleCard(13)">
            <h2><span class="card-num">13</span> Solids Loading Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Solids applied per unit clarifier area. Key for secondary clarifier design.</div>
                <div class="grid">
                    <div>
                        <label>Influent + RAS Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="slr_flow" oninput="calcSLR()" placeholder="2.0">
                        <span class="field-hint">Total flow to clarifier</span>
                    </div>
                    <div>
                        <label>MLSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="slr_mlss" oninput="calcSLR()" placeholder="3000">
                        <span class="field-hint">Mixed liquor solids</span>
                    </div>
                    <div>
                        <label>Surface Area (ft¬≤)</label>
                        <input type="number" inputmode="decimal" id="slr_area" oninput="calcSLR()" placeholder="3000">
                        <span class="field-hint">Clarifier area</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="slr_res">0.0 lbs/day/ft¬≤</span>
                    <div id="slr_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('slr_res')">Copy Result</button>
                </div>
                <div class="formula-note">(Flow √ó MLSS √ó 8.34) √∑ Surface Area</div>
            </div>
        </div>
    </div>

    <!-- 14. Chemical Dosing -->
    <div class="card success" id="card14" data-calc="chem">
        <div class="card-header" onclick="toggleCard(14)">
            <h2><span class="card-num">14</span> Chemical Dosing</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Calculate chemical feed rate. Works for chlorine, alum, polymer, lime, etc.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="chem_flow" oninput="calcChem()" placeholder="1.5">
                        <span class="field-hint">Treatment flow</span>
                    </div>
                    <div>
                        <label>Dose (mg/L)</label>
                        <input type="number" inputmode="decimal" id="chem_dose" oninput="calcChem()" placeholder="2.0">
                        <span class="field-hint">Target dosage</span>
                    </div>
                    <div>
                        <label>Chemical % Purity</label>
                        <input type="number" inputmode="decimal" id="chem_purity" oninput="calcChem()" placeholder="100">
                        <span class="field-hint">65% for HTH, 12% for bleach</span>
                    </div>
                </div>
                <div class="example-box"><b>Common:</b> Gas Cl‚ÇÇ = 100% | HTH = 65% | Bleach = 12% | Alum = 48%</div>
                <div class="result-box">
                    <span class="val" id="chem_res">0.00 lbs/day</span>
                    <div id="chem_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('chem_res')">Copy Result</button>
                </div>
                <div class="formula-note">(Flow √ó Dose √ó 8.34) √∑ (Purity √∑ 100)</div>
            </div>
        </div>
    </div>

    <!-- ========== MBR SECTION ========== -->
    <div class="section-header" data-cat="mbr" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(139, 92, 246, 0.15); border-radius: 8px; border-left: 4px solid #8b5cf6; font-size: 0.85rem; color: #a78bfa; font-weight: bold;">üî¨ MBR ‚Äì Membrane Bioreactor Calculators</div>

    <!-- 15. Membrane Flux Rate -->
    <div class="card" id="card15" data-calc="flux" style="border-left-color: #8b5cf6;">
        <div class="card-header" onclick="toggleCard(15)">
            <h2><span class="card-num" style="background: #8b5cf6;">15</span> Membrane Flux Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #8b5cf6;">Calculate permeate flux through the membrane. Primary MBR performance indicator ‚Äî check daily to detect fouling trends.</div>
                <div class="grid">
                    <div>
                        <label>Permeate Flow (GPD)</label>
                        <input type="number" inputmode="decimal" id="flux_flow" oninput="calcFlux()" placeholder="500000">
                        <span class="field-hint">Gallons per day through membranes</span>
                    </div>
                    <div>
                        <label>Membrane Area (ft¬≤)</label>
                        <input type="number" inputmode="decimal" id="flux_area" oninput="calcFlux()" placeholder="50000">
                        <span class="field-hint">Total active membrane area</span>
                    </div>
                </div>
                <div class="example-box"><b>Typical MBR Flux:</b> 10‚Äì15 GFD (avg) | 20‚Äì25 GFD (peak) | &lt;8 GFD = likely fouled | &gt;25 GFD = risk of damage</div>
                <div class="result-box">
                    <span class="val" id="flux_res">0.0 GFD</span>
                    <div id="flux_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('flux_res')">Copy Result</button>
                </div>
                <div class="formula-note">Flux (GFD) = Permeate Flow (GPD) √∑ Membrane Area (ft¬≤)</div>
            </div>
        </div>
    </div>

    <!-- 16. Transmembrane Pressure -->
    <div class="card" id="card16" data-calc="tmp" style="border-left-color: #8b5cf6;">
        <div class="card-header" onclick="toggleCard(16)">
            <h2><span class="card-num" style="background: #8b5cf6;">16</span> Transmembrane Pressure</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #8b5cf6;">Calculate pressure driving permeate through the membrane. TMP trending is the #1 fouling indicator and triggers CIP decisions.</div>
                <div class="grid">
                    <div>
                        <label>Feed Pressure (psi)</label>
                        <input type="number" inputmode="decimal" id="tmp_feed" oninput="calcTMP()" placeholder="6.0">
                        <span class="field-hint">Upstream of membrane</span>
                    </div>
                    <div>
                        <label>Permeate Pressure (psi)</label>
                        <input type="number" inputmode="decimal" id="tmp_perm" oninput="calcTMP()" placeholder="1.0">
                        <span class="field-hint">Downstream (often ~0 or vacuum)</span>
                    </div>
                </div>
                <div class="example-box"><b>Typical MBR TMP:</b> 1‚Äì7 psi (normal) | 7‚Äì12 psi (fouling) | >12 psi = CIP required | Submerged membranes often read in kPa (1 psi = 6.895 kPa)</div>
                <div class="result-box">
                    <span class="val" id="tmp_res">0.0 psi</span>
                    <div id="tmp_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('tmp_res')">Copy Result</button>
                </div>
                <div class="formula-note">TMP = Feed Pressure ‚àí Permeate Pressure</div>
            </div>
        </div>
    </div>

    <!-- 17. Membrane Permeability -->
    <div class="card" id="card17" data-calc="perm" style="border-left-color: #8b5cf6;">
        <div class="card-header" onclick="toggleCard(17)">
            <h2><span class="card-num" style="background: #8b5cf6;">17</span> Membrane Permeability</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #8b5cf6;">Normalizes flux per unit of driving pressure. Detects fouling even when flux appears stable ‚Äî declining permeability confirms membrane fouling.</div>
                <div class="grid">
                    <div>
                        <label>Flux (GFD)</label>
                        <input type="number" inputmode="decimal" id="perm_flux" oninput="calcPerm()" placeholder="12.0">
                        <span class="field-hint">From Flux calculator or known</span>
                    </div>
                    <div>
                        <label>TMP (psi)</label>
                        <input type="number" inputmode="decimal" id="perm_tmp" oninput="calcPerm()" placeholder="5.0">
                        <span class="field-hint">From TMP calculator or gauge</span>
                    </div>
                </div>
                <div class="example-box"><b>Typical Permeability:</b> 3‚Äì6 GFD/psi (good) | 1.5‚Äì3 GFD/psi (fouling) | &lt;1.5 GFD/psi = CIP needed | New membranes: 5‚Äì8+ GFD/psi</div>
                <div class="result-box">
                    <span class="val" id="perm_res">0.0 GFD/psi</span>
                    <div id="perm_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('perm_res')">Copy Result</button>
                </div>
                <div class="formula-note">Permeability = Flux (GFD) √∑ TMP (psi)</div>
            </div>
        </div>
    </div>

    <!-- 18. Membrane Area Sizing -->
    <div class="card" id="card18" data-calc="msize" style="border-left-color: #8b5cf6;">
        <div class="card-header" onclick="toggleCard(18)">
            <h2><span class="card-num" style="background: #8b5cf6;">18</span> Membrane Area Sizing</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #8b5cf6;">Calculate total membrane area needed for design flow. Essential for MBR retrofits, expansions, and new system evaluations.</div>
                <div class="grid">
                    <div>
                        <label>Design Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="msize_flow" oninput="calcMSize()" placeholder="1.5">
                        <span class="field-hint">Average day permitted flow</span>
                    </div>
                    <div>
                        <label>Peak Hour Factor</label>
                        <input type="number" inputmode="decimal" id="msize_pf" oninput="calcMSize()" placeholder="2.0">
                        <span class="field-hint">Typical: 1.5‚Äì3.0√ó</span>
                    </div>
                    <div>
                        <label>Target Avg Flux (GFD)</label>
                        <input type="number" inputmode="decimal" id="msize_flux" oninput="calcMSize()" placeholder="12">
                        <span class="field-hint">Design: 10‚Äì14 GFD avg</span>
                    </div>
                    <div>
                        <label>Peak Flux (GFD)</label>
                        <input type="number" inputmode="decimal" id="msize_peak" oninput="calcMSize()" placeholder="20">
                        <span class="field-hint">Peak: 18‚Äì25 GFD</span>
                    </div>
                </div>
                <div class="example-box"><b>Rule of thumb:</b> Design to avg flux for daily operation. Verify peak flux ‚â§ 25 GFD. Larger area = lower flux = longer membrane life.</div>
                <div class="result-box">
                    <span class="val" id="msize_res">0 ft¬≤</span>
                    <div id="msize_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('msize_res')">Copy Result</button>
                </div>
                <div class="formula-note">Area = Design Flow (GPD) √∑ Target Flux (GFD) ‚Äî checked against peak</div>
            </div>
        </div>
    </div>

    <!-- 19. Specific Aeration Demand -->
    <div class="card" id="card19" data-calc="sad" style="border-left-color: #8b5cf6;">
        <div class="card-header" onclick="toggleCard(19)">
            <h2><span class="card-num" style="background: #8b5cf6;">19</span> Specific Aeration Demand</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #8b5cf6;">Calculate membrane air scouring efficiency. SADm = air per membrane area. SADp = air per permeate volume. Membrane aeration is 30‚Äì50% of MBR energy cost.</div>
                <div class="grid">
                    <div>
                        <label>Air Flow (Nm¬≥/hr)</label>
                        <input type="number" inputmode="decimal" id="sad_air" oninput="calcSAD()" placeholder="500">
                        <span class="field-hint">Coarse bubble to membranes</span>
                    </div>
                    <div>
                        <label>Membrane Area (m¬≤)</label>
                        <input type="number" inputmode="decimal" id="sad_area" oninput="calcSAD()" placeholder="5000">
                        <span class="field-hint">Total active area</span>
                    </div>
                    <div>
                        <label>Permeate Flow (m¬≥/hr)</label>
                        <input type="number" inputmode="decimal" id="sad_perm" oninput="calcSAD()" placeholder="100">
                        <span class="field-hint">Permeate production rate</span>
                    </div>
                </div>
                <div class="example-box"><b>Targets:</b> SADm = 0.2‚Äì0.5 Nm¬≥/m¬≤/hr (flat sheet: 0.5‚Äì1.0) | SADp = 10‚Äì25 m¬≥air/m¬≥permeate | Lower = more efficient</div>
                <div class="result-box">
                    <span class="val" id="sad_res">‚Äî</span>
                    <div id="sad_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('sad_res')">Copy Result</button>
                </div>
                <div class="formula-note">SADm = Air Flow √∑ Membrane Area | SADp = Air Flow √∑ Permeate Flow</div>
            </div>
        </div>
    </div>

    <!-- 20. MBR Operating Range Check -->
    <div class="card" id="card20" data-calc="mbrcheck" style="border-left-color: #8b5cf6;">
        <div class="card-header" onclick="toggleCard(20)">
            <h2><span class="card-num" style="background: #8b5cf6;">20</span> MBR Operating Range Check</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #8b5cf6;">Verify MLSS, SRT, F:M, and DO are within MBR-appropriate ranges. MBR operates at drastically different setpoints than conventional activated sludge.</div>
                <div class="grid">
                    <div>
                        <label>MLSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="mbrc_mlss" oninput="calcMBRC()" placeholder="10000">
                        <span class="field-hint">MBR typical: 8,000‚Äì12,000</span>
                    </div>
                    <div>
                        <label>SRT (days)</label>
                        <input type="number" inputmode="decimal" id="mbrc_srt" oninput="calcMBRC()" placeholder="20">
                        <span class="field-hint">MBR typical: 15‚Äì40 days</span>
                    </div>
                    <div>
                        <label>F:M Ratio</label>
                        <input type="number" inputmode="decimal" id="mbrc_fm" oninput="calcMBRC()" placeholder="0.08">
                        <span class="field-hint">MBR typical: 0.05‚Äì0.15</span>
                    </div>
                    <div>
                        <label>DO (mg/L)</label>
                        <input type="number" inputmode="decimal" id="mbrc_do" oninput="calcMBRC()" placeholder="2.0">
                        <span class="field-hint">MBR typical: 1.0‚Äì3.0</span>
                    </div>
                </div>
                <div class="example-box"><b>CAS vs MBR:</b> CAS MLSS 1,500‚Äì4,000 ‚Üí MBR 8,000‚Äì12,000 | CAS SRT 5‚Äì15 d ‚Üí MBR 15‚Äì40 d | CAS F:M 0.2‚Äì0.5 ‚Üí MBR 0.05‚Äì0.15</div>
                <div class="result-box">
                    <span class="val" id="mbrc_res">‚Äî</span>
                    <div id="mbrc_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('mbrc_res')">Copy Result</button>
                </div>
                <div class="formula-note">Compares inputs against MBR-specific operating ranges</div>
            </div>
        </div>
    </div>

    <!-- 21. CIP Chemical Dosing -->
    <div class="card" id="card21" data-calc="cip" style="border-left-color: #8b5cf6;">
        <div class="card-header" onclick="toggleCard(21)">
            <h2><span class="card-num" style="background: #8b5cf6;">21</span> CIP Chemical Dosing</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #8b5cf6;">Calculate sodium hypochlorite (NaOCl) and citric acid volumes for membrane maintenance and recovery cleans. Wrong dosing can damage membranes.</div>
                <div class="grid">
                    <div>
                        <label>CIP Tank Volume (gal)</label>
                        <input type="number" inputmode="decimal" id="cip_vol" oninput="calcCIP()" placeholder="500">
                        <span class="field-hint">Membrane train clean volume</span>
                    </div>
                    <div>
                        <label>Target NaOCl (mg/L)</label>
                        <input type="number" inputmode="decimal" id="cip_nacl" oninput="calcCIP()" placeholder="1000">
                        <span class="field-hint">Maint: 200‚Äì500 | Recovery: 1000‚Äì2000</span>
                    </div>
                    <div>
                        <label>Bleach Strength (%)</label>
                        <input type="number" inputmode="decimal" id="cip_bleach" oninput="calcCIP()" placeholder="12.5">
                        <span class="field-hint">Typical: 12.5% (trade) or 10%</span>
                    </div>
                    <div>
                        <label>Target Citric Acid (mg/L)</label>
                        <input type="number" inputmode="decimal" id="cip_citric" oninput="calcCIP()" placeholder="2000">
                        <span class="field-hint">Maint: 1000‚Äì2000 | Recovery: 2000‚Äì5000</span>
                    </div>
                    <div>
                        <label>Citric Acid Strength (%)</label>
                        <input type="number" inputmode="decimal" id="cip_cstr" oninput="calcCIP()" placeholder="50">
                        <span class="field-hint">Powder dissolved: 50% typical</span>
                    </div>
                </div>
                <div class="example-box"><b>CIP Schedule:</b> Maintenance clean (MC): weekly‚Äìbiweekly | Recovery clean (RC): monthly‚Äìquarterly | Always NaOCl first, then citric acid. Never mix!</div>
                <div class="result-box">
                    <span class="val" id="cip_res">‚Äî</span>
                    <div id="cip_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('cip_res')">Copy Result</button>
                </div>
                <div class="formula-note">Volume = (Tank Vol √ó Target Conc) √∑ (Solution Strength √ó 10,000)</div>
            </div>
        </div>
    </div>

    <!-- ========== MBBR SECTION ========== -->
    <div class="section-header" data-cat="mbbr" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(6, 182, 212, 0.15); border-radius: 8px; border-left: 4px solid #06b6d4; font-size: 0.85rem; color: #22d3ee; font-weight: bold;">üß¨ MBBR ‚Äì Moving Bed Biofilm Reactor Calculators</div>

    <!-- 22. Surface Area Loading Rate -->
    <div class="card" id="card22" data-calc="salr" style="border-left-color: #06b6d4;">
        <div class="card-header" onclick="toggleCard(22)">
            <h2><span class="card-num" style="background: #06b6d4;">22</span> Surface Area Loading Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #06b6d4;">The fundamental MBBR design parameter ‚Äî equivalent of F:M for suspended growth. Calculates organic or nitrogen load applied per unit of biofilm surface area.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="salr_flow" oninput="calcSALR()" placeholder="1.5">
                        <span class="field-hint">Influent flow to MBBR</span>
                    </div>
                    <div>
                        <label>Concentration (mg/L)</label>
                        <input type="number" inputmode="decimal" id="salr_conc" oninput="calcSALR()" placeholder="150">
                        <span class="field-hint">BOD‚ÇÖ or NH‚ÇÉ-N</span>
                    </div>
                    <div>
                        <label>Biofilm Area (m¬≤)</label>
                        <input type="number" inputmode="decimal" id="salr_area" oninput="calcSALR()" placeholder="50000">
                        <span class="field-hint">Total protected surface area</span>
                    </div>
                </div>
                <div class="example-box"><b>SALR Targets:</b> BOD removal: 5‚Äì20 g/m¬≤/d | Nitrification: 0.5‚Äì1.5 g NH‚ÇÉ-N/m¬≤/d | Pre-denitrification: 1‚Äì3 g NO‚ÇÉ-N/m¬≤/d</div>
                <div class="result-box">
                    <span class="val" id="salr_res">0.0 g/m¬≤/d</span>
                    <div id="salr_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('salr_res')">Copy Result</button>
                </div>
                <div class="formula-note">SALR = (Flow √ó Conc √ó 3.785) √∑ Biofilm Area (g/m¬≤/day)</div>
            </div>
        </div>
    </div>

    <!-- 23. Effective Biofilm Area -->
    <div class="card" id="card23" data-calc="bioarea" style="border-left-color: #06b6d4;">
        <div class="card-header" onclick="toggleCard(23)">
            <h2><span class="card-num" style="background: #06b6d4;">23</span> Effective Biofilm Area</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #06b6d4;">Calculate total protected biofilm surface area from reactor volume, media fill fraction, and carrier specific surface area. Needed to verify actual loading rates.</div>
                <div class="grid">
                    <div>
                        <label>Reactor Volume (ft¬≥)</label>
                        <input type="number" inputmode="decimal" id="bio_vol" oninput="calcBioArea()" placeholder="10000">
                        <span class="field-hint">Liquid volume of MBBR zone</span>
                    </div>
                    <div>
                        <label>Fill Fraction (%)</label>
                        <input type="number" inputmode="decimal" id="bio_fill" oninput="calcBioArea()" placeholder="50">
                        <span class="field-hint">Typical: 40‚Äì67%</span>
                    </div>
                    <div>
                        <label>Specific Surface Area (m¬≤/m¬≥)</label>
                        <input type="number" inputmode="decimal" id="bio_ssa" oninput="calcBioArea()" placeholder="500">
                        <span class="field-hint">From media spec sheet</span>
                    </div>
                </div>
                <div class="example-box"><b>Common Media SSA:</b> K1 Kaldnes = 500 m¬≤/m¬≥ | K3 = 500 | K5 = 800 | AnoxKaldnes‚Ñ¢ BiofilmChip‚Ñ¢ = 900+ | Typical fill: 50‚Äì60%</div>
                <div class="result-box">
                    <span class="val" id="bio_res">0 m¬≤</span>
                    <div id="bio_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('bio_res')">Copy Result</button>
                </div>
                <div class="formula-note">Area = Reactor Vol (m¬≥) √ó Fill% √ó Specific Surface Area (m¬≤/m¬≥)</div>
            </div>
        </div>
    </div>

    <!-- 24. Media Fill Volume -->
    <div class="card" id="card24" data-calc="mediavol" style="border-left-color: #06b6d4;">
        <div class="card-header" onclick="toggleCard(24)">
            <h2><span class="card-num" style="background: #06b6d4;">24</span> Media Fill Volume</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #06b6d4;">Calculate required carrier media volume from target SALR, influent load, and media specific surface area. Critical for sizing new MBBR systems or expansions.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="mv_flow" oninput="calcMediaVol()" placeholder="1.5">
                        <span class="field-hint">Influent flow</span>
                    </div>
                    <div>
                        <label>Concentration (mg/L)</label>
                        <input type="number" inputmode="decimal" id="mv_conc" oninput="calcMediaVol()" placeholder="150">
                        <span class="field-hint">BOD‚ÇÖ or NH‚ÇÉ-N</span>
                    </div>
                    <div>
                        <label>Target SALR (g/m¬≤/d)</label>
                        <input type="number" inputmode="decimal" id="mv_salr" oninput="calcMediaVol()" placeholder="10">
                        <span class="field-hint">BOD: 5‚Äì20 | NH‚ÇÉ: 0.5‚Äì1.5</span>
                    </div>
                    <div>
                        <label>Media SSA (m¬≤/m¬≥)</label>
                        <input type="number" inputmode="decimal" id="mv_ssa" oninput="calcMediaVol()" placeholder="500">
                        <span class="field-hint">From spec sheet</span>
                    </div>
                </div>
                <div class="example-box"><b>Sizing Logic:</b> Required area = Load √∑ SALR ‚Üí Media volume = Area √∑ SSA ‚Üí Check fill fraction stays 40‚Äì67%</div>
                <div class="result-box">
                    <span class="val" id="mv_res">0 m¬≥</span>
                    <div id="mv_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('mv_res')">Copy Result</button>
                </div>
                <div class="formula-note">Media Vol = (Flow √ó Conc √ó 3.785) √∑ (Target SALR √ó SSA)</div>
            </div>
        </div>
    </div>

    <!-- 25. MBBR Reactor Sizing -->
    <div class="card" id="card25" data-calc="mbbrsz" style="border-left-color: #06b6d4;">
        <div class="card-header" onclick="toggleCard(25)">
            <h2><span class="card-num" style="background: #06b6d4;">25</span> MBBR Reactor Sizing</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #06b6d4;">Calculate required reactor volume from media volume and fill fraction. Verifies HRT and ensures adequate empty-bed volume for proper media circulation.</div>
                <div class="grid">
                    <div>
                        <label>Media Volume (m¬≥)</label>
                        <input type="number" inputmode="decimal" id="rsz_media" oninput="calcRSZ()" placeholder="150">
                        <span class="field-hint">From Media Fill calc or known</span>
                    </div>
                    <div>
                        <label>Fill Fraction (%)</label>
                        <input type="number" inputmode="decimal" id="rsz_fill" oninput="calcRSZ()" placeholder="55">
                        <span class="field-hint">Target: 40‚Äì67% max</span>
                    </div>
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="rsz_flow" oninput="calcRSZ()" placeholder="1.5">
                        <span class="field-hint">For HRT calculation</span>
                    </div>
                </div>
                <div class="example-box"><b>Design Notes:</b> Max fill 67% ‚Äî above this media cannot circulate. Typical HRT: 1‚Äì3 hrs BOD removal | 3‚Äì6 hrs nitrification. Provide adequate mixing energy.</div>
                <div class="result-box">
                    <span class="val" id="rsz_res">0 m¬≥</span>
                    <div id="rsz_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('rsz_res')">Copy Result</button>
                </div>
                <div class="formula-note">Reactor Vol = Media Vol √∑ (Fill% √∑ 100)</div>
            </div>
        </div>
    </div>

    <!-- 26. MBBR Dissolved Oxygen Demand -->
    <div class="card" id="card26" data-calc="mbbrdo" style="border-left-color: #06b6d4;">
        <div class="card-header" onclick="toggleCard(26)">
            <h2><span class="card-num" style="background: #06b6d4;">26</span> MBBR Oxygen Demand</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #06b6d4;">Calculate O‚ÇÇ transfer needed for BOD removal and nitrification in MBBR. Biofilm systems need higher DO (4‚Äì6 mg/L) than CAS (~2 mg/L) due to boundary layer diffusion.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="mdo_flow" oninput="calcMDO()" placeholder="1.5">
                        <span class="field-hint">Influent flow</span>
                    </div>
                    <div>
                        <label>BOD Removed (mg/L)</label>
                        <input type="number" inputmode="decimal" id="mdo_bod" oninput="calcMDO()" placeholder="130">
                        <span class="field-hint">Influent ‚Äì Effluent BOD</span>
                    </div>
                    <div>
                        <label>NH‚ÇÉ-N Removed (mg/L)</label>
                        <input type="number" inputmode="decimal" id="mdo_nh3" oninput="calcMDO()" placeholder="20">
                        <span class="field-hint">0 if no nitrification</span>
                    </div>
                </div>
                <div class="example-box"><b>O‚ÇÇ Factors:</b> ~1.5 lb O‚ÇÇ/lb BOD removed | ~4.6 lb O‚ÇÇ/lb NH‚ÇÉ-N oxidized | MBBR target DO: 4‚Äì6 mg/L (vs CAS 1.5‚Äì2.5 mg/L)</div>
                <div class="result-box">
                    <span class="val" id="mdo_res">0 lbs O‚ÇÇ/day</span>
                    <div id="mdo_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('mdo_res')">Copy Result</button>
                </div>
                <div class="formula-note">O‚ÇÇ = (Flow √ó ŒîBOD √ó 8.34 √ó 1.5) + (Flow √ó ŒîNH‚ÇÉ √ó 8.34 √ó 4.6)</div>
            </div>
        </div>
    </div>

    <!-- 27. MBBR vs CAS Comparison -->
    <div class="card" id="card27" data-calc="mbbrcas" style="border-left-color: #06b6d4;">
        <div class="card-header" onclick="toggleCard(27)">
            <h2><span class="card-num" style="background: #06b6d4;">27</span> MBBR vs CAS Comparison</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #06b6d4;">Side-by-side comparison of MBBR vs conventional activated sludge for the same flow and load. Useful for technology selection and consulting evaluations.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="cmp_flow" oninput="calcCMP()" placeholder="1.5">
                        <span class="field-hint">Design flow</span>
                    </div>
                    <div>
                        <label>Influent BOD (mg/L)</label>
                        <input type="number" inputmode="decimal" id="cmp_bod" oninput="calcCMP()" placeholder="200">
                        <span class="field-hint">Raw or primary effluent BOD</span>
                    </div>
                </div>
                <div class="example-box"><b>Comparison basis:</b> CAS: F:M=0.3, MLSS=3000, SRT=10d | MBBR: SALR=10 g/m¬≤/d, K3 media 500 m¬≤/m¬≥, 55% fill</div>
                <div class="result-box">
                    <span class="val" id="cmp_res">‚Äî</span>
                    <div id="cmp_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('cmp_res')">Copy Result</button>
                </div>
                <div class="formula-note">CAS Vol = (Flow √ó BOD √ó 8.34) √∑ (F:M √ó MLSS) | MBBR Vol = Media √∑ Fill%</div>
            </div>
        </div>
    </div>

    <!-- ========== SBR SECTION ========== -->
    <div class="section-header" data-cat="sbr" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(244, 63, 94, 0.15); border-radius: 8px; border-left: 4px solid #f43f5e; font-size: 0.85rem; color: #fb7185; font-weight: bold;">‚è±Ô∏è SBR ‚Äì Sequencing Batch Reactor Calculators</div>

    <!-- 28. SBR Cycle Time -->
    <div class="card" id="card28" data-calc="sbrcycle" style="border-left-color: #f43f5e;">
        <div class="card-header" onclick="toggleCard(28)">
            <h2><span class="card-num" style="background: #f43f5e;">28</span> SBR Cycle Time</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #f43f5e;">Calculate total cycle time, cycles per day, and effective treatment capacity. Every SBR process decision flows from cycle timing.</div>

                <div style="margin-bottom:10px;">
                    <button onclick="document.getElementById('sbr_guide').style.display = document.getElementById('sbr_guide').style.display === 'none' ? 'block' : 'none'; this.innerText = document.getElementById('sbr_guide').style.display === 'none' ? 'üìñ How to Use ‚ñ∏' : 'üìñ How to Use ‚ñæ'" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid #f43f5e;background:rgba(244,63,94,0.08);color:#fb7185;font-weight:bold;font-size:0.82rem;cursor:pointer;text-align:left;">üìñ How to Use ‚ñ∏</button>
                    <div id="sbr_guide" style="display:none;margin-top:8px;background:#0c1222;border:1px solid #334155;border-radius:8px;padding:14px;font-size:0.8rem;color:#cbd5e1;line-height:1.7;">
                        <div style="color:#fb7185;font-weight:bold;font-size:0.85rem;margin-bottom:8px;">SBR CYCLE TIME ‚Äî OPERATOR GUIDE</div>

                        <div style="color:#f8fafc;font-weight:bold;">What This Calculates</div>
                        An SBR operates in batch cycles: Fill ‚Üí React (Aerate) ‚Üí Settle ‚Üí Decant ‚Üí Idle. This calculator adds up all phase times to get your total cycle, then tells you how many cycles per day and whether your basin can handle the design flow.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Inputs Explained</div>
                        <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                            <b>Fill Time</b> ‚Äî How long to fill the basin. Static fill (no aeration) = stronger batch effect. Most plants: 1‚Äì2 hours.<br>
                            <b>React/Aerate Time</b> ‚Äî Active aeration period. This is where BOD removal and nitrification happen. Typically 2‚Äì4 hours. Longer = better treatment but fewer cycles.<br>
                            <b>Settle Time</b> ‚Äî Quiescent settling (no mixing or aeration). Typically 0.5‚Äì1.5 hours. Poor settling sludge needs more time.<br>
                            <b>Decant Time</b> ‚Äî Time to withdraw clear supernatant. Depends on decanter capacity. Typically 0.5‚Äì1 hour.<br>
                            <b>Idle Time</b> ‚Äî Buffer between cycles. Used for WAS, equalization, or waiting for the other basin to finish. Can be 0 if cycles are tight.
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">How to Read Results</div>
                        <b>Cycles/day</b> = 24 hrs √∑ total cycle time. More cycles = more daily capacity. Typical: 4‚Äì6 cycles/day.<br>
                        <b>Aeration duty cycle</b> = % of time blowers run. Used for energy cost estimates and blower sizing.<br>
                        If cycles/day √ó volume/cycle < your design flow, you need to shorten cycles or add a basin.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">TCEQ Exam Tips</div>
                        <div style="background:rgba(244,63,94,0.1);border-radius:6px;padding:8px 10px;margin:4px 0;border-left:3px solid #f43f5e;">
                            ‚Ä¢ Total cycle = Fill + React + Settle + Decant + Idle<br>
                            ‚Ä¢ Cycles/day = 24 √∑ Total Cycle (hrs)<br>
                            ‚Ä¢ If they ask "how many gallons can the SBR treat per day" ‚Üí cycles/day √ó volume per cycle<br>
                            ‚Ä¢ SBR = activated sludge without a separate clarifier
                        </div>
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>Fill (min)</label>
                        <input type="number" inputmode="decimal" id="cyc_fill" oninput="calcCycle()" placeholder="60">
                        <span class="field-hint">Static or aerated fill</span>
                    </div>
                    <div>
                        <label>React (min)</label>
                        <input type="number" inputmode="decimal" id="cyc_react" oninput="calcCycle()" placeholder="120">
                        <span class="field-hint">Aeration + mixing</span>
                    </div>
                    <div>
                        <label>Settle (min)</label>
                        <input type="number" inputmode="decimal" id="cyc_settle" oninput="calcCycle()" placeholder="60">
                        <span class="field-hint">Quiescent settling</span>
                    </div>
                    <div>
                        <label>Decant (min)</label>
                        <input type="number" inputmode="decimal" id="cyc_decant" oninput="calcCycle()" placeholder="30">
                        <span class="field-hint">Effluent withdrawal</span>
                    </div>
                    <div>
                        <label>Idle (min)</label>
                        <input type="number" inputmode="decimal" id="cyc_idle" oninput="calcCycle()" placeholder="10">
                        <span class="field-hint">Buffer / WAS (can be 0)</span>
                    </div>
                    <div>
                        <label>Design Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="cyc_flow" oninput="calcCycle()" placeholder="1.0">
                        <span class="field-hint">For capacity check</span>
                    </div>
                </div>
                <div class="example-box"><b>Typical Cycles:</b> 4‚Äì6 hrs total | 4‚Äì6 cycles/day | Fill 25‚Äì30% of cycle | React 30‚Äì40% | Settle 20‚Äì25% | Decant 15‚Äì20%</div>
                <div class="result-box">
                    <span class="val" id="cyc_res">‚Äî</span>
                    <div id="cyc_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('cyc_res')">Copy Result</button>
                </div>
                <div class="formula-note">Cycle = Fill + React + Settle + Decant + Idle | Cycles/day = 1440 √∑ Cycle</div>
            </div>
        </div>
    </div>

    <!-- 29. SBR Volume per Cycle -->
    <div class="card" id="card29" data-calc="sbrvol" style="border-left-color: #f43f5e;">
        <div class="card-header" onclick="toggleCard(29)">
            <h2><span class="card-num" style="background: #f43f5e;">29</span> SBR Volume per Cycle</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #f43f5e;">Calculate fill volume per cycle and verify reactor can handle the hydraulic load. Determines decant volume and checks against reactor capacity.</div>
                <div class="grid">
                    <div>
                        <label>Daily Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="sv_flow" oninput="calcSBRVol()" placeholder="1.0">
                        <span class="field-hint">Average daily flow</span>
                    </div>
                    <div>
                        <label>Cycles per Day</label>
                        <input type="number" inputmode="decimal" id="sv_cycles" oninput="calcSBRVol()" placeholder="4">
                        <span class="field-hint">From Cycle Time calc</span>
                    </div>
                    <div>
                        <label>Reactor Volume (gal)</label>
                        <input type="number" inputmode="decimal" id="sv_reactor" oninput="calcSBRVol()" placeholder="500000">
                        <span class="field-hint">Total basin volume</span>
                    </div>
                    <div>
                        <label># of Basins</label>
                        <input type="number" inputmode="decimal" id="sv_basins" oninput="calcSBRVol()" placeholder="2">
                        <span class="field-hint">Parallel SBR basins</span>
                    </div>
                </div>
                <div class="example-box"><b>Design Rule:</b> Decant volume (fill vol) should be 15‚Äì35% of total reactor volume. Freeboard must remain above max water level at all times.</div>
                <div class="result-box">
                    <span class="val" id="sv_res">‚Äî</span>
                    <div id="sv_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('sv_res')">Copy Result</button>
                </div>
                <div class="formula-note">Vol/Cycle = Daily Flow √∑ (Cycles √ó Basins) | Fill Ratio = Vol/Cycle √∑ Reactor Vol</div>
            </div>
        </div>
    </div>

    <!-- 30. SBR Decant Rate -->
    <div class="card" id="card30" data-calc="sbrdecant" style="border-left-color: #f43f5e;">
        <div class="card-header" onclick="toggleCard(30)">
            <h2><span class="card-num" style="background: #f43f5e;">30</span> SBR Decant Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #f43f5e;">Calculate decant withdrawal rate. Too fast = turbulence pulls solids into effluent. Too slow = steals time from react phase.</div>
                <div class="grid">
                    <div>
                        <label>Decant Volume (gal)</label>
                        <input type="number" inputmode="decimal" id="dec_vol" oninput="calcDecant()" placeholder="125000">
                        <span class="field-hint">Volume removed per cycle</span>
                    </div>
                    <div>
                        <label>Decant Time (min)</label>
                        <input type="number" inputmode="decimal" id="dec_time" oninput="calcDecant()" placeholder="30">
                        <span class="field-hint">Available decant period</span>
                    </div>
                    <div>
                        <label>Weir Length (ft)</label>
                        <input type="number" inputmode="decimal" id="dec_weir" oninput="calcDecant()" placeholder="20">
                        <span class="field-hint">Decanter weir length</span>
                    </div>
                </div>
                <div class="example-box"><b>Decant Limits:</b> Typical rate: 1,000‚Äì4,000 GPM total | Weir loading: &lt;10 GPM/ft preferred | Floating decanters adjust with water level</div>
                <div class="result-box">
                    <span class="val" id="dec_res">0 GPM</span>
                    <div id="dec_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('dec_res')">Copy Result</button>
                </div>
                <div class="formula-note">Rate (GPM) = Decant Vol √∑ Decant Time | Weir Rate = GPM √∑ Weir Length</div>
            </div>
        </div>
    </div>

    <!-- 31. SBR Aeration Demand -->
    <div class="card" id="card31" data-calc="sbraer" style="border-left-color: #f43f5e;">
        <div class="card-header" onclick="toggleCard(31)">
            <h2><span class="card-num" style="background: #f43f5e;">31</span> SBR Aeration Demand</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #f43f5e;">Calculate O‚ÇÇ required during react phase. In SBR, aeration only runs during fill+react ‚Äî blowers must deliver the full daily O‚ÇÇ demand in less time than continuous-flow plants.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="saer_flow" oninput="calcSBRAer()" placeholder="1.0">
                        <span class="field-hint">Daily flow</span>
                    </div>
                    <div>
                        <label>BOD Removed (mg/L)</label>
                        <input type="number" inputmode="decimal" id="saer_bod" oninput="calcSBRAer()" placeholder="150">
                        <span class="field-hint">Influent ‚Äì Effluent BOD</span>
                    </div>
                    <div>
                        <label>NH‚ÇÉ-N Removed (mg/L)</label>
                        <input type="number" inputmode="decimal" id="saer_nh3" oninput="calcSBRAer()" placeholder="20">
                        <span class="field-hint">0 if no nitrification</span>
                    </div>
                    <div>
                        <label>Aeration Duty (%)</label>
                        <input type="number" inputmode="decimal" id="saer_duty" oninput="calcSBRAer()" placeholder="50">
                        <span class="field-hint">(Fill + React) √∑ Total Cycle √ó 100</span>
                    </div>
                </div>
                <div class="example-box"><b>SBR Aeration:</b> If cycle = 4 hrs and aerated phases = 2 hrs ‚Üí 50% duty. Blower must deliver 2√ó the continuous rate. Size blowers for peak duty, not daily average.</div>
                <div class="result-box">
                    <span class="val" id="saer_res">‚Äî</span>
                    <div id="saer_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('saer_res')">Copy Result</button>
                </div>
                <div class="formula-note">Daily O‚ÇÇ = (BOD √ó 1.5 + NH‚ÇÉ √ó 4.6) √ó Flow √ó 8.34 | Peak = Daily √∑ Duty%</div>
            </div>
        </div>
    </div>

    <!-- 32. SBR F:M per Cycle -->
    <div class="card" id="card32" data-calc="sbrfm" style="border-left-color: #f43f5e;">
        <div class="card-header" onclick="toggleCard(32)">
            <h2><span class="card-num" style="background: #f43f5e;">32</span> SBR F:M per Cycle</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #f43f5e;">SBR F:M differs from CAS ‚Äî the food slug arrives all at once during fill, creating a high instantaneous F:M that drops to near-zero by end of react.</div>
                <div class="grid">
                    <div>
                        <label>Fill Volume (gal)</label>
                        <input type="number" inputmode="decimal" id="sfm_fill" oninput="calcSBRFM()" placeholder="125000">
                        <span class="field-hint">Volume added per cycle</span>
                    </div>
                    <div>
                        <label>Influent BOD (mg/L)</label>
                        <input type="number" inputmode="decimal" id="sfm_bod" oninput="calcSBRFM()" placeholder="200">
                        <span class="field-hint">Incoming BOD concentration</span>
                    </div>
                    <div>
                        <label>Reactor Volume (gal)</label>
                        <input type="number" inputmode="decimal" id="sfm_vol" oninput="calcSBRFM()" placeholder="500000">
                        <span class="field-hint">Total basin volume</span>
                    </div>
                    <div>
                        <label>MLVSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="sfm_mlvss" oninput="calcSBRFM()" placeholder="2500">
                        <span class="field-hint">Volatile suspended solids</span>
                    </div>
                    <div>
                        <label>Cycles per Day</label>
                        <input type="number" inputmode="decimal" id="sfm_cycles" oninput="calcSBRFM()" placeholder="4">
                        <span class="field-hint">For daily F:M</span>
                    </div>
                </div>
                <div class="example-box"><b>SBR F:M:</b> Daily avg: 0.05‚Äì0.15 typical | Instantaneous at start of fill is much higher | CAS equivalent would be 0.2‚Äì0.5</div>
                <div class="result-box">
                    <span class="val" id="sfm_res">‚Äî</span>
                    <div id="sfm_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('sfm_res')">Copy Result</button>
                </div>
                <div class="formula-note">Daily F:M = (Fill √ó BOD √ó 8.34 √ó Cycles) √∑ (Reactor √ó MLVSS √ó 8.34)</div>
            </div>
        </div>
    </div>

    <!-- 33. SBR Settle & Decant Check -->
    <div class="card" id="card33" data-calc="sbrsettle" style="border-left-color: #f43f5e;">
        <div class="card-header" onclick="toggleCard(33)">
            <h2><span class="card-num" style="background: #f43f5e;">33</span> SBR Settle & Decant Check</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #f43f5e;">Verify adequate separation before decant begins. Flags risk of solids carryover if sludge blanket is too close to decant withdrawal level.</div>
                <div class="grid">
                    <div>
                        <label>Total Water Depth (ft)</label>
                        <input type="number" inputmode="decimal" id="ssc_depth" oninput="calcSSC()" placeholder="16">
                        <span class="field-hint">Max water level at end of fill</span>
                    </div>
                    <div>
                        <label>Settled Sludge (%)</label>
                        <input type="number" inputmode="decimal" id="ssc_sludge" oninput="calcSSC()" placeholder="30">
                        <span class="field-hint">30-min settleometer (% of total)</span>
                    </div>
                    <div>
                        <label>Decant Depth (ft)</label>
                        <input type="number" inputmode="decimal" id="ssc_decant" oninput="calcSSC()" placeholder="4">
                        <span class="field-hint">Water removed during decant</span>
                    </div>
                    <div>
                        <label>MLSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="ssc_mlss" oninput="calcSSC()" placeholder="3500">
                        <span class="field-hint">Mixed liquor concentration</span>
                    </div>
                </div>
                <div class="example-box"><b>Safety Rule:</b> Sludge blanket must be ‚â•2 ft below decant weir at start of decant. Blanket depth = Water depth √ó Settled%. Good settling = &lt;30% in 30 min.</div>
                <div class="result-box">
                    <span class="val" id="ssc_res">‚Äî</span>
                    <div id="ssc_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('ssc_res')">Copy Result</button>
                </div>
                <div class="formula-note">Blanket = Depth √ó Settle% | Clearwater = Depth ‚àí Blanket | Buffer = Clearwater ‚àí Decant</div>
            </div>
        </div>
    </div>

    <!-- ========== DISINFECTION SECTION ========== -->
    <div class="section-header" data-cat="disinf" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(234, 179, 8, 0.15); border-radius: 8px; border-left: 4px solid #eab308; font-size: 0.85rem; color: #facc15; font-weight: bold;">üß™ Disinfection Calculators</div>

    <!-- 34. Chlorine Contact Time (CT) -->
    <div class="card" id="card34" data-calc="ct" style="border-left-color: #eab308;">
        <div class="card-header" onclick="toggleCard(34)">
            <h2><span class="card-num" style="background: #eab308;">34</span> Chlorine CT Value</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #eab308;">Calculate CT value for disinfection compliance. CT = chlorine residual √ó contact time. TCEQ requires specific CT for pathogen inactivation.</div>

                <div style="margin-bottom:10px;">
                    <button onclick="document.getElementById('ct_guide').style.display = document.getElementById('ct_guide').style.display === 'none' ? 'block' : 'none'; this.innerText = document.getElementById('ct_guide').style.display === 'none' ? 'üìñ How to Use ‚ñ∏' : 'üìñ How to Use ‚ñæ'" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid #eab308;background:rgba(234,179,8,0.08);color:#facc15;font-weight:bold;font-size:0.82rem;cursor:pointer;text-align:left;">üìñ How to Use ‚ñ∏</button>
                    <div id="ct_guide" style="display:none;margin-top:8px;background:#0c1222;border:1px solid #334155;border-radius:8px;padding:14px;font-size:0.8rem;color:#cbd5e1;line-height:1.7;">
                        <div style="color:#facc15;font-weight:bold;font-size:0.85rem;margin-bottom:8px;">CHLORINE CT VALUE ‚Äî OPERATOR GUIDE</div>

                        <div style="color:#f8fafc;font-weight:bold;">What is CT?</div>
                        CT is the product of disinfectant concentration (C, in mg/L) multiplied by contact time (T, in minutes). It measures total disinfection "dose" ‚Äî a higher CT means more pathogen kill. Your permit requires a minimum CT to ensure adequate disinfection before discharge.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Inputs Explained</div>
                        <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                            <b>Cl‚ÇÇ Residual (mg/L)</b> ‚Äî Measured at the <i>end</i> of the contact chamber, not at the dosing point. Use your grab sample or continuous analyzer reading.<br>
                            <b>Contact Time (min)</b> ‚Äî Use T10, NOT theoretical detention time. T10 = volume √∑ flow √ó baffling factor (BF). Serpentine channels: BF = 0.7. Plug flow pipe: BF = 1.0. Open basin: BF = 0.1‚Äì0.3.<br>
                            <b>Required CT</b> ‚Äî From your permit or TCEQ guidance. Depends on target pathogen, temperature, and pH. Cold water + high pH = need higher CT.
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Critical Operator Notes</div>
                        <div style="background:rgba(234,179,8,0.1);border-radius:6px;padding:8px 10px;margin:4px 0;border-left:3px solid #eab308;">
                            ‚Ä¢ <b>T10 matters:</b> A 10,000-gal tank at 100 GPM has 100 min theoretical detention ‚Äî but with BF=0.3, T10 is only 30 min<br>
                            ‚Ä¢ <b>Temperature effect:</b> CT requirements roughly double for every 10¬∞C drop in water temperature<br>
                            ‚Ä¢ <b>pH effect:</b> Free chlorine is much more effective at pH &lt; 7.5. Hypochlorous acid (HOCl) dominates below pH 7.5<br>
                            ‚Ä¢ <b>Don't over-chlorinate:</b> High residual = high CT but also high dechlorination cost and aquatic toxicity risk<br>
                            ‚Ä¢ <b>TCEQ exam:</b> CT = C √ó T. They often give you volume and flow ‚Äî you must calculate T first (T = Vol √∑ Flow, convert to minutes)
                        </div>
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>Cl‚ÇÇ Residual (mg/L)</label>
                        <input type="number" inputmode="decimal" id="ct_res_in" oninput="calcCT()" placeholder="2.0">
                        <span class="field-hint">At end of contact chamber</span>
                    </div>
                    <div>
                        <label>Contact Time (min)</label>
                        <input type="number" inputmode="decimal" id="ct_time" oninput="calcCT()" placeholder="30">
                        <span class="field-hint">T10 actual contact time</span>
                    </div>
                    <div>
                        <label>Required CT (mg¬∑min/L)</label>
                        <input type="number" inputmode="decimal" id="ct_req" oninput="calcCT()" placeholder="450">
                        <span class="field-hint">From permit or tables</span>
                    </div>
                </div>
                <div class="example-box"><b>Common CT Requirements:</b> 2-log virus: 6 mg¬∑min/L (free Cl‚ÇÇ) | 3-log Giardia: 104‚Äì150+ depending on temp/pH | TCEQ Surface Water: 450+ typical</div>
                <div class="result-box">
                    <span class="val" id="ct_res">0.0 mg¬∑min/L</span>
                    <div id="ct_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('ct_res')">Copy Result</button>
                </div>
                <div class="formula-note">CT = Residual (mg/L) √ó Contact Time (min)</div>
            </div>
        </div>
    </div>

    <!-- 35. Dechlorination Dosing -->
    <div class="card" id="card35" data-calc="dechlor" style="border-left-color: #eab308;">
        <div class="card-header" onclick="toggleCard(35)">
            <h2><span class="card-num" style="background: #eab308;">35</span> Dechlorination Dosing</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #eab308;">Calculate sodium bisulfite (NaHSO‚ÇÉ) or sulfur dioxide needed to neutralize chlorine residual before discharge. Required at most Texas plants.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="dcl_flow" oninput="calcDCL()" placeholder="1.5">
                        <span class="field-hint">Effluent flow</span>
                    </div>
                    <div>
                        <label>Cl‚ÇÇ Residual (mg/L)</label>
                        <input type="number" inputmode="decimal" id="dcl_cl2" oninput="calcDCL()" placeholder="2.0">
                        <span class="field-hint">Before dechlorination</span>
                    </div>
                    <div>
                        <label>Safety Factor</label>
                        <input type="number" inputmode="decimal" id="dcl_sf" oninput="calcDCL()" placeholder="1.2">
                        <span class="field-hint">Typical: 1.1‚Äì1.5√ó</span>
                    </div>
                </div>
                <div class="example-box"><b>Stoichiometry:</b> 1.0 mg SO‚ÇÇ per 1.0 mg Cl‚ÇÇ | 1.46 mg NaHSO‚ÇÉ per 1.0 mg Cl‚ÇÇ | 0.9 mg Na‚ÇÇSO‚ÇÉ per 1.0 mg Cl‚ÇÇ</div>
                <div class="result-box">
                    <span class="val" id="dcl_res">‚Äî</span>
                    <div id="dcl_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('dcl_res')">Copy Result</button>
                </div>
                <div class="formula-note">SO‚ÇÇ lbs/day = Flow √ó Cl‚ÇÇ √ó 8.34 √ó 1.0 √ó SF | NaHSO‚ÇÉ = √ó 1.46</div>
            </div>
        </div>
    </div>

    <!-- 36. UV Dose -->
    <div class="card" id="card36" data-calc="uv" style="border-left-color: #eab308;">
        <div class="card-header" onclick="toggleCard(36)">
            <h2><span class="card-num" style="background: #eab308;">36</span> UV Dose</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #eab308;">Calculate UV dose from intensity and exposure time. Verify adequate disinfection for permit compliance. UV increasingly replacing chlorine in Texas.</div>
                <div class="grid">
                    <div>
                        <label>UV Intensity (mW/cm¬≤)</label>
                        <input type="number" inputmode="decimal" id="uv_int" oninput="calcUV()" placeholder="40">
                        <span class="field-hint">Measured by UV sensor</span>
                    </div>
                    <div>
                        <label>Exposure Time (sec)</label>
                        <input type="number" inputmode="decimal" id="uv_time" oninput="calcUV()" placeholder="10">
                        <span class="field-hint">Chamber volume √∑ flow rate</span>
                    </div>
                    <div>
                        <label>UV Transmittance (%)</label>
                        <input type="number" inputmode="decimal" id="uv_uvt" oninput="calcUV()" placeholder="65">
                        <span class="field-hint">Lab UVT result</span>
                    </div>
                </div>
                <div class="example-box"><b>Required Doses:</b> E. coli/fecal: 30‚Äì40 mJ/cm¬≤ | TCEQ typical: 30+ mJ/cm¬≤ | Reuse water: 80‚Äì100+ mJ/cm¬≤ | Good UVT: &gt;65%</div>
                <div class="result-box">
                    <span class="val" id="uv_res">0.0 mJ/cm¬≤</span>
                    <div id="uv_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('uv_res')">Copy Result</button>
                </div>
                <div class="formula-note">Dose (mJ/cm¬≤) = Intensity (mW/cm¬≤) √ó Time (sec)</div>
            </div>
        </div>
    </div>

    <!-- ========== SLUDGE & BIOSOLIDS SECTION ========== -->
    <div class="section-header" data-cat="sludge" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(168, 85, 247, 0.15); border-radius: 8px; border-left: 4px solid #a855f7; font-size: 0.85rem; color: #c084fc; font-weight: bold;">üí© Sludge & Biosolids Calculators</div>

    <!-- 37. Sludge Volume & Percent Solids -->
    <div class="card" id="card37" data-calc="sldvol" style="border-left-color: #a855f7;">
        <div class="card-header" onclick="toggleCard(37)">
            <h2><span class="card-num" style="background: #a855f7;">37</span> Sludge Volume & % Solids</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #a855f7;">Convert between wet volume, dry weight, and percent solids. Used daily for hauling, land application, and biosolids reporting.</div>
                <div class="grid">
                    <div>
                        <label>Sludge Volume (gal/day)</label>
                        <input type="number" inputmode="decimal" id="slv_vol" oninput="calcSLV()" placeholder="10000">
                        <span class="field-hint">Wet sludge pumped</span>
                    </div>
                    <div>
                        <label>% Solids</label>
                        <input type="number" inputmode="decimal" id="slv_pct" oninput="calcSLV()" placeholder="3.0">
                        <span class="field-hint">Lab result or estimate</span>
                    </div>
                </div>
                <div class="example-box"><b>Typical:</b> WAS 0.5‚Äì1.5% | Thickened WAS 3‚Äì6% | Belt press cake 15‚Äì25% | Centrifuge cake 20‚Äì30% | 1 gal sludge ‚âà 8.34 lbs</div>
                <div class="result-box">
                    <span class="val" id="slv_res">‚Äî</span>
                    <div id="slv_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('slv_res')">Copy Result</button>
                </div>
                <div class="formula-note">Dry lbs = Volume √ó 8.34 √ó (%Solids √∑ 100) | Dry tons = Dry lbs √∑ 2000</div>
            </div>
        </div>
    </div>

    <!-- 38. Volatile Solids Reduction -->
    <div class="card" id="card38" data-calc="vsr" style="border-left-color: #a855f7;">
        <div class="card-header" onclick="toggleCard(38)">
            <h2><span class="card-num" style="background: #a855f7;">38</span> Volatile Solids Reduction</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #a855f7;">Calculate VS destruction in digesters using Van Kleeck equation. 38% minimum required for Class B biosolids (vector attraction reduction).</div>
                <div class="grid">
                    <div>
                        <label>Influent VS (%)</label>
                        <input type="number" inputmode="decimal" id="vsr_in" oninput="calcVSR()" placeholder="75">
                        <span class="field-hint">Raw sludge volatile fraction</span>
                    </div>
                    <div>
                        <label>Effluent VS (%)</label>
                        <input type="number" inputmode="decimal" id="vsr_out" oninput="calcVSR()" placeholder="55">
                        <span class="field-hint">Digested sludge volatile fraction</span>
                    </div>
                </div>
                <div class="example-box"><b>Van Kleeck:</b> VSR = (VSin ‚àí VSout) √∑ (VSin ‚àí (VSin √ó VSout)) √ó 100 | Class B minimum: 38% | Healthy digester: 50‚Äì60%</div>
                <div class="result-box">
                    <span class="val" id="vsr_res">0.0 %</span>
                    <div id="vsr_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('vsr_res')">Copy Result</button>
                </div>
                <div class="formula-note">VSR = (VSin ‚àí VSout) √∑ [VSin ‚àí (VSin √ó VSout)] √ó 100</div>
            </div>
        </div>
    </div>

    <!-- 39. Digester Loading Rate -->
    <div class="card" id="card39" data-calc="diglr" style="border-left-color: #a855f7;">
        <div class="card-header" onclick="toggleCard(39)">
            <h2><span class="card-num" style="background: #a855f7;">39</span> Digester Loading Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #a855f7;">Calculate volatile solids loading to anaerobic digester. Overloading causes pH drop, VFA buildup, and digester upset ‚Äî common and costly operator mistake.</div>
                <div class="grid">
                    <div>
                        <label>Sludge Flow (GPD)</label>
                        <input type="number" inputmode="decimal" id="dig_flow" oninput="calcDIG()" placeholder="15000">
                        <span class="field-hint">Volume fed to digester</span>
                    </div>
                    <div>
                        <label>% Solids</label>
                        <input type="number" inputmode="decimal" id="dig_pct" oninput="calcDIG()" placeholder="4.0">
                        <span class="field-hint">Feed sludge solids</span>
                    </div>
                    <div>
                        <label>% Volatile</label>
                        <input type="number" inputmode="decimal" id="dig_vs" oninput="calcDIG()" placeholder="72">
                        <span class="field-hint">VS as % of TS</span>
                    </div>
                    <div>
                        <label>Digester Volume (ft¬≥)</label>
                        <input type="number" inputmode="decimal" id="dig_vol" oninput="calcDIG()" placeholder="50000">
                        <span class="field-hint">Active digester volume</span>
                    </div>
                </div>
                <div class="example-box"><b>Loading Limits:</b> Low-rate: 0.03‚Äì0.05 lbs VS/ft¬≥/d | High-rate: 0.10‚Äì0.20 lbs VS/ft¬≥/d | Overloaded: &gt;0.20</div>
                <div class="result-box">
                    <span class="val" id="dig_res">0.00 lbs VS/ft¬≥/d</span>
                    <div id="dig_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('dig_res')">Copy Result</button>
                </div>
                <div class="formula-note">Loading = (Flow √ó 8.34 √ó %Solids √ó %VS) √∑ Digester Volume</div>
            </div>
        </div>
    </div>

    <!-- 40. Polymer Dosing for Dewatering -->
    <div class="card" id="card40" data-calc="poly" style="border-left-color: #a855f7;">
        <div class="card-header" onclick="toggleCard(40)">
            <h2><span class="card-num" style="background: #a855f7;">40</span> Polymer Dosing</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #a855f7;">Calculate active polymer per dry ton of solids for belt press or centrifuge. Polymer is one of the biggest chemical costs at any plant.</div>
                <div class="grid">
                    <div>
                        <label>Sludge Flow (GPM)</label>
                        <input type="number" inputmode="decimal" id="poly_flow" oninput="calcPoly()" placeholder="75">
                        <span class="field-hint">Feed to dewatering unit</span>
                    </div>
                    <div>
                        <label>% Solids</label>
                        <input type="number" inputmode="decimal" id="poly_pct" oninput="calcPoly()" placeholder="3.0">
                        <span class="field-hint">Feed sludge concentration</span>
                    </div>
                    <div>
                        <label>Polymer Solution (GPH)</label>
                        <input type="number" inputmode="decimal" id="poly_rate" oninput="calcPoly()" placeholder="20">
                        <span class="field-hint">Neat or diluted solution fed</span>
                    </div>
                    <div>
                        <label>Polymer Conc (% active)</label>
                        <input type="number" inputmode="decimal" id="poly_conc" oninput="calcPoly()" placeholder="0.5">
                        <span class="field-hint">Active polymer in solution</span>
                    </div>
                </div>
                <div class="example-box"><b>Targets:</b> Belt press: 3‚Äì8 lbs/DT | Centrifuge: 5‚Äì12 lbs/DT | Gravity thickener: 1‚Äì4 lbs/DT | Lower = more cost effective</div>
                <div class="result-box">
                    <span class="val" id="poly_res">‚Äî</span>
                    <div id="poly_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('poly_res')">Copy Result</button>
                </div>
                <div class="formula-note">lbs/DT = (Polymer GPH √ó 8.34 √ó %Active √ó 24) √∑ (Sludge GPM √ó 8.34 √ó %Solids √ó 60 √ó 24 √∑ 2000)</div>
            </div>
        </div>
    </div>

    <!-- ========== NUTRIENT REMOVAL SECTION ========== -->
    <div class="section-header" data-cat="nutrients" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(34, 197, 94, 0.15); border-radius: 8px; border-left: 4px solid #22c55e; font-size: 0.85rem; color: #4ade80; font-weight: bold;">üåø Nutrient Removal Calculators</div>

    <!-- 41. Phosphorus Removal -->
    <div class="card" id="card41" data-calc="phos" style="border-left-color: #22c55e;">
        <div class="card-header" onclick="toggleCard(41)">
            <h2><span class="card-num" style="background: #22c55e;">41</span> Phosphorus Removal</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #22c55e;">Calculate alum or ferric chloride dose for chemical phosphorus precipitation. TCEQ phosphorus limits are tightening across Texas watersheds.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="phos_flow" oninput="calcPhos()" placeholder="1.5">
                        <span class="field-hint">Treatment flow</span>
                    </div>
                    <div>
                        <label>Influent P (mg/L)</label>
                        <input type="number" inputmode="decimal" id="phos_in" oninput="calcPhos()" placeholder="5.0">
                        <span class="field-hint">Total phosphorus in</span>
                    </div>
                    <div>
                        <label>Target Effluent P (mg/L)</label>
                        <input type="number" inputmode="decimal" id="phos_out" oninput="calcPhos()" placeholder="1.0">
                        <span class="field-hint">Permit limit</span>
                    </div>
                    <div>
                        <label>Molar Ratio (Me:P)</label>
                        <input type="number" inputmode="decimal" id="phos_ratio" oninput="calcPhos()" placeholder="2.0">
                        <span class="field-hint">Alum: 1.5‚Äì2.5 | Ferric: 1.5‚Äì3.0</span>
                    </div>
                </div>
                <div class="example-box"><b>Chemical MW:</b> Alum (Al‚ÇÇ(SO‚ÇÑ)‚ÇÉ¬∑14H‚ÇÇO) = 594 | Ferric Chloride (FeCl‚ÇÉ) = 162.2 | P = 31 | Al = 27 | Fe = 55.85</div>
                <div class="result-box">
                    <span class="val" id="phos_res">‚Äî</span>
                    <div id="phos_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('phos_res')">Copy Result</button>
                </div>
                <div class="formula-note">Metal dose = ŒîP √ó Molar Ratio √ó (Metal MW √∑ P MW) | lbs/day = Flow √ó Dose √ó 8.34</div>
            </div>
        </div>
    </div>

    <!-- 42. Alkalinity Consumed by Nitrification -->
    <div class="card" id="card42" data-calc="alk" style="border-left-color: #22c55e;">
        <div class="card-header" onclick="toggleCard(42)">
            <h2><span class="card-num" style="background: #22c55e;">42</span> Alkalinity & Nitrification</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #22c55e;">Calculate alkalinity destroyed by nitrification (7.14 mg alk per mg NH‚ÇÉ-N). Low alkalinity causes nitrification crash and pH drop.</div>
                <div class="grid">
                    <div>
                        <label>Influent Alkalinity (mg/L as CaCO‚ÇÉ)</label>
                        <input type="number" inputmode="decimal" id="alk_in" oninput="calcALK()" placeholder="200">
                        <span class="field-hint">Lab alkalinity result</span>
                    </div>
                    <div>
                        <label>NH‚ÇÉ-N Oxidized (mg/L)</label>
                        <input type="number" inputmode="decimal" id="alk_nh3" oninput="calcALK()" placeholder="25">
                        <span class="field-hint">Influent NH‚ÇÉ ‚àí Effluent NH‚ÇÉ</span>
                    </div>
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="alk_flow" oninput="calcALK()" placeholder="1.5">
                        <span class="field-hint">For lime dosing calc</span>
                    </div>
                </div>
                <div class="example-box"><b>Rule:</b> 7.14 mg alk consumed per 1 mg NH‚ÇÉ-N oxidized | Maintain effluent alk &gt;50 mg/L | Lime adds ~1.35 mg alk per mg lime (as CaCO‚ÇÉ)</div>
                <div class="result-box">
                    <span class="val" id="alk_res">‚Äî</span>
                    <div id="alk_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('alk_res')">Copy Result</button>
                </div>
                <div class="formula-note">Alk consumed = NH‚ÇÉ-N √ó 7.14 | Remaining = Influent ‚àí Consumed</div>
            </div>
        </div>
    </div>

    <!-- 43. Nitrogen Balance -->
    <div class="card" id="card43" data-calc="nbal" style="border-left-color: #22c55e;">
        <div class="card-header" onclick="toggleCard(43)">
            <h2><span class="card-num" style="background: #22c55e;">43</span> Nitrogen Balance</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #22c55e;">Track where nitrogen goes in the treatment process. Essential for TN permit compliance and process optimization.</div>
                <div class="grid">
                    <div>
                        <label>Influent TKN (mg/L)</label>
                        <input type="number" inputmode="decimal" id="nb_tkn" oninput="calcNBal()" placeholder="35">
                        <span class="field-hint">Total Kjeldahl nitrogen in</span>
                    </div>
                    <div>
                        <label>Effluent NH‚ÇÉ-N (mg/L)</label>
                        <input type="number" inputmode="decimal" id="nb_nh3" oninput="calcNBal()" placeholder="1.0">
                        <span class="field-hint">Ammonia in effluent</span>
                    </div>
                    <div>
                        <label>Effluent NO‚ÇÉ-N (mg/L)</label>
                        <input type="number" inputmode="decimal" id="nb_no3" oninput="calcNBal()" placeholder="8.0">
                        <span class="field-hint">Nitrate in effluent</span>
                    </div>
                    <div>
                        <label>Biomass N Uptake (mg/L)</label>
                        <input type="number" inputmode="decimal" id="nb_bio" oninput="calcNBal()" placeholder="2.0">
                        <span class="field-hint">Typically 1‚Äì3 mg/L</span>
                    </div>
                </div>
                <div class="example-box"><b>N Pathways:</b> Nitrification (NH‚ÇÉ‚ÜíNO‚ÇÉ) | Denitrification (NO‚ÇÉ‚ÜíN‚ÇÇ gas) | Biomass uptake | Effluent TN = NH‚ÇÉ + NO‚ÇÉ + Org-N</div>
                <div class="result-box">
                    <span class="val" id="nb_res">‚Äî</span>
                    <div id="nb_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('nb_res')">Copy Result</button>
                </div>
                <div class="formula-note">Denitrified = TKN ‚àí Eff NH‚ÇÉ ‚àí Eff NO‚ÇÉ ‚àí Biomass N</div>
            </div>
        </div>
    </div>

    <!-- ========== HYDRAULICS & PUMPING SECTION ========== -->
    <div class="section-header" data-cat="hydraulics" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(59, 130, 246, 0.15); border-radius: 8px; border-left: 4px solid #3b82f6; font-size: 0.85rem; color: #60a5fa; font-weight: bold;">üíß Hydraulics & Pumping Calculators</div>

    <!-- 44. Pump TDH -->
    <div class="card" id="card44" data-calc="tdh" style="border-left-color: #3b82f6;">
        <div class="card-header" onclick="toggleCard(44)">
            <h2><span class="card-num" style="background: #3b82f6;">44</span> Total Dynamic Head</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #3b82f6;">Calculate total dynamic head from static lift, friction loss, and velocity head. Determines pump operating point and energy requirements.</div>

                <div style="margin-bottom:10px;">
                    <button onclick="document.getElementById('tdh_guide').style.display = document.getElementById('tdh_guide').style.display === 'none' ? 'block' : 'none'; this.innerText = document.getElementById('tdh_guide').style.display === 'none' ? 'üìñ How to Use ‚ñ∏' : 'üìñ How to Use ‚ñæ'" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid #3b82f6;background:rgba(59,130,246,0.08);color:#60a5fa;font-weight:bold;font-size:0.82rem;cursor:pointer;text-align:left;">üìñ How to Use ‚ñ∏</button>
                    <div id="tdh_guide" style="display:none;margin-top:8px;background:#0c1222;border:1px solid #334155;border-radius:8px;padding:14px;font-size:0.8rem;color:#cbd5e1;line-height:1.7;">
                        <div style="color:#60a5fa;font-weight:bold;font-size:0.85rem;margin-bottom:8px;">TOTAL DYNAMIC HEAD ‚Äî OPERATOR GUIDE</div>

                        <div style="color:#f8fafc;font-weight:bold;">What is TDH?</div>
                        TDH is the total pressure a pump must overcome to move water from point A to point B. It's the sum of three components: how high you're pushing it (static head), how much friction the pipe creates (friction loss), and the energy in the moving water (velocity head). TDH determines your pump selection, motor size, and energy cost.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Inputs Explained</div>
                        <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                            <b>Static Head (ft)</b> ‚Äî The vertical distance between the water surface at the pump suction and the discharge point. Measure with a tape or from as-built drawings. If pumping uphill from a wet well at 100 ft elevation to a tank at 130 ft, static head = 30 ft.<br>
                            <b>Friction Loss (ft)</b> ‚Äî Energy lost to pipe wall drag. Depends on pipe diameter, length, material, and flow rate. Use Hazen-Williams tables, Calc #53 (Force Main), or a rule of thumb: 1‚Äì5 ft per 100 ft of pipe for typical WW flows.<br>
                            <b>Velocity Head (ft)</b> ‚Äî Kinetic energy in the moving water. Formula: V¬≤/(2g). At typical WW velocities (3‚Äì8 fps), this is only 0.1‚Äì1.0 ft ‚Äî often negligible but always included on TCEQ exams.
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Why This Matters</div>
                        A pump curve plots flow (GPM) vs head (ft). Your pump operates where the system curve (TDH at various flows) intersects the pump curve. If TDH increases (clogged pipe, higher discharge), flow decreases. If TDH is wrong during design, you get an oversized or undersized pump.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">TCEQ Exam Tips</div>
                        <div style="background:rgba(59,130,246,0.1);border-radius:6px;padding:8px 10px;margin:4px 0;border-left:3px solid #3b82f6;">
                            ‚Ä¢ <b>TDH = Static Head + Friction Loss + Velocity Head</b><br>
                            ‚Ä¢ Velocity head: V¬≤/2g where g = 32.2 ft/s¬≤. At 5 fps: 5¬≤/(2√ó32.2) = 0.39 ft<br>
                            ‚Ä¢ To convert TDH (ft) to PSI: multiply by 0.433<br>
                            ‚Ä¢ Water HP = (Flow GPM √ó TDH ft) √∑ 3960<br>
                            ‚Ä¢ Brake HP = Water HP √∑ pump efficiency (typically 0.60‚Äì0.80)<br>
                            ‚Ä¢ Common trick: they give pressure in PSI ‚Äî convert to ft by dividing by 0.433 (or √ó 2.31)
                        </div>
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>Static Head (ft)</label>
                        <input type="number" inputmode="decimal" id="tdh_static" oninput="calcTDH()" placeholder="25">
                        <span class="field-hint">Elevation difference</span>
                    </div>
                    <div>
                        <label>Friction Loss (ft)</label>
                        <input type="number" inputmode="decimal" id="tdh_friction" oninput="calcTDH()" placeholder="8">
                        <span class="field-hint">Pipe friction + fittings</span>
                    </div>
                    <div>
                        <label>Velocity Head (ft)</label>
                        <input type="number" inputmode="decimal" id="tdh_vel" oninput="calcTDH()" placeholder="2">
                        <span class="field-hint">v¬≤/2g (often small)</span>
                    </div>
                </div>
                <div class="example-box"><b>Typical TDH:</b> Influent lift station: 20‚Äì40 ft | RAS/WAS: 5‚Äì15 ft | Transfer pumps: 10‚Äì30 ft | 1 psi = 2.31 ft head</div>
                <div class="result-box">
                    <span class="val" id="tdh_res">0.0 ft</span>
                    <div id="tdh_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('tdh_res')">Copy Result</button>
                </div>
                <div class="formula-note">TDH = Static Head + Friction Loss + Velocity Head</div>
            </div>
        </div>
    </div>

    <!-- 45. Pipe Velocity -->
    <div class="card" id="card45" data-calc="pipev" style="border-left-color: #3b82f6;">
        <div class="card-header" onclick="toggleCard(45)">
            <h2><span class="card-num" style="background: #3b82f6;">45</span> Pipe Velocity</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #3b82f6;">Calculate flow velocity from flow rate and pipe diameter. Flags settling (&lt;2 fps) and scouring (&gt;10 fps) conditions.</div>
                <div class="grid">
                    <div>
                        <label>Flow (GPM)</label>
                        <input type="number" inputmode="decimal" id="pv_flow" oninput="calcPV()" placeholder="500">
                        <span class="field-hint">Pump or pipe flow</span>
                    </div>
                    <div>
                        <label>Pipe Diameter (inches)</label>
                        <input type="number" inputmode="decimal" id="pv_dia" oninput="calcPV()" placeholder="8">
                        <span class="field-hint">Internal diameter</span>
                    </div>
                </div>
                <div class="example-box"><b>Velocity Targets:</b> Gravity sewer: 2‚Äì10 fps | Force main: 3‚Äì8 fps | Suction pipe: 3‚Äì6 fps | &lt;2 fps = settling | &gt;10 fps = erosion</div>
                <div class="result-box">
                    <span class="val" id="pv_res">0.0 fps</span>
                    <div id="pv_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('pv_res')">Copy Result</button>
                </div>
                <div class="formula-note">V (fps) = Flow (GPM) √ó 0.4085 √∑ Diameter¬≤ (in¬≤)</div>
            </div>
        </div>
    </div>

    <!-- 46. Horsepower -->
    <div class="card" id="card46" data-calc="hp" style="border-left-color: #3b82f6;">
        <div class="card-header" onclick="toggleCard(46)">
            <h2><span class="card-num" style="background: #3b82f6;">46</span> Horsepower (WHP & BHP)</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #3b82f6;">Calculate water horsepower and brake horsepower from flow, head, and pump efficiency. Used for energy costs and pump selection.</div>
                <div class="grid">
                    <div>
                        <label>Flow (GPM)</label>
                        <input type="number" inputmode="decimal" id="hp_flow" oninput="calcHP()" placeholder="500">
                        <span class="field-hint">Pump flow rate</span>
                    </div>
                    <div>
                        <label>TDH (ft)</label>
                        <input type="number" inputmode="decimal" id="hp_tdh" oninput="calcHP()" placeholder="35">
                        <span class="field-hint">Total dynamic head</span>
                    </div>
                    <div>
                        <label>Pump Efficiency (%)</label>
                        <input type="number" inputmode="decimal" id="hp_eff" oninput="calcHP()" placeholder="75">
                        <span class="field-hint">From pump curve: 60‚Äì85%</span>
                    </div>
                    <div>
                        <label>Motor Efficiency (%)</label>
                        <input type="number" inputmode="decimal" id="hp_meff" oninput="calcHP()" placeholder="90">
                        <span class="field-hint">Typical: 85‚Äì95%</span>
                    </div>
                </div>
                <div class="example-box"><b>Formulas:</b> WHP = (Flow √ó TDH) √∑ 3960 | BHP = WHP √∑ Pump Eff | MHP = BHP √∑ Motor Eff | 1 HP = 0.746 kW</div>
                <div class="result-box">
                    <span class="val" id="hp_res">‚Äî</span>
                    <div id="hp_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('hp_res')">Copy Result</button>
                </div>
                <div class="formula-note">WHP = (GPM √ó TDH) √∑ 3960 | BHP = WHP √∑ Efficiency</div>
            </div>
        </div>
    </div>

    <!-- ========== COMPLIANCE & REPORTING SECTION ========== -->
    <div class="section-header" data-cat="compliance" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(249, 115, 22, 0.15); border-radius: 8px; border-left: 4px solid #f97316; font-size: 0.85rem; color: #fb923c; font-weight: bold;">üìã Compliance & Reporting Calculators</div>

    <!-- 47. Geometric Mean -->
    <div class="card" id="card47" data-calc="geomean" style="border-left-color: #f97316;">
        <div class="card-header" onclick="toggleCard(47)">
            <h2><span class="card-num" style="background: #f97316;">47</span> Geometric Mean</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #f97316;">Calculate geometric mean for E. coli or fecal coliform DMR reporting. TCEQ requires geometric mean ‚Äî not arithmetic mean. Operators frequently get this wrong.</div>
                <div class="grid">
                    <div>
                        <label>Sample 1</label>
                        <input type="number" inputmode="decimal" id="gm_s1" oninput="calcGM()" placeholder="50">
                    </div>
                    <div>
                        <label>Sample 2</label>
                        <input type="number" inputmode="decimal" id="gm_s2" oninput="calcGM()" placeholder="120">
                    </div>
                    <div>
                        <label>Sample 3</label>
                        <input type="number" inputmode="decimal" id="gm_s3" oninput="calcGM()" placeholder="30">
                    </div>
                    <div>
                        <label>Sample 4</label>
                        <input type="number" inputmode="decimal" id="gm_s4" oninput="calcGM()" placeholder="">
                        <span class="field-hint">Optional</span>
                    </div>
                    <div>
                        <label>Sample 5</label>
                        <input type="number" inputmode="decimal" id="gm_s5" oninput="calcGM()" placeholder="">
                        <span class="field-hint">Optional</span>
                    </div>
                    <div>
                        <label>Sample 6</label>
                        <input type="number" inputmode="decimal" id="gm_s6" oninput="calcGM()" placeholder="">
                        <span class="field-hint">Optional</span>
                    </div>
                    <div>
                        <label>Sample 7</label>
                        <input type="number" inputmode="decimal" id="gm_s7" oninput="calcGM()" placeholder="">
                        <span class="field-hint">Optional</span>
                    </div>
                </div>
                <div class="example-box"><b>TCEQ Limits:</b> E. coli: 126 CFU/100mL (geomean) / 399 single | Fecal: 200 CFU/100mL (geomean) / 400 single</div>
                <div class="result-box">
                    <span class="val" id="gm_res">‚Äî</span>
                    <div id="gm_status" class="status">Enter at least 2 samples...</div>
                    <button class="btn-copy" onclick="copyVal('gm_res')">Copy Result</button>
                </div>
                <div class="formula-note">Geomean = (S1 √ó S2 √ó ... √ó Sn) ^ (1/n)</div>
            </div>
        </div>
    </div>

    <!-- 48. Flow-Weighted Composite -->
    <div class="card" id="card48" data-calc="fwc" style="border-left-color: #f97316;">
        <div class="card-header" onclick="toggleCard(48)">
            <h2><span class="card-num" style="background: #f97316;">48</span> Flow-Weighted Composite</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #f97316;">Calculate flow-proportional average concentration from grab samples at different flows. Required for accurate DMR reporting at many plants.</div>
                <div class="grid">
                    <div>
                        <label>Flow 1 (MGD)</label>
                        <input type="number" inputmode="decimal" id="fw_f1" oninput="calcFWC()" placeholder="1.2">
                    </div>
                    <div>
                        <label>Conc 1 (mg/L)</label>
                        <input type="number" inputmode="decimal" id="fw_c1" oninput="calcFWC()" placeholder="15">
                    </div>
                    <div>
                        <label>Flow 2 (MGD)</label>
                        <input type="number" inputmode="decimal" id="fw_f2" oninput="calcFWC()" placeholder="1.8">
                    </div>
                    <div>
                        <label>Conc 2 (mg/L)</label>
                        <input type="number" inputmode="decimal" id="fw_c2" oninput="calcFWC()" placeholder="20">
                    </div>
                    <div>
                        <label>Flow 3 (MGD)</label>
                        <input type="number" inputmode="decimal" id="fw_f3" oninput="calcFWC()" placeholder="1.0">
                        <span class="field-hint">Optional</span>
                    </div>
                    <div>
                        <label>Conc 3 (mg/L)</label>
                        <input type="number" inputmode="decimal" id="fw_c3" oninput="calcFWC()" placeholder="12">
                        <span class="field-hint">Optional</span>
                    </div>
                    <div>
                        <label>Flow 4 (MGD)</label>
                        <input type="number" inputmode="decimal" id="fw_f4" oninput="calcFWC()" placeholder="">
                        <span class="field-hint">Optional</span>
                    </div>
                    <div>
                        <label>Conc 4 (mg/L)</label>
                        <input type="number" inputmode="decimal" id="fw_c4" oninput="calcFWC()" placeholder="">
                        <span class="field-hint">Optional</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="fw_res">‚Äî</span>
                    <div id="fw_status" class="status">Enter at least 2 flow-concentration pairs...</div>
                    <button class="btn-copy" onclick="copyVal('fw_res')">Copy Result</button>
                </div>
                <div class="formula-note">FW Avg = Œ£(Flow √ó Conc) √∑ Œ£(Flow)</div>
            </div>
        </div>
    </div>

    <!-- ========== QUICK CONVERSIONS SECTION ========== -->
    <div class="section-header" data-cat="convert" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(148, 163, 184, 0.15); border-radius: 8px; border-left: 4px solid #94a3b8; font-size: 0.85rem; color: #cbd5e1; font-weight: bold;">üîÑ Quick Conversions</div>

    <!-- 49. Unit Converter -->
    <div class="card" id="card49" data-calc="convert" style="border-left-color: #94a3b8;">
        <div class="card-header" onclick="toggleCard(49)">
            <h2><span class="card-num" style="background: #94a3b8;">49</span> Unit Converter</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Enter a value in any field to convert. One-stop conversion for common wastewater units.</div>
                <div style="font-size:0.8rem;color:#94a3b8;margin-bottom:8px;font-weight:bold;">‚îÅ‚îÅ Flow ‚îÅ‚îÅ</div>
                <div class="grid">
                    <div>
                        <label>GPM</label>
                        <input type="number" inputmode="decimal" id="uc_gpm" oninput="calcUC('gpm')" placeholder="GPM">
                    </div>
                    <div>
                        <label>MGD</label>
                        <input type="number" inputmode="decimal" id="uc_mgd" oninput="calcUC('mgd')" placeholder="MGD">
                    </div>
                    <div>
                        <label>CFS</label>
                        <input type="number" inputmode="decimal" id="uc_cfs" oninput="calcUC('cfs')" placeholder="ft¬≥/sec">
                    </div>
                    <div>
                        <label>m¬≥/day</label>
                        <input type="number" inputmode="decimal" id="uc_m3d" oninput="calcUC('m3d')" placeholder="m¬≥/day">
                    </div>
                </div>
                <div style="font-size:0.8rem;color:#94a3b8;margin-bottom:8px;font-weight:bold;">‚îÅ‚îÅ Volume ‚îÅ‚îÅ</div>
                <div class="grid">
                    <div>
                        <label>Gallons</label>
                        <input type="number" inputmode="decimal" id="uc_gal" oninput="calcUC('gal')" placeholder="gal">
                    </div>
                    <div>
                        <label>ft¬≥</label>
                        <input type="number" inputmode="decimal" id="uc_ft3" oninput="calcUC('ft3')" placeholder="ft¬≥">
                    </div>
                    <div>
                        <label>m¬≥</label>
                        <input type="number" inputmode="decimal" id="uc_m3" oninput="calcUC('m3')" placeholder="m¬≥">
                    </div>
                    <div>
                        <label>Acre-ft</label>
                        <input type="number" inputmode="decimal" id="uc_acft" oninput="calcUC('acft')" placeholder="ac-ft">
                    </div>
                </div>
                <div style="font-size:0.8rem;color:#94a3b8;margin-bottom:8px;font-weight:bold;">‚îÅ‚îÅ Pressure ‚îÅ‚îÅ</div>
                <div class="grid">
                    <div>
                        <label>PSI</label>
                        <input type="number" inputmode="decimal" id="uc_psi" oninput="calcUC('psi')" placeholder="psi">
                    </div>
                    <div>
                        <label>ft H‚ÇÇO</label>
                        <input type="number" inputmode="decimal" id="uc_fth2o" oninput="calcUC('fth2o')" placeholder="ft H‚ÇÇO">
                    </div>
                    <div>
                        <label>kPa</label>
                        <input type="number" inputmode="decimal" id="uc_kpa" oninput="calcUC('kpa')" placeholder="kPa">
                    </div>
                </div>
                <div class="result-box">
                    <div id="uc_status" class="status" style="text-align:center;color:#94a3b8;">Enter a value in any field to convert</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== COLLECTION SYSTEMS SECTION ========== -->
    <div class="section-header" data-cat="collection" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(251, 146, 60, 0.15); border-radius: 8px; border-left: 4px solid #fb923c; font-size: 0.85rem; color: #fdba74; font-weight: bold;">üîß Collection Systems Calculators</div>

    <!-- 50. Manning's Equation -->
    <div class="card" id="card50" data-calc="manning" style="border-left-color: #fb923c;">
        <div class="card-header" onclick="toggleCard(50)">
            <h2><span class="card-num" style="background: #fb923c;">50</span> Manning's Equation</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #fb923c;">Calculate gravity sewer flow from pipe slope, diameter, and roughness. The most tested collection system formula on every TCEQ exam level.</div>

                <div style="margin-bottom:10px;">
                    <button onclick="document.getElementById('mann_guide').style.display = document.getElementById('mann_guide').style.display === 'none' ? 'block' : 'none'; this.innerText = document.getElementById('mann_guide').style.display === 'none' ? 'üìñ How to Use ‚ñ∏' : 'üìñ How to Use ‚ñæ'" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid #fb923c;background:rgba(251,146,60,0.08);color:#fdba74;font-weight:bold;font-size:0.82rem;cursor:pointer;text-align:left;">üìñ How to Use ‚ñ∏</button>
                    <div id="mann_guide" style="display:none;margin-top:8px;background:#0c1222;border:1px solid #334155;border-radius:8px;padding:14px;font-size:0.8rem;color:#cbd5e1;line-height:1.7;">
                        <div style="color:#fdba74;font-weight:bold;font-size:0.85rem;margin-bottom:8px;">MANNING'S EQUATION ‚Äî OPERATOR GUIDE</div>

                        <div style="color:#f8fafc;font-weight:bold;">What This Calculates</div>
                        Manning's equation calculates the velocity and flow rate in a gravity sewer pipe flowing full. It's the foundation of collection system design ‚Äî how fast wastewater moves through your pipes and how much they can carry. This is the single most-tested collection system formula on TCEQ exams at every level.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Inputs Explained</div>
                        <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                            <b>Diameter (inches)</b> ‚Äî Inside pipe diameter. Common gravity sewer: 8" (residential lateral), 10‚Äì12" (collector), 15‚Äì24" (trunk), 30"+ (interceptor). Minimum per TCEQ: 8" for public sewers.<br>
                            <b>Slope (ft/ft)</b> ‚Äî Pipe grade as a decimal. Example: 0.5% slope = 0.005 ft/ft. A pipe dropping 1 foot over 200 feet = 1/200 = 0.005. Get from as-builts or survey. TCEQ minimum slopes: 8" pipe = 0.0040, 10" = 0.0028, 12" = 0.0022.<br>
                            <b>Manning's n</b> ‚Äî Roughness coefficient. Lower n = smoother pipe = faster flow. PVC/HDPE: 0.010‚Äì0.013. New concrete: 0.013. Old concrete/clay: 0.013‚Äì0.015. Corrugated metal: 0.022‚Äì0.025. Use 0.013 on TCEQ exams unless told otherwise.
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Understanding Velocity Flags</div>
                        <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                            <b style="color:#4ade80;">2‚Äì10 fps: Good range</b> ‚Äî Self-cleansing velocity without pipe damage.<br>
                            <b style="color:#fbbf24;">&lt;2 fps: Too slow</b> ‚Äî Solids settle out ‚Üí blockages, H‚ÇÇS generation, odors. Increase slope or decrease pipe size to raise velocity.<br>
                            <b style="color:#ef4444;">&gt;10 fps: Too fast</b> ‚Äî Pipe erosion, joint damage, manhole erosion. Use drop manholes or energy dissipation. Some agencies allow up to 15 fps with reinforced pipe.
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">TCEQ Exam Tips</div>
                        <div style="background:rgba(251,146,60,0.1);border-radius:6px;padding:8px 10px;margin:4px 0;border-left:3px solid #fb923c;">
                            ‚Ä¢ <b>V = (1.486/n) √ó R^(2/3) √ó S^(1/2)</b> ‚Äî memorize this<br>
                            ‚Ä¢ For a full pipe: R (hydraulic radius) = D/4 (diameter in feet √∑ 4)<br>
                            ‚Ä¢ Q = V √ó A ‚Äî flow = velocity √ó cross-sectional area<br>
                            ‚Ä¢ Area of circle: A = œÄ √ó r¬≤ = œÄ/4 √ó D¬≤ (D in feet!)<br>
                            ‚Ä¢ <b>Unit trap:</b> Diameter is almost always given in inches ‚Äî convert to feet first (√∑ 12)<br>
                            ‚Ä¢ <b>Minimum velocity:</b> 2.0 fps (self-cleansing). They love asking this.<br>
                            ‚Ä¢ <b>Default n:</b> Use 0.013 unless the problem specifies otherwise<br>
                            ‚Ä¢ To convert CFS to GPM: √ó 448.83 | To MGD: √ó 0.6463
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Example</div>
                        <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                            12" pipe at 0.5% slope (0.005 ft/ft), n=0.013:<br>
                            R = (12/12)/4 = 0.25 ft<br>
                            V = (1.486/0.013) √ó 0.25^0.667 √ó 0.005^0.5 = 114.3 √ó 0.397 √ó 0.0707 = <b>3.21 fps</b> ‚úì<br>
                            A = œÄ/4 √ó 1¬≤ = 0.785 ft¬≤<br>
                            Q = 3.21 √ó 0.785 = 2.52 CFS = <b>1,131 GPM</b>
                        </div>
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>Pipe Diameter (inches)</label>
                        <input type="number" inputmode="decimal" id="man_dia" oninput="calcManning()" placeholder="12">
                        <span class="field-hint">Internal diameter</span>
                    </div>
                    <div>
                        <label>Slope (ft/ft)</label>
                        <input type="number" inputmode="decimal" id="man_slope" oninput="calcManning()" placeholder="0.005">
                        <span class="field-hint">Rise √∑ Run (e.g. 0.005)</span>
                    </div>
                    <div>
                        <label>Manning's n</label>
                        <input type="number" inputmode="decimal" id="man_n" oninput="calcManning()" placeholder="0.013">
                        <span class="field-hint">PVC: 0.010 | Concrete: 0.013</span>
                    </div>
                </div>
                <div class="example-box"><b>n values:</b> PVC/HDPE: 0.010 | New concrete: 0.012 | Old concrete: 0.013‚Äì0.015 | Clay/VCP: 0.013 | Corrugated metal: 0.024</div>
                <div class="result-box">
                    <span class="val" id="man_res">‚Äî</span>
                    <div id="man_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('man_res')">Copy Result</button>
                </div>
                <div class="formula-note">V = (1.486/n) √ó R^(2/3) √ó S^(1/2) | Q = V √ó A | Full pipe: R = D/4</div>
            </div>
        </div>
    </div>

    <!-- 51. Wet Well Sizing -->
    <div class="card" id="card51" data-calc="wetwell" style="border-left-color: #fb923c;">
        <div class="card-header" onclick="toggleCard(51)">
            <h2><span class="card-num" style="background: #fb923c;">51</span> Wet Well Sizing</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #fb923c;">Calculate required wet well volume from pump capacity and cycle time. Undersized wet wells cause short-cycling and premature pump failure.</div>
                <div class="grid">
                    <div>
                        <label>Pump Capacity (GPM)</label>
                        <input type="number" inputmode="decimal" id="ww_pump" oninput="calcWetWell()" placeholder="500">
                        <span class="field-hint">Single pump flow rate</span>
                    </div>
                    <div>
                        <label>Inflow Rate (GPM)</label>
                        <input type="number" inputmode="decimal" id="ww_inflow" oninput="calcWetWell()" placeholder="200">
                        <span class="field-hint">Average incoming flow</span>
                    </div>
                    <div>
                        <label>Min Cycle Time (min)</label>
                        <input type="number" inputmode="decimal" id="ww_cycle" oninput="calcWetWell()" placeholder="10">
                        <span class="field-hint">Typical: 10‚Äì15 min minimum</span>
                    </div>
                </div>
                <div class="example-box"><b>Design Rules:</b> Min cycle = 10 min (most manufacturers) | V = T √ó Q_pump √∑ 4 (for constant speed) | Short cycling wears seals, overheats motors</div>
                <div class="result-box">
                    <span class="val" id="ww_res">‚Äî</span>
                    <div id="ww_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('ww_res')">Copy Result</button>
                </div>
                <div class="formula-note">V = (T √ó Q_pump) √∑ 4 | Fill time = V √∑ Inflow | Pump-down = V √∑ (Pump ‚àí Inflow)</div>
            </div>
        </div>
    </div>

    <!-- 52. Infiltration & Inflow -->
    <div class="card" id="card52" data-calc="ii" style="border-left-color: #fb923c;">
        <div class="card-header" onclick="toggleCard(52)">
            <h2><span class="card-num" style="background: #fb923c;">52</span> Infiltration & Inflow (I/I)</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #fb923c;">Calculate infiltration/inflow rate from dry vs wet weather flow. Expressed as GPD per inch-diameter per mile. TCEQ exam staple and major compliance issue in aging Texas systems.</div>
                <div class="grid">
                    <div>
                        <label>Wet Weather Flow (GPD)</label>
                        <input type="number" inputmode="decimal" id="ii_wet" oninput="calcII()" placeholder="750000">
                        <span class="field-hint">Peak wet weather daily flow</span>
                    </div>
                    <div>
                        <label>Dry Weather Flow (GPD)</label>
                        <input type="number" inputmode="decimal" id="ii_dry" oninput="calcII()" placeholder="500000">
                        <span class="field-hint">Average dry weather flow</span>
                    </div>
                    <div>
                        <label>Pipe Diameter (inches)</label>
                        <input type="number" inputmode="decimal" id="ii_dia" oninput="calcII()" placeholder="8">
                        <span class="field-hint">Sewer pipe diameter</span>
                    </div>
                    <div>
                        <label>Pipe Length (miles)</label>
                        <input type="number" inputmode="decimal" id="ii_miles" oninput="calcII()" placeholder="5">
                        <span class="field-hint">Collection system length</span>
                    </div>
                </div>
                <div class="example-box"><b>I/I Limits:</b> TCEQ concern: &gt;500 GPD/inch-mile | Excessive: &gt;1,000 | Typical target: &lt;500 GPD/inch-mile</div>
                <div class="result-box">
                    <span class="val" id="ii_res">‚Äî</span>
                    <div id="ii_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('ii_res')">Copy Result</button>
                </div>
                <div class="formula-note">I/I = (Wet ‚àí Dry) √∑ (Diameter √ó Miles) GPD/inch-mile</div>
            </div>
        </div>
    </div>

    <!-- 53. Force Main Friction Loss -->
    <div class="card" id="card53" data-calc="hazen" style="border-left-color: #fb923c;">
        <div class="card-header" onclick="toggleCard(53)">
            <h2><span class="card-num" style="background: #fb923c;">53</span> Force Main Friction Loss</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #fb923c;">Hazen-Williams headloss in pressure pipes. Feeds directly into TDH calc (#44). Every lift station design uses this.</div>
                <div class="grid">
                    <div>
                        <label>Flow (GPM)</label>
                        <input type="number" inputmode="decimal" id="hz_flow" oninput="calcHazen()" placeholder="500">
                        <span class="field-hint">Pump flow rate</span>
                    </div>
                    <div>
                        <label>C-Factor</label>
                        <input type="number" inputmode="decimal" id="hz_c" oninput="calcHazen()" placeholder="120">
                        <span class="field-hint">PVC: 150 | DI: 130 | Old CI: 100</span>
                    </div>
                    <div>
                        <label>Pipe Diameter (inches)</label>
                        <input type="number" inputmode="decimal" id="hz_dia" oninput="calcHazen()" placeholder="8">
                        <span class="field-hint">Internal diameter</span>
                    </div>
                    <div>
                        <label>Pipe Length (ft)</label>
                        <input type="number" inputmode="decimal" id="hz_len" oninput="calcHazen()" placeholder="2000">
                        <span class="field-hint">Total force main length</span>
                    </div>
                </div>
                <div class="example-box"><b>C values:</b> New PVC/HDPE: 150 | New DI: 130 | Old cast iron: 100 | Concrete: 120 | Add 10‚Äì15% for fittings</div>
                <div class="result-box">
                    <span class="val" id="hz_res">‚Äî</span>
                    <div id="hz_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('hz_res')">Copy Result</button>
                </div>
                <div class="formula-note">hf = (4.52 √ó Q^1.85) √∑ (C^1.85 √ó D^4.87) √ó L (ft per 100ft √ó length)</div>
            </div>
        </div>
    </div>

    <!-- ========== FLOW MEASUREMENT SECTION ========== -->
    <div class="section-header" data-cat="flow" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(56, 189, 248, 0.15); border-radius: 8px; border-left: 4px solid #38bdf8; font-size: 0.85rem; color: #7dd3fc; font-weight: bold;">üìè Flow Measurement Calculators</div>

    <!-- 54. Weir Flow -->
    <div class="card" id="card54" data-calc="weir" style="border-left-color: #38bdf8;">
        <div class="card-header" onclick="toggleCard(54)">
            <h2><span class="card-num" style="background: #38bdf8;">54</span> Weir Flow</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #38bdf8;">Calculate flow over rectangular, V-notch (90¬∞), or Cipolletti weirs. On every single TCEQ exam at every level.</div>
                <div class="grid">
                    <div>
                        <label>Weir Type</label>
                        <select id="weir_type" oninput="calcWeir()" style="width:100%;padding:10px;border-radius:6px;border:1px solid #475569;background:#0f172a;color:#f8fafc;font-size:0.95rem;">
                            <option value="rect">Rectangular (no contractions)</option>
                            <option value="rect_c">Rectangular (contracted)</option>
                            <option value="vnot">V-Notch 90¬∞</option>
                            <option value="cip">Cipolletti (trapezoidal)</option>
                        </select>
                    </div>
                    <div>
                        <label>Head over Weir (ft)</label>
                        <input type="number" inputmode="decimal" id="weir_h" oninput="calcWeir()" placeholder="0.5">
                        <span class="field-hint">Measured upstream of weir</span>
                    </div>
                    <div>
                        <label>Weir Length (ft)</label>
                        <input type="number" inputmode="decimal" id="weir_l" oninput="calcWeir()" placeholder="3.0">
                        <span class="field-hint">Not needed for V-notch</span>
                    </div>
                </div>
                <div class="example-box"><b>Formulas:</b> Rect: Q = 3.33 √ó L √ó H^1.5 | V-notch 90¬∞: Q = 2.5 √ó H^2.5 | Cipolletti: Q = 3.367 √ó L √ó H^1.5 | Q in CFS</div>
                <div class="result-box">
                    <span class="val" id="weir_res">‚Äî</span>
                    <div id="weir_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('weir_res')">Copy Result</button>
                </div>
                <div class="formula-note">Suppressed rect: Q = 3.33LH^1.5 | Contracted: Q = 3.33(L‚àí0.2H)H^1.5</div>
            </div>
        </div>
    </div>

    <!-- 55. Area-Velocity Flow -->
    <div class="card" id="card55" data-calc="areavel" style="border-left-color: #38bdf8;">
        <div class="card-header" onclick="toggleCard(55)">
            <h2><span class="card-num" style="background: #38bdf8;">55</span> Area-Velocity Flow</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #38bdf8;">Q = A √ó V for open channels and pipes. Used for field flow verification with portable meters. Tested constantly on TCEQ exams.</div>
                <div class="grid">
                    <div>
                        <label>Channel Type</label>
                        <select id="av_type" oninput="calcAV()" style="width:100%;padding:10px;border-radius:6px;border:1px solid #475569;background:#0f172a;color:#f8fafc;font-size:0.95rem;">
                            <option value="pipe">Circular Pipe (full)</option>
                            <option value="rect">Rectangular Channel</option>
                        </select>
                    </div>
                    <div>
                        <label>Velocity (fps)</label>
                        <input type="number" inputmode="decimal" id="av_vel" oninput="calcAV()" placeholder="3.0">
                        <span class="field-hint">Measured or calculated</span>
                    </div>
                    <div>
                        <label>Diameter (in) or Width (ft)</label>
                        <input type="number" inputmode="decimal" id="av_dim1" oninput="calcAV()" placeholder="12">
                        <span class="field-hint">Pipe dia (in) or channel width (ft)</span>
                    </div>
                    <div>
                        <label>Depth (ft) ‚Äî rect only</label>
                        <input type="number" inputmode="decimal" id="av_dim2" oninput="calcAV()" placeholder="2.0">
                        <span class="field-hint">Water depth in channel</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="av_res">‚Äî</span>
                    <div id="av_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('av_res')">Copy Result</button>
                </div>
                <div class="formula-note">Q (CFS) = Area (ft¬≤) √ó Velocity (fps) | GPM = CFS √ó 448.83</div>
            </div>
        </div>
    </div>

    <!-- ========== TRICKLING FILTER SECTION ========== -->
    <div class="section-header" data-cat="tf" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(132, 204, 22, 0.15); border-radius: 8px; border-left: 4px solid #84cc16; font-size: 0.85rem; color: #a3e635; font-weight: bold;">ü™® Trickling Filter Calculators</div>

    <!-- 56. TF Efficiency (NRC) -->
    <div class="card" id="card56" data-calc="nrc" style="border-left-color: #84cc16;">
        <div class="card-header" onclick="toggleCard(56)">
            <h2><span class="card-num" style="background: #84cc16;">56</span> TF Efficiency (NRC)</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #84cc16;">National Research Council equation for single-stage trickling filter BOD removal. Guaranteed TCEQ exam question at Class B and above.</div>

                <div style="margin-bottom:10px;">
                    <button onclick="document.getElementById('nrc_guide').style.display = document.getElementById('nrc_guide').style.display === 'none' ? 'block' : 'none'; this.innerText = document.getElementById('nrc_guide').style.display === 'none' ? 'üìñ How to Use ‚ñ∏' : 'üìñ How to Use ‚ñæ'" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid #84cc16;background:rgba(132,204,22,0.08);color:#a3e635;font-weight:bold;font-size:0.82rem;cursor:pointer;text-align:left;">üìñ How to Use ‚ñ∏</button>
                    <div id="nrc_guide" style="display:none;margin-top:8px;background:#0c1222;border:1px solid #334155;border-radius:8px;padding:14px;font-size:0.8rem;color:#cbd5e1;line-height:1.7;">
                        <div style="color:#a3e635;font-weight:bold;font-size:0.85rem;margin-bottom:8px;">NRC TRICKLING FILTER EFFICIENCY ‚Äî OPERATOR GUIDE</div>

                        <div style="color:#f8fafc;font-weight:bold;">What This Calculates</div>
                        The NRC (National Research Council) equation predicts BOD removal efficiency for a trickling filter based on organic loading and recirculation. It was developed from WWII-era military installations and is still the standard design equation used by TCEQ. This is a guaranteed exam question at Class B and above.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Inputs Explained</div>
                        <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                            <b>Flow (MGD)</b> ‚Äî Average daily influent flow to the trickling filter (not including recirculation).<br>
                            <b>Influent BOD (mg/L)</b> ‚Äî BOD concentration entering the TF. If there's a primary clarifier upstream, use the primary effluent BOD (typically 60% of raw = ~120 mg/L).<br>
                            <b>Filter Volume (1000 ft¬≥)</b> ‚Äî Total media volume in thousands of cubic feet. A 60 ft diameter √ó 6 ft deep TF = œÄ/4 √ó 60¬≤ √ó 6 = 16,965 ft¬≥ = 16.965 (enter 16.965). Use Calc #63 for circular volume.<br>
                            <b>Recirculation Ratio (R)</b> ‚Äî Recirculated flow √∑ influent flow. R=0 means no recirculation. R=1 means recirculating equal to influent (2√ó total flow over the TF). Typical: 0.5‚Äì2.0.
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">How the NRC Equation Works</div>
                        The equation has two parts:<br>
                        1. <b>W/(V√óF)</b> ‚Äî BOD load applied vs filter capacity. W = lbs BOD/day, V = volume in 1000 ft¬≥, F = recirculation factor.<br>
                        2. <b>Recirculation factor F = (1+R)¬≤ / (1+0.1R)¬≤</b> ‚Äî Recirculation improves efficiency by giving organics multiple passes through the biofilm.<br>
                        Higher recirculation ‚Üí higher F ‚Üí lower W/(VF) ‚Üí higher efficiency.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">TCEQ Exam Tips</div>
                        <div style="background:rgba(132,204,22,0.1);border-radius:6px;padding:8px 10px;margin:4px 0;border-left:3px solid #84cc16;">
                            ‚Ä¢ <b>E = 1 / [1 + 0.4432 √ó ‚àö(W/(V√óF))]</b><br>
                            ‚Ä¢ <b>W = Flow (MGD) √ó BOD (mg/L) √ó 8.34</b> = lbs BOD/day<br>
                            ‚Ä¢ <b>F = (1+R)¬≤ / (1+0.1R)¬≤</b> ‚Äî recirculation factor<br>
                            ‚Ä¢ Volume is in <i>thousands</i> of ft¬≥ ‚Äî don't forget to divide by 1000<br>
                            ‚Ä¢ Typical efficiency: 65‚Äì85%. Below 65% means the filter is overloaded or media is clogged<br>
                            ‚Ä¢ If they ask "what is the effluent BOD?" ‚Üí Effluent = Influent √ó (1 ‚àí E)<br>
                            ‚Ä¢ Common trick: giving you diameter and depth instead of volume ‚Äî calculate V = œÄ/4 √ó D¬≤ √ó depth first
                        </div>
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>BOD Load (lbs/day)</label>
                        <input type="number" inputmode="decimal" id="nrc_bod" oninput="calcNRC()" placeholder="500">
                        <span class="field-hint">Applied BOD to filter</span>
                    </div>
                    <div>
                        <label>Filter Volume (1000 ft¬≥)</label>
                        <input type="number" inputmode="decimal" id="nrc_vol" oninput="calcNRC()" placeholder="20">
                        <span class="field-hint">In thousands of ft¬≥</span>
                    </div>
                    <div>
                        <label>Recirculation Ratio</label>
                        <input type="number" inputmode="decimal" id="nrc_recirc" oninput="calcNRC()" placeholder="1.0">
                        <span class="field-hint">R = recirc flow √∑ influent flow</span>
                    </div>
                </div>
                <div class="example-box"><b>NRC:</b> E = 1 √∑ [1 + 0.4432 √ó ‚àö(W/VF)] | F = (1+R) √∑ (1+0.1R)¬≤ | W = BOD lbs/day | V = 1000 ft¬≥ | Typical: 65‚Äì85% removal</div>
                <div class="result-box">
                    <span class="val" id="nrc_res">‚Äî</span>
                    <div id="nrc_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('nrc_res')">Copy Result</button>
                </div>
                <div class="formula-note">E = 1 √∑ [1 + 0.4432 √ó ‚àö(W √∑ (V √ó F))] √ó 100</div>
            </div>
        </div>
    </div>

    <!-- 57. TF Hydraulic Loading -->
    <div class="card" id="card57" data-calc="tflr" style="border-left-color: #84cc16;">
        <div class="card-header" onclick="toggleCard(57)">
            <h2><span class="card-num" style="background: #84cc16;">57</span> TF Hydraulic Loading</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #84cc16;">GPD/ft¬≤ applied to filter surface. Determines filter classification: low-rate, standard, high-rate, super-high-rate.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="tfl_flow" oninput="calcTFL()" placeholder="1.0">
                        <span class="field-hint">Including recirculation</span>
                    </div>
                    <div>
                        <label>Filter Diameter (ft)</label>
                        <input type="number" inputmode="decimal" id="tfl_dia" oninput="calcTFL()" placeholder="60">
                        <span class="field-hint">Circular filter</span>
                    </div>
                    <div>
                        <label>Influent BOD (mg/L)</label>
                        <input type="number" inputmode="decimal" id="tfl_bod" oninput="calcTFL()" placeholder="150">
                        <span class="field-hint">For organic loading check</span>
                    </div>
                    <div>
                        <label>Filter Depth (ft)</label>
                        <input type="number" inputmode="decimal" id="tfl_depth" oninput="calcTFL()" placeholder="6">
                        <span class="field-hint">Media depth</span>
                    </div>
                </div>
                <div class="example-box"><b>Classifications:</b> Low-rate: 25‚Äì100 GPD/ft¬≤ | Standard: 100‚Äì300 | High-rate: 300‚Äì1000 | Super-high: 1000‚Äì2000</div>
                <div class="result-box">
                    <span class="val" id="tfl_res">‚Äî</span>
                    <div id="tfl_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('tfl_res')">Copy Result</button>
                </div>
                <div class="formula-note">Hyd Load = Flow (GPD) √∑ Filter Area (ft¬≤) | Org Load = BOD lbs/day √∑ Volume (1000 ft¬≥)</div>
            </div>
        </div>
    </div>

    <!-- ========== LAGOONS SECTION ========== -->
    <div class="section-header" data-cat="lagoon" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(45, 212, 191, 0.15); border-radius: 8px; border-left: 4px solid #2dd4bf; font-size: 0.85rem; color: #5eead4; font-weight: bold;">üåä Lagoon & Pond Calculators</div>

    <!-- 58. Pond BOD Loading -->
    <div class="card" id="card58" data-calc="pond" style="border-left-color: #2dd4bf;">
        <div class="card-header" onclick="toggleCard(58)">
            <h2><span class="card-num" style="background: #2dd4bf;">58</span> Pond BOD Loading</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #2dd4bf;">Calculate lbs BOD/acre/day for waste stabilization ponds. Primary design parameter. Overloading causes odor complaints and TCEQ violations.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="pnd_flow" oninput="calcPond()" placeholder="0.5">
                        <span class="field-hint">Average daily flow</span>
                    </div>
                    <div>
                        <label>BOD (mg/L)</label>
                        <input type="number" inputmode="decimal" id="pnd_bod" oninput="calcPond()" placeholder="200">
                        <span class="field-hint">Influent BOD</span>
                    </div>
                    <div>
                        <label>Pond Area (acres)</label>
                        <input type="number" inputmode="decimal" id="pnd_acres" oninput="calcPond()" placeholder="20">
                        <span class="field-hint">Water surface area</span>
                    </div>
                    <div>
                        <label>Pond Depth (ft)</label>
                        <input type="number" inputmode="decimal" id="pnd_depth" oninput="calcPond()" placeholder="5">
                        <span class="field-hint">Average operating depth</span>
                    </div>
                </div>
                <div class="example-box"><b>Texas Limits:</b> Facultative: 35‚Äì50 lbs BOD/acre/day | Aerated: 50‚Äì200+ | HRT: 90‚Äì180 days typical | Depth: 3‚Äì8 ft</div>
                <div class="result-box">
                    <span class="val" id="pnd_res">‚Äî</span>
                    <div id="pnd_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('pnd_res')">Copy Result</button>
                </div>
                <div class="formula-note">Loading = (Flow √ó BOD √ó 8.34) √∑ Acres | HRT = (Acres √ó 43,560 √ó Depth √ó 7.48) √∑ (Flow √ó 1,000,000)</div>
            </div>
        </div>
    </div>

    <!-- ========== AERATION SECTION ========== -->
    <div class="section-header" data-cat="aeration" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(129, 140, 248, 0.15); border-radius: 8px; border-left: 4px solid #818cf8; font-size: 0.85rem; color: #a5b4fc; font-weight: bold;">üí® Aeration Calculators</div>

    <!-- 59. SOTR to AOTR -->
    <div class="card" id="card59" data-calc="aotr" style="border-left-color: #818cf8;">
        <div class="card-header" onclick="toggleCard(59)">
            <h2><span class="card-num" style="background: #818cf8;">59</span> SOTR ‚Üí AOTR</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #818cf8;">Convert manufacturer's Standard Oxygen Transfer Rate to Actual conditions using alpha, beta, temperature, altitude, and operating DO. This is how you actually size blowers.</div>

                <div style="margin-bottom:10px;">
                    <button onclick="document.getElementById('aotr_guide').style.display = document.getElementById('aotr_guide').style.display === 'none' ? 'block' : 'none'; this.innerText = document.getElementById('aotr_guide').style.display === 'none' ? 'üìñ How to Use ‚ñ∏' : 'üìñ How to Use ‚ñæ'" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid #818cf8;background:rgba(129,140,248,0.08);color:#a5b4fc;font-weight:bold;font-size:0.82rem;cursor:pointer;text-align:left;">üìñ How to Use ‚ñ∏</button>
                    <div id="aotr_guide" style="display:none;margin-top:8px;background:#0c1222;border:1px solid #334155;border-radius:8px;padding:14px;font-size:0.8rem;color:#cbd5e1;line-height:1.7;">
                        <div style="color:#a5b4fc;font-weight:bold;font-size:0.85rem;margin-bottom:8px;">SOTR TO AOTR ‚Äî OPERATOR GUIDE</div>

                        <div style="color:#f8fafc;font-weight:bold;">Why This Conversion Matters</div>
                        Manufacturers rate their aeration equipment under <b>standard conditions</b>: clean water, 20¬∞C, zero DO, sea level. Your plant operates in wastewater at a different temperature, with dissolved solids, at some DO setpoint, and possibly at altitude. The AOTR (Actual Oxygen Transfer Rate) is always <i>lower</i> than SOTR ‚Äî often 40‚Äì60% of the manufacturer's number. If you size blowers using SOTR, you'll be undersized.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Inputs Explained</div>
                        <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                            <b>SOTR (lbs O‚ÇÇ/hr)</b> ‚Äî From the manufacturer's spec sheet or performance test. This is the clean-water rating.<br>
                            <b>Alpha (Œ±)</b> ‚Äî Wastewater correction factor. Accounts for surfactants and contaminants that reduce O‚ÇÇ transfer. Range: 0.4‚Äì0.8. Use 0.5 for fine bubble diffusers in typical municipal WW, 0.6‚Äì0.8 for coarse bubble. Lower Œ± = dirtier wastewater.<br>
                            <b>Beta (Œ≤)</b> ‚Äî Salinity/dissolved solids correction. Reduces O‚ÇÇ saturation. Range: 0.90‚Äì0.98. Use 0.95 for typical municipal. Lower for industrial/saline waste.<br>
                            <b>Temperature (¬∞C)</b> ‚Äî Mixed liquor temperature. Higher temp = less dissolved O‚ÇÇ capacity but faster biological rates. Houston summer: 28‚Äì32¬∞C. Winter: 15‚Äì18¬∞C.<br>
                            <b>Operating DO (mg/L)</b> ‚Äî Your basin DO setpoint. Typical CAS: 2.0 mg/L. MBR: 1.0‚Äì2.0. Nitrification: ‚â•2.0. Higher DO = less driving force = less transfer.<br>
                            <b>Altitude (ft)</b> ‚Äî Elevation above sea level. Higher altitude = lower atmospheric pressure = lower O‚ÇÇ saturation. Houston: ~50 ft (negligible). Denver: 5,280 ft (significant correction).
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Reading the Results</div>
                        The <b>AOTR/SOTR ratio</b> tells you what fraction of the manufacturer's rating you actually get. Typical: 30‚Äì60%. If your ratio is below 30%, double-check your alpha and temperature ‚Äî something may be wrong with your wastewater characteristics or you have an industrial slug.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">TCEQ Exam Tips</div>
                        <div style="background:rgba(129,140,248,0.1);border-radius:6px;padding:8px 10px;margin:4px 0;border-left:3px solid #818cf8;">
                            ‚Ä¢ <b>AOTR = SOTR √ó Œ± √ó [(Œ≤ √ó Cs_T ‚àí DO) / Cs_20] √ó Œ∏^(T‚àí20)</b><br>
                            ‚Ä¢ Œ∏ (theta) = 1.024 ‚Äî temperature correction constant. Memorize this.<br>
                            ‚Ä¢ Cs_20 = 9.09 mg/L (O‚ÇÇ saturation at 20¬∞C, sea level)<br>
                            ‚Ä¢ Œ± always makes AOTR smaller (Œ± &lt; 1)<br>
                            ‚Ä¢ Higher operating DO ‚Üí smaller driving force ‚Üí less transfer<br>
                            ‚Ä¢ This calc feeds directly into Blower Air Requirement (Calc #65)
                        </div>
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>SOTR (lbs O‚ÇÇ/hr)</label>
                        <input type="number" inputmode="decimal" id="ao_sotr" oninput="calcAOTR()" placeholder="100">
                        <span class="field-hint">From manufacturer specs</span>
                    </div>
                    <div>
                        <label>Alpha (Œ±)</label>
                        <input type="number" inputmode="decimal" id="ao_alpha" oninput="calcAOTR()" placeholder="0.6">
                        <span class="field-hint">Wastewater factor: 0.4‚Äì0.8</span>
                    </div>
                    <div>
                        <label>Beta (Œ≤)</label>
                        <input type="number" inputmode="decimal" id="ao_beta" oninput="calcAOTR()" placeholder="0.95">
                        <span class="field-hint">Salinity factor: 0.90‚Äì0.98</span>
                    </div>
                    <div>
                        <label>Temperature (¬∞C)</label>
                        <input type="number" inputmode="decimal" id="ao_temp" oninput="calcAOTR()" placeholder="25">
                        <span class="field-hint">Wastewater temperature</span>
                    </div>
                    <div>
                        <label>Operating DO (mg/L)</label>
                        <input type="number" inputmode="decimal" id="ao_do" oninput="calcAOTR()" placeholder="2.0">
                        <span class="field-hint">Target basin DO</span>
                    </div>
                    <div>
                        <label>Altitude (ft)</label>
                        <input type="number" inputmode="decimal" id="ao_alt" oninput="calcAOTR()" placeholder="50">
                        <span class="field-hint">Houston ‚âà 50 ft</span>
                    </div>
                </div>
                <div class="example-box"><b>Corrections:</b> Œ±: fine bubble 0.5‚Äì0.7, coarse 0.6‚Äì0.9 | Œ≤: municipal 0.95‚Äì0.98, industrial 0.80‚Äì0.95 | CS at 20¬∞C = 9.09 mg/L</div>
                <div class="result-box">
                    <span class="val" id="ao_res">‚Äî</span>
                    <div id="ao_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('ao_res')">Copy Result</button>
                </div>
                <div class="formula-note">AOTR = SOTR √ó Œ± √ó [(Œ≤ √ó CS_alt √ó Œ∏^(T-20) ‚àí DO) √∑ CS_20] | Œ∏ = 1.024</div>
            </div>
        </div>
    </div>

    <!-- ========== RECEIVING WATER SECTION ========== -->
    <div class="section-header" data-cat="receiving" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(236, 72, 153, 0.15); border-radius: 8px; border-left: 4px solid #ec4899; font-size: 0.85rem; color: #f472b6; font-weight: bold;">üåä Receiving Water / Discharge</div>

    <!-- 60. Dilution / Mixing Zone -->
    <div class="card" id="card60" data-calc="dilute" style="border-left-color: #ec4899;">
        <div class="card-header" onclick="toggleCard(60)">
            <h2><span class="card-num" style="background: #ec4899;">60</span> Dilution / Mixing Zone</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #ec4899;">Calculate downstream concentration from effluent and stream mixing. Used for TPDES permit compliance and in-stream standards verification.</div>
                <div class="grid">
                    <div>
                        <label>Effluent Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="dil_eflow" oninput="calcDilute()" placeholder="2.0">
                        <span class="field-hint">Discharge flow</span>
                    </div>
                    <div>
                        <label>Effluent Conc (mg/L)</label>
                        <input type="number" inputmode="decimal" id="dil_econc" oninput="calcDilute()" placeholder="15">
                        <span class="field-hint">Effluent parameter value</span>
                    </div>
                    <div>
                        <label>Stream Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="dil_sflow" oninput="calcDilute()" placeholder="20">
                        <span class="field-hint">Upstream flow (7Q2 for permit)</span>
                    </div>
                    <div>
                        <label>Upstream Conc (mg/L)</label>
                        <input type="number" inputmode="decimal" id="dil_sconc" oninput="calcDilute()" placeholder="2.0">
                        <span class="field-hint">Background concentration</span>
                    </div>
                </div>
                <div class="example-box"><b>TPDES:</b> Use 7Q2 (lowest 7-day avg with 2-yr return) for critical low flow | Dilution ratio = Stream flow √∑ Effluent flow</div>
                <div class="result-box">
                    <span class="val" id="dil_res">‚Äî</span>
                    <div id="dil_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('dil_res')">Copy Result</button>
                </div>
                <div class="formula-note">C_mix = (Q_eff √ó C_eff + Q_stream √ó C_stream) √∑ (Q_eff + Q_stream)</div>
            </div>
        </div>
    </div>

    <!-- ========== POPULATION & DESIGN SECTION ========== -->
    <div class="section-header" data-cat="population" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(217, 70, 239, 0.15); border-radius: 8px; border-left: 4px solid #d946ef; font-size: 0.85rem; color: #e879f9; font-weight: bold;">üë• Population & Design</div>

    <!-- 61. Population Equivalent -->
    <div class="card" id="card61" data-calc="popeq" style="border-left-color: #d946ef;">
        <div class="card-header" onclick="toggleCard(61)">
            <h2><span class="card-num" style="background: #d946ef;">61</span> Population Equivalent</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #d946ef;">Comprehensive PE analysis: flow, BOD, TSS, and TKN population equivalents with per-capita comparison, industrial load detection, EDU conversion, peaking factor design, capacity projections, and TCEQ-ready reporting summary.</div>

                <!-- How to Use Toggle -->
                <div style="margin-bottom:10px;">
                    <button onclick="document.getElementById('pe_guide').style.display = document.getElementById('pe_guide').style.display === 'none' ? 'block' : 'none'; this.innerText = document.getElementById('pe_guide').style.display === 'none' ? 'üìñ How to Use This Calculator ‚ñ∏' : 'üìñ How to Use This Calculator ‚ñæ'" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid #d946ef;background:rgba(217,70,239,0.08);color:#e879f9;font-weight:bold;font-size:0.82rem;cursor:pointer;text-align:left;">üìñ How to Use This Calculator ‚ñ∏</button>
                    <div id="pe_guide" style="display:none;margin-top:8px;background:#0c1222;border:1px solid #334155;border-radius:8px;padding:14px;font-size:0.8rem;color:#cbd5e1;line-height:1.7;">
                        <div style="color:#e879f9;font-weight:bold;font-size:0.85rem;margin-bottom:8px;">üìñ POPULATION EQUIVALENT ‚Äî OPERATOR GUIDE</div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">What is Population Equivalent (PE)?</div>
                        PE converts plant loading into an equivalent number of people producing that wastewater. It tells you how big your plant's workload is in human terms ‚Äî even if your actual population is different. A PE higher than your actual population means you have industrial or commercial contributors.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:12px;">Step 1 ‚Äî Enter Plant Loading (minimum: Flow)</div>
                        <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                            <b>Flow (MGD)</b> ‚Äî Your average daily flow from the plant flowmeter. Use the monthly average from your DMR, not a single day's reading.<br>
                            <b>BOD (mg/L)</b> ‚Äî Influent BOD‚ÇÖ from your composite sampler. Use your monthly average.<br>
                            <b>TSS (mg/L)</b> ‚Äî Influent TSS from composite. Typical domestic: 200‚Äì250 mg/L.<br>
                            <b>TKN (mg/L)</b> ‚Äî Total Kjeldahl Nitrogen (ammonia + organic N). Typical domestic: 30‚Äì40 mg/L. Leave blank if you don't monitor TKN.
                        </div>
                        <span style="color:#94a3b8;font-size:0.75rem;">üí° The more parameters you enter, the more complete your analysis. Flow alone gives a basic PE; all four gives a full characterization.</span>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:12px;">Step 2 ‚Äî Enter Service Area Info (optional but powerful)</div>
                        <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                            <b>Actual Population</b> ‚Äî Number of people your system serves. Get this from your utility's billing records or census data. This unlocks per-capita comparison bars showing if your system matches expected loading.<br>
                            <b>Permitted Flow (MGD)</b> ‚Äî Your TPDES permit's maximum daily average flow. Found on page 1 of your permit. This unlocks the capacity analysis with TCEQ 75% trigger tracking.<br>
                            <b>Growth Rate (%)</b> ‚Äî Annual population growth for your service area. Check your city's comprehensive plan or TWDB data. Typical Texas suburban: 2‚Äì5%/yr. This projects when you'll hit capacity milestones.<br>
                            <b>Peaking Factor</b> ‚Äî Ratio of peak hourly flow to average daily flow. Small systems (&lt;1,000 pop): 3.5‚Äì4.0. Medium (10,000): 2.0‚Äì2.5. Large (100,000+): 1.5‚Äì2.0. This sizes your wet weather capacity.
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:12px;">Understanding Your Results</div>

                        <div style="margin:6px 0 3px;color:#d946ef;font-weight:bold;">‚ñ∏ PE Comparison Gauges</div>
                        Four horizontal bars showing PE from each parameter. The highest one is your <b>Governing PE</b> ‚Äî this is the one TCEQ cares about. If BOD PE is much higher than Flow PE, you likely have industrial discharge adding organic load without proportional flow.

                        <div style="margin:8px 0 3px;color:#d946ef;font-weight:bold;">‚ñ∏ EDU (Equivalent Dwelling Units)</div>
                        Governing PE √∑ 3.5 people per household. This is the number developers and planners use for impact fees and capacity allocation. If a developer wants to connect 200 new homes, that's ~700 PE of new load.

                        <div style="margin:8px 0 3px;color:#d946ef;font-weight:bold;">‚ñ∏ Industrial vs Domestic Split</div>
                        A stacked bar estimating how much of your BOD load comes from industrial/commercial sources vs. residential. If your system is >15% industrial, you may need a pretreatment program (40 CFR 403).

                        <div style="margin:8px 0 3px;color:#d946ef;font-weight:bold;">‚ñ∏ Wastewater Ratios</div>
                        <b>BOD:TSS</b> ‚Äî Normal domestic is 0.7‚Äì1.2. Above 1.2 = high organic strength (food processing?). Below 0.7 = high inert solids (construction I/I?).<br>
                        <b>TKN:BOD</b> ‚Äî Normal domestic is 0.12‚Äì0.25. Above 0.25 = nitrogen-rich (septic hauling, food waste). Below 0.12 = industrial dilution.

                        <div style="margin:8px 0 3px;color:#d946ef;font-weight:bold;">‚ñ∏ Per Capita Loading Bars</div>
                        Compares your actual per-person loading against national standards. The vertical line is the standard. <span style="color:#4ade80;">Green</span> = near standard. <span style="color:#fbbf24;">Yellow</span> = elevated (industrial contributor?). <span style="color:#3b82f6;">Blue</span> = below standard (I/I dilution?).

                        <div style="margin:8px 0 3px;color:#d946ef;font-weight:bold;">‚ñ∏ Capacity Analysis</div>
                        Shows current utilization against your TPDES permit. TCEQ requires a <b>capacity planning report when you hit 75%</b> of permitted flow (30 TAC ¬ß217.33). The bar marks 75% and 90% milestones. Red = you need to act now.

                        <div style="margin:8px 0 3px;color:#d946ef;font-weight:bold;">‚ñ∏ Growth Timeline</div>
                        Visual projection showing <i>when</i> your plant hits 75%, 90%, and 100% of permitted capacity based on growth rate. The projection table below shows flow, capacity %, and population at 5, 10, and 20 years. Use this for CIP budgeting and expansion planning.

                        <div style="margin:8px 0 3px;color:#d946ef;font-weight:bold;">‚ñ∏ TCEQ Report Summary</div>
                        A monospace text block formatted for direct copy-paste into capacity planning reports, engineering memos, or TCEQ submittals. Click <b>"Copy TCEQ Report Summary"</b> to put it on your clipboard.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:14px;">TCEQ Exam Tips</div>
                        <div style="background:rgba(217,70,239,0.1);border-radius:6px;padding:8px 10px;margin:4px 0;border-left:3px solid #d946ef;">
                            ‚Ä¢ <b>Memorize:</b> 100 GPD/person, 0.17 lbs BOD/person/day, 8.34 lbs/gal conversion<br>
                            ‚Ä¢ <b>Formula:</b> PE = (Flow MGD √ó BOD mg/L √ó 8.34) √∑ 0.17<br>
                            ‚Ä¢ <b>Shortcut:</b> At 200 mg/L BOD and 100 GPD/cap, both methods give the same PE<br>
                            ‚Ä¢ <b>Watch for:</b> Questions that give you flow in GPD vs MGD ‚Äî don't double-convert<br>
                            ‚Ä¢ <b>Trick question:</b> If PE from BOD >> PE from flow, the answer is "industrial contribution"<br>
                            ‚Ä¢ <b>75% rule:</b> TCEQ requires planning report at 75% of permitted capacity
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:14px;">Real-World Example</div>
                        <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                            <b>Scenario:</b> Your plant treats 1.5 MGD with 200 mg/L BOD, 220 mg/L TSS, serving 15,000 people. Permit = 2.0 MGD. Growth = 3%/yr.<br><br>
                            <b>Enter:</b> Flow: 1.5 | BOD: 200 | TSS: 220 | Pop: 15000 | Permit: 2.0 | Growth: 3.0<br><br>
                            <b>Result:</b> Flow PE = 15,000 | BOD PE = 14,706 | TSS PE = 13,761 ‚Üí Governing: Flow at 15,000 PE. Balanced domestic character. At 75% capacity. TCEQ planning report required. At 3% growth, you'll hit 100% in ~10 years.
                        </div>
                    </div>
                </div>
                <div style="font-size:0.8rem;color:#e879f9;margin-bottom:8px;font-weight:bold;">&#9473;&#9473; Plant Loading &#9473;&#9473;</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="pe_flow" oninput="calcPE()" placeholder="1.5">
                        <span class="field-hint">Average daily flow</span>
                    </div>
                    <div>
                        <label>Influent BOD (mg/L)</label>
                        <input type="number" inputmode="decimal" id="pe_bod" oninput="calcPE()" placeholder="200">
                        <span class="field-hint">Influent BOD5</span>
                    </div>
                    <div>
                        <label>Influent TSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="pe_tss" oninput="calcPE()" placeholder="220">
                        <span class="field-hint">Total suspended solids</span>
                    </div>
                    <div>
                        <label>Influent TKN (mg/L)</label>
                        <input type="number" inputmode="decimal" id="pe_tkn" oninput="calcPE()" placeholder="35">
                        <span class="field-hint">Total Kjeldahl nitrogen</span>
                    </div>
                </div>
                <div style="font-size:0.8rem;color:#e879f9;margin:12px 0 8px;font-weight:bold;">&#9473;&#9473; Service Area &#9473;&#9473;</div>
                <div class="grid">
                    <div>
                        <label>Actual Population</label>
                        <input type="number" inputmode="decimal" id="pe_pop" oninput="calcPE()" placeholder="15000">
                        <span class="field-hint">Current served population</span>
                    </div>
                    <div>
                        <label>Permitted Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="pe_permit" oninput="calcPE()" placeholder="2.0">
                        <span class="field-hint">TCEQ permitted capacity</span>
                    </div>
                    <div>
                        <label>Annual Growth Rate (%)</label>
                        <input type="number" inputmode="decimal" id="pe_growth" oninput="calcPE()" placeholder="3.0">
                        <span class="field-hint">Population growth rate</span>
                    </div>
                    <div>
                        <label>Peaking Factor</label>
                        <input type="number" inputmode="decimal" id="pe_peak" oninput="calcPE()" placeholder="2.5">
                        <span class="field-hint">Peak:Avg ratio (2.0-4.0 typical)</span>
                    </div>
                </div>
                <div class="example-box"><b>Per Capita Standards:</b> Flow: 100 GPD | BOD: 0.17 lbs/day | TSS: 0.20 lbs/day | TKN: 0.03 lbs/day | EDU: 3.5 persons/unit | Peaking: 2.0-4.0 (smaller systems peak higher)</div>
                <div class="result-box">
                    <span class="val" id="pe_res">&mdash;</span>
                    <div id="pe_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('pe_res')">Copy Result</button>
                </div>
                <div id="pe_report" style="display:none; margin-top:10px; background:#0c1222; border:1px solid #334155; border-radius:8px; padding:12px; font-size:0.78rem; color:#cbd5e1; white-space:pre-line; line-height:1.5; font-family:monospace;"></div>
                <button id="pe_report_btn" style="display:none; margin-top:6px; width:100%; padding:10px; border-radius:6px; border:1px solid #d946ef; background:rgba(217,70,239,0.1); color:#e879f9; font-weight:bold; font-size:0.85rem; cursor:pointer;" onclick="copyPEReport()">&#128203; Copy TCEQ Report Summary</button>
                <div class="formula-note">PE(flow) = GPD / 100 | PE(BOD) = lbs BOD / 0.17 | PE(TSS) = lbs TSS / 0.20 | PE(TKN) = lbs TKN / 0.03 | EDU = PE / 3.5</div>
            </div>
        </div>
    </div>

    <!-- ========== FLOW MEASUREMENT (continued) ========== -->
    <div class="section-header" data-cat="flow" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(56, 189, 248, 0.15); border-radius: 8px; border-left: 4px solid #38bdf8; font-size: 0.85rem; color: #7dd3fc; font-weight: bold;">üìè Flow Measurement (continued)</div>

    <!-- 62. Parshall Flume -->
    <div class="card" id="card62" data-calc="parshall" style="border-left-color: #38bdf8;">
        <div class="card-header" onclick="toggleCard(62)">
            <h2><span class="card-num" style="background: #38bdf8;">62</span> Parshall Flume</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #38bdf8;">Calculate flow through a Parshall flume from throat width and upstream head (Ha). Standard flow measurement device in wastewater ‚Äî on every TCEQ exam. Supports free-flow and submerged correction.</div>

                <div style="margin-bottom:10px;">
                    <button onclick="document.getElementById('flume_guide').style.display = document.getElementById('flume_guide').style.display === 'none' ? 'block' : 'none'; this.innerText = document.getElementById('flume_guide').style.display === 'none' ? 'üìñ How to Use ‚ñ∏' : 'üìñ How to Use ‚ñæ'" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid #38bdf8;background:rgba(56,189,248,0.08);color:#7dd3fc;font-weight:bold;font-size:0.82rem;cursor:pointer;text-align:left;">üìñ How to Use ‚ñ∏</button>
                    <div id="flume_guide" style="display:none;margin-top:8px;background:#0c1222;border:1px solid #334155;border-radius:8px;padding:14px;font-size:0.8rem;color:#cbd5e1;line-height:1.7;">
                        <div style="color:#7dd3fc;font-weight:bold;font-size:0.85rem;margin-bottom:8px;">PARSHALL FLUME ‚Äî OPERATOR GUIDE</div>

                        <div style="color:#f8fafc;font-weight:bold;">What This Calculates</div>
                        A Parshall flume is a specially shaped open-channel flow measurement structure. Water accelerates through a narrowed throat section, and the upstream water level (Ha) directly correlates to flow rate. You read Ha from a staff gauge or ultrasonic sensor, and this calculator converts that reading to GPM/MGD.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Inputs Explained</div>
                        <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                            <b>Throat Width</b> ‚Äî The narrowest section of the flume. This is a fixed dimension ‚Äî stamped on the flume nameplate or in your O&amp;M manual. Common WW sizes: 6"‚Äì24" for small plants, 3'‚Äì8' for large plants.<br>
                            <b>Ha (Upstream Head)</b> ‚Äî Water level measured at the Ha stilling well, located 2/3 of the way back from the throat in the converging section. Read in <b>feet</b> from the flume floor (not from the channel floor). This is your primary measurement ‚Äî accuracy here is everything.<br>
                            <b>Hb (Downstream Head)</b> ‚Äî Optional. Measured in the diverging section downstream of the throat. Only needed to check for submergence. If Hb/Ha exceeds the submergence limit, the standard equation is invalid and a correction factor must be applied.
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Free-Flow vs Submerged</div>
                        <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                            <b style="color:#4ade80;">Free-flow</b> ‚Äî Water drops through the throat freely. Ha alone determines flow. This is normal operation.<br>
                            <b style="color:#ef4444;">Submerged</b> ‚Äî Downstream water backs up into the throat. Occurs when Hb/Ha exceeds the limit (0.60 for large flumes, 0.70 for &gt;12"). Submergence means your flow reading is <i>too high</i>. Fix: clear downstream blockages, check for debris, or apply submergence correction tables.
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">TCEQ Exam Tips</div>
                        <div style="background:rgba(56,189,248,0.1);border-radius:6px;padding:8px 10px;margin:4px 0;border-left:3px solid #38bdf8;">
                            ‚Ä¢ <b>Q = C √ó Ha^n</b> ‚Äî C and n depend on throat width<br>
                            ‚Ä¢ They'll give you Ha and throat width ‚Äî plug into the equation<br>
                            ‚Ä¢ Ha is measured in <b>feet</b> ‚Äî watch for questions giving inches<br>
                            ‚Ä¢ Free-flow only needs Ha. Submerged needs both Ha and Hb<br>
                            ‚Ä¢ Most common exam flume sizes: 6", 9", 12"<br>
                            ‚Ä¢ A Parshall flume has a CONVERGING section, THROAT, and DIVERGING section<br>
                            ‚Ä¢ Unlike a weir, a Parshall flume is self-cleaning (no upstream sediment buildup)
                        </div>
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>Throat Width</label>
                        <select id="pf_width" oninput="calcParshall()" style="width:100%;padding:10px;border-radius:6px;border:1px solid #475569;background:#0f172a;color:#f8fafc;font-size:0.95rem;">
                            <option value="3">3 inches</option>
                            <option value="6">6 inches</option>
                            <option value="9">9 inches</option>
                            <option value="12" selected>12 inches (1 ft)</option>
                            <option value="18">18 inches (1.5 ft)</option>
                            <option value="24">24 inches (2 ft)</option>
                            <option value="36">36 inches (3 ft)</option>
                            <option value="48">48 inches (4 ft)</option>
                            <option value="60">60 inches (5 ft)</option>
                            <option value="72">72 inches (6 ft)</option>
                            <option value="96">96 inches (8 ft)</option>
                        </select>
                        <span class="field-hint">Standard Parshall throat sizes</span>
                    </div>
                    <div>
                        <label>Ha ‚Äî Upstream Head (ft)</label>
                        <input type="number" inputmode="decimal" id="pf_ha" oninput="calcParshall()" placeholder="1.0">
                        <span class="field-hint">Measured at 2/3 A from throat</span>
                    </div>
                    <div>
                        <label>Hb ‚Äî Downstream Head (ft)</label>
                        <input type="number" inputmode="decimal" id="pf_hb" oninput="calcParshall()" placeholder="">
                        <span class="field-hint">Optional ‚Äî for submergence check</span>
                    </div>
                </div>
                <div class="example-box"><b>Free-flow formula:</b> Q = C √ó Ha^n (CFS) | C and n vary by throat width | Submerged when Hb/Ha &gt; 0.70 (small) or &gt; 0.60 (large) ‚Äî correction required</div>
                <div class="result-box">
                    <span class="val" id="pf_res">‚Äî</span>
                    <div id="pf_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('pf_res')">Copy Result</button>
                </div>
                <div class="formula-note">Q (CFS) = C √ó Ha^n | GPM = CFS √ó 448.83 | MGD = GPM √ó 0.00144</div>
            </div>
        </div>
    </div>

    <!-- ========== TANK GEOMETRY ========== -->
    <div class="section-header" data-cat="tank" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(251, 191, 36, 0.15); border-radius: 8px; border-left: 4px solid #fbbf24; font-size: 0.85rem; color: #fcd34d; font-weight: bold;">üìê Tank Geometry</div>

    <!-- 63. Tank Volume Calculator -->
    <div class="card" id="card63" data-calc="tankvol" style="border-left-color: #fbbf24;">
        <div class="card-header" onclick="toggleCard(63)">
            <h2><span class="card-num" style="background: #fbbf24; color: #0f172a;">63</span> Tank Volume</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #fbbf24;">Calculate volume for circular, rectangular, and cone-bottom tanks in gallons, ft¬≥, and m¬≥. The most-used field calculator ‚Äî feeds every volume-based calc in the app.</div>

                <div style="margin-bottom:10px;">
                    <button onclick="document.getElementById('tank_guide').style.display = document.getElementById('tank_guide').style.display === 'none' ? 'block' : 'none'; this.innerText = document.getElementById('tank_guide').style.display === 'none' ? 'üìñ How to Use ‚ñ∏' : 'üìñ How to Use ‚ñæ'" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid #fbbf24;background:rgba(251,191,36,0.08);color:#fcd34d;font-weight:bold;font-size:0.82rem;cursor:pointer;text-align:left;">üìñ How to Use ‚ñ∏</button>
                    <div id="tank_guide" style="display:none;margin-top:8px;background:#0c1222;border:1px solid #334155;border-radius:8px;padding:14px;font-size:0.8rem;color:#cbd5e1;line-height:1.7;">
                        <div style="color:#fcd34d;font-weight:bold;font-size:0.85rem;margin-bottom:8px;">TANK VOLUME ‚Äî OPERATOR GUIDE</div>

                        <div style="color:#f8fafc;font-weight:bold;">Why You Need This</div>
                        Tank volume is the starting input for HRT, SRT, F:M, chemical dosing, and pump-down time. If you don't know your tank volume, you can't calculate anything else. This calculator handles every common WW tank geometry and gives you conversions in every unit you'll need.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Choosing the Right Shape</div>
                        <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                            <b>Circular</b> ‚Äî Clarifiers, digesters, SBR basins, equalization tanks. Enter the <i>inside</i> diameter and water depth (SWD).<br>
                            <b>Rectangular</b> ‚Äî Aeration basins, chlorine contact chambers, grit channels. Enter length, width, and water depth.<br>
                            <b>Cone-Bottom</b> ‚Äî Gravity thickeners, clarifier sludge hoppers, some digesters. Enter diameter, straight sidewall depth, PLUS the cone depth. The calculator adds cylinder + cone volumes.
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Tips for Accurate Measurements</div>
                        Use <b>sidewall depth (SWD)</b> ‚Äî the actual water depth, not the tank wall height. SWD is usually 1‚Äì3 feet less than wall height due to freeboard. For cone-bottom tanks, measure cone depth separately from the straight-wall portion. Get dimensions from as-built drawings when possible ‚Äî field tape measurements are less accurate for large tanks.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">TCEQ Exam Tips</div>
                        <div style="background:rgba(251,191,36,0.1);border-radius:6px;padding:8px 10px;margin:4px 0;border-left:3px solid #fbbf24;">
                            ‚Ä¢ <b>Memorize:</b> 1 ft¬≥ = 7.48 gallons. This shows up constantly.<br>
                            ‚Ä¢ Circle area = œÄ √ó r¬≤ = 0.785 √ó D¬≤ (they love 0.785)<br>
                            ‚Ä¢ Rectangle volume = L √ó W √ó D (easy)<br>
                            ‚Ä¢ Cone volume = (œÄ/3) √ó r¬≤ √ó h (1/3 of a cylinder)<br>
                            ‚Ä¢ To get from gallons to MG: √∑ 1,000,000<br>
                            ‚Ä¢ Common trap: giving diameter in inches. Always convert to feet first.<br>
                            ‚Ä¢ Common trap: asking for gallons but giving dimensions that naturally give ft¬≥
                        </div>
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>Tank Shape</label>
                        <select id="tv_shape" oninput="calcTankVol()" style="width:100%;padding:10px;border-radius:6px;border:1px solid #475569;background:#0f172a;color:#f8fafc;font-size:0.95rem;">
                            <option value="circ">Circular (diameter + depth)</option>
                            <option value="rect">Rectangular (L √ó W √ó D)</option>
                            <option value="cone">Cone-Bottom Circular</option>
                        </select>
                        <span class="field-hint">Select tank geometry</span>
                    </div>
                    <div>
                        <label>Diameter / Length (ft)</label>
                        <input type="number" inputmode="decimal" id="tv_dim1" oninput="calcTankVol()" placeholder="40">
                        <span class="field-hint">Diameter (circ/cone) or Length (rect)</span>
                    </div>
                    <div>
                        <label>Width (ft) ‚Äî rect only</label>
                        <input type="number" inputmode="decimal" id="tv_dim2" oninput="calcTankVol()" placeholder="20">
                        <span class="field-hint">Leave blank for circular</span>
                    </div>
                    <div>
                        <label>Sidewall Depth (ft)</label>
                        <input type="number" inputmode="decimal" id="tv_depth" oninput="calcTankVol()" placeholder="15">
                        <span class="field-hint">Water depth (SWD)</span>
                    </div>
                    <div>
                        <label>Cone Depth (ft) ‚Äî cone only</label>
                        <input type="number" inputmode="decimal" id="tv_cone" oninput="calcTankVol()" placeholder="4">
                        <span class="field-hint">Depth of cone section</span>
                    </div>
                </div>
                <div class="example-box"><b>Conversions:</b> 1 ft¬≥ = 7.48 gal | 1 m¬≥ = 264.17 gal | Circle area = œÄ √ó r¬≤ | Cone vol = œÄ/3 √ó r¬≤ √ó h</div>
                <div class="result-box">
                    <span class="val" id="tv_res">‚Äî</span>
                    <div id="tv_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('tv_res')">Copy Result</button>
                </div>
                <div class="formula-note">Circ: V = œÄ √ó r¬≤ √ó d | Rect: V = L √ó W √ó D | Cone: V = (œÄ/3) √ó r¬≤ √ó h | gal = ft¬≥ √ó 7.48</div>
            </div>
        </div>
    </div>

    <!-- ========== LAGOONS (continued) ========== -->
    <div class="section-header" data-cat="lagoon" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(45, 212, 191, 0.15); border-radius: 8px; border-left: 4px solid #2dd4bf; font-size: 0.85rem; color: #5eead4; font-weight: bold;">üåä Lagoon & Pond (continued)</div>

    <!-- 64. Pond HRT -->
    <div class="card" id="card64" data-calc="pondhrt" style="border-left-color: #2dd4bf;">
        <div class="card-header" onclick="toggleCard(64)">
            <h2><span class="card-num" style="background: #2dd4bf;">64</span> Pond Detention Time</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #2dd4bf;">Calculate actual hydraulic retention time accounting for sludge accumulation reducing effective volume. Ponds lose 5‚Äì15% of volume per decade from sludge buildup ‚Äî your actual HRT may be much shorter than design.</div>

                <div style="margin-bottom:10px;">
                    <button onclick="document.getElementById('phrt_guide').style.display = document.getElementById('phrt_guide').style.display === 'none' ? 'block' : 'none'; this.innerText = document.getElementById('phrt_guide').style.display === 'none' ? 'üìñ How to Use ‚ñ∏' : 'üìñ How to Use ‚ñæ'" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid #2dd4bf;background:rgba(45,212,191,0.08);color:#5eead4;font-weight:bold;font-size:0.82rem;cursor:pointer;text-align:left;">üìñ How to Use ‚ñ∏</button>
                    <div id="phrt_guide" style="display:none;margin-top:8px;background:#0c1222;border:1px solid #334155;border-radius:8px;padding:14px;font-size:0.8rem;color:#cbd5e1;line-height:1.7;">
                        <div style="color:#5eead4;font-weight:bold;font-size:0.85rem;margin-bottom:8px;">POND DETENTION TIME ‚Äî OPERATOR GUIDE</div>

                        <div style="color:#f8fafc;font-weight:bold;">Why Sludge Depth Matters</div>
                        Every lagoon accumulates sludge on the bottom ‚Äî dead algae, settled solids, and inorganic grit. A pond designed for 5 ft depth with 1.5 ft of sludge only has 3.5 ft of effective water. That's 30% less volume, 30% less HRT, and 30% less treatment. Many lagoon permit violations are caused by operators not knowing their actual sludge depth.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Inputs Explained</div>
                        <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                            <b>Pond Area (acres)</b> ‚Äî Water surface area. Get from as-builts, aerial imagery, or measure the dike-to-dike dimensions and subtract for slope.<br>
                            <b>Design Depth (ft)</b> ‚Äî Original operating depth from design documents. Typical: 3‚Äì5 ft (facultative), 8‚Äì15 ft (aerated).<br>
                            <b>Sludge Depth (ft)</b> ‚Äî Measure with a sludge judge or core sampler at multiple points and average. If unknown, assume 0.5‚Äì1.0 ft per decade of operation. Enter 0 for a new or recently dredged pond.<br>
                            <b>Flow (MGD)</b> ‚Äî Average daily influent flow. Use your monthly DMR average.<br>
                            <b>Number of Cells</b> ‚Äî Ponds in series. A 3-cell system has better plug-flow behavior than a single cell, meaning less short-circuiting and more effective HRT.
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Short-Circuiting</div>
                        The <b>actual effective HRT</b> is always less than the calculated HRT because water doesn't flow uniformly through the pond ‚Äî it short-circuits from inlet to outlet. A single-cell pond may only use ~30% of its volume effectively. Adding baffles or cells in series dramatically improves performance.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">TCEQ Exam Tips</div>
                        <div style="background:rgba(45,212,191,0.1);border-radius:6px;padding:8px 10px;margin:4px 0;border-left:3px solid #2dd4bf;">
                            ‚Ä¢ <b>HRT (days) = Volume (gal) √∑ Flow (GPD)</b><br>
                            ‚Ä¢ Volume = Acres √ó 43,560 ft¬≤/acre √ó Depth (ft) √ó 7.48 gal/ft¬≥<br>
                            ‚Ä¢ Facultative pond design HRT: 90‚Äì180 days<br>
                            ‚Ä¢ Aerated lagoon HRT: 3‚Äì20 days<br>
                            ‚Ä¢ Polishing/maturation pond: 10‚Äì30 days<br>
                            ‚Ä¢ 1 acre-foot = 43,560 ft¬≥ = 325,851 gallons<br>
                            ‚Ä¢ Questions may give volume in acre-feet ‚Äî multiply by 325,851 for gallons
                        </div>
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>Pond Area (acres)</label>
                        <input type="number" inputmode="decimal" id="hrt_acres" oninput="calcPondHRT()" placeholder="20">
                        <span class="field-hint">Water surface area</span>
                    </div>
                    <div>
                        <label>Design Depth (ft)</label>
                        <input type="number" inputmode="decimal" id="hrt_depth" oninput="calcPondHRT()" placeholder="5">
                        <span class="field-hint">Original operating depth</span>
                    </div>
                    <div>
                        <label>Sludge Depth (ft)</label>
                        <input type="number" inputmode="decimal" id="hrt_sludge" oninput="calcPondHRT()" placeholder="1.5">
                        <span class="field-hint">Accumulated sludge (0 if new)</span>
                    </div>
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="hrt_flow" oninput="calcPondHRT()" placeholder="0.5">
                        <span class="field-hint">Average daily flow</span>
                    </div>
                    <div>
                        <label>Number of Cells</label>
                        <input type="number" inputmode="decimal" id="hrt_cells" oninput="calcPondHRT()" placeholder="3">
                        <span class="field-hint">Ponds in series</span>
                    </div>
                </div>
                <div class="example-box"><b>Design targets:</b> Facultative: 90‚Äì180 days | Aerated: 3‚Äì20 days | Polishing: 10‚Äì30 days | Short-circuiting reduces effective HRT by 30‚Äì50% in single-cell systems</div>
                <div class="result-box">
                    <span class="val" id="hrt_res">‚Äî</span>
                    <div id="hrt_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('hrt_res')">Copy Result</button>
                </div>
                <div class="formula-note">HRT = Volume (gal) √∑ Flow (GPD) | Vol = Acres √ó 43,560 √ó Effective Depth √ó 7.48</div>
            </div>
        </div>
    </div>

    <!-- ========== AERATION (continued) ========== -->
    <div class="section-header" data-cat="aeration" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(129, 140, 248, 0.15); border-radius: 8px; border-left: 4px solid #818cf8; font-size: 0.85rem; color: #a5b4fc; font-weight: bold;">üí® Aeration (continued)</div>

    <!-- 65. Blower Air Requirement -->
    <div class="card" id="card65" data-calc="blower" style="border-left-color: #818cf8;">
        <div class="card-header" onclick="toggleCard(65)">
            <h2><span class="card-num" style="background: #818cf8;">65</span> Blower Air Requirement</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #818cf8;">Calculate required SCFM from oxygen demand, basin depth, and transfer efficiency. Connects your AOTR (Calc #59) to actual blower sizing. Aeration = 50‚Äì65% of plant energy cost.</div>

                <div style="margin-bottom:10px;">
                    <button onclick="document.getElementById('blow_guide').style.display = document.getElementById('blow_guide').style.display === 'none' ? 'block' : 'none'; this.innerText = document.getElementById('blow_guide').style.display === 'none' ? 'üìñ How to Use ‚ñ∏' : 'üìñ How to Use ‚ñæ'" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid #818cf8;background:rgba(129,140,248,0.08);color:#a5b4fc;font-weight:bold;font-size:0.82rem;cursor:pointer;text-align:left;">üìñ How to Use ‚ñ∏</button>
                    <div id="blow_guide" style="display:none;margin-top:8px;background:#0c1222;border:1px solid #334155;border-radius:8px;padding:14px;font-size:0.8rem;color:#cbd5e1;line-height:1.7;">
                        <div style="color:#a5b4fc;font-weight:bold;font-size:0.85rem;margin-bottom:8px;">BLOWER AIR REQUIREMENT ‚Äî OPERATOR GUIDE</div>

                        <div style="color:#f8fafc;font-weight:bold;">What This Calculates</div>
                        This converts your oxygen demand (lbs O‚ÇÇ/hr) into the actual volume of air your blowers need to deliver (SCFM). Air is only ~23% oxygen, and diffusers only transfer a fraction of that O‚ÇÇ into the water, so you need much more air than you might think. This calculator also estimates motor horsepower and annual energy cost ‚Äî since aeration is 50‚Äì65% of a typical plant's electric bill.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Inputs Explained</div>
                        <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                            <b>Oxygen Demand (lbs O‚ÇÇ/hr)</b> ‚Äî Your AOTR from Calc #59, or calculated as: (Flow MGD √ó BOD removed mg/L √ó 8.34) √∑ 24 hours. Include nitrification demand if applicable (4.6 lbs O‚ÇÇ per lb NH‚ÇÉ-N oxidized).<br>
                            <b>Diffuser Depth (ft)</b> ‚Äî Submergence depth of the diffusers. Deeper = higher back-pressure but better OTE. Typical: 12‚Äì18 ft.<br>
                            <b>OTE (%)</b> ‚Äî Oxygen Transfer Efficiency. Fine bubble diffusers: 25‚Äì35% (at 15 ft depth, clean water). Coarse bubble: 6‚Äì12%. Mechanical surface: varies. Use actual field-tested OTE if available ‚Äî clean-water OTE is higher than process conditions.<br>
                            <b>Number of Basins</b> ‚Äî SCFM is divided equally between parallel basins for per-basin blower sizing.<br>
                            <b>Safety Factor</b> ‚Äî Peak:average O‚ÇÇ demand ratio. Accounts for diurnal load variation and peak events. Typical: 1.5 for municipal, 2.0 for industrial.<br>
                            <b>Energy Cost ($/kWh)</b> ‚Äî Your utility rate. Texas average: $0.08‚Äì0.12/kWh. Enables annual cost projection.
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">TCEQ Exam Tips</div>
                        <div style="background:rgba(129,140,248,0.1);border-radius:6px;padding:8px 10px;margin:4px 0;border-left:3px solid #818cf8;">
                            ‚Ä¢ Air is 23.2% O‚ÇÇ by weight, 0.075 lbs/ft¬≥ at standard conditions<br>
                            ‚Ä¢ O‚ÇÇ per ft¬≥ of air = 0.075 √ó 0.232 = 0.0174 lbs<br>
                            ‚Ä¢ SCFM = O‚ÇÇ demand (lbs/min) √∑ (0.0174 √ó OTE fraction)<br>
                            ‚Ä¢ BHP = relates to SCFM and discharge pressure<br>
                            ‚Ä¢ Motor HP is typically next standard size above BHP √∑ motor efficiency<br>
                            ‚Ä¢ Higher OTE = less air needed = smaller blower = lower energy cost
                        </div>
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>Oxygen Demand (lbs O‚ÇÇ/hr)</label>
                        <input type="number" inputmode="decimal" id="bl_o2" oninput="calcBlower()" placeholder="80">
                        <span class="field-hint">AOTR from Calc #59</span>
                    </div>
                    <div>
                        <label>Diffuser Depth (ft)</label>
                        <input type="number" inputmode="decimal" id="bl_depth" oninput="calcBlower()" placeholder="15">
                        <span class="field-hint">Submergence depth</span>
                    </div>
                    <div>
                        <label>Oxygen Transfer Efficiency (%)</label>
                        <input type="number" inputmode="decimal" id="bl_ote" oninput="calcBlower()" placeholder="25">
                        <span class="field-hint">Fine bubble: 20-35% | Coarse: 6-12%</span>
                    </div>
                    <div>
                        <label>Number of Basins</label>
                        <input type="number" inputmode="decimal" id="bl_basins" oninput="calcBlower()" placeholder="2">
                        <span class="field-hint">Parallel aeration basins</span>
                    </div>
                    <div>
                        <label>Safety Factor</label>
                        <input type="number" inputmode="decimal" id="bl_sf" oninput="calcBlower()" placeholder="1.5">
                        <span class="field-hint">Peak:Avg (1.3‚Äì2.0 typical)</span>
                    </div>
                    <div>
                        <label>Energy Cost ($/kWh)</label>
                        <input type="number" inputmode="decimal" id="bl_cost" oninput="calcBlower()" placeholder="0.10">
                        <span class="field-hint">For annual cost estimate</span>
                    </div>
                </div>
                <div class="example-box"><b>OTE by type:</b> Fine bubble: 25‚Äì35% at 15 ft | Coarse bubble: 6‚Äì12% | Mechanical surface: 1.5‚Äì3.5 lbs O‚ÇÇ/hp-hr | Air is 23.2% O‚ÇÇ by weight (0.075 lbs/ft¬≥ √ó 0.232)</div>
                <div class="result-box">
                    <span class="val" id="bl_res">‚Äî</span>
                    <div id="bl_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('bl_res')">Copy Result</button>
                </div>
                <div class="formula-note">SCFM = (O‚ÇÇ demand √∑ (0.075 √ó 0.232 √ó OTE/100)) √∑ 60 | BHP = SCFM √ó ŒîP / (6356 √ó eff)</div>
            </div>
        </div>
    </div>

    <!-- ========== BIOSOLIDS & LAND APPLICATION ========== -->
    <div class="section-header" data-cat="landapp" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(180, 83, 9, 0.15); border-radius: 8px; border-left: 4px solid #d97706; font-size: 0.85rem; color: #fbbf24; font-weight: bold;">üå± Biosolids & Land Application</div>

    <!-- 66. Plant Available Nitrogen (PAN) -->
    <div class="card" id="card66" data-calc="pan" style="border-left-color: #d97706;">
        <div class="card-header" onclick="toggleCard(66)">
            <h2><span class="card-num" style="background: #d97706;">66</span> Plant Available Nitrogen</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #d97706;">Calculate Plant Available Nitrogen (PAN) from biosolids nitrogen fractions and mineralization rates. PAN determines the agronomic application rate ‚Äî apply too much and you contaminate groundwater, too little and the farmer complains.</div>

                <div style="margin-bottom:10px;">
                    <button onclick="document.getElementById('pan_guide').style.display = document.getElementById('pan_guide').style.display === 'none' ? 'block' : 'none'; this.innerText = document.getElementById('pan_guide').style.display === 'none' ? 'üìñ How to Use ‚ñ∏' : 'üìñ How to Use ‚ñæ'" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid #d97706;background:rgba(217,119,6,0.08);color:#fbbf24;font-weight:bold;font-size:0.82rem;cursor:pointer;text-align:left;">üìñ How to Use ‚ñ∏</button>
                    <div id="pan_guide" style="display:none;margin-top:8px;background:#0c1222;border:1px solid #334155;border-radius:8px;padding:14px;font-size:0.8rem;color:#cbd5e1;line-height:1.7;">
                        <div style="color:#fbbf24;font-weight:bold;font-size:0.85rem;margin-bottom:8px;">PLANT AVAILABLE NITROGEN ‚Äî OPERATOR GUIDE</div>

                        <div style="color:#f8fafc;font-weight:bold;">What is PAN?</div>
                        Not all nitrogen in biosolids is immediately available to plants. PAN (Plant Available Nitrogen) is the fraction that crops can actually use in the first growing season. It includes ammonia (with volatilization losses), nitrate (100% available), and a fraction of organic nitrogen that mineralizes. PAN is the legal basis for determining how much biosolids you can land-apply ‚Äî apply more N than the crop can use and you risk groundwater contamination.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Inputs Explained</div>
                        <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                            <b>NH‚ÇÉ-N (mg/kg dry)</b> ‚Äî Ammonia nitrogen from your biosolids lab analysis. Immediately plant-available but some is lost to volatilization (evaporation to air) during surface application.<br>
                            <b>NO‚ÇÉ-N (mg/kg dry)</b> ‚Äî Nitrate nitrogen. 100% plant available. Usually a small fraction in biosolids but can be significant in aerobically digested material.<br>
                            <b>Organic N (mg/kg dry)</b> ‚Äî Calculated as TKN minus NH‚ÇÉ-N. This is nitrogen locked in organic matter that slowly becomes available as microbes break it down (mineralization). Only a percentage converts in Year 1.<br>
                            <b>Application Method</b> ‚Äî How you apply affects ammonia loss. <b>Injected/incorporated within 24 hrs:</b> 0% NH‚ÇÉ loss (best). <b>Surface applied:</b> 50% of NH‚ÇÉ is lost to volatilization.<br>
                            <b>Mineralization Rate (%)</b> ‚Äî What fraction of organic N converts to plant-available form in Year 1. Depends on how the biosolids were treated: Aerobically digested: 30%. Anaerobically digested: 20%. Composted: 10%. Raw/unstabilized: 40%.<br>
                            <b>% Solids</b> ‚Äî Total solids of your biosolids. Liquid: 2‚Äì6%. Dewatered cake: 15‚Äì30%. Dried: 80%+. Needed to convert between dry and wet tons.
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">TCEQ Exam Tips</div>
                        <div style="background:rgba(217,119,6,0.1);border-radius:6px;padding:8px 10px;margin:4px 0;border-left:3px solid #d97706;">
                            ‚Ä¢ <b>PAN = (Kvol √ó NH‚ÇÉ-N) + NO‚ÇÉ-N + (Kmin √ó Org-N)</b><br>
                            ‚Ä¢ Kvol = 1.0 (injected) or 0.5 (surface applied)<br>
                            ‚Ä¢ Convert mg/kg to lbs/dry ton: multiply by 0.002<br>
                            ‚Ä¢ Org-N = TKN ‚àí NH‚ÇÉ-N<br>
                            ‚Ä¢ PAN determines the legal application rate under 40 CFR 503<br>
                            ‚Ä¢ If they ask "what is the agronomic rate?" ‚Üí next step is Calc #67
                        </div>
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>NH‚ÇÉ-N (mg/kg dry)</label>
                        <input type="number" inputmode="decimal" id="pan_nh3" oninput="calcPAN()" placeholder="15000">
                        <span class="field-hint">Ammonia nitrogen</span>
                    </div>
                    <div>
                        <label>NO‚ÇÉ-N (mg/kg dry)</label>
                        <input type="number" inputmode="decimal" id="pan_no3" oninput="calcPAN()" placeholder="500">
                        <span class="field-hint">Nitrate nitrogen</span>
                    </div>
                    <div>
                        <label>Organic N (mg/kg dry)</label>
                        <input type="number" inputmode="decimal" id="pan_orgn" oninput="calcPAN()" placeholder="25000">
                        <span class="field-hint">TKN minus NH‚ÇÉ-N</span>
                    </div>
                    <div>
                        <label>Application Method</label>
                        <select id="pan_method" oninput="calcPAN()" style="width:100%;padding:10px;border-radius:6px;border:1px solid #475569;background:#0f172a;color:#f8fafc;font-size:0.95rem;">
                            <option value="inject">Injected / Incorporated (&lt;24 hr)</option>
                            <option value="surface">Surface Applied (not incorporated)</option>
                        </select>
                        <span class="field-hint">Affects ammonia volatilization</span>
                    </div>
                    <div>
                        <label>Mineralization Rate (%)</label>
                        <input type="number" inputmode="decimal" id="pan_kmin" oninput="calcPAN()" placeholder="20">
                        <span class="field-hint">Year 1: 20-30% typical</span>
                    </div>
                    <div>
                        <label>% Solids</label>
                        <input type="number" inputmode="decimal" id="pan_solids" oninput="calcPAN()" placeholder="20">
                        <span class="field-hint">Biosolids % total solids</span>
                    </div>
                </div>
                <div class="example-box"><b>Volatilization:</b> Injected = 0% NH‚ÇÉ loss | Surface = 50% NH‚ÇÉ loss | <b>Mineralization:</b> Aerobic digested: 30% | Anaerobic: 20% | Composted: 10% | Raw: 40%</div>
                <div class="result-box">
                    <span class="val" id="pan_res">‚Äî</span>
                    <div id="pan_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('pan_res')">Copy Result</button>
                </div>
                <div class="formula-note">PAN = (Kvol √ó NH‚ÇÉ-N) + NO‚ÇÉ-N + (Kmin √ó Org-N) | lbs PAN/dry ton = PAN(mg/kg) √ó 0.002</div>
            </div>
        </div>
    </div>

    <!-- 67. Land Application Rate -->
    <div class="card" id="card67" data-calc="landapp" style="border-left-color: #d97706;">
        <div class="card-header" onclick="toggleCard(67)">
            <h2><span class="card-num" style="background: #d97706;">67</span> Land Application Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #d97706;">Calculate agronomic application rate in dry tons/acre and wet gallons/acre from PAN and crop nitrogen uptake. Ensures compliance with 40 CFR 503 and TCEQ biosolids permit requirements.</div>

                <div style="margin-bottom:10px;">
                    <button onclick="document.getElementById('land_guide').style.display = document.getElementById('land_guide').style.display === 'none' ? 'block' : 'none'; this.innerText = document.getElementById('land_guide').style.display === 'none' ? 'üìñ How to Use ‚ñ∏' : 'üìñ How to Use ‚ñæ'" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid #d97706;background:rgba(217,119,6,0.08);color:#fbbf24;font-weight:bold;font-size:0.82rem;cursor:pointer;text-align:left;">üìñ How to Use ‚ñ∏</button>
                    <div id="land_guide" style="display:none;margin-top:8px;background:#0c1222;border:1px solid #334155;border-radius:8px;padding:14px;font-size:0.8rem;color:#cbd5e1;line-height:1.7;">
                        <div style="color:#fbbf24;font-weight:bold;font-size:0.85rem;margin-bottom:8px;">LAND APPLICATION RATE ‚Äî OPERATOR GUIDE</div>

                        <div style="color:#f8fafc;font-weight:bold;">What This Calculates</div>
                        This determines how many dry tons of biosolids you can apply per acre per year based on the nitrogen balance: crop nitrogen uptake divided by PAN per dry ton. Apply at the agronomic rate ‚Äî the amount of nitrogen the crop can use ‚Äî and you stay in compliance. Exceed it and you risk nitrate groundwater contamination and regulatory action.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Inputs Explained</div>
                        <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                            <b>PAN (lbs/dry ton)</b> ‚Äî From Calc #66 or your lab report. This is the nitrogen the crop can access from each dry ton of biosolids applied.<br>
                            <b>Crop N Uptake (lbs N/acre/yr)</b> ‚Äî How much nitrogen the crop can absorb in one growing season. Get from NRCS guidance, your agronomist, or TCEQ design guidance. Common Texas crops: Coastal bermuda 300‚Äì400, corn silage 200‚Äì250, wheat 100‚Äì150, hay 150‚Äì250.<br>
                            <b>% Solids</b> ‚Äî Your biosolids total solids. Critical for converting dry tons to wet gallons for hauling logistics. Liquid biosolids (2‚Äì6% solids) require tanker trucks; dewatered cake (15‚Äì30%) uses dump trucks.<br>
                            <b>Annual Production (dry tons/yr)</b> ‚Äî How much biosolids your plant generates per year. Calculate from: (lbs dry solids/day √ó 365) √∑ 2000.<br>
                            <b>Available Acreage</b> ‚Äî Total permitted land application acreage. The calculator checks if your site is big enough for your annual production.
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Site Capacity Check</div>
                        If your production exceeds what the site can handle at the agronomic rate, you need more acreage, a different disposal method (composting, landfill, incineration), or you need to reduce solids production at the plant.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">TCEQ Exam Tips</div>
                        <div style="background:rgba(217,119,6,0.1);border-radius:6px;padding:8px 10px;margin:4px 0;border-left:3px solid #d97706;">
                            ‚Ä¢ <b>DT/acre = Crop N uptake √∑ PAN per dry ton</b><br>
                            ‚Ä¢ Wet gal/acre = (DT/acre √ó 2000 lbs) √∑ (8.34 √ó % solids as decimal)<br>
                            ‚Ä¢ Required acres = Annual production (DT/yr) √∑ Rate (DT/acre/yr)<br>
                            ‚Ä¢ <b>40 CFR 503:</b> Federal regulation governing biosolids use and disposal<br>
                            ‚Ä¢ <b>Agronomic rate</b> = match N application to crop uptake. This is the law.<br>
                            ‚Ä¢ Exam may give you all PAN components and crop info in one problem ‚Äî solve PAN first, then rate<br>
                            ‚Ä¢ Remember: 1 dry ton = 2,000 lbs
                        </div>
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>PAN (lbs/dry ton)</label>
                        <input type="number" inputmode="decimal" id="la_pan" oninput="calcLandApp()" placeholder="30">
                        <span class="field-hint">From Calc #66 or lab</span>
                    </div>
                    <div>
                        <label>Crop N Uptake (lbs N/acre/yr)</label>
                        <input type="number" inputmode="decimal" id="la_crop" oninput="calcLandApp()" placeholder="200">
                        <span class="field-hint">Bermuda: 200-400 | Corn: 150-200</span>
                    </div>
                    <div>
                        <label>% Solids</label>
                        <input type="number" inputmode="decimal" id="la_solids" oninput="calcLandApp()" placeholder="4">
                        <span class="field-hint">Liquid: 2-6% | Cake: 15-30%</span>
                    </div>
                    <div>
                        <label>Annual Production (dry tons/yr)</label>
                        <input type="number" inputmode="decimal" id="la_prod" oninput="calcLandApp()" placeholder="500">
                        <span class="field-hint">Total plant biosolids output</span>
                    </div>
                    <div>
                        <label>Available Acreage</label>
                        <input type="number" inputmode="decimal" id="la_acres" oninput="calcLandApp()" placeholder="200">
                        <span class="field-hint">Permitted land app site</span>
                    </div>
                </div>
                <div class="example-box"><b>Crop N Uptake (lbs/acre/yr):</b> Coastal bermuda: 300‚Äì400 | Corn silage: 200‚Äì250 | Wheat: 100‚Äì150 | Hay: 150‚Äì250 | Fescue: 150‚Äì250</div>
                <div class="result-box">
                    <span class="val" id="la_res">‚Äî</span>
                    <div id="la_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('la_res')">Copy Result</button>
                </div>
                <div class="formula-note">DT/acre = Crop N √∑ PAN | Wet gal/acre = (DT √ó 2000) √∑ (8.34 √ó %solids/100) | Required acres = Production √∑ Rate</div>
            </div>
        </div>
    </div>

    </div><!-- /card-grid-wrap -->
    <div class="version">
        <div style="font-size: 0.85rem; color: #94a3b8; margin-bottom: 4px;">Built by <b>Armand Frazier Sr.</b> | Houston, TX</div>
        WW Pro-Calc v9.1 ‚Äì 67 Calculators | Search ¬∑ Filter ¬∑ Favorites ¬∑ Exam Mode
    </div>

    <!-- QR Share Section -->
    <div style="text-align:center;margin:10px 0 20px;padding:14px;background:#1e293b;border-radius:10px;">
        <button onclick="document.getElementById('qrModal').classList.add('active')" style="padding:10px 20px;border-radius:8px;border:1px solid #475569;background:transparent;color:#94a3b8;font-size:0.82rem;font-weight:600;cursor:pointer;">üì≤ Share This App (QR Code)</button>
    </div>

    <div class="whatsnew-overlay" id="qrModal" onclick="if(event.target===this)this.classList.remove('active')">
        <div class="whatsnew-box" style="max-width:340px;text-align:center;">
            <div class="whatsnew-header">
                <h3>üì≤ Share WW Pro-Calc</h3>
                <button onclick="document.getElementById('qrModal').classList.remove('active')" style="background:none;border:none;color:#94a3b8;font-size:1.3rem;cursor:pointer">‚úï</button>
            </div>
            <div style="padding:20px;">
                <canvas id="qrCanvas" width="200" height="200" style="border-radius:8px;background:#fff;padding:10px;"></canvas>
                <div style="margin-top:12px;font-size:0.78rem;color:#94a3b8;">Scan with any phone camera to open the app.<br>Works offline after first load.</div>
                <div style="margin-top:10px;font-size:0.7rem;color:#64748b;" id="qrUrl"></div>
            </div>
        </div>
    </div>
</div>

<!-- TCEQ Exam Mode -->
<button class="exam-fab" onclick="openExam()" title="TCEQ Exam Mode">üìù<br>Exam</button>
<div class="exam-overlay" id="examOverlay" onclick="if(event.target===this)closeExam()">
    <div class="exam-box">
        <div class="exam-hdr">
            <h3>üìù TCEQ Exam Mode</h3>
            <span class="exam-score" id="examScore">0 / 0</span>
            <button class="exam-close" onclick="closeExam()">‚úï</button>
        </div>
        <div class="exam-body" id="examBody">
            <div style="text-align:center;padding:20px 0;">
                <div style="font-size:2rem;margin-bottom:10px;">üéì</div>
                <div style="color:#f8fafc;font-weight:bold;margin-bottom:8px;">Practice for Your TCEQ Exam</div>
                <div style="color:#94a3b8;font-size:0.82rem;margin-bottom:16px;">Randomized problems based on real exam formulas.<br>Covers Class D through Class A topics.</div>
                <button class="exam-next" onclick="nextExamQ()">Start Practice üí™</button>
            </div>
        </div>
    </div>
</div>

<!-- Bottom Navigation -->
<nav class="bottom-nav">
    <div class="nav-scroll">
        <button class="nav-btn active" onclick="goToCard(1)" id="nav1">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 3v18M5 8l7-5 7 5M5 12h14"/>
            </svg>
            <span>Lbs</span>
        </button>
        <button class="nav-btn" onclick="goToCard(2)" id="nav2">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="4" y="4" width="16" height="16" rx="2"/><path d="M8 20V10M12 20V6M16 20V14"/>
            </svg>
            <span>SVI</span>
        </button>
        <button class="nav-btn" onclick="goToCard(3)" id="nav3">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="8" cy="12" r="4"/><circle cx="16" cy="12" r="4"/>
            </svg>
            <span>Mix</span>
        </button>
        <button class="nav-btn" onclick="goToCard(4)" id="nav4">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
            <span>F/M</span>
        </button>
        <button class="nav-btn" onclick="goToCard(5)" id="nav5">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="16" rx="2"/><path d="M8 2v4M16 2v4M3 10h18"/>
            </svg>
            <span>SRT</span>
        </button>
        <button class="nav-btn" onclick="goToCard(6)" id="nav6">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
            </svg>
            <span>DT</span>
        </button>
        <button class="nav-btn" onclick="goToCard(7)" id="nav7">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 3v18h18"/><path d="M7 16l4-8 4 4 5-9"/>
            </svg>
            <span>Eff%</span>
        </button>
        <button class="nav-btn" onclick="goToCard(8)" id="nav8">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2v20M2 12h20"/><circle cx="12" cy="12" r="3"/>
            </svg>
            <span>WAS</span>
        </button>
        <button class="nav-btn" onclick="goToCard(9)" id="nav9">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 12h16M4 12l4-4M4 12l4 4M20 12l-4-4M20 12l-4 4"/>
            </svg>
            <span>RAS</span>
        </button>
        <button class="nav-btn" onclick="goToCard(10)" id="nav10">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 3v18"/>
            </svg>
            <span>OLR</span>
        </button>
        <button class="nav-btn" onclick="goToCard(11)" id="nav11">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><path d="M2 12h20"/>
            </svg>
            <span>SOR</span>
        </button>
        <button class="nav-btn" onclick="goToCard(12)" id="nav12">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 4h16v4H4zM4 12h16"/><path d="M12 12v8"/>
            </svg>
            <span>WOR</span>
        </button>
        <button class="nav-btn" onclick="goToCard(13)" id="nav13">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="4" y="4" width="16" height="16" rx="2"/><path d="M4 14h16M9 4v16"/>
            </svg>
            <span>SLR</span>
        </button>
        <button class="nav-btn" onclick="goToCard(14)" id="nav14">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 3h6v6H9zM12 9v12M8 21h8"/>
            </svg>
            <span>Chem</span>
        </button>
        <button class="nav-btn" onclick="goToCard(15)" id="nav15">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="6" width="18" height="12" rx="1"/><path d="M3 10h18M3 14h18M7 6v12M11 6v12M15 6v12M19 6v12"/>
            </svg>
            <span>Flux</span>
        </button>
        <button class="nav-btn" onclick="goToCard(16)" id="nav16">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2v20"/><path d="M5 5l14 14"/><path d="M19 5L5 19"/><circle cx="12" cy="12" r="3"/>
            </svg>
            <span>TMP</span>
        </button>
        <button class="nav-btn" onclick="goToCard(17)" id="nav17">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 12h16"/><path d="M4 6h16"/><path d="M4 18h16"/><circle cx="12" cy="12" r="2"/>
            </svg>
            <span>Perm</span>
        </button>
        <button class="nav-btn" onclick="goToCard(18)" id="nav18">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="2" y="4" width="20" height="16" rx="2"/><path d="M2 10h20M8 4v16M14 4v16"/>
            </svg>
            <span>MArea</span>
        </button>
        <button class="nav-btn" onclick="goToCard(19)" id="nav19">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="16" r="2"/><path d="M12 14V4"/><path d="M8 8l4-4 4 4"/><path d="M6 20h12"/>
            </svg>
            <span>SAD</span>
        </button>
        <button class="nav-btn" onclick="goToCard(20)" id="nav20">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 11l3 3 8-8"/><circle cx="12" cy="12" r="10"/>
            </svg>
            <span>MBR‚úì</span>
        </button>
        <button class="nav-btn" onclick="goToCard(21)" id="nav21">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M8 2h8l2 6H6l2-6z"/><rect x="6" y="8" width="12" height="12" rx="1"/><path d="M10 12v4M14 12v4"/>
            </svg>
            <span>CIP</span>
        </button>
        <button class="nav-btn" onclick="goToCard(22)" id="nav22">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 3v18"/>
            </svg>
            <span>SALR</span>
        </button>
        <button class="nav-btn" onclick="goToCard(23)" id="nav23">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="8" cy="8" r="3"/><circle cx="16" cy="8" r="3"/><circle cx="8" cy="16" r="3"/><circle cx="16" cy="16" r="3"/>
            </svg>
            <span>BioA</span>
        </button>
        <button class="nav-btn" onclick="goToCard(24)" id="nav24">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="4" y="4" width="16" height="16" rx="2"/><path d="M8 8h8v8H8z"/>
            </svg>
            <span>MVol</span>
        </button>
        <button class="nav-btn" onclick="goToCard(25)" id="nav25">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="6" width="18" height="12" rx="2"/><path d="M3 12h18"/>
            </svg>
            <span>RSiz</span>
        </button>
        <button class="nav-btn" onclick="goToCard(26)" id="nav26">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="8"/><path d="M12 8v4l2 2"/>
            </svg>
            <span>O‚ÇÇ</span>
        </button>
        <button class="nav-btn" onclick="goToCard(27)" id="nav27">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 4v16h16"/><rect x="7" y="10" width="4" height="8"/><rect x="13" y="6" width="4" height="12"/>
            </svg>
            <span>CvM</span>
        </button>
        <button class="nav-btn" onclick="goToCard(28)" id="nav28">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><path d="M12 6v6l3 3"/>
            </svg>
            <span>Cycle</span>
        </button>
        <button class="nav-btn" onclick="goToCard(29)" id="nav29">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="4" y="4" width="16" height="16" rx="2"/><path d="M4 12h16"/>
            </svg>
            <span>SVol</span>
        </button>
        <button class="nav-btn" onclick="goToCard(30)" id="nav30">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2v20"/><path d="M8 18l4 4 4-4"/><path d="M4 8h16"/>
            </svg>
            <span>Dec</span>
        </button>
        <button class="nav-btn" onclick="goToCard(31)" id="nav31">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="16" r="3"/><path d="M12 13V3"/><path d="M8 7l4-4 4 4"/>
            </svg>
            <span>SAer</span>
        </button>
        <button class="nav-btn" onclick="goToCard(32)" id="nav32">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18M6 6l12 12"/><circle cx="12" cy="12" r="2"/>
            </svg>
            <span>SF:M</span>
        </button>
        <button class="nav-btn" onclick="goToCard(33)" id="nav33">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="4" y="2" width="16" height="20" rx="2"/><path d="M4 8h16"/><path d="M4 14h16"/>
            </svg>
            <span>Set‚úì</span>
        </button>
        <button class="nav-btn" onclick="goToCard(34)" id="nav34">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 12h8M12 8v8"/></svg>
            <span>CT</span>
        </button>
        <button class="nav-btn" onclick="goToCard(35)" id="nav35">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18"/><circle cx="6" cy="6" r="3"/><circle cx="18" cy="18" r="3"/></svg>
            <span>DeCl</span>
        </button>
        <button class="nav-btn" onclick="goToCard(36)" id="nav36">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4"/></svg>
            <span>UV</span>
        </button>
        <button class="nav-btn" onclick="goToCard(37)" id="nav37">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="8" width="16" height="12" rx="2"/><path d="M8 8V6a4 4 0 018 0v2"/></svg>
            <span>Sld%</span>
        </button>
        <button class="nav-btn" onclick="goToCard(38)" id="nav38">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M7 16l4-8 4 4 5-9"/></svg>
            <span>VSR</span>
        </button>
        <button class="nav-btn" onclick="goToCard(39)" id="nav39">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6"/><circle cx="12" cy="16" r="1"/></svg>
            <span>DigL</span>
        </button>
        <button class="nav-btn" onclick="goToCard(40)" id="nav40">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 3h6v6H9zM12 9v6"/><circle cx="12" cy="18" r="3"/></svg>
            <span>Poly</span>
        </button>
        <button class="nav-btn" onclick="goToCard(41)" id="nav41">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/></svg>
            <span>Phos</span>
        </button>
        <button class="nav-btn" onclick="goToCard(42)" id="nav42">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 20h16M6 16l6-12 6 12"/><path d="M8.5 12h7"/></svg>
            <span>Alk</span>
        </button>
        <button class="nav-btn" onclick="goToCard(43)" id="nav43">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16v16H4z"/><path d="M4 12h16M12 4v16"/></svg>
            <span>NBal</span>
        </button>
        <button class="nav-btn" onclick="goToCard(44)" id="nav44">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M8 6l4-4 4 4M8 18l4 4 4-4"/></svg>
            <span>TDH</span>
        </button>
        <button class="nav-btn" onclick="goToCard(45)" id="nav45">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12h16M16 8l4 4-4 4"/></svg>
            <span>Pipe</span>
        </button>
        <button class="nav-btn" onclick="goToCard(46)" id="nav46">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
            <span>HP</span>
        </button>
        <button class="nav-btn" onclick="goToCard(47)" id="nav47">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="4" width="16" height="16" rx="2"/><path d="M8 8h8M8 12h5M8 16h8"/></svg>
            <span>Geo</span>
        </button>
        <button class="nav-btn" onclick="goToCard(48)" id="nav48">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6h16M4 10h16M4 14h10M4 18h6"/></svg>
            <span>FWC</span>
        </button>
        <button class="nav-btn" onclick="goToCard(49)" id="nav49">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12h16M12 4v16"/><path d="M8 8l8 8M16 8l-8 8"/></svg>
            <span>Unit</span>
        </button>
        <button class="nav-btn" onclick="goToCard(50)" id="nav50">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 20L12 4l8 16"/><path d="M7 14h10"/></svg>
            <span>Man</span>
        </button>
        <button class="nav-btn" onclick="goToCard(51)" id="nav51">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="8" width="16" height="12" rx="2"/><path d="M8 8V4h8v4"/></svg>
            <span>Well</span>
        </button>
        <button class="nav-btn" onclick="goToCard(52)" id="nav52">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M7 7l10 10M17 7L7 17"/></svg>
            <span>I/I</span>
        </button>
        <button class="nav-btn" onclick="goToCard(53)" id="nav53">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12h16M16 8l4 4-4 4"/><path d="M4 6v12"/></svg>
            <span>HzW</span>
        </button>
        <button class="nav-btn" onclick="goToCard(54)" id="nav54">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 8h16M4 8l4 12M20 8l-4 12"/></svg>
            <span>Weir</span>
        </button>
        <button class="nav-btn" onclick="goToCard(55)" id="nav55">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="4" width="12" height="16" rx="1"/><path d="M10 12l4 0M12 10v4"/></svg>
            <span>A√óV</span>
        </button>
        <button class="nav-btn" onclick="goToCard(56)" id="nav56">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 16l4-8 4 8"/></svg>
            <span>NRC</span>
        </button>
        <button class="nav-btn" onclick="goToCard(57)" id="nav57">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v12M6 12h12"/></svg>
            <span>TFH</span>
        </button>
        <button class="nav-btn" onclick="goToCard(58)" id="nav58">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 20c4-4 6-16 10-16s6 12 10 16"/></svg>
            <span>Pond</span>
        </button>
        <button class="nav-btn" onclick="goToCard(59)" id="nav59">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v8M8 6l4 4 4-4"/><circle cx="12" cy="16" r="5"/></svg>
            <span>OTR</span>
        </button>
        <button class="nav-btn" onclick="goToCard(60)" id="nav60">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12c0 0 4-8 8-8s8 8 8 8-4 8-8 8-8-8-8-8"/></svg>
            <span>Dil</span>
        </button>
        <button class="nav-btn" onclick="goToCard(61)" id="nav61">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="8" r="4"/><circle cx="17" cy="8" r="4"/><path d="M4 20c0-4 3-7 8-7s8 3 8 7"/></svg>
            <span>Pop</span>
        </button>
        <button class="nav-btn" onclick="goToCard(62)" id="nav62">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16v16H4z"/><path d="M8 4v16M16 4v16"/></svg>
            <span>Flm</span>
        </button>
        <button class="nav-btn" onclick="goToCard(63)" id="nav63">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="8"/><path d="M12 4v16M4 12h16"/></svg>
            <span>Tank</span>
        </button>
        <button class="nav-btn" onclick="goToCard(64)" id="nav64">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 20c2-6 6-16 16-16"/><path d="M4 20h16"/></svg>
            <span>HRT</span>
        </button>
        <button class="nav-btn" onclick="goToCard(65)" id="nav65">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="14" r="6"/><path d="M12 2v6M8 4h8"/></svg>
            <span>Blwr</span>
        </button>
        <button class="nav-btn" onclick="goToCard(66)" id="nav66">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l2 7h7l-6 4 2 7-5-4-5 4 2-7-6-4h7z"/></svg>
            <span>PAN</span>
        </button>
        <button class="nav-btn" onclick="goToCard(67)" id="nav67">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 20h16M4 20V8l8-6 8 6v12"/></svg>
            <span>Land</span>
        </button>
    </div>
</nav>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Install Prompt -->
<div class="install-prompt" id="installPrompt">
    üì≤ Install App
    <button onclick="installApp()">Install</button>
    <button onclick="dismissInstall()" style="background:transparent;color:white;font-size:1.2rem;">√ó</button>
</div>

<script>
    // ==================== STATE ====================
    const STORAGE_KEY = 'wwProCalcData';
    let currentCard = 1;
    
    // All input IDs for saving/restoring
    const inputIds = [
        'p_flow', 'p_conc',
        'svi_set', 'svi_mlss',
        'mb_qa', 'mb_ca', 'mb_qb', 'mb_cb',
        'fm_flow', 'fm_bod', 'fm_vol', 'fm_mlvss',
        'srt_vol', 'srt_mlss', 'srt_wasq', 'srt_wasc', 'srt_effq', 'srt_effc',
        'dt_vol', 'dt_flow',
        'eff_in', 'eff_out',
        'was_vol', 'was_mlss', 'was_srt', 'was_conc',
        'ras_flow', 'ras_mlss', 'ras_conc',
        'olr_flow', 'olr_bod', 'olr_vol',
        'sor_flow', 'sor_area',
        'wor_flow', 'wor_len',
        'slr_flow', 'slr_mlss', 'slr_area',
        'chem_flow', 'chem_dose', 'chem_purity',
        'flux_flow', 'flux_area',
        'tmp_feed', 'tmp_perm',
        'perm_flux', 'perm_tmp',
        'msize_flow', 'msize_pf', 'msize_flux', 'msize_peak',
        'sad_air', 'sad_area', 'sad_perm',
        'mbrc_mlss', 'mbrc_srt', 'mbrc_fm', 'mbrc_do',
        'cip_vol', 'cip_nacl', 'cip_bleach', 'cip_citric', 'cip_cstr',
        'salr_flow', 'salr_conc', 'salr_area',
        'bio_vol', 'bio_fill', 'bio_ssa',
        'mv_flow', 'mv_conc', 'mv_salr', 'mv_ssa',
        'rsz_media', 'rsz_fill', 'rsz_flow',
        'mdo_flow', 'mdo_bod', 'mdo_nh3',
        'cmp_flow', 'cmp_bod',
        'cyc_fill', 'cyc_react', 'cyc_settle', 'cyc_decant', 'cyc_idle', 'cyc_flow',
        'sv_flow', 'sv_cycles', 'sv_reactor', 'sv_basins',
        'dec_vol', 'dec_time', 'dec_weir',
        'saer_flow', 'saer_bod', 'saer_nh3', 'saer_duty',
        'sfm_fill', 'sfm_bod', 'sfm_vol', 'sfm_mlvss', 'sfm_cycles',
        'ssc_depth', 'ssc_sludge', 'ssc_decant', 'ssc_mlss',
        'ct_res_in', 'ct_time', 'ct_req',
        'dcl_flow', 'dcl_cl2', 'dcl_sf',
        'uv_int', 'uv_time', 'uv_uvt',
        'slv_vol', 'slv_pct',
        'vsr_in', 'vsr_out',
        'dig_flow', 'dig_pct', 'dig_vs', 'dig_vol',
        'poly_flow', 'poly_pct', 'poly_rate', 'poly_conc',
        'phos_flow', 'phos_in', 'phos_out', 'phos_ratio',
        'alk_in', 'alk_nh3', 'alk_flow',
        'nb_tkn', 'nb_nh3', 'nb_no3', 'nb_bio',
        'tdh_static', 'tdh_friction', 'tdh_vel',
        'pv_flow', 'pv_dia',
        'hp_flow', 'hp_tdh', 'hp_eff', 'hp_meff',
        'gm_s1', 'gm_s2', 'gm_s3', 'gm_s4', 'gm_s5', 'gm_s6', 'gm_s7',
        'fw_f1', 'fw_c1', 'fw_f2', 'fw_c2', 'fw_f3', 'fw_c3', 'fw_f4', 'fw_c4',
        'uc_gpm', 'uc_mgd', 'uc_cfs', 'uc_m3d', 'uc_gal', 'uc_ft3', 'uc_m3', 'uc_acft', 'uc_psi', 'uc_fth2o', 'uc_kpa',
        'man_dia', 'man_slope', 'man_n',
        'ww_pump', 'ww_inflow', 'ww_cycle',
        'ii_wet', 'ii_dry', 'ii_dia', 'ii_miles',
        'hz_flow', 'hz_c', 'hz_dia', 'hz_len',
        'weir_type', 'weir_h', 'weir_l',
        'av_type', 'av_vel', 'av_dim1', 'av_dim2',
        'nrc_bod', 'nrc_vol', 'nrc_recirc',
        'tfl_flow', 'tfl_dia', 'tfl_bod', 'tfl_depth',
        'pnd_flow', 'pnd_bod', 'pnd_acres', 'pnd_depth',
        'ao_sotr', 'ao_alpha', 'ao_beta', 'ao_temp', 'ao_do', 'ao_alt',
        'dil_eflow', 'dil_econc', 'dil_sflow', 'dil_sconc',
        'pe_flow', 'pe_bod', 'pe_tss', 'pe_tkn', 'pe_pop', 'pe_permit', 'pe_growth', 'pe_peak',
        'pf_width', 'pf_ha', 'pf_hb',
        'tv_shape', 'tv_dim1', 'tv_dim2', 'tv_depth', 'tv_cone',
        'hrt_acres', 'hrt_depth', 'hrt_sludge', 'hrt_flow', 'hrt_cells',
        'bl_o2', 'bl_depth', 'bl_ote', 'bl_basins', 'bl_sf', 'bl_cost',
        'pan_nh3', 'pan_no3', 'pan_orgn', 'pan_method', 'pan_kmin', 'pan_solids',
        'la_pan', 'la_crop', 'la_solids', 'la_prod', 'la_acres'
    ];

    // ==================== ACCORDION ====================
    // ==================== WHAT'S NEW ====================
    var WN_VERSION = '9.2';
    function openWhatsNew() {
        document.getElementById('wnOverlay').classList.add('active');
    }
    function closeWhatsNew() {
        document.getElementById('wnOverlay').classList.remove('active');
        document.getElementById('wnBadge').style.display = 'none';
        try { localStorage.setItem('wn_seen', WN_VERSION); } catch(e) {}
    }
    function checkWhatsNew() {
        try {
            var seen = localStorage.getItem('wn_seen');
            if (seen !== WN_VERSION) {
                document.getElementById('wnBadge').style.display = 'inline';
                // Auto-open on first visit to this version
                setTimeout(function() { openWhatsNew(); }, 600);
            }
        } catch(e) {
            // localStorage unavailable ‚Äî show badge anyway
            document.getElementById('wnBadge').style.display = 'inline';
        }
    }

    // ==================== INPUT VALIDATION ====================
    var validationRules = {
        // id: [min_error, min_warn, max_warn, max_error, unit_label]
        'p_flow': [0, null, 50, 200, 'MGD'], 'p_conc': [0, null, 1000, 5000, 'mg/L'],
        'fm_flow': [0, null, 50, 200, 'MGD'], 'fm_bod': [0, null, 500, 2000, 'mg/L'],
        'fm_vol': [0, null, 10, 50, 'MG'], 'fm_mlss': [0, 500, 8000, 15000, 'mg/L'],
        'srt_vol': [0, null, 10, 50, 'MG'], 'srt_mlss': [0, 500, 8000, 15000, 'mg/L'],
        'svi_vol': [0, null, null, null, 'mL'], 'svi_mlss': [0, 500, 8000, 15000, 'mg/L'],
        'dt_vol': [0, null, null, null, 'gal'], 'dt_flow': [0, null, null, null, 'GPD'],
        'ct_res_in': [0, null, 10, 20, 'mg/L'],
        'mann_dia': [0, 4, 120, 200, 'inches'], 'mann_slope': [0, null, 0.02, 0.05, 'ft/ft'],
        'mann_n': [0.005, 0.008, 0.025, 0.035, 'n'],
        'bl_ote': [0, 5, 40, 60, '%'], 'bl_sf': [0.5, 1.0, 2.5, 4.0, ''],
        'pf_ha': [0, null, 3, 5, 'ft'],
        'tv_dim1': [0, null, 200, 500, 'ft'], 'tv_depth': [0, null, 30, 50, 'ft'],
        'pe_flow': [0, null, 50, 200, 'MGD'], 'pe_bod': [0, null, 500, 2000, 'mg/L'],
        'pe_tss': [0, null, 500, 2000, 'mg/L'], 'pe_growth': [0, null, 5, 15, '%'],
        'pan_kmin': [0, null, 50, 80, '%'], 'pan_solids': [0, null, 40, 100, '%'],
        'la_solids': [0, null, 40, 100, '%']
    };
    
    function validateInput(el) {
        var id = el.id;
        var rules = validationRules[id];
        if (!rules) return;
        
        // Remove existing validation
        el.classList.remove('input-warn', 'input-error');
        var existing = el.parentElement.querySelector('.input-val-msg');
        if (existing) existing.remove();
        
        var val = parseFloat(el.value);
        if (isNaN(val) || el.value === '') return;
        
        var msg = '', level = '';
        var minErr = rules[0], minWarn = rules[1], maxWarn = rules[2], maxErr = rules[3];
        
        if (minErr !== null && val < minErr) { msg = '‚ö† Must be ‚â• ' + minErr; level = 'error'; }
        else if (minWarn !== null && val < minWarn) { msg = '‚ö° Low ‚Äî typical min is ' + minWarn; level = 'warn'; }
        else if (maxErr !== null && val > maxErr) { msg = '‚ö† Unusually high (>' + maxErr + ')'; level = 'error'; }
        else if (maxWarn !== null && val > maxWarn) { msg = '‚ö° High ‚Äî typical max ~' + maxWarn; level = 'warn'; }
        
        if (msg) {
            el.classList.add('input-' + level);
            var div = document.createElement('div');
            div.className = 'input-val-msg ' + level;
            div.textContent = msg;
            el.parentElement.appendChild(div);
        }
    }
    
    // Delegated validation listener
    document.addEventListener('input', function(e) {
        if (e.target.tagName === 'INPUT' && e.target.type === 'number') {
            validateInput(e.target);
        }
    });

    // ==================== EXPAND/COLLAPSE ALL ====================
    var allExpanded = false;
    function toggleAll() {
        allExpanded = !allExpanded;
        document.querySelectorAll('.card').forEach(function(card) {
            if (card.classList.contains('search-hidden')) return;
            if (allExpanded) card.classList.add('open');
            else card.classList.remove('open');
        });
        document.getElementById('btnToggleAll').textContent = allExpanded ? 'Collapse All' : 'Expand All';
    }

    // ==================== FAVORITES ====================
    var favorites = [];
    function loadFavorites() {
        try { favorites = JSON.parse(localStorage.getItem('ww_favs') || '[]'); } catch(e) { favorites = []; }
    }
    function saveFavorites() {
        try { localStorage.setItem('ww_favs', JSON.stringify(favorites)); } catch(e) {}
    }
    function initFavStars() {
        document.querySelectorAll('.card-header').forEach(function(hdr) {
            var card = hdr.parentElement;
            var cardId = card.id; // e.g. "card1"
            var num = cardId.replace('card', '');
            var star = document.createElement('button');
            star.className = 'fav-btn';
            star.setAttribute('data-card', num);
            star.textContent = '‚≠ê';
            star.title = 'Add to favorites';
            star.onclick = function(e) {
                e.stopPropagation();
                toggleFav(num);
            };
            hdr.querySelector('h2').appendChild(star);
        });
        updateFavUI();
    }
    function toggleFav(num) {
        var idx = favorites.indexOf(num);
        if (idx > -1) favorites.splice(idx, 1);
        else favorites.push(num);
        saveFavorites();
        updateFavUI();
    }
    function updateFavUI() {
        // Update star states
        document.querySelectorAll('.fav-btn').forEach(function(btn) {
            var num = btn.getAttribute('data-card');
            if (favorites.indexOf(num) > -1) btn.classList.add('favorited');
            else btn.classList.remove('favorited');
        });
        // Build favorites section
        var section = document.getElementById('favSection');
        var links = document.getElementById('favLinks');
        links.innerHTML = '';
        if (favorites.length === 0) {
            section.classList.remove('has-favs');
            return;
        }
        section.classList.add('has-favs');
        favorites.forEach(function(num) {
            var card = document.getElementById('card' + num);
            if (!card) return;
            var title = card.querySelector('h2');
            var name = title ? title.textContent.replace('‚≠ê', '').trim() : 'Calc ' + num;
            var link = document.createElement('span');
            link.className = 'fav-link';
            link.textContent = name;
            link.onclick = function() { goToCard(parseInt(num)); };
            links.appendChild(link);
        });
    }

    // ==================== CATEGORY FILTER ====================
    function filterCat(cat, btn) {
        // Update active chip
        document.querySelectorAll('.filter-chip').forEach(function(c) { c.classList.remove('active'); });
        btn.classList.add('active');
        
        // Clear search when filtering
        document.getElementById('searchInput').value = '';
        document.getElementById('searchClear').style.display = 'none';
        document.getElementById('searchCount').textContent = '';
        
        if (cat === 'all') {
            document.querySelectorAll('.card').forEach(function(c) { c.classList.remove('search-hidden'); });
            document.querySelectorAll('.section-header').forEach(function(s) { s.classList.remove('search-hidden'); });
            return;
        }
        
        // Build card-to-category mapping by walking DOM
        var cardCats = {};
        var currentCat = 'cas'; // cards before first section header are CAS Core
        var container = document.querySelector('.card-grid-wrap');
        if (!container) container = document.querySelector('.container');
        var children = container.children;
        for (var i = 0; i < children.length; i++) {
            var el = children[i];
            if (el.classList.contains('section-header') && el.dataset.cat) {
                currentCat = el.dataset.cat;
            }
            if (el.classList.contains('card')) {
                cardCats[el.id] = currentCat;
            }
        }
        
        // Show/hide cards
        document.querySelectorAll('.card').forEach(function(card) {
            if (cardCats[card.id] === cat) {
                card.classList.remove('search-hidden');
            } else {
                card.classList.add('search-hidden');
            }
        });
        
        // Show/hide section headers
        document.querySelectorAll('.section-header').forEach(function(hdr) {
            if (hdr.dataset.cat === cat) {
                hdr.classList.remove('search-hidden');
            } else {
                hdr.classList.add('search-hidden');
            }
        });
    }

    // ==================== SEARCH ====================
    function searchCalcs() {
        var term = document.getElementById('searchInput').value.toLowerCase().trim();
        var clearBtn = document.getElementById('searchClear');
        var countEl = document.getElementById('searchCount');
        
        clearBtn.style.display = term ? 'block' : 'none';
        
        // Reset filter chips when typing
        if (term) {
            document.querySelectorAll('.filter-chip').forEach(function(c) { c.classList.remove('active'); });
            document.querySelector('.filter-chip[data-filter="all"]').classList.add('active');
        }
        
        if (!term) {
            // Show everything
            document.querySelectorAll('.card').forEach(function(c) { c.classList.remove('search-hidden'); });
            document.querySelectorAll('.section-header').forEach(function(s) { s.classList.remove('search-hidden'); });
            countEl.textContent = '';
            return;
        }
        
        var terms = term.split(/\s+/);
        var matchCount = 0;
        
        document.querySelectorAll('.card').forEach(function(card) {
            // Build searchable text from card title, data-calc, and input-help
            var title = (card.querySelector('h2') || {}).textContent || '';
            var dataCat = card.getAttribute('data-calc') || '';
            var helpEl = card.querySelector('.input-help');
            var helpText = helpEl ? helpEl.textContent : '';
            var formulaEl = card.querySelector('.formula-note');
            var formulaText = formulaEl ? formulaEl.textContent : '';
            var searchText = (title + ' ' + dataCat + ' ' + helpText + ' ' + formulaText).toLowerCase();
            
            // All terms must match
            var match = terms.every(function(t) { return searchText.indexOf(t) !== -1; });
            
            if (match) {
                card.classList.remove('search-hidden');
                matchCount++;
            } else {
                card.classList.add('search-hidden');
            }
        });
        
        // Show/hide section headers based on whether any following cards are visible
        document.querySelectorAll('.section-header').forEach(function(hdr) {
            var next = hdr.nextElementSibling;
            var hasVisible = false;
            while (next && !next.classList.contains('section-header') && !next.classList.contains('version')) {
                if (next.classList.contains('card') && !next.classList.contains('search-hidden')) {
                    hasVisible = true;
                    break;
                }
                next = next.nextElementSibling;
            }
            if (hasVisible) hdr.classList.remove('search-hidden');
            else hdr.classList.add('search-hidden');
        });
        
        countEl.textContent = matchCount + ' of 67';
    }
    
    function clearSearch() {
        document.getElementById('searchInput').value = '';
        searchCalcs();
        document.getElementById('searchInput').focus();
    }

    // ==================== CARD TOGGLE ====================
    function toggleCard(num) {
        const card = document.getElementById('card' + num);
        const wasOpen = card.classList.contains('open');
        
        // Close all cards
        document.querySelectorAll('.card').forEach(c => c.classList.remove('open'));
        
        // Open clicked card if it wasn't open
        if (!wasOpen) {
            card.classList.add('open');
            currentCard = num;
            updateNav();
            // Scroll to card
            setTimeout(() => {
                card.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }
        
        vibrate();
    }
    
    function goToCard(num) {
        const card = document.getElementById('card' + num);
        document.querySelectorAll('.card').forEach(c => c.classList.remove('open'));
        card.classList.add('open');
        currentCard = num;
        updateNav();
        card.scrollIntoView({ behavior: 'smooth', block: 'start' });
        vibrate();
    }
    
    function updateNav() {
        document.querySelectorAll('.nav-btn').forEach((btn, i) => {
            btn.classList.toggle('active', i + 1 === currentCard);
        });
    }

    // ==================== HAPTIC FEEDBACK ====================
    function vibrate() {
        if (navigator.vibrate) navigator.vibrate(10);
    }

    // ==================== TOAST ====================
    function showToast(message, type = '') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'toast show ' + type;
        setTimeout(() => toast.classList.remove('show'), 2000);
    }

    // ==================== COPY ====================
    function copyVal(id) {
        const text = document.getElementById(id).innerText;
        navigator.clipboard.writeText(text).then(() => {
            showToast('‚úì Copied: ' + text, 'success');
            vibrate();
        });
    }

    // ==================== CLEAR ALL ====================
    function clearAll() {
        if (confirm('Clear all values?')) {
            inputIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.value = '';
                    el.classList.remove('error');
                }
            });
            localStorage.removeItem(STORAGE_KEY);
            // Reset all results
            document.getElementById('p_res').innerText = '0.00 lbs/day';
            document.getElementById('svi_res').innerText = '0.00 mL/g';
            document.getElementById('mb_res').innerText = '0.00 mg/L';
            document.getElementById('fm_res').innerText = '0.000';
            document.getElementById('srt_res').innerText = '0.0 days';
            document.getElementById('dt_res').innerText = '0.00 hours';
            document.getElementById('eff_res').innerText = '0.0 %';
            document.getElementById('was_res').innerText = '0 GPD';
            document.getElementById('ras_res').innerText = '0.00 MGD';
            document.getElementById('olr_res').innerText = '0.0 lbs/day/1000ft¬≥';
            document.getElementById('sor_res').innerText = '0 GPD/ft¬≤';
            document.getElementById('wor_res').innerText = '0 GPD/ft';
            document.getElementById('slr_res').innerText = '0.0 lbs/day/ft¬≤';
            document.getElementById('chem_res').innerText = '0.00 lbs/day';
            document.getElementById('flux_res').innerText = '0.0 GFD';
            document.getElementById('tmp_res').innerText = '0.0 psi';
            document.getElementById('perm_res').innerText = '0.0 GFD/psi';
            document.getElementById('msize_res').innerText = '0 ft¬≤';
            document.getElementById('sad_res').innerText = '‚Äî';
            document.getElementById('mbrc_res').innerText = '‚Äî';
            document.getElementById('cip_res').innerText = '‚Äî';
            document.getElementById('salr_res').innerText = '0.0 g/m¬≤/d';
            document.getElementById('bio_res').innerText = '0 m¬≤';
            document.getElementById('mv_res').innerText = '0 m¬≥';
            document.getElementById('rsz_res').innerText = '0 m¬≥';
            document.getElementById('mdo_res').innerText = '0 lbs O‚ÇÇ/day';
            document.getElementById('cmp_res').innerText = '‚Äî';
            document.getElementById('cyc_res').innerText = '‚Äî';
            document.getElementById('sv_res').innerText = '‚Äî';
            document.getElementById('dec_res').innerText = '0 GPM';
            document.getElementById('saer_res').innerText = '‚Äî';
            document.getElementById('sfm_res').innerText = '‚Äî';
            document.getElementById('ssc_res').innerText = '‚Äî';
            document.getElementById('ct_res').innerText = '0.0 mg¬∑min/L';
            document.getElementById('dcl_res').innerText = '‚Äî';
            document.getElementById('uv_res').innerText = '0.0 mJ/cm¬≤';
            document.getElementById('slv_res').innerText = '‚Äî';
            document.getElementById('vsr_res').innerText = '0.0 %';
            document.getElementById('dig_res').innerText = '0.00 lbs VS/ft¬≥/d';
            document.getElementById('poly_res').innerText = '‚Äî';
            document.getElementById('phos_res').innerText = '‚Äî';
            document.getElementById('alk_res').innerText = '‚Äî';
            document.getElementById('nb_res').innerText = '‚Äî';
            document.getElementById('tdh_res').innerText = '0.0 ft';
            document.getElementById('pv_res').innerText = '0.0 fps';
            document.getElementById('hp_res').innerText = '‚Äî';
            document.getElementById('gm_res').innerText = '‚Äî';
            document.getElementById('fw_res').innerText = '‚Äî';
            document.getElementById('man_res').innerText = '‚Äî';
            document.getElementById('ww_res').innerText = '‚Äî';
            document.getElementById('ii_res').innerText = '‚Äî';
            document.getElementById('hz_res').innerText = '‚Äî';
            document.getElementById('weir_res').innerText = '‚Äî';
            document.getElementById('av_res').innerText = '‚Äî';
            document.getElementById('nrc_res').innerText = '‚Äî';
            document.getElementById('tfl_res').innerText = '‚Äî';
            document.getElementById('pnd_res').innerText = '‚Äî';
            document.getElementById('ao_res').innerText = '‚Äî';
            document.getElementById('dil_res').innerText = '‚Äî';
            document.getElementById('pe_res').innerText = '‚Äî';
            document.getElementById('pe_report').style.display = 'none';
            document.getElementById('pe_report_btn').style.display = 'none';
            document.getElementById('pf_res').innerText = '‚Äî';
            document.getElementById('tv_res').innerText = '‚Äî';
            document.getElementById('hrt_res').innerText = '‚Äî';
            document.getElementById('bl_res').innerText = '‚Äî';
            document.getElementById('pan_res').innerText = '‚Äî';
            document.getElementById('la_res').innerText = '‚Äî';
            // Reset statuses
            document.querySelectorAll('.status').forEach(s => {
                s.innerText = 'Enter data...';
                s.style.color = '#64748b';
            });
            // Reset hints
            document.querySelectorAll('.field-hint').forEach(h => h.classList.remove('error'));
            const sviHint = document.getElementById('svi_set_hint');
            if (sviHint) sviHint.textContent = 'Max 1000 mL/L';
            
            showToast('‚úì All cleared', 'success');
            vibrate();
        }
    }

    // ==================== SAVE/RESTORE ====================
    function saveData() {
        const data = {};
        inputIds.forEach(id => {
            const el = document.getElementById(id);
            if (el && el.value) data[id] = el.value;
        });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }
    
    function restoreData() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            const data = JSON.parse(saved);
            inputIds.forEach(id => {
                const el = document.getElementById(id);
                if (el && data[id]) el.value = data[id];
            });
            // Trigger all calculations
            calcPounds(); calcSVI(); calcMB(); calcFM(); calcSRT(); calcDT(); calcEff();
            calcWAS(); calcRAS(); calcOLR(); calcSOR(); calcWOR(); calcSLR(); calcChem();
            calcFlux();
            calcTMP();
            calcPerm();
            calcMSize();
            calcSAD();
            calcMBRC();
            calcCIP();
            calcSALR(); calcBioArea(); calcMediaVol(); calcRSZ(); calcMDO(); calcCMP();
            calcCycle(); calcSBRVol(); calcDecant(); calcSBRAer(); calcSBRFM(); calcSSC();
            calcCT(); calcDCL(); calcUV();
            calcSLV(); calcVSR(); calcDIG(); calcPoly();
            calcPhos(); calcALK(); calcNBal();
            calcTDH(); calcPV(); calcHP();
            calcGM(); calcFWC();
            calcManning(); calcWetWell(); calcII(); calcHazen();
            calcWeir(); calcAV();
            calcNRC(); calcTFL();
            calcPond(); calcAOTR(); calcDilute(); calcPE();
            calcParshall(); calcTankVol(); calcPondHRT(); calcBlower(); calcPAN(); calcLandApp();
        }
    }
    
    // Auto-save on input with debounce
    let saveTimeout;
    document.addEventListener('input', () => {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(saveData, 500);
    });

    // ==================== VALIDATION ====================
    function validateInput(inputId, value, min, max, defaultHint) {
        const input = document.getElementById(inputId);
        const hintEl = document.getElementById(inputId + '_hint');
        
        if (value > max) {
            input.classList.add('error');
            if (hintEl) {
                hintEl.classList.add('error');
                hintEl.textContent = '‚ö†Ô∏è Max is ' + max;
            }
            vibrate();
            return false;
        } else if (value < min) {
            input.classList.add('error');
            if (hintEl) {
                hintEl.classList.add('error');
                hintEl.textContent = '‚ö†Ô∏è Min is ' + min;
            }
            vibrate();
            return false;
        } else {
            input.classList.remove('error');
            if (hintEl) {
                hintEl.classList.remove('error');
                hintEl.textContent = defaultHint;
            }
            return true;
        }
    }

    // ==================== CALCULATIONS ====================
    
    // 1. Pounds Formula
    function calcPounds() {
        const f = parseFloat(document.getElementById('p_flow').value) || 0;
        const c = parseFloat(document.getElementById('p_conc').value) || 0;
        const res = f * c * 8.34;
        document.getElementById('p_res').innerText = res.toFixed(2) + " lbs/day";
        const stat = document.getElementById('p_status');
        if (f > 0 && c > 0) {
            stat.innerHTML = "üìä <b>" + (c * 8.34).toFixed(1) + " lbs per MG</b> at this concentration";
            stat.style.color = "#94a3b8";
        } else {
            stat.innerText = "Enter data...";
            stat.style.color = "#64748b";
        }
    }

    // 2. SVI with validation
    function calcSVI() {
        const s = parseFloat(document.getElementById('svi_set').value) || 0;
        const m = parseFloat(document.getElementById('svi_mlss').value) || 0;
        
        // Validate settled volume (max 1000 mL/L for a settleometer)
        const valid = validateInput('svi_set', s, 0, 1000, 'Max 1000 mL/L');
        
        if (m > 0 && valid) {
            const res = (s * 1000) / m;
            document.getElementById('svi_res').innerText = res.toFixed(2) + " mL/g";
            const stat = document.getElementById('svi_status');
            
            if (res > 250) { 
                stat.innerHTML = "üö® <b>Severe Bulking</b> ‚Äì Check for Nocardia/M. parvicella. Consider RAS chlorination, reduce SRT."; 
                stat.style.color = "var(--danger)"; 
            } else if (res > 150) { 
                stat.innerHTML = "‚ö†Ô∏è <b>Bulking Sludge</b> ‚Äì Review F/M, DO levels, nutrient balance. Increase wasting."; 
                stat.style.color = "var(--accent)"; 
            } else if (res < 50) { 
                stat.innerHTML = "‚ö° <b>Pin Floc/Dispersed</b> ‚Äì Old sludge or toxic shock. Reduce SRT."; 
                stat.style.color = "var(--accent)"; 
            } else if (res < 80) { 
                stat.innerHTML = "‚ö° <b>Fast Settling</b> ‚Äì Monitor for pin floc. May indicate over-wasting."; 
                stat.style.color = "var(--primary)"; 
            } else { 
                stat.innerHTML = "‚úì <b>Optimal (80-150)</b> ‚Äì Good floc formation. Maintain operations."; 
                stat.style.color = "#4ade80"; 
            }
        } else if (!valid) {
            document.getElementById('svi_status').innerHTML = "‚ö†Ô∏è <b>Check Input</b> ‚Äì Settled volume cannot exceed 1000 mL/L";
            document.getElementById('svi_status').style.color = "var(--danger)";
        }
    }

    // 3. Mass Balance
    function calcMB() {
        const qa = parseFloat(document.getElementById('mb_qa').value) || 0;
        const ca = parseFloat(document.getElementById('mb_ca').value) || 0;
        const qb = parseFloat(document.getElementById('mb_qb').value) || 0;
        const cb = parseFloat(document.getElementById('mb_cb').value) || 0;
        
        if ((qa + qb) > 0) {
            const res = ((qa * ca) + (qb * cb)) / (qa + qb);
            document.getElementById('mb_res').innerText = res.toFixed(2) + " mg/L";
            const stat = document.getElementById('mb_status');
            const ratioA = (qa / (qa + qb) * 100).toFixed(0);
            const ratioB = (qb / (qa + qb) * 100).toFixed(0);
            stat.innerHTML = "üìä <b>Flow Mix:</b> A = " + ratioA + "% | B = " + ratioB + "%";
            stat.style.color = "#94a3b8";
        }
    }

    // 4. F/M Ratio
    function calcFM() {
        const flow = parseFloat(document.getElementById('fm_flow').value) || 0;
        const bod = parseFloat(document.getElementById('fm_bod').value) || 0;
        const vol = parseFloat(document.getElementById('fm_vol').value) || 0;
        const mlvss = parseFloat(document.getElementById('fm_mlvss').value) || 0;
        
        if (vol > 0 && mlvss > 0) {
            const res = (flow * bod) / (vol * mlvss);
            document.getElementById('fm_res').innerText = res.toFixed(3);
            const stat = document.getElementById('fm_status');
            
            if (res < 0.02) { 
                stat.innerHTML = "üö® <b>Starvation</b> ‚Äì Bacteria consuming themselves. Reduce MLSS."; 
                stat.style.color = "var(--danger)"; 
            } else if (res < 0.05) { 
                stat.innerHTML = "‚ö†Ô∏è <b>Very Low</b> ‚Äì Watch for old sludge, denitrification in clarifier."; 
                stat.style.color = "var(--accent)"; 
            } else if (res <= 0.15) { 
                stat.innerHTML = "‚úì <b>Extended Aeration (0.05-0.15)</b> ‚Äì Good nitrification potential."; 
                stat.style.color = "#4ade80"; 
            } else if (res <= 0.5) { 
                stat.innerHTML = "‚úì <b>Conventional (0.15-0.5)</b> ‚Äì Standard activated sludge."; 
                stat.style.color = "#4ade80"; 
            } else if (res <= 1.0) { 
                stat.innerHTML = "‚ö° <b>High Rate (0.5-1.0)</b> ‚Äì Short SRT, high sludge yield."; 
                stat.style.color = "var(--accent)"; 
            } else { 
                stat.innerHTML = "üö® <b>Overloaded (>1.0)</b> ‚Äì BOD breakthrough risk. Increase MLSS."; 
                stat.style.color = "var(--danger)"; 
            }
        }
    }

    // 5. SRT
    function calcSRT() {
        const vol = parseFloat(document.getElementById('srt_vol').value) || 0;
        const mlss = parseFloat(document.getElementById('srt_mlss').value) || 0;
        const wasQ = parseFloat(document.getElementById('srt_wasq').value) || 0;
        const wasC = parseFloat(document.getElementById('srt_wasc').value) || 0;
        const effQ = parseFloat(document.getElementById('srt_effq').value) || 0;
        const effC = parseFloat(document.getElementById('srt_effc').value) || 0;
        
        const sludgeIn = vol * mlss * 8.34;
        const sludgeOut = (wasQ * wasC * 8.34) + (effQ * effC * 8.34);
        
        if (sludgeOut > 0) {
            const res = sludgeIn / sludgeOut;
            document.getElementById('srt_res').innerText = res.toFixed(1) + " days";
            const stat = document.getElementById('srt_status');
            
            if (res < 2) { 
                stat.innerHTML = "üö® <b>Washout Risk</b> ‚Äì Reduce WAS immediately!"; 
                stat.style.color = "var(--danger)"; 
            } else if (res < 4) { 
                stat.innerHTML = "‚ö†Ô∏è <b>Low (2-4 days)</b> ‚Äì Young sludge, limited nitrification."; 
                stat.style.color = "var(--accent)"; 
            } else if (res < 8) { 
                stat.innerHTML = "‚úì <b>Conventional (4-8 days)</b> ‚Äì Good BOD removal."; 
                stat.style.color = "#4ade80"; 
            } else if (res <= 15) { 
                stat.innerHTML = "‚úì <b>Extended (8-15 days)</b> ‚Äì Full nitrification, stable."; 
                stat.style.color = "#4ade80"; 
            } else if (res <= 25) { 
                stat.innerHTML = "‚ö° <b>Long (15-25 days)</b> ‚Äì Watch for old sludge issues."; 
                stat.style.color = "var(--primary)"; 
            } else { 
                stat.innerHTML = "‚ö†Ô∏è <b>Excessive (>25 days)</b> ‚Äì Increase wasting."; 
                stat.style.color = "var(--accent)"; 
            }
        }
    }

    // 6. Detention Time
    function calcDT() {
        const vol = parseFloat(document.getElementById('dt_vol').value) || 0;
        const flow = parseFloat(document.getElementById('dt_flow').value) || 0;
        
        if (flow > 0) {
            const res = (vol / flow) * 24;
            document.getElementById('dt_res').innerText = res.toFixed(2) + " hours";
            const stat = document.getElementById('dt_status');
            
            if (res < 2) { 
                stat.innerHTML = "‚ö° <b>Very Short (<2 hrs)</b> ‚Äì Contact tank or high-rate process."; 
                stat.style.color = "var(--accent)"; 
            } else if (res < 4) { 
                stat.innerHTML = "‚úì <b>Clarifier Range (2-4 hrs)</b> ‚Äì Typical for secondary clarifiers."; 
                stat.style.color = "#4ade80"; 
            } else if (res < 8) { 
                stat.innerHTML = "‚úì <b>Conventional (4-8 hrs)</b> ‚Äì Standard aeration basin."; 
                stat.style.color = "#4ade80"; 
            } else if (res <= 24) { 
                stat.innerHTML = "‚úì <b>Extended (8-24 hrs)</b> ‚Äì Good for nitrification."; 
                stat.style.color = "#4ade80"; 
            } else if (res <= 48) { 
                stat.innerHTML = "‚ö° <b>Long (24-48 hrs)</b> ‚Äì EQ basin or oxidation ditch."; 
                stat.style.color = "var(--primary)"; 
            } else { 
                stat.innerHTML = "‚ö†Ô∏è <b>Very Long (>48 hrs)</b> ‚Äì Lagoon range."; 
                stat.style.color = "var(--accent)"; 
            }
        }
    }

    // 7. Removal Efficiency
    function calcEff() {
        const inf = parseFloat(document.getElementById('eff_in').value) || 0;
        const eff = parseFloat(document.getElementById('eff_out').value) || 0;
        
        if (inf > 0) {
            const res = ((inf - eff) / inf) * 100;
            document.getElementById('eff_res').innerText = res.toFixed(1) + " %";
            const stat = document.getElementById('eff_status');
            
            if (res >= 95) { 
                stat.innerHTML = "üåü <b>Excellent (‚â•95%)</b> ‚Äì Outstanding performance."; 
                stat.style.color = "#4ade80"; 
            } else if (res >= 90) { 
                stat.innerHTML = "‚úì <b>Very Good (90-95%)</b> ‚Äì Exceeds most permits."; 
                stat.style.color = "#4ade80"; 
            } else if (res >= 85) { 
                stat.innerHTML = "‚úì <b>Good (85-90%)</b> ‚Äì Meeting standard goals."; 
                stat.style.color = "#4ade80"; 
            } else if (res >= 75) { 
                stat.innerHTML = "‚ö° <b>Moderate (75-85%)</b> ‚Äì Review for optimization."; 
                stat.style.color = "var(--accent)"; 
            } else if (res >= 50) { 
                stat.innerHTML = "‚ö†Ô∏è <b>Below Target (50-75%)</b> ‚Äì Investigate cause."; 
                stat.style.color = "var(--danger)"; 
            } else if (res >= 0) { 
                stat.innerHTML = "üö® <b>Poor (<50%)</b> ‚Äì Process upset likely."; 
                stat.style.color = "var(--danger)"; 
            } else { 
                stat.innerHTML = "üö® <b>Negative</b> ‚Äì Effluent worse than influent!"; 
                stat.style.color = "var(--danger)"; 
            }
        }
    }

    // 8. WAS Pumping Rate
    function calcWAS() {
        const vol = parseFloat(document.getElementById('was_vol').value) || 0;
        const mlss = parseFloat(document.getElementById('was_mlss').value) || 0;
        const srt = parseFloat(document.getElementById('was_srt').value) || 0;
        const conc = parseFloat(document.getElementById('was_conc').value) || 0;
        
        if (srt > 0 && conc > 0) {
            // WAS Flow (MG) = (Vol √ó MLSS) √∑ (SRT √ó WAS Conc)
            const wasMGD = (vol * mlss) / (srt * conc);
            const wasGPD = wasMGD * 1000000;
            document.getElementById('was_res').innerText = wasGPD.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPD";
            const stat = document.getElementById('was_status');
            const wasGPM = wasGPD / 1440;
            stat.innerHTML = "üìä <b>" + wasGPM.toFixed(1) + " GPM</b> continuous, or <b>" + (wasGPM * 2).toFixed(1) + " GPM</b> for 12 hrs/day";
            stat.style.color = "#94a3b8";
        }
    }

    // 9. RAS Return Rate
    function calcRAS() {
        const flow = parseFloat(document.getElementById('ras_flow').value) || 0;
        const mlss = parseFloat(document.getElementById('ras_mlss').value) || 0;
        const conc = parseFloat(document.getElementById('ras_conc').value) || 0;
        
        if (conc > mlss && conc > 0) {
            // RAS = (Q √ó MLSS) √∑ (RAS Conc - MLSS)
            const ras = (flow * mlss) / (conc - mlss);
            document.getElementById('ras_res').innerText = ras.toFixed(3) + " MGD";
            const stat = document.getElementById('ras_status');
            const ratio = (ras / flow * 100).toFixed(0);
            if (ratio < 25) {
                stat.innerHTML = "‚ö° <b>" + ratio + "% RAS Ratio</b> ‚Äì Low return rate. Verify blanket depth.";
                stat.style.color = "var(--accent)";
            } else if (ratio <= 100) {
                stat.innerHTML = "‚úì <b>" + ratio + "% RAS Ratio</b> ‚Äì Normal operating range (25-100%).";
                stat.style.color = "#4ade80";
            } else {
                stat.innerHTML = "‚ö†Ô∏è <b>" + ratio + "% RAS Ratio</b> ‚Äì High return. Check RAS concentration.";
                stat.style.color = "var(--accent)";
            }
        } else if (conc <= mlss && conc > 0) {
            document.getElementById('ras_status').innerHTML = "‚ö†Ô∏è <b>Check Values</b> ‚Äì RAS conc must be higher than MLSS";
            document.getElementById('ras_status').style.color = "var(--danger)";
        }
    }

    // 10. Organic Loading Rate
    function calcOLR() {
        const flow = parseFloat(document.getElementById('olr_flow').value) || 0;
        const bod = parseFloat(document.getElementById('olr_bod').value) || 0;
        const vol = parseFloat(document.getElementById('olr_vol').value) || 0;
        
        if (vol > 0) {
            // OLR = (Flow √ó BOD √ó 8.34) √∑ Volume (1000 ft¬≥)
            const olr = (flow * bod * 8.34) / vol;
            document.getElementById('olr_res').innerText = olr.toFixed(1) + " lbs/day/1000ft¬≥";
            const stat = document.getElementById('olr_status');
            
            if (olr < 5) {
                stat.innerHTML = "‚ö° <b>Low Rate (<5)</b> ‚Äì Under-loaded, may have operational issues.";
                stat.style.color = "var(--accent)";
            } else if (olr <= 25) {
                stat.innerHTML = "‚úì <b>Low-Rate TF (5-25)</b> ‚Äì Standard trickling filter range.";
                stat.style.color = "#4ade80";
            } else if (olr <= 100) {
                stat.innerHTML = "‚úì <b>High-Rate TF (25-100)</b> ‚Äì Higher loading, needs recirculation.";
                stat.style.color = "#4ade80";
            } else if (olr <= 300) {
                stat.innerHTML = "‚ö° <b>Roughing Filter (100-300)</b> ‚Äì Very high rate, partial treatment only.";
                stat.style.color = "var(--accent)";
            } else {
                stat.innerHTML = "‚ö†Ô∏è <b>Overloaded (>300)</b> ‚Äì Exceeds typical design limits.";
                stat.style.color = "var(--danger)";
            }
        }
    }

    // 11. Surface Overflow Rate
    function calcSOR() {
        const flow = parseFloat(document.getElementById('sor_flow').value) || 0;
        const area = parseFloat(document.getElementById('sor_area').value) || 0;
        
        if (area > 0) {
            const sor = flow / area;
            document.getElementById('sor_res').innerText = sor.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPD/ft¬≤";
            const stat = document.getElementById('sor_status');
            
            if (sor < 300) {
                stat.innerHTML = "‚ö° <b>Very Low (<300)</b> ‚Äì Under-utilized clarifier.";
                stat.style.color = "var(--primary)";
            } else if (sor <= 600) {
                stat.innerHTML = "‚úì <b>Primary SOR (300-600)</b> ‚Äì Good for primary settling.";
                stat.style.color = "#4ade80";
            } else if (sor <= 800) {
                stat.innerHTML = "‚úì <b>Secondary SOR (400-800)</b> ‚Äì Typical for activated sludge.";
                stat.style.color = "#4ade80";
            } else if (sor <= 1200) {
                stat.innerHTML = "‚ö†Ô∏è <b>High (800-1200)</b> ‚Äì Peak flow range. Monitor effluent TSS.";
                stat.style.color = "var(--accent)";
            } else {
                stat.innerHTML = "üö® <b>Overloaded (>1200)</b> ‚Äì Risk of solids carryover.";
                stat.style.color = "var(--danger)";
            }
        }
    }

    // 12. Weir Overflow Rate
    function calcWOR() {
        const flow = parseFloat(document.getElementById('wor_flow').value) || 0;
        const len = parseFloat(document.getElementById('wor_len').value) || 0;
        
        if (len > 0) {
            const wor = flow / len;
            document.getElementById('wor_res').innerText = wor.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPD/ft";
            const stat = document.getElementById('wor_status');
            
            if (wor <= 10000) {
                stat.innerHTML = "‚úì <b>Excellent (‚â§10,000)</b> ‚Äì Low turbulence, good settling.";
                stat.style.color = "#4ade80";
            } else if (wor <= 15000) {
                stat.innerHTML = "‚úì <b>Good (10,000-15,000)</b> ‚Äì Acceptable for most clarifiers.";
                stat.style.color = "#4ade80";
            } else if (wor <= 20000) {
                stat.innerHTML = "‚ö†Ô∏è <b>High (15,000-20,000)</b> ‚Äì May cause turbulence. Monitor TSS.";
                stat.style.color = "var(--accent)";
            } else {
                stat.innerHTML = "üö® <b>Excessive (>20,000)</b> ‚Äì Risk of floc disruption and carryover.";
                stat.style.color = "var(--danger)";
            }
        }
    }

    // 13. Solids Loading Rate
    function calcSLR() {
        const flow = parseFloat(document.getElementById('slr_flow').value) || 0;
        const mlss = parseFloat(document.getElementById('slr_mlss').value) || 0;
        const area = parseFloat(document.getElementById('slr_area').value) || 0;
        
        if (area > 0) {
            // SLR = (Flow √ó MLSS √ó 8.34) √∑ Area
            const slr = (flow * mlss * 8.34) / area;
            document.getElementById('slr_res').innerText = slr.toFixed(2) + " lbs/day/ft¬≤";
            const stat = document.getElementById('slr_status');
            
            if (slr < 10) {
                stat.innerHTML = "‚ö° <b>Low (<10)</b> ‚Äì Under-loaded clarifier. Good settling expected.";
                stat.style.color = "var(--primary)";
            } else if (slr <= 25) {
                stat.innerHTML = "‚úì <b>Normal (10-25)</b> ‚Äì Typical for secondary clarifiers.";
                stat.style.color = "#4ade80";
            } else if (slr <= 35) {
                stat.innerHTML = "‚ö†Ô∏è <b>High (25-35)</b> ‚Äì Peak flow range. Watch blanket depth.";
                stat.style.color = "var(--accent)";
            } else {
                stat.innerHTML = "üö® <b>Overloaded (>35)</b> ‚Äì Risk of solids loss. Reduce RAS or increase area.";
                stat.style.color = "var(--danger)";
            }
        }
    }

    // 14. Chemical Dosing
    function calcChem() {
        const flow = parseFloat(document.getElementById('chem_flow').value) || 0;
        const dose = parseFloat(document.getElementById('chem_dose').value) || 0;
        const purity = parseFloat(document.getElementById('chem_purity').value) || 100;
        
        if (purity > 0) {
            // lbs/day = (Flow √ó Dose √ó 8.34) √∑ (Purity/100)
            const lbs = (flow * dose * 8.34) / (purity / 100);
            document.getElementById('chem_res').innerText = lbs.toFixed(2) + " lbs/day";
            const stat = document.getElementById('chem_status');
            const gallons = lbs / 8.34; // Approximate for liquids
            stat.innerHTML = "üìä <b>" + lbs.toFixed(1) + " lbs/day</b> of chemical product | ~" + gallons.toFixed(1) + " gal/day if liquid";
            stat.style.color = "#94a3b8";
        }
    }

    // ==================== MBR CALCULATIONS ====================

    // 15. Membrane Flux Rate
    function calcFlux() {
        const flow = parseFloat(document.getElementById('flux_flow').value) || 0;
        const area = parseFloat(document.getElementById('flux_area').value) || 0;
        
        if (area > 0) {
            const gfd = flow / area;
            document.getElementById('flux_res').innerText = gfd.toFixed(1) + " GFD";
            const stat = document.getElementById('flux_status');
            
            // Also show LMH for international reference
            const lmh = gfd * 1.6985;
            
            if (gfd < 5) {
                stat.innerHTML = "üö® <b>Very Low (<5 GFD)</b> ‚Äì Severe fouling likely. Initiate recovery clean (CIP). Check TMP.";
                stat.style.color = "var(--danger)";
            } else if (gfd < 8) {
                stat.innerHTML = "‚ö†Ô∏è <b>Low (5‚Äì8 GFD)</b> ‚Äì Fouling developing. Schedule maintenance clean. (" + lmh.toFixed(1) + " LMH)";
                stat.style.color = "var(--accent)";
            } else if (gfd <= 15) {
                stat.innerHTML = "‚úì <b>Normal (8‚Äì15 GFD)</b> ‚Äì Healthy operating range. (" + lmh.toFixed(1) + " LMH)";
                stat.style.color = "#4ade80";
            } else if (gfd <= 25) {
                stat.innerHTML = "‚ö° <b>High (15‚Äì25 GFD)</b> ‚Äì Peak flow range acceptable short-term. (" + lmh.toFixed(1) + " LMH)";
                stat.style.color = "var(--accent)";
            } else {
                stat.innerHTML = "üö® <b>Excessive (>25 GFD)</b> ‚Äì Risk of irreversible membrane damage. Reduce flow immediately.";
                stat.style.color = "var(--danger)";
            }
        }
    }

    // 16. Transmembrane Pressure
    function calcTMP() {
        const feed = parseFloat(document.getElementById('tmp_feed').value) || 0;
        const perm = parseFloat(document.getElementById('tmp_perm').value) || 0;
        
        if (feed > 0 || perm > 0) {
            const tmp = feed - perm;
            const kpa = tmp * 6.895;
            document.getElementById('tmp_res').innerText = tmp.toFixed(1) + " psi";
            const stat = document.getElementById('tmp_status');
            
            if (tmp < 0) {
                stat.innerHTML = "‚ö†Ô∏è <b>Negative TMP</b> ‚Äì Check pressure gauge readings. Feed should be > Permeate.";
                stat.style.color = "var(--danger)";
            } else if (tmp <= 3) {
                stat.innerHTML = "‚úì <b>Excellent (0‚Äì3 psi)</b> ‚Äì Clean membranes, low resistance. (" + kpa.toFixed(1) + " kPa)";
                stat.style.color = "#4ade80";
            } else if (tmp <= 7) {
                stat.innerHTML = "‚úì <b>Normal (3‚Äì7 psi)</b> ‚Äì Typical operating range. Monitor trend. (" + kpa.toFixed(1) + " kPa)";
                stat.style.color = "#4ade80";
            } else if (tmp <= 12) {
                stat.innerHTML = "‚ö†Ô∏è <b>Elevated (7‚Äì12 psi)</b> ‚Äì Fouling developing. Schedule maintenance clean. (" + kpa.toFixed(1) + " kPa)";
                stat.style.color = "var(--accent)";
            } else {
                stat.innerHTML = "üö® <b>High (>12 psi)</b> ‚Äì Recovery CIP required. Risk of membrane damage if sustained. (" + kpa.toFixed(1) + " kPa)";
                stat.style.color = "var(--danger)";
            }
        }
    }

    // 17. Membrane Permeability
    function calcPerm() {
        const flux = parseFloat(document.getElementById('perm_flux').value) || 0;
        const tmp = parseFloat(document.getElementById('perm_tmp').value) || 0;
        
        if (tmp > 0) {
            const perm = flux / tmp;
            const lmhBar = perm * 1.6985 / 0.0689476; // Convert GFD/psi to LMH/bar
            document.getElementById('perm_res').innerText = perm.toFixed(2) + " GFD/psi";
            const stat = document.getElementById('perm_status');
            
            if (perm >= 5) {
                stat.innerHTML = "‚úì <b>Excellent (‚â•5)</b> ‚Äì Clean membrane performance. (" + lmhBar.toFixed(1) + " LMH/bar)";
                stat.style.color = "#4ade80";
            } else if (perm >= 3) {
                stat.innerHTML = "‚úì <b>Good (3‚Äì5)</b> ‚Äì Normal operating condition. (" + lmhBar.toFixed(1) + " LMH/bar)";
                stat.style.color = "#4ade80";
            } else if (perm >= 1.5) {
                stat.innerHTML = "‚ö†Ô∏è <b>Declining (1.5‚Äì3)</b> ‚Äì Fouling progressing. Plan maintenance clean. (" + lmhBar.toFixed(1) + " LMH/bar)";
                stat.style.color = "var(--accent)";
            } else {
                stat.innerHTML = "üö® <b>Poor (<1.5)</b> ‚Äì Significant fouling. Recovery CIP required. (" + lmhBar.toFixed(1) + " LMH/bar)";
                stat.style.color = "var(--danger)";
            }
        } else if (flux > 0 && tmp === 0) {
            document.getElementById('perm_status').innerHTML = "‚ö†Ô∏è TMP cannot be zero ‚Äî enter measured pressure.";
            document.getElementById('perm_status').style.color = "var(--danger)";
        }
    }

    // 18. Membrane Area Sizing
    function calcMSize() {
        const flow = parseFloat(document.getElementById('msize_flow').value) || 0;
        const pf = parseFloat(document.getElementById('msize_pf').value) || 0;
        const avgFlux = parseFloat(document.getElementById('msize_flux').value) || 0;
        const peakFlux = parseFloat(document.getElementById('msize_peak').value) || 0;
        
        if (flow > 0 && avgFlux > 0) {
            const flowGPD = flow * 1000000;
            const areaAvg = flowGPD / avgFlux;
            let areaPeak = 0;
            let peakCheck = "";
            
            if (pf > 0 && peakFlux > 0) {
                areaPeak = (flowGPD * pf) / peakFlux;
                const actualPeakFlux = (flowGPD * pf) / areaAvg;
                if (actualPeakFlux > 25) {
                    peakCheck = "<br>‚ö†Ô∏è Peak flux on avg-sized area = " + actualPeakFlux.toFixed(1) + " GFD ‚Äî exceeds 25 GFD limit!";
                } else {
                    peakCheck = "<br>‚úì Peak flux on avg-sized area = " + actualPeakFlux.toFixed(1) + " GFD ‚Äî within limits.";
                }
            }
            
            const designArea = Math.max(areaAvg, areaPeak);
            const fmt = designArea.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            document.getElementById('msize_res').innerText = fmt + " ft¬≤";
            const stat = document.getElementById('msize_status');
            
            stat.innerHTML = "üìä <b>Avg design:</b> " + areaAvg.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " ft¬≤" +
                (areaPeak > 0 ? " | <b>Peak design:</b> " + areaPeak.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " ft¬≤" : "") +
                peakCheck + "<br>Governing area: <b>" + fmt + " ft¬≤</b> (" + (designArea / 1000).toFixed(1) + "k ft¬≤)";
            stat.style.color = "#94a3b8";
        }
    }

    // 19. Specific Aeration Demand
    function calcSAD() {
        const air = parseFloat(document.getElementById('sad_air').value) || 0;
        const area = parseFloat(document.getElementById('sad_area').value) || 0;
        const perm = parseFloat(document.getElementById('sad_perm').value) || 0;
        
        if (air > 0 && (area > 0 || perm > 0)) {
            let results = [];
            let sadmVal = 0, sadpVal = 0;
            const stat = document.getElementById('sad_status');
            
            if (area > 0) {
                sadmVal = air / area;
                results.push("SADm = " + sadmVal.toFixed(3) + " Nm¬≥/m¬≤/hr");
            }
            if (perm > 0) {
                sadpVal = air / perm;
                results.push("SADp = " + sadpVal.toFixed(1) + " m¬≥air/m¬≥perm");
            }
            
            document.getElementById('sad_res').innerText = results.join(" | ");
            
            let assessment = [];
            if (sadmVal > 0) {
                if (sadmVal < 0.2) assessment.push("‚ö° SADm very low ‚Äî verify adequate scouring");
                else if (sadmVal <= 0.5) assessment.push("‚úì SADm in hollow fiber range (0.2‚Äì0.5)");
                else if (sadmVal <= 1.0) assessment.push("‚úì SADm in flat sheet range (0.5‚Äì1.0)");
                else assessment.push("‚ö†Ô∏è SADm high ‚Äî excessive air scouring energy");
            }
            if (sadpVal > 0) {
                if (sadpVal < 10) assessment.push("‚úì SADp efficient (<10)");
                else if (sadpVal <= 25) assessment.push("‚úì SADp typical (10‚Äì25)");
                else assessment.push("‚ö†Ô∏è SADp high (>25) ‚Äî energy optimization opportunity");
            }
            
            stat.innerHTML = assessment.join("<br>");
            stat.style.color = (sadmVal > 1.0 || sadpVal > 25) ? "var(--accent)" : "#4ade80";
        }
    }

    // 20. MBR Operating Range Check
    function calcMBRC() {
        const mlss = parseFloat(document.getElementById('mbrc_mlss').value) || 0;
        const srt = parseFloat(document.getElementById('mbrc_srt').value) || 0;
        const fm = parseFloat(document.getElementById('mbrc_fm').value) || 0;
        const doVal = parseFloat(document.getElementById('mbrc_do').value) || 0;
        
        let checks = [];
        let issues = 0;
        let entered = 0;
        
        if (mlss > 0) {
            entered++;
            if (mlss < 6000) { checks.push("üö® <b>MLSS " + mlss + "</b> ‚Äì Too low for MBR. Target 8,000‚Äì12,000 mg/L."); issues++; }
            else if (mlss < 8000) { checks.push("‚ö†Ô∏è <b>MLSS " + mlss + "</b> ‚Äì Below MBR range. May reduce membrane protection."); issues++; }
            else if (mlss <= 12000) { checks.push("‚úì <b>MLSS " + mlss + "</b> ‚Äì Within MBR range (8,000‚Äì12,000)."); }
            else if (mlss <= 15000) { checks.push("‚ö†Ô∏è <b>MLSS " + mlss + "</b> ‚Äì High. Increases viscosity & TMP."); issues++; }
            else { checks.push("üö® <b>MLSS " + mlss + "</b> ‚Äì Excessive. Rapid fouling risk. Increase wasting."); issues++; }
        }
        
        if (srt > 0) {
            entered++;
            if (srt < 10) { checks.push("üö® <b>SRT " + srt + "d</b> ‚Äì Too low for MBR. Target 15‚Äì40 days."); issues++; }
            else if (srt < 15) { checks.push("‚ö†Ô∏è <b>SRT " + srt + "d</b> ‚Äì Below typical MBR. May lose nitrifiers."); issues++; }
            else if (srt <= 40) { checks.push("‚úì <b>SRT " + srt + "d</b> ‚Äì Within MBR range (15‚Äì40 days)."); }
            else { checks.push("‚ö†Ô∏è <b>SRT " + srt + "d</b> ‚Äì Very high. Risk of EPS buildup & fouling."); issues++; }
        }
        
        if (fm > 0) {
            entered++;
            if (fm < 0.04) { checks.push("‚ö†Ô∏è <b>F:M " + fm + "</b> ‚Äì Very low. Endogenous conditions, possible pin floc."); issues++; }
            else if (fm <= 0.15) { checks.push("‚úì <b>F:M " + fm + "</b> ‚Äì Within MBR range (0.05‚Äì0.15)."); }
            else if (fm <= 0.25) { checks.push("‚ö†Ô∏è <b>F:M " + fm + "</b> ‚Äì High for MBR. More typical of CAS."); issues++; }
            else { checks.push("üö® <b>F:M " + fm + "</b> ‚Äì Exceeds MBR range. This is CAS territory (>0.2)."); issues++; }
        }
        
        if (doVal > 0) {
            entered++;
            if (doVal < 0.5) { checks.push("üö® <b>DO " + doVal + "</b> ‚Äì Critically low. Risk of filaments & poor nitrification."); issues++; }
            else if (doVal < 1.0) { checks.push("‚ö†Ô∏è <b>DO " + doVal + "</b> ‚Äì Below MBR minimum. Increase aeration."); issues++; }
            else if (doVal <= 3.0) { checks.push("‚úì <b>DO " + doVal + "</b> ‚Äì Within MBR range (1.0‚Äì3.0 mg/L)."); }
            else { checks.push("‚ö° <b>DO " + doVal + "</b> ‚Äì Higher than needed. Energy savings opportunity."); }
        }
        
        if (entered > 0) {
            const score = entered - issues;
            document.getElementById('mbrc_res').innerText = score + "/" + entered + " In Range";
            const stat = document.getElementById('mbrc_status');
            stat.innerHTML = checks.join("<br>");
            stat.style.color = issues === 0 ? "#4ade80" : (issues >= entered/2 ? "var(--danger)" : "var(--accent)");
        }
    }

    // 21. CIP Chemical Dosing
    function calcCIP() {
        const vol = parseFloat(document.getElementById('cip_vol').value) || 0;
        const naclTarget = parseFloat(document.getElementById('cip_nacl').value) || 0;
        const bleachPct = parseFloat(document.getElementById('cip_bleach').value) || 0;
        const citTarget = parseFloat(document.getElementById('cip_citric').value) || 0;
        const citPct = parseFloat(document.getElementById('cip_cstr').value) || 0;
        
        if (vol > 0) {
            let results = [];
            let details = [];
            const volLiters = vol * 3.785;
            
            // NaOCl calculation
            if (naclTarget > 0 && bleachPct > 0) {
                // Volume (gal) = (Tank gal √ó Target mg/L) √∑ (Strength% √ó 10,000)
                const naclGal = (vol * naclTarget) / (bleachPct * 10000);
                const naclOz = naclGal * 128;
                results.push("NaOCl: " + naclGal.toFixed(2) + " gal");
                
                let cleanType = "";
                if (naclTarget <= 500) cleanType = "Maintenance Clean range";
                else if (naclTarget <= 2000) cleanType = "Recovery Clean range";
                else cleanType = "‚ö†Ô∏è Exceeds typical ‚Äî verify with membrane manufacturer";
                
                details.push("üß™ <b>NaOCl:</b> " + naclGal.toFixed(2) + " gal (" + naclOz.toFixed(0) + " fl oz) of " + bleachPct + "% bleach ‚Üí " + naclTarget + " mg/L ‚Äî " + cleanType);
            }
            
            // Citric acid calculation
            if (citTarget > 0 && citPct > 0) {
                const citGal = (vol * citTarget) / (citPct * 10000);
                const citLbs = citGal * 8.34 * (citPct / 100);
                results.push("Citric: " + citGal.toFixed(2) + " gal");
                
                let cleanType = "";
                if (citTarget <= 2000) cleanType = "Maintenance Clean range";
                else if (citTarget <= 5000) cleanType = "Recovery Clean range";
                else cleanType = "‚ö†Ô∏è Exceeds typical ‚Äî verify dosage";
                
                details.push("üß™ <b>Citric Acid:</b> " + citGal.toFixed(2) + " gal of " + citPct + "% solution ‚Üí " + citTarget + " mg/L ‚Äî " + cleanType);
            }
            
            if (results.length > 0) {
                document.getElementById('cip_res').innerText = results.join(" | ");
                const stat = document.getElementById('cip_status');
                details.push("<br>‚ö†Ô∏è <b>Safety:</b> Never mix NaOCl and citric acid. Rinse between steps. Soak 4‚Äì6 hrs typical.");
                stat.innerHTML = details.join("<br>");
                stat.style.color = "#94a3b8";
            }
        }
    }

    // ==================== MBBR CALCULATIONS ====================

    // 22. Surface Area Loading Rate
    function calcSALR() {
        const flow = parseFloat(document.getElementById('salr_flow').value) || 0;
        const conc = parseFloat(document.getElementById('salr_conc').value) || 0;
        const area = parseFloat(document.getElementById('salr_area').value) || 0;
        
        if (area > 0 && flow > 0 && conc > 0) {
            // Load (g/day) = Flow (MGD) √ó Conc (mg/L) √ó 3,785,412 (L/MG) / 1000 (mg/g)
            // SALR = Load / Area
            const loadGday = flow * conc * 3785.412;
            const salr = loadGday / area;
            document.getElementById('salr_res').innerText = salr.toFixed(1) + " g/m¬≤/d";
            const stat = document.getElementById('salr_status');
            
            const loadLbs = flow * conc * 8.34;
            
            if (conc > 50) {
                // BOD loading interpretation
                if (salr < 5) {
                    stat.innerHTML = "‚ö° <b>Low SALR (<5)</b> ‚Äì Under-loaded biofilm. Media may be oversized. Load: " + loadLbs.toFixed(0) + " lbs/day";
                    stat.style.color = "var(--primary)";
                } else if (salr <= 10) {
                    stat.innerHTML = "‚úì <b>Moderate (5‚Äì10)</b> ‚Äì Conservative BOD removal. Good for cold climate. Load: " + loadLbs.toFixed(0) + " lbs/day";
                    stat.style.color = "#4ade80";
                } else if (salr <= 20) {
                    stat.innerHTML = "‚úì <b>Typical (10‚Äì20)</b> ‚Äì Standard BOD removal range. Load: " + loadLbs.toFixed(0) + " lbs/day";
                    stat.style.color = "#4ade80";
                } else {
                    stat.innerHTML = "‚ö†Ô∏è <b>High (>20)</b> ‚Äì May exceed biofilm capacity. Check effluent quality. Load: " + loadLbs.toFixed(0) + " lbs/day";
                    stat.style.color = "var(--accent)";
                }
            } else {
                // NH3 loading interpretation
                if (salr < 0.5) {
                    stat.innerHTML = "‚ö° <b>Low (<0.5)</b> ‚Äì Under-loaded for nitrification. Load: " + loadLbs.toFixed(1) + " lbs/day";
                    stat.style.color = "var(--primary)";
                } else if (salr <= 1.5) {
                    stat.innerHTML = "‚úì <b>Typical (0.5‚Äì1.5)</b> ‚Äì Standard nitrification range. Load: " + loadLbs.toFixed(1) + " lbs/day";
                    stat.style.color = "#4ade80";
                } else {
                    stat.innerHTML = "‚ö†Ô∏è <b>High (>1.5)</b> ‚Äì May need additional area for full nitrification. Load: " + loadLbs.toFixed(1) + " lbs/day";
                    stat.style.color = "var(--accent)";
                }
            }
        }
    }

    // 23. Effective Biofilm Area
    function calcBioArea() {
        const vol = parseFloat(document.getElementById('bio_vol').value) || 0;
        const fill = parseFloat(document.getElementById('bio_fill').value) || 0;
        const ssa = parseFloat(document.getElementById('bio_ssa').value) || 0;
        
        if (vol > 0 && fill > 0 && ssa > 0) {
            const volM3 = vol * 0.0283168; // ft¬≥ to m¬≥
            const mediaM3 = volM3 * (fill / 100);
            const area = mediaM3 * ssa;
            const fmt = area.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            document.getElementById('bio_res').innerText = fmt + " m¬≤";
            const stat = document.getElementById('bio_status');
            
            const areaFt2 = area * 10.764;
            
            let fillCheck = "";
            if (fill < 40) fillCheck = "‚ö†Ô∏è Fill below 40% ‚Äî under-utilizing reactor volume.";
            else if (fill <= 67) fillCheck = "‚úì Fill " + fill + "% within design range (40‚Äì67%).";
            else fillCheck = "üö® Fill " + fill + "% exceeds 67% max ‚Äî media cannot circulate properly!";
            
            stat.innerHTML = "üìä <b>" + fmt + " m¬≤</b> (" + areaFt2.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " ft¬≤) protected biofilm area" +
                "<br>Media volume: " + mediaM3.toFixed(1) + " m¬≥ (" + (mediaM3 * 35.3147).toFixed(0) + " ft¬≥)" +
                "<br>" + fillCheck;
            stat.style.color = fill > 67 ? "var(--danger)" : "#4ade80";
        }
    }

    // 24. Media Fill Volume
    function calcMediaVol() {
        const flow = parseFloat(document.getElementById('mv_flow').value) || 0;
        const conc = parseFloat(document.getElementById('mv_conc').value) || 0;
        const salr = parseFloat(document.getElementById('mv_salr').value) || 0;
        const ssa = parseFloat(document.getElementById('mv_ssa').value) || 0;
        
        if (flow > 0 && conc > 0 && salr > 0 && ssa > 0) {
            const loadGday = flow * conc * 3785.412;
            const reqArea = loadGday / salr;
            const mediaVol = reqArea / ssa;
            const mediaFt3 = mediaVol * 35.3147;
            document.getElementById('mv_res').innerText = mediaVol.toFixed(1) + " m¬≥";
            const stat = document.getElementById('mv_status');
            
            // Show reactor sizes at different fill fractions
            const r50 = mediaVol / 0.50;
            const r55 = mediaVol / 0.55;
            const r60 = mediaVol / 0.60;
            
            stat.innerHTML = "üìä Required biofilm area: <b>" + reqArea.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " m¬≤</b>" +
                "<br>Media volume: <b>" + mediaVol.toFixed(1) + " m¬≥</b> (" + mediaFt3.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " ft¬≥)" +
                "<br>Reactor needed @ 50% fill: " + r50.toFixed(1) + " m¬≥ | 55%: " + r55.toFixed(1) + " m¬≥ | 60%: " + r60.toFixed(1) + " m¬≥";
            stat.style.color = "#94a3b8";
        }
    }

    // 25. MBBR Reactor Sizing
    function calcRSZ() {
        const media = parseFloat(document.getElementById('rsz_media').value) || 0;
        const fill = parseFloat(document.getElementById('rsz_fill').value) || 0;
        const flow = parseFloat(document.getElementById('rsz_flow').value) || 0;
        
        if (media > 0 && fill > 0) {
            const reactor = media / (fill / 100);
            const reactorFt3 = reactor * 35.3147;
            const reactorGal = reactor * 264.172;
            document.getElementById('rsz_res').innerText = reactor.toFixed(1) + " m¬≥";
            const stat = document.getElementById('rsz_status');
            
            let hrtInfo = "";
            if (flow > 0) {
                const flowM3hr = flow * 3785.412 / 24;
                const hrt = reactor / flowM3hr;
                hrtInfo = "<br>HRT: <b>" + hrt.toFixed(1) + " hrs</b>";
                if (hrt < 1) hrtInfo += " ‚Äî ‚ö†Ô∏è Very short, may need larger reactor";
                else if (hrt <= 3) hrtInfo += " ‚Äî Typical for BOD removal";
                else if (hrt <= 6) hrtInfo += " ‚Äî Good for nitrification";
                else hrtInfo += " ‚Äî Long HRT, may be oversized";
            }
            
            let fillCheck = "";
            if (fill > 67) fillCheck = "<br>üö® Fill " + fill + "% exceeds 67% max ‚Äî media cannot circulate!";
            else if (fill < 40) fillCheck = "<br>‚ö†Ô∏è Fill " + fill + "% below 40% ‚Äî reactor volume under-utilized";
            else fillCheck = "<br>‚úì Fill " + fill + "% in design range";
            
            stat.innerHTML = "üìä Reactor: <b>" + reactor.toFixed(1) + " m¬≥</b> (" + reactorFt3.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " ft¬≥ | " + 
                reactorGal.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " gal)" + hrtInfo + fillCheck;
            stat.style.color = fill > 67 ? "var(--danger)" : "#4ade80";
        }
    }

    // 26. MBBR Dissolved Oxygen Demand
    function calcMDO() {
        const flow = parseFloat(document.getElementById('mdo_flow').value) || 0;
        const bod = parseFloat(document.getElementById('mdo_bod').value) || 0;
        const nh3 = parseFloat(document.getElementById('mdo_nh3').value) || 0;
        
        if (flow > 0 && (bod > 0 || nh3 > 0)) {
            const o2bod = flow * bod * 8.34 * 1.5;
            const o2nh3 = flow * nh3 * 8.34 * 4.6;
            const total = o2bod + o2nh3;
            document.getElementById('mdo_res').innerText = total.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs O‚ÇÇ/day";
            const stat = document.getElementById('mdo_status');
            
            const totalKg = total / 2.205;
            
            stat.innerHTML = "üìä <b>BOD oxidation:</b> " + o2bod.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs/day (1.5√ó BOD removed)" +
                "<br><b>Nitrification:</b> " + o2nh3.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs/day (4.6√ó NH‚ÇÉ-N oxidized)" +
                "<br><b>Total:</b> " + total.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs/day (" + totalKg.toFixed(0) + " kg/day)" +
                "<br>‚ö° Maintain DO ‚â• 4 mg/L in MBBR zone (vs ~2 mg/L for CAS)";
            stat.style.color = "#94a3b8";
        }
    }

    // 27. MBBR vs CAS Comparison
    function calcCMP() {
        const flow = parseFloat(document.getElementById('cmp_flow').value) || 0;
        const bod = parseFloat(document.getElementById('cmp_bod').value) || 0;
        
        if (flow > 0 && bod > 0) {
            // CAS assumptions: F:M=0.3, MLSS=3000 mg/L
            const casLoad = flow * bod * 8.34;
            const casVol = (casLoad / (0.3 * 3000)) * 1000000; // gallons
            const casVolFt3 = casVol / 7.481;
            const casHRT = casVol / (flow * 1000000) * 24;
            
            // MBBR assumptions: SALR=10 g/m¬≤/d, K3 500 m¬≤/m¬≥, 55% fill
            const loadGday = flow * bod * 3785.412;
            const reqArea = loadGday / 10;
            const mediaVol = reqArea / 500;
            const mbbrVol = mediaVol / 0.55;
            const mbbrVolGal = mbbrVol * 264.172;
            const mbbrVolFt3 = mbbrVol * 35.3147;
            const mbbrHRT = mbbrVol / (flow * 3785.412 / 24);
            
            const savings = ((1 - mbbrVolFt3 / casVolFt3) * 100);
            
            document.getElementById('cmp_res').innerText = "MBBR " + (savings > 0 ? savings.toFixed(0) + "% smaller" : Math.abs(savings).toFixed(0) + "% larger");
            const stat = document.getElementById('cmp_status');
            
            stat.innerHTML = "<b>‚îÅ‚îÅ CAS (Conventional) ‚îÅ‚îÅ</b>" +
                "<br>F:M=0.3 | MLSS=3,000 | SRT~10d" +
                "<br>Volume: " + (casVolFt3/1000).toFixed(1) + "k ft¬≥ (" + (casVol/1000).toFixed(0) + "k gal)" +
                "<br>HRT: " + casHRT.toFixed(1) + " hrs" +
                "<br><br><b>‚îÅ‚îÅ MBBR (Biofilm) ‚îÅ‚îÅ</b>" +
                "<br>SALR=10 g/m¬≤/d | K3 500 m¬≤/m¬≥ | 55% fill" +
                "<br>Volume: " + (mbbrVolFt3/1000).toFixed(1) + "k ft¬≥ (" + (mbbrVolGal/1000).toFixed(0) + "k gal)" +
                "<br>HRT: " + mbbrHRT.toFixed(1) + " hrs | Media: " + mediaVol.toFixed(0) + " m¬≥" +
                "<br><br>üîÑ <b>MBBR is " + Math.abs(savings).toFixed(0) + "% " + (savings > 0 ? "smaller" : "larger") + " footprint</b> than CAS for same load";
            stat.style.color = "#94a3b8";
        }
    }

    // ==================== SBR CALCULATIONS ====================

    // 28. SBR Cycle Time
    function calcCycle() {
        const fill = parseFloat(document.getElementById('cyc_fill').value) || 0;
        const react = parseFloat(document.getElementById('cyc_react').value) || 0;
        const settle = parseFloat(document.getElementById('cyc_settle').value) || 0;
        const decant = parseFloat(document.getElementById('cyc_decant').value) || 0;
        const idle = parseFloat(document.getElementById('cyc_idle').value) || 0;
        const flow = parseFloat(document.getElementById('cyc_flow').value) || 0;
        
        const total = fill + react + settle + decant + idle;
        
        if (total > 0) {
            const hrs = total / 60;
            const cyclesDay = 1440 / total;
            document.getElementById('cyc_res').innerText = hrs.toFixed(1) + " hrs | " + cyclesDay.toFixed(1) + " cycles/day";
            const stat = document.getElementById('cyc_status');
            
            const fillPct = (fill / total * 100).toFixed(0);
            const reactPct = (react / total * 100).toFixed(0);
            const settlePct = (settle / total * 100).toFixed(0);
            const decantPct = (decant / total * 100).toFixed(0);
            const idlePct = (idle / total * 100).toFixed(0);
            const aeratedPct = ((fill + react) / total * 100).toFixed(0);
            
            let info = "üìä <b>Phase Breakdown:</b>" +
                "<br>Fill: " + fill + " min (" + fillPct + "%) | React: " + react + " min (" + reactPct + "%)" +
                "<br>Settle: " + settle + " min (" + settlePct + "%) | Decant: " + decant + " min (" + decantPct + "%)" +
                (idle > 0 ? " | Idle: " + idle + " min (" + idlePct + "%)" : "") +
                "<br>Aeration duty: <b>" + aeratedPct + "%</b> of cycle";
            
            if (flow > 0) {
                const volPerCycle = (flow * 1000000) / cyclesDay;
                info += "<br>Fill volume: " + volPerCycle.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " gal/cycle (1 basin)";
            }
            
            let check = "";
            if (cyclesDay < 3) check = "<br>‚ö†Ô∏è Few cycles/day ‚Äî long cycle may limit peak flow capacity";
            else if (cyclesDay <= 6) check = "<br>‚úì " + cyclesDay.toFixed(1) + " cycles/day ‚Äî typical SBR operation";
            else check = "<br>‚ö° " + cyclesDay.toFixed(1) + " cycles/day ‚Äî short cycles, verify settle time is adequate";
            
            stat.innerHTML = info + check;
            stat.style.color = "#94a3b8";
        }
    }

    // 29. SBR Volume per Cycle
    function calcSBRVol() {
        const flow = parseFloat(document.getElementById('sv_flow').value) || 0;
        const cycles = parseFloat(document.getElementById('sv_cycles').value) || 0;
        const reactor = parseFloat(document.getElementById('sv_reactor').value) || 0;
        const basins = parseFloat(document.getElementById('sv_basins').value) || 1;
        
        if (flow > 0 && cycles > 0) {
            const dailyGal = flow * 1000000;
            const volPerCycle = dailyGal / (cycles * basins);
            const fmt = volPerCycle.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            document.getElementById('sv_res').innerText = fmt + " gal/cycle";
            const stat = document.getElementById('sv_status');
            
            let info = "üìä <b>" + fmt + " gal</b> per cycle per basin" +
                "<br>Daily: " + (dailyGal / 1000).toFixed(0) + "k gal across " + basins + " basin(s), " + cycles + " cycles";
            
            if (reactor > 0) {
                const fillRatio = (volPerCycle / reactor * 100);
                info += "<br>Fill ratio: <b>" + fillRatio.toFixed(1) + "%</b> of reactor volume";
                
                if (fillRatio < 15) {
                    info += " ‚Äî ‚ö° Low fill ratio. Reactor may be oversized.";
                } else if (fillRatio <= 35) {
                    info += " ‚Äî ‚úì Within design range (15‚Äì35%)";
                } else if (fillRatio <= 50) {
                    info += " ‚Äî ‚ö†Ô∏è High fill ratio. Limited freeboard.";
                } else {
                    info += " ‚Äî üö® Exceeds 50%! Risk of overflow. Reduce flow or add cycles.";
                }
            }
            
            stat.innerHTML = info;
            stat.style.color = "#94a3b8";
        }
    }

    // 30. SBR Decant Rate
    function calcDecant() {
        const vol = parseFloat(document.getElementById('dec_vol').value) || 0;
        const time = parseFloat(document.getElementById('dec_time').value) || 0;
        const weir = parseFloat(document.getElementById('dec_weir').value) || 0;
        
        if (vol > 0 && time > 0) {
            const gpm = vol / time;
            document.getElementById('dec_res').innerText = gpm.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPM";
            const stat = document.getElementById('dec_status');
            
            let info = "üìä <b>Decant rate:</b> " + gpm.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPM";
            
            if (weir > 0) {
                const weirRate = gpm / weir;
                info += "<br>Weir loading: <b>" + weirRate.toFixed(1) + " GPM/ft</b>";
                
                if (weirRate <= 5) {
                    info += " ‚Äî ‚úì Excellent. Low turbulence risk.";
                } else if (weirRate <= 10) {
                    info += " ‚Äî ‚úì Acceptable range (&lt;10 GPM/ft).";
                } else if (weirRate <= 15) {
                    info += " ‚Äî ‚ö†Ô∏è Elevated. May disturb settled solids.";
                } else {
                    info += " ‚Äî üö® Too high. Risk of solids carryover into effluent.";
                }
            }
            
            if (gpm < 500) info += "<br>‚ö° Low decant rate ‚Äî may extend cycle time unnecessarily";
            else if (gpm <= 4000) info += "<br>‚úì Decant rate within typical range (500‚Äì4,000 GPM)";
            else info += "<br>‚ö†Ô∏è High decant rate ‚Äî verify effluent TSS during decant";
            
            stat.innerHTML = info;
            stat.style.color = "#94a3b8";
        }
    }

    // 31. SBR Aeration Demand
    function calcSBRAer() {
        const flow = parseFloat(document.getElementById('saer_flow').value) || 0;
        const bod = parseFloat(document.getElementById('saer_bod').value) || 0;
        const nh3 = parseFloat(document.getElementById('saer_nh3').value) || 0;
        const duty = parseFloat(document.getElementById('saer_duty').value) || 0;
        
        if (flow > 0 && (bod > 0 || nh3 > 0)) {
            const o2bod = flow * bod * 8.34 * 1.5;
            const o2nh3 = flow * nh3 * 8.34 * 4.6;
            const dailyO2 = o2bod + o2nh3;
            
            document.getElementById('saer_res').innerText = dailyO2.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs O‚ÇÇ/day";
            const stat = document.getElementById('saer_status');
            
            let info = "üìä <b>Daily O‚ÇÇ demand:</b> " + dailyO2.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs/day" +
                "<br>BOD oxidation: " + o2bod.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs | Nitrification: " + o2nh3.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs";
            
            if (duty > 0) {
                const peakRate = dailyO2 / (duty / 100);
                const peakPerHr = peakRate / 24;
                const multiplier = (100 / duty);
                info += "<br><br>‚ö° <b>SBR Aeration Sizing:</b>" +
                    "<br>Duty cycle: " + duty + "% ‚Üí Blower must deliver <b>" + multiplier.toFixed(1) + "√ó</b> continuous rate" +
                    "<br>Peak delivery: <b>" + peakRate.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs/day equiv</b> (" + peakPerHr.toFixed(1) + " lbs/hr during aeration)";
            }
            
            stat.innerHTML = info;
            stat.style.color = "#94a3b8";
        }
    }

    // 32. SBR F:M per Cycle
    function calcSBRFM() {
        const fillVol = parseFloat(document.getElementById('sfm_fill').value) || 0;
        const bod = parseFloat(document.getElementById('sfm_bod').value) || 0;
        const reactorVol = parseFloat(document.getElementById('sfm_vol').value) || 0;
        const mlvss = parseFloat(document.getElementById('sfm_mlvss').value) || 0;
        const cycles = parseFloat(document.getElementById('sfm_cycles').value) || 0;
        
        if (fillVol > 0 && bod > 0 && reactorVol > 0 && mlvss > 0) {
            // Food per cycle (lbs)
            const fillMG = fillVol / 1000000;
            const foodPerCycle = fillMG * bod * 8.34;
            
            // Biomass in reactor (lbs)
            const reactorMG = reactorVol / 1000000;
            const biomass = reactorMG * mlvss * 8.34;
            
            // Instantaneous F:M at start of fill
            const instFM = foodPerCycle / biomass;
            
            // Daily F:M
            let dailyFM = 0;
            let dailyInfo = "";
            if (cycles > 0) {
                dailyFM = (foodPerCycle * cycles) / biomass;
                dailyInfo = "<br>Daily F:M: <b>" + dailyFM.toFixed(3) + "</b> (" + cycles + " cycles √ó " + foodPerCycle.toFixed(1) + " lbs food)";
            }
            
            document.getElementById('sfm_res').innerText = "Inst: " + instFM.toFixed(3) + " | Daily: " + dailyFM.toFixed(3);
            const stat = document.getElementById('sfm_status');
            
            let assessment = "";
            if (dailyFM > 0) {
                if (dailyFM < 0.04) assessment = "‚ö° Very low daily F:M ‚Äî endogenous conditions, possible pin floc";
                else if (dailyFM <= 0.15) assessment = "‚úì Daily F:M in typical SBR range (0.05‚Äì0.15)";
                else if (dailyFM <= 0.3) assessment = "‚ö†Ô∏è Elevated daily F:M ‚Äî more typical of CAS";
                else assessment = "üö® High F:M ‚Äî may need to increase MLSS or reduce loading";
            }
            
            stat.innerHTML = "üìä <b>Instantaneous F:M:</b> " + instFM.toFixed(3) + " (at start of fill)" +
                dailyInfo +
                "<br>Food/cycle: " + foodPerCycle.toFixed(1) + " lbs BOD | Biomass: " + biomass.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs" +
                "<br>" + assessment;
            stat.style.color = "#94a3b8";
        }
    }

    // 33. SBR Settle & Decant Check
    function calcSSC() {
        const depth = parseFloat(document.getElementById('ssc_depth').value) || 0;
        const sludgePct = parseFloat(document.getElementById('ssc_sludge').value) || 0;
        const decantDepth = parseFloat(document.getElementById('ssc_decant').value) || 0;
        const mlss = parseFloat(document.getElementById('ssc_mlss').value) || 0;
        
        if (depth > 0 && sludgePct > 0) {
            const blanketDepth = depth * (sludgePct / 100);
            const clearwater = depth - blanketDepth;
            const buffer = clearwater - decantDepth;
            
            let result = "";
            if (buffer >= 2) result = buffer.toFixed(1) + " ft buffer ‚úì";
            else if (buffer > 0) result = buffer.toFixed(1) + " ft buffer ‚ö†Ô∏è";
            else result = "NO BUFFER üö®";
            
            document.getElementById('ssc_res').innerText = result;
            const stat = document.getElementById('ssc_status');
            
            let svi = "";
            if (mlss > 0) {
                const sviVal = (sludgePct * 10000) / mlss;
                svi = "<br>Estimated SVI: <b>" + sviVal.toFixed(0) + " mL/g</b>";
                if (sviVal < 80) svi += " ‚Äî Excellent settling";
                else if (sviVal <= 150) svi += " ‚Äî Good settling";
                else if (sviVal <= 250) svi += " ‚Äî Fair settling, watch for filaments";
                else svi += " ‚Äî ‚ö†Ô∏è Poor settling, check for bulking";
            }
            
            let assessment = "";
            if (buffer >= 3) {
                assessment = "‚úì <b>Safe:</b> " + buffer.toFixed(1) + " ft buffer between blanket and decant zone. Good separation.";
                stat.style.color = "#4ade80";
            } else if (buffer >= 2) {
                assessment = "‚úì <b>Adequate:</b> " + buffer.toFixed(1) + " ft buffer. Minimum safe margin (‚â•2 ft).";
                stat.style.color = "#4ade80";
            } else if (buffer > 0) {
                assessment = "‚ö†Ô∏è <b>Tight:</b> Only " + buffer.toFixed(1) + " ft buffer. Risk of solids carryover. Consider longer settle or less decant depth.";
                stat.style.color = "var(--accent)";
            } else {
                assessment = "üö® <b>Solids Carryover Risk:</b> Blanket (" + blanketDepth.toFixed(1) + " ft) extends into decant zone! Reduce decant depth or increase settle time.";
                stat.style.color = "var(--danger)";
            }
            
            stat.innerHTML = "üìä Blanket: <b>" + blanketDepth.toFixed(1) + " ft</b> | Clear water: <b>" + clearwater.toFixed(1) + " ft</b> | Decant: <b>" + decantDepth.toFixed(1) + " ft</b>" +
                svi +
                "<br>" + assessment;
        }
    }

    // ==================== DISINFECTION CALCULATIONS ====================

    // 34. Chlorine CT
    function calcCT() {
        const residual = parseFloat(document.getElementById('ct_res_in').value) || 0;
        const time = parseFloat(document.getElementById('ct_time').value) || 0;
        const req = parseFloat(document.getElementById('ct_req').value) || 0;
        
        if (residual > 0 && time > 0) {
            const ct = residual * time;
            document.getElementById('ct_res').innerText = ct.toFixed(1) + " mg¬∑min/L";
            const stat = document.getElementById('ct_status');
            
            let info = "üìä CT = " + residual + " mg/L √ó " + time + " min = <b>" + ct.toFixed(1) + " mg¬∑min/L</b>";
            
            if (req > 0) {
                const ratio = (ct / req * 100).toFixed(0);
                if (ct >= req) {
                    info += "<br>‚úì <b>Compliant:</b> " + ratio + "% of required CT (" + req + " mg¬∑min/L)";
                    stat.style.color = "#4ade80";
                } else {
                    info += "<br>üö® <b>Non-compliant:</b> Only " + ratio + "% of required CT (" + req + "). Increase residual or contact time.";
                    stat.style.color = "var(--danger)";
                }
            }
            stat.innerHTML = info;
        }
    }

    // 35. Dechlorination
    function calcDCL() {
        const flow = parseFloat(document.getElementById('dcl_flow').value) || 0;
        const cl2 = parseFloat(document.getElementById('dcl_cl2').value) || 0;
        const sf = parseFloat(document.getElementById('dcl_sf').value) || 1.0;
        
        if (flow > 0 && cl2 > 0) {
            const so2 = flow * cl2 * 8.34 * 1.0 * sf;
            const nahso3 = flow * cl2 * 8.34 * 1.46 * sf;
            const na2so3 = flow * cl2 * 8.34 * 0.9 * sf;
            
            document.getElementById('dcl_res').innerText = so2.toFixed(1) + " lbs SO‚ÇÇ/day";
            const stat = document.getElementById('dcl_status');
            
            stat.innerHTML = "üìä <b>Chemical Options (SF=" + sf + "√ó):</b>" +
                "<br>SO‚ÇÇ (gas): <b>" + so2.toFixed(1) + " lbs/day</b>" +
                "<br>NaHSO‚ÇÉ (sodium bisulfite): <b>" + nahso3.toFixed(1) + " lbs/day</b> (" + (nahso3/8.34).toFixed(1) + " gal/day @ SG‚âà1.0)" +
                "<br>Na‚ÇÇSO‚ÇÉ (sodium sulfite): <b>" + na2so3.toFixed(1) + " lbs/day</b>" +
                "<br><br>Neutralizing " + cl2 + " mg/L residual at " + flow + " MGD";
            stat.style.color = "#94a3b8";
        }
    }

    // 36. UV Dose
    function calcUV() {
        const intensity = parseFloat(document.getElementById('uv_int').value) || 0;
        const time = parseFloat(document.getElementById('uv_time').value) || 0;
        const uvt = parseFloat(document.getElementById('uv_uvt').value) || 0;
        
        if (intensity > 0 && time > 0) {
            const dose = intensity * time;
            document.getElementById('uv_res').innerText = dose.toFixed(1) + " mJ/cm¬≤";
            const stat = document.getElementById('uv_status');
            
            let info = "üìä UV Dose = " + intensity + " mW/cm¬≤ √ó " + time + " sec = <b>" + dose.toFixed(1) + " mJ/cm¬≤</b>";
            
            if (dose >= 80) info += "<br>‚úì Adequate for reuse-quality disinfection (‚â•80 mJ/cm¬≤)";
            else if (dose >= 40) info += "<br>‚úì Adequate for E. coli/fecal compliance (‚â•40 mJ/cm¬≤)";
            else if (dose >= 30) info += "<br>‚ö†Ô∏è Minimum range ‚Äî may not meet permit during peak flow";
            else info += "<br>üö® Below typical TCEQ requirement. Increase intensity or exposure time.";
            
            if (uvt > 0) {
                info += "<br>UVT: <b>" + uvt + "%</b>";
                if (uvt >= 65) info += " ‚Äî ‚úì Good transmittance";
                else if (uvt >= 55) info += " ‚Äî ‚ö†Ô∏è Marginal. TSS or color may reduce effectiveness.";
                else info += " ‚Äî üö® Poor transmittance. Pre-treatment needed.";
            }
            
            stat.innerHTML = info;
            stat.style.color = "#94a3b8";
        }
    }

    // ==================== SLUDGE & BIOSOLIDS CALCULATIONS ====================

    // 37. Sludge Volume & % Solids
    function calcSLV() {
        const vol = parseFloat(document.getElementById('slv_vol').value) || 0;
        const pct = parseFloat(document.getElementById('slv_pct').value) || 0;
        
        if (vol > 0 && pct > 0) {
            const wetLbs = vol * 8.34;
            const dryLbs = wetLbs * (pct / 100);
            const dryTons = dryLbs / 2000;
            const ft3 = vol / 7.48;
            
            document.getElementById('slv_res').innerText = dryLbs.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " dry lbs/day";
            const stat = document.getElementById('slv_status');
            
            stat.innerHTML = "üìä <b>Sludge Summary:</b>" +
                "<br>Wet volume: " + vol.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " gal/day (" + ft3.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " ft¬≥)" +
                "<br>Wet weight: " + wetLbs.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs/day (" + (wetLbs/2000).toFixed(2) + " wet tons)" +
                "<br>Dry solids: <b>" + dryLbs.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs/day</b> (" + dryTons.toFixed(2) + " dry tons)" +
                "<br>At " + pct + "% solids | " + (100-pct).toFixed(1) + "% water";
            stat.style.color = "#94a3b8";
        }
    }

    // 38. Volatile Solids Reduction (Van Kleeck)
    function calcVSR() {
        const vsIn = parseFloat(document.getElementById('vsr_in').value) || 0;
        const vsOut = parseFloat(document.getElementById('vsr_out').value) || 0;
        
        if (vsIn > 0 && vsOut > 0 && vsIn > vsOut) {
            const inDec = vsIn / 100;
            const outDec = vsOut / 100;
            const vsr = ((inDec - outDec) / (inDec - (inDec * outDec))) * 100;
            
            document.getElementById('vsr_res').innerText = vsr.toFixed(1) + " %";
            const stat = document.getElementById('vsr_status');
            
            let assessment = "";
            if (vsr >= 50) { assessment = "‚úì <b>Excellent:</b> Healthy digester performance (‚â•50%)"; stat.style.color = "#4ade80"; }
            else if (vsr >= 38) { assessment = "‚úì <b>Meets Class B:</b> ‚â•38% VS reduction (VAR Option 1)"; stat.style.color = "#4ade80"; }
            else { assessment = "üö® <b>Below 38%:</b> Does NOT meet Class B vector attraction reduction. Check digester operation."; stat.style.color = "var(--danger)"; }
            
            stat.innerHTML = "üìä Van Kleeck VSR: <b>" + vsr.toFixed(1) + "%</b>" +
                "<br>Influent VS: " + vsIn + "% ‚Üí Effluent VS: " + vsOut + "%" +
                "<br>" + assessment;
        }
    }

    // 39. Digester Loading Rate
    function calcDIG() {
        const flow = parseFloat(document.getElementById('dig_flow').value) || 0;
        const pct = parseFloat(document.getElementById('dig_pct').value) || 0;
        const vs = parseFloat(document.getElementById('dig_vs').value) || 0;
        const vol = parseFloat(document.getElementById('dig_vol').value) || 0;
        
        if (flow > 0 && pct > 0 && vs > 0 && vol > 0) {
            const vsLbs = flow * 8.34 * (pct / 100) * (vs / 100);
            const loading = vsLbs / vol;
            
            document.getElementById('dig_res').innerText = loading.toFixed(3) + " lbs VS/ft¬≥/d";
            const stat = document.getElementById('dig_status');
            
            let assessment = "";
            if (loading <= 0.05) { assessment = "‚úì Low-rate digester range (0.03‚Äì0.05)"; stat.style.color = "#4ade80"; }
            else if (loading <= 0.10) { assessment = "‚úì Moderate loading ‚Äî transitional range"; stat.style.color = "#4ade80"; }
            else if (loading <= 0.20) { assessment = "‚úì High-rate digester range (0.10‚Äì0.20)"; stat.style.color = "#4ade80"; }
            else { assessment = "üö® <b>Overloaded!</b> Risk of VFA buildup and pH crash. Reduce feed rate."; stat.style.color = "var(--danger)"; }
            
            stat.innerHTML = "üìä VS feed: <b>" + vsLbs.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs VS/day</b>" +
                "<br>Loading: <b>" + loading.toFixed(3) + " lbs VS/ft¬≥/day</b>" +
                "<br>HRT: " + (vol * 7.48 / flow).toFixed(0) + " days" +
                "<br>" + assessment;
        }
    }

    // 40. Polymer Dosing
    function calcPoly() {
        const flow = parseFloat(document.getElementById('poly_flow').value) || 0;
        const pct = parseFloat(document.getElementById('poly_pct').value) || 0;
        const rate = parseFloat(document.getElementById('poly_rate').value) || 0;
        const conc = parseFloat(document.getElementById('poly_conc').value) || 0;
        
        if (flow > 0 && pct > 0 && rate > 0 && conc > 0) {
            const activeLbsHr = rate * 8.34 * (conc / 100);
            const activeLbsDay = activeLbsHr * 24;
            const dryTonsDay = (flow * 60 * 8.34 * (pct / 100) * 24) / 2000;
            const lbsPerDT = activeLbsDay / dryTonsDay;
            
            document.getElementById('poly_res').innerText = lbsPerDT.toFixed(1) + " lbs active/DT";
            const stat = document.getElementById('poly_status');
            
            let assessment = "";
            if (lbsPerDT <= 4) { assessment = "‚úì Low polymer usage ‚Äî cost effective"; stat.style.color = "#4ade80"; }
            else if (lbsPerDT <= 8) { assessment = "‚úì Typical belt press range (3‚Äì8 lbs/DT)"; stat.style.color = "#4ade80"; }
            else if (lbsPerDT <= 12) { assessment = "‚ö†Ô∏è Typical centrifuge range (5‚Äì12) ‚Äî high for belt press"; stat.style.color = "var(--accent)"; }
            else { assessment = "üö® Excessive polymer. Check conditioning, sludge age, or polymer type."; stat.style.color = "var(--danger)"; }
            
            stat.innerHTML = "üìä <b>Polymer Usage:</b>" +
                "<br>Active polymer: " + activeLbsDay.toFixed(1) + " lbs/day (" + activeLbsHr.toFixed(2) + " lbs/hr)" +
                "<br>Dry solids: " + dryTonsDay.toFixed(2) + " DT/day" +
                "<br>Dosage: <b>" + lbsPerDT.toFixed(1) + " lbs active polymer per dry ton</b>" +
                "<br>" + assessment;
        }
    }

    // ==================== NUTRIENT REMOVAL CALCULATIONS ====================

    // 41. Phosphorus Removal
    function calcPhos() {
        const flow = parseFloat(document.getElementById('phos_flow').value) || 0;
        const pIn = parseFloat(document.getElementById('phos_in').value) || 0;
        const pOut = parseFloat(document.getElementById('phos_out').value) || 0;
        const ratio = parseFloat(document.getElementById('phos_ratio').value) || 0;
        
        if (flow > 0 && pIn > pOut && ratio > 0) {
            const deltaP = pIn - pOut;
            // Alum: Al needed = deltaP √ó ratio √ó (27/31), then alum = Al √ó (594/(2√ó27))
            const alDose = deltaP * ratio * (27/31); // mg/L as Al
            const alumDose = alDose * (594 / 54); // mg/L as alum (Al2(SO4)3¬∑14H2O)
            const alumLbs = flow * alumDose * 8.34;
            // Ferric: Fe needed = deltaP √ó ratio √ó (55.85/31)
            const feDose = deltaP * ratio * (55.85/31);
            const fecl3Dose = feDose * (162.2/55.85);
            const fecl3Lbs = flow * fecl3Dose * 8.34;
            
            document.getElementById('phos_res').innerText = "Alum: " + alumLbs.toFixed(0) + " | FeCl‚ÇÉ: " + fecl3Lbs.toFixed(0) + " lbs/day";
            const stat = document.getElementById('phos_status');
            
            stat.innerHTML = "üìä Removing <b>" + deltaP.toFixed(1) + " mg/L P</b> at " + ratio + ":1 molar ratio" +
                "<br><br>üß™ <b>Alum (Al‚ÇÇ(SO‚ÇÑ)‚ÇÉ¬∑14H‚ÇÇO):</b>" +
                "<br>Dose: " + alumDose.toFixed(1) + " mg/L ‚Üí <b>" + alumLbs.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs/day</b>" +
                " (" + (alumLbs / (8.34 * 1.33)).toFixed(0) + " gal/day @ 48% liquid)" +
                "<br><br>üß™ <b>Ferric Chloride (FeCl‚ÇÉ):</b>" +
                "<br>Dose: " + fecl3Dose.toFixed(1) + " mg/L ‚Üí <b>" + fecl3Lbs.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs/day</b>" +
                " (" + (fecl3Lbs / (8.34 * 1.42)).toFixed(0) + " gal/day @ 42% liquid)";
            stat.style.color = "#94a3b8";
        }
    }

    // 42. Alkalinity & Nitrification
    function calcALK() {
        const alkIn = parseFloat(document.getElementById('alk_in').value) || 0;
        const nh3 = parseFloat(document.getElementById('alk_nh3').value) || 0;
        const flow = parseFloat(document.getElementById('alk_flow').value) || 0;
        
        if (alkIn > 0 && nh3 > 0) {
            const consumed = nh3 * 7.14;
            const remaining = alkIn - consumed;
            
            document.getElementById('alk_res').innerText = remaining.toFixed(0) + " mg/L remaining";
            const stat = document.getElementById('alk_status');
            
            let assessment = "";
            let supplement = "";
            if (remaining >= 100) { assessment = "‚úì <b>Adequate alkalinity buffer.</b> No supplement needed."; stat.style.color = "#4ade80"; }
            else if (remaining >= 50) { assessment = "‚ö†Ô∏è <b>Low buffer.</b> Monitor pH closely. Consider supplemental alkalinity."; stat.style.color = "var(--accent)"; }
            else {
                assessment = "üö® <b>Insufficient alkalinity!</b> Nitrification will crash. Supplement required.";
                stat.style.color = "var(--danger)";
            }
            
            if (remaining < 80 && flow > 0) {
                const deficit = 80 - remaining; // target 80 mg/L remaining
                const limeLbs = flow * deficit * 8.34 / 1.35; // lime effectiveness
                supplement = "<br><br>üíä To reach 80 mg/L remaining:" +
                    "<br>Lime (CaO): ~" + limeLbs.toFixed(0) + " lbs/day" +
                    "<br>Soda Ash (Na‚ÇÇCO‚ÇÉ): ~" + (flow * deficit * 8.34 / 1.06).toFixed(0) + " lbs/day";
            }
            
            stat.innerHTML = "üìä Alkalinity consumed: <b>" + consumed.toFixed(0) + " mg/L</b> (from " + nh3 + " mg/L NH‚ÇÉ-N)" +
                "<br>Influent: " + alkIn + " mg/L ‚Üí Remaining: <b>" + remaining.toFixed(0) + " mg/L</b>" +
                "<br>" + assessment + supplement;
        }
    }

    // 43. Nitrogen Balance
    function calcNBal() {
        const tkn = parseFloat(document.getElementById('nb_tkn').value) || 0;
        const nh3 = parseFloat(document.getElementById('nb_nh3').value) || 0;
        const no3 = parseFloat(document.getElementById('nb_no3').value) || 0;
        const bio = parseFloat(document.getElementById('nb_bio').value) || 0;
        
        if (tkn > 0) {
            const nitrified = tkn - nh3 - bio; // ammonia that was nitrified
            const denitrified = nitrified - no3; // nitrate that was denitrified (removed as N2)
            const effTN = nh3 + no3;
            const removalPct = ((tkn - effTN) / tkn * 100);
            
            document.getElementById('nb_res').innerText = "Eff TN: " + effTN.toFixed(1) + " mg/L | " + removalPct.toFixed(0) + "% removal";
            const stat = document.getElementById('nb_status');
            
            stat.innerHTML = "üìä <b>Nitrogen Fate:</b>" +
                "<br>Influent TKN: <b>" + tkn + " mg/L</b>" +
                "<br>‚Üí Nitrified (NH‚ÇÉ‚ÜíNO‚ÇÉ): " + Math.max(0, nitrified).toFixed(1) + " mg/L" +
                "<br>‚Üí Denitrified (NO‚ÇÉ‚ÜíN‚ÇÇ‚Üë): <b>" + Math.max(0, denitrified).toFixed(1) + " mg/L</b> (removed as gas)" +
                "<br>‚Üí Biomass uptake: " + bio + " mg/L" +
                "<br>‚Üí Effluent NH‚ÇÉ: " + nh3 + " mg/L | Effluent NO‚ÇÉ: " + no3 + " mg/L" +
                "<br><br>üìã <b>Effluent TN: " + effTN.toFixed(1) + " mg/L</b> (" + removalPct.toFixed(0) + "% total N removal)" +
                (denitrified < 0 ? "<br>‚ö†Ô∏è Negative denitrification ‚Äî check TKN/NO‚ÇÉ values" : "");
            stat.style.color = "#94a3b8";
        }
    }

    // ==================== HYDRAULICS & PUMPING CALCULATIONS ====================

    // 44. Total Dynamic Head
    function calcTDH() {
        const stat_h = parseFloat(document.getElementById('tdh_static').value) || 0;
        const friction = parseFloat(document.getElementById('tdh_friction').value) || 0;
        const vel = parseFloat(document.getElementById('tdh_vel').value) || 0;
        
        const tdh = stat_h + friction + vel;
        if (tdh > 0) {
            const psi = tdh / 2.31;
            document.getElementById('tdh_res').innerText = tdh.toFixed(1) + " ft (" + psi.toFixed(1) + " psi)";
            const stat = document.getElementById('tdh_status');
            
            stat.innerHTML = "üìä Static: " + stat_h + " ft + Friction: " + friction + " ft + Velocity: " + vel + " ft" +
                "<br>TDH = <b>" + tdh.toFixed(1) + " ft</b> = <b>" + psi.toFixed(1) + " psi</b> = " + (tdh * 0.3048).toFixed(2) + " m" +
                "<br>Friction is " + (friction / tdh * 100).toFixed(0) + "% of total head";
            stat.style.color = "#94a3b8";
        }
    }

    // 45. Pipe Velocity
    function calcPV() {
        const flow = parseFloat(document.getElementById('pv_flow').value) || 0;
        const dia = parseFloat(document.getElementById('pv_dia').value) || 0;
        
        if (flow > 0 && dia > 0) {
            const area = Math.PI * Math.pow(dia/2, 2); // in¬≤
            const cfs = flow / 448.83;
            const fps = cfs / (area / 144); // convert in¬≤ to ft¬≤
            
            document.getElementById('pv_res').innerText = fps.toFixed(2) + " fps";
            const stat = document.getElementById('pv_status');
            
            let assessment = "";
            if (fps < 2) { assessment = "üö® <b>Too slow:</b> Solids will settle and accumulate. Increase flow or reduce pipe size."; stat.style.color = "var(--danger)"; }
            else if (fps <= 5) { assessment = "‚úì <b>Good:</b> Adequate self-cleaning velocity."; stat.style.color = "#4ade80"; }
            else if (fps <= 8) { assessment = "‚úì <b>Normal range</b> for force mains and pressure pipe."; stat.style.color = "#4ade80"; }
            else if (fps <= 10) { assessment = "‚ö†Ô∏è <b>Elevated:</b> Approaching maximum recommended velocity."; stat.style.color = "var(--accent)"; }
            else { assessment = "üö® <b>Too fast:</b> Risk of pipe erosion, water hammer, and excessive friction loss."; stat.style.color = "var(--danger)"; }
            
            stat.innerHTML = "üìä " + flow + " GPM through " + dia + "\" pipe = <b>" + fps.toFixed(2) + " fps</b>" +
                "<br>Flow: " + cfs.toFixed(3) + " CFS | Pipe area: " + (area/144).toFixed(4) + " ft¬≤" +
                "<br>" + assessment;
        }
    }

    // 46. Horsepower
    function calcHP() {
        const flow = parseFloat(document.getElementById('hp_flow').value) || 0;
        const tdh = parseFloat(document.getElementById('hp_tdh').value) || 0;
        const pEff = parseFloat(document.getElementById('hp_eff').value) || 75;
        const mEff = parseFloat(document.getElementById('hp_meff').value) || 90;
        
        if (flow > 0 && tdh > 0) {
            const whp = (flow * tdh) / 3960;
            const bhp = whp / (pEff / 100);
            const mhp = bhp / (mEff / 100);
            const kw = mhp * 0.746;
            
            document.getElementById('hp_res').innerText = "WHP: " + whp.toFixed(2) + " | BHP: " + bhp.toFixed(2);
            const stat = document.getElementById('hp_status');
            
            stat.innerHTML = "üìä <b>Power Chain:</b>" +
                "<br>Water HP: <b>" + whp.toFixed(2) + " HP</b> (theoretical minimum)" +
                "<br>Brake HP: <b>" + bhp.toFixed(2) + " HP</b> (pump " + pEff + "% eff)" +
                "<br>Motor HP: <b>" + mhp.toFixed(2) + " HP</b> (motor " + mEff + "% eff)" +
                "<br>Power draw: <b>" + kw.toFixed(2) + " kW</b>" +
                "<br><br>üí∞ Est. energy cost: $" + (kw * 24 * 0.10).toFixed(2) + "/day @ $0.10/kWh (" + (kw * 24 * 30 * 0.10).toFixed(0) + "/month)";
            stat.style.color = "#94a3b8";
        }
    }

    // ==================== COMPLIANCE & REPORTING CALCULATIONS ====================

    // 47. Geometric Mean
    function calcGM() {
        const samples = [];
        for (let i = 1; i <= 7; i++) {
            const v = parseFloat(document.getElementById('gm_s' + i).value);
            if (v > 0) samples.push(v);
        }
        
        if (samples.length >= 2) {
            const logSum = samples.reduce((sum, v) => sum + Math.log(v), 0);
            const geoMean = Math.exp(logSum / samples.length);
            const arithMean = samples.reduce((s, v) => s + v, 0) / samples.length;
            
            document.getElementById('gm_res').innerText = geoMean.toFixed(1) + " CFU/100mL";
            const stat = document.getElementById('gm_status');
            
            let ecoliCheck = "";
            if (geoMean <= 126) ecoliCheck = "<br>‚úì E. coli: <b>PASS</b> (‚â§126 CFU/100mL)";
            else ecoliCheck = "<br>üö® E. coli: <b>FAIL</b> (>126 CFU/100mL)";
            
            let fecalCheck = "";
            if (geoMean <= 200) fecalCheck = "<br>‚úì Fecal coliform: <b>PASS</b> (‚â§200 CFU/100mL)";
            else fecalCheck = "<br>üö® Fecal coliform: <b>FAIL</b> (>200 CFU/100mL)";
            
            stat.innerHTML = "üìä <b>Geometric Mean: " + geoMean.toFixed(1) + "</b> from " + samples.length + " samples" +
                "<br>Arithmetic mean: " + arithMean.toFixed(1) + " (not used for DMR)" +
                "<br>Values: " + samples.join(", ") +
                ecoliCheck + fecalCheck;
            stat.style.color = "#94a3b8";
        }
    }

    // 48. Flow-Weighted Composite
    function calcFWC() {
        let sumFC = 0, sumF = 0, pairs = 0;
        for (let i = 1; i <= 4; i++) {
            const f = parseFloat(document.getElementById('fw_f' + i).value);
            const c = parseFloat(document.getElementById('fw_c' + i).value);
            if (f > 0 && c >= 0) {
                sumFC += f * c;
                sumF += f;
                pairs++;
            }
        }
        
        if (pairs >= 2 && sumF > 0) {
            const fwAvg = sumFC / sumF;
            document.getElementById('fw_res').innerText = fwAvg.toFixed(2) + " mg/L";
            const stat = document.getElementById('fw_status');
            
            let detail = "";
            for (let i = 1; i <= 4; i++) {
                const f = parseFloat(document.getElementById('fw_f' + i).value);
                const c = parseFloat(document.getElementById('fw_c' + i).value);
                if (f > 0 && c >= 0) {
                    const weight = (f / sumF * 100).toFixed(0);
                    detail += "<br>Sample " + i + ": " + f + " MGD √ó " + c + " mg/L (weight: " + weight + "%)";
                }
            }
            
            // Arithmetic mean for comparison
            let simpleSum = 0, cnt = 0;
            for (let i = 1; i <= 4; i++) {
                const c = parseFloat(document.getElementById('fw_c' + i).value);
                if (c >= 0 && parseFloat(document.getElementById('fw_f' + i).value) > 0) { simpleSum += c; cnt++; }
            }
            const arith = simpleSum / cnt;
            
            stat.innerHTML = "üìä <b>Flow-Weighted Average: " + fwAvg.toFixed(2) + " mg/L</b>" +
                "<br>Simple average: " + arith.toFixed(2) + " mg/L (difference: " + (fwAvg - arith).toFixed(2) + ")" +
                detail +
                "<br><br>Total flow: " + sumF.toFixed(2) + " MGD across " + pairs + " samples";
            stat.style.color = "#94a3b8";
        }
    }

    // ==================== UNIT CONVERTER ====================

    // 49. Unit Converter
    function calcUC(source) {
        const stat = document.getElementById('uc_status');
        
        // Flow conversions
        if (['gpm','mgd','cfs','m3d'].includes(source)) {
            let mgd = 0;
            if (source === 'gpm') mgd = (parseFloat(document.getElementById('uc_gpm').value) || 0) * 0.00144;
            else if (source === 'mgd') mgd = parseFloat(document.getElementById('uc_mgd').value) || 0;
            else if (source === 'cfs') mgd = (parseFloat(document.getElementById('uc_cfs').value) || 0) * 0.6464;
            else if (source === 'm3d') mgd = (parseFloat(document.getElementById('uc_m3d').value) || 0) / 3785.41;
            
            if (source !== 'gpm') document.getElementById('uc_gpm').value = (mgd / 0.00144).toFixed(2);
            if (source !== 'mgd') document.getElementById('uc_mgd').value = mgd.toFixed(6);
            if (source !== 'cfs') document.getElementById('uc_cfs').value = (mgd / 0.6464).toFixed(4);
            if (source !== 'm3d') document.getElementById('uc_m3d').value = (mgd * 3785.41).toFixed(2);
            stat.innerHTML = "‚úì Flow converted";
        }
        
        // Volume conversions
        if (['gal','ft3','m3','acft'].includes(source)) {
            let gal = 0;
            if (source === 'gal') gal = parseFloat(document.getElementById('uc_gal').value) || 0;
            else if (source === 'ft3') gal = (parseFloat(document.getElementById('uc_ft3').value) || 0) * 7.48052;
            else if (source === 'm3') gal = (parseFloat(document.getElementById('uc_m3').value) || 0) * 264.172;
            else if (source === 'acft') gal = (parseFloat(document.getElementById('uc_acft').value) || 0) * 325851;
            
            if (source !== 'gal') document.getElementById('uc_gal').value = gal.toFixed(2);
            if (source !== 'ft3') document.getElementById('uc_ft3').value = (gal / 7.48052).toFixed(2);
            if (source !== 'm3') document.getElementById('uc_m3').value = (gal / 264.172).toFixed(4);
            if (source !== 'acft') document.getElementById('uc_acft').value = (gal / 325851).toFixed(6);
            stat.innerHTML = "‚úì Volume converted";
        }
        
        // Pressure conversions
        if (['psi','fth2o','kpa'].includes(source)) {
            let psi = 0;
            if (source === 'psi') psi = parseFloat(document.getElementById('uc_psi').value) || 0;
            else if (source === 'fth2o') psi = (parseFloat(document.getElementById('uc_fth2o').value) || 0) / 2.31;
            else if (source === 'kpa') psi = (parseFloat(document.getElementById('uc_kpa').value) || 0) / 6.895;
            
            if (source !== 'psi') document.getElementById('uc_psi').value = psi.toFixed(4);
            if (source !== 'fth2o') document.getElementById('uc_fth2o').value = (psi * 2.31).toFixed(4);
            if (source !== 'kpa') document.getElementById('uc_kpa').value = (psi * 6.895).toFixed(4);
            stat.innerHTML = "‚úì Pressure converted";
        }
        
        stat.style.color = "#4ade80";
    }

    // ==================== COLLECTION SYSTEMS CALCULATIONS ====================

    // 50. Manning's Equation
    function calcManning() {
        const dia = parseFloat(document.getElementById('man_dia').value) || 0;
        const slope = parseFloat(document.getElementById('man_slope').value) || 0;
        const n = parseFloat(document.getElementById('man_n').value) || 0;
        
        if (dia > 0 && slope > 0 && n > 0) {
            const dFt = dia / 12;
            const area = Math.PI * Math.pow(dFt/2, 2);
            const r = dFt / 4; // hydraulic radius for full pipe
            const vel = (1.486 / n) * Math.pow(r, 2/3) * Math.pow(slope, 1/2);
            const qCFS = vel * area;
            const qGPM = qCFS * 448.83;
            const qMGD = qGPM * 0.00144;
            
            document.getElementById('man_res').innerText = qGPM.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPM";
            const stat = document.getElementById('man_status');
            
            let velCheck = "";
            if (vel < 2) velCheck = "üö® <b>Below 2 fps:</b> Solids will deposit. Increase slope or reduce pipe size.";
            else if (vel <= 10) velCheck = "‚úì Velocity in acceptable range (2‚Äì10 fps)";
            else velCheck = "‚ö†Ô∏è >10 fps: Risk of erosion and wear on pipe joints";
            
            stat.innerHTML = "üìä <b>Full Pipe Capacity:</b>" +
                "<br>Velocity: <b>" + vel.toFixed(2) + " fps</b>" +
                "<br>Flow: <b>" + qGPM.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPM</b> | " + qCFS.toFixed(2) + " CFS | " + qMGD.toFixed(3) + " MGD" +
                "<br>" + dia + "\" pipe | Slope: " + slope + " ft/ft (" + (slope*100).toFixed(2) + "%) | n=" + n +
                "<br>" + velCheck;
            stat.style.color = "#94a3b8";
        }
    }

    // 51. Wet Well Sizing
    function calcWetWell() {
        const pump = parseFloat(document.getElementById('ww_pump').value) || 0;
        const inflow = parseFloat(document.getElementById('ww_inflow').value) || 0;
        const cycle = parseFloat(document.getElementById('ww_cycle').value) || 0;
        
        if (pump > 0 && cycle > 0) {
            const vol = (cycle * pump) / 4; // standard formula for constant speed pump
            const fillTime = inflow > 0 ? vol / inflow : 0;
            const pumpDown = (pump - inflow) > 0 ? vol / (pump - inflow) : 0;
            
            document.getElementById('ww_res').innerText = vol.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " gallons";
            const stat = document.getElementById('ww_status');
            
            let info = "üìä <b>Required Wet Well Volume: " + vol.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " gal</b> (" + (vol/7.48).toFixed(1) + " ft¬≥)" +
                "<br>Minimum cycle time: " + cycle + " min | Pump: " + pump + " GPM";
            
            if (inflow > 0) {
                info += "<br>Fill time: " + fillTime.toFixed(1) + " min | Pump-down: " + pumpDown.toFixed(1) + " min";
                if (inflow >= pump) {
                    info += "<br>üö® <b>Inflow ‚â• pump capacity!</b> Pump cannot keep up. Need larger pump or additional pump.";
                } else {
                    const dutyCycle = (inflow / pump * 100).toFixed(0);
                    info += "<br>Pump duty cycle: " + dutyCycle + "% (run time √∑ total cycle)";
                }
            }
            
            if (cycle < 10) info += "<br>‚ö†Ô∏è Cycle time <10 min ‚Äî risk of motor overheating and seal wear";
            else info += "<br>‚úì Cycle time ‚â•10 min ‚Äî within manufacturer recommendations";
            
            stat.innerHTML = info;
            stat.style.color = "#94a3b8";
        }
    }

    // 52. Infiltration & Inflow
    function calcII() {
        const wet = parseFloat(document.getElementById('ii_wet').value) || 0;
        const dry = parseFloat(document.getElementById('ii_dry').value) || 0;
        const dia = parseFloat(document.getElementById('ii_dia').value) || 0;
        const miles = parseFloat(document.getElementById('ii_miles').value) || 0;
        
        if (wet > 0 && dry > 0 && dia > 0 && miles > 0) {
            const ii = (wet - dry) / (dia * miles);
            const iiTotal = wet - dry;
            const pctIncrease = ((wet - dry) / dry * 100);
            
            document.getElementById('ii_res').innerText = ii.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPD/inch-mile";
            const stat = document.getElementById('ii_status');
            
            let assessment = "";
            if (ii <= 250) { assessment = "‚úì <b>Low I/I:</b> Well-maintained system"; stat.style.color = "#4ade80"; }
            else if (ii <= 500) { assessment = "‚úì <b>Acceptable:</b> Within typical TCEQ guidance"; stat.style.color = "#4ade80"; }
            else if (ii <= 1000) { assessment = "‚ö†Ô∏è <b>Elevated:</b> Rehabilitation recommended. TCEQ may require SSES."; stat.style.color = "var(--accent)"; }
            else { assessment = "üö® <b>Excessive I/I:</b> Immediate investigation required. System is a regulatory risk."; stat.style.color = "var(--danger)"; }
            
            stat.innerHTML = "üìä Total I/I: <b>" + iiTotal.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPD</b> (" + pctIncrease.toFixed(0) + "% increase over dry weather)" +
                "<br>Rate: <b>" + ii.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPD/inch-mile</b>" +
                "<br>" + dia + "\" pipe | " + miles + " miles | Wet: " + (wet/1000).toFixed(0) + "k GPD | Dry: " + (dry/1000).toFixed(0) + "k GPD" +
                "<br>" + assessment;
        }
    }

    // 53. Force Main Friction Loss (Hazen-Williams)
    function calcHazen() {
        const flow = parseFloat(document.getElementById('hz_flow').value) || 0;
        const c = parseFloat(document.getElementById('hz_c').value) || 0;
        const dia = parseFloat(document.getElementById('hz_dia').value) || 0;
        const len = parseFloat(document.getElementById('hz_len').value) || 0;
        
        if (flow > 0 && c > 0 && dia > 0 && len > 0) {
            // Hazen-Williams: hf/L = (4.52 √ó Q^1.85) / (C^1.85 √ó D^4.87) where Q in GPM, D in inches
            const hfPer100 = (4.52 * Math.pow(flow, 1.85)) / (Math.pow(c, 1.85) * Math.pow(dia, 4.87));
            const totalHf = hfPer100 * (len / 1); // hfPer100 is already per foot, multiply by length
            // Actually the formula gives hf in ft per ft of pipe
            // Let me recalculate: standard form gives ft headloss per ft of pipe
            const totalLoss = hfPer100 * len;
            
            document.getElementById('hz_res').innerText = totalLoss.toFixed(2) + " ft loss";
            const stat = document.getElementById('hz_status');
            
            const vel = flow * 0.4085 / (dia * dia);
            const lossPsi = totalLoss / 2.31;
            
            stat.innerHTML = "üìä <b>Friction Loss: " + totalLoss.toFixed(2) + " ft</b> (" + lossPsi.toFixed(2) + " psi)" +
                "<br>Loss rate: " + (hfPer100 * 100).toFixed(2) + " ft per 100 ft of pipe" +
                "<br>Velocity: " + vel.toFixed(2) + " fps | C=" + c + " | " + dia + "\" √ó " + len.toFixed(0) + " ft" +
                "<br><br>üí° Add 10‚Äì15% for fittings: ~" + (totalLoss * 1.15).toFixed(2) + " ft total estimated";
            stat.style.color = "#94a3b8";
        }
    }

    // ==================== FLOW MEASUREMENT CALCULATIONS ====================

    // 54. Weir Flow
    function calcWeir() {
        const type = document.getElementById('weir_type').value;
        const h = parseFloat(document.getElementById('weir_h').value) || 0;
        const l = parseFloat(document.getElementById('weir_l').value) || 0;
        
        if (h > 0) {
            let qCFS = 0;
            let formula = "";
            
            if (type === 'rect' && l > 0) {
                qCFS = 3.33 * l * Math.pow(h, 1.5);
                formula = "Q = 3.33 √ó " + l + " √ó " + h + "^1.5 (suppressed)";
            } else if (type === 'rect_c' && l > 0) {
                const lEff = l - (0.2 * h);
                qCFS = 3.33 * lEff * Math.pow(h, 1.5);
                formula = "Q = 3.33 √ó (" + l + " ‚àí 0.2√ó" + h + ") √ó " + h + "^1.5 (contracted)";
            } else if (type === 'vnot') {
                qCFS = 2.5 * Math.pow(h, 2.5);
                formula = "Q = 2.5 √ó " + h + "^2.5 (90¬∞ V-notch)";
            } else if (type === 'cip' && l > 0) {
                qCFS = 3.367 * l * Math.pow(h, 1.5);
                formula = "Q = 3.367 √ó " + l + " √ó " + h + "^1.5 (Cipolletti)";
            } else {
                return;
            }
            
            const qGPM = qCFS * 448.83;
            const qMGD = qGPM * 0.00144;
            
            document.getElementById('weir_res').innerText = qGPM.toFixed(1) + " GPM (" + qMGD.toFixed(4) + " MGD)";
            const stat = document.getElementById('weir_status');
            
            stat.innerHTML = "üìä " + formula +
                "<br>Flow: <b>" + qCFS.toFixed(3) + " CFS</b> | " + qGPM.toFixed(1) + " GPM | " + qMGD.toFixed(4) + " MGD" +
                "<br>Head: " + h + " ft (" + (h*12).toFixed(1) + " inches)";
            stat.style.color = "#94a3b8";
        }
    }

    // 55. Area-Velocity Flow
    function calcAV() {
        const type = document.getElementById('av_type').value;
        const vel = parseFloat(document.getElementById('av_vel').value) || 0;
        const dim1 = parseFloat(document.getElementById('av_dim1').value) || 0;
        const dim2 = parseFloat(document.getElementById('av_dim2').value) || 0;
        
        if (vel > 0 && dim1 > 0) {
            let area = 0;
            let desc = "";
            
            if (type === 'pipe') {
                const dFt = dim1 / 12;
                area = Math.PI * Math.pow(dFt/2, 2);
                desc = dim1 + "\" pipe (full) | Area: " + area.toFixed(4) + " ft¬≤";
            } else if (type === 'rect' && dim2 > 0) {
                area = dim1 * dim2;
                desc = dim1 + " ft wide √ó " + dim2 + " ft deep | Area: " + area.toFixed(2) + " ft¬≤";
            } else {
                return;
            }
            
            const qCFS = area * vel;
            const qGPM = qCFS * 448.83;
            const qMGD = qGPM * 0.00144;
            
            document.getElementById('av_res').innerText = qGPM.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPM";
            const stat = document.getElementById('av_status');
            
            stat.innerHTML = "üìä Q = A √ó V = " + area.toFixed(4) + " ft¬≤ √ó " + vel + " fps" +
                "<br>Flow: <b>" + qCFS.toFixed(2) + " CFS</b> | " + qGPM.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPM | " + qMGD.toFixed(4) + " MGD" +
                "<br>" + desc;
            stat.style.color = "#94a3b8";
        }
    }

    // ==================== TRICKLING FILTER CALCULATIONS ====================

    // 56. NRC Equation
    function calcNRC() {
        const bod = parseFloat(document.getElementById('nrc_bod').value) || 0;
        const vol = parseFloat(document.getElementById('nrc_vol').value) || 0;
        const recirc = parseFloat(document.getElementById('nrc_recirc').value) || 0;
        
        if (bod > 0 && vol > 0) {
            const f = Math.pow(1 + recirc, 2) / Math.pow(1 + 0.1 * recirc, 2); // recirculation factor
            // NRC: E = 1 / (1 + 0.4432 * sqrt(W/(V*F)))
            const e = 1 / (1 + 0.4432 * Math.sqrt(bod / (vol * f)));
            const ePct = e * 100;
            const effBOD = (1 - e) * (bod / (vol > 0 ? 1 : 1)); // This needs influent BOD concentration
            
            document.getElementById('nrc_res').innerText = ePct.toFixed(1) + "% efficiency";
            const stat = document.getElementById('nrc_status');
            
            let assessment = "";
            if (ePct >= 85) assessment = "‚úì <b>Excellent:</b> High efficiency ‚Äî well within design";
            else if (ePct >= 65) assessment = "‚úì <b>Typical:</b> Normal TF performance range";
            else if (ePct >= 50) assessment = "‚ö†Ô∏è <b>Low:</b> May need increased recirculation or reduced loading";
            else assessment = "üö® <b>Poor:</b> Filter is overloaded. Reduce loading or add recirculation.";
            
            stat.innerHTML = "üìä NRC Efficiency: <b>" + ePct.toFixed(1) + "%</b>" +
                "<br>BOD loading: " + bod + " lbs/day | Volume: " + vol + " √ó 1000 ft¬≥" +
                "<br>Recirculation factor (F): " + f.toFixed(2) + " (R=" + recirc + ")" +
                "<br>" + assessment;
            stat.style.color = "#94a3b8";
        }
    }

    // 57. TF Hydraulic Loading
    function calcTFL() {
        const flow = parseFloat(document.getElementById('tfl_flow').value) || 0;
        const dia = parseFloat(document.getElementById('tfl_dia').value) || 0;
        const bod = parseFloat(document.getElementById('tfl_bod').value) || 0;
        const depth = parseFloat(document.getElementById('tfl_depth').value) || 0;
        
        if (flow > 0 && dia > 0) {
            const area = Math.PI * Math.pow(dia/2, 2);
            const flowGPD = flow * 1000000;
            const hydLoad = flowGPD / area;
            
            document.getElementById('tfl_res').innerText = hydLoad.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPD/ft¬≤";
            const stat = document.getElementById('tfl_status');
            
            let classification = "";
            if (hydLoad <= 100) classification = "üìó <b>Low-rate</b> (25‚Äì100 GPD/ft¬≤) ‚Äî nitrification possible, no recirc needed";
            else if (hydLoad <= 300) classification = "üìò <b>Standard-rate</b> (100‚Äì300 GPD/ft¬≤) ‚Äî good BOD removal with recirc";
            else if (hydLoad <= 1000) classification = "üìô <b>High-rate</b> (300‚Äì1000 GPD/ft¬≤) ‚Äî BOD removal, recirc required";
            else classification = "üìï <b>Super-high-rate</b> (>1000 GPD/ft¬≤) ‚Äî roughing filter only";
            
            let orgInfo = "";
            if (bod > 0 && depth > 0) {
                const vol1000 = (area * depth) / 1000;
                const orgLoad = (flow * bod * 8.34) / vol1000;
                orgInfo = "<br>Organic loading: <b>" + orgLoad.toFixed(1) + " lbs BOD/1000 ft¬≥/day</b>";
                if (orgLoad <= 15) orgInfo += " ‚Äî Low-rate range";
                else if (orgLoad <= 30) orgInfo += " ‚Äî Standard range";
                else if (orgLoad <= 100) orgInfo += " ‚Äî High-rate range";
                else orgInfo += " ‚Äî ‚ö†Ô∏è Very high loading";
            }
            
            stat.innerHTML = "üìä Hydraulic loading: <b>" + hydLoad.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPD/ft¬≤</b>" +
                "<br>Filter: " + dia + " ft diameter | Area: " + area.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " ft¬≤" +
                orgInfo +
                "<br>" + classification;
            stat.style.color = "#94a3b8";
        }
    }

    // ==================== LAGOON CALCULATIONS ====================

    // 58. Pond BOD Loading
    function calcPond() {
        const flow = parseFloat(document.getElementById('pnd_flow').value) || 0;
        const bod = parseFloat(document.getElementById('pnd_bod').value) || 0;
        const acres = parseFloat(document.getElementById('pnd_acres').value) || 0;
        const depth = parseFloat(document.getElementById('pnd_depth').value) || 0;
        
        if (flow > 0 && bod > 0 && acres > 0) {
            const lbsBOD = flow * bod * 8.34;
            const loading = lbsBOD / acres;
            
            document.getElementById('pnd_res').innerText = loading.toFixed(1) + " lbs BOD/acre/day";
            const stat = document.getElementById('pnd_status');
            
            let assessment = "";
            if (loading <= 35) { assessment = "‚úì <b>Conservative:</b> Well within Texas climate limits"; stat.style.color = "#4ade80"; }
            else if (loading <= 50) { assessment = "‚úì <b>Normal:</b> Typical facultative pond range for Texas (35‚Äì50)"; stat.style.color = "#4ade80"; }
            else if (loading <= 80) { assessment = "‚ö†Ô∏è <b>Elevated:</b> May develop odor issues. Consider aeration."; stat.style.color = "var(--accent)"; }
            else { assessment = "üö® <b>Overloaded:</b> Anaerobic conditions likely. Odor complaints and TCEQ violations."; stat.style.color = "var(--danger)"; }
            
            let hrtInfo = "";
            if (depth > 0) {
                const volGal = acres * 43560 * depth * 7.48;
                const hrt = volGal / (flow * 1000000);
                hrtInfo = "<br>Pond volume: " + (volGal/1000000).toFixed(2) + " MG | HRT: <b>" + hrt.toFixed(0) + " days</b>";
                if (hrt < 90) hrtInfo += " ‚Äî ‚ö†Ô∏è Short HRT. Risk of short-circuiting.";
                else if (hrt <= 180) hrtInfo += " ‚Äî ‚úì Typical range (90‚Äì180 days)";
                else hrtInfo += " ‚Äî Long retention ‚Äî good treatment buffer";
            }
            
            stat.innerHTML = "üìä BOD load: " + lbsBOD.toFixed(0) + " lbs/day on " + acres + " acres" +
                "<br>Loading: <b>" + loading.toFixed(1) + " lbs BOD/acre/day</b>" +
                hrtInfo +
                "<br>" + assessment;
        }
    }

    // ==================== AERATION CALCULATIONS ====================

    // 59. SOTR to AOTR
    function calcAOTR() {
        const sotr = parseFloat(document.getElementById('ao_sotr').value) || 0;
        const alpha = parseFloat(document.getElementById('ao_alpha').value) || 0;
        const beta = parseFloat(document.getElementById('ao_beta').value) || 0;
        const temp = parseFloat(document.getElementById('ao_temp').value) || 0;
        const dO = parseFloat(document.getElementById('ao_do').value) || 0;
        const alt = parseFloat(document.getElementById('ao_alt').value) || 0;
        
        if (sotr > 0 && alpha > 0 && beta > 0) {
            const theta = 1.024;
            const cs20 = 9.09; // DO saturation at 20¬∞C, sea level
            
            // Temperature correction for saturation
            // Approximate CS at different temps
            const csTemp = 14.62 - (0.3898 * temp) + (0.006969 * temp * temp) - (0.00005896 * temp * temp * temp);
            
            // Altitude correction (approx: reduce 3.5% per 1000 ft)
            const altFactor = 1 - (alt * 0.000035);
            const csAlt = csTemp * altFactor;
            
            // AOTR = SOTR √ó alpha √ó [(beta √ó CS_alt √ó theta^(T-20) - DO) / CS_20]
            const tempFactor = Math.pow(theta, temp - 20);
            const aotr = sotr * alpha * ((beta * csAlt * tempFactor - dO) / cs20);
            const ratio = (aotr / sotr * 100);
            
            document.getElementById('ao_res').innerText = aotr.toFixed(1) + " lbs O‚ÇÇ/hr AOTR";
            const stat = document.getElementById('ao_status');
            
            stat.innerHTML = "üìä <b>SOTR: " + sotr + " ‚Üí AOTR: " + aotr.toFixed(1) + " lbs O‚ÇÇ/hr</b>" +
                "<br>Actual is <b>" + ratio.toFixed(0) + "%</b> of standard ‚Äî you need " + (100/ratio*100).toFixed(0) + "% more blower capacity than theoretical" +
                "<br><br>üìã <b>Correction Factors:</b>" +
                "<br>Œ± (wastewater): " + alpha + " | Œ≤ (salinity): " + beta +
                "<br>CS at " + temp + "¬∞C: " + csAlt.toFixed(2) + " mg/L (alt-corrected) | Operating DO: " + dO + " mg/L" +
                "<br>Œ∏^(T-20): " + tempFactor.toFixed(3) + " | Altitude factor: " + altFactor.toFixed(4);
            stat.style.color = "#94a3b8";
        }
    }

    // ==================== RECEIVING WATER CALCULATIONS ====================

    // 60. Dilution / Mixing Zone
    function calcDilute() {
        const eFlow = parseFloat(document.getElementById('dil_eflow').value) || 0;
        const eConc = parseFloat(document.getElementById('dil_econc').value) || 0;
        const sFlow = parseFloat(document.getElementById('dil_sflow').value) || 0;
        const sConc = parseFloat(document.getElementById('dil_sconc').value) || 0;
        
        if (eFlow > 0 && sFlow > 0) {
            const mixConc = ((eFlow * eConc) + (sFlow * sConc)) / (eFlow + sFlow);
            const dilRatio = sFlow / eFlow;
            const pctReduction = ((eConc - mixConc) / eConc * 100);
            
            document.getElementById('dil_res').innerText = mixConc.toFixed(2) + " mg/L downstream";
            const stat = document.getElementById('dil_status');
            
            stat.innerHTML = "üìä <b>Mixed Concentration: " + mixConc.toFixed(2) + " mg/L</b>" +
                "<br>Effluent: " + eFlow + " MGD √ó " + eConc + " mg/L" +
                "<br>Stream: " + sFlow + " MGD √ó " + sConc + " mg/L" +
                "<br>Combined flow: " + (eFlow + sFlow).toFixed(2) + " MGD" +
                "<br><br>Dilution ratio: <b>" + dilRatio.toFixed(1) + ":1</b> (stream:effluent)" +
                "<br>Concentration reduced <b>" + pctReduction.toFixed(1) + "%</b> from effluent to downstream";
            stat.style.color = "#94a3b8";
        }
    }

    // ==================== POPULATION CALCULATIONS ====================

    // 61. Population Equivalent (Enhanced v2)
    function calcPE() {
        const flow = parseFloat(document.getElementById('pe_flow').value) || 0;
        const bod = parseFloat(document.getElementById('pe_bod').value) || 0;
        const tss = parseFloat(document.getElementById('pe_tss').value) || 0;
        const tkn = parseFloat(document.getElementById('pe_tkn').value) || 0;
        const pop = parseFloat(document.getElementById('pe_pop').value) || 0;
        const permit = parseFloat(document.getElementById('pe_permit').value) || 0;
        const growth = parseFloat(document.getElementById('pe_growth').value) || 0;
        const peak = parseFloat(document.getElementById('pe_peak').value) || 0;
        
        if (flow <= 0) return;
        
        const flowGPD = flow * 1000000;
        const peFlow = flowGPD / 100;
        const lbsBOD = flow * bod * 8.34;
        const peBOD = bod > 0 ? lbsBOD / 0.17 : 0;
        const lbsTSS = flow * tss * 8.34;
        const peTSS = tss > 0 ? lbsTSS / 0.20 : 0;
        const lbsTKN = flow * tkn * 8.34;
        const peTKN = tkn > 0 ? lbsTKN / 0.03 : 0;
        
        // Governing PE (highest)
        const peValues = [{val: peFlow, label: 'Flow', color: '#3b82f6'}];
        if (peBOD > 0) peValues.push({val: peBOD, label: 'BOD', color: '#f59e0b'});
        if (peTSS > 0) peValues.push({val: peTSS, label: 'TSS', color: '#8b5cf6'});
        if (peTKN > 0) peValues.push({val: peTKN, label: 'TKN', color: '#10b981'});
        const governing = peValues.reduce((max, pe) => pe.val > max.val ? pe : max, peValues[0]);
        const eduGoverning = governing.val / 3.5;
        
        document.getElementById('pe_res').innerText = "Governing PE: " + Math.round(governing.val).toLocaleString() + " (" + governing.label + ") | " + Math.round(eduGoverning).toLocaleString() + " EDU";
        const stat = document.getElementById('pe_status');
        
        // ===== PE COMPARISON GAUGES =====
        const maxPE = Math.max(peFlow, peBOD, peTSS, peTKN) * 1.15;
        let info = "<div style='margin-bottom:8px'><b>Population Equivalent Comparison:</b></div>";
        
        peValues.forEach(function(pe) {
            const pct = (pe.val / maxPE * 100).toFixed(0);
            const isGov = pe.label === governing.label;
            info += "<div style='display:flex;align-items:center;margin:4px 0;gap:8px'>" +
                "<span style='width:36px;font-size:0.75rem;color:" + pe.color + ";font-weight:bold'>" + pe.label + "</span>" +
                "<div style='flex:1;background:#1e293b;border-radius:4px;height:18px;position:relative;overflow:hidden'>" +
                "<div style='background:" + pe.color + ";height:100%;width:" + pct + "%;border-radius:4px;transition:width 0.3s'></div>" +
                "<span style='position:absolute;right:6px;top:0;line-height:18px;font-size:0.65rem;font-weight:bold;color:#f8fafc'>" + Math.round(pe.val).toLocaleString() + " PE</span>" +
                "</div>" +
                (isGov ? "<span style='font-size:0.65rem;background:#d946ef;color:#fff;padding:1px 5px;border-radius:3px;font-weight:bold'>GOV</span>" : "<span style='width:30px'></span>") +
                "</div>";
        });
        
        // EDU conversion
        info += "<div style='margin-top:6px;padding:6px 8px;background:rgba(217,70,239,0.1);border-radius:4px;font-size:0.8rem'>" +
            "<b>EDU (3.5 persons/unit):</b> " + Math.round(eduGoverning).toLocaleString() + " equivalent dwelling units" +
            "</div>";
        
        // ===== WASTEWATER CHARACTER =====
        if (bod > 0 || tss > 0) {
            info += "<br><b>Wastewater Character Analysis:</b>";
            
            // Industrial vs Domestic split estimate
            if (peBOD > 0) {
                const domesticPE = peFlow; // flow-based = domestic baseline
                const industrialPE = Math.max(0, peBOD - domesticPE);
                const industrialPct = (industrialPE / peBOD * 100);
                const domesticPct = 100 - industrialPct;
                
                if (industrialPct > 5) {
                    info += "<br><div style='margin:4px 0'>" +
                        "<span style='font-size:0.75rem'>Estimated Load Split:</span>" +
                        "<div style='display:flex;height:14px;border-radius:4px;overflow:hidden;margin:3px 0'>" +
                        "<div style='background:#4ade80;width:" + domesticPct.toFixed(0) + "%;display:flex;align-items:center;justify-content:center;font-size:0.6rem;font-weight:bold;color:#0f172a'>" + domesticPct.toFixed(0) + "% Dom</div>" +
                        "<div style='background:#f59e0b;width:" + industrialPct.toFixed(0) + "%;display:flex;align-items:center;justify-content:center;font-size:0.6rem;font-weight:bold;color:#0f172a'>" + industrialPct.toFixed(0) + "% Ind</div>" +
                        "</div>" +
                        "<span style='font-size:0.7rem;color:#94a3b8'>Industrial BOD contribution: ~" + Math.round(industrialPE * 0.17).toLocaleString() + " lbs/day (" + Math.round(industrialPE).toLocaleString() + " PE)</span>" +
                        "</div>";
                } else {
                    info += "<br>Predominantly domestic wastewater (&lt;5% industrial BOD)";
                }
            }
            
            // Ratios
            if (tss > 0 && bod > 0) {
                const btsRatio = bod / tss;
                info += "<br>BOD:TSS = <b>" + btsRatio.toFixed(2) + "</b>";
                if (btsRatio > 1.2) info += " (high organic strength &mdash; food processing/industrial?)";
                else if (btsRatio >= 0.7) info += " (typical domestic: 0.7&ndash;1.2)";
                else info += " (high inerts &mdash; construction runoff, sandy I/I?)";
            }
            if (tkn > 0 && bod > 0) {
                const tknBod = tkn / bod;
                info += "<br>TKN:BOD = <b>" + tknBod.toFixed(2) + "</b>";
                if (tknBod > 0.25) info += " (nitrogen-rich &mdash; septic hauling, food waste?)";
                else if (tknBod >= 0.12) info += " (typical domestic: 0.12&ndash;0.25)";
                else info += " (low nitrogen &mdash; industrial dilution)";
            }
            
            // Strength classification
            info += "<br>Strength: ";
            if (bod < 100) info += "<span style='color:#60a5fa'><b>Weak</b></span> (&lt;100 mg/L)";
            else if (bod <= 200) info += "<span style='color:#4ade80'><b>Medium</b></span> (100&ndash;200)";
            else if (bod <= 300) info += "<span style='color:#fbbf24'><b>Strong</b></span> (200&ndash;300)";
            else info += "<span style='color:#ef4444'><b>Very Strong</b></span> (&gt;300 mg/L)";
        }
        
        // ===== PER CAPITA + VISUAL BARS =====
        if (pop > 0) {
            const perCapFlow = flowGPD / pop;
            const perCapBOD = bod > 0 ? lbsBOD / pop : 0;
            const perCapTSS = tss > 0 ? lbsTSS / pop : 0;
            const perCapTKN = tkn > 0 ? lbsTKN / pop : 0;
            
            info += "<br><br><b>Per Capita Loading (pop: " + Math.round(pop).toLocaleString() + "):</b>";
            
            var metrics = [
                {label:'Flow', val: perCapFlow, std: 100, unit: 'GPD', dec: 0},
                {label:'BOD', val: perCapBOD, std: 0.17, unit: 'lbs', dec: 3},
                {label:'TSS', val: perCapTSS, std: 0.20, unit: 'lbs', dec: 3},
                {label:'TKN', val: perCapTKN, std: 0.03, unit: 'lbs', dec: 4}
            ];
            
            metrics.forEach(function(m) {
                if (m.val <= 0) return;
                var pct = Math.min((m.val / m.std) * 100, 150);
                var ratio = m.val / m.std;
                var barColor = ratio > 1.3 ? 'var(--accent)' : ratio < 0.7 ? '#3b82f6' : '#4ade80';
                info += "<div style='display:flex;align-items:center;gap:6px;margin:3px 0'>" +
                    "<span style='width:32px;font-size:0.7rem;font-weight:bold;color:#94a3b8'>" + m.label + "</span>" +
                    "<div style='flex:1;background:#1e293b;border-radius:4px;height:10px;position:relative'>" +
                    "<div style='position:absolute;left:" + Math.min(100/1.5, 66.7) + "%;top:0;bottom:0;width:1px;background:#94a3b8;opacity:0.5'></div>" +
                    "<div style='background:" + barColor + ";height:100%;border-radius:4px;width:" + Math.min(pct/1.5, 100) + "%'></div>" +
                    "</div>" +
                    "<span style='width:90px;font-size:0.7rem;text-align:right'><b>" + m.val.toFixed(m.dec) + "</b> " + m.unit + " <span style='color:#64748b'>(" + m.std + ")</span></span>" +
                    "</div>";
            });
            info += "<span style='font-size:0.65rem;color:#475569'>Vertical line = per capita standard | Green = normal | Yellow = elevated | Blue = low</span>";
        }
        
        // ===== PEAKING FACTOR DESIGN =====
        if (peak > 0) {
            const peakFlow = flow * peak;
            const peakGPD = flowGPD * peak;
            const peakPE = peakGPD / 100;
            
            info += "<br><br><b>Peaking Factor Design (PF: " + peak + "):</b>";
            info += "<br>Average flow: " + flow.toFixed(3) + " MGD | Peak flow: <b>" + peakFlow.toFixed(3) + " MGD</b>";
            info += "<br>Peak PE: <b>" + Math.round(peakPE).toLocaleString() + "</b> | Peak EDU: <b>" + Math.round(peakPE/3.5).toLocaleString() + "</b>";
            
            if (permit > 0) {
                const peakCapPct = (peakFlow / permit * 100);
                info += "<br>Peak vs permitted: <b>" + peakCapPct.toFixed(0) + "%</b>";
                if (peakCapPct > 100) info += " <span style='color:var(--danger)'>&#128680; PEAK EXCEEDS PERMITTED CAPACITY</span>";
                else if (peakCapPct > 85) info += " <span style='color:var(--accent)'>&#9888;&#65039; Peak near permit limit</span>";
                else info += " <span style='color:#4ade80'>&#9989; Peak within limits</span>";
            }
            
            // Peaking factor assessment
            if (pop > 0) {
                var expectedPF;
                if (pop < 1000) expectedPF = "3.5-4.0 (small system)";
                else if (pop < 10000) expectedPF = "2.5-3.5 (small-medium)";
                else if (pop < 100000) expectedPF = "2.0-2.5 (medium)";
                else expectedPF = "1.5-2.0 (large system)";
                info += "<br>Expected PF for " + Math.round(pop).toLocaleString() + " pop: " + expectedPF;
            }
        }
        
        // ===== CAPACITY ANALYSIS =====
        if (permit > 0) {
            const capPct = (flow / permit * 100);
            const remainMGD = permit - flow;
            const remainPE = (remainMGD * 1000000) / 100;
            const remainEDU = remainPE / 3.5;
            
            info += "<br><br><b>Capacity Analysis:</b>";
            info += "<br>Permitted: " + permit + " MGD | Current: " + flow + " MGD | Remaining: " + remainMGD.toFixed(3) + " MGD";
            
            // Capacity bar with milestone markers
            info += "<div style='position:relative;margin:6px 0'>" +
                "<div style='background:#1e293b;border-radius:4px;height:20px;position:relative;overflow:hidden'>" +
                "<div style='position:absolute;left:75%;top:0;bottom:0;width:1px;background:#fbbf24;z-index:1'></div>" +
                "<div style='position:absolute;left:90%;top:0;bottom:0;width:1px;background:#ef4444;z-index:1'></div>" +
                "<div style='background:" + (capPct > 90 ? "var(--danger)" : capPct > 75 ? "var(--accent)" : "#4ade80") +
                ";height:100%;width:" + Math.min(capPct, 100) + "%;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:0.7rem;font-weight:bold;color:#0f172a'>" + capPct.toFixed(1) + "%</div>" +
                "</div>" +
                "<div style='display:flex;justify-content:space-between;font-size:0.6rem;color:#64748b;margin-top:1px'>" +
                "<span>0%</span><span style='margin-left:50%'>|75% TCEQ</span><span style='margin-left:auto'>|90%</span><span>100%</span>" +
                "</div></div>";
            
            if (capPct >= 95) info += "&#128680; <b>AT CAPACITY</b> &mdash; Expansion required immediately. TCEQ enforcement risk.";
            else if (capPct >= 80) info += "&#9888;&#65039; <b>Approaching capacity.</b> Engineering report and expansion timeline required.";
            else if (capPct >= 75) info += "&#9888;&#65039; <b>75% TCEQ trigger.</b> Capacity planning report required per 30 TAC 217.";
            else info += "&#9989; Within capacity. <b>" + remainMGD.toFixed(3) + " MGD remaining</b> (" + Math.round(remainPE).toLocaleString() + " PE / " + Math.round(remainEDU).toLocaleString() + " EDU)";
            
            // Growth Projection
            if (growth > 0 && capPct < 100) {
                info += "<br><br><b>Growth Projection @ " + growth + "%/yr:</b>";
                
                // Timeline milestones
                var projFlow = flow;
                var yr75 = 0, yr80 = 0, yr90 = 0, yr100 = 0;
                for (var yr = 1; yr <= 50; yr++) {
                    projFlow *= (1 + growth/100);
                    if (projFlow >= permit * 0.75 && yr75 === 0) yr75 = yr;
                    if (projFlow >= permit * 0.80 && yr80 === 0) yr80 = yr;
                    if (projFlow >= permit * 0.90 && yr90 === 0) yr90 = yr;
                    if (projFlow >= permit && yr100 === 0) yr100 = yr;
                }
                
                // Visual timeline bar
                var thisYear = new Date().getFullYear();
                var maxYr = yr100 > 0 ? yr100 : 50;
                var timelineHTML = "<div style='background:#1e293b;border-radius:4px;height:24px;position:relative;margin:6px 0;overflow:hidden'>";
                if (yr75 > 0 && capPct < 75) timelineHTML += "<div style='position:absolute;left:" + (yr75/maxYr*100) + "%;top:0;bottom:0;width:2px;background:#fbbf24;z-index:1' title='75%'></div>" +
                    "<div style='position:absolute;left:" + (yr75/maxYr*100) + "%;top:1px;font-size:0.55rem;color:#fbbf24;padding-left:3px'>75%<br>" + (thisYear+yr75) + "</div>";
                if (yr90 > 0) timelineHTML += "<div style='position:absolute;left:" + (yr90/maxYr*100) + "%;top:0;bottom:0;width:2px;background:#f97316;z-index:1' title='90%'></div>" +
                    "<div style='position:absolute;left:" + (yr90/maxYr*100) + "%;top:1px;font-size:0.55rem;color:#f97316;padding-left:3px'>90%<br>" + (thisYear+yr90) + "</div>";
                if (yr100 > 0) timelineHTML += "<div style='position:absolute;left:" + Math.min(yr100/maxYr*100,98) + "%;top:0;bottom:0;width:2px;background:#ef4444;z-index:1' title='100%'></div>" +
                    "<div style='position:absolute;left:" + Math.min(yr100/maxYr*100,98) + "%;top:1px;font-size:0.55rem;color:#ef4444;padding-left:3px'>100%<br>" + (thisYear+yr100) + "</div>";
                timelineHTML += "</div>";
                info += timelineHTML;
                
                if (capPct < 75 && yr75 > 0) info += "<br>&#128310; 75% TCEQ planning trigger: <b>" + yr75 + " years</b> (" + (thisYear+yr75) + ")";
                if (capPct < 80 && yr80 > 0) info += "<br>&#128992; 80% capacity: <b>" + yr80 + " years</b> (" + (thisYear+yr80) + ")";
                if (yr90 > 0) info += "<br>&#128308; 90% capacity: <b>" + yr90 + " years</b> (" + (thisYear+yr90) + ")";
                if (yr100 > 0) info += "<br>&#9899; 100% capacity: <b>" + yr100 + " years</b> (" + (thisYear+yr100) + ")";
                else info += "<br>100% capacity: &gt;50 years at current growth";
                
                // 5/10/20 year table
                var proj5 = flow * Math.pow(1 + growth/100, 5);
                var proj10 = flow * Math.pow(1 + growth/100, 10);
                var proj20 = flow * Math.pow(1 + growth/100, 20);
                var pop5 = pop > 0 ? pop * Math.pow(1 + growth/100, 5) : 0;
                var pop10 = pop > 0 ? pop * Math.pow(1 + growth/100, 10) : 0;
                var pop20 = pop > 0 ? pop * Math.pow(1 + growth/100, 20) : 0;
                
                info += "<br><div style='margin-top:6px;font-size:0.75rem'>" +
                    "<div style='display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:2px;text-align:center'>" +
                    "<div style='background:#1e293b;padding:3px;border-radius:3px;font-weight:bold;color:#94a3b8'>Year</div>" +
                    "<div style='background:#1e293b;padding:3px;border-radius:3px;font-weight:bold;color:#94a3b8'>5-yr (" + (thisYear+5) + ")</div>" +
                    "<div style='background:#1e293b;padding:3px;border-radius:3px;font-weight:bold;color:#94a3b8'>10-yr (" + (thisYear+10) + ")</div>" +
                    "<div style='background:#1e293b;padding:3px;border-radius:3px;font-weight:bold;color:#94a3b8'>20-yr (" + (thisYear+20) + ")</div>" +
                    "<div style='padding:2px;color:#94a3b8'>Flow</div>" +
                    "<div style='padding:2px'>" + proj5.toFixed(3) + " MGD</div>" +
                    "<div style='padding:2px'>" + proj10.toFixed(3) + " MGD</div>" +
                    "<div style='padding:2px'>" + proj20.toFixed(3) + " MGD</div>" +
                    "<div style='padding:2px;color:#94a3b8'>Cap %</div>" +
                    "<div style='padding:2px;color:" + (proj5/permit*100 > 90 ? "var(--danger)" : proj5/permit*100 > 75 ? "var(--accent)" : "#4ade80") + "'><b>" + (proj5/permit*100).toFixed(0) + "%</b></div>" +
                    "<div style='padding:2px;color:" + (proj10/permit*100 > 90 ? "var(--danger)" : proj10/permit*100 > 75 ? "var(--accent)" : "#4ade80") + "'><b>" + (proj10/permit*100).toFixed(0) + "%</b></div>" +
                    "<div style='padding:2px;color:" + (proj20/permit*100 > 90 ? "var(--danger)" : proj20/permit*100 > 75 ? "var(--accent)" : "#4ade80") + "'><b>" + (proj20/permit*100).toFixed(0) + "%</b></div>";
                if (pop > 0) {
                    info += "<div style='padding:2px;color:#94a3b8'>Pop</div>" +
                        "<div style='padding:2px'>" + Math.round(pop5).toLocaleString() + "</div>" +
                        "<div style='padding:2px'>" + Math.round(pop10).toLocaleString() + "</div>" +
                        "<div style='padding:2px'>" + Math.round(pop20).toLocaleString() + "</div>";
                }
                info += "</div></div>";
            }
        }
        
        // ===== TCEQ REPORT SUMMARY =====
        var reportLines = [];
        reportLines.push("POPULATION EQUIVALENT & CAPACITY ANALYSIS");
        reportLines.push("=========================================");
        reportLines.push("Date: " + new Date().toLocaleDateString());
        reportLines.push("");
        reportLines.push("PLANT LOADING:");
        reportLines.push("  Average Daily Flow:  " + flow.toFixed(3) + " MGD (" + flowGPD.toLocaleString() + " GPD)");
        if (bod > 0) reportLines.push("  Influent BOD:        " + bod + " mg/L (" + lbsBOD.toFixed(0) + " lbs/day)");
        if (tss > 0) reportLines.push("  Influent TSS:        " + tss + " mg/L (" + lbsTSS.toFixed(0) + " lbs/day)");
        if (tkn > 0) reportLines.push("  Influent TKN:        " + tkn + " mg/L (" + lbsTKN.toFixed(0) + " lbs/day)");
        reportLines.push("");
        reportLines.push("POPULATION EQUIVALENTS:");
        reportLines.push("  From Flow (100 GPD/cap):   " + Math.round(peFlow).toLocaleString() + " PE");
        if (peBOD > 0) reportLines.push("  From BOD (0.17 lbs/cap):   " + Math.round(peBOD).toLocaleString() + " PE");
        if (peTSS > 0) reportLines.push("  From TSS (0.20 lbs/cap):   " + Math.round(peTSS).toLocaleString() + " PE");
        if (peTKN > 0) reportLines.push("  From TKN (0.03 lbs/cap):   " + Math.round(peTKN).toLocaleString() + " PE");
        reportLines.push("  GOVERNING PE:              " + Math.round(governing.val).toLocaleString() + " (" + governing.label + ")");
        reportLines.push("  Equivalent Dwelling Units:  " + Math.round(eduGoverning).toLocaleString() + " EDU (3.5 cap/EDU)");
        if (pop > 0) {
            reportLines.push("");
            reportLines.push("SERVICE AREA:");
            reportLines.push("  Actual Population:    " + Math.round(pop).toLocaleString());
            reportLines.push("  Per Capita Flow:      " + (flowGPD/pop).toFixed(0) + " GPD/person (std: 100)");
            if (bod > 0) reportLines.push("  Per Capita BOD:       " + (lbsBOD/pop).toFixed(3) + " lbs/person (std: 0.17)");
            if (tss > 0) reportLines.push("  Per Capita TSS:       " + (lbsTSS/pop).toFixed(3) + " lbs/person (std: 0.20)");
            if (tkn > 0) reportLines.push("  Per Capita TKN:       " + (lbsTKN/pop).toFixed(4) + " lbs/person (std: 0.03)");
        }
        if (permit > 0) {
            var rptCapPct = (flow/permit*100);
            reportLines.push("");
            reportLines.push("CAPACITY:");
            reportLines.push("  Permitted Flow:       " + permit + " MGD");
            reportLines.push("  Current Utilization:  " + rptCapPct.toFixed(1) + "%");
            reportLines.push("  Remaining Capacity:   " + (permit-flow).toFixed(3) + " MGD (" + Math.round((permit-flow)*1000000/100).toLocaleString() + " PE)");
            if (rptCapPct >= 75) reportLines.push("  STATUS: *** EXCEEDS 75% TCEQ PLANNING THRESHOLD ***");
            if (growth > 0) {
                var pf2 = flow;
                var y100 = 0;
                for (var yy = 1; yy <= 50; yy++) { pf2 *= (1+growth/100); if (pf2 >= permit && y100===0) y100 = yy; }
                reportLines.push("");
                reportLines.push("GROWTH PROJECTION (" + growth + "%/yr):");
                var p5 = flow*Math.pow(1+growth/100,5);
                var p10 = flow*Math.pow(1+growth/100,10);
                var p20 = flow*Math.pow(1+growth/100,20);
                reportLines.push("  5-Year:  " + p5.toFixed(3) + " MGD (" + (p5/permit*100).toFixed(0) + "% capacity)");
                reportLines.push("  10-Year: " + p10.toFixed(3) + " MGD (" + (p10/permit*100).toFixed(0) + "% capacity)");
                reportLines.push("  20-Year: " + p20.toFixed(3) + " MGD (" + (p20/permit*100).toFixed(0) + "% capacity)");
                if (y100 > 0) reportLines.push("  Capacity Reached: " + y100 + " years (" + (new Date().getFullYear()+y100) + ")");
            }
        }
        if (peak > 0) {
            reportLines.push("");
            reportLines.push("PEAKING:");
            reportLines.push("  Peaking Factor:       " + peak);
            reportLines.push("  Peak Flow:            " + (flow*peak).toFixed(3) + " MGD");
            if (permit > 0) reportLines.push("  Peak vs Permit:       " + (flow*peak/permit*100).toFixed(1) + "%");
        }
        reportLines.push("");
        reportLines.push("Generated by WW Pro-Calc v9.1 | ProcessCore Systems");
        
        var reportText = reportLines.join("\n");
        var reportEl = document.getElementById('pe_report');
        var reportBtn = document.getElementById('pe_report_btn');
        reportEl.style.display = 'block';
        reportBtn.style.display = 'block';
        reportEl.innerText = reportText;
        reportEl.setAttribute('data-report', reportText);
        
        stat.innerHTML = info;
        stat.style.color = "#94a3b8";
    }

    function copyPEReport() {
        var reportEl = document.getElementById('pe_report');
        var text = reportEl.getAttribute('data-report') || reportEl.innerText;
        navigator.clipboard.writeText(text).then(function() {
            var btn = document.getElementById('pe_report_btn');
            btn.innerText = '‚úì Copied to Clipboard!';
            btn.style.background = 'rgba(74, 222, 128, 0.15)';
            btn.style.borderColor = '#4ade80';
            btn.style.color = '#4ade80';
            setTimeout(function() {
                btn.innerHTML = '&#128203; Copy TCEQ Report Summary';
                btn.style.background = 'rgba(217,70,239,0.1)';
                btn.style.borderColor = '#d946ef';
                btn.style.color = '#e879f9';
            }, 2000);
        });
    }

    // ==================== PARSHALL FLUME ====================

    // 62. Parshall Flume
    function calcParshall() {
        const widthIn = parseInt(document.getElementById('pf_width').value) || 0;
        const ha = parseFloat(document.getElementById('pf_ha').value) || 0;
        const hb = parseFloat(document.getElementById('pf_hb').value) || 0;
        
        if (widthIn > 0 && ha > 0) {
            // Parshall flume coefficients: Q = C √ó Ha^n (CFS)
            var coeffs = {
                3:  {c: 0.992, n: 1.547, subLimit: 0.50},
                6:  {c: 2.06,  n: 1.58,  subLimit: 0.60},
                9:  {c: 3.07,  n: 1.53,  subLimit: 0.60},
                12: {c: 4.00,  n: 1.522, subLimit: 0.70},
                18: {c: 6.00,  n: 1.538, subLimit: 0.70},
                24: {c: 8.00,  n: 1.550, subLimit: 0.70},
                36: {c: 12.00, n: 1.566, subLimit: 0.70},
                48: {c: 16.00, n: 1.578, subLimit: 0.70},
                60: {c: 20.00, n: 1.587, subLimit: 0.70},
                72: {c: 24.00, n: 1.595, subLimit: 0.70},
                96: {c: 32.00, n: 1.607, subLimit: 0.70}
            };
            
            var co = coeffs[widthIn];
            if (!co) return;
            
            var qCFS = co.c * Math.pow(ha, co.n);
            var qGPM = qCFS * 448.83;
            var qMGD = qGPM * 0.00144;
            
            document.getElementById('pf_res').innerText = qGPM.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPM (" + qMGD.toFixed(4) + " MGD)";
            var stat = document.getElementById('pf_status');
            
            var subInfo = "";
            if (hb > 0) {
                var subRatio = hb / ha;
                if (subRatio > co.subLimit) {
                    subInfo = "<br><span style='color:var(--accent)'>‚ö†Ô∏è SUBMERGED: Hb/Ha = " + subRatio.toFixed(2) + " (limit: " + co.subLimit + ")</span>" +
                        "<br>Free-flow reading is <b>NOT VALID</b>. Apply submergence correction or clear downstream obstruction.";
                } else {
                    subInfo = "<br>‚úì Free-flow confirmed: Hb/Ha = " + subRatio.toFixed(2) + " (limit: " + co.subLimit + ")";
                }
            }
            
            stat.innerHTML = "üìä <b>Free-Flow Discharge: " + qGPM.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPM</b>" +
                "<br>" + qCFS.toFixed(3) + " CFS | " + qMGD.toFixed(4) + " MGD" +
                "<br>Throat: " + widthIn + "\" | Ha: " + ha + " ft (" + (ha*12).toFixed(1) + " in) | C=" + co.c + " | n=" + co.n +
                subInfo +
                "<br><br>üìê Q = " + co.c + " √ó " + ha + "^" + co.n + " = " + qCFS.toFixed(3) + " CFS";
            stat.style.color = "#94a3b8";
        }
    }

    // ==================== TANK VOLUME ====================

    // 63. Tank Volume
    function calcTankVol() {
        var shape = document.getElementById('tv_shape').value;
        var dim1 = parseFloat(document.getElementById('tv_dim1').value) || 0;
        var dim2 = parseFloat(document.getElementById('tv_dim2').value) || 0;
        var depth = parseFloat(document.getElementById('tv_depth').value) || 0;
        var cone = parseFloat(document.getElementById('tv_cone').value) || 0;
        
        if (dim1 > 0 && depth > 0) {
            var volFt3 = 0;
            var desc = "";
            var areaFt2 = 0;
            
            if (shape === 'circ') {
                areaFt2 = Math.PI * Math.pow(dim1/2, 2);
                volFt3 = areaFt2 * depth;
                desc = "Circular: " + dim1 + " ft dia √ó " + depth + " ft SWD | Area: " + areaFt2.toFixed(1) + " ft¬≤";
            } else if (shape === 'rect' && dim2 > 0) {
                areaFt2 = dim1 * dim2;
                volFt3 = dim1 * dim2 * depth;
                desc = "Rectangular: " + dim1 + " √ó " + dim2 + " √ó " + depth + " ft | Area: " + areaFt2.toFixed(1) + " ft¬≤";
            } else if (shape === 'cone') {
                areaFt2 = Math.PI * Math.pow(dim1/2, 2);
                var cylVol = areaFt2 * depth;
                var coneVol = cone > 0 ? (Math.PI / 3) * Math.pow(dim1/2, 2) * cone : 0;
                volFt3 = cylVol + coneVol;
                desc = "Cone-bottom: " + dim1 + " ft dia √ó " + depth + " ft wall + " + cone + " ft cone";
            } else {
                return;
            }
            
            var volGal = volFt3 * 7.48;
            var volM3 = volFt3 * 0.02832;
            var volMG = volGal / 1000000;
            var volAcFt = volFt3 / 43560;
            
            document.getElementById('tv_res').innerText = volGal.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " gallons";
            var stat = document.getElementById('tv_status');
            
            stat.innerHTML = "üìä <b>Volume Results:</b>" +
                "<br>" + desc +
                "<br><br><div style='display:grid;grid-template-columns:1fr 1fr;gap:4px;font-size:0.85rem'>" +
                "<div style='background:#1e293b;padding:6px 8px;border-radius:4px'><span style='color:#94a3b8'>Gallons:</span><br><b>" + volGal.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + "</b></div>" +
                "<div style='background:#1e293b;padding:6px 8px;border-radius:4px'><span style='color:#94a3b8'>ft¬≥:</span><br><b>" + volFt3.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + "</b></div>" +
                "<div style='background:#1e293b;padding:6px 8px;border-radius:4px'><span style='color:#94a3b8'>MG:</span><br><b>" + volMG.toFixed(4) + "</b></div>" +
                "<div style='background:#1e293b;padding:6px 8px;border-radius:4px'><span style='color:#94a3b8'>m¬≥:</span><br><b>" + volM3.toFixed(1) + "</b></div>" +
                "</div>" +
                (shape === 'cone' && cone > 0 ? "<br>Cylinder: " + (areaFt2 * depth * 7.48).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " gal | Cone: " + ((Math.PI/3) * Math.pow(dim1/2,2) * cone * 7.48).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " gal" : "") +
                "<br><br>üí° <b>Quick HRT check:</b> At 1 MGD ‚Üí HRT = " + (volMG / 1 * 24).toFixed(1) + " hrs | At 0.5 MGD ‚Üí " + (volMG / 0.5 * 24).toFixed(1) + " hrs";
            stat.style.color = "#94a3b8";
        }
    }

    // ==================== POND HRT ====================

    // 64. Pond Detention Time
    function calcPondHRT() {
        var acres = parseFloat(document.getElementById('hrt_acres').value) || 0;
        var depth = parseFloat(document.getElementById('hrt_depth').value) || 0;
        var sludge = parseFloat(document.getElementById('hrt_sludge').value) || 0;
        var flow = parseFloat(document.getElementById('hrt_flow').value) || 0;
        var cells = parseFloat(document.getElementById('hrt_cells').value) || 1;
        
        if (acres > 0 && depth > 0 && flow > 0) {
            var effDepth = depth - sludge;
            if (effDepth <= 0) {
                document.getElementById('hrt_res').innerText = "ERROR: Sludge ‚â• Depth!";
                document.getElementById('hrt_status').innerHTML = "üö® <b>Sludge depth exceeds water depth ‚Äî pond is full of sludge. Immediate dredging required.</b>";
                document.getElementById('hrt_status').style.color = "var(--danger)";
                return;
            }
            
            var designVol = acres * 43560 * depth * 7.48;
            var actualVol = acres * 43560 * effDepth * 7.48;
            var volLost = designVol - actualVol;
            var pctLost = (volLost / designVol * 100);
            var flowGPD = flow * 1000000;
            
            var designHRT = designVol / flowGPD;
            var actualHRT = actualVol / flowGPD;
            var hrtLost = designHRT - actualHRT;
            
            document.getElementById('hrt_res').innerText = "Actual HRT: " + actualHRT.toFixed(0) + " days (design: " + designHRT.toFixed(0) + ")";
            var stat = document.getElementById('hrt_status');
            
            var assessment = "";
            if (actualHRT >= 90) { assessment = "‚úì Within typical facultative range (90‚Äì180 days)"; stat.style.color = "#4ade80"; }
            else if (actualHRT >= 60) { assessment = "‚ö†Ô∏è Below 90-day minimum ‚Äî reduced treatment. Consider flow reduction or sludge removal."; stat.style.color = "var(--accent)"; }
            else if (actualHRT >= 30) { assessment = "üö® Severely reduced HRT ‚Äî high risk of odors and permit violations"; stat.style.color = "var(--danger)"; }
            else { assessment = "üö® CRITICAL ‚Äî HRT far below design. Immediate action required."; stat.style.color = "var(--danger)"; }
            
            var info = "üìä <b>Pond Detention Analysis:</b>" +
                "<br>Design volume: " + (designVol/1000000).toFixed(2) + " MG | Actual: " + (actualVol/1000000).toFixed(2) + " MG" +
                "<br>Sludge loss: <b>" + (volLost/1000000).toFixed(2) + " MG (" + pctLost.toFixed(0) + "% of design)</b>" +
                "<br><br><div style='display:flex;gap:6px'>" +
                "<div style='flex:1;background:#1e293b;padding:8px;border-radius:6px;text-align:center'>" +
                "<div style='color:#94a3b8;font-size:0.7rem'>DESIGN HRT</div><div style='font-size:1.2rem;font-weight:bold;color:#4ade80'>" + designHRT.toFixed(0) + " d</div></div>" +
                "<div style='flex:1;background:#1e293b;padding:8px;border-radius:6px;text-align:center'>" +
                "<div style='color:#94a3b8;font-size:0.7rem'>ACTUAL HRT</div><div style='font-size:1.2rem;font-weight:bold;color:" + (actualHRT < 90 ? "var(--accent)" : "#4ade80") + "'>" + actualHRT.toFixed(0) + " d</div></div>" +
                "<div style='flex:1;background:#1e293b;padding:8px;border-radius:6px;text-align:center'>" +
                "<div style='color:#94a3b8;font-size:0.7rem'>LOST</div><div style='font-size:1.2rem;font-weight:bold;color:var(--danger)'>" + hrtLost.toFixed(0) + " d</div></div>" +
                "</div>";
            
            // Sludge depth bar
            info += "<br><div style='margin:4px 0'><span style='font-size:0.75rem;color:#94a3b8'>Cross-section:</span>" +
                "<div style='display:flex;height:40px;border-radius:4px;overflow:hidden;border:1px solid #334155;margin:3px 0'>" +
                "<div style='width:" + ((effDepth/depth)*100) + "%;background:rgba(56,189,248,0.3);display:flex;align-items:center;justify-content:center;font-size:0.65rem;color:#7dd3fc;font-weight:bold'>Water: " + effDepth.toFixed(1) + " ft</div>" +
                "<div style='width:" + ((sludge/depth)*100) + "%;background:rgba(180,83,9,0.4);display:flex;align-items:center;justify-content:center;font-size:0.65rem;color:#fbbf24;font-weight:bold'>Sludge: " + sludge.toFixed(1) + " ft</div>" +
                "</div></div>";
            
            // Short-circuiting estimate
            if (cells > 0) {
                var scFactor = cells === 1 ? 0.3 : cells === 2 ? 0.5 : cells >= 3 ? 0.7 : 0.5;
                var effectiveHRT = actualHRT * scFactor;
                info += "<br><b>Short-Circuiting Estimate (" + cells + " cell" + (cells > 1 ? "s" : "") + " in series):</b>" +
                    "<br>Efficiency factor: " + (scFactor*100).toFixed(0) + "% | Effective HRT: <b>" + effectiveHRT.toFixed(0) + " days</b>" +
                    "<br><span style='font-size:0.7rem;color:#64748b'>1 cell: ~30% efficient | 2 cells: ~50% | 3+ cells: ~70% | Baffles improve performance</span>";
            }
            
            info += "<br><br>" + assessment;
            stat.innerHTML = info;
        }
    }

    // ==================== BLOWER AIR REQUIREMENT ====================

    // 65. Blower Air Requirement
    function calcBlower() {
        var o2 = parseFloat(document.getElementById('bl_o2').value) || 0;
        var depth = parseFloat(document.getElementById('bl_depth').value) || 0;
        var ote = parseFloat(document.getElementById('bl_ote').value) || 0;
        var basins = parseFloat(document.getElementById('bl_basins').value) || 1;
        var sf = parseFloat(document.getElementById('bl_sf').value) || 1;
        var cost = parseFloat(document.getElementById('bl_cost').value) || 0;
        
        if (o2 > 0 && ote > 0) {
            // Air is 0.075 lbs/ft¬≥ at standard conditions, 23.2% O‚ÇÇ by weight
            var o2PerCFAir = 0.075 * 0.232; // 0.0174 lbs O‚ÇÇ per ft¬≥ air
            var totalO2 = o2 * sf; // lbs O‚ÇÇ/hr with safety factor
            var cfmTotal = (totalO2 / (o2PerCFAir * (ote/100))) / 60;
            var cfmPerBasin = cfmTotal / basins;
            
            // Blower discharge pressure (approx: 1 psi per 2.31 ft depth + 1-2 psi losses)
            var dischPSI = (depth / 2.31) + 1.5;
            
            // BHP estimate: BHP = (SCFM √ó discharge PSI) / (6356 √ó blower eff)
            var blowerEff = 0.70; // typical
            var bhpTotal = (cfmTotal * dischPSI * 144) / (33000 * blowerEff);
            var kw = bhpTotal * 0.746;
            
            // Annual cost
            var annualKWH = kw * 8760 * 0.90; // 90% runtime
            var annualCost = cost > 0 ? annualKWH * cost : 0;
            
            document.getElementById('bl_res').innerText = cfmTotal.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " SCFM total";
            var stat = document.getElementById('bl_status');
            
            var info = "üìä <b>Blower Sizing Results:</b>" +
                "<br><div style='display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;margin:6px 0'>" +
                "<div style='background:#1e293b;padding:8px;border-radius:6px;text-align:center'>" +
                "<div style='color:#94a3b8;font-size:0.65rem'>TOTAL SCFM</div><div style='font-size:1.1rem;font-weight:bold;color:#818cf8'>" + cfmTotal.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + "</div></div>" +
                "<div style='background:#1e293b;padding:8px;border-radius:6px;text-align:center'>" +
                "<div style='color:#94a3b8;font-size:0.65rem'>PER BASIN</div><div style='font-size:1.1rem;font-weight:bold;color:#a5b4fc'>" + cfmPerBasin.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + "</div></div>" +
                "<div style='background:#1e293b;padding:8px;border-radius:6px;text-align:center'>" +
                "<div style='color:#94a3b8;font-size:0.65rem'>EST. BHP</div><div style='font-size:1.1rem;font-weight:bold;color:#c4b5fd'>" + bhpTotal.toFixed(0) + "</div></div>" +
                "</div>";
            
            info += "<b>Design Parameters:</b>" +
                "<br>O‚ÇÇ demand: " + o2 + " lbs/hr √ó " + sf + " SF = <b>" + totalO2.toFixed(0) + " lbs O‚ÇÇ/hr</b>" +
                "<br>OTE: " + ote + "% at " + depth + " ft depth | " + basins + " basin" + (basins > 1 ? "s" : "") +
                "<br>Discharge pressure: ~" + dischPSI.toFixed(1) + " psig | Motor: <b>" + kw.toFixed(1) + " kW</b> (" + bhpTotal.toFixed(0) + " BHP)";
            
            if (cost > 0) {
                info += "<br><br><b>Energy Cost Estimate:</b>" +
                    "<br>Annual runtime: 7,884 hrs (90%) | " + annualKWH.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " kWh/yr" +
                    "<br>At $" + cost.toFixed(2) + "/kWh: <b style='color:#fbbf24'>$" + annualCost.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + "/year</b>" +
                    " ($" + (annualCost/12).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + "/month)";
            }
            
            // Diffuser count estimate
            var diffPerSCFM = 3.5; // typical fine bubble: 2-5 SCFM per diffuser
            var estDiffusers = Math.ceil(cfmTotal / diffPerSCFM);
            info += "<br><br>üí° Est. diffuser count: ~" + estDiffusers + " fine bubble (at 3.5 SCFM/disc)";
            
            stat.innerHTML = info;
            stat.style.color = "#94a3b8";
        }
    }

    // ==================== BIOSOLIDS & LAND APPLICATION ====================

    // 66. Plant Available Nitrogen (PAN)
    function calcPAN() {
        var nh3 = parseFloat(document.getElementById('pan_nh3').value) || 0;
        var no3 = parseFloat(document.getElementById('pan_no3').value) || 0;
        var orgN = parseFloat(document.getElementById('pan_orgn').value) || 0;
        var method = document.getElementById('pan_method').value;
        var kmin = parseFloat(document.getElementById('pan_kmin').value) || 0;
        var solids = parseFloat(document.getElementById('pan_solids').value) || 0;
        
        if ((nh3 > 0 || no3 > 0 || orgN > 0) && kmin > 0) {
            // Volatilization factor
            var kvol = method === 'inject' ? 1.0 : 0.5; // injected = 100% available, surface = 50% lost
            
            // PAN (mg/kg) = (Kvol √ó NH‚ÇÉ-N) + NO‚ÇÉ-N + (Kmin √ó Org-N)
            var panMgKg = (kvol * nh3) + no3 + ((kmin/100) * orgN);
            
            // Convert to lbs/dry ton: mg/kg √ó 0.002 = lbs/ton
            var panLbsDT = panMgKg * 0.002;
            
            // Total nitrogen
            var totalN = nh3 + no3 + orgN;
            var pctAvailable = (panMgKg / totalN * 100);
            
            document.getElementById('pan_res').innerText = panLbsDT.toFixed(1) + " lbs PAN / dry ton";
            var stat = document.getElementById('pan_status');
            
            var info = "üìä <b>Plant Available Nitrogen Analysis:</b>" +
                "<br><div style='display:grid;grid-template-columns:1fr 1fr;gap:4px;margin:6px 0'>" +
                "<div style='background:#1e293b;padding:8px;border-radius:6px;text-align:center'>" +
                "<div style='color:#94a3b8;font-size:0.65rem'>PAN (mg/kg)</div><div style='font-size:1.1rem;font-weight:bold;color:#fbbf24'>" + panMgKg.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + "</div></div>" +
                "<div style='background:#1e293b;padding:8px;border-radius:6px;text-align:center'>" +
                "<div style='color:#94a3b8;font-size:0.65rem'>PAN (lbs/DT)</div><div style='font-size:1.1rem;font-weight:bold;color:#d97706'>" + panLbsDT.toFixed(1) + "</div></div>" +
                "</div>";
            
            info += "<b>Nitrogen Fractions:</b>" +
                "<br>NH‚ÇÉ-N: " + nh3.toLocaleString() + " mg/kg √ó " + (kvol*100) + "% available = <b>" + (kvol*nh3).toFixed(0).toLocaleString() + "</b> mg/kg" +
                "<br>NO‚ÇÉ-N: " + no3.toLocaleString() + " mg/kg √ó 100% available = <b>" + no3.toFixed(0).toLocaleString() + "</b> mg/kg" +
                "<br>Org-N: " + orgN.toLocaleString() + " mg/kg √ó " + kmin + "% mineralized = <b>" + ((kmin/100)*orgN).toFixed(0).toLocaleString() + "</b> mg/kg";
            
            // N availability bar
            var nh3Pct = (kvol * nh3) / panMgKg * 100;
            var no3Pct = no3 / panMgKg * 100;
            var orgPct = ((kmin/100) * orgN) / panMgKg * 100;
            info += "<br><div style='display:flex;height:16px;border-radius:4px;overflow:hidden;margin:6px 0'>" +
                "<div style='width:" + nh3Pct.toFixed(0) + "%;background:#4ade80;display:flex;align-items:center;justify-content:center;font-size:0.55rem;font-weight:bold;color:#0f172a'>NH‚ÇÉ</div>" +
                "<div style='width:" + no3Pct.toFixed(0) + "%;background:#3b82f6;display:flex;align-items:center;justify-content:center;font-size:0.55rem;font-weight:bold;color:#fff'>NO‚ÇÉ</div>" +
                "<div style='width:" + orgPct.toFixed(0) + "%;background:#d97706;display:flex;align-items:center;justify-content:center;font-size:0.55rem;font-weight:bold;color:#fff'>Org</div>" +
                "</div>";
            
            info += "<br>Total N: " + totalN.toLocaleString() + " mg/kg | PAN: " + panMgKg.toFixed(0).toLocaleString() + " mg/kg | <b>" + pctAvailable.toFixed(0) + "% available</b> in Year 1" +
                "<br>Method: " + (method === 'inject' ? "Injected/incorporated (0% NH‚ÇÉ loss)" : "Surface applied (50% NH‚ÇÉ volatilization loss)");
            
            if (solids > 0) {
                var wetTonLbs = 2000 / (solids/100);
                var panPerWetTon = panLbsDT * (solids/100);
                info += "<br><br>At " + solids + "% solids: <b>" + panPerWetTon.toFixed(2) + " lbs PAN/wet ton</b> (" + (wetTonLbs).toFixed(0).toLocaleString() + " lbs wet per dry ton)";
            }
            
            stat.innerHTML = info;
            stat.style.color = "#94a3b8";
        }
    }

    // 67. Land Application Rate
    function calcLandApp() {
        var pan = parseFloat(document.getElementById('la_pan').value) || 0;
        var crop = parseFloat(document.getElementById('la_crop').value) || 0;
        var solids = parseFloat(document.getElementById('la_solids').value) || 0;
        var prod = parseFloat(document.getElementById('la_prod').value) || 0;
        var acres = parseFloat(document.getElementById('la_acres').value) || 0;
        
        if (pan > 0 && crop > 0) {
            // Agronomic rate: DT/acre = Crop N uptake / PAN per DT
            var dtPerAcre = crop / pan;
            
            // Wet gallons per acre (if solids given)
            var wetGalPerAcre = 0;
            var wetTonsPerAcre = 0;
            if (solids > 0) {
                var lbsWetPerDT = 2000 / (solids/100);
                wetTonsPerAcre = dtPerAcre * (1 / (solids/100));
                wetGalPerAcre = (dtPerAcre * 2000) / (8.34 * (solids/100));
            }
            
            document.getElementById('la_res').innerText = dtPerAcre.toFixed(1) + " dry tons/acre/yr" + (wetGalPerAcre > 0 ? " | " + wetGalPerAcre.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " gal/acre" : "");
            var stat = document.getElementById('la_status');
            
            var info = "üìä <b>Agronomic Application Rate:</b>" +
                "<br><div style='display:grid;grid-template-columns:1fr 1fr" + (wetGalPerAcre > 0 ? " 1fr" : "") + ";gap:4px;margin:6px 0'>" +
                "<div style='background:#1e293b;padding:8px;border-radius:6px;text-align:center'>" +
                "<div style='color:#94a3b8;font-size:0.65rem'>DRY TONS/ACRE</div><div style='font-size:1.1rem;font-weight:bold;color:#d97706'>" + dtPerAcre.toFixed(1) + "</div></div>" +
                "<div style='background:#1e293b;padding:8px;border-radius:6px;text-align:center'>" +
                "<div style='color:#94a3b8;font-size:0.65rem'>N APPLIED</div><div style='font-size:1.1rem;font-weight:bold;color:#4ade80'>" + crop + " lbs/ac</div></div>";
            if (wetGalPerAcre > 0) {
                info += "<div style='background:#1e293b;padding:8px;border-radius:6px;text-align:center'>" +
                    "<div style='color:#94a3b8;font-size:0.65rem'>WET GAL/ACRE</div><div style='font-size:1.1rem;font-weight:bold;color:#fbbf24'>" + wetGalPerAcre.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + "</div></div>";
            }
            info += "</div>";
            
            info += "<b>Calculation:</b>" +
                "<br>Crop N uptake: " + crop + " lbs N/acre/yr √∑ PAN: " + pan + " lbs/DT = <b>" + dtPerAcre.toFixed(1) + " DT/acre</b>";
            
            if (solids > 0) {
                info += "<br>At " + solids + "% solids: <b>" + wetTonsPerAcre.toFixed(1) + " wet tons/acre</b> (" + wetGalPerAcre.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " gal/acre)";
                
                // Truck loads estimate
                var galPerTruck = solids < 10 ? 5000 : 20; // liquid tanker vs dump truck (wet tons)
                if (solids < 10) {
                    var trucksPerAcre = wetGalPerAcre / 5000;
                    info += "<br>Est. tanker loads: ~" + trucksPerAcre.toFixed(1) + " per acre (5,000 gal tanker)";
                } else {
                    var trucksPerAcre2 = wetTonsPerAcre / 20;
                    info += "<br>Est. truck loads: ~" + trucksPerAcre2.toFixed(1) + " per acre (20 wet ton truck)";
                }
            }
            
            // Site capacity analysis
            if (prod > 0 && acres > 0) {
                var requiredAcres = prod / dtPerAcre;
                var siteCapDT = acres * dtPerAcre;
                var capPct = (prod / siteCapDT * 100);
                
                info += "<br><br><b>Site Capacity:</b>" +
                    "<br>Annual production: " + prod + " DT/yr | Required: <b>" + requiredAcres.toFixed(0) + " acres</b> | Available: " + acres + " acres";
                
                info += "<br><div style='background:#1e293b;border-radius:4px;height:16px;position:relative;margin:4px 0;overflow:hidden'>" +
                    "<div style='background:" + (capPct > 100 ? "var(--danger)" : capPct > 80 ? "var(--accent)" : "#4ade80") +
                    ";height:100%;width:" + Math.min(capPct, 100) + "%;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:0.65rem;font-weight:bold;color:#0f172a'>" + capPct.toFixed(0) + "% utilized</div></div>";
                
                if (capPct > 100) {
                    info += "üö® <b>INSUFFICIENT ACREAGE.</b> Need " + (requiredAcres - acres).toFixed(0) + " more acres or reduce production.";
                } else if (capPct > 80) {
                    info += "‚ö†Ô∏è Site at " + capPct.toFixed(0) + "% capacity. Buffer: " + (acres - requiredAcres).toFixed(0) + " surplus acres.";
                } else {
                    info += "‚úì Adequate. Surplus: " + (acres - requiredAcres).toFixed(0) + " acres (" + (siteCapDT - prod).toFixed(0) + " DT/yr additional capacity)";
                }
                
                // Annual hauling summary
                if (solids > 0) {
                    var totalWetGal = prod * 2000 / (8.34 * (solids/100));
                    info += "<br><br><b>Annual Hauling:</b> " + totalWetGal.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " gallons/yr total";
                    if (solids < 10) {
                        info += " (~" + Math.ceil(totalWetGal/5000) + " tanker loads)";
                    } else {
                        var totalWetTons = prod / (solids/100);
                        info += " (~" + Math.ceil(totalWetTons/20) + " truck loads)";
                    }
                }
            }
            
            stat.innerHTML = info;
            stat.style.color = "#94a3b8";
        }
    }

    // ==================== PWA ====================
    let deferredPrompt;
    
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .catch(err => console.log('SW error:', err));
        });
    }

    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        document.getElementById('installPrompt').style.display = 'flex';
    });

    function installApp() {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then(() => {
                deferredPrompt = null;
                document.getElementById('installPrompt').style.display = 'none';
            });
        }
    }

    function dismissInstall() {
        document.getElementById('installPrompt').style.display = 'none';
    }

    // Refresh app - clear cache and reload
    function refreshApp() {
        showToast('Checking for updates...', '');
        vibrate();
        
        if ('serviceWorker' in navigator && 'caches' in window) {
            // Clear all caches
            caches.keys().then(names => {
                names.forEach(name => caches.delete(name));
            });
            
            // Unregister service worker and reload
            navigator.serviceWorker.getRegistrations().then(registrations => {
                registrations.forEach(registration => registration.unregister());
            }).then(() => {
                setTimeout(() => {
                    window.location.reload(true);
                }, 500);
            });
        } else {
            window.location.reload(true);
        }
    }

    // ==================== HOW TO USE GUIDES (JS-injected) ====================
    var guideData = {
        1: { color:'#3b82f6', title:'POUNDS FORMULA', content:
            '<b>What This Calculates</b><br>Converts concentration (mg/L) to mass loading (lbs/day). This is THE fundamental formula in wastewater ‚Äî every other calculation builds on it. If you only memorize one formula for the TCEQ exam, memorize this one.' +
            '<div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:6px 0"><b>Flow (MGD)</b> ‚Äî Average daily flow in million gallons per day. Get from your plant flow meter or monthly DMR.<br><b>Concentration (mg/L)</b> ‚Äî From your lab results: BOD, TSS, NH‚ÇÉ, whatever parameter you need.</div>' +
            '<div style="background:rgba(59,130,246,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #3b82f6"><b>lbs/day = Flow (MGD) √ó Concentration (mg/L) √ó 8.34</b><br>‚Ä¢ 8.34 = weight of 1 gallon of water in lbs<br>‚Ä¢ Works for ANY parameter: BOD, TSS, NH‚ÇÉ, PO‚ÇÑ, chlorine<br>‚Ä¢ To get lbs/hr: divide by 24<br>‚Ä¢ Exam will sometimes give flow in GPD ‚Äî convert to MGD first (√∑ 1,000,000)</div>' },
        2: { color:'#3b82f6', title:'SVI ‚Äî SLUDGE VOLUME INDEX', content:
            '<b>What This Calculates</b><br>SVI measures how well your activated sludge settles. Lower SVI = denser, better-settling sludge. It\'s the volume (mL) occupied by 1 gram of sludge after 30 minutes of settling.' +
            '<div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:6px 0"><b>Settled Volume (mL)</b> ‚Äî Read from a 1-liter settleometer after exactly 30 minutes. No stirring.<br><b>MLSS (mg/L)</b> ‚Äî Mixed liquor suspended solids from lab.</div>' +
            '<div style="background:rgba(59,130,246,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #3b82f6"><b>SVI = (Settled Vol mL √ó 1000) √∑ MLSS mg/L</b><br>‚Ä¢ Good settling: 80‚Äì150 mL/g<br>‚Ä¢ Bulking sludge: >150 (filamentous, light, fluffy)<br>‚Ä¢ Pin floc/old sludge: <80 (too dense, turbid effluent)<br>‚Ä¢ SVI >300 = severe bulking ‚Äî check for filamentous organisms</div>' },
        3: { color:'#3b82f6', title:'MASS BALANCE', content:
            '<b>What This Calculates</b><br>Calculates the resulting concentration when two flows of different concentrations mix together. Common uses: RAS + influent mixing, chemical blending, sidestream return impact.' +
            '<div style="background:rgba(59,130,246,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #3b82f6"><b>C_mix = (Q‚ÇÅ√óC‚ÇÅ + Q‚ÇÇ√óC‚ÇÇ) √∑ (Q‚ÇÅ + Q‚ÇÇ)</b><br>‚Ä¢ This is a weighted average by flow<br>‚Ä¢ Works for any parameter: TSS, BOD, temperature<br>‚Ä¢ Common exam problem: "What is the MLSS in the aeration basin when RAS mixes with influent?"</div>' },
        4: { color:'#10b981', title:'F:M RATIO', content:
            '<b>What This Calculates</b><br>Food-to-Microorganism ratio ‚Äî how much "food" (BOD) you\'re feeding your bugs (MLSS) each day. THE primary process control parameter for activated sludge. Think of it as the menu portion size for your microorganisms.' +
            '<div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:6px 0"><b>Flow (MGD)</b> ‚Äî Plant influent flow<br><b>BOD (mg/L)</b> ‚Äî Influent (or primary effluent) BOD<br><b>Aeration Volume (MG)</b> ‚Äî Total volume of aeration basins. Use Calc #63 if needed.<br><b>MLSS (mg/L)</b> ‚Äî Mixed liquor suspended solids in aeration basin</div>' +
            '<div style="background:rgba(16,185,129,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #10b981"><b>F:M = (Flow √ó BOD √ó 8.34) √∑ (Vol √ó MLSS √ó 8.34)</b><br>‚Ä¢ Conventional AS: 0.2‚Äì0.5<br>‚Ä¢ Extended aeration: 0.05‚Äì0.15<br>‚Ä¢ Contact stab: 0.2‚Äì0.6<br>‚Ä¢ High F:M = young, active sludge (good settling but less treatment)<br>‚Ä¢ Low F:M = old sludge (great treatment but may bulk)<br>‚Ä¢ Adjust F:M by changing WAS rate</div>' },
        5: { color:'#10b981', title:'SRT ‚Äî SLUDGE AGE', content:
            '<b>What This Calculates</b><br>Solids Retention Time ‚Äî the average number of days a microorganism stays in the system. Controls which organisms can grow: nitrifiers need >8 days SRT. This is your second most important process control parameter after F:M.' +
            '<div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:6px 0"><b>Aeration Volume (MG)</b> ‚Äî Total aeration basin volume<br><b>MLSS (mg/L)</b> ‚Äî Mixed liquor concentration<br><b>WAS Flow & TSS</b> ‚Äî Waste sludge flow rate and concentration<br><b>Effluent Flow & TSS</b> ‚Äî Final effluent (solids lost over the weir)</div>' +
            '<div style="background:rgba(16,185,129,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #10b981"><b>SRT = (Vol √ó MLSS √ó 8.34) √∑ [(WAS Q √ó WAS TSS √ó 8.34) + (Eff Q √ó Eff TSS √ó 8.34)]</b><br>‚Ä¢ Conventional AS: 5‚Äì15 days<br>‚Ä¢ Extended aeration: 20‚Äì40 days<br>‚Ä¢ For nitrification: MUST be >8 days (>12 in cold weather)<br>‚Ä¢ Increase SRT ‚Üí decrease WAS rate. Decrease SRT ‚Üí increase WAS rate.</div>' },
        6: { color:'#3b82f6', title:'DETENTION TIME', content:
            '<b>What This Calculates</b><br>How long water stays in a tank or process. Critical for disinfection (CT), sedimentation, biological treatment, and chemical reactions. Also called HRT (Hydraulic Retention Time).' +
            '<div style="background:rgba(59,130,246,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #3b82f6"><b>DT = Volume √∑ Flow</b> (match units!)<br>‚Ä¢ Gallons √∑ GPD = days | Gallons √∑ GPM = minutes<br>‚Ä¢ To convert days ‚Üí hours: √ó 24 | hours ‚Üí minutes: √ó 60<br>‚Ä¢ Primary clarifier: 1.5‚Äì2.5 hrs<br>‚Ä¢ Aeration basin: 4‚Äì8 hrs (conventional), 18‚Äì36 hrs (extended aeration)<br>‚Ä¢ Chlorine contact: 15‚Äì30 min at peak flow</div>' },
        7: { color:'#3b82f6', title:'REMOVAL EFFICIENCY', content:
            '<b>What This Calculates</b><br>Percent removal of any parameter through a process. Used for permit compliance reporting and process performance tracking.' +
            '<div style="background:rgba(59,130,246,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #3b82f6"><b>% Removal = [(Influent ‚àí Effluent) √∑ Influent] √ó 100</b><br>‚Ä¢ Typical BOD removal: 85‚Äì95%<br>‚Ä¢ Typical TSS removal: 85‚Äì95%<br>‚Ä¢ NH‚ÇÉ removal (with nitrification): >95%<br>‚Ä¢ Primary clarifier BOD removal: 25‚Äì40%<br>‚Ä¢ TCEQ permits often require ‚â•85% BOD & TSS removal</div>' },
        8: { color:'#10b981', title:'WAS PUMPING RATE', content:
            '<b>What This Calculates</b><br>Required waste activated sludge flow rate to maintain your target SRT. Wasting is the #1 process control tool ‚Äî it\'s how you control SRT, F:M, MLSS, and sludge age all at once.' +
            '<div style="background:rgba(16,185,129,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #10b981"><b>WAS (GPD) = (Vol √ó MLSS √ó 8.34) √∑ (Target SRT √ó WAS TSS √ó 8.34)</b><br>‚Ä¢ Simplified: WAS GPD = (Vol MG √ó MLSS) √∑ (SRT √ó WAS TSS)<br>‚Ä¢ Convert to GPM: √∑ 1440<br>‚Ä¢ Adjust WAS daily based on SRT trending<br>‚Ä¢ Sudden increase in WAS needed may indicate solids washout or growth</div>' },
        9: { color:'#10b981', title:'RAS RETURN RATE', content:
            '<b>What This Calculates</b><br>Return Activated Sludge flow rate ‚Äî recirculates settled sludge from the clarifier back to the aeration basin to maintain MLSS concentration.' +
            '<div style="background:rgba(16,185,129,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #10b981"><b>Settleability method: RAS % = (SV‚ÇÉ‚ÇÄ √∑ (1000 ‚àí SV‚ÇÉ‚ÇÄ)) √ó 100</b><br>‚Ä¢ SV‚ÇÉ‚ÇÄ = 30-min settled volume in mL per 1000 mL<br>‚Ä¢ Typical RAS rate: 25‚Äì100% of influent flow<br>‚Ä¢ Too low RAS ‚Üí sludge blanket rises in clarifier ‚Üí solids washout<br>‚Ä¢ Too high RAS ‚Üí short-circuits clarifier, resuspends settled solids<br>‚Ä¢ Watch sludge blanket depth: keep >2 ft below weir</div>' },
        10: { color:'#3b82f6', title:'ORGANIC LOADING RATE', content:
            '<b>What This Calculates</b><br>BOD applied per unit volume of treatment process. Used for aeration basins, trickling filters, and RBCs. Tells you if your process is overloaded or underloaded.' +
            '<div style="background:rgba(59,130,246,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #3b82f6"><b>OLR = (Flow √ó BOD √ó 8.34) √∑ Volume (1000 ft¬≥ or MG)</b><br>‚Ä¢ Conventional AS: 20‚Äì40 lbs BOD/1000 ft¬≥/day<br>‚Ä¢ Extended aeration: 10‚Äì25 lbs BOD/1000 ft¬≥/day<br>‚Ä¢ Trickling filter: 15‚Äì30 lbs BOD/1000 ft¬≥/day (low rate) to 40‚Äì100 (high rate)<br>‚Ä¢ Overloading causes DO depletion, odors, poor treatment</div>' },
        11: { color:'#3b82f6', title:'SURFACE OVERFLOW RATE', content:
            '<b>What This Calculates</b><br>Flow per unit surface area of a clarifier. THE primary clarifier design parameter ‚Äî determines settling performance.' +
            '<div style="background:rgba(59,130,246,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #3b82f6"><b>SOR = Flow (GPD) √∑ Surface Area (ft¬≤)</b><br>‚Ä¢ Primary clarifier: 600‚Äì1200 GPD/ft¬≤<br>‚Ä¢ Secondary clarifier: 400‚Äì800 GPD/ft¬≤<br>‚Ä¢ Area = œÄ/4 √ó D¬≤ for circular<br>‚Ä¢ Higher SOR = less settling time = more solids carryover<br>‚Ä¢ TCEQ exam loves this one ‚Äî watch units!</div>' },
        12: { color:'#3b82f6', title:'WEIR OVERFLOW RATE', content:
            '<b>What This Calculates</b><br>Flow per linear foot of effluent weir. High WOR causes turbulence that resuspends settled solids near the weir.' +
            '<div style="background:rgba(59,130,246,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #3b82f6"><b>WOR = Flow (GPD) √∑ Weir Length (ft)</b><br>‚Ä¢ Design max: 10,000‚Äì20,000 GPD/ft<br>‚Ä¢ For circular clarifiers: Weir length = œÄ √ó Diameter<br>‚Ä¢ V-notch weirs give better flow distribution than flat weirs<br>‚Ä¢ Double-sided weir troughs = double the weir length</div>' },
        13: { color:'#3b82f6', title:'SOLIDS LOADING RATE', content:
            '<b>What This Calculates</b><br>Total solids applied per unit area of the clarifier. More important than SOR for secondary clarifiers because it accounts for RAS solids recycling.' +
            '<div style="background:rgba(59,130,246,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #3b82f6"><b>SLR = [(Q + Q_RAS) √ó MLSS √ó 8.34] √∑ Area (ft¬≤)</b><br>‚Ä¢ Design: 20‚Äì30 lbs/ft¬≤/day (conventional)<br>‚Ä¢ Peak: <50 lbs/ft¬≤/day<br>‚Ä¢ High SLR ‚Üí rising sludge blanket ‚Üí solids in effluent<br>‚Ä¢ SLR is often the limiting factor, not SOR</div>' },
        14: { color:'#3b82f6', title:'CHEMICAL DOSING', content:
            '<b>What This Calculates</b><br>Feed rate for any chemical: chlorine, alum, polymer, lime, permanganate. Converts target dose (mg/L) to actual lbs/day or gal/day of chemical product.' +
            '<div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:6px 0"><b>Flow (MGD)</b> ‚Äî Treatment flow<br><b>Dose (mg/L)</b> ‚Äî Target concentration<br><b>Chemical Strength (%)</b> ‚Äî Product purity/strength. 12.5% sodium hypochlorite, 48% alum, 100% for dry chemicals.</div>' +
            '<div style="background:rgba(59,130,246,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #3b82f6"><b>lbs/day = (Flow √ó Dose √ó 8.34) √∑ (% Strength as decimal)</b><br>‚Ä¢ For liquid chemicals: GPD = lbs/day √∑ (8.34 √ó specific gravity)<br>‚Ä¢ 12.5% NaOCl has SG ‚âà 1.17<br>‚Ä¢ 48% alum has SG ‚âà 1.33<br>‚Ä¢ Dry chemicals: lbs/day = Flow √ó Dose √ó 8.34 (strength = 100%)</div>' },
        15: { color:'#8b5cf6', title:'MEMBRANE FLUX RATE', content:
            '<b>What This Calculates</b><br>Permeate flow per unit membrane area. THE primary MBR performance indicator. Track daily to detect fouling trends before they become emergencies.' +
            '<div style="background:rgba(139,92,246,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #8b5cf6"><b>Flux = Permeate Flow (GPD) √∑ Membrane Area (ft¬≤)</b><br>‚Ä¢ Typical MBR flux: 10‚Äì20 GFD (gallons/ft¬≤/day)<br>‚Ä¢ Also expressed as LMH (liters/m¬≤/hr): GFD √ó 1.70 = LMH<br>‚Ä¢ Declining flux at constant TMP = fouling<br>‚Ä¢ Stable flux with rising TMP = also fouling<br>‚Ä¢ Net flux accounts for backwash; gross flux does not</div>' },
        22: { color:'#06b6d4', title:'MBBR ‚Äî SURFACE AREA LOADING RATE', content:
            '<b>What This Calculates</b><br>SALR is the MBBR equivalent of F:M ‚Äî organic or nitrogen load per unit of biofilm surface area. This is the fundamental MBBR design parameter.' +
            '<div style="background:rgba(6,182,212,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #06b6d4"><b>SALR = (Flow √ó Conc √ó 8.34) √∑ Biofilm Area (m¬≤ or 1000 ft¬≤)</b><br>‚Ä¢ BOD SALR: 3‚Äì10 g/m¬≤/day (typical municipal)<br>‚Ä¢ NH‚ÇÉ SALR: 0.5‚Äì2.0 g/m¬≤/day (nitrification)<br>‚Ä¢ Higher SALR = higher loading = need more DO<br>‚Ä¢ Design at the target SALR for your treatment goal</div>' },
        35: { color:'#eab308', title:'DECHLORINATION DOSING', content:
            '<b>What This Calculates</b><br>Required sodium bisulfite or sulfur dioxide dose to neutralize chlorine residual before discharge. Most TPDES permits require <0.1 mg/L Cl‚ÇÇ in effluent.' +
            '<div style="background:rgba(234,179,8,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #eab308"><b>Stoichiometry:</b> 1.0 mg/L Cl‚ÇÇ requires:<br>‚Ä¢ 1.46 mg/L sodium bisulfite (NaHSO‚ÇÉ)<br>‚Ä¢ 0.90 mg/L sulfur dioxide (SO‚ÇÇ)<br>‚Ä¢ 1.34 mg/L sodium sulfite (Na‚ÇÇSO‚ÇÉ)<br>‚Ä¢ Always overdose slightly (1.1√ó stoichiometric) for safety margin<br>‚Ä¢ Too much dechlorination = DO depression in effluent</div>' },
        36: { color:'#eab308', title:'UV DOSE', content:
            '<b>What This Calculates</b><br>UV disinfection dose in mJ/cm¬≤. No chemical residual to remove ‚Äî increasingly popular alternative to chlorine.' +
            '<div style="background:rgba(234,179,8,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #eab308"><b>UV Dose = Intensity (mW/cm¬≤) √ó Contact Time (seconds)</b><br>‚Ä¢ Typical WW dose: 30‚Äì80 mJ/cm¬≤<br>‚Ä¢ Turbidity and TSS reduce UV penetration<br>‚Ä¢ Lamp aging reduces output ‚Äî track lamp hours<br>‚Ä¢ Clean quartz sleeves regularly for consistent performance</div>' },
        37: { color:'#a855f7', title:'SLUDGE VOLUME & % SOLIDS', content:
            '<b>What This Calculates</b><br>Converts between sludge volume, weight, and % solids. Essential for hauling, disposal, and dewatering calculations.' +
            '<div style="background:rgba(168,85,247,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #a855f7"><b>Dry Solids (lbs) = Wet Volume (gal) √ó 8.34 √ó (% Solids √∑ 100)</b><br>‚Ä¢ WAS from clarifier: 0.5‚Äì1.5% solids<br>‚Ä¢ Thickened WAS: 3‚Äì6%<br>‚Ä¢ Belt press cake: 15‚Äì25%<br>‚Ä¢ Centrifuge cake: 18‚Äì30%<br>‚Ä¢ 1 dry ton = 2,000 lbs dry solids</div>' },
        38: { color:'#a855f7', title:'VOLATILE SOLIDS REDUCTION', content:
            '<b>What This Calculates</b><br>Percent destruction of volatile (organic) solids through digestion. Must achieve ‚â•38% VSR for Class B biosolids under 40 CFR 503.' +
            '<div style="background:rgba(168,85,247,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #a855f7"><b>% VSR = [(VS_in ‚àí VS_out) √∑ VS_in] √ó 100</b><br>‚Ä¢ Or Van Kleeck formula: % VSR = [(% VS_in ‚àí % VS_out) √∑ (% VS_in √ó (1 ‚àí % VS_out/100))] √ó 100<br>‚Ä¢ Class B requirement: ‚â•38% VSR (or equivalent)<br>‚Ä¢ Typical aerobic digestion: 35‚Äì50%<br>‚Ä¢ Typical anaerobic digestion: 45‚Äì55%<br>‚Ä¢ Exam almost always uses Van Kleeck ‚Äî memorize it</div>' },
        39: { color:'#a855f7', title:'DIGESTER LOADING RATE', content:
            '<b>What This Calculates</b><br>Volatile solids loading to a digester in lbs VS/ft¬≥/day. Overloading causes acid buildup, pH drop, and digester failure.' +
            '<div style="background:rgba(168,85,247,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #a855f7"><b>Loading = (VS lbs/day) √∑ Digester Volume (ft¬≥)</b><br>‚Ä¢ Anaerobic: 0.04‚Äì0.10 lbs VS/ft¬≥/day (standard rate), 0.15‚Äì0.40 (high rate)<br>‚Ä¢ Aerobic: 0.1‚Äì0.3 lbs VS/ft¬≥/day<br>‚Ä¢ Monitor: pH, alkalinity, VFA, gas production<br>‚Ä¢ VFA:Alk ratio >0.5 = stressed digester</div>' },
        40: { color:'#a855f7', title:'POLYMER DOSING', content:
            '<b>What This Calculates</b><br>Polymer dose for sludge conditioning before dewatering. Expressed in lbs polymer per dry ton of solids or mg/L of sludge.' +
            '<div style="background:rgba(168,85,247,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #a855f7"><b>lbs polymer/DT = (dose mg/L √ó sludge flow GPD √ó 8.34) √∑ (dry solids lbs/day)</b><br>‚Ä¢ Typical dose: 5‚Äì15 lbs active polymer/DT<br>‚Ä¢ Emulsion polymer (30‚Äì40% active): adjust for strength<br>‚Ä¢ Jar test to optimize dose ‚Äî overdosing wastes money and can impair dewatering<br>‚Ä¢ Cationic polymers are most common for WW sludge</div>' },
        41: { color:'#22c55e', title:'PHOSPHORUS REMOVAL', content:
            '<b>What This Calculates</b><br>Chemical dose for phosphorus precipitation using alum or ferric chloride. P removal is increasingly required as nutrient limits tighten.' +
            '<div style="background:rgba(34,197,94,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #22c55e"><b>Molar ratios (metal:P):</b><br>‚Ä¢ Alum (Al): 1.5‚Äì3.0 mol Al per mol P (typical 2.0)<br>‚Ä¢ Ferric (Fe): 1.5‚Äì3.0 mol Fe per mol P (typical 2.5)<br>‚Ä¢ Higher ratios = more removal but more sludge and cost<br>‚Ä¢ Bio-P (EBPR) can reduce chemical costs<br>‚Ä¢ pH impact: alum drops pH, may need alkalinity supplement</div>' },
        42: { color:'#22c55e', title:'ALKALINITY & NITRIFICATION', content:
            '<b>What This Calculates</b><br>Alkalinity consumed by nitrification and whether supplemental alkalinity (lime/soda ash) is needed. Nitrification destroys 7.14 mg/L alkalinity per mg/L NH‚ÇÉ-N oxidized.' +
            '<div style="background:rgba(34,197,94,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #22c55e"><b>Alk consumed = NH‚ÇÉ-N removed (mg/L) √ó 7.14</b><br>‚Ä¢ Maintain ‚â•50 mg/L as CaCO‚ÇÉ in effluent for stable nitrification<br>‚Ä¢ If influent alk < alk consumed ‚Üí add lime or soda ash<br>‚Ä¢ Denitrification returns ~3.57 mg/L alk per mg/L NO‚ÇÉ-N reduced (50% recovery)<br>‚Ä¢ Low pH from alk depletion inhibits nitrifiers below pH 6.5</div>' },
        43: { color:'#22c55e', title:'NITROGEN BALANCE', content:
            '<b>What This Calculates</b><br>Tracks nitrogen through the plant: influent TKN ‚Üí nitrification ‚Üí denitrification ‚Üí effluent. Essential for nutrient permit compliance.' +
            '<div style="background:rgba(34,197,94,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #22c55e"><b>TKN = NH‚ÇÉ-N + Organic N</b><br>‚Ä¢ Total N = TKN + NO‚ÇÉ-N + NO‚ÇÇ-N<br>‚Ä¢ Nitrification: NH‚ÇÉ ‚Üí NO‚ÇÇ ‚Üí NO‚ÇÉ (needs DO >2 mg/L, SRT >8 days)<br>‚Ä¢ Denitrification: NO‚ÇÉ ‚Üí N‚ÇÇ gas (needs anoxic zone, carbon source)<br>‚Ä¢ Nitrogen incorporated into biomass: ~5% of BOD removed</div>' },
        45: { color:'#3b82f6', title:'PIPE VELOCITY', content:
            '<b>What This Calculates</b><br>Flow velocity in a pipe from flow rate and pipe diameter. Critical for checking self-cleansing velocity in sewers and avoiding pipe erosion.' +
            '<div style="background:rgba(59,130,246,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #3b82f6"><b>V (fps) = Flow (ft¬≥/s) √∑ Area (ft¬≤)</b><br>‚Ä¢ Or: V = (GPM √ó 0.002228) √∑ (œÄ/4 √ó (D in ft)¬≤)<br>‚Ä¢ Gravity sewer: 2‚Äì10 fps<br>‚Ä¢ Force main: 3‚Äì8 fps<br>‚Ä¢ <2 fps = solids deposition | >10 fps = pipe erosion<br>‚Ä¢ Diameter in inches √∑ 12 = diameter in feet</div>' },
        46: { color:'#3b82f6', title:'HORSEPOWER', content:
            '<b>What This Calculates</b><br>Water horsepower and brake horsepower for pump sizing. WHP is theoretical; BHP accounts for pump inefficiency and is what you actually need from the motor.' +
            '<div style="background:rgba(59,130,246,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #3b82f6"><b>WHP = (GPM √ó TDH ft) √∑ 3960</b><br><b>BHP = WHP √∑ Pump Efficiency</b><br><b>Motor HP = BHP √∑ Motor Efficiency</b><br>‚Ä¢ Pump efficiency: 60‚Äì80% typical<br>‚Ä¢ Motor efficiency: 85‚Äì95%<br>‚Ä¢ kW = BHP √ó 0.746<br>‚Ä¢ Wire-to-water efficiency = pump eff √ó motor eff</div>' },
        47: { color:'#f97316', title:'GEOMETRIC MEAN', content:
            '<b>What This Calculates</b><br>TCEQ requires geometric mean (not arithmetic mean) for fecal coliform and E. coli reporting. Geometric mean reduces the influence of outlier spikes.' +
            '<div style="background:rgba(249,115,22,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #f97316"><b>Geo Mean = (x‚ÇÅ √ó x‚ÇÇ √ó ... √ó x‚Çô)^(1/n)</b><br>‚Ä¢ Or: 10^(average of log‚ÇÅ‚ÇÄ values)<br>‚Ä¢ Always lower than arithmetic mean for bacteria data<br>‚Ä¢ TCEQ limit: 200 CFU/100mL (E. coli, 30-day geo mean)<br>‚Ä¢ Single sample max: 394 CFU/100mL<br>‚Ä¢ You cannot use zero in geometric mean ‚Äî use 1 as minimum</div>' },
        48: { color:'#f97316', title:'FLOW-WEIGHTED COMPOSITE', content:
            '<b>What This Calculates</b><br>True average concentration when flow varies throughout the day. Required for accurate DMR reporting ‚Äî grab samples at constant intervals give misleading averages if flow changes.' +
            '<div style="background:rgba(249,115,22,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #f97316"><b>FWC = Œ£(Flow_i √ó Conc_i) √∑ Œ£(Flow_i)</b><br>‚Ä¢ Weight each sample by the flow at time of collection<br>‚Ä¢ Automatic composite samplers do this with flow-paced sampling<br>‚Ä¢ More accurate than time-weighted for variable-flow plants</div>' },
        51: { color:'#fb923c', title:'WET WELL SIZING', content:
            '<b>What This Calculates</b><br>Required wet well volume for pump cycling. Too small = pumps cycle too frequently (motor burnout). Too large = septic conditions and odors.' +
            '<div style="background:rgba(251,146,60,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #fb923c"><b>V (gal) = (Q √ó T) √∑ 4</b> (for simplex pump)<br>‚Ä¢ Q = pump capacity (GPM), T = minimum cycle time (min)<br>‚Ä¢ Minimum cycle time: 10‚Äì15 min for small pumps, 5‚Äì10 for large<br>‚Ä¢ Max starts/hr: 6‚Äì10 for most motors<br>‚Ä¢ HRT in wet well should be <30 min to avoid septicity<br>‚Ä¢ Must accommodate peak flow + first flush</div>' },
        52: { color:'#fb923c', title:'I/I ‚Äî INFILTRATION & INFLOW', content:
            '<b>What This Calculates</b><br>Estimates how much groundwater (infiltration) and stormwater (inflow) enters your collection system. High I/I wastes treatment capacity and causes SSOs.' +
            '<div style="background:rgba(251,146,60,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #fb923c"><b>I/I = (Wet Weather Flow ‚àí Dry Weather Flow)</b><br>‚Ä¢ Infiltration: GPD per inch-mile of pipe (groundwater seeping through joints/cracks)<br>‚Ä¢ Inflow: Direct connections ‚Äî roof drains, manhole covers, cross-connections<br>‚Ä¢ TCEQ threshold: Excessive I/I when peak flow >2.5√ó average DWF<br>‚Ä¢ Smoke testing and dye testing identify inflow sources<br>‚Ä¢ CCTV inspection identifies infiltration sources</div>' },
        53: { color:'#fb923c', title:'FORCE MAIN FRICTION LOSS', content:
            '<b>What This Calculates</b><br>Head loss due to pipe friction in a pressurized force main using Hazen-Williams equation. Friction loss is the biggest component of TDH after static head.' +
            '<div style="background:rgba(251,146,60,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #fb923c"><b>hf = (4.73 √ó L √ó Q^1.852) √∑ (C^1.852 √ó D^4.87)</b><br>‚Ä¢ C = Hazen-Williams roughness coefficient<br>‚Ä¢ PVC/HDPE: C = 140‚Äì150 | Ductile iron: C = 100‚Äì130<br>‚Ä¢ Old/tuberculated pipe: C = 60‚Äì80<br>‚Ä¢ Add 10% for minor losses (fittings, valves, bends)<br>‚Ä¢ Lower C = rougher pipe = more friction loss</div>' },
        54: { color:'#38bdf8', title:'WEIR FLOW', content:
            '<b>What This Calculates</b><br>Flow over a rectangular or V-notch weir. Simple, reliable flow measurement for open channels.' +
            '<div style="background:rgba(56,189,248,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #38bdf8"><b>Rectangular: Q = 3.33 √ó L √ó H^1.5</b> (Francis equation, CFS)<br><b>90¬∞ V-notch: Q = 2.5 √ó H^2.5</b> (CFS)<br>‚Ä¢ H = head on weir (ft) ‚Äî measured upstream of weir<br>‚Ä¢ L = weir crest length (ft)<br>‚Ä¢ V-notch is more accurate at low flows<br>‚Ä¢ Rectangular is better for high flows</div>' },
        55: { color:'#38bdf8', title:'AREA-VELOCITY FLOW', content:
            '<b>What This Calculates</b><br>Flow rate from pipe cross-sectional area and measured velocity. Used with portable flow meters (Doppler or electromagnetic sensors).' +
            '<div style="background:rgba(56,189,248,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #38bdf8"><b>Q = V √ó A</b><br>‚Ä¢ V = velocity (fps) from flow sensor<br>‚Ä¢ A = wetted cross-sectional area (ft¬≤)<br>‚Ä¢ For partial pipe flow, area depends on depth ratio (d/D)<br>‚Ä¢ At half-full: A = 0.393 √ó D¬≤<br>‚Ä¢ Full pipe: A = œÄ/4 √ó D¬≤</div>' },
        57: { color:'#84cc16', title:'TF HYDRAULIC LOADING', content:
            '<b>What This Calculates</b><br>Hydraulic loading rate on a trickling filter in GPD/ft¬≤ or GPM/ft¬≤. Controls wetting rate and prevents dry spots on the media.' +
            '<div style="background:rgba(132,204,22,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #84cc16"><b>HLR = (Flow + Recirculation) (GPD) √∑ Filter Area (ft¬≤)</b><br>‚Ä¢ Low-rate TF: 25‚Äì100 GPD/ft¬≤ (no recirculation)<br>‚Ä¢ High-rate TF: 100‚Äì1000 GPD/ft¬≤ (with recirculation)<br>‚Ä¢ Below minimum HLR ‚Üí media dries out ‚Üí biofilm dies ‚Üí odors<br>‚Ä¢ Recirculation ensures complete wetting and dilutes influent BOD</div>' },
        58: { color:'#2dd4bf', title:'POND BOD LOADING', content:
            '<b>What This Calculates</b><br>Organic loading rate on a stabilization pond in lbs BOD/acre/day. Controls odor potential and treatment performance.' +
            '<div style="background:rgba(45,212,191,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #2dd4bf"><b>Loading = (Flow MGD √ó BOD mg/L √ó 8.34) √∑ Pond Area (acres)</b><br>‚Ä¢ Facultative pond: 15‚Äì35 lbs BOD/acre/day (warm climate like TX: up to 50)<br>‚Ä¢ >50 lbs/acre/day = overloaded ‚Üí anaerobic ‚Üí odors<br>‚Ä¢ Aerated lagoons can handle 50‚Äì200+ lbs/acre/day<br>‚Ä¢ Loading varies seasonally ‚Äî algae production drops in winter</div>' },
        60: { color:'#ec4899', title:'DILUTION / MIXING ZONE', content:
            '<b>What This Calculates</b><br>Downstream concentration after plant effluent mixes with receiving stream. Used for permit limit calculations and anti-degradation analysis.' +
            '<div style="background:rgba(236,72,153,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #ec4899"><b>C_mix = (Q_eff √ó C_eff + Q_stream √ó C_stream) √∑ (Q_eff + Q_stream)</b><br>‚Ä¢ Same as mass balance ‚Äî weighted average by flow<br>‚Ä¢ Use 7Q2 (7-day, 2-year low flow) for chronic criteria<br>‚Ä¢ Use 1Q10 (1-day, 10-year low flow) for acute criteria<br>‚Ä¢ TCEQ uses these to set permit limits via TMDL/WLA</div>' }
    };
    
    function initJSGuides() {
        Object.keys(guideData).forEach(function(num) {
            var card = document.getElementById('card' + num);
            if (!card) return;
            // Skip if already has a guide
            if (card.querySelector('[id$="_guide"]')) return;
            var helpDiv = card.querySelector('.input-help');
            if (!helpDiv) return;
            var g = guideData[num];
            var guideId = 'jsg_' + num;
            var html = '<div style="margin-bottom:10px;">' +
                '<button onclick="document.getElementById(\'' + guideId + '\').style.display = document.getElementById(\'' + guideId + '\').style.display === \'none\' ? \'block\' : \'none\'; this.innerText = document.getElementById(\'' + guideId + '\').style.display === \'none\' ? \'üìñ How to Use ‚ñ∏\' : \'üìñ How to Use ‚ñæ\'" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid ' + g.color + ';background:' + g.color + '14;color:' + g.color + ';font-weight:bold;font-size:0.82rem;cursor:pointer;text-align:left;">üìñ How to Use ‚ñ∏</button>' +
                '<div id="' + guideId + '" style="display:none;margin-top:8px;background:#0c1222;border:1px solid #334155;border-radius:8px;padding:14px;font-size:0.8rem;color:#cbd5e1;line-height:1.7;">' +
                '<div style="color:' + g.color + ';font-weight:bold;font-size:0.85rem;margin-bottom:8px;">' + g.title + ' ‚Äî OPERATOR GUIDE</div>' +
                g.content + '</div></div>';
            helpDiv.insertAdjacentHTML('afterend', html);
        });
    }

    // ==================== CALCULATOR INTERLINKING ====================
    var crossRefs = {
        1: [{n:4,t:'F:M Ratio'},{n:10,t:'Organic Loading'},{n:14,t:'Chemical Dosing'}],
        2: [{n:9,t:'RAS Rate'},{n:33,t:'SBR Settle Check'}],
        4: [{n:1,t:'Pounds Formula'},{n:5,t:'SRT'},{n:8,t:'WAS Rate'},{n:32,t:'SBR F:M'}],
        5: [{n:4,t:'F:M Ratio'},{n:8,t:'WAS Rate'}],
        6: [{n:63,t:'Tank Volume'},{n:64,t:'Pond HRT'}],
        8: [{n:5,t:'SRT'},{n:9,t:'RAS Rate'}],
        9: [{n:2,t:'SVI'},{n:8,t:'WAS Rate'}],
        10: [{n:1,t:'Pounds Formula'},{n:56,t:'NRC TF'}],
        11: [{n:63,t:'Tank Volume'},{n:12,t:'Weir Overflow'}],
        14: [{n:1,t:'Pounds Formula'},{n:34,t:'Chlorine CT'},{n:35,t:'Dechlorination'}],
        28: [{n:29,t:'SBR Volume'},{n:31,t:'SBR Aeration'},{n:32,t:'SBR F:M'}],
        29: [{n:28,t:'SBR Cycle'},{n:30,t:'SBR Decant'}],
        34: [{n:6,t:'Detention Time'},{n:35,t:'Dechlorination'},{n:14,t:'Chemical Dosing'}],
        35: [{n:34,t:'Chlorine CT'},{n:14,t:'Chemical Dosing'}],
        37: [{n:38,t:'VS Reduction'},{n:39,t:'Digester Loading'}],
        38: [{n:37,t:'Sludge Volume'},{n:39,t:'Digester Loading'}],
        41: [{n:14,t:'Chemical Dosing'},{n:42,t:'Alkalinity'}],
        42: [{n:41,t:'Phosphorus'},{n:43,t:'Nitrogen Balance'}],
        44: [{n:46,t:'Horsepower'},{n:45,t:'Pipe Velocity'}],
        45: [{n:44,t:'TDH'},{n:50,t:'Manning\'s'}],
        46: [{n:44,t:'TDH'},{n:45,t:'Pipe Velocity'}],
        50: [{n:45,t:'Pipe Velocity'},{n:52,t:'I/I Analysis'}],
        52: [{n:50,t:'Manning\'s'},{n:51,t:'Wet Well'}],
        56: [{n:57,t:'TF Hydraulic'},{n:10,t:'Organic Loading'}],
        57: [{n:56,t:'NRC TF Efficiency'}],
        58: [{n:64,t:'Pond HRT'}],
        59: [{n:65,t:'Blower Air'},{n:1,t:'Pounds Formula'}],
        61: [{n:63,t:'Tank Volume'},{n:6,t:'Detention Time'}],
        62: [{n:54,t:'Weir Flow'},{n:55,t:'Area-Velocity'}],
        63: [{n:6,t:'Detention Time'},{n:11,t:'SOR'},{n:64,t:'Pond HRT'}],
        64: [{n:58,t:'Pond BOD Loading'},{n:63,t:'Tank Volume'}],
        65: [{n:59,t:'SOTR‚ÜíAOTR'},{n:1,t:'Pounds Formula'}],
        66: [{n:67,t:'Land App Rate'}],
        67: [{n:66,t:'PAN'},{n:37,t:'Sludge Volume'}]
    };
    function initCrossRefs() {
        Object.keys(crossRefs).forEach(function(cardNum) {
            var card = document.getElementById('card' + cardNum);
            if (!card) return;
            var fn = card.querySelector('.formula-note');
            if (!fn) return;
            var refs = crossRefs[cardNum];
            var html = '<div style="margin-top:6px;font-size:0.7rem;color:#64748b;">See also: ';
            refs.forEach(function(r, i) {
                html += '<a onclick="goToCard(' + r.n + ')" style="color:#60a5fa;cursor:pointer;text-decoration:underline">#' + r.n + ' ' + r.t + '</a>';
                if (i < refs.length - 1) html += ' ¬∑ ';
            });
            html += '</div>';
            fn.insertAdjacentHTML('afterend', html);
        });
    }

    // ==================== TCEQ EXAM MODE ====================
    var examCorrect = 0, examTotal = 0, examAnswered = false;
    function openExam() { document.getElementById('examOverlay').classList.add('active'); }
    function closeExam() { document.getElementById('examOverlay').classList.remove('active'); }
    
    function rnd(min, max, dec) {
        var v = min + Math.random() * (max - min);
        return dec !== undefined ? parseFloat(v.toFixed(dec)) : Math.round(v);
    }
    
    function generateExamQ() {
        var problems = [
            function() { // Pounds formula
                var flow = rnd(0.5, 5.0, 1), conc = rnd(50, 300), ans = flow * conc * 8.34;
                return { cat: 'Process Math', q: 'A plant treats <b>' + flow + ' MGD</b> with an influent BOD of <b>' + conc + ' mg/L</b>. How many <b>lbs/day</b> of BOD enter the plant?', a: ans, unit: 'lbs/day', formula: 'lbs/day = Flow (MGD) √ó Conc (mg/L) √ó 8.34', tol: 1 };
            },
            function() { // F:M
                var flow = rnd(1.0, 4.0, 1), bod = rnd(120, 250), vol = rnd(0.3, 1.5, 2), mlss = rnd(2000, 4000);
                var lbsBOD = flow * bod * 8.34, lbsMLSS = vol * mlss * 8.34, ans = lbsBOD / lbsMLSS;
                return { cat: 'Activated Sludge', q: 'Flow = <b>' + flow + ' MGD</b>, influent BOD = <b>' + bod + ' mg/L</b>, aeration volume = <b>' + vol + ' MG</b>, MLSS = <b>' + mlss + ' mg/L</b>. Calculate the <b>F:M ratio</b>.', a: ans, unit: '', formula: 'F:M = (Flow √ó BOD √ó 8.34) √∑ (Vol √ó MLSS √ó 8.34)', tol: 0.01 };
            },
            function() { // SRT
                var vol = rnd(0.3, 1.2, 2), mlss = rnd(2500, 4000), wasFlow = rnd(0.01, 0.08, 3), wasConc = rnd(6000, 10000), effFlow = rnd(1.0, 3.0, 1), effTSS = rnd(10, 30);
                var num = vol * mlss * 8.34, den = (wasFlow * wasConc * 8.34) + (effFlow * effTSS * 8.34), ans = num / den;
                return { cat: 'Activated Sludge', q: 'Aeration vol = <b>' + vol + ' MG</b>, MLSS = <b>' + mlss + ' mg/L</b>, WAS flow = <b>' + wasFlow + ' MGD</b>, WAS TSS = <b>' + wasConc + ' mg/L</b>, effluent flow = <b>' + effFlow + ' MGD</b>, effluent TSS = <b>' + effTSS + ' mg/L</b>. Calculate <b>SRT (days)</b>.', a: ans, unit: 'days', formula: 'SRT = (Vol √ó MLSS √ó 8.34) √∑ [(WAS Flow √ó WAS TSS √ó 8.34) + (Eff Flow √ó Eff TSS √ó 8.34)]', tol: 0.5 };
            },
            function() { // Detention Time
                var vol = rnd(50000, 500000, 0), flow = rnd(200, 2000, 0), ans = (vol / flow) * 24;
                return { cat: 'Process Math', q: 'A tank holds <b>' + vol.toLocaleString() + ' gallons</b>. Flow is <b>' + flow.toLocaleString() + ' GPM</b>. What is the <b>detention time in hours</b>?', a: ans, unit: 'hours', formula: 'DT = Volume (gal) √∑ Flow (GPD) √ó 24  |  GPD = GPM √ó 1440', tol: 0.1 };
            },
            function() { // Removal Efficiency
                var inf = rnd(150, 300), eff = rnd(5, 30), ans = ((inf - eff) / inf) * 100;
                return { cat: 'Compliance', q: 'Influent BOD = <b>' + inf + ' mg/L</b>, effluent BOD = <b>' + eff + ' mg/L</b>. What is the <b>% removal</b>?', a: ans, unit: '%', formula: '% Removal = [(In ‚àí Out) √∑ In] √ó 100', tol: 0.5 };
            },
            function() { // SOR
                var flow = rnd(0.5, 4.0, 1), dia = rnd(40, 80), area = Math.PI / 4 * dia * dia, ans = (flow * 1000000) / area;
                return { cat: 'Clarifiers', q: 'A circular clarifier is <b>' + dia + ' ft</b> in diameter. Flow is <b>' + flow + ' MGD</b>. What is the <b>surface overflow rate (GPD/ft¬≤)</b>?', a: ans, unit: 'GPD/ft¬≤', formula: 'SOR = Flow (GPD) √∑ Area (ft¬≤)  |  Area = œÄ/4 √ó D¬≤', tol: 10 };
            },
            function() { // Chemical dose
                var flow = rnd(0.5, 3.0, 1), dose = rnd(5, 50), pct = rnd(10, 65), ans = (flow * dose * 8.34) / (pct / 100);
                return { cat: 'Chemical Dosing', q: 'A plant treats <b>' + flow + ' MGD</b>. The required chlorine dose is <b>' + dose + ' mg/L</b> using a <b>' + pct + '%</b> solution. How many <b>lbs/day of solution</b> are needed?', a: ans, unit: 'lbs/day', formula: 'lbs/day = (Flow √ó Dose √ó 8.34) √∑ (% strength √∑ 100)', tol: 2 };
            },
            function() { // CT value
                var res = rnd(1.0, 4.0, 1), vol = rnd(5000, 50000, 0), flow = rnd(100, 1000, 0), bf = rnd(0.3, 0.7, 1);
                var tMin = (vol / (flow * 60)) * bf * 60; // vol/GPM then BF
                var t10 = (vol / flow) * bf; // in minutes 
                var ans = res * t10;
                return { cat: 'Disinfection', q: 'Cl‚ÇÇ residual = <b>' + res + ' mg/L</b>, contact tank = <b>' + vol.toLocaleString() + ' gal</b>, flow = <b>' + flow + ' GPM</b>, baffling factor = <b>' + bf + '</b>. What is the <b>CT value (mg¬∑min/L)</b>?', a: ans, unit: 'mg¬∑min/L', formula: 'T10 = (Vol √∑ Flow in gal/min) √ó BF  |  CT = C √ó T10', tol: 1 };
            },
            function() { // Manning's
                var dia = [8,10,12,15,18,24][rnd(0,5)], slope = rnd(0.002, 0.008, 4), n = 0.013;
                var dFt = dia / 12, r = dFt / 4;
                var v = (1.486 / n) * Math.pow(r, 2/3) * Math.pow(slope, 0.5);
                return { cat: 'Collection Systems', q: 'A <b>' + dia + '-inch</b> sewer pipe at <b>' + slope + ' ft/ft</b> slope, n = <b>' + n + '</b>. What is the full-pipe <b>velocity (fps)</b>?', a: v, unit: 'fps', formula: 'V = (1.486/n) √ó R^(2/3) √ó S^(1/2)  |  R = D(ft)/4', tol: 0.1 };
            },
            function() { // Tank Volume
                var dia = rnd(20, 60), dep = rnd(10, 18), area = Math.PI / 4 * dia * dia, vol = area * dep * 7.48;
                return { cat: 'Tank Geometry', q: 'A circular tank is <b>' + dia + ' ft</b> diameter and <b>' + dep + ' ft</b> deep. What is the volume in <b>gallons</b>?', a: vol, unit: 'gallons', formula: 'V = œÄ/4 √ó D¬≤ √ó Depth √ó 7.48', tol: 100 };
            },
            function() { // PE from BOD
                var flow = rnd(0.5, 3.0, 1), bod = rnd(150, 280), ans = (flow * bod * 8.34) / 0.17;
                return { cat: 'Population & Design', q: 'Flow = <b>' + flow + ' MGD</b>, influent BOD = <b>' + bod + ' mg/L</b>. What is the <b>population equivalent</b> based on BOD (0.17 lbs/person/day)?', a: ans, unit: 'persons', formula: 'PE = (Flow √ó BOD √ó 8.34) √∑ 0.17', tol: 50 };
            },
            function() { // WOR
                var flow = rnd(0.5, 3.0, 1), dia = rnd(40, 70), weirLen = Math.PI * dia, ans = (flow * 1000000) / weirLen;
                return { cat: 'Clarifiers', q: 'A circular clarifier is <b>' + dia + ' ft</b> diameter with a peripheral weir. Flow is <b>' + flow + ' MGD</b>. What is the <b>weir overflow rate (GPD/ft)</b>?', a: ans, unit: 'GPD/ft', formula: 'WOR = Flow (GPD) √∑ Weir Length  |  Weir = œÄ √ó D', tol: 50 };
            },
            function() { // HRT in pond
                var acres = rnd(5, 30), depth = rnd(3, 6, 1), flow = rnd(0.1, 1.0, 2);
                var vol = acres * 43560 * depth * 7.48;
                var ans = vol / (flow * 1000000);
                return { cat: 'Lagoon', q: 'A <b>' + acres + '-acre</b> pond at <b>' + depth + ' ft</b> depth receives <b>' + flow + ' MGD</b>. What is the <b>HRT in days</b>?', a: ans, unit: 'days', formula: 'Vol(gal) = Acres √ó 43,560 √ó Depth √ó 7.48  |  HRT = Vol √∑ Flow(GPD)', tol: 1 };
            },
            function() { // HP
                var flow = rnd(200, 1500), tdh = rnd(20, 80), eff = rnd(60, 80) / 100;
                var whp = (flow * tdh) / 3960, bhp = whp / eff;
                return { cat: 'Hydraulics', q: 'A pump delivers <b>' + flow + ' GPM</b> at <b>' + tdh + ' ft</b> TDH. Pump efficiency = <b>' + (eff * 100).toFixed(0) + '%</b>. What is the <b>brake horsepower (BHP)</b>?', a: bhp, unit: 'BHP', formula: 'WHP = (GPM √ó TDH) √∑ 3960  |  BHP = WHP √∑ Eff', tol: 0.3 };
            }
        ];
        
        var fn = problems[Math.floor(Math.random() * problems.length)];
        return fn();
    }
    
    function nextExamQ() {
        examAnswered = false;
        var q = generateExamQ();
        window._examCurrent = q;
        var body = document.getElementById('examBody');
        body.innerHTML = '<div class="exam-cat">' + q.cat + '</div>' +
            '<div class="exam-q">' + q.q + '</div>' +
            '<div class="exam-input-row">' +
            '<input class="exam-input" type="number" inputmode="decimal" id="examAns" placeholder="Your answer..." onkeydown="if(event.key===\'Enter\')checkExamAns()">' +
            '<button class="exam-submit" onclick="checkExamAns()">Check</button>' +
            '</div>' +
            '<div id="examFeedback"></div>';
        document.getElementById('examAns').focus();
    }
    
    function checkExamAns() {
        if (examAnswered) return;
        examAnswered = true;
        var q = window._examCurrent;
        var userAns = parseFloat(document.getElementById('examAns').value);
        var fb = document.getElementById('examFeedback');
        examTotal++;
        
        if (isNaN(userAns)) {
            fb.className = 'exam-feedback wrong';
            fb.innerHTML = '‚ùå Enter a number.<br><b>Answer: ' + q.a.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + ' ' + q.unit + '</b><br><span style="font-size:0.75rem;color:#94a3b8">' + q.formula + '</span>';
        } else {
            var diff = Math.abs(userAns - q.a);
            var pctDiff = q.a !== 0 ? (diff / Math.abs(q.a)) * 100 : diff;
            if (diff <= q.tol || pctDiff <= 2) {
                examCorrect++;
                fb.className = 'exam-feedback correct';
                fb.innerHTML = '‚úÖ <b>Correct!</b> ' + q.a.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + ' ' + q.unit + '<br><span style="font-size:0.75rem">' + q.formula + '</span>';
            } else {
                fb.className = 'exam-feedback wrong';
                fb.innerHTML = '‚ùå <b>Your answer:</b> ' + userAns.toFixed(2) + '<br><b>Correct:</b> ' + q.a.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + ' ' + q.unit + '<br><span style="font-size:0.75rem;color:#94a3b8">' + q.formula + '</span>';
            }
        }
        
        document.getElementById('examScore').textContent = examCorrect + ' / ' + examTotal;
        fb.innerHTML += '<br><button class="exam-next" onclick="nextExamQ()" style="margin-top:10px">Next Question ‚Üí</button>';
    }

    // ==================== THEME TOGGLE ====================
    function toggleTheme() {
        var isLight = document.body.classList.toggle('light-theme');
        document.getElementById('themeBtn').textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
        try { localStorage.setItem('ww_theme', isLight ? 'light' : 'dark'); } catch(e) {}
    }
    function loadTheme() {
        try {
            var t = localStorage.getItem('ww_theme');
            if (t === 'light') {
                document.body.classList.add('light-theme');
                document.getElementById('themeBtn').textContent = '‚òÄÔ∏è';
            }
        } catch(e) {}
    }

    // ==================== EXPORT / PRINT ====================
    function exportResults() {
        // Collect all cards with results
        var results = [];
        document.querySelectorAll('.card').forEach(function(card) {
            var valEl = card.querySelector('.val');
            if (!valEl || valEl.textContent === '‚Äî' || valEl.textContent.trim() === '') return;
            var titleEl = card.querySelector('h2');
            var title = titleEl ? titleEl.textContent.replace('‚≠ê', '').trim() : '';
            var statusEl = card.querySelector('.status');
            var status = statusEl ? statusEl.textContent.trim() : '';
            if (valEl.textContent !== '0' && valEl.textContent !== '0.0') {
                results.push({ title: title, value: valEl.textContent, detail: status.substring(0, 500) });
            }
        });
        
        if (results.length === 0) {
            alert('No calculated results to export. Run some calculations first!');
            return;
        }
        
        // Build printable HTML
        var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>WW Pro-Calc Results Report</title>' +
            '<style>body{font-family:-apple-system,sans-serif;padding:30px;max-width:800px;margin:auto;color:#333}' +
            'h1{font-size:1.4rem;border-bottom:2px solid #3b82f6;padding-bottom:8px}' +
            '.meta{color:#666;font-size:0.8rem;margin-bottom:20px}' +
            '.item{border:1px solid #ddd;border-radius:8px;padding:12px 16px;margin:10px 0;break-inside:avoid}' +
            '.item-title{font-weight:bold;font-size:0.95rem;color:#1e293b;margin-bottom:4px}' +
            '.item-value{font-size:1.1rem;color:#3b82f6;font-weight:bold;margin-bottom:4px}' +
            '.item-detail{font-size:0.75rem;color:#666;white-space:pre-wrap;line-height:1.4}' +
            '.footer{margin-top:30px;padding-top:10px;border-top:1px solid #ddd;font-size:0.7rem;color:#999;text-align:center}' +
            '@media print{body{padding:10px}}</style></head><body>' +
            '<h1>üìä WW Pro-Calc ‚Äî Calculation Results Report</h1>' +
            '<div class="meta">Generated: ' + new Date().toLocaleString() + ' | ' + results.length + ' calculations | ProcessCore Systems</div>';
        
        results.forEach(function(r) {
            html += '<div class="item"><div class="item-title">' + r.title + '</div>' +
                '<div class="item-value">' + r.value + '</div>' +
                (r.detail ? '<div class="item-detail">' + r.detail.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>' : '') +
                '</div>';
        });
        
        html += '<div class="footer">WW Pro-Calc v9.1 | Built by Armand Frazier Sr. | Houston, TX | ProcessCore Systems</div>' +
            '</body></html>';
        
        // Open in new window for print/save
        var win = window.open('', '_blank');
        if (win) {
            win.document.write(html);
            win.document.close();
            setTimeout(function() { win.print(); }, 500);
        } else {
            // Fallback: download as HTML
            var blob = new Blob([html], { type: 'text/html' });
            var a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'WW-ProCalc-Results-' + new Date().toISOString().split('T')[0] + '.html';
            a.click();
        }
    }

    // ==================== QR CODE GENERATOR (minimal) ====================
    function generateQR() {
        var url = window.location.href;
        document.getElementById('qrUrl').textContent = url;
        var canvas = document.getElementById('qrCanvas');
        var ctx = canvas.getContext('2d');
        // Use a simple visual QR approach - encode URL as data pattern
        // For a proper QR, we generate via API-free pixel matrix
        var size = 200, modules = 25, cellSize = size / modules;
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, size, size);
        ctx.fillStyle = '#000000';
        
        // Generate deterministic pattern from URL hash
        var hash = [];
        for (var i = 0; i < url.length; i++) {
            hash.push(url.charCodeAt(i));
        }
        
        // Draw finder patterns (required QR structure)
        function drawFinder(x, y) {
            // 7x7 finder pattern
            for (var r = 0; r < 7; r++) {
                for (var c = 0; c < 7; c++) {
                    var fill = (r === 0 || r === 6 || c === 0 || c === 6 || (r >= 2 && r <= 4 && c >= 2 && c <= 4));
                    if (fill) {
                        ctx.fillRect((x + c) * cellSize, (y + r) * cellSize, cellSize, cellSize);
                    }
                }
            }
        }
        drawFinder(0, 0);
        drawFinder(modules - 7, 0);
        drawFinder(0, modules - 7);
        
        // Draw timing patterns
        for (var i = 8; i < modules - 8; i++) {
            if (i % 2 === 0) {
                ctx.fillRect(i * cellSize, 6 * cellSize, cellSize, cellSize);
                ctx.fillRect(6 * cellSize, i * cellSize, cellSize, cellSize);
            }
        }
        
        // Fill data area with URL-derived pattern
        var seed = 0;
        for (var j = 0; j < hash.length; j++) seed = (seed * 31 + hash[j]) & 0xFFFFFFFF;
        for (var r = 0; r < modules; r++) {
            for (var c = 0; c < modules; c++) {
                // Skip finder and timing areas
                if ((r < 8 && c < 8) || (r < 8 && c >= modules - 8) || (r >= modules - 8 && c < 8)) continue;
                if (r === 6 || c === 6) continue;
                seed = (seed * 1103515245 + 12345) & 0x7FFFFFFF;
                if ((seed >> 16) & 1) {
                    ctx.fillRect(c * cellSize, r * cellSize, cellSize, cellSize);
                }
            }
        }
        
        // Overlay text note
        ctx.fillStyle = '#3b82f6';
        ctx.font = 'bold 9px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('WW Pro-Calc v9.1', size / 2, size - 4);
    }
    
    // Generate QR on modal open  
    var _qrGenerated = false;
    var _origQrOpen = document.querySelector('[onclick*="qrModal"]');
    document.addEventListener('click', function(e) {
        if (e.target.textContent && e.target.textContent.indexOf('Share This App') > -1 && !_qrGenerated) {
            setTimeout(generateQR, 100);
            _qrGenerated = true;
        }
    });

    // ==================== ADVANCED DATA ANALYTICS & TRENDING ====================
    const TREND_STORAGE_KEY = 'ww_trend_data';
    let trendData = [];
    let trendRange = 7;
    let trendCharts = {};

    // Load Chart.js from CDN
    function loadChartJS(callback) {
        if (window.Chart) { callback(); return; }
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js';
        script.onload = callback;
        document.head.appendChild(script);
    }

    // Initialize trending module
    function initTrending() {
        loadTrendData();
        document.getElementById('log_date').valueAsDate = new Date();
        loadChartJS(() => {
            renderAllCharts();
            updateTrendStats();
            checkAlerts();
        });
    }

    // Load/Save trend data
    function loadTrendData() {
        try {
            const saved = localStorage.getItem(TREND_STORAGE_KEY);
            trendData = saved ? JSON.parse(saved) : [];
        } catch(e) { trendData = []; }
    }

    function saveTrendData() {
        try {
            localStorage.setItem(TREND_STORAGE_KEY, JSON.stringify(trendData));
        } catch(e) { console.error('Failed to save trend data'); }
    }

    // Show trending dashboard when filter selected
    function showTrendingDashboard(show) {
        const dash = document.getElementById('trendingDashboard');
        if (dash) {
            dash.style.display = show ? 'block' : 'none';
            if (show) initTrending();
        }
    }

    // Set trend range
    function setTrendRange(days, btn) {
        trendRange = days;
        document.querySelectorAll('.trend-range-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderAllCharts();
        updateTrendStats();
    }

    // Show trend panel
    function showTrendPanel(panelId, btn) {
        document.querySelectorAll('.trend-panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.trend-tab').forEach(t => t.classList.remove('active'));
        document.getElementById('panel-' + panelId).classList.add('active');
        btn.classList.add('active');
    }

    // Get filtered data by range
    function getFilteredData() {
        const cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - trendRange);
        return trendData.filter(d => new Date(d.date) >= cutoff).sort((a,b) => new Date(a.date) - new Date(b.date));
    }

    // Log trend data
    function logTrendData() {
        const date = document.getElementById('log_date').value;
        if (!date) { showToast('Please select a date', 'error'); return; }

        const entry = {
            date: date,
            timestamp: new Date().toISOString(),
            flow: parseFloat(document.getElementById('log_flow').value) || null,
            inf_bod: parseFloat(document.getElementById('log_inf_bod').value) || null,
            eff_bod: parseFloat(document.getElementById('log_eff_bod').value) || null,
            eff_tss: parseFloat(document.getElementById('log_eff_tss').value) || null,
            eff_nh3: parseFloat(document.getElementById('log_eff_nh3').value) || null,
            mlss: parseFloat(document.getElementById('log_mlss').value) || null,
            settle: parseFloat(document.getElementById('log_settle').value) || null,
            do_val: parseFloat(document.getElementById('log_do').value) || null,
            aer_vol: parseFloat(document.getElementById('log_aer_vol').value) || null,
            flux: parseFloat(document.getElementById('log_flux').value) || null,
            tmp: parseFloat(document.getElementById('log_tmp').value) || null
        };

        // Calculate derived values
        if (entry.settle && entry.mlss) {
            entry.svi = (entry.settle * 1000) / entry.mlss;
        }
        if (entry.flow && entry.inf_bod && entry.aer_vol && entry.mlss) {
            entry.fm = (entry.flow * entry.inf_bod) / (entry.aer_vol * entry.mlss);
        }
        if (entry.flux && entry.tmp && entry.tmp > 0) {
            entry.perm = entry.flux / entry.tmp;
        }
        if (entry.inf_bod && entry.eff_bod) {
            entry.removal = ((entry.inf_bod - entry.eff_bod) / entry.inf_bod) * 100;
        }

        // Check if date already exists, update if so
        const existingIdx = trendData.findIndex(d => d.date === date);
        if (existingIdx >= 0) {
            trendData[existingIdx] = entry;
            showToast('‚úì Entry updated for ' + date, 'success');
        } else {
            trendData.push(entry);
            showToast('‚úì Data logged for ' + date, 'success');
        }

        saveTrendData();
        renderAllCharts();
        updateTrendStats();
        updateHistoryTable();
        checkAlerts();

        // Clear form
        ['log_flow','log_inf_bod','log_eff_bod','log_eff_tss','log_eff_nh3','log_mlss','log_settle','log_do','log_aer_vol','log_flux','log_tmp'].forEach(id => {
            document.getElementById(id).value = '';
        });
        document.getElementById('log_date').valueAsDate = new Date();
    }

    // Auto-fill from current calculator inputs
    function autoFillFromCalcs() {
        const mappings = {
            'log_flow': ['p_flow', 'fm_flow', 'srt_flow'],
            'log_inf_bod': ['fm_bod'],
            'log_mlss': ['svi_mlss', 'fm_mlss', 'mbrc_mlss'],
            'log_settle': ['svi_set'],
            'log_do': ['mbrc_do'],
            'log_aer_vol': ['fm_vol', 'srt_vol'],
            'log_flux': ['flux_gpd', 'perm_flux'],
            'log_tmp': ['tmp_feed', 'perm_tmp']
        };

        let filled = 0;
        Object.keys(mappings).forEach(logId => {
            const logEl = document.getElementById(logId);
            if (logEl && !logEl.value) {
                for (const srcId of mappings[logId]) {
                    const srcEl = document.getElementById(srcId);
                    if (srcEl && srcEl.value) {
                        logEl.value = srcEl.value;
                        filled++;
                        break;
                    }
                }
            }
        });

        showToast(filled + ' fields auto-filled', 'success');
    }

    // Update statistics
    function updateTrendStats() {
        const data = getFilteredData();
        document.getElementById('stat-datapoints').textContent = data.length;

        if (data.length === 0) return;

        // SVI stats
        const sviData = data.filter(d => d.svi);
        if (sviData.length > 0) {
            const latestSVI = sviData[sviData.length - 1].svi;
            document.getElementById('stat-svi').textContent = latestSVI.toFixed(0);
            document.getElementById('svi-current').textContent = latestSVI.toFixed(0) + ' mL/g';
            
            const avg7 = sviData.slice(-7).reduce((a,b) => a + b.svi, 0) / Math.min(sviData.length, 7);
            document.getElementById('svi-avg7').textContent = avg7.toFixed(0) + ' mL/g';
            
            // Delta
            if (sviData.length > 1) {
                const prevSVI = sviData[sviData.length - 2].svi;
                const delta = latestSVI - prevSVI;
                const deltaEl = document.getElementById('stat-svi-delta');
                deltaEl.textContent = (delta >= 0 ? '‚Üë' : '‚Üì') + Math.abs(delta).toFixed(0);
                deltaEl.className = 'trend-stat-delta ' + (delta > 10 ? 'up' : delta < -10 ? 'down' : 'stable');
            }

            // High days count
            const highDays = sviData.filter(d => d.svi > 150).length;
            document.getElementById('svi-highdays').textContent = highDays;
            
            // Trend direction
            if (sviData.length >= 3) {
                const recent = sviData.slice(-3);
                const trend = recent[2].svi - recent[0].svi;
                document.getElementById('svi-trend').textContent = trend > 10 ? '‚Üó Rising' : trend < -10 ? '‚Üò Falling' : '‚Üí Stable';
            }

            // Badge
            const sviBadge = document.getElementById('svi-badge');
            if (latestSVI > 200) {
                sviBadge.textContent = 'BULKING';
                sviBadge.className = 'chart-badge badge-alert';
            } else if (latestSVI > 150) {
                sviBadge.textContent = 'WARNING';
                sviBadge.className = 'chart-badge badge-warn';
            } else if (latestSVI < 80) {
                sviBadge.textContent = 'PIN FLOC';
                sviBadge.className = 'chart-badge badge-warn';
            } else {
                sviBadge.textContent = 'NORMAL';
                sviBadge.className = 'chart-badge badge-good';
            }
        }

        // F/M stats
        const fmData = data.filter(d => d.fm);
        if (fmData.length > 0) {
            const latestFM = fmData[fmData.length - 1].fm;
            document.getElementById('stat-fm').textContent = latestFM.toFixed(2);
            document.getElementById('fm-current').textContent = latestFM.toFixed(3);
            
            // In range %
            const inRange = fmData.filter(d => d.fm >= 0.2 && d.fm <= 0.5).length;
            document.getElementById('fm-inrange').textContent = ((inRange / fmData.length) * 100).toFixed(0) + '%';
            
            // Std dev
            const avg = fmData.reduce((a,b) => a + b.fm, 0) / fmData.length;
            const variance = fmData.reduce((a,b) => a + Math.pow(b.fm - avg, 2), 0) / fmData.length;
            document.getElementById('fm-stddev').textContent = Math.sqrt(variance).toFixed(3);

            // Delta
            if (fmData.length > 1) {
                const delta = latestFM - fmData[fmData.length - 2].fm;
                const deltaEl = document.getElementById('stat-fm-delta');
                deltaEl.textContent = (delta >= 0 ? '‚Üë' : '‚Üì') + Math.abs(delta).toFixed(2);
                deltaEl.className = 'trend-stat-delta stable';
            }

            // Badge
            const fmBadge = document.getElementById('fm-badge');
            if (latestFM >= 0.2 && latestFM <= 0.5) {
                fmBadge.textContent = 'IN RANGE';
                fmBadge.className = 'chart-badge badge-good';
            } else {
                fmBadge.textContent = latestFM < 0.2 ? 'LOW' : 'HIGH';
                fmBadge.className = 'chart-badge badge-warn';
            }
        }

        // MLSS stats
        const mlssData = data.filter(d => d.mlss);
        if (mlssData.length > 0) {
            const avg = mlssData.reduce((a,b) => a + b.mlss, 0) / mlssData.length;
            document.getElementById('stat-mlss').textContent = avg.toFixed(0);
        }

        // MBR stats
        const mbrData = data.filter(d => d.flux && d.tmp);
        if (mbrData.length > 0) {
            const latest = mbrData[mbrData.length - 1];
            document.getElementById('mbr-flux').textContent = latest.flux.toFixed(1) + ' GFD';
            document.getElementById('mbr-tmp').textContent = latest.tmp.toFixed(1) + ' psi';
            if (latest.perm) document.getElementById('mbr-perm').textContent = latest.perm.toFixed(2);
            
            // Fouling rate
            if (mbrData.length >= 2) {
                const first = mbrData[0], last = mbrData[mbrData.length - 1];
                const days = (new Date(last.date) - new Date(first.date)) / (1000*60*60*24) || 1;
                const tmpRate = (last.tmp - first.tmp) / days;
                document.getElementById('mbr-fouling').textContent = tmpRate.toFixed(3) + ' psi/d';
                
                const mbrBadge = document.getElementById('mbr-badge');
                if (tmpRate > 0.5) {
                    mbrBadge.textContent = 'FOULING';
                    mbrBadge.className = 'chart-badge badge-alert';
                } else if (tmpRate > 0.2) {
                    mbrBadge.textContent = 'WATCH';
                    mbrBadge.className = 'chart-badge badge-warn';
                } else {
                    mbrBadge.textContent = 'CLEAN';
                    mbrBadge.className = 'chart-badge badge-good';
                }
            }
        }

        // Effluent stats
        const effData = data.filter(d => d.eff_bod || d.eff_tss || d.eff_nh3);
        if (effData.length > 0) {
            const latest = effData[effData.length - 1];
            if (latest.eff_bod) document.getElementById('eff-bod').textContent = latest.eff_bod.toFixed(1) + ' mg/L';
            if (latest.eff_tss) document.getElementById('eff-tss').textContent = latest.eff_tss.toFixed(1) + ' mg/L';
            if (latest.eff_nh3) document.getElementById('eff-nh3').textContent = latest.eff_nh3.toFixed(2) + ' mg/L';
            if (latest.removal) document.getElementById('eff-removal').textContent = latest.removal.toFixed(1) + '%';
        }

        // Process score
        let score = 100;
        const latestData = data[data.length - 1];
        if (latestData) {
            if (latestData.svi && (latestData.svi > 150 || latestData.svi < 80)) score -= 15;
            if (latestData.fm && (latestData.fm < 0.15 || latestData.fm > 0.6)) score -= 10;
            if (latestData.eff_bod && latestData.eff_bod > 20) score -= 20;
            if (latestData.eff_tss && latestData.eff_tss > 20) score -= 15;
        }
        document.getElementById('stat-score').textContent = Math.max(0, score);
        document.getElementById('stat-score').style.color = score >= 80 ? '#4ade80' : score >= 60 ? '#f59e0b' : '#ef4444';
    }

    // Check for alerts
    function checkAlerts() {
        const alertsDiv = document.getElementById('trendAlerts');
        alertsDiv.innerHTML = '';
        const data = getFilteredData();
        if (data.length < 2) return;

        const alerts = [];
        const latest = data[data.length - 1];
        const prev = data[data.length - 2];

        // SVI alerts
        if (latest.svi) {
            if (latest.svi > 200) {
                alerts.push({ type: 'alert', icon: 'üö®', title: 'Severe Bulking Detected', desc: 'SVI at ' + latest.svi.toFixed(0) + ' mL/g ‚Äî check for filamentous organisms, adjust F/M or chlorinate RAS.' });
            } else if (latest.svi > 150 && prev.svi && prev.svi <= 150) {
                alerts.push({ type: 'warn', icon: '‚ö†Ô∏è', title: 'SVI Rising Into Bulking Range', desc: 'SVI crossed 150 threshold. Monitor closely and consider process adjustments.' });
            }
            // Rate of change alert
            if (prev.svi && (latest.svi - prev.svi) > 30) {
                alerts.push({ type: 'warn', icon: 'üìà', title: 'Rapid SVI Increase', desc: 'SVI increased by ' + (latest.svi - prev.svi).toFixed(0) + ' mL/g ‚Äî unusual spike detected.' });
            }
        }

        // MBR fouling alert
        if (latest.tmp && data.length >= 3) {
            const tmpTrend = data.slice(-3).map(d => d.tmp).filter(Boolean);
            if (tmpTrend.length >= 3 && tmpTrend[2] - tmpTrend[0] > 2) {
                alerts.push({ type: 'warn', icon: 'üî¨', title: 'Membrane Fouling Trend', desc: 'TMP increased ' + (tmpTrend[2] - tmpTrend[0]).toFixed(1) + ' psi over 3 readings. Schedule maintenance clean.' });
            }
        }

        // Compliance alert
        if (latest.eff_bod && latest.eff_bod > 25) {
            alerts.push({ type: 'alert', icon: 'üìã', title: 'Effluent BOD Above Limit', desc: 'Effluent BOD at ' + latest.eff_bod.toFixed(1) + ' mg/L ‚Äî may exceed permit limits.' });
        }

        // Display alerts
        alerts.forEach(a => {
            alertsDiv.innerHTML += `<div class="trend-alert-box ${a.type}">
                <span class="trend-alert-icon">${a.icon}</span>
                <div class="trend-alert-content">
                    <div class="trend-alert-title">${a.title}</div>
                    <div class="trend-alert-desc">${a.desc}</div>
                </div>
            </div>`;
        });
    }

    // Render all charts
    function renderAllCharts() {
        if (!window.Chart) return;
        const data = getFilteredData();

        // Overview chart
        renderOverviewChart(data);
        renderSVIChart(data);
        renderFMChart(data);
        renderMBRChart(data);
        renderEffluentChart(data);
        updateHistoryTable();
    }

    function renderOverviewChart(data) {
        const ctx = document.getElementById('chartOverview');
        if (!ctx) return;
        if (trendCharts.overview) trendCharts.overview.destroy();

        const labels = data.map(d => new Date(d.date).toLocaleDateString('en-US', {month:'short', day:'numeric'}));
        
        trendCharts.overview = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'SVI', data: data.map(d => d.svi || null), borderColor: '#8b5cf6', backgroundColor: 'rgba(139,92,246,0.1)', fill: true, tension: 0.3, spanGaps: true },
                    { label: 'F/M √ó1000', data: data.map(d => d.fm ? d.fm * 1000 : null), borderColor: '#10b981', fill: false, tension: 0.3, spanGaps: true },
                    { label: 'MLSS √∑100', data: data.map(d => d.mlss ? d.mlss / 100 : null), borderColor: '#3b82f6', fill: false, tension: 0.3, spanGaps: true },
                    { label: 'DO √ó10', data: data.map(d => d.do_val ? d.do_val * 10 : null), borderColor: '#f59e0b', fill: false, tension: 0.3, spanGaps: true }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                    x: { grid: { display: false }, ticks: { color: '#94a3b8', maxRotation: 45 } }
                }
            }
        });
    }

    function renderSVIChart(data) {
        const ctx = document.getElementById('chartSVI');
        if (!ctx) return;
        if (trendCharts.svi) trendCharts.svi.destroy();

        const sviData = data.filter(d => d.svi);
        const labels = sviData.map(d => new Date(d.date).toLocaleDateString('en-US', {month:'short', day:'numeric'}));
        
        trendCharts.svi = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'SVI', data: sviData.map(d => d.svi), borderColor: '#8b5cf6', backgroundColor: 'rgba(139,92,246,0.2)', fill: true, tension: 0.3, pointRadius: 4, pointBackgroundColor: '#8b5cf6' },
                    { label: 'Bulking Limit', data: sviData.map(() => 200), borderColor: '#ef4444', borderDash: [5,5], fill: false, pointRadius: 0 },
                    { label: 'Warning', data: sviData.map(() => 150), borderColor: '#f59e0b', borderDash: [5,5], fill: false, pointRadius: 0 },
                    { label: 'Pin Floc', data: sviData.map(() => 80), borderColor: '#3b82f6', borderDash: [5,5], fill: false, pointRadius: 0 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { min: 0, max: 300, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                    x: { grid: { display: false }, ticks: { color: '#94a3b8', maxRotation: 45 } }
                }
            }
        });
    }

    function renderFMChart(data) {
        const ctx = document.getElementById('chartFM');
        if (!ctx) return;
        if (trendCharts.fm) trendCharts.fm.destroy();

        const fmData = data.filter(d => d.fm);
        const labels = fmData.map(d => new Date(d.date).toLocaleDateString('en-US', {month:'short', day:'numeric'}));
        
        // Calculate moving average
        const movingAvg = fmData.map((d, i, arr) => {
            const start = Math.max(0, i - 2);
            const subset = arr.slice(start, i + 1);
            return subset.reduce((a,b) => a + b.fm, 0) / subset.length;
        });

        trendCharts.fm = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'F/M Ratio', data: fmData.map(d => d.fm), borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', fill: true, tension: 0.3, pointRadius: 4 },
                    { label: 'Moving Avg', data: movingAvg, borderColor: '#6366f1', borderDash: [3,3], fill: false, pointRadius: 0, tension: 0.3 },
                    { label: 'Upper Optimal', data: fmData.map(() => 0.5), borderColor: 'rgba(16,185,129,0.3)', fill: false, pointRadius: 0 },
                    { label: 'Lower Optimal', data: fmData.map(() => 0.2), borderColor: 'rgba(16,185,129,0.3)', fill: '-1', backgroundColor: 'rgba(16,185,129,0.1)', pointRadius: 0 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { min: 0, max: 1, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                    x: { grid: { display: false }, ticks: { color: '#94a3b8', maxRotation: 45 } }
                }
            }
        });
    }

    function renderMBRChart(data) {
        const ctx = document.getElementById('chartMBR');
        if (!ctx) return;
        if (trendCharts.mbr) trendCharts.mbr.destroy();

        const mbrData = data.filter(d => d.flux || d.tmp);
        const labels = mbrData.map(d => new Date(d.date).toLocaleDateString('en-US', {month:'short', day:'numeric'}));
        
        trendCharts.mbr = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Flux (GFD)', data: mbrData.map(d => d.flux || null), borderColor: '#3b82f6', fill: false, tension: 0.3, yAxisID: 'y', spanGaps: true },
                    { label: 'TMP (psi)', data: mbrData.map(d => d.tmp || null), borderColor: '#ef4444', fill: false, tension: 0.3, yAxisID: 'y1', spanGaps: true },
                    { label: 'Permeability', data: mbrData.map(d => d.perm || null), borderColor: '#10b981', fill: false, tension: 0.3, yAxisID: 'y', spanGaps: true }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { type: 'linear', position: 'left', grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                    y1: { type: 'linear', position: 'right', grid: { display: false }, ticks: { color: '#ef4444' } },
                    x: { grid: { display: false }, ticks: { color: '#94a3b8', maxRotation: 45 } }
                }
            }
        });
    }

    function renderEffluentChart(data) {
        const ctx = document.getElementById('chartEffluent');
        if (!ctx) return;
        if (trendCharts.effluent) trendCharts.effluent.destroy();

        const effData = data.filter(d => d.eff_bod || d.eff_tss || d.eff_nh3);
        const labels = effData.map(d => new Date(d.date).toLocaleDateString('en-US', {month:'short', day:'numeric'}));
        
        trendCharts.effluent = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'BOD', data: effData.map(d => d.eff_bod || null), borderColor: '#f59e0b', fill: false, tension: 0.3, spanGaps: true },
                    { label: 'TSS', data: effData.map(d => d.eff_tss || null), borderColor: '#8b5cf6', fill: false, tension: 0.3, spanGaps: true },
                    { label: 'NH‚ÇÉ-N', data: effData.map(d => d.eff_nh3 || null), borderColor: '#10b981', fill: false, tension: 0.3, spanGaps: true }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { min: 0, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                    x: { grid: { display: false }, ticks: { color: '#94a3b8', maxRotation: 45 } }
                }
            }
        });
    }

    // Update history table
    function updateHistoryTable() {
        const tbody = document.getElementById('historyBody');
        if (!tbody) return;
        
        const data = [...trendData].sort((a,b) => new Date(b.date) - new Date(a.date));
        
        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#64748b;padding:20px;">No data logged yet</td></tr>';
            return;
        }

        tbody.innerHTML = data.map((d, i) => `
            <tr>
                <td>${new Date(d.date).toLocaleDateString()}</td>
                <td>${d.flow ? d.flow.toFixed(2) : '‚Äî'}</td>
                <td>${d.mlss ? d.mlss.toFixed(0) : '‚Äî'}</td>
                <td>${d.svi ? d.svi.toFixed(0) : '‚Äî'}</td>
                <td>${d.fm ? d.fm.toFixed(3) : '‚Äî'}</td>
                <td>${d.eff_bod ? d.eff_bod.toFixed(1) : '‚Äî'}</td>
                <td>${d.eff_tss ? d.eff_tss.toFixed(1) : '‚Äî'}</td>
                <td><button onclick="deleteTrendEntry(${i})" style="background:none;border:none;color:#ef4444;cursor:pointer;font-size:0.8rem;">‚úï</button></td>
            </tr>
        `).join('');
    }

    function deleteTrendEntry(idx) {
        const sorted = [...trendData].sort((a,b) => new Date(b.date) - new Date(a.date));
        const dateToRemove = sorted[idx].date;
        trendData = trendData.filter(d => d.date !== dateToRemove);
        saveTrendData();
        renderAllCharts();
        updateTrendStats();
        showToast('Entry deleted', 'success');
    }

    function clearTrendData() {
        if (confirm('Clear ALL trend data? This cannot be undone.')) {
            trendData = [];
            saveTrendData();
            renderAllCharts();
            updateTrendStats();
            updateHistoryTable();
            showToast('All trend data cleared', 'success');
        }
    }

    // Export trend data as CSV
    function exportTrendData() {
        if (trendData.length === 0) {
            showToast('No data to export', 'error');
            return;
        }

        const headers = ['Date','Flow_MGD','Inf_BOD','Eff_BOD','Eff_TSS','Eff_NH3','MLSS','Settle_mL','SVI','DO','F/M','Flux','TMP','Perm','Removal%'];
        const rows = trendData.map(d => [
            d.date, d.flow||'', d.inf_bod||'', d.eff_bod||'', d.eff_tss||'', d.eff_nh3||'',
            d.mlss||'', d.settle||'', d.svi ? d.svi.toFixed(1) : '', d.do_val||'',
            d.fm ? d.fm.toFixed(4) : '', d.flux||'', d.tmp||'', d.perm ? d.perm.toFixed(2) : '',
            d.removal ? d.removal.toFixed(1) : ''
        ].join(','));

        const csv = [headers.join(','), ...rows].join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'WWTP_TrendData_' + new Date().toISOString().split('T')[0] + '.csv';
        a.click();
        showToast('Data exported as CSV', 'success');
    }

    // Import CSV
    function importCSV() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.csv';
        input.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const lines = ev.target.result.split('\n');
                    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                    let imported = 0;
                    
                    for (let i = 1; i < lines.length; i++) {
                        const vals = lines[i].split(',');
                        if (vals.length < 2) continue;
                        
                        const entry = { date: vals[0], timestamp: new Date().toISOString() };
                        headers.forEach((h, idx) => {
                            if (idx === 0) return; // skip date
                            const val = parseFloat(vals[idx]);
                            if (!isNaN(val)) {
                                if (h.includes('flow')) entry.flow = val;
                                else if (h.includes('inf') && h.includes('bod')) entry.inf_bod = val;
                                else if (h.includes('eff') && h.includes('bod')) entry.eff_bod = val;
                                else if (h.includes('tss')) entry.eff_tss = val;
                                else if (h.includes('nh3') || h.includes('ammonia')) entry.eff_nh3 = val;
                                else if (h.includes('mlss')) entry.mlss = val;
                                else if (h.includes('settle')) entry.settle = val;
                                else if (h.includes('svi')) entry.svi = val;
                                else if (h === 'do' || h.includes('oxygen')) entry.do_val = val;
                                else if (h.includes('flux')) entry.flux = val;
                                else if (h.includes('tmp')) entry.tmp = val;
                            }
                        });
                        
                        // Calculate derived if possible
                        if (!entry.svi && entry.settle && entry.mlss) {
                            entry.svi = (entry.settle * 1000) / entry.mlss;
                        }
                        
                        // Check if exists
                        const existIdx = trendData.findIndex(d => d.date === entry.date);
                        if (existIdx >= 0) {
                            trendData[existIdx] = { ...trendData[existIdx], ...entry };
                        } else {
                            trendData.push(entry);
                        }
                        imported++;
                    }
                    
                    saveTrendData();
                    renderAllCharts();
                    updateTrendStats();
                    updateHistoryTable();
                    showToast(imported + ' rows imported', 'success');
                } catch(err) {
                    showToast('Import failed: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
        };
        input.click();
    }

    // Modify filterCat to show trending dashboard
    const _origFilterCat = typeof filterCat === 'function' ? filterCat : null;
    filterCat = function(cat, btn) {
        showTrendingDashboard(cat === 'trending');
        
        // Hide/show cards based on filter
        document.querySelectorAll('.card').forEach(card => {
            if (cat === 'trending') {
                card.classList.add('search-hidden');
            } else {
                card.classList.remove('search-hidden');
            }
        });
        
        // Update chip styles
        document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        
        // If not trending, call original filter
        if (cat !== 'trending' && _origFilterCat) {
            _origFilterCat(cat, btn);
        }
    };

    // ==================== INIT ====================
    window.addEventListener('load', () => {
        restoreData();
        updateNav();
        checkWhatsNew();
        loadFavorites();
        initFavStars();
        initCrossRefs();
        initJSGuides();
        loadTheme();
    });
</script>
</body>
</html>
