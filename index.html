<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="description" content="Essential wastewater treatment calculations for operators">
    <meta name="author" content="Armand Frazier Sr.">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="WW Pro-Calc">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>WW Operator Pro-Calc</title>
    <style>
        :root {
            --bg: #0f172a; --card: #1e293b; --text: #f8fafc;
            --primary: #3b82f6; --accent: #f59e0b; --danger: #ef4444;
            --success: #10b981; --card-header: #334155;
        }
        body.light-theme {
            --bg: #f1f5f9; --card: #ffffff; --text: #1e293b;
            --card-header: #e2e8f0;
        }
        body.light-theme { color: var(--text); }
        body.light-theme .card { border-color: #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        body.light-theme .card-header { background: var(--card-header); }
        body.light-theme .card-header h2 { color: #1e293b; }
        body.light-theme input, body.light-theme select { background: #f8fafc; border-color: #cbd5e1; color: #1e293b; }
        body.light-theme .result-box { background: #f8fafc; border-color: #e2e8f0; }
        body.light-theme .status { color: #475569; }
        body.light-theme .val { color: #1e293b; }
        body.light-theme .formula-note { color: #64748b; }
        body.light-theme .field-hint { color: #94a3b8; }
        body.light-theme .input-help { background: #f8fafc; border-color: #e2e8f0; color: #475569; }
        body.light-theme .search-bar { background: #fff; border-color: #cbd5e1; }
        body.light-theme .search-bar input { color: #1e293b; }
        body.light-theme .filter-chip { border-color: #cbd5e1; color: #64748b; }
        body.light-theme .nav-bar { background: #fff; border-top-color: #e2e8f0; }
        body.light-theme .nav-btn { color: #64748b; }
        body.light-theme .nav-btn.active { color: var(--primary); }
        body.light-theme .example-box { background: #f8fafc; border-color: #e2e8f0; color: #475569; }
        body.light-theme .version { color: #94a3b8; }
        body.light-theme .grid > div > label { color: #475569; }
        .theme-btn {
            padding: 5px 8px; border-radius: 8px; border: 1px solid #475569;
            background: transparent; font-size: 1rem; cursor: pointer; line-height: 1;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        .search-wrap {
            position: sticky; top: 0; z-index: 100; background: var(--bg);
            padding: 0 0 10px; margin: 0 -2px;
        }
        .search-bar {
            display: flex; align-items: center; gap: 8px;
            background: var(--card); border: 1px solid #475569; border-radius: 10px;
            padding: 10px 14px; transition: border-color 0.2s;
        }
        .search-bar:focus-within { border-color: var(--primary); }
        .search-bar svg { width: 18px; height: 18px; color: #64748b; flex-shrink: 0; }
        .search-bar input {
            flex: 1; background: none; border: none; outline: none;
            color: var(--text); font-size: 0.95rem; font-family: inherit;
        }
        .search-bar input::placeholder { color: #64748b; }
        .search-clear {
            display: none; background: none; border: none; color: #94a3b8;
            font-size: 1.2rem; cursor: pointer; padding: 0 2px; line-height: 1;
        }
        .search-count {
            font-size: 0.7rem; color: #64748b; white-space: nowrap;
        }
        .card.search-hidden, .section-header.search-hidden { display: none !important; }
        .whatsnew-overlay {
            display: none; position: fixed; inset: 0; z-index: 999;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
            align-items: center; justify-content: center; padding: 20px;
        }
        .whatsnew-overlay.active { display: flex; }
        .whatsnew-box {
            background: #1e293b; border-radius: 14px; max-width: 420px; width: 100%;
            max-height: 80vh; overflow-y: auto; border: 1px solid #475569;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .whatsnew-header {
            padding: 18px 20px 12px; border-bottom: 1px solid #334155;
            display: flex; align-items: center; justify-content: space-between;
        }
        .whatsnew-header h3 { margin: 0; font-size: 1.1rem; color: #f8fafc; }
        .whatsnew-ver { font-size: 0.7rem; background: var(--primary); color: #fff; padding: 2px 8px; border-radius: 10px; font-weight: bold; }
        .whatsnew-body { padding: 16px 20px; }
        .whatsnew-item {
            padding: 10px 0; border-bottom: 1px solid #1e293b;
            cursor: pointer; transition: background 0.15s;
        }
        .whatsnew-item:hover { background: rgba(59,130,246,0.05); margin: 0 -20px; padding: 10px 20px; }
        .whatsnew-item:last-child { border: none; }
        .whatsnew-item .wn-badge {
            display: inline-block; font-size: 0.6rem; font-weight: bold; padding: 1px 6px;
            border-radius: 4px; margin-right: 6px; vertical-align: middle;
        }
        .whatsnew-item .wn-title { font-weight: bold; font-size: 0.88rem; color: #f8fafc; }
        .whatsnew-item .wn-desc { font-size: 0.78rem; color: #94a3b8; margin-top: 3px; line-height: 1.4; }
        .whatsnew-close {
            display: block; width: calc(100% - 40px); margin: 4px 20px 16px; padding: 12px;
            background: var(--primary); color: #fff; border: none; border-radius: 8px;
            font-size: 0.95rem; font-weight: bold; cursor: pointer;
        }
        .wn-header-badge {
            background: var(--accent); color: #0f172a; font-size: 0.55rem; font-weight: bold;
            padding: 1px 5px; border-radius: 6px; margin-left: 6px; cursor: pointer;
            vertical-align: super; animation: wn-pulse 2s ease-in-out 3;
        }
        @keyframes wn-pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
        .filter-bar {
            display: flex; gap: 6px; overflow-x: auto; padding: 2px 0 10px;
            -webkit-overflow-scrolling: touch; scrollbar-width: none;
        }
        .filter-bar::-webkit-scrollbar { display: none; }
        .filter-chip {
            flex-shrink: 0; padding: 5px 12px; border-radius: 20px;
            border: 1px solid #475569; background: transparent; color: #94a3b8;
            font-size: 0.72rem; font-weight: 600; cursor: pointer;
            transition: all 0.15s; white-space: nowrap;
        }
        .filter-chip:hover { border-color: #64748b; color: #cbd5e1; }
        .filter-chip.active { background: var(--primary); border-color: var(--primary); color: #fff; }
        .fav-btn {
            background: none; border: none; cursor: pointer; font-size: 1.1rem;
            padding: 0 4px; line-height: 1; opacity: 0.3; transition: opacity 0.15s, transform 0.15s;
        }
        .fav-btn:hover { opacity: 0.6; }
        .fav-btn.favorited { opacity: 1; transform: scale(1.1); }
        .fav-section {
            display: none; margin-bottom: 12px; padding: 10px 14px;
            background: rgba(251,191,36,0.08); border: 1px dashed rgba(251,191,36,0.3);
            border-radius: 10px;
        }
        .fav-section.has-favs { display: block; }
        .fav-section-title {
            font-size: 0.75rem; font-weight: bold; color: #fbbf24;
            margin-bottom: 8px; display: flex; align-items: center; gap: 6px;
        }
        .fav-links { display: flex; flex-wrap: wrap; gap: 6px; }
        .fav-link {
            padding: 4px 10px; border-radius: 6px; font-size: 0.72rem; font-weight: 600;
            background: rgba(251,191,36,0.12); color: #fcd34d; border: 1px solid rgba(251,191,36,0.2);
            cursor: pointer; transition: background 0.15s;
        }
        .fav-link:hover { background: rgba(251,191,36,0.25); }
        input.input-warn {
            border-color: var(--accent) !important;
            box-shadow: 0 0 0 2px rgba(245,158,11,0.2);
        }
        input.input-error {
            border-color: var(--danger) !important;
            box-shadow: 0 0 0 2px rgba(239,68,68,0.2);
        }
        .input-val-msg {
            font-size: 0.65rem; margin-top: 2px; line-height: 1.3;
        }
        .input-val-msg.warn { color: var(--accent); }
        .input-val-msg.error { color: var(--danger); }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            padding: 15px; 
            padding-top: env(safe-area-inset-top, 15px);
            padding-bottom: calc(80px + env(safe-area-inset-bottom, 15px));
            margin: 0; 
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: auto; }
        @media (min-width: 768px) {
            .container { padding: 0 30px; max-width: 1000px; margin: 0 auto; }
            .search-wrap { max-width: 100%; }
            header { max-width: 100%; }
        }
        @media (max-width: 767px) {
            .container { max-width: 100%; padding: 0 10px; }
        }
        
        /* Header */
        header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px;
            position: sticky;
            top: 0;
            background: var(--bg);
            padding: 10px 0;
            z-index: 100;
            flex-wrap: wrap;
            gap: 8px;
        }
        header > div {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap;
        }
        .header-btns {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: flex-end;
        }
        h1 { font-size: 1.3rem; color: var(--primary); margin: 0; white-space: nowrap; }
        .btn-clear { 
            background: var(--danger); 
            color: white; 
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
        }
        .btn-refresh {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
        }
        .btn-refresh:active { background: #1d4ed8; }
        .btn-update {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }
        .btn-update:hover { background: linear-gradient(135deg, #60a5fa, #3b82f6); transform: scale(1.02); }
        .btn-update:active { transform: scale(0.98); }
        .btn-update .update-icon { display: inline-block; }
        .btn-update.checking .update-icon { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); }
        }
        .btn-toggle-all {
            padding: 7px 12px; border-radius: 8px; border: 1px solid #475569;
            background: transparent; color: #94a3b8; font-size: 0.75rem;
            font-weight: 600; cursor: pointer; white-space: nowrap;
        }
        .btn-toggle-all:active { background: #334155; }
        
        @media (max-width: 600px) {
            header { padding: 8px 0; }
            h1 { font-size: 1.1rem; }
            .header-btns { gap: 4px; }
            .btn-toggle-all { display: none; }
            .btn-clear, .btn-refresh, .btn-update { padding: 6px 8px; font-size: 0.85rem; }
            .theme-btn, .export-btn { padding: 6px 8px; font-size: 0.9rem; }
            .unit-toggle button { padding: 4px 8px; font-size: 0.65rem; }
        }
        .back-to-top {
            position: fixed; 
            bottom: calc(130px + env(safe-area-inset-bottom, 8px)); 
            right: 14px;
            z-index: 90; 
            background: linear-gradient(135deg, #3b82f6, #2563eb); 
            color: #fff; 
            border: none; 
            border-radius: 50%;
            width: 44px; 
            height: 44px; 
            font-size: 1.2rem;
            cursor: pointer; 
            box-shadow: 0 4px 12px rgba(59,130,246,0.4);
            display: none; 
            align-items: center; 
            justify-content: center;
            transition: transform 0.2s, opacity 0.3s;
            opacity: 0;
        }
        .back-to-top.visible { display: flex; opacity: 1; }
        .back-to-top:hover { transform: scale(1.1); }
        .back-to-top:active { transform: scale(0.95); }
        
        /* Performance: Lazy Loading */
        .card:not(.lazy-loaded) .card-body {
            content-visibility: auto;
            contain-intrinsic-size: 0 200px;
        }
        .card:not(.lazy-loaded) .card-content {
            opacity: 0;
        }
        .card.lazy-loaded .card-content {
            opacity: 1;
            transition: opacity 0.3s ease;
        }
        
        /* Performance: Offline Indicator */
        .offline-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: #fff;
            padding: 8px 16px;
            font-size: 0.8rem;
            font-weight: 600;
            text-align: center;
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .offline-indicator.show { display: flex; }
        .offline-dot {
            width: 8px;
            height: 8px;
            background: #fff;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        
        /* Performance: Loading skeleton */
        .skeleton {
            background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Onboarding Tour */
        .tour-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 9998;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        .tour-overlay.active { display: flex; }
        .tour-box {
            background: #1e293b;
            border-radius: 16px;
            max-width: 420px;
            width: 100%;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            border: 1px solid #334155;
        }
        .tour-header {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            padding: 20px;
            text-align: center;
        }
        .tour-header h3 {
            margin: 0;
            color: #fff;
            font-size: 1.2rem;
        }
        .tour-header p {
            margin: 8px 0 0;
            color: rgba(255,255,255,0.8);
            font-size: 0.85rem;
        }
        .tour-progress {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin-top: 12px;
        }
        .tour-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transition: all 0.3s;
        }
        .tour-dot.active {
            background: #fff;
            width: 24px;
            border-radius: 4px;
        }
        .tour-body {
            padding: 24px;
        }
        .tour-step {
            display: none;
            text-align: center;
        }
        .tour-step.active { display: block; }
        .tour-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }
        .tour-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #f8fafc;
            margin-bottom: 12px;
        }
        .tour-desc {
            color: #94a3b8;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        .tour-tip {
            background: rgba(59,130,246,0.1);
            border: 1px solid rgba(59,130,246,0.3);
            border-radius: 8px;
            padding: 12px;
            margin-top: 16px;
            font-size: 0.8rem;
            color: #60a5fa;
        }
        .tour-footer {
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #334155;
        }
        .tour-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        .tour-btn-skip {
            background: transparent;
            color: #64748b;
        }
        .tour-btn-skip:hover { color: #94a3b8; }
        .tour-btn-next {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: #fff;
        }
        .tour-btn-next:hover { transform: scale(1.02); }
        .tour-btn-prev {
            background: #334155;
            color: #94a3b8;
        }
        
        /* Help FAB */
        .help-fab {
            position: fixed;
            bottom: calc(185px + env(safe-area-inset-bottom, 8px));
            right: 14px;
            z-index: 89;
            background: linear-gradient(135deg, #10b981, #059669);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(16,185,129,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .help-fab:active { transform: scale(0.95); }
        
        /* TCEQ Inspection Checklist */
        .insp-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            margin: 4px 0;
            background: #1e293b;
            border-radius: 6px;
            font-size: 0.8rem;
            color: #cbd5e1;
            cursor: pointer;
            transition: all 0.2s;
        }
        .insp-item:hover { background: #334155; }
        .insp-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #22c55e;
            cursor: pointer;
        }
        .insp-item:has(input:checked) {
            background: rgba(34, 197, 94, 0.1);
            color: #4ade80;
        }
        
        /* Enhanced Tooltips */
        .tooltip-wrap {
            position: relative;
            display: inline-block;
        }
        .tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            background: #334155;
            color: #94a3b8;
            border-radius: 50%;
            font-size: 0.65rem;
            cursor: help;
            margin-left: 4px;
            vertical-align: middle;
        }
        .tooltip-content {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #0f172a;
            color: #e2e8f0;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 0.75rem;
            line-height: 1.5;
            width: 220px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            border: 1px solid #334155;
            z-index: 100;
            margin-bottom: 8px;
        }
        .tooltip-content::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #0f172a;
        }
        .tooltip-wrap:hover .tooltip-content,
        .tooltip-icon:focus + .tooltip-content {
            display: block;
        }
        
        .exam-fab {
            position: fixed; bottom: calc(75px + env(safe-area-inset-bottom, 8px)); right: 14px;
            z-index: 90; background: #dc2626; color: #fff; border: none; border-radius: 50%;
            width: 48px; height: 48px; font-size: 0.65rem; font-weight: bold;
            cursor: pointer; box-shadow: 0 4px 12px rgba(220,38,38,0.4);
            display: flex; align-items: center; justify-content: center; line-height: 1.1; text-align: center;
        }
        .exam-fab:active { transform: scale(0.95); }
        .exam-overlay {
            display: none; position: fixed; inset: 0; z-index: 998;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(4px);
            align-items: center; justify-content: center; padding: 16px;
        }
        .exam-overlay.active { display: flex; }
        .exam-box {
            background: #1e293b; border-radius: 14px; max-width: 480px; width: 100%;
            max-height: 90vh; overflow-y: auto; border: 1px solid #dc2626;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .exam-hdr {
            padding: 16px 18px; border-bottom: 1px solid #334155;
            display: flex; align-items: center; justify-content: space-between;
        }
        .exam-hdr h3 { margin: 0; font-size: 1rem; color: #f8fafc; }
        .exam-score { font-size: 0.75rem; color: #4ade80; font-weight: bold; }
        .exam-body { padding: 18px; }
        .exam-q { font-size: 0.92rem; color: #f8fafc; line-height: 1.6; margin-bottom: 14px; }
        .exam-q b { color: #fbbf24; }
        .exam-input-row { display: flex; gap: 8px; margin-bottom: 12px; }
        .exam-input {
            flex: 1; padding: 10px 14px; border-radius: 8px; border: 1px solid #475569;
            background: #0f172a; color: #f8fafc; font-size: 1rem; font-family: inherit;
        }
        .exam-submit {
            padding: 10px 18px; border-radius: 8px; border: none;
            background: var(--primary); color: #fff; font-weight: bold; cursor: pointer; font-size: 0.9rem;
        }
        .exam-feedback {
            padding: 12px; border-radius: 8px; margin-bottom: 12px; font-size: 0.85rem; line-height: 1.5;
        }
        .exam-feedback.correct { background: rgba(74,222,128,0.1); border: 1px solid #4ade80; color: #4ade80; }
        .exam-feedback.wrong { background: rgba(239,68,68,0.1); border: 1px solid #ef4444; color: #f8fafc; }
        .exam-next {
            width: 100%; padding: 12px; border-radius: 8px; border: none;
            background: #dc2626; color: #fff; font-weight: bold; cursor: pointer; font-size: 0.9rem;
        }
        .exam-close {
            background: none; border: none; color: #94a3b8; font-size: 1.4rem; cursor: pointer;
        }
        .exam-cat { font-size: 0.65rem; color: #94a3b8; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
        /* Enhanced Exam Mode Styles */
        .exam-tabs {
            display: flex; gap: 4px; padding: 12px 18px 0; border-bottom: 1px solid #334155;
            overflow-x: auto; -webkit-overflow-scrolling: touch;
        }
        .exam-tab {
            padding: 8px 14px; border-radius: 8px 8px 0 0; border: none;
            background: transparent; color: #94a3b8; font-size: 0.75rem;
            font-weight: 600; cursor: pointer; white-space: nowrap;
        }
        .exam-tab:hover { color: #e2e8f0; }
        .exam-tab.active { background: #0f172a; color: #f8fafc; }
        .exam-category-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 15px;
        }
        .exam-cat-btn {
            padding: 12px 10px; border-radius: 8px; border: 1px solid #475569;
            background: #0f172a; color: #cbd5e1; font-size: 0.75rem;
            font-weight: 600; cursor: pointer; text-align: center; transition: all 0.2s;
        }
        .exam-cat-btn:hover { border-color: #dc2626; color: #f8fafc; }
        .exam-cat-btn.active { background: #dc2626; border-color: #dc2626; color: #fff; }
        .exam-cat-btn .cat-icon { font-size: 1.2rem; display: block; margin-bottom: 4px; }
        .exam-cat-btn .cat-score { font-size: 0.6rem; color: #94a3b8; margin-top: 2px; }
        .exam-cat-btn.active .cat-score { color: rgba(255,255,255,0.8); }
        .exam-stats-row {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 15px;
        }
        .exam-stat-box {
            background: #0f172a; border-radius: 8px; padding: 10px 6px; text-align: center;
        }
        .exam-stat-label { font-size: 0.6rem; color: #64748b; text-transform: uppercase; }
        .exam-stat-val { font-size: 1.1rem; font-weight: bold; color: #f8fafc; margin-top: 2px; }
        .exam-stat-val.good { color: #4ade80; }
        .exam-stat-val.warn { color: #f59e0b; }
        .exam-stat-val.bad { color: #ef4444; }
        .flashcard {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border: 2px solid #475569; border-radius: 12px; padding: 24px;
            min-height: 180px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; text-align: center;
            cursor: pointer; transition: all 0.3s; position: relative;
        }
        .flashcard:hover { border-color: #6366f1; transform: translateY(-2px); }
        .flashcard.flipped { background: linear-gradient(135deg, #312e81, #1e1b4b); border-color: #6366f1; }
        .flashcard-cat { position: absolute; top: 10px; left: 10px; font-size: 0.6rem; color: #64748b; text-transform: uppercase; }
        .flashcard-front { font-size: 1rem; color: #f8fafc; font-weight: bold; line-height: 1.5; }
        .flashcard-back { font-size: 0.9rem; color: #a5b4fc; line-height: 1.6; display: none; }
        .flashcard.flipped .flashcard-front { display: none; }
        .flashcard.flipped .flashcard-back { display: block; }
        .flashcard-hint { position: absolute; bottom: 10px; font-size: 0.65rem; color: #475569; }
        .flashcard-nav { display: flex; gap: 8px; margin-top: 12px; }
        .flashcard-nav button {
            flex: 1; padding: 10px; border-radius: 8px; border: none;
            font-weight: bold; font-size: 0.85rem; cursor: pointer;
        }
        .flashcard-prev { background: #334155; color: #e2e8f0; }
        .flashcard-next { background: #6366f1; color: #fff; }
        .flashcard-counter { text-align: center; font-size: 0.75rem; color: #64748b; margin-top: 8px; }
        .exam-history-list { max-height: 250px; overflow-y: auto; }
        .exam-history-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 12px; border-bottom: 1px solid #334155; font-size: 0.8rem;
        }
        .exam-history-item:last-child { border: none; }
        .exam-history-date { color: #94a3b8; }
        .exam-history-score { font-weight: bold; }
        .exam-progress-bar {
            height: 6px; background: #334155; border-radius: 3px; overflow: hidden; margin-bottom: 15px;
        }
        .exam-progress-fill { height: 100%; background: linear-gradient(90deg, #ef4444, #f59e0b, #4ade80); transition: width 0.3s; }
        .weak-area-tag {
            display: inline-block; padding: 2px 8px; border-radius: 4px;
            font-size: 0.65rem; font-weight: bold; margin: 2px;
        }
        .weak-area-tag.critical { background: #ef4444; color: #fff; }
        .weak-area-tag.weak { background: #f59e0b; color: #0f172a; }
        .weak-area-tag.strong { background: #4ade80; color: #0f172a; }
        .export-btn {
            padding: 7px 12px; border-radius: 8px; border: 1px solid #475569;
            background: transparent; color: #94a3b8; font-size: 0.75rem;
            font-weight: 600; cursor: pointer; white-space: nowrap;
        }
        .export-btn:active { background: #334155; }
        @media print {
            .search-wrap, .filter-bar, .nav-bar, .exam-fab, header, .fav-section,
            .btn-copy, button, .whatsnew-overlay, .exam-overlay, .export-btn,
            .btn-toggle-all, .btn-refresh, .btn-clear, .chevron { display: none !important; }
            body { background: #fff !important; color: #000 !important; padding: 10px !important; }
            .container { max-width: 100% !important; }
            .card { border: 1px solid #ccc !important; break-inside: avoid; margin: 8px 0 !important; }
            .card-body { max-height: none !important; overflow: visible !important; }
            .card.open .card-body { padding: 10px !important; }
            .card:not(.open) { display: none !important; }
            .card-header { background: #f0f0f0 !important; color: #000 !important; }
            .result-box { background: #f8f8f8 !important; color: #000 !important; border: 1px solid #ccc !important; }
            .status { color: #333 !important; }
            .val { color: #000 !important; }
            .card-grid-wrap { display: block !important; }
            .version { color: #666 !important; }
        }

        /* Accordion Cards */
        .card { 
            background: var(--card); 
            border-radius: 12px; 
            margin-bottom: 12px; 
            border-left: 4px solid var(--primary); 
            overflow: hidden;
        }
        .card.accent { border-left-color: var(--accent); }
        .card.success { border-left-color: var(--success); }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 18px;
            background: var(--card-header);
            cursor: pointer;
            user-select: none;
        }
        .card-header:active { background: #3d4a5c; }
        .card-header h2 { 
            font-size: 1rem; 
            margin: 0; 
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card-num {
            background: var(--primary);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            flex-shrink: 0;
        }
        .card.accent .card-num { background: var(--accent); }
        .card.success .card-num { background: var(--success); }
        .diagram-badge {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: #fff;
            font-size: 0.55rem;
            padding: 2px 5px;
            border-radius: 4px;
            margin-left: 8px;
            font-weight: 600;
            letter-spacing: 0.3px;
            vertical-align: middle;
            display: inline-flex;
            align-items: center;
            gap: 3px;
        }
        .diagram-badge::before {
            content: "ðŸ“Š";
            font-size: 0.65rem;
        }
        
        .chevron {
            width: 20px;
            height: 20px;
            transition: transform 0.3s ease;
            color: #94a3b8;
            flex-shrink: 0;
        }
        .card.open .chevron { transform: rotate(180deg); }
        
        .card-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .card.open .card-body { max-height: 2000px; }
        .card-content { padding: 18px; padding-top: 10px; }

        /* Form Elements */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
        label { font-size: 0.8rem; color: #94a3b8; display: block; margin-bottom: 4px; }
        input { 
            width: 100%; 
            padding: 12px; 
            border-radius: 6px; 
            border: 2px solid #334155; 
            background: #0f172a; 
            color: white; 
            box-sizing: border-box; 
            font-size: 16px;
            transition: border-color 0.2s;
        }
        input:focus { outline: none; border-color: var(--primary); }
        input.error { border-color: var(--danger); animation: shake 0.3s; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .field-hint { font-size: 0.7rem; color: #64748b; display: block; margin-top: 3px; }
        .field-hint.error { color: var(--danger); font-weight: bold; }
        
        .input-help { 
            font-size: 0.8rem; 
            color: #94a3b8; 
            margin-bottom: 12px; 
            padding: 8px; 
            background: rgba(59, 130, 246, 0.1); 
            border-radius: 6px; 
            border-left: 3px solid var(--primary); 
        }
        .example-box { 
            font-size: 0.75rem; 
            color: #94a3b8; 
            margin: 10px 0; 
            padding: 8px; 
            background: rgba(245, 158, 11, 0.1); 
            border-radius: 6px; 
            border-left: 3px solid var(--accent); 
        }

        /* Results */
        .result-box { 
            background: #334155; 
            padding: 15px; 
            border-radius: 8px; 
            text-align: center; 
        }
        .val { display: block; font-size: 1.5rem; font-weight: bold; color: var(--accent); }
        .status { 
            font-size: 0.85rem; 
            margin-top: 8px; 
            color: #cbd5e1; 
            line-height: 1.4; 
            text-align: left; 
            padding: 0 5px; 
        }
        .btn-copy { 
            background: var(--primary); 
            color: white; 
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-top: 10px;
            cursor: pointer;
        }
        .btn-copy:active { background: #2563eb; }
        .formula-note { 
            font-size: 0.7rem; 
            color: #64748b; 
            margin-top: 10px; 
            text-align: center; 
            font-style: italic; 
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card);
            border-top: 1px solid #334155;
            padding: 6px 0;
            padding-bottom: calc(6px + env(safe-area-inset-bottom, 0px));
            z-index: 1000;
        }
        .nav-scroll {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            padding: 0 5px;
            gap: 2px;
        }
        .nav-scroll::-webkit-scrollbar { display: none; }
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            background: none;
            border: none;
            color: #64748b;
            font-size: 0.55rem;
            padding: 4px 6px;
            border-radius: 8px;
            cursor: pointer;
            min-width: 42px;
            flex-shrink: 0;
            scroll-snap-align: start;
        }
        .nav-btn:active, .nav-btn.active { 
            color: var(--primary); 
            background: rgba(59, 130, 246, 0.1);
        }
        .nav-icon {
            width: 18px;
            height: 18px;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #334155;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 0.9rem;
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }

        /* Install Prompt */
        .install-prompt {
            display: none;
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            font-size: 0.85rem;
            align-items: center;
            gap: 10px;
        }
        .install-prompt button { 
            background: white; 
            color: var(--primary); 
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-weight: bold;
            cursor: pointer;
        }

        .version { 
            font-size: 0.7rem; 
            color: #475569; 
            text-align: center; 
            padding: 15px 0; 
        }

        /* ========== ADVANCED DATA ANALYTICS & TRENDING ========== */
        .trending-dashboard {
            background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(99,102,241,0.05));
            border: 1px solid rgba(139,92,246,0.3);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 15px;
        }
        .trending-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .trending-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #a78bfa;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .trending-tabs {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .trend-tab {
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid #6366f1;
            background: transparent;
            color: #a5b4fc;
            font-size: 0.72rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .trend-tab:hover { background: rgba(99,102,241,0.2); }
        .trend-tab.active { background: #6366f1; color: #fff; }
        .trend-panel { display: none; }
        .trend-panel.active { display: block; }
        .trend-chart-wrap {
            background: #1e293b;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
            min-height: 220px;
            position: relative;
        }
        .trend-chart-title {
            font-size: 0.8rem;
            font-weight: bold;
            color: #e2e8f0;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .trend-chart-title .chart-badge {
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }
        .trend-chart-title .badge-good { background: #10b981; color: #fff; }
        .trend-chart-title .badge-warn { background: #f59e0b; color: #0f172a; }
        .trend-chart-title .badge-alert { background: #ef4444; color: #fff; }
        .trend-stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
            margin-bottom: 12px;
        }
        .trend-stat-box {
            background: #0f172a;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            border: 1px solid #334155;
        }
        .trend-stat-label {
            font-size: 0.6rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .trend-stat-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #f8fafc;
            margin-top: 2px;
        }
        .trend-stat-delta {
            font-size: 0.65rem;
            margin-top: 2px;
        }
        .trend-stat-delta.up { color: #ef4444; }
        .trend-stat-delta.down { color: #10b981; }
        .trend-stat-delta.stable { color: #94a3b8; }
        .trend-data-entry {
            background: #0f172a;
            border-radius: 10px;
            padding: 14px;
            margin-top: 12px;
        }
        .trend-entry-title {
            font-size: 0.8rem;
            font-weight: bold;
            color: #c4b5fd;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .trend-entry-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }
        .trend-entry-field label {
            font-size: 0.7rem;
            color: #94a3b8;
            display: block;
            margin-bottom: 3px;
        }
        .trend-entry-field input, .trend-entry-field select {
            width: 100%;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid #475569;
            background: #1e293b;
            color: #f8fafc;
            font-size: 0.85rem;
        }
        .trend-entry-field input:focus, .trend-entry-field select:focus {
            border-color: #8b5cf6;
            outline: none;
        }
        .trend-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .trend-btn-primary {
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            color: #fff;
        }
        .trend-btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(139,92,246,0.4); }
        .trend-btn-secondary {
            background: #334155;
            color: #e2e8f0;
        }
        .trend-btn-danger {
            background: #ef4444;
            color: #fff;
        }
        .trend-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }
        .trend-alert-box {
            background: rgba(239,68,68,0.1);
            border: 1px solid rgba(239,68,68,0.3);
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        .trend-alert-box.warn {
            background: rgba(245,158,11,0.1);
            border-color: rgba(245,158,11,0.3);
        }
        .trend-alert-box.info {
            background: rgba(59,130,246,0.1);
            border-color: rgba(59,130,246,0.3);
        }
        .trend-alert-icon { font-size: 1rem; }
        .trend-alert-content { flex: 1; }
        .trend-alert-title { font-size: 0.8rem; font-weight: bold; color: #f8fafc; }
        .trend-alert-desc { font-size: 0.72rem; color: #94a3b8; margin-top: 2px; }
        .trend-history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
            margin-top: 10px;
        }
        .trend-history-table th {
            background: #334155;
            color: #e2e8f0;
            padding: 8px 6px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        .trend-history-table td {
            padding: 6px;
            border-bottom: 1px solid #334155;
            color: #cbd5e1;
        }
        .trend-history-table tr:hover td {
            background: rgba(99,102,241,0.1);
        }
        .trend-history-wrap {
            max-height: 200px;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid #334155;
        }
        .trend-range-selector {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        .trend-range-btn {
            padding: 4px 10px;
            border-radius: 4px;
            border: 1px solid #475569;
            background: transparent;
            color: #94a3b8;
            font-size: 0.68rem;
            cursor: pointer;
        }
        .trend-range-btn.active, .trend-range-btn:hover {
            background: #6366f1;
            border-color: #6366f1;
            color: #fff;
        }
        .trend-no-data {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }
        .trend-no-data-icon { font-size: 2.5rem; opacity: 0.5; margin-bottom: 10px; }
        .trend-no-data-text { font-size: 0.85rem; }
        .trend-thresholds {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #334155;
        }
        .trend-threshold-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.68rem;
            color: #94a3b8;
        }
        .trend-threshold-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .control-limit-line { stroke-dasharray: 5, 5; }
        /* ==================== CHEMICAL INVENTORY ==================== */
        .chem-dashboard {
            display: none;
            background: linear-gradient(180deg, #064e3b 0%, #0f172a 100%);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }
        .chem-dashboard.active { display: block; }
        .chem-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .chem-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #34d399;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .chem-tabs {
            display: flex;
            gap: 4px;
            background: #1e293b;
            padding: 4px;
            border-radius: 8px;
            flex-wrap: wrap;
        }
        .chem-tab {
            padding: 6px 12px;
            border: none;
            background: transparent;
            color: #94a3b8;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .chem-tab:hover { color: #f8fafc; }
        .chem-tab.active {
            background: linear-gradient(135deg, #10b981, #059669);
            color: #fff;
        }
        .chem-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }
        .chem-card {
            background: #1e293b;
            border-radius: 10px;
            padding: 14px;
            border-left: 4px solid #10b981;
            position: relative;
        }
        .chem-card.low-stock { border-left-color: #f59e0b; }
        .chem-card.critical { border-left-color: #ef4444; }
        .chem-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        .chem-card-name {
            font-size: 0.9rem;
            font-weight: bold;
            color: #f8fafc;
        }
        .chem-card-type {
            font-size: 0.65rem;
            color: #94a3b8;
            margin-top: 2px;
        }
        .chem-card-badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: bold;
        }
        .chem-badge-ok { background: rgba(16,185,129,0.2); color: #34d399; }
        .chem-badge-low { background: rgba(245,158,11,0.2); color: #fbbf24; }
        .chem-badge-critical { background: rgba(239,68,68,0.2); color: #f87171; }
        .chem-card-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid #334155;
        }
        .chem-card-row:last-child { border-bottom: none; }
        .chem-card-label {
            font-size: 0.72rem;
            color: #94a3b8;
        }
        .chem-card-value {
            font-size: 0.85rem;
            font-weight: 600;
            color: #e2e8f0;
        }
        .chem-progress-bar {
            height: 6px;
            background: #334155;
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }
        .chem-progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
        }
        .chem-progress-ok { background: linear-gradient(90deg, #10b981, #34d399); }
        .chem-progress-low { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .chem-progress-critical { background: linear-gradient(90deg, #ef4444, #f87171); }
        .chem-card-actions {
            display: flex;
            gap: 6px;
            margin-top: 10px;
        }
        .chem-card-btn {
            flex: 1;
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .chem-btn-add { background: #10b981; color: #fff; }
        .chem-btn-add:hover { background: #059669; }
        .chem-btn-use { background: #3b82f6; color: #fff; }
        .chem-btn-use:hover { background: #2563eb; }
        .chem-btn-edit { background: #475569; color: #e2e8f0; }
        .chem-form {
            background: #0f172a;
            border-radius: 10px;
            padding: 14px;
            margin-top: 12px;
        }
        .chem-form-title {
            font-size: 0.85rem;
            font-weight: bold;
            color: #34d399;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .chem-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
        }
        .chem-form-field label {
            font-size: 0.7rem;
            color: #94a3b8;
            display: block;
            margin-bottom: 3px;
        }
        .chem-form-field input, .chem-form-field select {
            width: 100%;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid #475569;
            background: #1e293b;
            color: #f8fafc;
            font-size: 0.85rem;
        }
        .chem-form-field input:focus, .chem-form-field select:focus {
            border-color: #10b981;
            outline: none;
        }
        .chem-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .chem-btn-primary {
            background: linear-gradient(135deg, #10b981, #059669);
            color: #fff;
        }
        .chem-btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(16,185,129,0.4); }
        .chem-btn-secondary {
            background: #334155;
            color: #e2e8f0;
        }
        .chem-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }
        .chem-summary-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }
        .chem-summary-box {
            flex: 1;
            min-width: 100px;
            background: #1e293b;
            padding: 10px 12px;
            border-radius: 8px;
            text-align: center;
        }
        .chem-summary-label {
            font-size: 0.65rem;
            color: #94a3b8;
            text-transform: uppercase;
        }
        .chem-summary-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #f8fafc;
            margin-top: 2px;
        }
        .chem-summary-value.ok { color: #34d399; }
        .chem-summary-value.warn { color: #fbbf24; }
        .chem-summary-value.danger { color: #f87171; }
        .chem-history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.73rem;
            margin-top: 10px;
        }
        .chem-history-table th {
            background: #334155;
            color: #e2e8f0;
            padding: 8px 6px;
            text-align: left;
            font-weight: 600;
        }
        .chem-history-table td {
            padding: 6px;
            border-bottom: 1px solid #334155;
            color: #cbd5e1;
        }
        .chem-history-wrap {
            max-height: 220px;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid #334155;
        }
        .chem-alert {
            background: rgba(239,68,68,0.1);
            border: 1px solid rgba(239,68,68,0.3);
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        .chem-alert.warn {
            background: rgba(245,158,11,0.1);
            border-color: rgba(245,158,11,0.3);
        }
        .chem-alert-icon { font-size: 1rem; }
        .chem-alert-content { flex: 1; }
        .chem-alert-title { font-size: 0.8rem; font-weight: bold; color: #f8fafc; }
        .chem-alert-desc { font-size: 0.72rem; color: #94a3b8; margin-top: 2px; }

        /* UX/UI Improvements v9.14 */
        .unit-toggle {
            display: flex; align-items: center; gap: 6px;
            background: #334155; border-radius: 20px; padding: 4px;
        }
        .unit-toggle button {
            border: none; background: transparent; color: #94a3b8;
            padding: 4px 10px; border-radius: 16px; font-size: 0.7rem;
            font-weight: 600; cursor: pointer; transition: all 0.2s;
        }
        .unit-toggle button.active {
            background: var(--primary); color: #fff;
        }
        .scenario-btn {
            background: transparent; border: 1px solid #475569;
            color: #94a3b8; padding: 4px 8px; border-radius: 4px;
            font-size: 0.65rem; cursor: pointer; margin-left: 6px;
        }
        .scenario-btn:hover { background: #334155; color: #f8fafc; }
        .scenario-overlay {
            display: none; position: fixed; inset: 0; z-index: 999;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(4px);
            align-items: center; justify-content: center; padding: 16px;
        }
        .scenario-overlay.active { display: flex; }
        .scenario-box {
            background: #1e293b; border-radius: 14px; max-width: 500px; width: 100%;
            max-height: 85vh; overflow-y: auto; border: 1px solid var(--primary);
        }
        .scenario-hdr {
            padding: 14px 18px; border-bottom: 1px solid #334155;
            display: flex; align-items: center; justify-content: space-between;
        }
        .scenario-hdr h3 { margin: 0; font-size: 1rem; color: #f8fafc; }
        .scenario-body { padding: 16px; }
        .scenario-list { display: flex; flex-direction: column; gap: 8px; }
        .scenario-item {
            background: #334155; border-radius: 8px; padding: 12px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .scenario-item:hover { background: #3d4f66; }
        .scenario-info h4 { margin: 0 0 4px 0; font-size: 0.85rem; color: #f8fafc; }
        .scenario-info p { margin: 0; font-size: 0.7rem; color: #94a3b8; }
        .scenario-actions { display: flex; gap: 6px; }
        .scenario-actions button {
            border: none; padding: 6px 10px; border-radius: 4px;
            font-size: 0.7rem; cursor: pointer; font-weight: 600;
        }
        .scenario-actions .load-btn { background: var(--primary); color: #fff; }
        .scenario-actions .compare-btn { background: #8b5cf6; color: #fff; }
        .scenario-actions .del-btn { background: var(--danger); color: #fff; }
        .scenario-empty {
            text-align: center; padding: 30px; color: #64748b;
        }
        .compare-panel {
            display: none; background: linear-gradient(135deg, #1e1b4b, #312e81);
            border: 1px solid #6366f1; border-radius: 10px;
            padding: 14px; margin-bottom: 12px;
        }
        .compare-panel.active { display: block; }
        .compare-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 12px;
        }
        .compare-header h4 { margin: 0; color: #a5b4fc; font-size: 0.85rem; }
        .compare-close {
            background: transparent; border: none; color: #f87171;
            font-size: 1.2rem; cursor: pointer;
        }
        .compare-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
        }
        .compare-col {
            background: rgba(255,255,255,0.05); border-radius: 8px; padding: 10px;
        }
        .compare-col h5 {
            margin: 0 0 8px 0; font-size: 0.75rem; color: #c4b5fd;
            border-bottom: 1px solid #4c1d95; padding-bottom: 6px;
        }
        .compare-row {
            display: flex; justify-content: space-between;
            font-size: 0.72rem; padding: 4px 0; color: #e2e8f0;
        }
        .compare-row .label { color: #94a3b8; }
        .compare-diff { color: #fbbf24; font-weight: bold; }
        .compare-diff.better { color: #4ade80; }
        .compare-diff.worse { color: #f87171; }
        .process-diagram {
            background: linear-gradient(180deg, #0c1929, #1e293b);
            border: 1px solid #334155; border-radius: 10px;
            padding: 16px; margin: 12px 0; overflow-x: auto;
        }
        .process-diagram svg { max-width: 100%; height: auto; }
        .diagram-toggle {
            background: transparent; border: 1px dashed #475569;
            color: #64748b; padding: 8px 12px; border-radius: 6px;
            font-size: 0.75rem; cursor: pointer; width: 100%; margin-top: 8px;
        }
        .diagram-toggle:hover { border-color: #6366f1; color: #a5b4fc; }
        .save-indicator {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #10b981; color: #fff; padding: 10px 20px;
            border-radius: 20px; font-size: 0.8rem; font-weight: 600;
            z-index: 1000; opacity: 0; transition: opacity 0.3s;
            box-shadow: 0 4px 12px rgba(16,185,129,0.4);
        }
        .save-indicator.show { opacity: 1; }
        .quick-save {
            position: absolute; top: 8px; right: 50px;
            background: #10b981; border: none; color: #fff;
            padding: 4px 8px; border-radius: 4px; font-size: 0.65rem;
            cursor: pointer; opacity: 0.7; transition: opacity 0.2s;
        }
        .quick-save:hover { opacity: 1; }
        .card { position: relative; }
        
        /* Process Control Wizards */
        .wizard-dashboard {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #f59e0b;
        }
        .wizard-header { margin-bottom: 15px; }
        .wizard-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #f8fafc;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .wizard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        .wizard-card {
            background: linear-gradient(135deg, #334155 0%, #1e293b 100%);
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            border: 1px solid #475569;
            transition: all 0.2s;
            text-align: center;
        }
        .wizard-card:hover {
            border-color: #f59e0b;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245,158,11,0.2);
        }
        .wizard-card.active {
            border-color: #f59e0b;
            background: linear-gradient(135deg, #44403c 0%, #292524 100%);
        }
        .wizard-icon { font-size: 2rem; margin-bottom: 8px; }
        .wizard-name { font-size: 0.85rem; font-weight: bold; color: #f8fafc; margin-bottom: 4px; }
        .wizard-desc { font-size: 0.7rem; color: #94a3b8; line-height: 1.3; }
        .wizard-content-box {
            background: #1e293b;
            border-radius: 10px;
            padding: 15px;
            border: 1px solid #334155;
        }
        .wizard-step {
            background: #0f172a;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 3px solid #f59e0b;
        }
        .wizard-step-title {
            font-size: 0.85rem;
            font-weight: bold;
            color: #fbbf24;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .wizard-step-content { font-size: 0.78rem; color: #cbd5e1; line-height: 1.5; }
        .wizard-question {
            background: rgba(245,158,11,0.1);
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid rgba(245,158,11,0.3);
        }
        .wizard-question-text {
            font-size: 0.85rem;
            color: #f8fafc;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .wizard-options { display: flex; flex-direction: column; gap: 8px; }
        .wizard-option {
            background: #334155;
            border: 1px solid #475569;
            border-radius: 6px;
            padding: 10px 12px;
            cursor: pointer;
            font-size: 0.78rem;
            color: #e2e8f0;
            transition: all 0.15s;
        }
        .wizard-option:hover {
            background: #475569;
            border-color: #f59e0b;
        }
        .wizard-option.selected {
            background: rgba(245,158,11,0.2);
            border-color: #f59e0b;
            color: #fbbf24;
        }
        .wizard-result {
            background: linear-gradient(135deg, rgba(74,222,128,0.1) 0%, rgba(34,197,94,0.05) 100%);
            border: 1px solid rgba(74,222,128,0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }
        .wizard-result.warning {
            background: linear-gradient(135deg, rgba(251,191,36,0.1) 0%, rgba(245,158,11,0.05) 100%);
            border-color: rgba(251,191,36,0.3);
        }
        .wizard-result.danger {
            background: linear-gradient(135deg, rgba(239,68,68,0.1) 0%, rgba(220,38,38,0.05) 100%);
            border-color: rgba(239,68,68,0.3);
        }
        .wizard-result-title {
            font-size: 0.9rem;
            font-weight: bold;
            color: #4ade80;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .wizard-result.warning .wizard-result-title { color: #fbbf24; }
        .wizard-result.danger .wizard-result-title { color: #f87171; }
        .wizard-action {
            background: #0f172a;
            border-radius: 6px;
            padding: 10px;
            margin: 8px 0;
            border-left: 3px solid #4ade80;
        }
        .wizard-action.priority-high { border-left-color: #ef4444; }
        .wizard-action.priority-med { border-left-color: #f59e0b; }
        .wizard-action-title { font-size: 0.8rem; font-weight: bold; color: #f8fafc; }
        .wizard-action-desc { font-size: 0.75rem; color: #94a3b8; margin-top: 4px; }
        .wizard-calc-link {
            display: inline-block;
            background: #334155;
            color: #60a5fa;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.72rem;
            margin-top: 6px;
            cursor: pointer;
            text-decoration: none;
        }
        .wizard-calc-link:hover { background: #475569; }
        .wizard-back-btn {
            background: #475569;
            color: #f8fafc;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-top: 10px;
        }
        .wizard-back-btn:hover { background: #64748b; }
    </style>
</head>
<body>
<!-- Offline Indicator -->
<div class="offline-indicator" id="offlineIndicator">
    <span class="offline-dot"></span>
    <span>You're offline â€” All features still work!</span>
</div>

<div class="container">
    <header>
        <h1>WW Pro-Calc <span class="wn-header-badge" id="wnBadge" onclick="openWhatsNew()" style="display:none">NEW</span></h1>
        <div class="header-btns">
            <div class="unit-toggle" title="Switch units">
                <button id="unitUS" class="active" onclick="setUnits('us')">US</button>
                <button id="unitMetric" onclick="setUnits('metric')">Metric</button>
            </div>
            <button class="theme-btn" id="themeBtn" onclick="toggleTheme()" title="Toggle light/dark theme">ðŸŒ™</button>
            <button class="export-btn" onclick="exportResults()" title="Print / Export PDF">ðŸ–¨ï¸</button>
            <button class="btn-toggle-all" id="btnToggleAll" onclick="toggleAll()">Expand All</button>
            <button class="btn-refresh" onclick="openScenarios()" title="Saved Scenarios">ðŸ’¾</button>
            <button class="btn-update" id="btnUpdate" onclick="checkForUpdates()" title="Check for Updates / Refresh">
                <span class="update-icon">â†»</span> Update
            </button>
            <button class="btn-clear" onclick="clearAll()">Reset</button>
        </div>
    </header>

    <!-- What's New Modal -->
    <div class="whatsnew-overlay" id="wnOverlay" onclick="if(event.target===this)closeWhatsNew()">
        <div class="whatsnew-box">
            <div class="whatsnew-header">
                <h3>ðŸš€ What's New</h3>
                <span class="whatsnew-ver">v9.14</span>
            </div>
            <div class="whatsnew-body">
                <div class="whatsnew-item" onclick="closeWhatsNew();filterCat('tceq',document.querySelector('[data-filter=tceq]'))">
                    <div><span class="wn-badge" style="background:linear-gradient(135deg,#dc2626,#b91c1c);color:#fff">ðŸ›ï¸ NEW</span><span class="wn-title">TCEQ Compliance Tools</span></div>
                    <div class="wn-desc">DMR Calculator, Permit Limit Tracker, Inspection Checklist, and Geometric Mean for E. coli. 4 new tools for regulatory compliance!</div>
                </div>
                <div class="whatsnew-item" onclick="closeWhatsNew();startTour()">
                    <div><span class="wn-badge" style="background:linear-gradient(135deg,#10b981,#059669);color:#fff">ðŸŽ¯ NEW</span><span class="wn-title">Onboarding Tour & Help</span></div>
                    <div class="wn-desc">New users see a 6-step tour automatically. Tap the green ? button anytime for help, tour, and quick links.</div>
                </div>
                <div class="whatsnew-item" onclick="closeWhatsNew()">
                    <div><span class="wn-badge" style="background:linear-gradient(135deg,#06b6d4,#0891b2);color:#fff">âš¡ NEW</span><span class="wn-title">Performance & Offline Mode</span></div>
                    <div class="wn-desc">Lazy loading, IndexedDB storage, service worker caching. App works offline! Look for the banner when disconnected.</div>
                </div>
                <div class="whatsnew-item" onclick="closeWhatsNew();openScenarios()">
                    <div><span class="wn-badge" style="background:linear-gradient(135deg,#10b981,#059669);color:#fff">ðŸ’¾ NEW</span><span class="wn-title">Save & Compare Scenarios</span></div>
                    <div class="wn-desc">Save calculator inputs to recall later. Compare two scenarios side-by-side. Click ðŸ’¾ in header, then "How to Use" for full guide!</div>
                </div>
                <div class="whatsnew-item" onclick="closeWhatsNew()">
                    <div><span class="wn-badge" style="background:linear-gradient(135deg,#6366f1,#4f46e5);color:#fff">ðŸ”„ NEW</span><span class="wn-title">US/Metric Unit Toggle</span></div>
                    <div class="wn-desc">Switch between US and Metric units with one click. Your preference is saved automatically.</div>
                </div>
                <div class="whatsnew-item" onclick="closeWhatsNew();filterDiagrams(document.querySelector('[data-filter=diagrams]'))">
                    <div><span class="wn-badge" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:#fff">ðŸ“Š NEW</span><span class="wn-title">15 Process Flow Diagrams</span></div>
                    <div class="wn-desc">Animated SVG diagrams for 20 calculators! Look for "DIAGRAM" badges on card headers. Use the ðŸ“Š Diagrams filter to view them all.</div>
                </div>
                <div class="whatsnew-item" onclick="closeWhatsNew();filterCat('wizards',document.querySelector('[data-filter=wizards]'))">
                    <div><span class="wn-badge" style="background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff">ðŸ§™</span><span class="wn-title">16 Process Wizards</span></div>
                    <div class="wn-desc">Ammonia Breakthrough, Odor/Hâ‚‚S, Dewatering, Digester Upset, Lift Stations, Septicity, Toxic Shock, Phosphorus, Plant Startup, Energy Optimization.</div>
                </div>
                <div class="whatsnew-item" onclick="closeWhatsNew();openExam()">
                    <div><span class="wn-badge" style="background:#22c55e;color:#fff">ðŸŽ“</span><span class="wn-title">Exam Explanations</span></div>
                    <div class="wn-desc">All 85 exam questions include detailed "Why?" explanationsâ€”learn the reasoning, not just formulas.</div>
                </div>
                <div class="whatsnew-item" onclick="closeWhatsNew();goToCard(72)">
                    <div><span class="wn-badge" style="background:#fb923c;color:#fff">NEW</span><span class="wn-title">94 Calculators</span></div>
                    <div class="wn-desc">Chemical Dosing Pump, Collection Systems Suite, Activated Sludge Advanced, Design Criteria, Sludge Disposal, Laboratory calcs.</div>
                </div>
                <div class="whatsnew-item" onclick="closeWhatsNew();filterCat('wizards',document.querySelector('[data-filter=wizards]'))">
                    <div><span class="wn-badge" style="background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff">NEW</span><span class="wn-title">Process Control Wizards</span></div>
                    <div class="wn-desc">Guided troubleshooting for High SVI, Effluent Quality, DO Problems, Foam, Clarifier Issues, and Nutrient Removal. Get diagnosis + corrective actions + TCEQ exam tips!</div>
                </div>
                <div class="whatsnew-item" onclick="closeWhatsNew();goToCard(37)">
                    <div><span class="wn-badge" style="background:linear-gradient(135deg,#22d3ee,#06b6d4);color:#fff">NEW</span><span class="wn-title">Hypochlorite Dosing (#37)</span></div>
                    <div class="wn-desc">Cal-hypo or liquid bleach dosing for effluent disinfection or RAS chlorination. Includes pump settings and monthly usage.</div>
                </div>
                <div class="whatsnew-item" onclick="closeWhatsNew();openExam()">
                    <div><span class="wn-badge" style="background:linear-gradient(135deg,#f59e0b,#ef4444);color:#fff">NEW</span><span class="wn-title">ðŸ“ TCEQ Exam Prep Enhanced</span></div>
                    <div class="wn-desc">100+ questions across 7 categories targeting Class A weak areas: Collection Systems, Activated Sludge, Design Criteria, Sludge Disposal. Timed mode, expanded flashcards, study tips.</div>
                </div>
                <div class="whatsnew-item" onclick="closeWhatsNew();filterCat('trending',document.querySelector('[data-filter=trending]'))">
                    <div><span class="wn-badge" style="background:linear-gradient(135deg,#8b5cf6,#6366f1);color:#fff">NEW</span><span class="wn-title">ðŸ“ˆ Advanced Data Analytics & Trending</span></div>
                    <div class="wn-desc">Log daily process data, track SVI/F:M/MBR trends with Chart.js, proactive fouling alerts, seasonal pattern detection, CSV import/export. Click "ðŸ“ˆ Trending" filter chip.</div>
                </div>
                <div class="whatsnew-item" onclick="closeWhatsNew();goToCard(65)">
                    <div><span class="wn-badge" style="background:#4ade80;color:#0f172a">NEW</span><span class="wn-title">Parshall Flume (#65)</span></div>
                    <div class="wn-desc">11 throat widths, free-flow + submergence detection. Standard TCEQ exam topic.</div>
                </div>
                <div class="whatsnew-item" onclick="closeWhatsNew();goToCard(66)">
                    <div><span class="wn-badge" style="background:#4ade80;color:#0f172a">NEW</span><span class="wn-title">Tank Volume (#66)</span></div>
                    <div class="wn-desc">Circular, rectangular, and cone-bottom. Output in gallons, ftÂ³, MG, and mÂ³.</div>
                </div>
                <div class="whatsnew-item" onclick="closeWhatsNew();goToCard(67)">
                    <div><span class="wn-badge" style="background:#4ade80;color:#0f172a">NEW</span><span class="wn-title">Pond Detention Time (#67)</span></div>
                    <div class="wn-desc">Sludge accumulation impact on HRT, cross-section visual, short-circuiting by cell count.</div>
                </div>
                <div class="whatsnew-item" onclick="closeWhatsNew();goToCard(68)">
                    <div><span class="wn-badge" style="background:#4ade80;color:#0f172a">NEW</span><span class="wn-title">Blower Air Requirement (#68)</span></div>
                    <div class="wn-desc">SCFM from Oâ‚‚ demand + OTE. BHP estimate and annual energy cost projection.</div>
                </div>
                <div class="whatsnew-item" onclick="closeWhatsNew();goToCard(69)">
                    <div><span class="wn-badge" style="background:#4ade80;color:#0f172a">NEW</span><span class="wn-title">Plant Available Nitrogen (#69)</span></div>
                    <div class="wn-desc">PAN from NHâ‚ƒ/NOâ‚ƒ/Org-N fractions with volatilization and mineralization.</div>
                </div>
                <div class="whatsnew-item" onclick="closeWhatsNew();goToCard(70)">
                    <div><span class="wn-badge" style="background:#4ade80;color:#0f172a">NEW</span><span class="wn-title">Land Application Rate (#70)</span></div>
                    <div class="wn-desc">Agronomic rate, site capacity, hauling estimates. 40 CFR 503 compliant.</div>
                </div>
                <div class="whatsnew-item" onclick="closeWhatsNew();goToCard(64)">
                    <div><span class="wn-badge" style="background:#d946ef;color:#fff">UPG</span><span class="wn-title">Population Equivalent Enhanced (#64)</span></div>
                    <div class="wn-desc">TKN-based PE, peaking factors, EDU conversion, industrial load split, growth timeline, TCEQ report export.</div>
                </div>
                <div class="whatsnew-item">
                    <div><span class="wn-badge" style="background:#3b82f6;color:#fff">UX</span><span class="wn-title">Search Bar</span></div>
                    <div class="wn-desc">Find any of 67 calculators instantly by keyword. Sticky at top of page.</div>
                </div>
                <div class="whatsnew-item">
                    <div><span class="wn-badge" style="background:#818cf8;color:#fff">GUIDE</span><span class="wn-title">13 How to Use Guides</span></div>
                    <div class="wn-desc">Collapsible operator guides with TCEQ exam tips on SBR, Manning's, NRC, SOTRâ†’AOTR, CT, TDH, Flume, Tank Vol, Pond HRT, Blower, PAN, Land App, and PE.</div>
                </div>
                <div class="whatsnew-item">
                    <div><span class="wn-badge" style="background:#818cf8;color:#fff">GUIDE</span><span class="wn-title">52 Total Operator Guides</span></div>
                    <div class="wn-desc">How to Use guides now on 52 of 67 calculators â€” F:M, SRT, SVI, Chemical Dosing, MBR, MBBR, Sludge, Nutrients, Hydraulics, and more.</div>
                </div>
                <div class="whatsnew-item">
                    <div><span class="wn-badge" style="background:#22c55e;color:#fff">NEW</span><span class="wn-title">Dark/Light Theme</span></div>
                    <div class="wn-desc">Toggle between dark and light modes with the ðŸŒ™ button. Preference saved automatically.</div>
                </div>
                <div class="whatsnew-item">
                    <div><span class="wn-badge" style="background:#22c55e;color:#fff">NEW</span><span class="wn-title">Print / PDF Export</span></div>
                    <div class="wn-desc">ðŸ–¨ï¸ button generates a printable report of all calculated results. Print to PDF from any browser.</div>
                </div>
                <div class="whatsnew-item">
                    <div><span class="wn-badge" style="background:#22c55e;color:#fff">NEW</span><span class="wn-title">QR Code Sharing</span></div>
                    <div class="wn-desc">Share the app with coworkers via QR code â€” scan with any phone camera.</div>
                </div>
            </div>
            <button class="whatsnew-close" onclick="closeWhatsNew()">Got it â€” Let's Calculate ðŸ’ª</button>
        </div>
    </div>

    <!-- Scenario Manager Modal -->
    <div class="scenario-overlay" id="scenarioOverlay" onclick="if(event.target===this)closeScenarios()">
        <div class="scenario-box">
            <div class="scenario-hdr">
                <h3>ðŸ’¾ Saved Scenarios</h3>
                <button onclick="closeScenarios()" style="background:transparent;border:none;color:#94a3b8;font-size:1.2rem;cursor:pointer;">âœ•</button>
            </div>
            <div class="scenario-body">
                <!-- How to Use Guide -->
                <div style="margin-bottom:12px;">
                    <button id="scenarioGuideBtn" onclick="document.getElementById('scenarioGuide').style.display = document.getElementById('scenarioGuide').style.display === 'none' ? 'block' : 'none'; this.innerText = document.getElementById('scenarioGuide').style.display === 'none' ? 'â“ How to Use Scenarios â–¸' : 'â“ How to Use Scenarios â–¾'" style="width:100%;padding:10px 12px;border-radius:6px;border:1px solid #10b981;background:rgba(16,185,129,0.08);color:#4ade80;font-weight:bold;font-size:0.82rem;cursor:pointer;text-align:left;">â“ How to Use Scenarios â–¸</button>
                    <div id="scenarioGuide" style="display:none;margin-top:8px;background:#0c1222;border:1px solid #334155;border-radius:8px;padding:14px;font-size:0.8rem;color:#cbd5e1;line-height:1.7;">
                        <div style="color:#4ade80;font-weight:bold;font-size:0.9rem;margin-bottom:10px;">ðŸ“š SCENARIO MANAGER â€” USER GUIDE</div>
                        
                        <div style="color:#f8fafc;font-weight:bold;">What Are Scenarios?</div>
                        <div style="background:#1e293b;border-radius:6px;padding:10px;margin:6px 0;">
                            Scenarios let you <b>save all your calculator inputs</b> so you can recall them later. Perfect for:<br>
                            â€¢ Comparing different operating conditions (summer vs winter)<br>
                            â€¢ Saving "what-if" calculations for process optimization<br>
                            â€¢ Documenting baseline conditions before making changes<br>
                            â€¢ Quickly switching between multiple plants or processes
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:12px;">ðŸ’¾ How to Save a Scenario</div>
                        <div style="background:#1e293b;border-radius:6px;padding:10px;margin:6px 0;">
                            <b>Step 1:</b> Enter values in any calculators you want to save<br>
                            <b>Step 2:</b> Click the <span style="background:#10b981;color:#fff;padding:2px 6px;border-radius:4px;font-size:0.75rem;">ðŸ’¾</span> button in the header<br>
                            <b>Step 3:</b> Type a descriptive name (e.g., "Summer High Flow" or "Plant A Baseline")<br>
                            <b>Step 4:</b> Click <span style="background:#10b981;color:#fff;padding:2px 6px;border-radius:4px;font-size:0.75rem;">Save Current</span><br>
                            <span style="color:#94a3b8;">âœ“ All inputs from all calculators are saved automatically</span>
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:12px;">ðŸ“‚ How to Load a Scenario</div>
                        <div style="background:#1e293b;border-radius:6px;padding:10px;margin:6px 0;">
                            <b>Step 1:</b> Click <span style="background:#10b981;color:#fff;padding:2px 6px;border-radius:4px;font-size:0.75rem;">ðŸ’¾</span> to open the Scenario Manager<br>
                            <b>Step 2:</b> Find your saved scenario in the list<br>
                            <b>Step 3:</b> Click <span style="background:#3b82f6;color:#fff;padding:2px 6px;border-radius:4px;font-size:0.75rem;">Load</span><br>
                            <span style="color:#94a3b8;">âœ“ All saved values are restored to the calculators</span>
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:12px;">ðŸ“Š How to Compare Scenarios</div>
                        <div style="background:#1e293b;border-radius:6px;padding:10px;margin:6px 0;">
                            Compare two scenarios side-by-side to see how changes affect results:<br><br>
                            <b>Step 1:</b> Click <span style="background:#8b5cf6;color:#fff;padding:2px 6px;border-radius:4px;font-size:0.75rem;">Compare</span> on your first scenario<br>
                            <b>Step 2:</b> Click <span style="background:#8b5cf6;color:#fff;padding:2px 6px;border-radius:4px;font-size:0.75rem;">Compare</span> on your second scenario<br>
                            <b>Step 3:</b> A comparison panel appears showing results side-by-side<br>
                            <span style="color:#94a3b8;">ðŸ’¡ Great for: Before/After, Summer/Winter, High Flow/Low Flow comparisons</span>
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:12px;">ðŸ—‘ï¸ How to Delete a Scenario</div>
                        <div style="background:#1e293b;border-radius:6px;padding:10px;margin:6px 0;">
                            Click the <span style="background:#ef4444;color:#fff;padding:2px 6px;border-radius:4px;font-size:0.75rem;">âœ•</span> button on any scenario to delete it.<br>
                            <span style="color:#f87171;">âš ï¸ This cannot be undone!</span>
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:12px;">ðŸ’¡ Pro Tips</div>
                        <div style="background:rgba(16,185,129,0.1);border-radius:6px;padding:10px;margin:6px 0;border-left:3px solid #10b981;">
                            â€¢ <b>Naming:</b> Use descriptive names with dates â†’ "2026-02-12 Morning Baseline"<br>
                            â€¢ <b>Limit:</b> Up to 20 scenarios stored (oldest auto-deleted)<br>
                            â€¢ <b>Storage:</b> Saved in your browser's localStorage â€” stays on this device<br>
                            â€¢ <b>Compare Use Case:</b> Save current conditions, make changes, save again, compare!<br>
                            â€¢ <b>TCEQ Prep:</b> Save practice exam scenarios to review calculations later
                        </div>
                    </div>
                </div>

                <div style="margin-bottom:12px;display:flex;gap:8px;">
                    <input type="text" id="scenarioName" placeholder="Scenario name..." style="flex:1;padding:8px;border-radius:6px;border:1px solid #475569;background:#0f172a;color:#f8fafc;font-size:0.8rem;">
                    <button onclick="saveCurrentScenario()" style="background:var(--success);color:#fff;border:none;padding:8px 14px;border-radius:6px;font-weight:600;cursor:pointer;">Save Current</button>
                </div>
                <div id="scenarioList" class="scenario-list">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Compare Panel (appears above cards) -->
    <div class="compare-panel" id="comparePanel">
        <div class="compare-header">
            <h4>ðŸ“Š Compare Scenarios</h4>
            <button class="compare-close" onclick="closeCompare()">âœ•</button>
        </div>
        <div class="compare-grid" id="compareGrid">
            <!-- Populated by JS -->
        </div>
        <div style="margin-top:12px;padding:10px;background:rgba(139,92,246,0.1);border-radius:6px;font-size:0.75rem;color:#c4b5fd;">
            ðŸ’¡ <b>Tip:</b> Differences are highlighted. Click âœ• to close comparison. Load either scenario to work with those values.
        </div>
    </div>

    <!-- Save Indicator Toast -->
    <div class="save-indicator" id="saveIndicator">âœ“ Scenario Saved</div>

    <!-- Search Bar -->
    <div class="search-wrap" id="searchWrap">
        <div class="search-bar">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
            <input type="text" id="searchInput" placeholder="Search 90 calculators..." oninput="searchCalcs()" autocomplete="off" autocorrect="off" spellcheck="false">
            <span class="search-count" id="searchCount"></span>
            <button class="search-clear" id="searchClear" onclick="clearSearch()">âœ•</button>
        </div>
        <div class="filter-bar" id="filterBar">
            <button class="filter-chip active" data-filter="all" onclick="filterCat('all',this)">All (90)</button>
            <button class="filter-chip" data-filter="cas" onclick="filterCat('cas',this)">CAS Core</button>
            <button class="filter-chip" data-filter="mbr" onclick="filterCat('mbr',this)">MBR</button>
            <button class="filter-chip" data-filter="mbbr" onclick="filterCat('mbbr',this)">MBBR</button>
            <button class="filter-chip" data-filter="sbr" onclick="filterCat('sbr',this)">SBR</button>
            <button class="filter-chip" data-filter="disinf" onclick="filterCat('disinf',this)">Disinfection</button>
            <button class="filter-chip" data-filter="sludge" onclick="filterCat('sludge',this)">Sludge</button>
            <button class="filter-chip" data-filter="nutrients" onclick="filterCat('nutrients',this)">Nutrients</button>
            <button class="filter-chip" data-filter="hydraulics" onclick="filterCat('hydraulics',this)">Hydraulics</button>
            <button class="filter-chip" data-filter="compliance" onclick="filterCat('compliance',this)">Compliance</button>
            <button class="filter-chip" data-filter="collection" onclick="filterCat('collection',this)">Collection</button>
            <button class="filter-chip" data-filter="flow" onclick="filterCat('flow',this)">Flow Meas.</button>
            <button class="filter-chip" data-filter="tf" onclick="filterCat('tf',this)">Trickling Filter</button>
            <button class="filter-chip" data-filter="lagoon" onclick="filterCat('lagoon',this)">Lagoon</button>
            <button class="filter-chip" data-filter="aeration" onclick="filterCat('aeration',this)">Aeration</button>
            <button class="filter-chip" data-filter="receiving" onclick="filterCat('receiving',this)">Receiving</button>
            <button class="filter-chip" data-filter="population" onclick="filterCat('population',this)">Population</button>
            <button class="filter-chip" data-filter="tank" onclick="filterCat('tank',this)">Tank</button>
            <button class="filter-chip" data-filter="landapp" onclick="filterCat('landapp',this)">Land App</button>
            <button class="filter-chip" data-filter="convert" onclick="filterCat('convert',this)">Conversions</button>
            <button class="filter-chip" data-filter="chemfeed" onclick="filterCat('chemfeed',this)">Chem Feed</button>
            <button class="filter-chip" data-filter="design" onclick="filterCat('design',this)">Design</button>
            <button class="filter-chip" data-filter="lab" onclick="filterCat('lab',this)">Lab</button>
            <button class="filter-chip" data-filter="trending" onclick="filterCat('trending',this)" style="background:linear-gradient(135deg,#8b5cf6,#6366f1);border-color:#8b5cf6;color:#fff;">ðŸ“ˆ Trending</button>
            <button class="filter-chip" data-filter="chemicals" onclick="filterCat('chemicals',this)" style="background:linear-gradient(135deg,#10b981,#059669);border-color:#10b981;color:#fff;">ðŸ§ª Chemicals</button>
            <button class="filter-chip" data-filter="wizards" onclick="filterCat('wizards',this)" style="background:linear-gradient(135deg,#f59e0b,#d97706);border-color:#f59e0b;color:#fff;">ðŸ§™ Wizards</button>
            <button class="filter-chip" data-filter="diagrams" onclick="filterDiagrams(this)" style="background:linear-gradient(135deg,#6366f1,#8b5cf6);border-color:#6366f1;color:#fff;">ðŸ“Š Diagrams</button>
            <button class="filter-chip" data-filter="favorites" onclick="filterFavorites(this)" style="background:linear-gradient(135deg,#fbbf24,#f59e0b);border-color:#fbbf24;color:#000;">â­ Favorites</button>
            <button class="filter-chip" data-filter="tceq" onclick="filterCat('tceq',this)" style="background:linear-gradient(135deg,#dc2626,#b91c1c);border-color:#dc2626;color:#fff;">ðŸ›ï¸ TCEQ Tools</button>
        </div>
    </div>

    <!-- Favorites Section -->
    <div class="card-grid-wrap">
    <div class="fav-section" id="favSection">
        <div class="fav-section-title">â­ My Favorites <span style="font-weight:normal;color:#94a3b8;font-size:0.65rem">(tap star in any card header)</span></div>
        <div class="fav-links" id="favLinks"></div>
    </div>

    <!-- ========== ADVANCED DATA ANALYTICS & TRENDING DASHBOARD ========== -->
    <div class="trending-dashboard" id="trendingDashboard" data-cat="trending" style="display:none;">
        <div class="trending-header">
            <div class="trending-title">
                ðŸ“ˆ Advanced Data Analytics & Trending
                <span style="font-size:0.65rem;background:#8b5cf6;color:#fff;padding:2px 8px;border-radius:10px;">BETA</span>
            </div>
            <div class="trend-range-selector">
                <button class="trend-range-btn active" onclick="setTrendRange(7, this)">7D</button>
                <button class="trend-range-btn" onclick="setTrendRange(14, this)">14D</button>
                <button class="trend-range-btn" onclick="setTrendRange(30, this)">30D</button>
                <button class="trend-range-btn" onclick="setTrendRange(90, this)">90D</button>
            </div>
        </div>

        <!-- Alert Banner Area -->
        <div id="trendAlerts"></div>

        <!-- Navigation Tabs -->
        <div class="trending-tabs">
            <button class="trend-tab active" onclick="showTrendPanel('overview', this)">ðŸ“Š Overview</button>
            <button class="trend-tab" onclick="showTrendPanel('svi', this)">ðŸ§« SVI</button>
            <button class="trend-tab" onclick="showTrendPanel('fm', this)">âš–ï¸ F/M</button>
            <button class="trend-tab" onclick="showTrendPanel('mbr', this)">ðŸ”¬ MBR</button>
            <button class="trend-tab" onclick="showTrendPanel('effluent', this)">ðŸ’§ Effluent</button>
            <button class="trend-tab" onclick="showTrendPanel('entry', this)">âœï¸ Log Data</button>
            <button class="trend-tab" onclick="showTrendPanel('history', this)">ðŸ“‹ History</button>
        </div>

        <!-- OVERVIEW PANEL -->
        <div class="trend-panel active" id="panel-overview">
            <div class="trend-stats-row">
                <div class="trend-stat-box">
                    <div class="trend-stat-label">Data Points</div>
                    <div class="trend-stat-value" id="stat-datapoints">0</div>
                </div>
                <div class="trend-stat-box">
                    <div class="trend-stat-label">Latest SVI</div>
                    <div class="trend-stat-value" id="stat-svi">â€”</div>
                    <div class="trend-stat-delta stable" id="stat-svi-delta"></div>
                </div>
                <div class="trend-stat-box">
                    <div class="trend-stat-label">Latest F/M</div>
                    <div class="trend-stat-value" id="stat-fm">â€”</div>
                    <div class="trend-stat-delta stable" id="stat-fm-delta"></div>
                </div>
                <div class="trend-stat-box">
                    <div class="trend-stat-label">Avg MLSS</div>
                    <div class="trend-stat-value" id="stat-mlss">â€”</div>
                </div>
                <div class="trend-stat-box">
                    <div class="trend-stat-label">Process Score</div>
                    <div class="trend-stat-value" id="stat-score" style="color:#4ade80">â€”</div>
                </div>
            </div>
            <div class="trend-chart-wrap">
                <div class="trend-chart-title">
                    Multi-Parameter Trend Overview
                    <span class="chart-badge badge-good" id="overview-badge">STABLE</span>
                </div>
                <canvas id="chartOverview" height="200"></canvas>
                <div class="trend-thresholds">
                    <div class="trend-threshold-item"><div class="trend-threshold-dot" style="background:#8b5cf6"></div>SVI (mL/g)</div>
                    <div class="trend-threshold-item"><div class="trend-threshold-dot" style="background:#10b981"></div>F/M Ã— 1000</div>
                    <div class="trend-threshold-item"><div class="trend-threshold-dot" style="background:#3b82f6"></div>MLSS Ã· 100</div>
                    <div class="trend-threshold-item"><div class="trend-threshold-dot" style="background:#f59e0b"></div>DO Ã— 10</div>
                </div>
            </div>
        </div>

        <!-- SVI PANEL -->
        <div class="trend-panel" id="panel-svi">
            <div class="trend-stats-row">
                <div class="trend-stat-box">
                    <div class="trend-stat-label">Current SVI</div>
                    <div class="trend-stat-value" id="svi-current">â€”</div>
                </div>
                <div class="trend-stat-box">
                    <div class="trend-stat-label">7-Day Avg</div>
                    <div class="trend-stat-value" id="svi-avg7">â€”</div>
                </div>
                <div class="trend-stat-box">
                    <div class="trend-stat-label">Trend</div>
                    <div class="trend-stat-value" id="svi-trend">â€”</div>
                </div>
                <div class="trend-stat-box">
                    <div class="trend-stat-label">Days >150</div>
                    <div class="trend-stat-value" id="svi-highdays">0</div>
                </div>
            </div>
            <div class="trend-chart-wrap">
                <div class="trend-chart-title">
                    SVI Trend with Control Limits
                    <span class="chart-badge badge-good" id="svi-badge">NORMAL</span>
                </div>
                <canvas id="chartSVI" height="200"></canvas>
                <div class="trend-thresholds">
                    <div class="trend-threshold-item"><div class="trend-threshold-dot" style="background:#8b5cf6"></div>SVI</div>
                    <div class="trend-threshold-item"><div class="trend-threshold-dot" style="background:#f59e0b;opacity:0.5"></div>Warning (150)</div>
                    <div class="trend-threshold-item"><div class="trend-threshold-dot" style="background:#ef4444;opacity:0.5"></div>Bulking (200)</div>
                    <div class="trend-threshold-item"><div class="trend-threshold-dot" style="background:#3b82f6;opacity:0.5"></div>Pin Floc (80)</div>
                </div>
            </div>
            <div class="input-help" style="margin-top:10px;border-left-color:#8b5cf6;">
                <b>SVI Interpretation:</b> 80â€“150 mL/g = good settling | >150 = bulking risk | >200 = severe bulking | <80 = pin floc/old sludge. Track 7-day trends to catch developing problems early.
            </div>
        </div>

        <!-- F/M PANEL -->
        <div class="trend-panel" id="panel-fm">
            <div class="trend-stats-row">
                <div class="trend-stat-box">
                    <div class="trend-stat-label">Current F/M</div>
                    <div class="trend-stat-value" id="fm-current">â€”</div>
                </div>
                <div class="trend-stat-box">
                    <div class="trend-stat-label">Target Range</div>
                    <div class="trend-stat-value" id="fm-target" style="font-size:0.9rem">0.2â€“0.5</div>
                </div>
                <div class="trend-stat-box">
                    <div class="trend-stat-label">Std Dev</div>
                    <div class="trend-stat-value" id="fm-stddev">â€”</div>
                </div>
                <div class="trend-stat-box">
                    <div class="trend-stat-label">In Range %</div>
                    <div class="trend-stat-value" id="fm-inrange">â€”</div>
                </div>
            </div>
            <div class="trend-chart-wrap">
                <div class="trend-chart-title">
                    F/M Ratio with Optimal Band
                    <span class="chart-badge badge-good" id="fm-badge">IN RANGE</span>
                </div>
                <canvas id="chartFM" height="200"></canvas>
                <div class="trend-thresholds">
                    <div class="trend-threshold-item"><div class="trend-threshold-dot" style="background:#10b981"></div>F/M Ratio</div>
                    <div class="trend-threshold-item"><div class="trend-threshold-dot" style="background:rgba(16,185,129,0.2)"></div>Optimal (0.2â€“0.5)</div>
                    <div class="trend-threshold-item"><div class="trend-threshold-dot" style="background:#6366f1"></div>Moving Avg</div>
                </div>
            </div>
        </div>

        <!-- MBR PANEL -->
        <div class="trend-panel" id="panel-mbr">
            <div class="trend-stats-row">
                <div class="trend-stat-box">
                    <div class="trend-stat-label">Flux</div>
                    <div class="trend-stat-value" id="mbr-flux">â€”</div>
                </div>
                <div class="trend-stat-box">
                    <div class="trend-stat-label">TMP</div>
                    <div class="trend-stat-value" id="mbr-tmp">â€”</div>
                </div>
                <div class="trend-stat-box">
                    <div class="trend-stat-label">Permeability</div>
                    <div class="trend-stat-value" id="mbr-perm">â€”</div>
                </div>
                <div class="trend-stat-box">
                    <div class="trend-stat-label">Fouling Rate</div>
                    <div class="trend-stat-value" id="mbr-fouling">â€”</div>
                </div>
            </div>
            <div class="trend-chart-wrap">
                <div class="trend-chart-title">
                    Membrane Performance (Flux & TMP)
                    <span class="chart-badge badge-good" id="mbr-badge">CLEAN</span>
                </div>
                <canvas id="chartMBR" height="200"></canvas>
                <div class="trend-thresholds">
                    <div class="trend-threshold-item"><div class="trend-threshold-dot" style="background:#3b82f6"></div>Flux (GFD)</div>
                    <div class="trend-threshold-item"><div class="trend-threshold-dot" style="background:#ef4444"></div>TMP (psi)</div>
                    <div class="trend-threshold-item"><div class="trend-threshold-dot" style="background:#10b981"></div>Permeability</div>
                </div>
            </div>
            <div class="input-help" style="margin-top:10px;border-left-color:#3b82f6;">
                <b>Fouling Detection:</b> Rising TMP at constant flux = fouling. Permeability decline >20% from baseline = schedule CIP. Sudden TMP spike = possible membrane damage.
            </div>
        </div>

        <!-- EFFLUENT PANEL -->
        <div class="trend-panel" id="panel-effluent">
            <div class="trend-stats-row">
                <div class="trend-stat-box">
                    <div class="trend-stat-label">BOD Eff</div>
                    <div class="trend-stat-value" id="eff-bod">â€”</div>
                </div>
                <div class="trend-stat-box">
                    <div class="trend-stat-label">TSS Eff</div>
                    <div class="trend-stat-value" id="eff-tss">â€”</div>
                </div>
                <div class="trend-stat-box">
                    <div class="trend-stat-label">NHâ‚ƒ-N</div>
                    <div class="trend-stat-value" id="eff-nh3">â€”</div>
                </div>
                <div class="trend-stat-box">
                    <div class="trend-stat-label">Removal %</div>
                    <div class="trend-stat-value" id="eff-removal" style="color:#4ade80">â€”</div>
                </div>
            </div>
            <div class="trend-chart-wrap">
                <div class="trend-chart-title">
                    Effluent Quality Trending
                    <span class="chart-badge badge-good" id="eff-badge">COMPLIANT</span>
                </div>
                <canvas id="chartEffluent" height="200"></canvas>
                <div class="trend-thresholds">
                    <div class="trend-threshold-item"><div class="trend-threshold-dot" style="background:#f59e0b"></div>BOD (mg/L)</div>
                    <div class="trend-threshold-item"><div class="trend-threshold-dot" style="background:#8b5cf6"></div>TSS (mg/L)</div>
                    <div class="trend-threshold-item"><div class="trend-threshold-dot" style="background:#10b981"></div>NHâ‚ƒ-N (mg/L)</div>
                </div>
            </div>
        </div>

        <!-- DATA ENTRY PANEL -->
        <div class="trend-panel" id="panel-entry">
            <div class="trend-data-entry">
                <div class="trend-entry-title">âœï¸ Log Daily Process Data</div>
                <div class="trend-entry-grid">
                    <div class="trend-entry-field">
                        <label>Date</label>
                        <input type="date" id="log_date">
                    </div>
                    <div class="trend-entry-field">
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="log_flow" placeholder="1.5">
                    </div>
                    <div class="trend-entry-field">
                        <label>Inf BOD (mg/L)</label>
                        <input type="number" inputmode="decimal" id="log_inf_bod" placeholder="200">
                    </div>
                    <div class="trend-entry-field">
                        <label>Eff BOD (mg/L)</label>
                        <input type="number" inputmode="decimal" id="log_eff_bod" placeholder="10">
                    </div>
                    <div class="trend-entry-field">
                        <label>Eff TSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="log_eff_tss" placeholder="10">
                    </div>
                    <div class="trend-entry-field">
                        <label>Eff NHâ‚ƒ (mg/L)</label>
                        <input type="number" inputmode="decimal" id="log_eff_nh3" placeholder="1.0">
                    </div>
                    <div class="trend-entry-field">
                        <label>MLSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="log_mlss" placeholder="3000">
                    </div>
                    <div class="trend-entry-field">
                        <label>30-min Settle (mL)</label>
                        <input type="number" inputmode="decimal" id="log_settle" placeholder="300">
                    </div>
                    <div class="trend-entry-field">
                        <label>DO (mg/L)</label>
                        <input type="number" inputmode="decimal" id="log_do" placeholder="2.0">
                    </div>
                    <div class="trend-entry-field">
                        <label>Aer Vol (MG)</label>
                        <input type="number" inputmode="decimal" id="log_aer_vol" placeholder="0.5">
                    </div>
                    <div class="trend-entry-field">
                        <label>Flux (GFD)</label>
                        <input type="number" inputmode="decimal" id="log_flux" placeholder="12">
                    </div>
                    <div class="trend-entry-field">
                        <label>TMP (psi)</label>
                        <input type="number" inputmode="decimal" id="log_tmp" placeholder="5">
                    </div>
                </div>
                <div class="trend-actions">
                    <button class="trend-btn trend-btn-primary" onclick="logTrendData()">ðŸ’¾ Save Entry</button>
                    <button class="trend-btn trend-btn-secondary" onclick="autoFillFromCalcs()">ðŸ”„ Auto-Fill from Calcs</button>
                    <button class="trend-btn trend-btn-secondary" onclick="importCSV()">ðŸ“¥ Import CSV</button>
                    <button class="trend-btn trend-btn-secondary" onclick="exportTrendData()">ðŸ“¤ Export Data</button>
                </div>
            </div>
            <div class="input-help" style="margin-top:12px;border-left-color:#a78bfa;">
                <b>Tip:</b> Log data daily for best trend analysis. Use "Auto-Fill from Calcs" to pull current values from your calculator inputs. SVI is auto-calculated from Settle/MLSS.
            </div>
        </div>

        <!-- HISTORY PANEL -->
        <div class="trend-panel" id="panel-history">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <div class="trend-entry-title" style="margin:0;">ðŸ“‹ Data History</div>
                <button class="trend-btn trend-btn-danger" onclick="clearTrendData()" style="padding:6px 12px;font-size:0.7rem;">ðŸ—‘ï¸ Clear All</button>
            </div>
            <div class="trend-history-wrap" id="historyTableWrap">
                <table class="trend-history-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Flow</th>
                            <th>MLSS</th>
                            <th>SVI</th>
                            <th>F/M</th>
                            <th>BOD</th>
                            <th>TSS</th>
                            <th>âš™ï¸</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                        <tr><td colspan="8" style="text-align:center;color:#64748b;padding:20px;">No data logged yet</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- CHEMICAL INVENTORY DASHBOARD -->
    <div class="chem-dashboard" id="chemDashboard" data-cat="chemicals" style="display:none;">
        <div class="chem-header">
            <div class="chem-title">
                ðŸ§ª Chemical Inventory & Tracking
            </div>
            <div class="chem-tabs">
                <button class="chem-tab active" onclick="showChemPanel('inventory', this)">ðŸ“¦ Inventory</button>
                <button class="chem-tab" onclick="showChemPanel('usage', this)">ðŸ“‰ Usage</button>
                <button class="chem-tab" onclick="showChemPanel('add', this)">âž• Add Chemical</button>
                <button class="chem-tab" onclick="showChemPanel('history', this)">ðŸ“‹ History</button>
            </div>
        </div>

        <!-- Alerts Area -->
        <div id="chemAlerts"></div>

        <!-- INVENTORY PANEL -->
        <div class="chem-panel active" id="chem-panel-inventory">
            <div class="chem-summary-row">
                <div class="chem-summary-box">
                    <div class="chem-summary-label">Total Chemicals</div>
                    <div class="chem-summary-value" id="chem-total">0</div>
                </div>
                <div class="chem-summary-box">
                    <div class="chem-summary-label">Low Stock</div>
                    <div class="chem-summary-value warn" id="chem-low">0</div>
                </div>
                <div class="chem-summary-box">
                    <div class="chem-summary-label">Critical</div>
                    <div class="chem-summary-value danger" id="chem-critical">0</div>
                </div>
                <div class="chem-summary-box">
                    <div class="chem-summary-label">Monthly Cost</div>
                    <div class="chem-summary-value" id="chem-cost">$0</div>
                </div>
            </div>
            <div class="chem-grid" id="chemGrid">
                <div style="grid-column:1/-1;text-align:center;padding:40px;color:#64748b;">
                    <div style="font-size:2.5rem;opacity:0.5;margin-bottom:10px;">ðŸ§ª</div>
                    <div>No chemicals added yet. Click "âž• Add Chemical" to get started.</div>
                </div>
            </div>
        </div>

        <!-- USAGE PANEL -->
        <div class="chem-panel" id="chem-panel-usage" style="display:none;">
            <div class="chem-form">
                <div class="chem-form-title">ðŸ“‰ Log Chemical Usage</div>
                <div class="chem-form-grid">
                    <div class="chem-form-field">
                        <label>Chemical</label>
                        <select id="usage_chem" onchange="updateUsageRate()">
                            <option value="">Select chemical...</option>
                        </select>
                    </div>
                    <div class="chem-form-field">
                        <label>Amount Used</label>
                        <input type="number" id="usage_amount" placeholder="50" oninput="updateUsageRate()">
                    </div>
                    <div class="chem-form-field">
                        <label>Unit</label>
                        <select id="usage_unit">
                            <option value="lbs">lbs</option>
                            <option value="gal">gallons</option>
                            <option value="kg">kg</option>
                            <option value="L">liters</option>
                        </select>
                    </div>
                    <div class="chem-form-field">
                        <label>Date</label>
                        <input type="date" id="usage_date">
                    </div>
                    <div class="chem-form-field" style="grid-column:1/-1;">
                        <label>Notes (optional)</label>
                        <input type="text" id="usage_notes" placeholder="e.g., Heavy rain event, increased dosing">
                    </div>
                </div>
                <div class="chem-actions">
                    <button class="chem-btn chem-btn-primary" onclick="logChemUsage()">ðŸ“‰ Log Usage</button>
                    <button class="chem-btn chem-btn-secondary" onclick="autoCalcFromDosing()">ðŸ”„ Auto-Calc from Dosing</button>
                </div>
            </div>
            <div style="margin-top:15px;">
                <div class="chem-form-title">ðŸ“Š Usage Summary (Last 30 Days)</div>
                <div id="usageSummary" style="color:#94a3b8;font-size:0.8rem;">No usage data logged yet.</div>
            </div>
        </div>

        <!-- ADD CHEMICAL PANEL -->
        <div class="chem-panel" id="chem-panel-add" style="display:none;">
            <div class="chem-form">
                <div class="chem-form-title">âž• Add New Chemical</div>
                <div class="chem-form-grid">
                    <div class="chem-form-field">
                        <label>Chemical Name</label>
                        <input type="text" id="chem_name" placeholder="e.g., Sodium Hypochlorite">
                    </div>
                    <div class="chem-form-field">
                        <label>Type</label>
                        <select id="chem_type">
                            <option value="disinfection">Disinfection</option>
                            <option value="coagulant">Coagulant</option>
                            <option value="polymer">Polymer</option>
                            <option value="pH">pH Adjustment</option>
                            <option value="nutrient">Nutrient</option>
                            <option value="defoamer">Defoamer</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="chem-form-field">
                        <label>Current Quantity</label>
                        <input type="number" id="chem_qty" placeholder="500">
                    </div>
                    <div class="chem-form-field">
                        <label>Unit</label>
                        <select id="chem_unit">
                            <option value="lbs">lbs</option>
                            <option value="gal">gallons</option>
                            <option value="kg">kg</option>
                            <option value="L">liters</option>
                            <option value="drums">drums</option>
                            <option value="totes">totes</option>
                        </select>
                    </div>
                    <div class="chem-form-field">
                        <label>Reorder Level</label>
                        <input type="number" id="chem_reorder" placeholder="100">
                    </div>
                    <div class="chem-form-field">
                        <label>Critical Level</label>
                        <input type="number" id="chem_critical" placeholder="25">
                    </div>
                    <div class="chem-form-field">
                        <label>Max Capacity</label>
                        <input type="number" id="chem_max" placeholder="1000">
                    </div>
                    <div class="chem-form-field">
                        <label>Unit Cost ($)</label>
                        <input type="number" id="chem_cost" placeholder="0.50" step="0.01">
                    </div>
                    <div class="chem-form-field">
                        <label>Supplier</label>
                        <input type="text" id="chem_supplier" placeholder="e.g., Brenntag">
                    </div>
                    <div class="chem-form-field">
                        <label>Lead Time (days)</label>
                        <input type="number" id="chem_lead" placeholder="7">
                    </div>
                </div>
                <div class="chem-actions">
                    <button class="chem-btn chem-btn-primary" onclick="addChemical()">ðŸ’¾ Save Chemical</button>
                    <button class="chem-btn chem-btn-secondary" onclick="loadPresetChemical()">ðŸ“‹ Load Preset</button>
                </div>
                <div style="margin-top:12px;">
                    <div style="font-size:0.72rem;color:#94a3b8;margin-bottom:6px;">Quick Add Presets:</div>
                    <div style="display:flex;flex-wrap:wrap;gap:6px;">
                        <button onclick="presetChem('chlorine')" style="padding:4px 10px;border-radius:4px;border:1px solid #475569;background:#1e293b;color:#94a3b8;font-size:0.7rem;cursor:pointer;">Chlorine (12.5%)</button>
                        <button onclick="presetChem('polymer')" style="padding:4px 10px;border-radius:4px;border:1px solid #475569;background:#1e293b;color:#94a3b8;font-size:0.7rem;cursor:pointer;">Polymer</button>
                        <button onclick="presetChem('alum')" style="padding:4px 10px;border-radius:4px;border:1px solid #475569;background:#1e293b;color:#94a3b8;font-size:0.7rem;cursor:pointer;">Alum</button>
                        <button onclick="presetChem('caustic')" style="padding:4px 10px;border-radius:4px;border:1px solid #475569;background:#1e293b;color:#94a3b8;font-size:0.7rem;cursor:pointer;">Caustic (50%)</button>
                        <button onclick="presetChem('ferric')" style="padding:4px 10px;border-radius:4px;border:1px solid #475569;background:#1e293b;color:#94a3b8;font-size:0.7rem;cursor:pointer;">Ferric Chloride</button>
                        <button onclick="presetChem('bisulfite')" style="padding:4px 10px;border-radius:4px;border:1px solid #475569;background:#1e293b;color:#94a3b8;font-size:0.7rem;cursor:pointer;">Sodium Bisulfite</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- HISTORY PANEL -->
        <div class="chem-panel" id="chem-panel-history" style="display:none;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:8px;">
                <div class="chem-form-title" style="margin:0;">ðŸ“‹ Transaction History</div>
                <div style="display:flex;gap:6px;">
                    <button class="chem-btn chem-btn-secondary" onclick="exportChemHistory()" style="padding:6px 12px;font-size:0.7rem;">ðŸ“¤ Export CSV</button>
                    <button class="chem-btn" onclick="clearChemHistory()" style="padding:6px 12px;font-size:0.7rem;background:#ef4444;color:#fff;">ðŸ—‘ï¸ Clear</button>
                </div>
            </div>
            <div class="chem-history-wrap">
                <table class="chem-history-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Chemical</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Balance</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody id="chemHistoryBody">
                        <tr><td colspan="6" style="text-align:center;color:#64748b;padding:20px;">No transactions yet</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ========== PROCESS CONTROL WIZARDS DASHBOARD ========== -->
    <div class="wizard-dashboard" id="wizardDashboard" data-cat="wizards" style="display:none;">
        <div class="wizard-header">
            <div class="wizard-title">
                ðŸ§™ Process Control Wizards
                <span style="font-size:0.65rem;background:#f59e0b;color:#0f172a;padding:2px 8px;border-radius:10px;font-weight:bold;">TROUBLESHOOT</span>
                <span style="font-size:0.65rem;background:#10b981;color:#fff;padding:2px 8px;border-radius:10px;font-weight:bold;margin-left:4px;">16 WIZARDS</span>
            </div>
            <div style="font-size:0.75rem;color:#94a3b8;">Guided diagnosis & corrective actions for common problems</div>
        </div>

        <!-- Wizard Selection Grid -->
        <div class="wizard-grid">
            <div class="wizard-card" onclick="startWizard('svi')">
                <div class="wizard-icon">ðŸ¦ </div>
                <div class="wizard-name">High SVI / Bulking</div>
                <div class="wizard-desc">Diagnose filamentous bulking, rising sludge, or poor settling</div>
            </div>
            <div class="wizard-card" onclick="startWizard('effluent')">
                <div class="wizard-icon">ðŸ’§</div>
                <div class="wizard-name">Effluent Quality</div>
                <div class="wizard-desc">TSS, BOD, or ammonia violations troubleshooting</div>
            </div>
            <div class="wizard-card" onclick="startWizard('do')">
                <div class="wizard-icon">ðŸ’¨</div>
                <div class="wizard-name">DO Problems</div>
                <div class="wizard-desc">Can't maintain DO, blower issues, aeration troubleshooting</div>
            </div>
            <div class="wizard-card" onclick="startWizard('foam')">
                <div class="wizard-icon">ðŸ«§</div>
                <div class="wizard-name">Foam & Scum</div>
                <div class="wizard-desc">Brown foam, Nocardia, startup foam, grease problems</div>
            </div>
            <div class="wizard-card" onclick="startWizard('clarifier')">
                <div class="wizard-icon">ðŸŒ€</div>
                <div class="wizard-name">Clarifier Issues</div>
                <div class="wizard-desc">Rising sludge, floating solids, blanket depth problems</div>
            </div>
            <div class="wizard-card" onclick="startWizard('nutrients')">
                <div class="wizard-icon">ðŸ§ª</div>
                <div class="wizard-name">Nutrient Removal</div>
                <div class="wizard-desc">Nitrification failure, high ammonia, phosphorus issues</div>
            </div>
            <!-- NEW WIZARDS v9.11 -->
            <div class="wizard-card" onclick="startWizard('ammonia')">
                <div class="wizard-icon">âš—ï¸</div>
                <div class="wizard-name">Ammonia Breakthrough</div>
                <div class="wizard-desc">Sudden ammonia spike, nitrifier washout, permit violations</div>
            </div>
            <div class="wizard-card" onclick="startWizard('odor')">
                <div class="wizard-icon">ðŸ‘ƒ</div>
                <div class="wizard-name">Odor / Hâ‚‚S Control</div>
                <div class="wizard-desc">Rotten egg smell, headworks odor, collection system Hâ‚‚S</div>
            </div>
            <div class="wizard-card" onclick="startWizard('dewatering')">
                <div class="wizard-icon">ðŸ—œï¸</div>
                <div class="wizard-name">Dewatering Problems</div>
                <div class="wizard-desc">Poor cake solids, high polymer use, belt press issues</div>
            </div>
            <div class="wizard-card" onclick="startWizard('digester')">
                <div class="wizard-icon">ðŸ”¥</div>
                <div class="wizard-name">Digester Upset</div>
                <div class="wizard-desc">Low gas, high VFA, pH drop, foaming digesters</div>
            </div>
            <div class="wizard-card" onclick="startWizard('liftstation')">
                <div class="wizard-icon">â¬†ï¸</div>
                <div class="wizard-name">Lift Station Issues</div>
                <div class="wizard-desc">Pump cycling, wet well odor, float problems, alarms</div>
            </div>
            <div class="wizard-card" onclick="startWizard('septicity')">
                <div class="wizard-icon">ðŸ’€</div>
                <div class="wizard-name">Septicity & Corrosion</div>
                <div class="wizard-desc">Black wastewater, crown corrosion, force main issues</div>
            </div>
            <div class="wizard-card" onclick="startWizard('toxicity')">
                <div class="wizard-icon">â˜ ï¸</div>
                <div class="wizard-name">Toxic Shock</div>
                <div class="wizard-desc">Industrial spill, sudden die-off, process upset recovery</div>
            </div>
            <div class="wizard-card" onclick="startWizard('phosphorus')">
                <div class="wizard-icon">ðŸ…¿ï¸</div>
                <div class="wizard-name">Phosphorus Removal</div>
                <div class="wizard-desc">High effluent P, chemical dosing, bio-P failure</div>
            </div>
            <div class="wizard-card" onclick="startWizard('startup')">
                <div class="wizard-icon">ðŸš€</div>
                <div class="wizard-name">Plant Startup</div>
                <div class="wizard-desc">New plant, seasonal restart, seeding, acclimation</div>
            </div>
            <div class="wizard-card" onclick="startWizard('energy')">
                <div class="wizard-icon">âš¡</div>
                <div class="wizard-name">Energy Optimization</div>
                <div class="wizard-desc">High power bills, blower efficiency, pump scheduling</div>
            </div>
        </div>

        <!-- Wizard Content Area -->
        <div id="wizardContent" style="display:none;margin-top:15px;">
            <!-- Dynamic wizard content loads here -->
        </div>
    </div>

    <!-- 1. Pounds Formula -->
    <div class="card open" id="card1" data-calc="pounds">
        <div class="card-header" onclick="toggleCard(1)">
            <h2><span class="card-num">1</span> Pounds Formula</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Convert concentration to mass loading. Use for BOD, TSS, ammonia, phosphorus.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="p_flow" oninput="calcPounds()" placeholder="1.5">
                        <span class="field-hint">Million gallons per day</span>
                    </div>
                    <div>
                        <label>Concentration (mg/L)</label>
                        <input type="number" inputmode="decimal" id="p_conc" oninput="calcPounds()" placeholder="200">
                        <span class="field-hint">Lab result</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="p_res">0.00 lbs/day</span>
                    <div id="p_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('p_res')">Copy Result</button>
                </div>
                <div class="formula-note">Flow Ã— Conc Ã— 8.34</div>
            </div>
        </div>
    </div>

    <!-- 2. SVI -->
    <div class="card" id="card2" data-calc="svi">
        <div class="card-header" onclick="toggleCard(2)">
            <h2><span class="card-num">2</span> SVI â€“ Sludge Volume Index <span class="diagram-badge">DIAGRAM</span></h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Measures sludge settleability. Perform 30-min settleometer test.</div>
                <div class="grid">
                    <div>
                        <label>30-min Settled (mL/L)</label>
                        <input type="number" inputmode="decimal" id="svi_set" oninput="calcSVI()" placeholder="250">
                        <span class="field-hint" id="svi_set_hint">Max 1000 mL/L</span>
                    </div>
                    <div>
                        <label>MLSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="svi_mlss" oninput="calcSVI()" placeholder="2500">
                        <span class="field-hint">From lab</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="svi_res">0.00 mL/g</span>
                    <div id="svi_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('svi_res')">Copy Result</button>
                </div>
                <div class="formula-note">(Settled Vol Ã— 1000) Ã· MLSS</div>
                <button class="diagram-toggle" onclick="toggleDiagram(2,'clarifier')">ðŸ“Š Show Clarifier Process Diagram</button>
            </div>
        </div>
    </div>

    <!-- 3. Mass Balance -->
    <div class="card accent" id="card3" data-calc="mass">
        <div class="card-header" onclick="toggleCard(3)">
            <h2><span class="card-num">3</span> Mass Balance</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Calculate mixed concentration when two flows combine (RAS + Influent, blending).</div>
                <div class="grid">
                    <div>
                        <label>Stream A â€“ Flow</label>
                        <input type="number" inputmode="decimal" id="mb_qa" oninput="calcMB()" placeholder="1.0">
                        <span class="field-hint">Any flow unit</span>
                    </div>
                    <div>
                        <label>Stream A â€“ Conc</label>
                        <input type="number" inputmode="decimal" id="mb_ca" oninput="calcMB()" placeholder="200">
                        <span class="field-hint">mg/L</span>
                    </div>
                    <div>
                        <label>Stream B â€“ Flow</label>
                        <input type="number" inputmode="decimal" id="mb_qb" oninput="calcMB()" placeholder="0.5">
                        <span class="field-hint">Same unit as A</span>
                    </div>
                    <div>
                        <label>Stream B â€“ Conc</label>
                        <input type="number" inputmode="decimal" id="mb_cb" oninput="calcMB()" placeholder="8000">
                        <span class="field-hint">mg/L</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="mb_res">0.00 mg/L</span>
                    <div id="mb_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('mb_res')">Copy Result</button>
                </div>
                <div class="formula-note">(Qâ‚Ã—Câ‚ + Qâ‚‚Ã—Câ‚‚) Ã· (Qâ‚ + Qâ‚‚)</div>
            </div>
        </div>
    </div>

    <!-- 4. F/M Ratio -->
    <div class="card success" id="card4" data-calc="fm">
        <div class="card-header" onclick="toggleCard(4)">
            <h2><span class="card-num">4</span> F/M Ratio <span class="diagram-badge">DIAGRAM</span></h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Food to Microorganism ratio. Key process control parameter.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="fm_flow" oninput="calcFM()" placeholder="1.5">
                        <span class="field-hint">Influent flow</span>
                    </div>
                    <div>
                        <label>BOD (mg/L)</label>
                        <input type="number" inputmode="decimal" id="fm_bod" oninput="calcFM()" placeholder="200">
                        <span class="field-hint">Influent BODâ‚…</span>
                    </div>
                    <div>
                        <label>Aeration Vol (MG)</label>
                        <input type="number" inputmode="decimal" id="fm_vol" oninput="calcFM()" placeholder="0.5">
                        <span class="field-hint">Million gallons</span>
                    </div>
                    <div>
                        <label>MLVSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="fm_mlvss" oninput="calcFM()" placeholder="2000">
                        <span class="field-hint">Or MLSS Ã— 0.75</span>
                    </div>
                </div>
                <div class="example-box"><b>Tip:</b> MLVSS â‰ˆ MLSS Ã— 0.75 if not measured directly</div>
                <div class="result-box">
                    <span class="val" id="fm_res">0.000</span>
                    <div id="fm_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('fm_res')">Copy Result</button>
                </div>
                <div class="formula-note">(Flow Ã— BOD Ã— 8.34) Ã· (Vol Ã— MLVSS Ã— 8.34)</div>
                <button class="diagram-toggle" onclick="toggleDiagram(4,'activated_sludge')">ðŸ“Š Show Activated Sludge Process Diagram</button>
            </div>
        </div>
    </div>

    <!-- 5. SRT -->
    <div class="card success" id="card5" data-calc="srt">
        <div class="card-header" onclick="toggleCard(5)">
            <h2><span class="card-num">5</span> SRT â€“ Sludge Age <span class="diagram-badge">DIAGRAM</span></h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Solids Retention Time. Critical for nitrification (need >8 days).</div>
                <div class="grid">
                    <div>
                        <label>Aeration Vol (MG)</label>
                        <input type="number" inputmode="decimal" id="srt_vol" oninput="calcSRT()" placeholder="0.5">
                        <span class="field-hint">Basin volume</span>
                    </div>
                    <div>
                        <label>MLSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="srt_mlss" oninput="calcSRT()" placeholder="3000">
                        <span class="field-hint">In aeration</span>
                    </div>
                    <div>
                        <label>WAS Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="srt_wasq" oninput="calcSRT()" placeholder="0.015">
                        <span class="field-hint">Waste sludge flow</span>
                    </div>
                    <div>
                        <label>WAS Conc (mg/L)</label>
                        <input type="number" inputmode="decimal" id="srt_wasc" oninput="calcSRT()" placeholder="8000">
                        <span class="field-hint">WAS or RAS conc</span>
                    </div>
                    <div>
                        <label>Effluent Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="srt_effq" oninput="calcSRT()" placeholder="1.5">
                        <span class="field-hint">Discharge flow</span>
                    </div>
                    <div>
                        <label>Effluent TSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="srt_effc" oninput="calcSRT()" placeholder="10">
                        <span class="field-hint">Solids over weirs</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="srt_res">0.0 days</span>
                    <div id="srt_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('srt_res')">Copy Result</button>
                </div>
                <div class="formula-note">Solids in System Ã· Solids Out per Day</div>
                <button class="diagram-toggle" onclick="toggleDiagram(5,'activated_sludge')">ðŸ“Š Show Activated Sludge Process Diagram</button>
            </div>
        </div>
    </div>

    <!-- 6. Detention Time -->
    <div class="card success" id="card6" data-calc="dt">
        <div class="card-header" onclick="toggleCard(6)">
            <h2><span class="card-num">6</span> Detention Time</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Hydraulic retention time in any tank or process.</div>
                <div class="grid">
                    <div>
                        <label>Volume (gallons)</label>
                        <input type="number" inputmode="decimal" id="dt_vol" oninput="calcDT()" placeholder="500000">
                        <span class="field-hint">Tank volume</span>
                    </div>
                    <div>
                        <label>Flow (GPD)</label>
                        <input type="number" inputmode="decimal" id="dt_flow" oninput="calcDT()" placeholder="1500000">
                        <span class="field-hint">Gallons per day</span>
                    </div>
                </div>
                <div class="example-box"><b>Volume:</b> Rect = LÃ—WÃ—DÃ—7.48 | Circ = 0.785Ã—DÂ²Ã—HÃ—7.48</div>
                <div class="result-box">
                    <span class="val" id="dt_res">0.00 hours</span>
                    <div id="dt_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('dt_res')">Copy Result</button>
                </div>
                <div class="formula-note">(Volume Ã· Flow) Ã— 24</div>
            </div>
        </div>
    </div>

    <!-- 7. Removal Efficiency -->
    <div class="card success" id="card7" data-calc="eff">
        <div class="card-header" onclick="toggleCard(7)">
            <h2><span class="card-num">7</span> Removal Efficiency</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Percent removal for BOD, TSS, ammonia, or any parameter.</div>
                <div class="grid">
                    <div>
                        <label>Influent (mg/L)</label>
                        <input type="number" inputmode="decimal" id="eff_in" oninput="calcEff()" placeholder="200">
                        <span class="field-hint">Before treatment</span>
                    </div>
                    <div>
                        <label>Effluent (mg/L)</label>
                        <input type="number" inputmode="decimal" id="eff_out" oninput="calcEff()" placeholder="15">
                        <span class="field-hint">After treatment</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="eff_res">0.0 %</span>
                    <div id="eff_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('eff_res')">Copy Result</button>
                </div>
                <div class="formula-note">(In - Out) Ã· In Ã— 100</div>
            </div>
        </div>
    </div>

    <!-- 8. WAS Pumping Rate -->
    <div class="card" id="card8" data-calc="was">
        <div class="card-header" onclick="toggleCard(8)">
            <h2><span class="card-num">8</span> WAS Pumping Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Calculate required WAS flow to achieve target SRT. Solve for wasting rate.</div>
                <div class="grid">
                    <div>
                        <label>Aeration Vol (MG)</label>
                        <input type="number" inputmode="decimal" id="was_vol" oninput="calcWAS()" placeholder="0.5">
                        <span class="field-hint">Basin volume</span>
                    </div>
                    <div>
                        <label>MLSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="was_mlss" oninput="calcWAS()" placeholder="3000">
                        <span class="field-hint">In aeration</span>
                    </div>
                    <div>
                        <label>Target SRT (days)</label>
                        <input type="number" inputmode="decimal" id="was_srt" oninput="calcWAS()" placeholder="10">
                        <span class="field-hint">Desired sludge age</span>
                    </div>
                    <div>
                        <label>WAS Conc (mg/L)</label>
                        <input type="number" inputmode="decimal" id="was_conc" oninput="calcWAS()" placeholder="8000">
                        <span class="field-hint">WAS/RAS solids</span>
                    </div>
                </div>
                <div class="example-box"><b>Note:</b> This simplified calc ignores effluent TSS loss. For precise SRT, account for solids over weirs.</div>
                <div class="result-box">
                    <span class="val" id="was_res">0 GPD</span>
                    <div id="was_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('was_res')">Copy Result</button>
                </div>
                <div class="formula-note">WAS Flow = (Vol Ã— MLSS) Ã· (SRT Ã— WAS Conc)</div>
            </div>
        </div>
    </div>

    <!-- 9. RAS Return Rate -->
    <div class="card" id="card9" data-calc="ras">
        <div class="card-header" onclick="toggleCard(9)">
            <h2><span class="card-num">9</span> RAS Return Rate <span class="diagram-badge">DIAGRAM</span></h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Calculate RAS flow rate based on sludge blanket or settleability method.</div>
                <div class="grid">
                    <div>
                        <label>Influent Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="ras_flow" oninput="calcRAS()" placeholder="1.5">
                        <span class="field-hint">Plant flow</span>
                    </div>
                    <div>
                        <label>MLSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="ras_mlss" oninput="calcRAS()" placeholder="3000">
                        <span class="field-hint">In aeration</span>
                    </div>
                    <div>
                        <label>RAS Conc (mg/L)</label>
                        <input type="number" inputmode="decimal" id="ras_conc" oninput="calcRAS()" placeholder="8000">
                        <span class="field-hint">Return sludge TSS</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="ras_res">0.00 MGD</span>
                    <div id="ras_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('ras_res')">Copy Result</button>
                </div>
                <div class="formula-note">RAS = (Q Ã— MLSS) Ã· (RAS Conc - MLSS)</div>
                <button class="diagram-toggle" onclick="toggleDiagram(9,'clarifier')">ðŸ“Š Show Clarifier Process Diagram</button>
            </div>
        </div>
    </div>

    <!-- 10. Organic Loading Rate -->
    <div class="card accent" id="card10" data-calc="olr">
        <div class="card-header" onclick="toggleCard(10)">
            <h2><span class="card-num">10</span> Organic Loading Rate <span class="diagram-badge">DIAGRAM</span></h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">BOD loading per unit volume. Used for trickling filters, RBCs, and aeration basins.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="olr_flow" oninput="calcOLR()" placeholder="1.5">
                        <span class="field-hint">Influent flow</span>
                    </div>
                    <div>
                        <label>BOD (mg/L)</label>
                        <input type="number" inputmode="decimal" id="olr_bod" oninput="calcOLR()" placeholder="200">
                        <span class="field-hint">Influent BOD</span>
                    </div>
                    <div>
                        <label>Volume (1000 ftÂ³)</label>
                        <input type="number" inputmode="decimal" id="olr_vol" oninput="calcOLR()" placeholder="50">
                        <span class="field-hint">Media or basin volume</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="olr_res">0.0 lbs/day/1000ftÂ³</span>
                    <div id="olr_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('olr_res')">Copy Result</button>
                </div>
                <div class="formula-note">(Flow Ã— BOD Ã— 8.34) Ã· Volume in 1000 ftÂ³</div>
                <button class="diagram-toggle" onclick="toggleDiagram(10,'oxidation_ditch')">ðŸ“Š Show Oxidation Ditch Diagram</button>
            </div>
        </div>
    </div>

    <!-- 11. Surface Overflow Rate -->
    <div class="card accent" id="card11" data-calc="sor">
        <div class="card-header" onclick="toggleCard(11)">
            <h2><span class="card-num">11</span> Surface Overflow Rate <span class="diagram-badge">DIAGRAM</span></h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Hydraulic loading rate for clarifiers. Flow per unit surface area.</div>
                <div class="grid">
                    <div>
                        <label>Flow (GPD)</label>
                        <input type="number" inputmode="decimal" id="sor_flow" oninput="calcSOR()" placeholder="1500000">
                        <span class="field-hint">Gallons per day</span>
                    </div>
                    <div>
                        <label>Surface Area (ftÂ²)</label>
                        <input type="number" inputmode="decimal" id="sor_area" oninput="calcSOR()" placeholder="3000">
                        <span class="field-hint">Clarifier surface area</span>
                    </div>
                </div>
                <div class="example-box"><b>Circular:</b> Area = 0.785 Ã— DÂ² | <b>Rectangular:</b> Area = L Ã— W</div>
                <div class="result-box">
                    <span class="val" id="sor_res">0 GPD/ftÂ²</span>
                    <div id="sor_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('sor_res')">Copy Result</button>
                </div>
                <div class="formula-note">Flow (GPD) Ã· Surface Area (ftÂ²)</div>
                <button class="diagram-toggle" onclick="toggleDiagram(11,'clarifier')">ðŸ“Š Show Clarifier Process Diagram</button>
            </div>
        </div>
    </div>

    <!-- 12. Weir Overflow Rate -->
    <div class="card accent" id="card12" data-calc="wor">
        <div class="card-header" onclick="toggleCard(12)">
            <h2><span class="card-num">12</span> Weir Overflow Rate <span class="diagram-badge">DIAGRAM</span></h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Flow per linear foot of weir. Important for clarifier performance.</div>
                <div class="grid">
                    <div>
                        <label>Flow (GPD)</label>
                        <input type="number" inputmode="decimal" id="wor_flow" oninput="calcWOR()" placeholder="1500000">
                        <span class="field-hint">Gallons per day</span>
                    </div>
                    <div>
                        <label>Weir Length (ft)</label>
                        <input type="number" inputmode="decimal" id="wor_len" oninput="calcWOR()" placeholder="150">
                        <span class="field-hint">Total weir length</span>
                    </div>
                </div>
                <div class="example-box"><b>Circular weir:</b> Length = Ï€ Ã— Diameter (3.14 Ã— D)</div>
                <div class="result-box">
                    <span class="val" id="wor_res">0 GPD/ft</span>
                    <div id="wor_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('wor_res')">Copy Result</button>
                </div>
                <div class="formula-note">Flow (GPD) Ã· Weir Length (ft)</div>
                <button class="diagram-toggle" onclick="toggleDiagram(12,'clarifier')">ðŸ“Š Show Clarifier Process Diagram</button>
            </div>
        </div>
    </div>

    <!-- 13. Solids Loading Rate -->
    <div class="card success" id="card13" data-calc="slr">
        <div class="card-header" onclick="toggleCard(13)">
            <h2><span class="card-num">13</span> Solids Loading Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Solids applied per unit clarifier area. Key for secondary clarifier design.</div>
                <div class="grid">
                    <div>
                        <label>Influent + RAS Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="slr_flow" oninput="calcSLR()" placeholder="2.0">
                        <span class="field-hint">Total flow to clarifier</span>
                    </div>
                    <div>
                        <label>MLSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="slr_mlss" oninput="calcSLR()" placeholder="3000">
                        <span class="field-hint">Mixed liquor solids</span>
                    </div>
                    <div>
                        <label>Surface Area (ftÂ²)</label>
                        <input type="number" inputmode="decimal" id="slr_area" oninput="calcSLR()" placeholder="3000">
                        <span class="field-hint">Clarifier area</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="slr_res">0.0 lbs/day/ftÂ²</span>
                    <div id="slr_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('slr_res')">Copy Result</button>
                </div>
                <div class="formula-note">(Flow Ã— MLSS Ã— 8.34) Ã· Surface Area</div>
            </div>
        </div>
    </div>

    <!-- 14. Chemical Dosing -->
    <div class="card success" id="card14" data-calc="chem">
        <div class="card-header" onclick="toggleCard(14)">
            <h2><span class="card-num">14</span> Chemical Dosing</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Calculate chemical feed rate. Works for chlorine, alum, polymer, lime, etc.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="chem_flow" oninput="calcChem()" placeholder="1.5">
                        <span class="field-hint">Treatment flow</span>
                    </div>
                    <div>
                        <label>Dose (mg/L)</label>
                        <input type="number" inputmode="decimal" id="chem_dose" oninput="calcChem()" placeholder="2.0">
                        <span class="field-hint">Target dosage</span>
                    </div>
                    <div>
                        <label>Chemical % Purity</label>
                        <input type="number" inputmode="decimal" id="chem_purity" oninput="calcChem()" placeholder="100">
                        <span class="field-hint">65% for HTH, 12% for bleach</span>
                    </div>
                </div>
                <div class="example-box"><b>Common:</b> Gas Clâ‚‚ = 100% | HTH = 65% | Bleach = 12% | Alum = 48%</div>
                <div class="result-box">
                    <span class="val" id="chem_res">0.00 lbs/day</span>
                    <div id="chem_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('chem_res')">Copy Result</button>
                </div>
                <div class="formula-note">(Flow Ã— Dose Ã— 8.34) Ã· (Purity Ã· 100)</div>
            </div>
        </div>
    </div>

    <!-- ========== MBR SECTION ========== -->
    <div class="section-header" data-cat="mbr" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(139, 92, 246, 0.15); border-radius: 8px; border-left: 4px solid #8b5cf6; font-size: 0.85rem; color: #a78bfa; font-weight: bold;">ðŸ”¬ MBR â€“ Membrane Bioreactor Calculators</div>

    <!-- 15. Membrane Flux Rate -->
    <div class="card" id="card15" data-calc="flux" style="border-left-color: #8b5cf6;">
        <div class="card-header" onclick="toggleCard(15)">
            <h2><span class="card-num" style="background: #8b5cf6;">15</span> Membrane Flux Rate <span class="diagram-badge">DIAGRAM</span></h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #8b5cf6;">Calculate permeate flux through the membrane. Primary MBR performance indicator â€” check daily to detect fouling trends.</div>
                <div class="grid">
                    <div>
                        <label>Permeate Flow (GPD)</label>
                        <input type="number" inputmode="decimal" id="flux_flow" oninput="calcFlux()" placeholder="500000">
                        <span class="field-hint">Gallons per day through membranes</span>
                    </div>
                    <div>
                        <label>Membrane Area (ftÂ²)</label>
                        <input type="number" inputmode="decimal" id="flux_area" oninput="calcFlux()" placeholder="50000">
                        <span class="field-hint">Total active membrane area</span>
                    </div>
                </div>
                <div class="example-box"><b>Typical MBR Flux:</b> 10â€“15 GFD (avg) | 20â€“25 GFD (peak) | &lt;8 GFD = likely fouled | &gt;25 GFD = risk of damage</div>
                <div class="result-box">
                    <span class="val" id="flux_res">0.0 GFD</span>
                    <div id="flux_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('flux_res')">Copy Result</button>
                </div>
                <div class="formula-note">Flux (GFD) = Permeate Flow (GPD) Ã· Membrane Area (ftÂ²)</div>
                <button class="diagram-toggle" onclick="toggleDiagram(15,'mbr')">ðŸ“Š Show MBR Process Diagram</button>
            </div>
        </div>
    </div>

    <!-- 16. Transmembrane Pressure -->
    <div class="card" id="card16" data-calc="tmp" style="border-left-color: #8b5cf6;">
        <div class="card-header" onclick="toggleCard(16)">
            <h2><span class="card-num" style="background: #8b5cf6;">16</span> Transmembrane Pressure</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #8b5cf6;">Calculate pressure driving permeate through the membrane. TMP trending is the #1 fouling indicator and triggers CIP decisions.</div>
                <div class="grid">
                    <div>
                        <label>Feed Pressure (psi)</label>
                        <input type="number" inputmode="decimal" id="tmp_feed" oninput="calcTMP()" placeholder="6.0">
                        <span class="field-hint">Upstream of membrane</span>
                    </div>
                    <div>
                        <label>Permeate Pressure (psi)</label>
                        <input type="number" inputmode="decimal" id="tmp_perm" oninput="calcTMP()" placeholder="1.0">
                        <span class="field-hint">Downstream (often ~0 or vacuum)</span>
                    </div>
                </div>
                <div class="example-box"><b>Typical MBR TMP:</b> 1â€“7 psi (normal) | 7â€“12 psi (fouling) | >12 psi = CIP required | Submerged membranes often read in kPa (1 psi = 6.895 kPa)</div>
                <div class="result-box">
                    <span class="val" id="tmp_res">0.0 psi</span>
                    <div id="tmp_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('tmp_res')">Copy Result</button>
                </div>
                <div class="formula-note">TMP = Feed Pressure âˆ’ Permeate Pressure</div>
            </div>
        </div>
    </div>

    <!-- 17. Membrane Permeability -->
    <div class="card" id="card17" data-calc="perm" style="border-left-color: #8b5cf6;">
        <div class="card-header" onclick="toggleCard(17)">
            <h2><span class="card-num" style="background: #8b5cf6;">17</span> Membrane Permeability</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #8b5cf6;">Normalizes flux per unit of driving pressure. Detects fouling even when flux appears stable â€” declining permeability confirms membrane fouling.</div>
                <div class="grid">
                    <div>
                        <label>Flux (GFD)</label>
                        <input type="number" inputmode="decimal" id="perm_flux" oninput="calcPerm()" placeholder="12.0">
                        <span class="field-hint">From Flux calculator or known</span>
                    </div>
                    <div>
                        <label>TMP (psi)</label>
                        <input type="number" inputmode="decimal" id="perm_tmp" oninput="calcPerm()" placeholder="5.0">
                        <span class="field-hint">From TMP calculator or gauge</span>
                    </div>
                </div>
                <div class="example-box"><b>Typical Permeability:</b> 3â€“6 GFD/psi (good) | 1.5â€“3 GFD/psi (fouling) | &lt;1.5 GFD/psi = CIP needed | New membranes: 5â€“8+ GFD/psi</div>
                <div class="result-box">
                    <span class="val" id="perm_res">0.0 GFD/psi</span>
                    <div id="perm_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('perm_res')">Copy Result</button>
                </div>
                <div class="formula-note">Permeability = Flux (GFD) Ã· TMP (psi)</div>
            </div>
        </div>
    </div>

    <!-- 18. Membrane Area Sizing -->
    <div class="card" id="card18" data-calc="msize" style="border-left-color: #8b5cf6;">
        <div class="card-header" onclick="toggleCard(18)">
            <h2><span class="card-num" style="background: #8b5cf6;">18</span> Membrane Area Sizing</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #8b5cf6;">Calculate total membrane area needed for design flow. Essential for MBR retrofits, expansions, and new system evaluations.</div>
                <div class="grid">
                    <div>
                        <label>Design Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="msize_flow" oninput="calcMSize()" placeholder="1.5">
                        <span class="field-hint">Average day permitted flow</span>
                    </div>
                    <div>
                        <label>Peak Hour Factor</label>
                        <input type="number" inputmode="decimal" id="msize_pf" oninput="calcMSize()" placeholder="2.0">
                        <span class="field-hint">Typical: 1.5â€“3.0Ã—</span>
                    </div>
                    <div>
                        <label>Target Avg Flux (GFD)</label>
                        <input type="number" inputmode="decimal" id="msize_flux" oninput="calcMSize()" placeholder="12">
                        <span class="field-hint">Design: 10â€“14 GFD avg</span>
                    </div>
                    <div>
                        <label>Peak Flux (GFD)</label>
                        <input type="number" inputmode="decimal" id="msize_peak" oninput="calcMSize()" placeholder="20">
                        <span class="field-hint">Peak: 18â€“25 GFD</span>
                    </div>
                </div>
                <div class="example-box"><b>Rule of thumb:</b> Design to avg flux for daily operation. Verify peak flux â‰¤ 25 GFD. Larger area = lower flux = longer membrane life.</div>
                <div class="result-box">
                    <span class="val" id="msize_res">0 ftÂ²</span>
                    <div id="msize_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('msize_res')">Copy Result</button>
                </div>
                <div class="formula-note">Area = Design Flow (GPD) Ã· Target Flux (GFD) â€” checked against peak</div>
            </div>
        </div>
    </div>

    <!-- 19. Specific Aeration Demand -->
    <div class="card" id="card19" data-calc="sad" style="border-left-color: #8b5cf6;">
        <div class="card-header" onclick="toggleCard(19)">
            <h2><span class="card-num" style="background: #8b5cf6;">19</span> Specific Aeration Demand</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #8b5cf6;">Calculate membrane air scouring efficiency. SADm = air per membrane area. SADp = air per permeate volume. Membrane aeration is 30â€“50% of MBR energy cost.</div>
                <div class="grid">
                    <div>
                        <label>Air Flow (NmÂ³/hr)</label>
                        <input type="number" inputmode="decimal" id="sad_air" oninput="calcSAD()" placeholder="500">
                        <span class="field-hint">Coarse bubble to membranes</span>
                    </div>
                    <div>
                        <label>Membrane Area (mÂ²)</label>
                        <input type="number" inputmode="decimal" id="sad_area" oninput="calcSAD()" placeholder="5000">
                        <span class="field-hint">Total active area</span>
                    </div>
                    <div>
                        <label>Permeate Flow (mÂ³/hr)</label>
                        <input type="number" inputmode="decimal" id="sad_perm" oninput="calcSAD()" placeholder="100">
                        <span class="field-hint">Permeate production rate</span>
                    </div>
                </div>
                <div class="example-box"><b>Targets:</b> SADm = 0.2â€“0.5 NmÂ³/mÂ²/hr (flat sheet: 0.5â€“1.0) | SADp = 10â€“25 mÂ³air/mÂ³permeate | Lower = more efficient</div>
                <div class="result-box">
                    <span class="val" id="sad_res">â€”</span>
                    <div id="sad_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('sad_res')">Copy Result</button>
                </div>
                <div class="formula-note">SADm = Air Flow Ã· Membrane Area | SADp = Air Flow Ã· Permeate Flow</div>
            </div>
        </div>
    </div>

    <!-- 20. MBR Operating Range Check -->
    <div class="card" id="card20" data-calc="mbrcheck" style="border-left-color: #8b5cf6;">
        <div class="card-header" onclick="toggleCard(20)">
            <h2><span class="card-num" style="background: #8b5cf6;">20</span> MBR Operating Range Check</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #8b5cf6;">Verify MLSS, SRT, F:M, and DO are within MBR-appropriate ranges. MBR operates at drastically different setpoints than conventional activated sludge.</div>
                <div class="grid">
                    <div>
                        <label>MLSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="mbrc_mlss" oninput="calcMBRC()" placeholder="10000">
                        <span class="field-hint">MBR typical: 8,000â€“12,000</span>
                    </div>
                    <div>
                        <label>SRT (days)</label>
                        <input type="number" inputmode="decimal" id="mbrc_srt" oninput="calcMBRC()" placeholder="20">
                        <span class="field-hint">MBR typical: 15â€“40 days</span>
                    </div>
                    <div>
                        <label>F:M Ratio</label>
                        <input type="number" inputmode="decimal" id="mbrc_fm" oninput="calcMBRC()" placeholder="0.08">
                        <span class="field-hint">MBR typical: 0.05â€“0.15</span>
                    </div>
                    <div>
                        <label>DO (mg/L)</label>
                        <input type="number" inputmode="decimal" id="mbrc_do" oninput="calcMBRC()" placeholder="2.0">
                        <span class="field-hint">MBR typical: 1.0â€“3.0</span>
                    </div>
                </div>
                <div class="example-box"><b>CAS vs MBR:</b> CAS MLSS 1,500â€“4,000 â†’ MBR 8,000â€“12,000 | CAS SRT 5â€“15 d â†’ MBR 15â€“40 d | CAS F:M 0.2â€“0.5 â†’ MBR 0.05â€“0.15</div>
                <div class="result-box">
                    <span class="val" id="mbrc_res">â€”</span>
                    <div id="mbrc_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('mbrc_res')">Copy Result</button>
                </div>
                <div class="formula-note">Compares inputs against MBR-specific operating ranges</div>
            </div>
        </div>
    </div>

    <!-- 21. CIP Chemical Dosing -->
    <div class="card" id="card21" data-calc="cip" style="border-left-color: #8b5cf6;">
        <div class="card-header" onclick="toggleCard(21)">
            <h2><span class="card-num" style="background: #8b5cf6;">21</span> CIP Chemical Dosing</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #8b5cf6;">Calculate sodium hypochlorite (NaOCl) and citric acid volumes for membrane maintenance and recovery cleans. Wrong dosing can damage membranes.</div>
                <div class="grid">
                    <div>
                        <label>CIP Tank Volume (gal)</label>
                        <input type="number" inputmode="decimal" id="cip_vol" oninput="calcCIP()" placeholder="500">
                        <span class="field-hint">Membrane train clean volume</span>
                    </div>
                    <div>
                        <label>Target NaOCl (mg/L)</label>
                        <input type="number" inputmode="decimal" id="cip_nacl" oninput="calcCIP()" placeholder="1000">
                        <span class="field-hint">Maint: 200â€“500 | Recovery: 1000â€“2000</span>
                    </div>
                    <div>
                        <label>Bleach Strength (%)</label>
                        <input type="number" inputmode="decimal" id="cip_bleach" oninput="calcCIP()" placeholder="12.5">
                        <span class="field-hint">Typical: 12.5% (trade) or 10%</span>
                    </div>
                    <div>
                        <label>Target Citric Acid (mg/L)</label>
                        <input type="number" inputmode="decimal" id="cip_citric" oninput="calcCIP()" placeholder="2000">
                        <span class="field-hint">Maint: 1000â€“2000 | Recovery: 2000â€“5000</span>
                    </div>
                    <div>
                        <label>Citric Acid Strength (%)</label>
                        <input type="number" inputmode="decimal" id="cip_cstr" oninput="calcCIP()" placeholder="50">
                        <span class="field-hint">Powder dissolved: 50% typical</span>
                    </div>
                </div>
                <div class="example-box"><b>CIP Schedule:</b> Maintenance clean (MC): weeklyâ€“biweekly | Recovery clean (RC): monthlyâ€“quarterly | Always NaOCl first, then citric acid. Never mix!</div>
                <div class="result-box">
                    <span class="val" id="cip_res">â€”</span>
                    <div id="cip_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('cip_res')">Copy Result</button>
                </div>
                <div class="formula-note">Volume = (Tank Vol Ã— Target Conc) Ã· (Solution Strength Ã— 10,000)</div>
            </div>
        </div>
    </div>

    <!-- ========== MBBR SECTION ========== -->
    <div class="section-header" data-cat="mbbr" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(6, 182, 212, 0.15); border-radius: 8px; border-left: 4px solid #06b6d4; font-size: 0.85rem; color: #22d3ee; font-weight: bold;">ðŸ§¬ MBBR â€“ Moving Bed Biofilm Reactor Calculators</div>

    <!-- 22. Surface Area Loading Rate -->
    <div class="card" id="card22" data-calc="salr" style="border-left-color: #06b6d4;">
        <div class="card-header" onclick="toggleCard(22)">
            <h2><span class="card-num" style="background: #06b6d4;">22</span> Surface Area Loading Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #06b6d4;">The fundamental MBBR design parameter â€” equivalent of F:M for suspended growth. Calculates organic or nitrogen load applied per unit of biofilm surface area.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="salr_flow" oninput="calcSALR()" placeholder="1.5">
                        <span class="field-hint">Influent flow to MBBR</span>
                    </div>
                    <div>
                        <label>Concentration (mg/L)</label>
                        <input type="number" inputmode="decimal" id="salr_conc" oninput="calcSALR()" placeholder="150">
                        <span class="field-hint">BODâ‚… or NHâ‚ƒ-N</span>
                    </div>
                    <div>
                        <label>Biofilm Area (mÂ²)</label>
                        <input type="number" inputmode="decimal" id="salr_area" oninput="calcSALR()" placeholder="50000">
                        <span class="field-hint">Total protected surface area</span>
                    </div>
                </div>
                <div class="example-box"><b>SALR Targets:</b> BOD removal: 5â€“20 g/mÂ²/d | Nitrification: 0.5â€“1.5 g NHâ‚ƒ-N/mÂ²/d | Pre-denitrification: 1â€“3 g NOâ‚ƒ-N/mÂ²/d</div>
                <div class="result-box">
                    <span class="val" id="salr_res">0.0 g/mÂ²/d</span>
                    <div id="salr_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('salr_res')">Copy Result</button>
                </div>
                <div class="formula-note">SALR = (Flow Ã— Conc Ã— 3.785) Ã· Biofilm Area (g/mÂ²/day)</div>
            </div>
        </div>
    </div>

    <!-- 23. Effective Biofilm Area -->
    <div class="card" id="card23" data-calc="bioarea" style="border-left-color: #06b6d4;">
        <div class="card-header" onclick="toggleCard(23)">
            <h2><span class="card-num" style="background: #06b6d4;">23</span> Effective Biofilm Area</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #06b6d4;">Calculate total protected biofilm surface area from reactor volume, media fill fraction, and carrier specific surface area. Needed to verify actual loading rates.</div>
                <div class="grid">
                    <div>
                        <label>Reactor Volume (ftÂ³)</label>
                        <input type="number" inputmode="decimal" id="bio_vol" oninput="calcBioArea()" placeholder="10000">
                        <span class="field-hint">Liquid volume of MBBR zone</span>
                    </div>
                    <div>
                        <label>Fill Fraction (%)</label>
                        <input type="number" inputmode="decimal" id="bio_fill" oninput="calcBioArea()" placeholder="50">
                        <span class="field-hint">Typical: 40â€“67%</span>
                    </div>
                    <div>
                        <label>Specific Surface Area (mÂ²/mÂ³)</label>
                        <input type="number" inputmode="decimal" id="bio_ssa" oninput="calcBioArea()" placeholder="500">
                        <span class="field-hint">From media spec sheet</span>
                    </div>
                </div>
                <div class="example-box"><b>Common Media SSA:</b> K1 Kaldnes = 500 mÂ²/mÂ³ | K3 = 500 | K5 = 800 | AnoxKaldnesâ„¢ BiofilmChipâ„¢ = 900+ | Typical fill: 50â€“60%</div>
                <div class="result-box">
                    <span class="val" id="bio_res">0 mÂ²</span>
                    <div id="bio_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('bio_res')">Copy Result</button>
                </div>
                <div class="formula-note">Area = Reactor Vol (mÂ³) Ã— Fill% Ã— Specific Surface Area (mÂ²/mÂ³)</div>
            </div>
        </div>
    </div>

    <!-- 24. Media Fill Volume -->
    <div class="card" id="card24" data-calc="mediavol" style="border-left-color: #06b6d4;">
        <div class="card-header" onclick="toggleCard(24)">
            <h2><span class="card-num" style="background: #06b6d4;">24</span> Media Fill Volume</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #06b6d4;">Calculate required carrier media volume from target SALR, influent load, and media specific surface area. Critical for sizing new MBBR systems or expansions.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="mv_flow" oninput="calcMediaVol()" placeholder="1.5">
                        <span class="field-hint">Influent flow</span>
                    </div>
                    <div>
                        <label>Concentration (mg/L)</label>
                        <input type="number" inputmode="decimal" id="mv_conc" oninput="calcMediaVol()" placeholder="150">
                        <span class="field-hint">BODâ‚… or NHâ‚ƒ-N</span>
                    </div>
                    <div>
                        <label>Target SALR (g/mÂ²/d)</label>
                        <input type="number" inputmode="decimal" id="mv_salr" oninput="calcMediaVol()" placeholder="10">
                        <span class="field-hint">BOD: 5â€“20 | NHâ‚ƒ: 0.5â€“1.5</span>
                    </div>
                    <div>
                        <label>Media SSA (mÂ²/mÂ³)</label>
                        <input type="number" inputmode="decimal" id="mv_ssa" oninput="calcMediaVol()" placeholder="500">
                        <span class="field-hint">From spec sheet</span>
                    </div>
                </div>
                <div class="example-box"><b>Sizing Logic:</b> Required area = Load Ã· SALR â†’ Media volume = Area Ã· SSA â†’ Check fill fraction stays 40â€“67%</div>
                <div class="result-box">
                    <span class="val" id="mv_res">0 mÂ³</span>
                    <div id="mv_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('mv_res')">Copy Result</button>
                </div>
                <div class="formula-note">Media Vol = (Flow Ã— Conc Ã— 3.785) Ã· (Target SALR Ã— SSA)</div>
            </div>
        </div>
    </div>

    <!-- 25. MBBR Reactor Sizing -->
    <div class="card" id="card25" data-calc="mbbrsz" style="border-left-color: #06b6d4;">
        <div class="card-header" onclick="toggleCard(25)">
            <h2><span class="card-num" style="background: #06b6d4;">25</span> MBBR Reactor Sizing</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #06b6d4;">Calculate required reactor volume from media volume and fill fraction. Verifies HRT and ensures adequate empty-bed volume for proper media circulation.</div>
                <div class="grid">
                    <div>
                        <label>Media Volume (mÂ³)</label>
                        <input type="number" inputmode="decimal" id="rsz_media" oninput="calcRSZ()" placeholder="150">
                        <span class="field-hint">From Media Fill calc or known</span>
                    </div>
                    <div>
                        <label>Fill Fraction (%)</label>
                        <input type="number" inputmode="decimal" id="rsz_fill" oninput="calcRSZ()" placeholder="55">
                        <span class="field-hint">Target: 40â€“67% max</span>
                    </div>
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="rsz_flow" oninput="calcRSZ()" placeholder="1.5">
                        <span class="field-hint">For HRT calculation</span>
                    </div>
                </div>
                <div class="example-box"><b>Design Notes:</b> Max fill 67% â€” above this media cannot circulate. Typical HRT: 1â€“3 hrs BOD removal | 3â€“6 hrs nitrification. Provide adequate mixing energy.</div>
                <div class="result-box">
                    <span class="val" id="rsz_res">0 mÂ³</span>
                    <div id="rsz_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('rsz_res')">Copy Result</button>
                </div>
                <div class="formula-note">Reactor Vol = Media Vol Ã· (Fill% Ã· 100)</div>
            </div>
        </div>
    </div>

    <!-- 26. MBBR Dissolved Oxygen Demand -->
    <div class="card" id="card26" data-calc="mbbrdo" style="border-left-color: #06b6d4;">
        <div class="card-header" onclick="toggleCard(26)">
            <h2><span class="card-num" style="background: #06b6d4;">26</span> MBBR Oxygen Demand</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #06b6d4;">Calculate Oâ‚‚ transfer needed for BOD removal and nitrification in MBBR. Biofilm systems need higher DO (4â€“6 mg/L) than CAS (~2 mg/L) due to boundary layer diffusion.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="mdo_flow" oninput="calcMDO()" placeholder="1.5">
                        <span class="field-hint">Influent flow</span>
                    </div>
                    <div>
                        <label>BOD Removed (mg/L)</label>
                        <input type="number" inputmode="decimal" id="mdo_bod" oninput="calcMDO()" placeholder="130">
                        <span class="field-hint">Influent â€“ Effluent BOD</span>
                    </div>
                    <div>
                        <label>NHâ‚ƒ-N Removed (mg/L)</label>
                        <input type="number" inputmode="decimal" id="mdo_nh3" oninput="calcMDO()" placeholder="20">
                        <span class="field-hint">0 if no nitrification</span>
                    </div>
                </div>
                <div class="example-box"><b>Oâ‚‚ Factors:</b> ~1.5 lb Oâ‚‚/lb BOD removed | ~4.6 lb Oâ‚‚/lb NHâ‚ƒ-N oxidized | MBBR target DO: 4â€“6 mg/L (vs CAS 1.5â€“2.5 mg/L)</div>
                <div class="result-box">
                    <span class="val" id="mdo_res">0 lbs Oâ‚‚/day</span>
                    <div id="mdo_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('mdo_res')">Copy Result</button>
                </div>
                <div class="formula-note">Oâ‚‚ = (Flow Ã— Î”BOD Ã— 8.34 Ã— 1.5) + (Flow Ã— Î”NHâ‚ƒ Ã— 8.34 Ã— 4.6)</div>
            </div>
        </div>
    </div>

    <!-- 27. MBBR vs CAS Comparison -->
    <div class="card" id="card27" data-calc="mbbrcas" style="border-left-color: #06b6d4;">
        <div class="card-header" onclick="toggleCard(27)">
            <h2><span class="card-num" style="background: #06b6d4;">27</span> MBBR vs CAS Comparison</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #06b6d4;">Side-by-side comparison of MBBR vs conventional activated sludge for the same flow and load. Useful for technology selection and consulting evaluations.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="cmp_flow" oninput="calcCMP()" placeholder="1.5">
                        <span class="field-hint">Design flow</span>
                    </div>
                    <div>
                        <label>Influent BOD (mg/L)</label>
                        <input type="number" inputmode="decimal" id="cmp_bod" oninput="calcCMP()" placeholder="200">
                        <span class="field-hint">Raw or primary effluent BOD</span>
                    </div>
                </div>
                <div class="example-box"><b>Comparison basis:</b> CAS: F:M=0.3, MLSS=3000, SRT=10d | MBBR: SALR=10 g/mÂ²/d, K3 media 500 mÂ²/mÂ³, 55% fill</div>
                <div class="result-box">
                    <span class="val" id="cmp_res">â€”</span>
                    <div id="cmp_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('cmp_res')">Copy Result</button>
                </div>
                <div class="formula-note">CAS Vol = (Flow Ã— BOD Ã— 8.34) Ã· (F:M Ã— MLSS) | MBBR Vol = Media Ã· Fill%</div>
            </div>
        </div>
    </div>

    <!-- ========== SBR SECTION ========== -->
    <div class="section-header" data-cat="sbr" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(244, 63, 94, 0.15); border-radius: 8px; border-left: 4px solid #f43f5e; font-size: 0.85rem; color: #fb7185; font-weight: bold;">â±ï¸ SBR â€“ Sequencing Batch Reactor Calculators</div>

    <!-- 28. SBR Cycle Time -->
    <div class="card" id="card28" data-calc="sbrcycle" style="border-left-color: #f43f5e;">
        <div class="card-header" onclick="toggleCard(28)">
            <h2><span class="card-num" style="background: #f43f5e;">28</span> SBR Cycle Time <span class="diagram-badge">DIAGRAM</span></h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #f43f5e;">Calculate total cycle time, cycles per day, and effective treatment capacity. Every SBR process decision flows from cycle timing.</div>

                <div style="margin-bottom:10px;">
                    <button onclick="document.getElementById('sbr_guide').style.display = document.getElementById('sbr_guide').style.display === 'none' ? 'block' : 'none'; this.innerText = document.getElementById('sbr_guide').style.display === 'none' ? 'ðŸ“– How to Use â–¸' : 'ðŸ“– How to Use â–¾'" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid #f43f5e;background:rgba(244,63,94,0.08);color:#fb7185;font-weight:bold;font-size:0.82rem;cursor:pointer;text-align:left;">ðŸ“– How to Use â–¸</button>
                    <div id="sbr_guide" style="display:none;margin-top:8px;background:#0c1222;border:1px solid #334155;border-radius:8px;padding:14px;font-size:0.8rem;color:#cbd5e1;line-height:1.7;">
                        <div style="color:#fb7185;font-weight:bold;font-size:0.85rem;margin-bottom:8px;">SBR CYCLE TIME â€” OPERATOR GUIDE</div>

                        <div style="color:#f8fafc;font-weight:bold;">What This Calculates</div>
                        An SBR operates in batch cycles: Fill â†’ React (Aerate) â†’ Settle â†’ Decant â†’ Idle. This calculator adds up all phase times to get your total cycle, then tells you how many cycles per day and whether your basin can handle the design flow.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Inputs Explained</div>
                        <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                            <b>Fill Time</b> â€” How long to fill the basin. Static fill (no aeration) = stronger batch effect. Most plants: 1â€“2 hours.<br>
                            <b>React/Aerate Time</b> â€” Active aeration period. This is where BOD removal and nitrification happen. Typically 2â€“4 hours. Longer = better treatment but fewer cycles.<br>
                            <b>Settle Time</b> â€” Quiescent settling (no mixing or aeration). Typically 0.5â€“1.5 hours. Poor settling sludge needs more time.<br>
                            <b>Decant Time</b> â€” Time to withdraw clear supernatant. Depends on decanter capacity. Typically 0.5â€“1 hour.<br>
                            <b>Idle Time</b> â€” Buffer between cycles. Used for WAS, equalization, or waiting for the other basin to finish. Can be 0 if cycles are tight.
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">How to Read Results</div>
                        <b>Cycles/day</b> = 24 hrs Ã· total cycle time. More cycles = more daily capacity. Typical: 4â€“6 cycles/day.<br>
                        <b>Aeration duty cycle</b> = % of time blowers run. Used for energy cost estimates and blower sizing.<br>
                        If cycles/day Ã— volume/cycle < your design flow, you need to shorten cycles or add a basin.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">TCEQ Exam Tips</div>
                        <div style="background:rgba(244,63,94,0.1);border-radius:6px;padding:8px 10px;margin:4px 0;border-left:3px solid #f43f5e;">
                            â€¢ Total cycle = Fill + React + Settle + Decant + Idle<br>
                            â€¢ Cycles/day = 24 Ã· Total Cycle (hrs)<br>
                            â€¢ If they ask "how many gallons can the SBR treat per day" â†’ cycles/day Ã— volume per cycle<br>
                            â€¢ SBR = activated sludge without a separate clarifier
                        </div>
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>Fill (min)</label>
                        <input type="number" inputmode="decimal" id="cyc_fill" oninput="calcCycle()" placeholder="60">
                        <span class="field-hint">Static or aerated fill</span>
                    </div>
                    <div>
                        <label>React (min)</label>
                        <input type="number" inputmode="decimal" id="cyc_react" oninput="calcCycle()" placeholder="120">
                        <span class="field-hint">Aeration + mixing</span>
                    </div>
                    <div>
                        <label>Settle (min)</label>
                        <input type="number" inputmode="decimal" id="cyc_settle" oninput="calcCycle()" placeholder="60">
                        <span class="field-hint">Quiescent settling</span>
                    </div>
                    <div>
                        <label>Decant (min)</label>
                        <input type="number" inputmode="decimal" id="cyc_decant" oninput="calcCycle()" placeholder="30">
                        <span class="field-hint">Effluent withdrawal</span>
                    </div>
                    <div>
                        <label>Idle (min)</label>
                        <input type="number" inputmode="decimal" id="cyc_idle" oninput="calcCycle()" placeholder="10">
                        <span class="field-hint">Buffer / WAS (can be 0)</span>
                    </div>
                    <div>
                        <label>Design Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="cyc_flow" oninput="calcCycle()" placeholder="1.0">
                        <span class="field-hint">For capacity check</span>
                    </div>
                </div>
                <div class="example-box"><b>Typical Cycles:</b> 4â€“6 hrs total | 4â€“6 cycles/day | Fill 25â€“30% of cycle | React 30â€“40% | Settle 20â€“25% | Decant 15â€“20%</div>
                <div class="result-box">
                    <span class="val" id="cyc_res">â€”</span>
                    <div id="cyc_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('cyc_res')">Copy Result</button>
                </div>
                <div class="formula-note">Cycle = Fill + React + Settle + Decant + Idle | Cycles/day = 1440 Ã· Cycle</div>
                <button class="diagram-toggle" onclick="toggleDiagram(28,'sbr')">ðŸ“Š Show SBR Cycle Phases Diagram</button>
            </div>
        </div>
    </div>

    <!-- 29. SBR Volume per Cycle -->
    <div class="card" id="card29" data-calc="sbrvol" style="border-left-color: #f43f5e;">
        <div class="card-header" onclick="toggleCard(29)">
            <h2><span class="card-num" style="background: #f43f5e;">29</span> SBR Volume per Cycle</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #f43f5e;">Calculate fill volume per cycle and verify reactor can handle the hydraulic load. Determines decant volume and checks against reactor capacity.</div>
                <div class="grid">
                    <div>
                        <label>Daily Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="sv_flow" oninput="calcSBRVol()" placeholder="1.0">
                        <span class="field-hint">Average daily flow</span>
                    </div>
                    <div>
                        <label>Cycles per Day</label>
                        <input type="number" inputmode="decimal" id="sv_cycles" oninput="calcSBRVol()" placeholder="4">
                        <span class="field-hint">From Cycle Time calc</span>
                    </div>
                    <div>
                        <label>Reactor Volume (gal)</label>
                        <input type="number" inputmode="decimal" id="sv_reactor" oninput="calcSBRVol()" placeholder="500000">
                        <span class="field-hint">Total basin volume</span>
                    </div>
                    <div>
                        <label># of Basins</label>
                        <input type="number" inputmode="decimal" id="sv_basins" oninput="calcSBRVol()" placeholder="2">
                        <span class="field-hint">Parallel SBR basins</span>
                    </div>
                </div>
                <div class="example-box"><b>Design Rule:</b> Decant volume (fill vol) should be 15â€“35% of total reactor volume. Freeboard must remain above max water level at all times.</div>
                <div class="result-box">
                    <span class="val" id="sv_res">â€”</span>
                    <div id="sv_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('sv_res')">Copy Result</button>
                </div>
                <div class="formula-note">Vol/Cycle = Daily Flow Ã· (Cycles Ã— Basins) | Fill Ratio = Vol/Cycle Ã· Reactor Vol</div>
            </div>
        </div>
    </div>

    <!-- 30. SBR Decant Rate -->
    <div class="card" id="card30" data-calc="sbrdecant" style="border-left-color: #f43f5e;">
        <div class="card-header" onclick="toggleCard(30)">
            <h2><span class="card-num" style="background: #f43f5e;">30</span> SBR Decant Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #f43f5e;">Calculate decant withdrawal rate. Too fast = turbulence pulls solids into effluent. Too slow = steals time from react phase.</div>
                <div class="grid">
                    <div>
                        <label>Decant Volume (gal)</label>
                        <input type="number" inputmode="decimal" id="dec_vol" oninput="calcDecant()" placeholder="125000">
                        <span class="field-hint">Volume removed per cycle</span>
                    </div>
                    <div>
                        <label>Decant Time (min)</label>
                        <input type="number" inputmode="decimal" id="dec_time" oninput="calcDecant()" placeholder="30">
                        <span class="field-hint">Available decant period</span>
                    </div>
                    <div>
                        <label>Weir Length (ft)</label>
                        <input type="number" inputmode="decimal" id="dec_weir" oninput="calcDecant()" placeholder="20">
                        <span class="field-hint">Decanter weir length</span>
                    </div>
                </div>
                <div class="example-box"><b>Decant Limits:</b> Typical rate: 1,000â€“4,000 GPM total | Weir loading: &lt;10 GPM/ft preferred | Floating decanters adjust with water level</div>
                <div class="result-box">
                    <span class="val" id="dec_res">0 GPM</span>
                    <div id="dec_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('dec_res')">Copy Result</button>
                </div>
                <div class="formula-note">Rate (GPM) = Decant Vol Ã· Decant Time | Weir Rate = GPM Ã· Weir Length</div>
            </div>
        </div>
    </div>

    <!-- 31. SBR Aeration Demand -->
    <div class="card" id="card31" data-calc="sbraer" style="border-left-color: #f43f5e;">
        <div class="card-header" onclick="toggleCard(31)">
            <h2><span class="card-num" style="background: #f43f5e;">31</span> SBR Aeration Demand</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #f43f5e;">Calculate Oâ‚‚ required during react phase. In SBR, aeration only runs during fill+react â€” blowers must deliver the full daily Oâ‚‚ demand in less time than continuous-flow plants.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="saer_flow" oninput="calcSBRAer()" placeholder="1.0">
                        <span class="field-hint">Daily flow</span>
                    </div>
                    <div>
                        <label>BOD Removed (mg/L)</label>
                        <input type="number" inputmode="decimal" id="saer_bod" oninput="calcSBRAer()" placeholder="150">
                        <span class="field-hint">Influent â€“ Effluent BOD</span>
                    </div>
                    <div>
                        <label>NHâ‚ƒ-N Removed (mg/L)</label>
                        <input type="number" inputmode="decimal" id="saer_nh3" oninput="calcSBRAer()" placeholder="20">
                        <span class="field-hint">0 if no nitrification</span>
                    </div>
                    <div>
                        <label>Aeration Duty (%)</label>
                        <input type="number" inputmode="decimal" id="saer_duty" oninput="calcSBRAer()" placeholder="50">
                        <span class="field-hint">(Fill + React) Ã· Total Cycle Ã— 100</span>
                    </div>
                </div>
                <div class="example-box"><b>SBR Aeration:</b> If cycle = 4 hrs and aerated phases = 2 hrs â†’ 50% duty. Blower must deliver 2Ã— the continuous rate. Size blowers for peak duty, not daily average.</div>
                <div class="result-box">
                    <span class="val" id="saer_res">â€”</span>
                    <div id="saer_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('saer_res')">Copy Result</button>
                </div>
                <div class="formula-note">Daily Oâ‚‚ = (BOD Ã— 1.5 + NHâ‚ƒ Ã— 4.6) Ã— Flow Ã— 8.34 | Peak = Daily Ã· Duty%</div>
            </div>
        </div>
    </div>

    <!-- 32. SBR F:M per Cycle -->
    <div class="card" id="card32" data-calc="sbrfm" style="border-left-color: #f43f5e;">
        <div class="card-header" onclick="toggleCard(32)">
            <h2><span class="card-num" style="background: #f43f5e;">32</span> SBR F:M per Cycle</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #f43f5e;">SBR F:M differs from CAS â€” the food slug arrives all at once during fill, creating a high instantaneous F:M that drops to near-zero by end of react.</div>
                <div class="grid">
                    <div>
                        <label>Fill Volume (gal)</label>
                        <input type="number" inputmode="decimal" id="sfm_fill" oninput="calcSBRFM()" placeholder="125000">
                        <span class="field-hint">Volume added per cycle</span>
                    </div>
                    <div>
                        <label>Influent BOD (mg/L)</label>
                        <input type="number" inputmode="decimal" id="sfm_bod" oninput="calcSBRFM()" placeholder="200">
                        <span class="field-hint">Incoming BOD concentration</span>
                    </div>
                    <div>
                        <label>Reactor Volume (gal)</label>
                        <input type="number" inputmode="decimal" id="sfm_vol" oninput="calcSBRFM()" placeholder="500000">
                        <span class="field-hint">Total basin volume</span>
                    </div>
                    <div>
                        <label>MLVSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="sfm_mlvss" oninput="calcSBRFM()" placeholder="2500">
                        <span class="field-hint">Volatile suspended solids</span>
                    </div>
                    <div>
                        <label>Cycles per Day</label>
                        <input type="number" inputmode="decimal" id="sfm_cycles" oninput="calcSBRFM()" placeholder="4">
                        <span class="field-hint">For daily F:M</span>
                    </div>
                </div>
                <div class="example-box"><b>SBR F:M:</b> Daily avg: 0.05â€“0.15 typical | Instantaneous at start of fill is much higher | CAS equivalent would be 0.2â€“0.5</div>
                <div class="result-box">
                    <span class="val" id="sfm_res">â€”</span>
                    <div id="sfm_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('sfm_res')">Copy Result</button>
                </div>
                <div class="formula-note">Daily F:M = (Fill Ã— BOD Ã— 8.34 Ã— Cycles) Ã· (Reactor Ã— MLVSS Ã— 8.34)</div>
            </div>
        </div>
    </div>

    <!-- 33. SBR Settle & Decant Check -->
    <div class="card" id="card33" data-calc="sbrsettle" style="border-left-color: #f43f5e;">
        <div class="card-header" onclick="toggleCard(33)">
            <h2><span class="card-num" style="background: #f43f5e;">33</span> SBR Settle & Decant Check</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #f43f5e;">Verify adequate separation before decant begins. Flags risk of solids carryover if sludge blanket is too close to decant withdrawal level.</div>
                <div class="grid">
                    <div>
                        <label>Total Water Depth (ft)</label>
                        <input type="number" inputmode="decimal" id="ssc_depth" oninput="calcSSC()" placeholder="16">
                        <span class="field-hint">Max water level at end of fill</span>
                    </div>
                    <div>
                        <label>Settled Sludge (%)</label>
                        <input type="number" inputmode="decimal" id="ssc_sludge" oninput="calcSSC()" placeholder="30">
                        <span class="field-hint">30-min settleometer (% of total)</span>
                    </div>
                    <div>
                        <label>Decant Depth (ft)</label>
                        <input type="number" inputmode="decimal" id="ssc_decant" oninput="calcSSC()" placeholder="4">
                        <span class="field-hint">Water removed during decant</span>
                    </div>
                    <div>
                        <label>MLSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="ssc_mlss" oninput="calcSSC()" placeholder="3500">
                        <span class="field-hint">Mixed liquor concentration</span>
                    </div>
                </div>
                <div class="example-box"><b>Safety Rule:</b> Sludge blanket must be â‰¥2 ft below decant weir at start of decant. Blanket depth = Water depth Ã— Settled%. Good settling = &lt;30% in 30 min.</div>
                <div class="result-box">
                    <span class="val" id="ssc_res">â€”</span>
                    <div id="ssc_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('ssc_res')">Copy Result</button>
                </div>
                <div class="formula-note">Blanket = Depth Ã— Settle% | Clearwater = Depth âˆ’ Blanket | Buffer = Clearwater âˆ’ Decant</div>
            </div>
        </div>
    </div>

    <!-- ========== DISINFECTION SECTION ========== -->
    <div class="section-header" data-cat="disinf" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(234, 179, 8, 0.15); border-radius: 8px; border-left: 4px solid #eab308; font-size: 0.85rem; color: #facc15; font-weight: bold;">ðŸ§ª Disinfection Calculators</div>

    <!-- 34. Chlorine Contact Time (CT) -->
    <div class="card" id="card34" data-calc="ct" style="border-left-color: #eab308;">
        <div class="card-header" onclick="toggleCard(34)">
            <h2><span class="card-num" style="background: #eab308;">34</span> Chlorine CT Value</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #eab308;">Calculate CT value for disinfection compliance. CT = chlorine residual Ã— contact time. TCEQ requires specific CT for pathogen inactivation.</div>

                <div style="margin-bottom:10px;">
                    <button onclick="document.getElementById('ct_guide').style.display = document.getElementById('ct_guide').style.display === 'none' ? 'block' : 'none'; this.innerText = document.getElementById('ct_guide').style.display === 'none' ? 'ðŸ“– How to Use â–¸' : 'ðŸ“– How to Use â–¾'" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid #eab308;background:rgba(234,179,8,0.08);color:#facc15;font-weight:bold;font-size:0.82rem;cursor:pointer;text-align:left;">ðŸ“– How to Use â–¸</button>
                    <div id="ct_guide" style="display:none;margin-top:8px;background:#0c1222;border:1px solid #334155;border-radius:8px;padding:14px;font-size:0.8rem;color:#cbd5e1;line-height:1.7;">
                        <div style="color:#facc15;font-weight:bold;font-size:0.85rem;margin-bottom:8px;">CHLORINE CT VALUE â€” OPERATOR GUIDE</div>

                        <div style="color:#f8fafc;font-weight:bold;">What is CT?</div>
                        CT is the product of disinfectant concentration (C, in mg/L) multiplied by contact time (T, in minutes). It measures total disinfection "dose" â€” a higher CT means more pathogen kill. Your permit requires a minimum CT to ensure adequate disinfection before discharge.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Inputs Explained</div>
                        <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                            <b>Clâ‚‚ Residual (mg/L)</b> â€” Measured at the <i>end</i> of the contact chamber, not at the dosing point. Use your grab sample or continuous analyzer reading.<br>
                            <b>Contact Time (min)</b> â€” Use T10, NOT theoretical detention time. T10 = volume Ã· flow Ã— baffling factor (BF). Serpentine channels: BF = 0.7. Plug flow pipe: BF = 1.0. Open basin: BF = 0.1â€“0.3.<br>
                            <b>Required CT</b> â€” From your permit or TCEQ guidance. Depends on target pathogen, temperature, and pH. Cold water + high pH = need higher CT.
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Critical Operator Notes</div>
                        <div style="background:rgba(234,179,8,0.1);border-radius:6px;padding:8px 10px;margin:4px 0;border-left:3px solid #eab308;">
                            â€¢ <b>T10 matters:</b> A 10,000-gal tank at 100 GPM has 100 min theoretical detention â€” but with BF=0.3, T10 is only 30 min<br>
                            â€¢ <b>Temperature effect:</b> CT requirements roughly double for every 10Â°C drop in water temperature<br>
                            â€¢ <b>pH effect:</b> Free chlorine is much more effective at pH &lt; 7.5. Hypochlorous acid (HOCl) dominates below pH 7.5<br>
                            â€¢ <b>Don't over-chlorinate:</b> High residual = high CT but also high dechlorination cost and aquatic toxicity risk<br>
                            â€¢ <b>TCEQ exam:</b> CT = C Ã— T. They often give you volume and flow â€” you must calculate T first (T = Vol Ã· Flow, convert to minutes)
                        </div>
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>Clâ‚‚ Residual (mg/L)</label>
                        <input type="number" inputmode="decimal" id="ct_res_in" oninput="calcCT()" placeholder="2.0">
                        <span class="field-hint">At end of contact chamber</span>
                    </div>
                    <div>
                        <label>Contact Time (min)</label>
                        <input type="number" inputmode="decimal" id="ct_time" oninput="calcCT()" placeholder="30">
                        <span class="field-hint">T10 actual contact time</span>
                    </div>
                    <div>
                        <label>Required CT (mgÂ·min/L)</label>
                        <input type="number" inputmode="decimal" id="ct_req" oninput="calcCT()" placeholder="450">
                        <span class="field-hint">From permit or tables</span>
                    </div>
                </div>
                <div class="example-box"><b>Common CT Requirements:</b> 2-log virus: 6 mgÂ·min/L (free Clâ‚‚) | 3-log Giardia: 104â€“150+ depending on temp/pH | TCEQ Surface Water: 450+ typical</div>
                <div class="result-box">
                    <span class="val" id="ct_res">0.0 mgÂ·min/L</span>
                    <div id="ct_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('ct_res')">Copy Result</button>
                </div>
                <div class="formula-note">CT = Residual (mg/L) Ã— Contact Time (min)</div>
            </div>
        </div>
    </div>

    <!-- 35. Dechlorination Dosing -->
    <div class="card" id="card35" data-calc="dechlor" style="border-left-color: #eab308;">
        <div class="card-header" onclick="toggleCard(35)">
            <h2><span class="card-num" style="background: #eab308;">35</span> Dechlorination Dosing</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #eab308;">Calculate sodium bisulfite (NaHSOâ‚ƒ) or sulfur dioxide needed to neutralize chlorine residual before discharge. Required at most Texas plants.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="dcl_flow" oninput="calcDCL()" placeholder="1.5">
                        <span class="field-hint">Effluent flow</span>
                    </div>
                    <div>
                        <label>Clâ‚‚ Residual (mg/L)</label>
                        <input type="number" inputmode="decimal" id="dcl_cl2" oninput="calcDCL()" placeholder="2.0">
                        <span class="field-hint">Before dechlorination</span>
                    </div>
                    <div>
                        <label>Safety Factor</label>
                        <input type="number" inputmode="decimal" id="dcl_sf" oninput="calcDCL()" placeholder="1.2">
                        <span class="field-hint">Typical: 1.1â€“1.5Ã—</span>
                    </div>
                </div>
                <div class="example-box"><b>Stoichiometry:</b> 1.0 mg SOâ‚‚ per 1.0 mg Clâ‚‚ | 1.46 mg NaHSOâ‚ƒ per 1.0 mg Clâ‚‚ | 0.9 mg Naâ‚‚SOâ‚ƒ per 1.0 mg Clâ‚‚</div>
                <div class="result-box">
                    <span class="val" id="dcl_res">â€”</span>
                    <div id="dcl_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('dcl_res')">Copy Result</button>
                </div>
                <div class="formula-note">SOâ‚‚ lbs/day = Flow Ã— Clâ‚‚ Ã— 8.34 Ã— 1.0 Ã— SF | NaHSOâ‚ƒ = Ã— 1.46</div>
            </div>
        </div>
    </div>

    <!-- 36. UV Dose -->
    <div class="card" id="card36" data-calc="uv" style="border-left-color: #eab308;">
        <div class="card-header" onclick="toggleCard(36)">
            <h2><span class="card-num" style="background: #eab308;">36</span> UV Dose</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #eab308;">Calculate UV dose from intensity and exposure time. Verify adequate disinfection for permit compliance. UV increasingly replacing chlorine in Texas.</div>
                <div class="grid">
                    <div>
                        <label>UV Intensity (mW/cmÂ²)</label>
                        <input type="number" inputmode="decimal" id="uv_int" oninput="calcUV()" placeholder="40">
                        <span class="field-hint">Measured by UV sensor</span>
                    </div>
                    <div>
                        <label>Exposure Time (sec)</label>
                        <input type="number" inputmode="decimal" id="uv_time" oninput="calcUV()" placeholder="10">
                        <span class="field-hint">Chamber volume Ã· flow rate</span>
                    </div>
                    <div>
                        <label>UV Transmittance (%)</label>
                        <input type="number" inputmode="decimal" id="uv_uvt" oninput="calcUV()" placeholder="65">
                        <span class="field-hint">Lab UVT result</span>
                    </div>
                </div>
                <div class="example-box"><b>Required Doses:</b> E. coli/fecal: 30â€“40 mJ/cmÂ² | TCEQ typical: 30+ mJ/cmÂ² | Reuse water: 80â€“100+ mJ/cmÂ² | Good UVT: &gt;65%</div>
                <div class="result-box">
                    <span class="val" id="uv_res">0.0 mJ/cmÂ²</span>
                    <div id="uv_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('uv_res')">Copy Result</button>
                </div>
                <div class="formula-note">Dose (mJ/cmÂ²) = Intensity (mW/cmÂ²) Ã— Time (sec)</div>
            </div>
        </div>
    </div>

    <!-- 69. Hypochlorite Dosing Calculator -->
    <div class="card" id="card37" data-calc="hypo" style="border-left-color: #eab308;">
        <div class="card-header" onclick="toggleCard(37)">
            <h2><span class="card-num" style="background: #eab308;">37</span> Hypochlorite Dosing (Cal-Hypo & Bleach) <span class="diagram-badge">DIAGRAM</span></h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #eab308;">Calculate calcium hypochlorite or liquid bleach dosing for disinfection or RAS chlorination.</div>

                <div class="grid">
                    <div>
                        <label>Application</label>
                        <select id="hypo_app" onchange="calcHypoDose()">
                            <option value="effluent">Effluent Disinfection</option>
                            <option value="ras">RAS Chlorination (Filament Control)</option>
                        </select>
                        <span class="field-hint">Select application type</span>
                    </div>
                    <div>
                        <label>Chemical Type</label>
                        <select id="hypo_type" onchange="calcHypoDose()">
                            <option value="liquid">Liquid Bleach (Sodium Hypochlorite)</option>
                            <option value="calcium">Calcium Hypochlorite (Granular)</option>
                        </select>
                        <span class="field-hint">Cal-hypo or liquid bleach</span>
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>% Available Chlorine</label>
                        <input type="number" inputmode="decimal" id="hypo_pct" oninput="calcHypoDose()" placeholder="12.5" value="12.5">
                        <span class="field-hint">Liquid: 10-12.5% | Cal-hypo: 65-70%</span>
                    </div>
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="hypo_flow" oninput="calcHypoDose()" placeholder="1.5">
                        <span class="field-hint">Treatment flow rate</span>
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>Target Dose (mg/L as Clâ‚‚)</label>
                        <input type="number" inputmode="decimal" id="hypo_dose" oninput="calcHypoDose()" placeholder="5">
                        <span class="field-hint">Effluent: 2-10 mg/L typical</span>
                    </div>
                    <div>
                        <label>Liquid Specific Gravity</label>
                        <input type="number" inputmode="decimal" id="hypo_sg" oninput="calcHypoDose()" placeholder="1.16" value="1.16">
                        <span class="field-hint">12.5% bleach â‰ˆ 1.16 SG</span>
                    </div>
                </div>
                
                <!-- RAS Chlorination specific inputs -->
                <div id="rasInputs" style="display:none;margin-top:10px;padding:10px;background:#1e3a5f;border-radius:8px;border-left:3px solid #fbbf24;">
                    <div style="color:#fbbf24;font-weight:bold;font-size:0.8rem;margin-bottom:8px;">ðŸ¦  RAS Chlorination for Filament Control</div>
                    <div class="grid">
                        <div>
                            <label>MLSS (mg/L)</label>
                            <input type="number" inputmode="decimal" id="hypo_mlss" oninput="calcHypoDose()" placeholder="3000">
                            <span class="field-hint">Mixed liquor concentration</span>
                        </div>
                        <div>
                            <label>Aeration Volume (MG)</label>
                            <input type="number" inputmode="decimal" id="hypo_vol" oninput="calcHypoDose()" placeholder="0.5">
                            <span class="field-hint">Total aeration basin volume</span>
                        </div>
                    </div>
                    <div class="grid">
                        <div>
                            <label>Clâ‚‚ Dose (lb/1000 lb MLSS/day)</label>
                            <input type="number" inputmode="decimal" id="hypo_rasdose" oninput="calcHypoDose()" placeholder="5" value="5">
                            <span class="field-hint">Typical: 2-10 lb Clâ‚‚/1000 lb MLSS/day</span>
                        </div>
                    </div>
                </div>

                <div class="example-box">
                    <b>Typical % Available Chlorine:</b><br>
                    â€¢ Sodium Hypochlorite (liquid bleach): 10-12.5% (trade), 5.25% (household)<br>
                    â€¢ Calcium Hypochlorite (granular): 65-70%<br>
                    <b>RAS Chlorination:</b> 2-10 lb Clâ‚‚ per 1000 lb MLSS per day to control filaments
                </div>
                <div class="result-box">
                    <span class="val" id="hypo_res">â€”</span>
                    <div id="hypo_status" class="status">Enter flow, dose, and chemical strength...</div>
                    <button class="btn-copy" onclick="copyVal('hypo_res')">Copy Result</button>
                </div>
                <div class="formula-note">lbs Clâ‚‚/day = Flow (MGD) Ã— Dose (mg/L) Ã— 8.34 | Chemical lbs = Clâ‚‚ lbs Ã· (% avail/100) | Gallons = lbs Ã· (8.34 Ã— SG)</div>
                
                <!-- Collapsible Guide -->
                <div class="guide-toggle" onclick="this.classList.toggle('open');this.nextElementSibling.classList.toggle('open')">
                    â–¶ How to Use This Calculator
                </div>
                <div class="guide-content">
                    <div style="color:#eab308;font-weight:bold;font-size:0.85rem;margin-bottom:8px;">HYPOCHLORITE DOSING â€” OPERATOR GUIDE</div>

                    <div style="color:#f8fafc;font-weight:bold;">Effluent Disinfection</div>
                    <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                        1. Determine required CT value from permit<br>
                        2. Set target residual (typically 0.5-2.0 mg/L)<br>
                        3. Account for chlorine demand (dose > residual)<br>
                        4. Typical dose: 5-15 mg/L depending on demand
                    </div>

                    <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">RAS Chlorination (Filament Control)</div>
                    <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                        â€¢ Dose: 2-10 lb Clâ‚‚ per 1000 lb MLSS per day<br>
                        â€¢ Start low (2-3 lb), increase if SVI doesn't improve<br>
                        â€¢ Apply to RAS line before return to aeration<br>
                        â€¢ Monitor SVI weekly â€” should drop within 2-4 weeks
                    </div>

                    <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">TCEQ Exam Tips</div>
                    <div style="background:rgba(234,179,8,0.1);border-radius:6px;padding:8px 10px;margin:4px 0;border-left:3px solid #eab308;">
                        â€¢ <b>Chlorinate RAS 2-10 lb Clâ‚‚ per 1000 lb MLSS/day</b> to kill filaments<br>
                        â€¢ 12.5% bleach has ~1.25 lb Clâ‚‚ per gallon<br>
                        â€¢ 65% cal-hypo: need 1.54 lb product per lb Clâ‚‚<br>
                        â€¢ Always calculate as Clâ‚‚ first, then convert to product
                    </div>
                </div>
                <button class="diagram-toggle" onclick="toggleDiagram(37,'disinfection')">ðŸ“Š Show Chlorine Contact Chamber Diagram</button>
            </div>
        </div>
    </div>

    <!-- ========== SLUDGE & BIOSOLIDS SECTION ========== -->
    <div class="section-header" data-cat="sludge" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(168, 85, 247, 0.15); border-radius: 8px; border-left: 4px solid #a855f7; font-size: 0.85rem; color: #c084fc; font-weight: bold;">ðŸ’© Sludge & Biosolids Calculators</div>

    <!-- 37. Sludge Volume & Percent Solids -->
    <div class="card" id="card38" data-calc="sldvol" style="border-left-color: #a855f7;">
        <div class="card-header" onclick="toggleCard(38)">
            <h2><span class="card-num" style="background: #a855f7;">38</span> Sludge Volume & % Solids</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #a855f7;">Convert between wet volume, dry weight, and percent solids. Used daily for hauling, land application, and biosolids reporting.</div>
                <div class="grid">
                    <div>
                        <label>Sludge Volume (gal/day)</label>
                        <input type="number" inputmode="decimal" id="slv_vol" oninput="calcSLV()" placeholder="10000">
                        <span class="field-hint">Wet sludge pumped</span>
                    </div>
                    <div>
                        <label>% Solids</label>
                        <input type="number" inputmode="decimal" id="slv_pct" oninput="calcSLV()" placeholder="3.0">
                        <span class="field-hint">Lab result or estimate</span>
                    </div>
                </div>
                <div class="example-box"><b>Typical:</b> WAS 0.5â€“1.5% | Thickened WAS 3â€“6% | Belt press cake 15â€“25% | Centrifuge cake 20â€“30% | 1 gal sludge â‰ˆ 8.34 lbs</div>
                <div class="result-box">
                    <span class="val" id="slv_res">â€”</span>
                    <div id="slv_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('slv_res')">Copy Result</button>
                </div>
                <div class="formula-note">Dry lbs = Volume Ã— 8.34 Ã— (%Solids Ã· 100) | Dry tons = Dry lbs Ã· 2000</div>
            </div>
        </div>
    </div>

    <!-- 38. Volatile Solids Reduction -->
    <div class="card" id="card39" data-calc="vsr" style="border-left-color: #a855f7;">
        <div class="card-header" onclick="toggleCard(39)">
            <h2><span class="card-num" style="background: #a855f7;">39</span> Volatile Solids Reduction</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #a855f7;">Calculate VS destruction in digesters using Van Kleeck equation. 38% minimum required for Class B biosolids (vector attraction reduction).</div>
                <div class="grid">
                    <div>
                        <label>Influent VS (%)</label>
                        <input type="number" inputmode="decimal" id="vsr_in" oninput="calcVSR()" placeholder="75">
                        <span class="field-hint">Raw sludge volatile fraction</span>
                    </div>
                    <div>
                        <label>Effluent VS (%)</label>
                        <input type="number" inputmode="decimal" id="vsr_out" oninput="calcVSR()" placeholder="55">
                        <span class="field-hint">Digested sludge volatile fraction</span>
                    </div>
                </div>
                <div class="example-box"><b>Van Kleeck:</b> VSR = (VSin âˆ’ VSout) Ã· (VSin âˆ’ (VSin Ã— VSout)) Ã— 100 | Class B minimum: 38% | Healthy digester: 50â€“60%</div>
                <div class="result-box">
                    <span class="val" id="vsr_res">0.0 %</span>
                    <div id="vsr_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('vsr_res')">Copy Result</button>
                </div>
                <div class="formula-note">VSR = (VSin âˆ’ VSout) Ã· [VSin âˆ’ (VSin Ã— VSout)] Ã— 100</div>
            </div>
        </div>
    </div>

    <!-- 39. Digester Loading Rate -->
    <div class="card" id="card40" data-calc="diglr" style="border-left-color: #a855f7;">
        <div class="card-header" onclick="toggleCard(40)">
            <h2><span class="card-num" style="background: #a855f7;">40</span> Digester Loading Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #a855f7;">Calculate volatile solids loading to anaerobic digester. Overloading causes pH drop, VFA buildup, and digester upset â€” common and costly operator mistake.</div>
                <div class="grid">
                    <div>
                        <label>Sludge Flow (GPD)</label>
                        <input type="number" inputmode="decimal" id="dig_flow" oninput="calcDIG()" placeholder="15000">
                        <span class="field-hint">Volume fed to digester</span>
                    </div>
                    <div>
                        <label>% Solids</label>
                        <input type="number" inputmode="decimal" id="dig_pct" oninput="calcDIG()" placeholder="4.0">
                        <span class="field-hint">Feed sludge solids</span>
                    </div>
                    <div>
                        <label>% Volatile</label>
                        <input type="number" inputmode="decimal" id="dig_vs" oninput="calcDIG()" placeholder="72">
                        <span class="field-hint">VS as % of TS</span>
                    </div>
                    <div>
                        <label>Digester Volume (ftÂ³)</label>
                        <input type="number" inputmode="decimal" id="dig_vol" oninput="calcDIG()" placeholder="50000">
                        <span class="field-hint">Active digester volume</span>
                    </div>
                </div>
                <div class="example-box"><b>Loading Limits:</b> Low-rate: 0.03â€“0.05 lbs VS/ftÂ³/d | High-rate: 0.10â€“0.20 lbs VS/ftÂ³/d | Overloaded: &gt;0.20</div>
                <div class="result-box">
                    <span class="val" id="dig_res">0.00 lbs VS/ftÂ³/d</span>
                    <div id="dig_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('dig_res')">Copy Result</button>
                </div>
                <div class="formula-note">Loading = (Flow Ã— 8.34 Ã— %Solids Ã— %VS) Ã· Digester Volume</div>
            </div>
        </div>
    </div>

    <!-- 71. Digester Gas Production -->
    <div class="card" id="card41" data-calc="biogas" style="border-left-color: #a855f7;">
        <div class="card-header" onclick="toggleCard(41)">
            <h2><span class="card-num" style="background: #a855f7;">41</span> Digester Gas Production <span class="diagram-badge">DIAGRAM</span></h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #a855f7;">Estimate biogas production from anaerobic digester based on VS destroyed. Used for sizing gas handling, energy recovery, and flare capacity.</div>
                <div class="grid">
                    <div>
                        <label>Sludge Flow (GPD)</label>
                        <input type="number" inputmode="decimal" id="gas_flow" oninput="calcDigesterGas()" placeholder="50000">
                        <span class="field-hint">Feed to digester</span>
                    </div>
                    <div>
                        <label>% Solids</label>
                        <input type="number" inputmode="decimal" id="gas_pct" oninput="calcDigesterGas()" placeholder="4.0">
                        <span class="field-hint">Feed sludge concentration</span>
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>% Volatile Solids</label>
                        <input type="number" inputmode="decimal" id="gas_vs" oninput="calcDigesterGas()" placeholder="75">
                        <span class="field-hint">VS as % of TS</span>
                    </div>
                    <div>
                        <label>VS Destruction (%)</label>
                        <input type="number" inputmode="decimal" id="gas_vsr" oninput="calcDigesterGas()" placeholder="55">
                        <span class="field-hint">Typical 50-60%</span>
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>Gas Yield (ftÂ³/lb VS destroyed)</label>
                        <input type="number" inputmode="decimal" id="gas_yield" oninput="calcDigesterGas()" placeholder="15" value="15">
                        <span class="field-hint">Typical 12-18 ftÂ³/lb</span>
                    </div>
                    <div>
                        <label>Methane Content (%)</label>
                        <input type="number" inputmode="decimal" id="gas_ch4" oninput="calcDigesterGas()" placeholder="65" value="65">
                        <span class="field-hint">Typical 60-70%</span>
                    </div>
                </div>
                <div class="example-box"><b>Biogas Composition:</b> 60-70% CHâ‚„ (methane), 30-40% COâ‚‚ | ~600 BTU/ftÂ³ | 1 ftÂ³ CHâ‚„ â‰ˆ 1,000 BTU | Flare or energy recovery</div>
                <div class="result-box">
                    <span class="val" id="gas_res">â€”</span>
                    <div id="gas_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('gas_res')">Copy Result</button>
                </div>
                <div id="gas_detail" style="display:none;margin-top:10px;padding:12px;background:#0f172a;border-radius:8px;font-size:0.8rem;color:#cbd5e1;"></div>
                <div class="formula-note">Gas = VS destroyed (lbs/day) Ã— Gas Yield (ftÂ³/lb)</div>
                <button class="diagram-toggle" onclick="toggleDiagram(41,'digester')">ðŸ“Š Show Anaerobic Digester Diagram</button>
                <div class="see-also">See also: <a onclick="goToCard(39)">#39 VS Reduction</a> Â· <a onclick="goToCard(40)">#40 Digester Loading</a></div>
            </div>
        </div>
    </div>

    <!-- 40. Polymer Dosing for Dewatering -->
    <div class="card" id="card42" data-calc="poly" style="border-left-color: #a855f7;">
        <div class="card-header" onclick="toggleCard(42)">
            <h2><span class="card-num" style="background: #a855f7;">42</span> Polymer Dosing</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #a855f7;">Calculate active polymer per dry ton of solids for belt press or centrifuge. Polymer is one of the biggest chemical costs at any plant.</div>
                <div class="grid">
                    <div>
                        <label>Sludge Flow (GPM)</label>
                        <input type="number" inputmode="decimal" id="poly_flow" oninput="calcPoly()" placeholder="75">
                        <span class="field-hint">Feed to dewatering unit</span>
                    </div>
                    <div>
                        <label>% Solids</label>
                        <input type="number" inputmode="decimal" id="poly_pct" oninput="calcPoly()" placeholder="3.0">
                        <span class="field-hint">Feed sludge concentration</span>
                    </div>
                    <div>
                        <label>Polymer Solution (GPH)</label>
                        <input type="number" inputmode="decimal" id="poly_rate" oninput="calcPoly()" placeholder="20">
                        <span class="field-hint">Neat or diluted solution fed</span>
                    </div>
                    <div>
                        <label>Polymer Conc (% active)</label>
                        <input type="number" inputmode="decimal" id="poly_conc" oninput="calcPoly()" placeholder="0.5">
                        <span class="field-hint">Active polymer in solution</span>
                    </div>
                </div>
                <div class="example-box"><b>Targets:</b> Belt press: 3â€“8 lbs/DT | Centrifuge: 5â€“12 lbs/DT | Gravity thickener: 1â€“4 lbs/DT | Lower = more cost effective</div>
                <div class="result-box">
                    <span class="val" id="poly_res">â€”</span>
                    <div id="poly_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('poly_res')">Copy Result</button>
                </div>
                <div class="formula-note">lbs/DT = (Polymer GPH Ã— 8.34 Ã— %Active Ã— 24) Ã· (Sludge GPM Ã— 8.34 Ã— %Solids Ã— 60 Ã— 24 Ã· 2000)</div>
            </div>
        </div>
    </div>

    <!-- ========== NUTRIENT REMOVAL SECTION ========== -->
    <div class="section-header" data-cat="nutrients" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(34, 197, 94, 0.15); border-radius: 8px; border-left: 4px solid #22c55e; font-size: 0.85rem; color: #4ade80; font-weight: bold;">ðŸŒ¿ Nutrient Removal Calculators</div>

    <!-- 41. Phosphorus Removal -->
    <div class="card" id="card43" data-calc="phos" style="border-left-color: #22c55e;">
        <div class="card-header" onclick="toggleCard(43)">
            <h2><span class="card-num" style="background: #22c55e;">43</span> Phosphorus Removal</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #22c55e;">Calculate alum or ferric chloride dose for chemical phosphorus precipitation. TCEQ phosphorus limits are tightening across Texas watersheds.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="phos_flow" oninput="calcPhos()" placeholder="1.5">
                        <span class="field-hint">Treatment flow</span>
                    </div>
                    <div>
                        <label>Influent P (mg/L)</label>
                        <input type="number" inputmode="decimal" id="phos_in" oninput="calcPhos()" placeholder="5.0">
                        <span class="field-hint">Total phosphorus in</span>
                    </div>
                    <div>
                        <label>Target Effluent P (mg/L)</label>
                        <input type="number" inputmode="decimal" id="phos_out" oninput="calcPhos()" placeholder="1.0">
                        <span class="field-hint">Permit limit</span>
                    </div>
                    <div>
                        <label>Molar Ratio (Me:P)</label>
                        <input type="number" inputmode="decimal" id="phos_ratio" oninput="calcPhos()" placeholder="2.0">
                        <span class="field-hint">Alum: 1.5â€“2.5 | Ferric: 1.5â€“3.0</span>
                    </div>
                </div>
                <div class="example-box"><b>Chemical MW:</b> Alum (Alâ‚‚(SOâ‚„)â‚ƒÂ·14Hâ‚‚O) = 594 | Ferric Chloride (FeClâ‚ƒ) = 162.2 | P = 31 | Al = 27 | Fe = 55.85</div>
                <div class="result-box">
                    <span class="val" id="phos_res">â€”</span>
                    <div id="phos_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('phos_res')">Copy Result</button>
                </div>
                <div class="formula-note">Metal dose = Î”P Ã— Molar Ratio Ã— (Metal MW Ã· P MW) | lbs/day = Flow Ã— Dose Ã— 8.34</div>
            </div>
        </div>
    </div>

    <!-- 42. Alkalinity Consumed by Nitrification -->
    <div class="card" id="card44" data-calc="alk" style="border-left-color: #22c55e;">
        <div class="card-header" onclick="toggleCard(44)">
            <h2><span class="card-num" style="background: #22c55e;">44</span> Alkalinity & Nitrification <span class="diagram-badge">DIAGRAM</span></h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #22c55e;">Calculate alkalinity destroyed by nitrification (7.14 mg alk per mg NHâ‚ƒ-N). Low alkalinity causes nitrification crash and pH drop.</div>
                <div class="grid">
                    <div>
                        <label>Influent Alkalinity (mg/L as CaCOâ‚ƒ)</label>
                        <input type="number" inputmode="decimal" id="alk_in" oninput="calcALK()" placeholder="200">
                        <span class="field-hint">Lab alkalinity result</span>
                    </div>
                    <div>
                        <label>NHâ‚ƒ-N Oxidized (mg/L)</label>
                        <input type="number" inputmode="decimal" id="alk_nh3" oninput="calcALK()" placeholder="25">
                        <span class="field-hint">Influent NHâ‚ƒ âˆ’ Effluent NHâ‚ƒ</span>
                    </div>
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="alk_flow" oninput="calcALK()" placeholder="1.5">
                        <span class="field-hint">For lime dosing calc</span>
                    </div>
                </div>
                <div class="example-box"><b>Rule:</b> 7.14 mg alk consumed per 1 mg NHâ‚ƒ-N oxidized | Maintain effluent alk &gt;50 mg/L | Lime adds ~1.35 mg alk per mg lime (as CaCOâ‚ƒ)</div>
                <div class="result-box">
                    <span class="val" id="alk_res">â€”</span>
                    <div id="alk_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('alk_res')">Copy Result</button>
                </div>
                <div class="formula-note">Alk consumed = NHâ‚ƒ-N Ã— 7.14 | Remaining = Influent âˆ’ Consumed</div>
                <button class="diagram-toggle" onclick="toggleDiagram(44,'bnr')">ðŸ“Š Show BNR Process Diagram</button>
            </div>
        </div>
    </div>

    <!-- 43. Nitrogen Balance -->
    <div class="card" id="card45" data-calc="nbal" style="border-left-color: #22c55e;">
        <div class="card-header" onclick="toggleCard(45)">
            <h2><span class="card-num" style="background: #22c55e;">45</span> Nitrogen Balance</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #22c55e;">Track where nitrogen goes in the treatment process. Essential for TN permit compliance and process optimization.</div>
                <div class="grid">
                    <div>
                        <label>Influent TKN (mg/L)</label>
                        <input type="number" inputmode="decimal" id="nb_tkn" oninput="calcNBal()" placeholder="35">
                        <span class="field-hint">Total Kjeldahl nitrogen in</span>
                    </div>
                    <div>
                        <label>Effluent NHâ‚ƒ-N (mg/L)</label>
                        <input type="number" inputmode="decimal" id="nb_nh3" oninput="calcNBal()" placeholder="1.0">
                        <span class="field-hint">Ammonia in effluent</span>
                    </div>
                    <div>
                        <label>Effluent NOâ‚ƒ-N (mg/L)</label>
                        <input type="number" inputmode="decimal" id="nb_no3" oninput="calcNBal()" placeholder="8.0">
                        <span class="field-hint">Nitrate in effluent</span>
                    </div>
                    <div>
                        <label>Biomass N Uptake (mg/L)</label>
                        <input type="number" inputmode="decimal" id="nb_bio" oninput="calcNBal()" placeholder="2.0">
                        <span class="field-hint">Typically 1â€“3 mg/L</span>
                    </div>
                </div>
                <div class="example-box"><b>N Pathways:</b> Nitrification (NHâ‚ƒâ†’NOâ‚ƒ) | Denitrification (NOâ‚ƒâ†’Nâ‚‚ gas) | Biomass uptake | Effluent TN = NHâ‚ƒ + NOâ‚ƒ + Org-N</div>
                <div class="result-box">
                    <span class="val" id="nb_res">â€”</span>
                    <div id="nb_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('nb_res')">Copy Result</button>
                </div>
                <div class="formula-note">Denitrified = TKN âˆ’ Eff NHâ‚ƒ âˆ’ Eff NOâ‚ƒ âˆ’ Biomass N</div>
            </div>
        </div>
    </div>

    <!-- ========== HYDRAULICS & PUMPING SECTION ========== -->
    <div class="section-header" data-cat="hydraulics" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(59, 130, 246, 0.15); border-radius: 8px; border-left: 4px solid #3b82f6; font-size: 0.85rem; color: #60a5fa; font-weight: bold;">ðŸ’§ Hydraulics & Pumping Calculators</div>

    <!-- 44. Pump TDH -->
    <div class="card" id="card46" data-calc="tdh" style="border-left-color: #3b82f6;">
        <div class="card-header" onclick="toggleCard(46)">
            <h2><span class="card-num" style="background: #3b82f6;">46</span> Total Dynamic Head</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #3b82f6;">Calculate total dynamic head from static lift, friction loss, and velocity head. Determines pump operating point and energy requirements.</div>

                <div style="margin-bottom:10px;">
                    <button onclick="document.getElementById('tdh_guide').style.display = document.getElementById('tdh_guide').style.display === 'none' ? 'block' : 'none'; this.innerText = document.getElementById('tdh_guide').style.display === 'none' ? 'ðŸ“– How to Use â–¸' : 'ðŸ“– How to Use â–¾'" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid #3b82f6;background:rgba(59,130,246,0.08);color:#60a5fa;font-weight:bold;font-size:0.82rem;cursor:pointer;text-align:left;">ðŸ“– How to Use â–¸</button>
                    <div id="tdh_guide" style="display:none;margin-top:8px;background:#0c1222;border:1px solid #334155;border-radius:8px;padding:14px;font-size:0.8rem;color:#cbd5e1;line-height:1.7;">
                        <div style="color:#60a5fa;font-weight:bold;font-size:0.85rem;margin-bottom:8px;">TOTAL DYNAMIC HEAD â€” OPERATOR GUIDE</div>

                        <div style="color:#f8fafc;font-weight:bold;">What is TDH?</div>
                        TDH is the total pressure a pump must overcome to move water from point A to point B. It's the sum of three components: how high you're pushing it (static head), how much friction the pipe creates (friction loss), and the energy in the moving water (velocity head). TDH determines your pump selection, motor size, and energy cost.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Inputs Explained</div>
                        <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                            <b>Static Head (ft)</b> â€” The vertical distance between the water surface at the pump suction and the discharge point. Measure with a tape or from as-built drawings. If pumping uphill from a wet well at 100 ft elevation to a tank at 130 ft, static head = 30 ft.<br>
                            <b>Friction Loss (ft)</b> â€” Energy lost to pipe wall drag. Depends on pipe diameter, length, material, and flow rate. Use Hazen-Williams tables, Calc #56 (Force Main), or a rule of thumb: 1â€“5 ft per 100 ft of pipe for typical WW flows.<br>
                            <b>Velocity Head (ft)</b> â€” Kinetic energy in the moving water. Formula: VÂ²/(2g). At typical WW velocities (3â€“8 fps), this is only 0.1â€“1.0 ft â€” often negligible but always included on TCEQ exams.
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Why This Matters</div>
                        A pump curve plots flow (GPM) vs head (ft). Your pump operates where the system curve (TDH at various flows) intersects the pump curve. If TDH increases (clogged pipe, higher discharge), flow decreases. If TDH is wrong during design, you get an oversized or undersized pump.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">TCEQ Exam Tips</div>
                        <div style="background:rgba(59,130,246,0.1);border-radius:6px;padding:8px 10px;margin:4px 0;border-left:3px solid #3b82f6;">
                            â€¢ <b>TDH = Static Head + Friction Loss + Velocity Head</b><br>
                            â€¢ Velocity head: VÂ²/2g where g = 32.2 ft/sÂ². At 5 fps: 5Â²/(2Ã—32.2) = 0.39 ft<br>
                            â€¢ To convert TDH (ft) to PSI: multiply by 0.433<br>
                            â€¢ Water HP = (Flow GPM Ã— TDH ft) Ã· 3960<br>
                            â€¢ Brake HP = Water HP Ã· pump efficiency (typically 0.60â€“0.80)<br>
                            â€¢ Common trick: they give pressure in PSI â€” convert to ft by dividing by 0.433 (or Ã— 2.31)
                        </div>
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>Static Head (ft)</label>
                        <input type="number" inputmode="decimal" id="tdh_static" oninput="calcTDH()" placeholder="25">
                        <span class="field-hint">Elevation difference</span>
                    </div>
                    <div>
                        <label>Friction Loss (ft)</label>
                        <input type="number" inputmode="decimal" id="tdh_friction" oninput="calcTDH()" placeholder="8">
                        <span class="field-hint">Pipe friction + fittings</span>
                    </div>
                    <div>
                        <label>Velocity Head (ft)</label>
                        <input type="number" inputmode="decimal" id="tdh_vel" oninput="calcTDH()" placeholder="2">
                        <span class="field-hint">vÂ²/2g (often small)</span>
                    </div>
                </div>
                <div class="example-box"><b>Typical TDH:</b> Influent lift station: 20â€“40 ft | RAS/WAS: 5â€“15 ft | Transfer pumps: 10â€“30 ft | 1 psi = 2.31 ft head</div>
                <div class="result-box">
                    <span class="val" id="tdh_res">0.0 ft</span>
                    <div id="tdh_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('tdh_res')">Copy Result</button>
                </div>
                <div class="formula-note">TDH = Static Head + Friction Loss + Velocity Head</div>
            </div>
        </div>
    </div>

    <!-- 70. Pump Horsepower & Energy Cost -->
    <div class="card" id="card47" data-calc="pumphp" style="border-left-color: #3b82f6;">
        <div class="card-header" onclick="toggleCard(47)">
            <h2><span class="card-num" style="background: #3b82f6;">47</span> Pump HP & Energy Cost</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #3b82f6;">Calculate water horsepower, brake horsepower, motor HP, and daily energy cost from flow, TDH, and efficiency.</div>
                <div class="grid">
                    <div>
                        <label>Flow (GPM)</label>
                        <input type="number" inputmode="decimal" id="php_flow" oninput="calcPumpHP()" placeholder="500">
                        <span class="field-hint">Pump flow rate</span>
                    </div>
                    <div>
                        <label>TDH (ft)</label>
                        <input type="number" inputmode="decimal" id="php_tdh" oninput="calcPumpHP()" placeholder="35">
                        <span class="field-hint">Total dynamic head</span>
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>Pump Efficiency (%)</label>
                        <input type="number" inputmode="decimal" id="php_peff" oninput="calcPumpHP()" placeholder="70" value="70">
                        <span class="field-hint">Typical 60-80%</span>
                    </div>
                    <div>
                        <label>Motor Efficiency (%)</label>
                        <input type="number" inputmode="decimal" id="php_meff" oninput="calcPumpHP()" placeholder="90" value="90">
                        <span class="field-hint">Typical 85-95%</span>
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>Hours/Day Running</label>
                        <input type="number" inputmode="decimal" id="php_hrs" oninput="calcPumpHP()" placeholder="24" value="24">
                        <span class="field-hint">Runtime per day</span>
                    </div>
                    <div>
                        <label>Electric Rate ($/kWh)</label>
                        <input type="number" inputmode="decimal" id="php_rate" oninput="calcPumpHP()" placeholder="0.10" value="0.10">
                        <span class="field-hint">Utility rate</span>
                    </div>
                </div>
                <div class="example-box"><b>TCEQ Formulas:</b> WHP = (GPM Ã— TDH) Ã· 3960 | BHP = WHP Ã· Pump Eff | Motor HP = BHP Ã· Motor Eff | kW = HP Ã— 0.746</div>
                <div class="result-box">
                    <span class="val" id="php_res">â€”</span>
                    <div id="php_status" class="status">Enter flow and TDH...</div>
                    <button class="btn-copy" onclick="copyVal('php_res')">Copy Result</button>
                </div>
                <div id="php_detail" style="display:none;margin-top:10px;padding:12px;background:#0f172a;border-radius:8px;font-size:0.8rem;color:#cbd5e1;"></div>
                <div class="formula-note">WHP = (GPM Ã— TDH) Ã· 3960 | BHP = WHP Ã· Î·<sub>pump</sub></div>
                <div class="see-also">See also: <a onclick="goToCard(46)">#46 TDH</a> Â· <a onclick="goToCard(48)">#48 Pipe Velocity</a></div>
            </div>
        </div>
    </div>

    <!-- 45. Pipe Velocity -->
    <div class="card" id="card48" data-calc="pipev" style="border-left-color: #3b82f6;">
        <div class="card-header" onclick="toggleCard(48)">
            <h2><span class="card-num" style="background: #3b82f6;">48</span> Pipe Velocity</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #3b82f6;">Calculate flow velocity from flow rate and pipe diameter. Flags settling (&lt;2 fps) and scouring (&gt;10 fps) conditions.</div>
                <div class="grid">
                    <div>
                        <label>Flow (GPM)</label>
                        <input type="number" inputmode="decimal" id="pv_flow" oninput="calcPV()" placeholder="500">
                        <span class="field-hint">Pump or pipe flow</span>
                    </div>
                    <div>
                        <label>Pipe Diameter (inches)</label>
                        <input type="number" inputmode="decimal" id="pv_dia" oninput="calcPV()" placeholder="8">
                        <span class="field-hint">Internal diameter</span>
                    </div>
                </div>
                <div class="example-box"><b>Velocity Targets:</b> Gravity sewer: 2â€“10 fps | Force main: 3â€“8 fps | Suction pipe: 3â€“6 fps | &lt;2 fps = settling | &gt;10 fps = erosion</div>
                <div class="result-box">
                    <span class="val" id="pv_res">0.0 fps</span>
                    <div id="pv_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('pv_res')">Copy Result</button>
                </div>
                <div class="formula-note">V (fps) = Flow (GPM) Ã— 0.4085 Ã· DiameterÂ² (inÂ²)</div>
            </div>
        </div>
    </div>

    <!-- 46. Horsepower -->
    <div class="card" id="card49" data-calc="hp" style="border-left-color: #3b82f6;">
        <div class="card-header" onclick="toggleCard(49)">
            <h2><span class="card-num" style="background: #3b82f6;">49</span> Horsepower (WHP & BHP)</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #3b82f6;">Calculate water horsepower and brake horsepower from flow, head, and pump efficiency. Used for energy costs and pump selection.</div>
                <div class="grid">
                    <div>
                        <label>Flow (GPM)</label>
                        <input type="number" inputmode="decimal" id="hp_flow" oninput="calcHP()" placeholder="500">
                        <span class="field-hint">Pump flow rate</span>
                    </div>
                    <div>
                        <label>TDH (ft)</label>
                        <input type="number" inputmode="decimal" id="hp_tdh" oninput="calcHP()" placeholder="35">
                        <span class="field-hint">Total dynamic head</span>
                    </div>
                    <div>
                        <label>Pump Efficiency (%)</label>
                        <input type="number" inputmode="decimal" id="hp_eff" oninput="calcHP()" placeholder="75">
                        <span class="field-hint">From pump curve: 60â€“85%</span>
                    </div>
                    <div>
                        <label>Motor Efficiency (%)</label>
                        <input type="number" inputmode="decimal" id="hp_meff" oninput="calcHP()" placeholder="90">
                        <span class="field-hint">Typical: 85â€“95%</span>
                    </div>
                </div>
                <div class="example-box"><b>Formulas:</b> WHP = (Flow Ã— TDH) Ã· 3960 | BHP = WHP Ã· Pump Eff | MHP = BHP Ã· Motor Eff | 1 HP = 0.746 kW</div>
                <div class="result-box">
                    <span class="val" id="hp_res">â€”</span>
                    <div id="hp_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('hp_res')">Copy Result</button>
                </div>
                <div class="formula-note">WHP = (GPM Ã— TDH) Ã· 3960 | BHP = WHP Ã· Efficiency</div>
            </div>
        </div>
    </div>

    <!-- ========== COMPLIANCE & REPORTING SECTION ========== -->
    <div class="section-header" data-cat="compliance" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(249, 115, 22, 0.15); border-radius: 8px; border-left: 4px solid #f97316; font-size: 0.85rem; color: #fb923c; font-weight: bold;">ðŸ“‹ Compliance & Reporting Calculators</div>

    <!-- 47. Geometric Mean -->
    <div class="card" id="card50" data-calc="geomean" style="border-left-color: #f97316;">
        <div class="card-header" onclick="toggleCard(50)">
            <h2><span class="card-num" style="background: #f97316;">50</span> Geometric Mean</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #f97316;">Calculate geometric mean for E. coli or fecal coliform DMR reporting. TCEQ requires geometric mean â€” not arithmetic mean. Operators frequently get this wrong.</div>
                <div class="grid">
                    <div>
                        <label>Sample 1</label>
                        <input type="number" inputmode="decimal" id="gm_s1" oninput="calcGM()" placeholder="50">
                    </div>
                    <div>
                        <label>Sample 2</label>
                        <input type="number" inputmode="decimal" id="gm_s2" oninput="calcGM()" placeholder="120">
                    </div>
                    <div>
                        <label>Sample 3</label>
                        <input type="number" inputmode="decimal" id="gm_s3" oninput="calcGM()" placeholder="30">
                    </div>
                    <div>
                        <label>Sample 4</label>
                        <input type="number" inputmode="decimal" id="gm_s4" oninput="calcGM()" placeholder="">
                        <span class="field-hint">Optional</span>
                    </div>
                    <div>
                        <label>Sample 5</label>
                        <input type="number" inputmode="decimal" id="gm_s5" oninput="calcGM()" placeholder="">
                        <span class="field-hint">Optional</span>
                    </div>
                    <div>
                        <label>Sample 6</label>
                        <input type="number" inputmode="decimal" id="gm_s6" oninput="calcGM()" placeholder="">
                        <span class="field-hint">Optional</span>
                    </div>
                    <div>
                        <label>Sample 7</label>
                        <input type="number" inputmode="decimal" id="gm_s7" oninput="calcGM()" placeholder="">
                        <span class="field-hint">Optional</span>
                    </div>
                </div>
                <div class="example-box"><b>TCEQ Limits:</b> E. coli: 126 CFU/100mL (geomean) / 399 single | Fecal: 200 CFU/100mL (geomean) / 400 single</div>
                <div class="result-box">
                    <span class="val" id="gm_res">â€”</span>
                    <div id="gm_status" class="status">Enter at least 2 samples...</div>
                    <button class="btn-copy" onclick="copyVal('gm_res')">Copy Result</button>
                </div>
                <div class="formula-note">Geomean = (S1 Ã— S2 Ã— ... Ã— Sn) ^ (1/n)</div>
            </div>
        </div>
    </div>

    <!-- 48. Flow-Weighted Composite -->
    <div class="card" id="card51" data-calc="fwc" style="border-left-color: #f97316;">
        <div class="card-header" onclick="toggleCard(51)">
            <h2><span class="card-num" style="background: #f97316;">51</span> Flow-Weighted Composite</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #f97316;">Calculate flow-proportional average concentration from grab samples at different flows. Required for accurate DMR reporting at many plants.</div>
                <div class="grid">
                    <div>
                        <label>Flow 1 (MGD)</label>
                        <input type="number" inputmode="decimal" id="fw_f1" oninput="calcFWC()" placeholder="1.2">
                    </div>
                    <div>
                        <label>Conc 1 (mg/L)</label>
                        <input type="number" inputmode="decimal" id="fw_c1" oninput="calcFWC()" placeholder="15">
                    </div>
                    <div>
                        <label>Flow 2 (MGD)</label>
                        <input type="number" inputmode="decimal" id="fw_f2" oninput="calcFWC()" placeholder="1.8">
                    </div>
                    <div>
                        <label>Conc 2 (mg/L)</label>
                        <input type="number" inputmode="decimal" id="fw_c2" oninput="calcFWC()" placeholder="20">
                    </div>
                    <div>
                        <label>Flow 3 (MGD)</label>
                        <input type="number" inputmode="decimal" id="fw_f3" oninput="calcFWC()" placeholder="1.0">
                        <span class="field-hint">Optional</span>
                    </div>
                    <div>
                        <label>Conc 3 (mg/L)</label>
                        <input type="number" inputmode="decimal" id="fw_c3" oninput="calcFWC()" placeholder="12">
                        <span class="field-hint">Optional</span>
                    </div>
                    <div>
                        <label>Flow 4 (MGD)</label>
                        <input type="number" inputmode="decimal" id="fw_f4" oninput="calcFWC()" placeholder="">
                        <span class="field-hint">Optional</span>
                    </div>
                    <div>
                        <label>Conc 4 (mg/L)</label>
                        <input type="number" inputmode="decimal" id="fw_c4" oninput="calcFWC()" placeholder="">
                        <span class="field-hint">Optional</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="fw_res">â€”</span>
                    <div id="fw_status" class="status">Enter at least 2 flow-concentration pairs...</div>
                    <button class="btn-copy" onclick="copyVal('fw_res')">Copy Result</button>
                </div>
                <div class="formula-note">FW Avg = Î£(Flow Ã— Conc) Ã· Î£(Flow)</div>
            </div>
        </div>
    </div>

    <!-- ========== QUICK CONVERSIONS SECTION ========== -->
    <div class="section-header" data-cat="convert" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(148, 163, 184, 0.15); border-radius: 8px; border-left: 4px solid #94a3b8; font-size: 0.85rem; color: #cbd5e1; font-weight: bold;">ðŸ”„ Quick Conversions</div>

    <!-- 49. Unit Converter -->
    <div class="card" id="card52" data-calc="convert" style="border-left-color: #94a3b8;">
        <div class="card-header" onclick="toggleCard(52)">
            <h2><span class="card-num" style="background: #94a3b8;">52</span> Unit Converter</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Enter a value in any field to convert. One-stop conversion for common wastewater units.</div>
                <div style="font-size:0.8rem;color:#94a3b8;margin-bottom:8px;font-weight:bold;">â”â” Flow â”â”</div>
                <div class="grid">
                    <div>
                        <label>GPM</label>
                        <input type="number" inputmode="decimal" id="uc_gpm" oninput="calcUC('gpm')" placeholder="GPM">
                    </div>
                    <div>
                        <label>MGD</label>
                        <input type="number" inputmode="decimal" id="uc_mgd" oninput="calcUC('mgd')" placeholder="MGD">
                    </div>
                    <div>
                        <label>CFS</label>
                        <input type="number" inputmode="decimal" id="uc_cfs" oninput="calcUC('cfs')" placeholder="ftÂ³/sec">
                    </div>
                    <div>
                        <label>mÂ³/day</label>
                        <input type="number" inputmode="decimal" id="uc_m3d" oninput="calcUC('m3d')" placeholder="mÂ³/day">
                    </div>
                </div>
                <div style="font-size:0.8rem;color:#94a3b8;margin-bottom:8px;font-weight:bold;">â”â” Volume â”â”</div>
                <div class="grid">
                    <div>
                        <label>Gallons</label>
                        <input type="number" inputmode="decimal" id="uc_gal" oninput="calcUC('gal')" placeholder="gal">
                    </div>
                    <div>
                        <label>ftÂ³</label>
                        <input type="number" inputmode="decimal" id="uc_ft3" oninput="calcUC('ft3')" placeholder="ftÂ³">
                    </div>
                    <div>
                        <label>mÂ³</label>
                        <input type="number" inputmode="decimal" id="uc_m3" oninput="calcUC('m3')" placeholder="mÂ³">
                    </div>
                    <div>
                        <label>Acre-ft</label>
                        <input type="number" inputmode="decimal" id="uc_acft" oninput="calcUC('acft')" placeholder="ac-ft">
                    </div>
                </div>
                <div style="font-size:0.8rem;color:#94a3b8;margin-bottom:8px;font-weight:bold;">â”â” Pressure â”â”</div>
                <div class="grid">
                    <div>
                        <label>PSI</label>
                        <input type="number" inputmode="decimal" id="uc_psi" oninput="calcUC('psi')" placeholder="psi">
                    </div>
                    <div>
                        <label>ft Hâ‚‚O</label>
                        <input type="number" inputmode="decimal" id="uc_fth2o" oninput="calcUC('fth2o')" placeholder="ft Hâ‚‚O">
                    </div>
                    <div>
                        <label>kPa</label>
                        <input type="number" inputmode="decimal" id="uc_kpa" oninput="calcUC('kpa')" placeholder="kPa">
                    </div>
                </div>
                <div class="result-box">
                    <div id="uc_status" class="status" style="text-align:center;color:#94a3b8;">Enter a value in any field to convert</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== COLLECTION SYSTEMS SECTION ========== -->
    <div class="section-header" data-cat="collection" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(251, 146, 60, 0.15); border-radius: 8px; border-left: 4px solid #fb923c; font-size: 0.85rem; color: #fdba74; font-weight: bold;">ðŸ”§ Collection Systems Calculators</div>

    <!-- 50. Manning's Equation -->
    <div class="card" id="card53" data-calc="manning" style="border-left-color: #fb923c;">
        <div class="card-header" onclick="toggleCard(53)">
            <h2><span class="card-num" style="background: #fb923c;">53</span> Manning's Equation</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #fb923c;">Calculate gravity sewer flow from pipe slope, diameter, and roughness. The most tested collection system formula on every TCEQ exam level.</div>

                <div style="margin-bottom:10px;">
                    <button onclick="document.getElementById('mann_guide').style.display = document.getElementById('mann_guide').style.display === 'none' ? 'block' : 'none'; this.innerText = document.getElementById('mann_guide').style.display === 'none' ? 'ðŸ“– How to Use â–¸' : 'ðŸ“– How to Use â–¾'" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid #fb923c;background:rgba(251,146,60,0.08);color:#fdba74;font-weight:bold;font-size:0.82rem;cursor:pointer;text-align:left;">ðŸ“– How to Use â–¸</button>
                    <div id="mann_guide" style="display:none;margin-top:8px;background:#0c1222;border:1px solid #334155;border-radius:8px;padding:14px;font-size:0.8rem;color:#cbd5e1;line-height:1.7;">
                        <div style="color:#fdba74;font-weight:bold;font-size:0.85rem;margin-bottom:8px;">MANNING'S EQUATION â€” OPERATOR GUIDE</div>

                        <div style="color:#f8fafc;font-weight:bold;">What This Calculates</div>
                        Manning's equation calculates the velocity and flow rate in a gravity sewer pipe flowing full. It's the foundation of collection system design â€” how fast wastewater moves through your pipes and how much they can carry. This is the single most-tested collection system formula on TCEQ exams at every level.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Inputs Explained</div>
                        <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                            <b>Diameter (inches)</b> â€” Inside pipe diameter. Common gravity sewer: 8" (residential lateral), 10â€“12" (collector), 15â€“24" (trunk), 30"+ (interceptor). Minimum per TCEQ: 8" for public sewers.<br>
                            <b>Slope (ft/ft)</b> â€” Pipe grade as a decimal. Example: 0.5% slope = 0.005 ft/ft. A pipe dropping 1 foot over 200 feet = 1/200 = 0.005. Get from as-builts or survey. TCEQ minimum slopes: 8" pipe = 0.0040, 10" = 0.0028, 12" = 0.0022.<br>
                            <b>Manning's n</b> â€” Roughness coefficient. Lower n = smoother pipe = faster flow. PVC/HDPE: 0.010â€“0.013. New concrete: 0.013. Old concrete/clay: 0.013â€“0.015. Corrugated metal: 0.022â€“0.025. Use 0.013 on TCEQ exams unless told otherwise.
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Understanding Velocity Flags</div>
                        <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                            <b style="color:#4ade80;">2â€“10 fps: Good range</b> â€” Self-cleansing velocity without pipe damage.<br>
                            <b style="color:#fbbf24;">&lt;2 fps: Too slow</b> â€” Solids settle out â†’ blockages, Hâ‚‚S generation, odors. Increase slope or decrease pipe size to raise velocity.<br>
                            <b style="color:#ef4444;">&gt;10 fps: Too fast</b> â€” Pipe erosion, joint damage, manhole erosion. Use drop manholes or energy dissipation. Some agencies allow up to 15 fps with reinforced pipe.
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">TCEQ Exam Tips</div>
                        <div style="background:rgba(251,146,60,0.1);border-radius:6px;padding:8px 10px;margin:4px 0;border-left:3px solid #fb923c;">
                            â€¢ <b>V = (1.486/n) Ã— R^(2/3) Ã— S^(1/2)</b> â€” memorize this<br>
                            â€¢ For a full pipe: R (hydraulic radius) = D/4 (diameter in feet Ã· 4)<br>
                            â€¢ Q = V Ã— A â€” flow = velocity Ã— cross-sectional area<br>
                            â€¢ Area of circle: A = Ï€ Ã— rÂ² = Ï€/4 Ã— DÂ² (D in feet!)<br>
                            â€¢ <b>Unit trap:</b> Diameter is almost always given in inches â€” convert to feet first (Ã· 12)<br>
                            â€¢ <b>Minimum velocity:</b> 2.0 fps (self-cleansing). They love asking this.<br>
                            â€¢ <b>Default n:</b> Use 0.013 unless the problem specifies otherwise<br>
                            â€¢ To convert CFS to GPM: Ã— 448.83 | To MGD: Ã— 0.6463
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Example</div>
                        <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                            12" pipe at 0.5% slope (0.005 ft/ft), n=0.013:<br>
                            R = (12/12)/4 = 0.25 ft<br>
                            V = (1.486/0.013) Ã— 0.25^0.667 Ã— 0.005^0.5 = 114.3 Ã— 0.397 Ã— 0.0707 = <b>3.21 fps</b> âœ“<br>
                            A = Ï€/4 Ã— 1Â² = 0.785 ftÂ²<br>
                            Q = 3.21 Ã— 0.785 = 2.52 CFS = <b>1,131 GPM</b>
                        </div>
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>Pipe Diameter (inches)</label>
                        <input type="number" inputmode="decimal" id="man_dia" oninput="calcManning()" placeholder="12">
                        <span class="field-hint">Internal diameter</span>
                    </div>
                    <div>
                        <label>Slope (ft/ft)</label>
                        <input type="number" inputmode="decimal" id="man_slope" oninput="calcManning()" placeholder="0.005">
                        <span class="field-hint">Rise Ã· Run (e.g. 0.005)</span>
                    </div>
                    <div>
                        <label>Manning's n</label>
                        <input type="number" inputmode="decimal" id="man_n" oninput="calcManning()" placeholder="0.013">
                        <span class="field-hint">PVC: 0.010 | Concrete: 0.013</span>
                    </div>
                </div>
                <div class="example-box"><b>n values:</b> PVC/HDPE: 0.010 | New concrete: 0.012 | Old concrete: 0.013â€“0.015 | Clay/VCP: 0.013 | Corrugated metal: 0.024</div>
                <div class="result-box">
                    <span class="val" id="man_res">â€”</span>
                    <div id="man_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('man_res')">Copy Result</button>
                </div>
                <div class="formula-note">V = (1.486/n) Ã— R^(2/3) Ã— S^(1/2) | Q = V Ã— A | Full pipe: R = D/4</div>
            </div>
        </div>
    </div>

    <!-- 51. Wet Well Sizing -->
    <div class="card" id="card54" data-calc="wetwell" style="border-left-color: #fb923c;">
        <div class="card-header" onclick="toggleCard(54)">
            <h2><span class="card-num" style="background: #fb923c;">54</span> Wet Well Sizing</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #fb923c;">Calculate required wet well volume from pump capacity and cycle time. Undersized wet wells cause short-cycling and premature pump failure.</div>
                <div class="grid">
                    <div>
                        <label>Pump Capacity (GPM)</label>
                        <input type="number" inputmode="decimal" id="ww_pump" oninput="calcWetWell()" placeholder="500">
                        <span class="field-hint">Single pump flow rate</span>
                    </div>
                    <div>
                        <label>Inflow Rate (GPM)</label>
                        <input type="number" inputmode="decimal" id="ww_inflow" oninput="calcWetWell()" placeholder="200">
                        <span class="field-hint">Average incoming flow</span>
                    </div>
                    <div>
                        <label>Min Cycle Time (min)</label>
                        <input type="number" inputmode="decimal" id="ww_cycle" oninput="calcWetWell()" placeholder="10">
                        <span class="field-hint">Typical: 10â€“15 min minimum</span>
                    </div>
                </div>
                <div class="example-box"><b>Design Rules:</b> Min cycle = 10 min (most manufacturers) | V = T Ã— Q_pump Ã· 4 (for constant speed) | Short cycling wears seals, overheats motors</div>
                <div class="result-box">
                    <span class="val" id="ww_res">â€”</span>
                    <div id="ww_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('ww_res')">Copy Result</button>
                </div>
                <div class="formula-note">V = (T Ã— Q_pump) Ã· 4 | Fill time = V Ã· Inflow | Pump-down = V Ã· (Pump âˆ’ Inflow)</div>
            </div>
        </div>
    </div>

    <!-- 52. Infiltration & Inflow -->
    <div class="card" id="card55" data-calc="ii" style="border-left-color: #fb923c;">
        <div class="card-header" onclick="toggleCard(55)">
            <h2><span class="card-num" style="background: #fb923c;">55</span> Infiltration & Inflow (I/I)</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #fb923c;">Calculate infiltration/inflow rate from dry vs wet weather flow. Expressed as GPD per inch-diameter per mile. TCEQ exam staple and major compliance issue in aging Texas systems.</div>
                <div class="grid">
                    <div>
                        <label>Wet Weather Flow (GPD)</label>
                        <input type="number" inputmode="decimal" id="ii_wet" oninput="calcII()" placeholder="750000">
                        <span class="field-hint">Peak wet weather daily flow</span>
                    </div>
                    <div>
                        <label>Dry Weather Flow (GPD)</label>
                        <input type="number" inputmode="decimal" id="ii_dry" oninput="calcII()" placeholder="500000">
                        <span class="field-hint">Average dry weather flow</span>
                    </div>
                    <div>
                        <label>Pipe Diameter (inches)</label>
                        <input type="number" inputmode="decimal" id="ii_dia" oninput="calcII()" placeholder="8">
                        <span class="field-hint">Sewer pipe diameter</span>
                    </div>
                    <div>
                        <label>Pipe Length (miles)</label>
                        <input type="number" inputmode="decimal" id="ii_miles" oninput="calcII()" placeholder="5">
                        <span class="field-hint">Collection system length</span>
                    </div>
                </div>
                <div class="example-box"><b>I/I Limits:</b> TCEQ concern: &gt;500 GPD/inch-mile | Excessive: &gt;1,000 | Typical target: &lt;500 GPD/inch-mile</div>
                <div class="result-box">
                    <span class="val" id="ii_res">â€”</span>
                    <div id="ii_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('ii_res')">Copy Result</button>
                </div>
                <div class="formula-note">I/I = (Wet âˆ’ Dry) Ã· (Diameter Ã— Miles) GPD/inch-mile</div>
            </div>
        </div>
    </div>

    <!-- 53. Force Main Friction Loss -->
    <div class="card" id="card56" data-calc="hazen" style="border-left-color: #fb923c;">
        <div class="card-header" onclick="toggleCard(56)">
            <h2><span class="card-num" style="background: #fb923c;">56</span> Force Main Friction Loss</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #fb923c;">Hazen-Williams headloss in pressure pipes. Feeds directly into TDH calc (#44). Every lift station design uses this.</div>
                <div class="grid">
                    <div>
                        <label>Flow (GPM)</label>
                        <input type="number" inputmode="decimal" id="hz_flow" oninput="calcHazen()" placeholder="500">
                        <span class="field-hint">Pump flow rate</span>
                    </div>
                    <div>
                        <label>C-Factor</label>
                        <input type="number" inputmode="decimal" id="hz_c" oninput="calcHazen()" placeholder="120">
                        <span class="field-hint">PVC: 150 | DI: 130 | Old CI: 100</span>
                    </div>
                    <div>
                        <label>Pipe Diameter (inches)</label>
                        <input type="number" inputmode="decimal" id="hz_dia" oninput="calcHazen()" placeholder="8">
                        <span class="field-hint">Internal diameter</span>
                    </div>
                    <div>
                        <label>Pipe Length (ft)</label>
                        <input type="number" inputmode="decimal" id="hz_len" oninput="calcHazen()" placeholder="2000">
                        <span class="field-hint">Total force main length</span>
                    </div>
                </div>
                <div class="example-box"><b>C values:</b> New PVC/HDPE: 150 | New DI: 130 | Old cast iron: 100 | Concrete: 120 | Add 10â€“15% for fittings</div>
                <div class="result-box">
                    <span class="val" id="hz_res">â€”</span>
                    <div id="hz_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('hz_res')">Copy Result</button>
                </div>
                <div class="formula-note">hf = (4.52 Ã— Q^1.85) Ã· (C^1.85 Ã— D^4.87) Ã— L (ft per 100ft Ã— length)</div>
            </div>
        </div>
    </div>

    <!-- ========== FLOW MEASUREMENT SECTION ========== -->
    <div class="section-header" data-cat="flow" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(56, 189, 248, 0.15); border-radius: 8px; border-left: 4px solid #38bdf8; font-size: 0.85rem; color: #7dd3fc; font-weight: bold;">ðŸ“ Flow Measurement Calculators</div>

    <!-- 54. Weir Flow -->
    <div class="card" id="card57" data-calc="weir" style="border-left-color: #38bdf8;">
        <div class="card-header" onclick="toggleCard(57)">
            <h2><span class="card-num" style="background: #38bdf8;">57</span> Weir Flow</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #38bdf8;">Calculate flow over rectangular, V-notch (90Â°), or Cipolletti weirs. On every single TCEQ exam at every level.</div>
                <div class="grid">
                    <div>
                        <label>Weir Type</label>
                        <select id="weir_type" oninput="calcWeir()" style="width:100%;padding:10px;border-radius:6px;border:1px solid #475569;background:#0f172a;color:#f8fafc;font-size:0.95rem;">
                            <option value="rect">Rectangular (no contractions)</option>
                            <option value="rect_c">Rectangular (contracted)</option>
                            <option value="vnot">V-Notch 90Â°</option>
                            <option value="cip">Cipolletti (trapezoidal)</option>
                        </select>
                    </div>
                    <div>
                        <label>Head over Weir (ft)</label>
                        <input type="number" inputmode="decimal" id="weir_h" oninput="calcWeir()" placeholder="0.5">
                        <span class="field-hint">Measured upstream of weir</span>
                    </div>
                    <div>
                        <label>Weir Length (ft)</label>
                        <input type="number" inputmode="decimal" id="weir_l" oninput="calcWeir()" placeholder="3.0">
                        <span class="field-hint">Not needed for V-notch</span>
                    </div>
                </div>
                <div class="example-box"><b>Formulas:</b> Rect: Q = 3.33 Ã— L Ã— H^1.5 | V-notch 90Â°: Q = 2.5 Ã— H^2.5 | Cipolletti: Q = 3.367 Ã— L Ã— H^1.5 | Q in CFS</div>
                <div class="result-box">
                    <span class="val" id="weir_res">â€”</span>
                    <div id="weir_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('weir_res')">Copy Result</button>
                </div>
                <div class="formula-note">Suppressed rect: Q = 3.33LH^1.5 | Contracted: Q = 3.33(Lâˆ’0.2H)H^1.5</div>
            </div>
        </div>
    </div>

    <!-- 55. Area-Velocity Flow -->
    <div class="card" id="card58" data-calc="areavel" style="border-left-color: #38bdf8;">
        <div class="card-header" onclick="toggleCard(58)">
            <h2><span class="card-num" style="background: #38bdf8;">58</span> Area-Velocity Flow</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #38bdf8;">Q = A Ã— V for open channels and pipes. Used for field flow verification with portable meters. Tested constantly on TCEQ exams.</div>
                <div class="grid">
                    <div>
                        <label>Channel Type</label>
                        <select id="av_type" oninput="calcAV()" style="width:100%;padding:10px;border-radius:6px;border:1px solid #475569;background:#0f172a;color:#f8fafc;font-size:0.95rem;">
                            <option value="pipe">Circular Pipe (full)</option>
                            <option value="rect">Rectangular Channel</option>
                        </select>
                    </div>
                    <div>
                        <label>Velocity (fps)</label>
                        <input type="number" inputmode="decimal" id="av_vel" oninput="calcAV()" placeholder="3.0">
                        <span class="field-hint">Measured or calculated</span>
                    </div>
                    <div>
                        <label>Diameter (in) or Width (ft)</label>
                        <input type="number" inputmode="decimal" id="av_dim1" oninput="calcAV()" placeholder="12">
                        <span class="field-hint">Pipe dia (in) or channel width (ft)</span>
                    </div>
                    <div>
                        <label>Depth (ft) â€” rect only</label>
                        <input type="number" inputmode="decimal" id="av_dim2" oninput="calcAV()" placeholder="2.0">
                        <span class="field-hint">Water depth in channel</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="av_res">â€”</span>
                    <div id="av_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('av_res')">Copy Result</button>
                </div>
                <div class="formula-note">Q (CFS) = Area (ftÂ²) Ã— Velocity (fps) | GPM = CFS Ã— 448.83</div>
            </div>
        </div>
    </div>

    <!-- ========== TRICKLING FILTER SECTION ========== -->
    <div class="section-header" data-cat="tf" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(132, 204, 22, 0.15); border-radius: 8px; border-left: 4px solid #84cc16; font-size: 0.85rem; color: #a3e635; font-weight: bold;">ðŸª¨ Trickling Filter Calculators</div>

    <!-- 56. TF Efficiency (NRC) -->
    <div class="card" id="card59" data-calc="nrc" style="border-left-color: #84cc16;">
        <div class="card-header" onclick="toggleCard(59)">
            <h2><span class="card-num" style="background: #84cc16;">59</span> TF Efficiency (NRC) <span class="diagram-badge">DIAGRAM</span></h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #84cc16;">National Research Council equation for single-stage trickling filter BOD removal. Guaranteed TCEQ exam question at Class B and above.</div>

                <div style="margin-bottom:10px;">
                    <button onclick="document.getElementById('nrc_guide').style.display = document.getElementById('nrc_guide').style.display === 'none' ? 'block' : 'none'; this.innerText = document.getElementById('nrc_guide').style.display === 'none' ? 'ðŸ“– How to Use â–¸' : 'ðŸ“– How to Use â–¾'" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid #84cc16;background:rgba(132,204,22,0.08);color:#a3e635;font-weight:bold;font-size:0.82rem;cursor:pointer;text-align:left;">ðŸ“– How to Use â–¸</button>
                    <div id="nrc_guide" style="display:none;margin-top:8px;background:#0c1222;border:1px solid #334155;border-radius:8px;padding:14px;font-size:0.8rem;color:#cbd5e1;line-height:1.7;">
                        <div style="color:#a3e635;font-weight:bold;font-size:0.85rem;margin-bottom:8px;">NRC TRICKLING FILTER EFFICIENCY â€” OPERATOR GUIDE</div>

                        <div style="color:#f8fafc;font-weight:bold;">What This Calculates</div>
                        The NRC (National Research Council) equation predicts BOD removal efficiency for a trickling filter based on organic loading and recirculation. It was developed from WWII-era military installations and is still the standard design equation used by TCEQ. This is a guaranteed exam question at Class B and above.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Inputs Explained</div>
                        <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                            <b>Flow (MGD)</b> â€” Average daily influent flow to the trickling filter (not including recirculation).<br>
                            <b>Influent BOD (mg/L)</b> â€” BOD concentration entering the TF. If there's a primary clarifier upstream, use the primary effluent BOD (typically 60% of raw = ~120 mg/L).<br>
                            <b>Filter Volume (1000 ftÂ³)</b> â€” Total media volume in thousands of cubic feet. A 60 ft diameter Ã— 6 ft deep TF = Ï€/4 Ã— 60Â² Ã— 6 = 16,965 ftÂ³ = 16.965 (enter 16.965). Use Calc #66 for circular volume.<br>
                            <b>Recirculation Ratio (R)</b> â€” Recirculated flow Ã· influent flow. R=0 means no recirculation. R=1 means recirculating equal to influent (2Ã— total flow over the TF). Typical: 0.5â€“2.0.
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">How the NRC Equation Works</div>
                        The equation has two parts:<br>
                        1. <b>W/(VÃ—F)</b> â€” BOD load applied vs filter capacity. W = lbs BOD/day, V = volume in 1000 ftÂ³, F = recirculation factor.<br>
                        2. <b>Recirculation factor F = (1+R)Â² / (1+0.1R)Â²</b> â€” Recirculation improves efficiency by giving organics multiple passes through the biofilm.<br>
                        Higher recirculation â†’ higher F â†’ lower W/(VF) â†’ higher efficiency.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">TCEQ Exam Tips</div>
                        <div style="background:rgba(132,204,22,0.1);border-radius:6px;padding:8px 10px;margin:4px 0;border-left:3px solid #84cc16;">
                            â€¢ <b>E = 1 / [1 + 0.4432 Ã— âˆš(W/(VÃ—F))]</b><br>
                            â€¢ <b>W = Flow (MGD) Ã— BOD (mg/L) Ã— 8.34</b> = lbs BOD/day<br>
                            â€¢ <b>F = (1+R)Â² / (1+0.1R)Â²</b> â€” recirculation factor<br>
                            â€¢ Volume is in <i>thousands</i> of ftÂ³ â€” don't forget to divide by 1000<br>
                            â€¢ Typical efficiency: 65â€“85%. Below 65% means the filter is overloaded or media is clogged<br>
                            â€¢ If they ask "what is the effluent BOD?" â†’ Effluent = Influent Ã— (1 âˆ’ E)<br>
                            â€¢ Common trick: giving you diameter and depth instead of volume â€” calculate V = Ï€/4 Ã— DÂ² Ã— depth first
                        </div>
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>BOD Load (lbs/day)</label>
                        <input type="number" inputmode="decimal" id="nrc_bod" oninput="calcNRC()" placeholder="500">
                        <span class="field-hint">Applied BOD to filter</span>
                    </div>
                    <div>
                        <label>Filter Volume (1000 ftÂ³)</label>
                        <input type="number" inputmode="decimal" id="nrc_vol" oninput="calcNRC()" placeholder="20">
                        <span class="field-hint">In thousands of ftÂ³</span>
                    </div>
                    <div>
                        <label>Recirculation Ratio</label>
                        <input type="number" inputmode="decimal" id="nrc_recirc" oninput="calcNRC()" placeholder="1.0">
                        <span class="field-hint">R = recirc flow Ã· influent flow</span>
                    </div>
                </div>
                <div class="example-box"><b>NRC:</b> E = 1 Ã· [1 + 0.4432 Ã— âˆš(W/VF)] | F = (1+R) Ã· (1+0.1R)Â² | W = BOD lbs/day | V = 1000 ftÂ³ | Typical: 65â€“85% removal</div>
                <div class="result-box">
                    <span class="val" id="nrc_res">â€”</span>
                    <div id="nrc_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('nrc_res')">Copy Result</button>
                </div>
                <div class="formula-note">E = 1 Ã· [1 + 0.4432 Ã— âˆš(W Ã· (V Ã— F))] Ã— 100</div>
                <button class="diagram-toggle" onclick="toggleDiagram(59,'trickling_filter')">ðŸ“Š Show Trickling Filter Diagram</button>
            </div>
        </div>
    </div>

    <!-- 57. TF Hydraulic Loading -->
    <div class="card" id="card60" data-calc="tflr" style="border-left-color: #84cc16;">
        <div class="card-header" onclick="toggleCard(60)">
            <h2><span class="card-num" style="background: #84cc16;">60</span> TF Hydraulic Loading</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #84cc16;">GPD/ftÂ² applied to filter surface. Determines filter classification: low-rate, standard, high-rate, super-high-rate.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="tfl_flow" oninput="calcTFL()" placeholder="1.0">
                        <span class="field-hint">Including recirculation</span>
                    </div>
                    <div>
                        <label>Filter Diameter (ft)</label>
                        <input type="number" inputmode="decimal" id="tfl_dia" oninput="calcTFL()" placeholder="60">
                        <span class="field-hint">Circular filter</span>
                    </div>
                    <div>
                        <label>Influent BOD (mg/L)</label>
                        <input type="number" inputmode="decimal" id="tfl_bod" oninput="calcTFL()" placeholder="150">
                        <span class="field-hint">For organic loading check</span>
                    </div>
                    <div>
                        <label>Filter Depth (ft)</label>
                        <input type="number" inputmode="decimal" id="tfl_depth" oninput="calcTFL()" placeholder="6">
                        <span class="field-hint">Media depth</span>
                    </div>
                </div>
                <div class="example-box"><b>Classifications:</b> Low-rate: 25â€“100 GPD/ftÂ² | Standard: 100â€“300 | High-rate: 300â€“1000 | Super-high: 1000â€“2000</div>
                <div class="result-box">
                    <span class="val" id="tfl_res">â€”</span>
                    <div id="tfl_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('tfl_res')">Copy Result</button>
                </div>
                <div class="formula-note">Hyd Load = Flow (GPD) Ã· Filter Area (ftÂ²) | Org Load = BOD lbs/day Ã· Volume (1000 ftÂ³)</div>
            </div>
        </div>
    </div>

    <!-- ========== LAGOONS SECTION ========== -->
    <div class="section-header" data-cat="lagoon" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(45, 212, 191, 0.15); border-radius: 8px; border-left: 4px solid #2dd4bf; font-size: 0.85rem; color: #5eead4; font-weight: bold;">ðŸŒŠ Lagoon & Pond Calculators</div>

    <!-- 58. Pond BOD Loading -->
    <div class="card" id="card61" data-calc="pond" style="border-left-color: #2dd4bf;">
        <div class="card-header" onclick="toggleCard(61)">
            <h2><span class="card-num" style="background: #2dd4bf;">61</span> Pond BOD Loading</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #2dd4bf;">Calculate lbs BOD/acre/day for waste stabilization ponds. Primary design parameter. Overloading causes odor complaints and TCEQ violations.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="pnd_flow" oninput="calcPond()" placeholder="0.5">
                        <span class="field-hint">Average daily flow</span>
                    </div>
                    <div>
                        <label>BOD (mg/L)</label>
                        <input type="number" inputmode="decimal" id="pnd_bod" oninput="calcPond()" placeholder="200">
                        <span class="field-hint">Influent BOD</span>
                    </div>
                    <div>
                        <label>Pond Area (acres)</label>
                        <input type="number" inputmode="decimal" id="pnd_acres" oninput="calcPond()" placeholder="20">
                        <span class="field-hint">Water surface area</span>
                    </div>
                    <div>
                        <label>Pond Depth (ft)</label>
                        <input type="number" inputmode="decimal" id="pnd_depth" oninput="calcPond()" placeholder="5">
                        <span class="field-hint">Average operating depth</span>
                    </div>
                </div>
                <div class="example-box"><b>Texas Limits:</b> Facultative: 35â€“50 lbs BOD/acre/day | Aerated: 50â€“200+ | HRT: 90â€“180 days typical | Depth: 3â€“8 ft</div>
                <div class="result-box">
                    <span class="val" id="pnd_res">â€”</span>
                    <div id="pnd_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('pnd_res')">Copy Result</button>
                </div>
                <div class="formula-note">Loading = (Flow Ã— BOD Ã— 8.34) Ã· Acres | HRT = (Acres Ã— 43,560 Ã— Depth Ã— 7.48) Ã· (Flow Ã— 1,000,000)</div>
            </div>
        </div>
    </div>

    <!-- ========== AERATION SECTION ========== -->
    <div class="section-header" data-cat="aeration" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(129, 140, 248, 0.15); border-radius: 8px; border-left: 4px solid #818cf8; font-size: 0.85rem; color: #a5b4fc; font-weight: bold;">ðŸ’¨ Aeration Calculators</div>

    <!-- 59. SOTR to AOTR -->
    <div class="card" id="card62" data-calc="aotr" style="border-left-color: #818cf8;">
        <div class="card-header" onclick="toggleCard(62)">
            <h2><span class="card-num" style="background: #818cf8;">62</span> SOTR â†’ AOTR</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #818cf8;">Convert manufacturer's Standard Oxygen Transfer Rate to Actual conditions using alpha, beta, temperature, altitude, and operating DO. This is how you actually size blowers.</div>

                <div style="margin-bottom:10px;">
                    <button onclick="document.getElementById('aotr_guide').style.display = document.getElementById('aotr_guide').style.display === 'none' ? 'block' : 'none'; this.innerText = document.getElementById('aotr_guide').style.display === 'none' ? 'ðŸ“– How to Use â–¸' : 'ðŸ“– How to Use â–¾'" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid #818cf8;background:rgba(129,140,248,0.08);color:#a5b4fc;font-weight:bold;font-size:0.82rem;cursor:pointer;text-align:left;">ðŸ“– How to Use â–¸</button>
                    <div id="aotr_guide" style="display:none;margin-top:8px;background:#0c1222;border:1px solid #334155;border-radius:8px;padding:14px;font-size:0.8rem;color:#cbd5e1;line-height:1.7;">
                        <div style="color:#a5b4fc;font-weight:bold;font-size:0.85rem;margin-bottom:8px;">SOTR TO AOTR â€” OPERATOR GUIDE</div>

                        <div style="color:#f8fafc;font-weight:bold;">Why This Conversion Matters</div>
                        Manufacturers rate their aeration equipment under <b>standard conditions</b>: clean water, 20Â°C, zero DO, sea level. Your plant operates in wastewater at a different temperature, with dissolved solids, at some DO setpoint, and possibly at altitude. The AOTR (Actual Oxygen Transfer Rate) is always <i>lower</i> than SOTR â€” often 40â€“60% of the manufacturer's number. If you size blowers using SOTR, you'll be undersized.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Inputs Explained</div>
                        <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                            <b>SOTR (lbs Oâ‚‚/hr)</b> â€” From the manufacturer's spec sheet or performance test. This is the clean-water rating.<br>
                            <b>Alpha (Î±)</b> â€” Wastewater correction factor. Accounts for surfactants and contaminants that reduce Oâ‚‚ transfer. Range: 0.4â€“0.8. Use 0.5 for fine bubble diffusers in typical municipal WW, 0.6â€“0.8 for coarse bubble. Lower Î± = dirtier wastewater.<br>
                            <b>Beta (Î²)</b> â€” Salinity/dissolved solids correction. Reduces Oâ‚‚ saturation. Range: 0.90â€“0.98. Use 0.95 for typical municipal. Lower for industrial/saline waste.<br>
                            <b>Temperature (Â°C)</b> â€” Mixed liquor temperature. Higher temp = less dissolved Oâ‚‚ capacity but faster biological rates. Houston summer: 28â€“32Â°C. Winter: 15â€“18Â°C.<br>
                            <b>Operating DO (mg/L)</b> â€” Your basin DO setpoint. Typical CAS: 2.0 mg/L. MBR: 1.0â€“2.0. Nitrification: â‰¥2.0. Higher DO = less driving force = less transfer.<br>
                            <b>Altitude (ft)</b> â€” Elevation above sea level. Higher altitude = lower atmospheric pressure = lower Oâ‚‚ saturation. Houston: ~50 ft (negligible). Denver: 5,280 ft (significant correction).
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Reading the Results</div>
                        The <b>AOTR/SOTR ratio</b> tells you what fraction of the manufacturer's rating you actually get. Typical: 30â€“60%. If your ratio is below 30%, double-check your alpha and temperature â€” something may be wrong with your wastewater characteristics or you have an industrial slug.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">TCEQ Exam Tips</div>
                        <div style="background:rgba(129,140,248,0.1);border-radius:6px;padding:8px 10px;margin:4px 0;border-left:3px solid #818cf8;">
                            â€¢ <b>AOTR = SOTR Ã— Î± Ã— [(Î² Ã— Cs_T âˆ’ DO) / Cs_20] Ã— Î¸^(Tâˆ’20)</b><br>
                            â€¢ Î¸ (theta) = 1.024 â€” temperature correction constant. Memorize this.<br>
                            â€¢ Cs_20 = 9.09 mg/L (Oâ‚‚ saturation at 20Â°C, sea level)<br>
                            â€¢ Î± always makes AOTR smaller (Î± &lt; 1)<br>
                            â€¢ Higher operating DO â†’ smaller driving force â†’ less transfer<br>
                            â€¢ This calc feeds directly into Blower Air Requirement (Calc #65)
                        </div>
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>SOTR (lbs Oâ‚‚/hr)</label>
                        <input type="number" inputmode="decimal" id="ao_sotr" oninput="calcAOTR()" placeholder="100">
                        <span class="field-hint">From manufacturer specs</span>
                    </div>
                    <div>
                        <label>Alpha (Î±)</label>
                        <input type="number" inputmode="decimal" id="ao_alpha" oninput="calcAOTR()" placeholder="0.6">
                        <span class="field-hint">Wastewater factor: 0.4â€“0.8</span>
                    </div>
                    <div>
                        <label>Beta (Î²)</label>
                        <input type="number" inputmode="decimal" id="ao_beta" oninput="calcAOTR()" placeholder="0.95">
                        <span class="field-hint">Salinity factor: 0.90â€“0.98</span>
                    </div>
                    <div>
                        <label>Temperature (Â°C)</label>
                        <input type="number" inputmode="decimal" id="ao_temp" oninput="calcAOTR()" placeholder="25">
                        <span class="field-hint">Wastewater temperature</span>
                    </div>
                    <div>
                        <label>Operating DO (mg/L)</label>
                        <input type="number" inputmode="decimal" id="ao_do" oninput="calcAOTR()" placeholder="2.0">
                        <span class="field-hint">Target basin DO</span>
                    </div>
                    <div>
                        <label>Altitude (ft)</label>
                        <input type="number" inputmode="decimal" id="ao_alt" oninput="calcAOTR()" placeholder="50">
                        <span class="field-hint">Houston â‰ˆ 50 ft</span>
                    </div>
                </div>
                <div class="example-box"><b>Corrections:</b> Î±: fine bubble 0.5â€“0.7, coarse 0.6â€“0.9 | Î²: municipal 0.95â€“0.98, industrial 0.80â€“0.95 | CS at 20Â°C = 9.09 mg/L</div>
                <div class="result-box">
                    <span class="val" id="ao_res">â€”</span>
                    <div id="ao_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('ao_res')">Copy Result</button>
                </div>
                <div class="formula-note">AOTR = SOTR Ã— Î± Ã— [(Î² Ã— CS_alt Ã— Î¸^(T-20) âˆ’ DO) Ã· CS_20] | Î¸ = 1.024</div>
            </div>
        </div>
    </div>

    <!-- ========== RECEIVING WATER SECTION ========== -->
    <div class="section-header" data-cat="receiving" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(236, 72, 153, 0.15); border-radius: 8px; border-left: 4px solid #ec4899; font-size: 0.85rem; color: #f472b6; font-weight: bold;">ðŸŒŠ Receiving Water / Discharge</div>

    <!-- 60. Dilution / Mixing Zone -->
    <div class="card" id="card63" data-calc="dilute" style="border-left-color: #ec4899;">
        <div class="card-header" onclick="toggleCard(63)">
            <h2><span class="card-num" style="background: #ec4899;">63</span> Dilution / Mixing Zone</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #ec4899;">Calculate downstream concentration from effluent and stream mixing. Used for TPDES permit compliance and in-stream standards verification.</div>
                <div class="grid">
                    <div>
                        <label>Effluent Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="dil_eflow" oninput="calcDilute()" placeholder="2.0">
                        <span class="field-hint">Discharge flow</span>
                    </div>
                    <div>
                        <label>Effluent Conc (mg/L)</label>
                        <input type="number" inputmode="decimal" id="dil_econc" oninput="calcDilute()" placeholder="15">
                        <span class="field-hint">Effluent parameter value</span>
                    </div>
                    <div>
                        <label>Stream Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="dil_sflow" oninput="calcDilute()" placeholder="20">
                        <span class="field-hint">Upstream flow (7Q2 for permit)</span>
                    </div>
                    <div>
                        <label>Upstream Conc (mg/L)</label>
                        <input type="number" inputmode="decimal" id="dil_sconc" oninput="calcDilute()" placeholder="2.0">
                        <span class="field-hint">Background concentration</span>
                    </div>
                </div>
                <div class="example-box"><b>TPDES:</b> Use 7Q2 (lowest 7-day avg with 2-yr return) for critical low flow | Dilution ratio = Stream flow Ã· Effluent flow</div>
                <div class="result-box">
                    <span class="val" id="dil_res">â€”</span>
                    <div id="dil_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('dil_res')">Copy Result</button>
                </div>
                <div class="formula-note">C_mix = (Q_eff Ã— C_eff + Q_stream Ã— C_stream) Ã· (Q_eff + Q_stream)</div>
            </div>
        </div>
    </div>

    <!-- ========== POPULATION & DESIGN SECTION ========== -->
    <div class="section-header" data-cat="population" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(217, 70, 239, 0.15); border-radius: 8px; border-left: 4px solid #d946ef; font-size: 0.85rem; color: #e879f9; font-weight: bold;">ðŸ‘¥ Population & Design</div>

    <!-- 61. Population Equivalent -->
    <div class="card" id="card64" data-calc="popeq" style="border-left-color: #d946ef;">
        <div class="card-header" onclick="toggleCard(64)">
            <h2><span class="card-num" style="background: #d946ef;">64</span> Population Equivalent</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #d946ef;">Comprehensive PE analysis: flow, BOD, TSS, and TKN population equivalents with per-capita comparison, industrial load detection, EDU conversion, peaking factor design, capacity projections, and TCEQ-ready reporting summary.</div>

                <!-- How to Use Toggle -->
                <div style="margin-bottom:10px;">
                    <button onclick="document.getElementById('pe_guide').style.display = document.getElementById('pe_guide').style.display === 'none' ? 'block' : 'none'; this.innerText = document.getElementById('pe_guide').style.display === 'none' ? 'ðŸ“– How to Use This Calculator â–¸' : 'ðŸ“– How to Use This Calculator â–¾'" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid #d946ef;background:rgba(217,70,239,0.08);color:#e879f9;font-weight:bold;font-size:0.82rem;cursor:pointer;text-align:left;">ðŸ“– How to Use This Calculator â–¸</button>
                    <div id="pe_guide" style="display:none;margin-top:8px;background:#0c1222;border:1px solid #334155;border-radius:8px;padding:14px;font-size:0.8rem;color:#cbd5e1;line-height:1.7;">
                        <div style="color:#e879f9;font-weight:bold;font-size:0.85rem;margin-bottom:8px;">ðŸ“– POPULATION EQUIVALENT â€” OPERATOR GUIDE</div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">What is Population Equivalent (PE)?</div>
                        PE converts plant loading into an equivalent number of people producing that wastewater. It tells you how big your plant's workload is in human terms â€” even if your actual population is different. A PE higher than your actual population means you have industrial or commercial contributors.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:12px;">Step 1 â€” Enter Plant Loading (minimum: Flow)</div>
                        <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                            <b>Flow (MGD)</b> â€” Your average daily flow from the plant flowmeter. Use the monthly average from your DMR, not a single day's reading.<br>
                            <b>BOD (mg/L)</b> â€” Influent BODâ‚… from your composite sampler. Use your monthly average.<br>
                            <b>TSS (mg/L)</b> â€” Influent TSS from composite. Typical domestic: 200â€“250 mg/L.<br>
                            <b>TKN (mg/L)</b> â€” Total Kjeldahl Nitrogen (ammonia + organic N). Typical domestic: 30â€“40 mg/L. Leave blank if you don't monitor TKN.
                        </div>
                        <span style="color:#94a3b8;font-size:0.75rem;">ðŸ’¡ The more parameters you enter, the more complete your analysis. Flow alone gives a basic PE; all four gives a full characterization.</span>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:12px;">Step 2 â€” Enter Service Area Info (optional but powerful)</div>
                        <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                            <b>Actual Population</b> â€” Number of people your system serves. Get this from your utility's billing records or census data. This unlocks per-capita comparison bars showing if your system matches expected loading.<br>
                            <b>Permitted Flow (MGD)</b> â€” Your TPDES permit's maximum daily average flow. Found on page 1 of your permit. This unlocks the capacity analysis with TCEQ 75% trigger tracking.<br>
                            <b>Growth Rate (%)</b> â€” Annual population growth for your service area. Check your city's comprehensive plan or TWDB data. Typical Texas suburban: 2â€“5%/yr. This projects when you'll hit capacity milestones.<br>
                            <b>Peaking Factor</b> â€” Ratio of peak hourly flow to average daily flow. Small systems (&lt;1,000 pop): 3.5â€“4.0. Medium (10,000): 2.0â€“2.5. Large (100,000+): 1.5â€“2.0. This sizes your wet weather capacity.
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:12px;">Understanding Your Results</div>

                        <div style="margin:6px 0 3px;color:#d946ef;font-weight:bold;">â–¸ PE Comparison Gauges</div>
                        Four horizontal bars showing PE from each parameter. The highest one is your <b>Governing PE</b> â€” this is the one TCEQ cares about. If BOD PE is much higher than Flow PE, you likely have industrial discharge adding organic load without proportional flow.

                        <div style="margin:8px 0 3px;color:#d946ef;font-weight:bold;">â–¸ EDU (Equivalent Dwelling Units)</div>
                        Governing PE Ã· 3.5 people per household. This is the number developers and planners use for impact fees and capacity allocation. If a developer wants to connect 200 new homes, that's ~700 PE of new load.

                        <div style="margin:8px 0 3px;color:#d946ef;font-weight:bold;">â–¸ Industrial vs Domestic Split</div>
                        A stacked bar estimating how much of your BOD load comes from industrial/commercial sources vs. residential. If your system is >15% industrial, you may need a pretreatment program (40 CFR 403).

                        <div style="margin:8px 0 3px;color:#d946ef;font-weight:bold;">â–¸ Wastewater Ratios</div>
                        <b>BOD:TSS</b> â€” Normal domestic is 0.7â€“1.2. Above 1.2 = high organic strength (food processing?). Below 0.7 = high inert solids (construction I/I?).<br>
                        <b>TKN:BOD</b> â€” Normal domestic is 0.12â€“0.25. Above 0.25 = nitrogen-rich (septic hauling, food waste). Below 0.12 = industrial dilution.

                        <div style="margin:8px 0 3px;color:#d946ef;font-weight:bold;">â–¸ Per Capita Loading Bars</div>
                        Compares your actual per-person loading against national standards. The vertical line is the standard. <span style="color:#4ade80;">Green</span> = near standard. <span style="color:#fbbf24;">Yellow</span> = elevated (industrial contributor?). <span style="color:#3b82f6;">Blue</span> = below standard (I/I dilution?).

                        <div style="margin:8px 0 3px;color:#d946ef;font-weight:bold;">â–¸ Capacity Analysis</div>
                        Shows current utilization against your TPDES permit. TCEQ requires a <b>capacity planning report when you hit 75%</b> of permitted flow (30 TAC Â§217.33). The bar marks 75% and 90% milestones. Red = you need to act now.

                        <div style="margin:8px 0 3px;color:#d946ef;font-weight:bold;">â–¸ Growth Timeline</div>
                        Visual projection showing <i>when</i> your plant hits 75%, 90%, and 100% of permitted capacity based on growth rate. The projection table below shows flow, capacity %, and population at 5, 10, and 20 years. Use this for CIP budgeting and expansion planning.

                        <div style="margin:8px 0 3px;color:#d946ef;font-weight:bold;">â–¸ TCEQ Report Summary</div>
                        A monospace text block formatted for direct copy-paste into capacity planning reports, engineering memos, or TCEQ submittals. Click <b>"Copy TCEQ Report Summary"</b> to put it on your clipboard.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:14px;">TCEQ Exam Tips</div>
                        <div style="background:rgba(217,70,239,0.1);border-radius:6px;padding:8px 10px;margin:4px 0;border-left:3px solid #d946ef;">
                            â€¢ <b>Memorize:</b> 100 GPD/person, 0.17 lbs BOD/person/day, 8.34 lbs/gal conversion<br>
                            â€¢ <b>Formula:</b> PE = (Flow MGD Ã— BOD mg/L Ã— 8.34) Ã· 0.17<br>
                            â€¢ <b>Shortcut:</b> At 200 mg/L BOD and 100 GPD/cap, both methods give the same PE<br>
                            â€¢ <b>Watch for:</b> Questions that give you flow in GPD vs MGD â€” don't double-convert<br>
                            â€¢ <b>Trick question:</b> If PE from BOD >> PE from flow, the answer is "industrial contribution"<br>
                            â€¢ <b>75% rule:</b> TCEQ requires planning report at 75% of permitted capacity
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:14px;">Real-World Example</div>
                        <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                            <b>Scenario:</b> Your plant treats 1.5 MGD with 200 mg/L BOD, 220 mg/L TSS, serving 15,000 people. Permit = 2.0 MGD. Growth = 3%/yr.<br><br>
                            <b>Enter:</b> Flow: 1.5 | BOD: 200 | TSS: 220 | Pop: 15000 | Permit: 2.0 | Growth: 3.0<br><br>
                            <b>Result:</b> Flow PE = 15,000 | BOD PE = 14,706 | TSS PE = 13,761 â†’ Governing: Flow at 15,000 PE. Balanced domestic character. At 75% capacity. TCEQ planning report required. At 3% growth, you'll hit 100% in ~10 years.
                        </div>
                    </div>
                </div>
                <div style="font-size:0.8rem;color:#e879f9;margin-bottom:8px;font-weight:bold;">&#9473;&#9473; Plant Loading &#9473;&#9473;</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="pe_flow" oninput="calcPE()" placeholder="1.5">
                        <span class="field-hint">Average daily flow</span>
                    </div>
                    <div>
                        <label>Influent BOD (mg/L)</label>
                        <input type="number" inputmode="decimal" id="pe_bod" oninput="calcPE()" placeholder="200">
                        <span class="field-hint">Influent BOD5</span>
                    </div>
                    <div>
                        <label>Influent TSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="pe_tss" oninput="calcPE()" placeholder="220">
                        <span class="field-hint">Total suspended solids</span>
                    </div>
                    <div>
                        <label>Influent TKN (mg/L)</label>
                        <input type="number" inputmode="decimal" id="pe_tkn" oninput="calcPE()" placeholder="35">
                        <span class="field-hint">Total Kjeldahl nitrogen</span>
                    </div>
                </div>
                <div style="font-size:0.8rem;color:#e879f9;margin:12px 0 8px;font-weight:bold;">&#9473;&#9473; Service Area &#9473;&#9473;</div>
                <div class="grid">
                    <div>
                        <label>Actual Population</label>
                        <input type="number" inputmode="decimal" id="pe_pop" oninput="calcPE()" placeholder="15000">
                        <span class="field-hint">Current served population</span>
                    </div>
                    <div>
                        <label>Permitted Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="pe_permit" oninput="calcPE()" placeholder="2.0">
                        <span class="field-hint">TCEQ permitted capacity</span>
                    </div>
                    <div>
                        <label>Annual Growth Rate (%)</label>
                        <input type="number" inputmode="decimal" id="pe_growth" oninput="calcPE()" placeholder="3.0">
                        <span class="field-hint">Population growth rate</span>
                    </div>
                    <div>
                        <label>Peaking Factor</label>
                        <input type="number" inputmode="decimal" id="pe_peak" oninput="calcPE()" placeholder="2.5">
                        <span class="field-hint">Peak:Avg ratio (2.0-4.0 typical)</span>
                    </div>
                </div>
                <div class="example-box"><b>Per Capita Standards:</b> Flow: 100 GPD | BOD: 0.17 lbs/day | TSS: 0.20 lbs/day | TKN: 0.03 lbs/day | EDU: 3.5 persons/unit | Peaking: 2.0-4.0 (smaller systems peak higher)</div>
                <div class="result-box">
                    <span class="val" id="pe_res">&mdash;</span>
                    <div id="pe_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('pe_res')">Copy Result</button>
                </div>
                <div id="pe_report" style="display:none; margin-top:10px; background:#0c1222; border:1px solid #334155; border-radius:8px; padding:12px; font-size:0.78rem; color:#cbd5e1; white-space:pre-line; line-height:1.5; font-family:monospace;"></div>
                <button id="pe_report_btn" style="display:none; margin-top:6px; width:100%; padding:10px; border-radius:6px; border:1px solid #d946ef; background:rgba(217,70,239,0.1); color:#e879f9; font-weight:bold; font-size:0.85rem; cursor:pointer;" onclick="copyPEReport()">&#128203; Copy TCEQ Report Summary</button>
                <div class="formula-note">PE(flow) = GPD / 100 | PE(BOD) = lbs BOD / 0.17 | PE(TSS) = lbs TSS / 0.20 | PE(TKN) = lbs TKN / 0.03 | EDU = PE / 3.5</div>
            </div>
        </div>
    </div>

    <!-- ========== FLOW MEASUREMENT (continued) ========== -->
    <div class="section-header" data-cat="flow" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(56, 189, 248, 0.15); border-radius: 8px; border-left: 4px solid #38bdf8; font-size: 0.85rem; color: #7dd3fc; font-weight: bold;">ðŸ“ Flow Measurement (continued)</div>

    <!-- 62. Parshall Flume -->
    <div class="card" id="card65" data-calc="parshall" style="border-left-color: #38bdf8;">
        <div class="card-header" onclick="toggleCard(65)">
            <h2><span class="card-num" style="background: #38bdf8;">65</span> Parshall Flume <span class="diagram-badge">DIAGRAM</span></h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #38bdf8;">Calculate flow through a Parshall flume from throat width and upstream head (Ha). Standard flow measurement device in wastewater â€” on every TCEQ exam. Supports free-flow and submerged correction.</div>

                <div style="margin-bottom:10px;">
                    <button onclick="document.getElementById('flume_guide').style.display = document.getElementById('flume_guide').style.display === 'none' ? 'block' : 'none'; this.innerText = document.getElementById('flume_guide').style.display === 'none' ? 'ðŸ“– How to Use â–¸' : 'ðŸ“– How to Use â–¾'" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid #38bdf8;background:rgba(56,189,248,0.08);color:#7dd3fc;font-weight:bold;font-size:0.82rem;cursor:pointer;text-align:left;">ðŸ“– How to Use â–¸</button>
                    <div id="flume_guide" style="display:none;margin-top:8px;background:#0c1222;border:1px solid #334155;border-radius:8px;padding:14px;font-size:0.8rem;color:#cbd5e1;line-height:1.7;">
                        <div style="color:#7dd3fc;font-weight:bold;font-size:0.85rem;margin-bottom:8px;">PARSHALL FLUME â€” OPERATOR GUIDE</div>

                        <div style="color:#f8fafc;font-weight:bold;">What This Calculates</div>
                        A Parshall flume is a specially shaped open-channel flow measurement structure. Water accelerates through a narrowed throat section, and the upstream water level (Ha) directly correlates to flow rate. You read Ha from a staff gauge or ultrasonic sensor, and this calculator converts that reading to GPM/MGD.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Inputs Explained</div>
                        <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                            <b>Throat Width</b> â€” The narrowest section of the flume. This is a fixed dimension â€” stamped on the flume nameplate or in your O&amp;M manual. Common WW sizes: 6"â€“24" for small plants, 3'â€“8' for large plants.<br>
                            <b>Ha (Upstream Head)</b> â€” Water level measured at the Ha stilling well, located 2/3 of the way back from the throat in the converging section. Read in <b>feet</b> from the flume floor (not from the channel floor). This is your primary measurement â€” accuracy here is everything.<br>
                            <b>Hb (Downstream Head)</b> â€” Optional. Measured in the diverging section downstream of the throat. Only needed to check for submergence. If Hb/Ha exceeds the submergence limit, the standard equation is invalid and a correction factor must be applied.
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Free-Flow vs Submerged</div>
                        <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                            <b style="color:#4ade80;">Free-flow</b> â€” Water drops through the throat freely. Ha alone determines flow. This is normal operation.<br>
                            <b style="color:#ef4444;">Submerged</b> â€” Downstream water backs up into the throat. Occurs when Hb/Ha exceeds the limit (0.60 for large flumes, 0.70 for &gt;12"). Submergence means your flow reading is <i>too high</i>. Fix: clear downstream blockages, check for debris, or apply submergence correction tables.
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">TCEQ Exam Tips</div>
                        <div style="background:rgba(56,189,248,0.1);border-radius:6px;padding:8px 10px;margin:4px 0;border-left:3px solid #38bdf8;">
                            â€¢ <b>Q = C Ã— Ha^n</b> â€” C and n depend on throat width<br>
                            â€¢ They'll give you Ha and throat width â€” plug into the equation<br>
                            â€¢ Ha is measured in <b>feet</b> â€” watch for questions giving inches<br>
                            â€¢ Free-flow only needs Ha. Submerged needs both Ha and Hb<br>
                            â€¢ Most common exam flume sizes: 6", 9", 12"<br>
                            â€¢ A Parshall flume has a CONVERGING section, THROAT, and DIVERGING section<br>
                            â€¢ Unlike a weir, a Parshall flume is self-cleaning (no upstream sediment buildup)
                        </div>
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>Throat Width</label>
                        <select id="pf_width" oninput="calcParshall()" style="width:100%;padding:10px;border-radius:6px;border:1px solid #475569;background:#0f172a;color:#f8fafc;font-size:0.95rem;">
                            <option value="3">3 inches</option>
                            <option value="6">6 inches</option>
                            <option value="9">9 inches</option>
                            <option value="12" selected>12 inches (1 ft)</option>
                            <option value="18">18 inches (1.5 ft)</option>
                            <option value="24">24 inches (2 ft)</option>
                            <option value="36">36 inches (3 ft)</option>
                            <option value="48">48 inches (4 ft)</option>
                            <option value="60">60 inches (5 ft)</option>
                            <option value="72">72 inches (6 ft)</option>
                            <option value="96">96 inches (8 ft)</option>
                        </select>
                        <span class="field-hint">Standard Parshall throat sizes</span>
                    </div>
                    <div>
                        <label>Ha â€” Upstream Head (ft)</label>
                        <input type="number" inputmode="decimal" id="pf_ha" oninput="calcParshall()" placeholder="1.0">
                        <span class="field-hint">Measured at 2/3 A from throat</span>
                    </div>
                    <div>
                        <label>Hb â€” Downstream Head (ft)</label>
                        <input type="number" inputmode="decimal" id="pf_hb" oninput="calcParshall()" placeholder="">
                        <span class="field-hint">Optional â€” for submergence check</span>
                    </div>
                </div>
                <div class="example-box"><b>Free-flow formula:</b> Q = C Ã— Ha^n (CFS) | C and n vary by throat width | Submerged when Hb/Ha &gt; 0.70 (small) or &gt; 0.60 (large) â€” correction required</div>
                <div class="result-box">
                    <span class="val" id="pf_res">â€”</span>
                    <div id="pf_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('pf_res')">Copy Result</button>
                </div>
                <div class="formula-note">Q (CFS) = C Ã— Ha^n | GPM = CFS Ã— 448.83 | MGD = GPM Ã— 0.00144</div>
                <button class="diagram-toggle" onclick="toggleDiagram(65,'headworks')">ðŸ“Š Show Headworks Process Diagram</button>
            </div>
        </div>
    </div>

    <!-- ========== TANK GEOMETRY ========== -->
    <div class="section-header" data-cat="tank" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(251, 191, 36, 0.15); border-radius: 8px; border-left: 4px solid #fbbf24; font-size: 0.85rem; color: #fcd34d; font-weight: bold;">ðŸ“ Tank Geometry</div>

    <!-- 63. Tank Volume Calculator -->
    <div class="card" id="card66" data-calc="tankvol" style="border-left-color: #fbbf24;">
        <div class="card-header" onclick="toggleCard(66)">
            <h2><span class="card-num" style="background: #fbbf24; color: #0f172a;">66</span> Tank Volume</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #fbbf24;">Calculate volume for circular, rectangular, and cone-bottom tanks in gallons, ftÂ³, and mÂ³. The most-used field calculator â€” feeds every volume-based calc in the app.</div>

                <div style="margin-bottom:10px;">
                    <button onclick="document.getElementById('tank_guide').style.display = document.getElementById('tank_guide').style.display === 'none' ? 'block' : 'none'; this.innerText = document.getElementById('tank_guide').style.display === 'none' ? 'ðŸ“– How to Use â–¸' : 'ðŸ“– How to Use â–¾'" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid #fbbf24;background:rgba(251,191,36,0.08);color:#fcd34d;font-weight:bold;font-size:0.82rem;cursor:pointer;text-align:left;">ðŸ“– How to Use â–¸</button>
                    <div id="tank_guide" style="display:none;margin-top:8px;background:#0c1222;border:1px solid #334155;border-radius:8px;padding:14px;font-size:0.8rem;color:#cbd5e1;line-height:1.7;">
                        <div style="color:#fcd34d;font-weight:bold;font-size:0.85rem;margin-bottom:8px;">TANK VOLUME â€” OPERATOR GUIDE</div>

                        <div style="color:#f8fafc;font-weight:bold;">Why You Need This</div>
                        Tank volume is the starting input for HRT, SRT, F:M, chemical dosing, and pump-down time. If you don't know your tank volume, you can't calculate anything else. This calculator handles every common WW tank geometry and gives you conversions in every unit you'll need.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Choosing the Right Shape</div>
                        <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                            <b>Circular</b> â€” Clarifiers, digesters, SBR basins, equalization tanks. Enter the <i>inside</i> diameter and water depth (SWD).<br>
                            <b>Rectangular</b> â€” Aeration basins, chlorine contact chambers, grit channels. Enter length, width, and water depth.<br>
                            <b>Cone-Bottom</b> â€” Gravity thickeners, clarifier sludge hoppers, some digesters. Enter diameter, straight sidewall depth, PLUS the cone depth. The calculator adds cylinder + cone volumes.
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Tips for Accurate Measurements</div>
                        Use <b>sidewall depth (SWD)</b> â€” the actual water depth, not the tank wall height. SWD is usually 1â€“3 feet less than wall height due to freeboard. For cone-bottom tanks, measure cone depth separately from the straight-wall portion. Get dimensions from as-built drawings when possible â€” field tape measurements are less accurate for large tanks.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">TCEQ Exam Tips</div>
                        <div style="background:rgba(251,191,36,0.1);border-radius:6px;padding:8px 10px;margin:4px 0;border-left:3px solid #fbbf24;">
                            â€¢ <b>Memorize:</b> 1 ftÂ³ = 7.48 gallons. This shows up constantly.<br>
                            â€¢ Circle area = Ï€ Ã— rÂ² = 0.785 Ã— DÂ² (they love 0.785)<br>
                            â€¢ Rectangle volume = L Ã— W Ã— D (easy)<br>
                            â€¢ Cone volume = (Ï€/3) Ã— rÂ² Ã— h (1/3 of a cylinder)<br>
                            â€¢ To get from gallons to MG: Ã· 1,000,000<br>
                            â€¢ Common trap: giving diameter in inches. Always convert to feet first.<br>
                            â€¢ Common trap: asking for gallons but giving dimensions that naturally give ftÂ³
                        </div>
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>Tank Shape</label>
                        <select id="tv_shape" oninput="calcTankVol()" style="width:100%;padding:10px;border-radius:6px;border:1px solid #475569;background:#0f172a;color:#f8fafc;font-size:0.95rem;">
                            <option value="circ">Circular (diameter + depth)</option>
                            <option value="rect">Rectangular (L Ã— W Ã— D)</option>
                            <option value="cone">Cone-Bottom Circular</option>
                        </select>
                        <span class="field-hint">Select tank geometry</span>
                    </div>
                    <div>
                        <label>Diameter / Length (ft)</label>
                        <input type="number" inputmode="decimal" id="tv_dim1" oninput="calcTankVol()" placeholder="40">
                        <span class="field-hint">Diameter (circ/cone) or Length (rect)</span>
                    </div>
                    <div>
                        <label>Width (ft) â€” rect only</label>
                        <input type="number" inputmode="decimal" id="tv_dim2" oninput="calcTankVol()" placeholder="20">
                        <span class="field-hint">Leave blank for circular</span>
                    </div>
                    <div>
                        <label>Sidewall Depth (ft)</label>
                        <input type="number" inputmode="decimal" id="tv_depth" oninput="calcTankVol()" placeholder="15">
                        <span class="field-hint">Water depth (SWD)</span>
                    </div>
                    <div>
                        <label>Cone Depth (ft) â€” cone only</label>
                        <input type="number" inputmode="decimal" id="tv_cone" oninput="calcTankVol()" placeholder="4">
                        <span class="field-hint">Depth of cone section</span>
                    </div>
                </div>
                <div class="example-box"><b>Conversions:</b> 1 ftÂ³ = 7.48 gal | 1 mÂ³ = 264.17 gal | Circle area = Ï€ Ã— rÂ² | Cone vol = Ï€/3 Ã— rÂ² Ã— h</div>
                <div class="result-box">
                    <span class="val" id="tv_res">â€”</span>
                    <div id="tv_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('tv_res')">Copy Result</button>
                </div>
                <div class="formula-note">Circ: V = Ï€ Ã— rÂ² Ã— d | Rect: V = L Ã— W Ã— D | Cone: V = (Ï€/3) Ã— rÂ² Ã— h | gal = ftÂ³ Ã— 7.48</div>
            </div>
        </div>
    </div>

    <!-- ========== LAGOONS (continued) ========== -->
    <div class="section-header" data-cat="lagoon" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(45, 212, 191, 0.15); border-radius: 8px; border-left: 4px solid #2dd4bf; font-size: 0.85rem; color: #5eead4; font-weight: bold;">ðŸŒŠ Lagoon & Pond (continued)</div>

    <!-- 64. Pond HRT -->
    <div class="card" id="card67" data-calc="pondhrt" style="border-left-color: #2dd4bf;">
        <div class="card-header" onclick="toggleCard(67)">
            <h2><span class="card-num" style="background: #2dd4bf;">67</span> Pond Detention Time</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #2dd4bf;">Calculate actual hydraulic retention time accounting for sludge accumulation reducing effective volume. Ponds lose 5â€“15% of volume per decade from sludge buildup â€” your actual HRT may be much shorter than design.</div>

                <div style="margin-bottom:10px;">
                    <button onclick="document.getElementById('phrt_guide').style.display = document.getElementById('phrt_guide').style.display === 'none' ? 'block' : 'none'; this.innerText = document.getElementById('phrt_guide').style.display === 'none' ? 'ðŸ“– How to Use â–¸' : 'ðŸ“– How to Use â–¾'" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid #2dd4bf;background:rgba(45,212,191,0.08);color:#5eead4;font-weight:bold;font-size:0.82rem;cursor:pointer;text-align:left;">ðŸ“– How to Use â–¸</button>
                    <div id="phrt_guide" style="display:none;margin-top:8px;background:#0c1222;border:1px solid #334155;border-radius:8px;padding:14px;font-size:0.8rem;color:#cbd5e1;line-height:1.7;">
                        <div style="color:#5eead4;font-weight:bold;font-size:0.85rem;margin-bottom:8px;">POND DETENTION TIME â€” OPERATOR GUIDE</div>

                        <div style="color:#f8fafc;font-weight:bold;">Why Sludge Depth Matters</div>
                        Every lagoon accumulates sludge on the bottom â€” dead algae, settled solids, and inorganic grit. A pond designed for 5 ft depth with 1.5 ft of sludge only has 3.5 ft of effective water. That's 30% less volume, 30% less HRT, and 30% less treatment. Many lagoon permit violations are caused by operators not knowing their actual sludge depth.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Inputs Explained</div>
                        <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                            <b>Pond Area (acres)</b> â€” Water surface area. Get from as-builts, aerial imagery, or measure the dike-to-dike dimensions and subtract for slope.<br>
                            <b>Design Depth (ft)</b> â€” Original operating depth from design documents. Typical: 3â€“5 ft (facultative), 8â€“15 ft (aerated).<br>
                            <b>Sludge Depth (ft)</b> â€” Measure with a sludge judge or core sampler at multiple points and average. If unknown, assume 0.5â€“1.0 ft per decade of operation. Enter 0 for a new or recently dredged pond.<br>
                            <b>Flow (MGD)</b> â€” Average daily influent flow. Use your monthly DMR average.<br>
                            <b>Number of Cells</b> â€” Ponds in series. A 3-cell system has better plug-flow behavior than a single cell, meaning less short-circuiting and more effective HRT.
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Short-Circuiting</div>
                        The <b>actual effective HRT</b> is always less than the calculated HRT because water doesn't flow uniformly through the pond â€” it short-circuits from inlet to outlet. A single-cell pond may only use ~30% of its volume effectively. Adding baffles or cells in series dramatically improves performance.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">TCEQ Exam Tips</div>
                        <div style="background:rgba(45,212,191,0.1);border-radius:6px;padding:8px 10px;margin:4px 0;border-left:3px solid #2dd4bf;">
                            â€¢ <b>HRT (days) = Volume (gal) Ã· Flow (GPD)</b><br>
                            â€¢ Volume = Acres Ã— 43,560 ftÂ²/acre Ã— Depth (ft) Ã— 7.48 gal/ftÂ³<br>
                            â€¢ Facultative pond design HRT: 90â€“180 days<br>
                            â€¢ Aerated lagoon HRT: 3â€“20 days<br>
                            â€¢ Polishing/maturation pond: 10â€“30 days<br>
                            â€¢ 1 acre-foot = 43,560 ftÂ³ = 325,851 gallons<br>
                            â€¢ Questions may give volume in acre-feet â€” multiply by 325,851 for gallons
                        </div>
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>Pond Area (acres)</label>
                        <input type="number" inputmode="decimal" id="hrt_acres" oninput="calcPondHRT()" placeholder="20">
                        <span class="field-hint">Water surface area</span>
                    </div>
                    <div>
                        <label>Design Depth (ft)</label>
                        <input type="number" inputmode="decimal" id="hrt_depth" oninput="calcPondHRT()" placeholder="5">
                        <span class="field-hint">Original operating depth</span>
                    </div>
                    <div>
                        <label>Sludge Depth (ft)</label>
                        <input type="number" inputmode="decimal" id="hrt_sludge" oninput="calcPondHRT()" placeholder="1.5">
                        <span class="field-hint">Accumulated sludge (0 if new)</span>
                    </div>
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="hrt_flow" oninput="calcPondHRT()" placeholder="0.5">
                        <span class="field-hint">Average daily flow</span>
                    </div>
                    <div>
                        <label>Number of Cells</label>
                        <input type="number" inputmode="decimal" id="hrt_cells" oninput="calcPondHRT()" placeholder="3">
                        <span class="field-hint">Ponds in series</span>
                    </div>
                </div>
                <div class="example-box"><b>Design targets:</b> Facultative: 90â€“180 days | Aerated: 3â€“20 days | Polishing: 10â€“30 days | Short-circuiting reduces effective HRT by 30â€“50% in single-cell systems</div>
                <div class="result-box">
                    <span class="val" id="hrt_res">â€”</span>
                    <div id="hrt_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('hrt_res')">Copy Result</button>
                </div>
                <div class="formula-note">HRT = Volume (gal) Ã· Flow (GPD) | Vol = Acres Ã— 43,560 Ã— Effective Depth Ã— 7.48</div>
            </div>
        </div>
    </div>

    <!-- ========== AERATION (continued) ========== -->
    <div class="section-header" data-cat="aeration" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(129, 140, 248, 0.15); border-radius: 8px; border-left: 4px solid #818cf8; font-size: 0.85rem; color: #a5b4fc; font-weight: bold;">ðŸ’¨ Aeration (continued)</div>

    <!-- 65. Blower Air Requirement -->
    <div class="card" id="card68" data-calc="blower" style="border-left-color: #818cf8;">
        <div class="card-header" onclick="toggleCard(68)">
            <h2><span class="card-num" style="background: #818cf8;">68</span> Blower Air Requirement</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #818cf8;">Calculate required SCFM from oxygen demand, basin depth, and transfer efficiency. Connects your AOTR (Calc #59) to actual blower sizing. Aeration = 50â€“65% of plant energy cost.</div>

                <div style="margin-bottom:10px;">
                    <button onclick="document.getElementById('blow_guide').style.display = document.getElementById('blow_guide').style.display === 'none' ? 'block' : 'none'; this.innerText = document.getElementById('blow_guide').style.display === 'none' ? 'ðŸ“– How to Use â–¸' : 'ðŸ“– How to Use â–¾'" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid #818cf8;background:rgba(129,140,248,0.08);color:#a5b4fc;font-weight:bold;font-size:0.82rem;cursor:pointer;text-align:left;">ðŸ“– How to Use â–¸</button>
                    <div id="blow_guide" style="display:none;margin-top:8px;background:#0c1222;border:1px solid #334155;border-radius:8px;padding:14px;font-size:0.8rem;color:#cbd5e1;line-height:1.7;">
                        <div style="color:#a5b4fc;font-weight:bold;font-size:0.85rem;margin-bottom:8px;">BLOWER AIR REQUIREMENT â€” OPERATOR GUIDE</div>

                        <div style="color:#f8fafc;font-weight:bold;">What This Calculates</div>
                        This converts your oxygen demand (lbs Oâ‚‚/hr) into the actual volume of air your blowers need to deliver (SCFM). Air is only ~23% oxygen, and diffusers only transfer a fraction of that Oâ‚‚ into the water, so you need much more air than you might think. This calculator also estimates motor horsepower and annual energy cost â€” since aeration is 50â€“65% of a typical plant's electric bill.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Inputs Explained</div>
                        <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                            <b>Oxygen Demand (lbs Oâ‚‚/hr)</b> â€” Your AOTR from Calc #59, or calculated as: (Flow MGD Ã— BOD removed mg/L Ã— 8.34) Ã· 24 hours. Include nitrification demand if applicable (4.6 lbs Oâ‚‚ per lb NHâ‚ƒ-N oxidized).<br>
                            <b>Diffuser Depth (ft)</b> â€” Submergence depth of the diffusers. Deeper = higher back-pressure but better OTE. Typical: 12â€“18 ft.<br>
                            <b>OTE (%)</b> â€” Oxygen Transfer Efficiency. Fine bubble diffusers: 25â€“35% (at 15 ft depth, clean water). Coarse bubble: 6â€“12%. Mechanical surface: varies. Use actual field-tested OTE if available â€” clean-water OTE is higher than process conditions.<br>
                            <b>Number of Basins</b> â€” SCFM is divided equally between parallel basins for per-basin blower sizing.<br>
                            <b>Safety Factor</b> â€” Peak:average Oâ‚‚ demand ratio. Accounts for diurnal load variation and peak events. Typical: 1.5 for municipal, 2.0 for industrial.<br>
                            <b>Energy Cost ($/kWh)</b> â€” Your utility rate. Texas average: $0.08â€“0.12/kWh. Enables annual cost projection.
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">TCEQ Exam Tips</div>
                        <div style="background:rgba(129,140,248,0.1);border-radius:6px;padding:8px 10px;margin:4px 0;border-left:3px solid #818cf8;">
                            â€¢ Air is 23.2% Oâ‚‚ by weight, 0.075 lbs/ftÂ³ at standard conditions<br>
                            â€¢ Oâ‚‚ per ftÂ³ of air = 0.075 Ã— 0.232 = 0.0174 lbs<br>
                            â€¢ SCFM = Oâ‚‚ demand (lbs/min) Ã· (0.0174 Ã— OTE fraction)<br>
                            â€¢ BHP = relates to SCFM and discharge pressure<br>
                            â€¢ Motor HP is typically next standard size above BHP Ã· motor efficiency<br>
                            â€¢ Higher OTE = less air needed = smaller blower = lower energy cost
                        </div>
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>Oxygen Demand (lbs Oâ‚‚/hr)</label>
                        <input type="number" inputmode="decimal" id="bl_o2" oninput="calcBlower()" placeholder="80">
                        <span class="field-hint">AOTR from Calc #62</span>
                    </div>
                    <div>
                        <label>Diffuser Depth (ft)</label>
                        <input type="number" inputmode="decimal" id="bl_depth" oninput="calcBlower()" placeholder="15">
                        <span class="field-hint">Submergence depth</span>
                    </div>
                    <div>
                        <label>Oxygen Transfer Efficiency (%)</label>
                        <input type="number" inputmode="decimal" id="bl_ote" oninput="calcBlower()" placeholder="25">
                        <span class="field-hint">Fine bubble: 20-35% | Coarse: 6-12%</span>
                    </div>
                    <div>
                        <label>Number of Basins</label>
                        <input type="number" inputmode="decimal" id="bl_basins" oninput="calcBlower()" placeholder="2">
                        <span class="field-hint">Parallel aeration basins</span>
                    </div>
                    <div>
                        <label>Safety Factor</label>
                        <input type="number" inputmode="decimal" id="bl_sf" oninput="calcBlower()" placeholder="1.5">
                        <span class="field-hint">Peak:Avg (1.3â€“2.0 typical)</span>
                    </div>
                    <div>
                        <label>Energy Cost ($/kWh)</label>
                        <input type="number" inputmode="decimal" id="bl_cost" oninput="calcBlower()" placeholder="0.10">
                        <span class="field-hint">For annual cost estimate</span>
                    </div>
                </div>
                <div class="example-box"><b>OTE by type:</b> Fine bubble: 25â€“35% at 15 ft | Coarse bubble: 6â€“12% | Mechanical surface: 1.5â€“3.5 lbs Oâ‚‚/hp-hr | Air is 23.2% Oâ‚‚ by weight (0.075 lbs/ftÂ³ Ã— 0.232)</div>
                <div class="result-box">
                    <span class="val" id="bl_res">â€”</span>
                    <div id="bl_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('bl_res')">Copy Result</button>
                </div>
                <div class="formula-note">SCFM = (Oâ‚‚ demand Ã· (0.075 Ã— 0.232 Ã— OTE/100)) Ã· 60 | BHP = SCFM Ã— Î”P / (6356 Ã— eff)</div>
            </div>
        </div>
    </div>

    <!-- ========== BIOSOLIDS & LAND APPLICATION ========== -->
    <div class="section-header" data-cat="landapp" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(180, 83, 9, 0.15); border-radius: 8px; border-left: 4px solid #d97706; font-size: 0.85rem; color: #fbbf24; font-weight: bold;">ðŸŒ± Biosolids & Land Application</div>

    <!-- 66. Plant Available Nitrogen (PAN) -->
    <div class="card" id="card69" data-calc="pan" style="border-left-color: #d97706;">
        <div class="card-header" onclick="toggleCard(69)">
            <h2><span class="card-num" style="background: #d97706;">69</span> Plant Available Nitrogen</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #d97706;">Calculate Plant Available Nitrogen (PAN) from biosolids nitrogen fractions and mineralization rates. PAN determines the agronomic application rate â€” apply too much and you contaminate groundwater, too little and the farmer complains.</div>

                <div style="margin-bottom:10px;">
                    <button onclick="document.getElementById('pan_guide').style.display = document.getElementById('pan_guide').style.display === 'none' ? 'block' : 'none'; this.innerText = document.getElementById('pan_guide').style.display === 'none' ? 'ðŸ“– How to Use â–¸' : 'ðŸ“– How to Use â–¾'" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid #d97706;background:rgba(217,119,6,0.08);color:#fbbf24;font-weight:bold;font-size:0.82rem;cursor:pointer;text-align:left;">ðŸ“– How to Use â–¸</button>
                    <div id="pan_guide" style="display:none;margin-top:8px;background:#0c1222;border:1px solid #334155;border-radius:8px;padding:14px;font-size:0.8rem;color:#cbd5e1;line-height:1.7;">
                        <div style="color:#fbbf24;font-weight:bold;font-size:0.85rem;margin-bottom:8px;">PLANT AVAILABLE NITROGEN â€” OPERATOR GUIDE</div>

                        <div style="color:#f8fafc;font-weight:bold;">What is PAN?</div>
                        Not all nitrogen in biosolids is immediately available to plants. PAN (Plant Available Nitrogen) is the fraction that crops can actually use in the first growing season. It includes ammonia (with volatilization losses), nitrate (100% available), and a fraction of organic nitrogen that mineralizes. PAN is the legal basis for determining how much biosolids you can land-apply â€” apply more N than the crop can use and you risk groundwater contamination.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Inputs Explained</div>
                        <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                            <b>NHâ‚ƒ-N (mg/kg dry)</b> â€” Ammonia nitrogen from your biosolids lab analysis. Immediately plant-available but some is lost to volatilization (evaporation to air) during surface application.<br>
                            <b>NOâ‚ƒ-N (mg/kg dry)</b> â€” Nitrate nitrogen. 100% plant available. Usually a small fraction in biosolids but can be significant in aerobically digested material.<br>
                            <b>Organic N (mg/kg dry)</b> â€” Calculated as TKN minus NHâ‚ƒ-N. This is nitrogen locked in organic matter that slowly becomes available as microbes break it down (mineralization). Only a percentage converts in Year 1.<br>
                            <b>Application Method</b> â€” How you apply affects ammonia loss. <b>Injected/incorporated within 24 hrs:</b> 0% NHâ‚ƒ loss (best). <b>Surface applied:</b> 50% of NHâ‚ƒ is lost to volatilization.<br>
                            <b>Mineralization Rate (%)</b> â€” What fraction of organic N converts to plant-available form in Year 1. Depends on how the biosolids were treated: Aerobically digested: 30%. Anaerobically digested: 20%. Composted: 10%. Raw/unstabilized: 40%.<br>
                            <b>% Solids</b> â€” Total solids of your biosolids. Liquid: 2â€“6%. Dewatered cake: 15â€“30%. Dried: 80%+. Needed to convert between dry and wet tons.
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">TCEQ Exam Tips</div>
                        <div style="background:rgba(217,119,6,0.1);border-radius:6px;padding:8px 10px;margin:4px 0;border-left:3px solid #d97706;">
                            â€¢ <b>PAN = (Kvol Ã— NHâ‚ƒ-N) + NOâ‚ƒ-N + (Kmin Ã— Org-N)</b><br>
                            â€¢ Kvol = 1.0 (injected) or 0.5 (surface applied)<br>
                            â€¢ Convert mg/kg to lbs/dry ton: multiply by 0.002<br>
                            â€¢ Org-N = TKN âˆ’ NHâ‚ƒ-N<br>
                            â€¢ PAN determines the legal application rate under 40 CFR 503<br>
                            â€¢ If they ask "what is the agronomic rate?" â†’ next step is Calc #67
                        </div>
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>NHâ‚ƒ-N (mg/kg dry)</label>
                        <input type="number" inputmode="decimal" id="pan_nh3" oninput="calcPAN()" placeholder="15000">
                        <span class="field-hint">Ammonia nitrogen</span>
                    </div>
                    <div>
                        <label>NOâ‚ƒ-N (mg/kg dry)</label>
                        <input type="number" inputmode="decimal" id="pan_no3" oninput="calcPAN()" placeholder="500">
                        <span class="field-hint">Nitrate nitrogen</span>
                    </div>
                    <div>
                        <label>Organic N (mg/kg dry)</label>
                        <input type="number" inputmode="decimal" id="pan_orgn" oninput="calcPAN()" placeholder="25000">
                        <span class="field-hint">TKN minus NHâ‚ƒ-N</span>
                    </div>
                    <div>
                        <label>Application Method</label>
                        <select id="pan_method" oninput="calcPAN()" style="width:100%;padding:10px;border-radius:6px;border:1px solid #475569;background:#0f172a;color:#f8fafc;font-size:0.95rem;">
                            <option value="inject">Injected / Incorporated (&lt;24 hr)</option>
                            <option value="surface">Surface Applied (not incorporated)</option>
                        </select>
                        <span class="field-hint">Affects ammonia volatilization</span>
                    </div>
                    <div>
                        <label>Mineralization Rate (%)</label>
                        <input type="number" inputmode="decimal" id="pan_kmin" oninput="calcPAN()" placeholder="20">
                        <span class="field-hint">Year 1: 20-30% typical</span>
                    </div>
                    <div>
                        <label>% Solids</label>
                        <input type="number" inputmode="decimal" id="pan_solids" oninput="calcPAN()" placeholder="20">
                        <span class="field-hint">Biosolids % total solids</span>
                    </div>
                </div>
                <div class="example-box"><b>Volatilization:</b> Injected = 0% NHâ‚ƒ loss | Surface = 50% NHâ‚ƒ loss | <b>Mineralization:</b> Aerobic digested: 30% | Anaerobic: 20% | Composted: 10% | Raw: 40%</div>
                <div class="result-box">
                    <span class="val" id="pan_res">â€”</span>
                    <div id="pan_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('pan_res')">Copy Result</button>
                </div>
                <div class="formula-note">PAN = (Kvol Ã— NHâ‚ƒ-N) + NOâ‚ƒ-N + (Kmin Ã— Org-N) | lbs PAN/dry ton = PAN(mg/kg) Ã— 0.002</div>
            </div>
        </div>
    </div>

    <!-- 67. Land Application Rate -->
    <div class="card" id="card70" data-calc="landapp" style="border-left-color: #d97706;">
        <div class="card-header" onclick="toggleCard(70)">
            <h2><span class="card-num" style="background: #d97706;">70</span> Land Application Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #d97706;">Calculate agronomic application rate in dry tons/acre and wet gallons/acre from PAN and crop nitrogen uptake. Ensures compliance with 40 CFR 503 and TCEQ biosolids permit requirements.</div>

                <div style="margin-bottom:10px;">
                    <button onclick="document.getElementById('land_guide').style.display = document.getElementById('land_guide').style.display === 'none' ? 'block' : 'none'; this.innerText = document.getElementById('land_guide').style.display === 'none' ? 'ðŸ“– How to Use â–¸' : 'ðŸ“– How to Use â–¾'" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid #d97706;background:rgba(217,119,6,0.08);color:#fbbf24;font-weight:bold;font-size:0.82rem;cursor:pointer;text-align:left;">ðŸ“– How to Use â–¸</button>
                    <div id="land_guide" style="display:none;margin-top:8px;background:#0c1222;border:1px solid #334155;border-radius:8px;padding:14px;font-size:0.8rem;color:#cbd5e1;line-height:1.7;">
                        <div style="color:#fbbf24;font-weight:bold;font-size:0.85rem;margin-bottom:8px;">LAND APPLICATION RATE â€” OPERATOR GUIDE</div>

                        <div style="color:#f8fafc;font-weight:bold;">What This Calculates</div>
                        This determines how many dry tons of biosolids you can apply per acre per year based on the nitrogen balance: crop nitrogen uptake divided by PAN per dry ton. Apply at the agronomic rate â€” the amount of nitrogen the crop can use â€” and you stay in compliance. Exceed it and you risk nitrate groundwater contamination and regulatory action.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Inputs Explained</div>
                        <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                            <b>PAN (lbs/dry ton)</b> â€” From Calc #69 or your lab report. This is the nitrogen the crop can access from each dry ton of biosolids applied.<br>
                            <b>Crop N Uptake (lbs N/acre/yr)</b> â€” How much nitrogen the crop can absorb in one growing season. Get from NRCS guidance, your agronomist, or TCEQ design guidance. Common Texas crops: Coastal bermuda 300â€“400, corn silage 200â€“250, wheat 100â€“150, hay 150â€“250.<br>
                            <b>% Solids</b> â€” Your biosolids total solids. Critical for converting dry tons to wet gallons for hauling logistics. Liquid biosolids (2â€“6% solids) require tanker trucks; dewatered cake (15â€“30%) uses dump trucks.<br>
                            <b>Annual Production (dry tons/yr)</b> â€” How much biosolids your plant generates per year. Calculate from: (lbs dry solids/day Ã— 365) Ã· 2000.<br>
                            <b>Available Acreage</b> â€” Total permitted land application acreage. The calculator checks if your site is big enough for your annual production.
                        </div>

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Site Capacity Check</div>
                        If your production exceeds what the site can handle at the agronomic rate, you need more acreage, a different disposal method (composting, landfill, incineration), or you need to reduce solids production at the plant.

                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">TCEQ Exam Tips</div>
                        <div style="background:rgba(217,119,6,0.1);border-radius:6px;padding:8px 10px;margin:4px 0;border-left:3px solid #d97706;">
                            â€¢ <b>DT/acre = Crop N uptake Ã· PAN per dry ton</b><br>
                            â€¢ Wet gal/acre = (DT/acre Ã— 2000 lbs) Ã· (8.34 Ã— % solids as decimal)<br>
                            â€¢ Required acres = Annual production (DT/yr) Ã· Rate (DT/acre/yr)<br>
                            â€¢ <b>40 CFR 503:</b> Federal regulation governing biosolids use and disposal<br>
                            â€¢ <b>Agronomic rate</b> = match N application to crop uptake. This is the law.<br>
                            â€¢ Exam may give you all PAN components and crop info in one problem â€” solve PAN first, then rate<br>
                            â€¢ Remember: 1 dry ton = 2,000 lbs
                        </div>
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>PAN (lbs/dry ton)</label>
                        <input type="number" inputmode="decimal" id="la_pan" oninput="calcLandApp()" placeholder="30">
                        <span class="field-hint">From Calc #69 or lab</span>
                    </div>
                    <div>
                        <label>Crop N Uptake (lbs N/acre/yr)</label>
                        <input type="number" inputmode="decimal" id="la_crop" oninput="calcLandApp()" placeholder="200">
                        <span class="field-hint">Bermuda: 200-400 | Corn: 150-200</span>
                    </div>
                    <div>
                        <label>% Solids</label>
                        <input type="number" inputmode="decimal" id="la_solids" oninput="calcLandApp()" placeholder="4">
                        <span class="field-hint">Liquid: 2-6% | Cake: 15-30%</span>
                    </div>
                    <div>
                        <label>Annual Production (dry tons/yr)</label>
                        <input type="number" inputmode="decimal" id="la_prod" oninput="calcLandApp()" placeholder="500">
                        <span class="field-hint">Total plant biosolids output</span>
                    </div>
                    <div>
                        <label>Available Acreage</label>
                        <input type="number" inputmode="decimal" id="la_acres" oninput="calcLandApp()" placeholder="200">
                        <span class="field-hint">Permitted land app site</span>
                    </div>
                </div>
                <div class="example-box"><b>Crop N Uptake (lbs/acre/yr):</b> Coastal bermuda: 300â€“400 | Corn silage: 200â€“250 | Wheat: 100â€“150 | Hay: 150â€“250 | Fescue: 150â€“250</div>
                <div class="result-box">
                    <span class="val" id="la_res">â€”</span>
                    <div id="la_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('la_res')">Copy Result</button>
                </div>
                <div class="formula-note">DT/acre = Crop N Ã· PAN | Wet gal/acre = (DT Ã— 2000) Ã· (8.34 Ã— %solids/100) | Required acres = Production Ã· Rate</div>
            </div>
        </div>
    </div>

    <!-- 68. TSS/VSS Lab Calculator -->
    <div class="card" id="card71" data-calc="lab" style="border-left-color: #f97316;">
        <div class="card-header" onclick="toggleCard(71)">
            <h2><span class="card-num" style="background: #f97316;">71</span> TSS / VSS Lab Calculator</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Calculate Total Suspended Solids and Volatile Suspended Solids from gravimetric lab data.</div>

                <div class="grid">
                    <div>
                        <label>Filter Weight (g)</label>
                        <input type="number" inputmode="decimal" id="tss_filter" oninput="calcTSSVSS()" placeholder="1.5432" step="0.0001">
                        <span class="field-hint">Clean, dry filter before use</span>
                    </div>
                    <div>
                        <label>Weight After 105Â°C (g)</label>
                        <input type="number" inputmode="decimal" id="tss_dried" oninput="calcTSSVSS()" placeholder="1.5678" step="0.0001">
                        <span class="field-hint">Filter + residue after drying</span>
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>Weight After 550Â°C (g)</label>
                        <input type="number" inputmode="decimal" id="tss_ignited" oninput="calcTSSVSS()" placeholder="1.5498" step="0.0001">
                        <span class="field-hint">Optional â€” for VSS calculation</span>
                    </div>
                    <div>
                        <label>Sample Volume (mL)</label>
                        <input type="number" inputmode="decimal" id="tss_vol" oninput="calcTSSVSS()" placeholder="100">
                        <span class="field-hint">Volume filtered (required)</span>
                    </div>
                </div>
                <div class="example-box"><b>Typical Sample Volumes:</b> Effluent: 100â€“500 mL | MLSS: 10â€“25 mL | WAS: 5â€“10 mL | RAS: 10â€“25 mL | Primary sludge: 5â€“10 mL</div>
                <div class="result-box">
                    <span class="val" id="tss_res">â€”</span>
                    <div id="tss_status" class="status">Enter filter weights and sample volume...</div>
                    <button class="btn-copy" onclick="copyVal('tss_res')">Copy Result</button>
                </div>
                <div class="formula-note">TSS = (W_105Â°C âˆ’ W_filter) Ã— 1,000,000 Ã· mL | VSS = (W_105Â°C âˆ’ W_550Â°C) Ã— 1,000,000 Ã· mL | FSS = TSS âˆ’ VSS</div>
                
                <!-- Collapsible Guide -->
                <div class="guide-toggle" onclick="this.classList.toggle('open');this.nextElementSibling.classList.toggle('open')">
                    â–¶ How to Use This Calculator
                </div>
                <div class="guide-content">
                    <div style="color:#fb923c;font-weight:bold;font-size:0.85rem;margin-bottom:8px;">TSS / VSS LAB PROCEDURE â€” OPERATOR GUIDE</div>

                    <div style="color:#f8fafc;font-weight:bold;">What This Calculates</div>
                    TSS (Total Suspended Solids) and VSS (Volatile Suspended Solids) from filter weight measurements.

                    <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Lab Procedure</div>
                    <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                        <b>TSS (Standard Methods 2540D):</b> Filter sample â†’ Dry at 103â€“105Â°C â†’ Weigh<br>
                        <b>VSS (Standard Methods 2540E):</b> Take dried filter â†’ Ignite at 550Â°C â†’ Weigh
                    </div>

                    <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">TCEQ Exam Tips</div>
                    <div style="background:rgba(249,115,22,0.1);border-radius:6px;padding:8px 10px;margin:4px 0;border-left:3px solid #f97316;">
                        â€¢ <b>TSS dried at 103â€“105Â°C</b> â€” Weight difference = suspended solids<br>
                        â€¢ <b>VSS ignited at 550Â°C</b> â€” Weight loss = volatile (organic) solids<br>
                        â€¢ Typical MLVSS/MLSS ratio: 70â€“85%
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== CHEMICAL FEED SECTION ========== -->
    <div class="section-header" data-cat="chemfeed" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(16, 185, 129, 0.15); border-radius: 8px; border-left: 4px solid #10b981; font-size: 0.85rem; color: #34d399; font-weight: bold;">ðŸ’‰ Chemical Feed & Pump Calculators</div>

    <!-- 72. Chemical Dosing Pump Output -->
    <div class="card" id="card72" data-calc="pumpdose" style="border-left-color: #10b981;">
        <div class="card-header" onclick="toggleCard(72)">
            <h2><span class="card-num" style="background: #10b981;">72</span> Chemical Dosing Pump Output</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #10b981;">Complete chemical feed pump calculator: forward calculation (settings â†’ output), reverse calculation (target dose â†’ required settings), and dose verification with plant flow. Includes chemical presets, cost tracking, and calibration tools.</div>
                
                <!-- Mode Tabs -->
                <div style="display:flex;gap:4px;margin-bottom:12px;background:#0f172a;padding:6px;border-radius:8px;">
                    <button id="pumpTabFwd" onclick="setPumpTab('forward')" style="flex:1;padding:8px 6px;border-radius:6px;border:none;background:#10b981;color:#fff;font-size:0.72rem;font-weight:bold;cursor:pointer;">ðŸ“Š Forward</button>
                    <button id="pumpTabRev" onclick="setPumpTab('reverse')" style="flex:1;padding:8px 6px;border-radius:6px;border:none;background:transparent;color:#94a3b8;font-size:0.72rem;font-weight:bold;cursor:pointer;">ðŸŽ¯ Reverse</button>
                    <button id="pumpTabDose" onclick="setPumpTab('dose')" style="flex:1;padding:8px 6px;border-radius:6px;border:none;background:transparent;color:#94a3b8;font-size:0.72rem;font-weight:bold;cursor:pointer;">ðŸ’§ Dose</button>
                    <button id="pumpTabCal" onclick="setPumpTab('calibrate')" style="flex:1;padding:8px 6px;border-radius:6px;border:none;background:transparent;color:#94a3b8;font-size:0.72rem;font-weight:bold;cursor:pointer;">ðŸ”§ Calibrate</button>
                </div>

                <!-- Chemical Preset Selector -->
                <div style="background:#0f172a;padding:10px 12px;border-radius:8px;margin-bottom:12px;">
                    <label style="color:#34d399;font-size:0.75rem;font-weight:bold;">Chemical Preset (auto-fills SG & concentration)</label>
                    <select id="pump_chemical" onchange="setChemicalPreset()" style="width:100%;padding:10px;border-radius:6px;border:2px solid #334155;background:#1e293b;color:#f8fafc;font-size:0.85rem;margin-top:6px;">
                        <option value="custom">â€” Custom / Manual Entry â€”</option>
                        <option value="bleach125">Sodium Hypochlorite 12.5% (Bleach)</option>
                        <option value="bleach10">Sodium Hypochlorite 10%</option>
                        <option value="calhypo65">Calcium Hypochlorite 65% (HTH)</option>
                        <option value="polymer">Polymer Solution (0.5% mixed)</option>
                        <option value="polyemul">Polymer Emulsion (Neat)</option>
                        <option value="alum48">Alum 48% (Liquid)</option>
                        <option value="ferric40">Ferric Chloride 40%</option>
                        <option value="caustic25">Caustic Soda 25% (NaOH)</option>
                        <option value="caustic50">Caustic Soda 50% (NaOH)</option>
                        <option value="sulfuric93">Sulfuric Acid 93%</option>
                        <option value="sodium_bisulfite">Sodium Bisulfite 38%</option>
                        <option value="methanol">Methanol (Carbon Source)</option>
                    </select>
                </div>

                <!-- FORWARD CALCULATION PANEL -->
                <div id="pumpPanelFwd">
                    <div style="background:#0f172a;padding:10px 12px;border-radius:8px;margin-bottom:12px;">
                        <label style="color:#34d399;font-size:0.75rem;font-weight:bold;">Pump Capacity Input</label>
                        <div style="display:flex;gap:8px;margin-top:6px;">
                            <button id="pumpModeGPD" onclick="setPumpMode('gpd')" style="flex:1;padding:8px;border-radius:6px;border:1px solid #10b981;background:rgba(16,185,129,0.2);color:#34d399;font-size:0.75rem;font-weight:bold;cursor:pointer;">GPD @ 100%</button>
                            <button id="pumpModeML" onclick="setPumpMode('mlmin')" style="flex:1;padding:8px;border-radius:6px;border:1px solid #475569;background:transparent;color:#94a3b8;font-size:0.75rem;font-weight:bold;cursor:pointer;">mL/min @ 100%</button>
                        </div>
                    </div>

                    <div class="grid">
                        <div>
                            <label id="pumpCapLabel">Pump Capacity (GPD @ 100%)</label>
                            <input type="number" inputmode="decimal" id="pump_capacity" oninput="calcPumpDose()" placeholder="24">
                            <span class="field-hint">Max output at full stroke/speed</span>
                        </div>
                        <div>
                            <label>Stroke Length (%)</label>
                            <input type="number" inputmode="decimal" id="pump_stroke" oninput="calcPumpDose()" placeholder="50" min="0" max="100">
                            <span class="field-hint">0â€“100% of max stroke</span>
                        </div>
                    </div>
                    <div class="grid">
                        <div>
                            <label>Stroke Rate (%)</label>
                            <input type="number" inputmode="decimal" id="pump_rate" oninput="calcPumpDose()" placeholder="75" min="0" max="100">
                            <span class="field-hint">Speed setting 0â€“100%</span>
                        </div>
                        <div>
                            <label>Specific Gravity</label>
                            <input type="number" inputmode="decimal" id="pump_sg" oninput="calcPumpDose()" placeholder="1.0" step="0.01">
                            <span class="field-hint">Auto-filled from preset</span>
                        </div>
                    </div>
                    <div class="grid">
                        <div>
                            <label>Chemical Concentration (%)</label>
                            <input type="number" inputmode="decimal" id="pump_conc" oninput="calcPumpDose()" placeholder="12.5">
                            <span class="field-hint">Active ingredient %</span>
                        </div>
                        <div>
                            <label>Chemical Cost ($/gal)</label>
                            <input type="number" inputmode="decimal" id="pump_cost" oninput="calcPumpDose()" placeholder="1.50" step="0.01">
                            <span class="field-hint">For cost estimates</span>
                        </div>
                    </div>
                </div>

                <!-- REVERSE CALCULATION PANEL -->
                <div id="pumpPanelRev" style="display:none;">
                    <div class="example-box" style="border-left-color:#10b981;background:rgba(16,185,129,0.1);">
                        <b>ðŸŽ¯ Reverse Calc:</b> Enter target lb/day â†’ calculates required pump settings.
                    </div>
                    <div class="grid">
                        <div>
                            <label>Target Output (lb/day)</label>
                            <input type="number" inputmode="decimal" id="pump_target_lbday" oninput="calcPumpReverse()" placeholder="10">
                            <span class="field-hint">Required chemical feed rate</span>
                        </div>
                        <div>
                            <label>Pump Capacity (GPD @ 100%)</label>
                            <input type="number" inputmode="decimal" id="pump_rev_capacity" oninput="calcPumpReverse()" placeholder="24">
                            <span class="field-hint">Your pump's max output</span>
                        </div>
                    </div>
                    <div class="grid">
                        <div>
                            <label>Specific Gravity</label>
                            <input type="number" inputmode="decimal" id="pump_rev_sg" oninput="calcPumpReverse()" placeholder="1.16" step="0.01">
                            <span class="field-hint">Chemical density</span>
                        </div>
                        <div>
                            <label>Fix Stroke at (%)</label>
                            <input type="number" inputmode="decimal" id="pump_rev_stroke" oninput="calcPumpReverse()" placeholder="100" min="0" max="100">
                            <span class="field-hint">Fixed stroke, solve for rate</span>
                        </div>
                    </div>
                    <div class="result-box" style="margin-top:10px;">
                        <span class="val" id="pump_rev_res">â€” % setting</span>
                        <div id="pump_rev_status" class="status">Enter target lb/day and pump capacity...</div>
                    </div>
                </div>

                <!-- DOSE CHECK PANEL -->
                <div id="pumpPanelDose" style="display:none;">
                    <div class="example-box" style="border-left-color:#3b82f6;background:rgba(59,130,246,0.1);">
                        <b>ðŸ’§ Dose Verification:</b> Enter pump output + plant flow to verify actual dose in mg/L.
                    </div>
                    <div class="grid">
                        <div>
                            <label>Pump Output (GPD)</label>
                            <input type="number" inputmode="decimal" id="pump_dose_gpd" oninput="calcPumpDoseCheck()" placeholder="5.0">
                            <span class="field-hint">From forward calc or meter</span>
                        </div>
                        <div>
                            <label>Plant Flow (MGD)</label>
                            <input type="number" inputmode="decimal" id="pump_dose_flow" oninput="calcPumpDoseCheck()" placeholder="1.0">
                            <span class="field-hint">Treatment flow</span>
                        </div>
                    </div>
                    <div class="grid">
                        <div>
                            <label>Chemical Concentration (%)</label>
                            <input type="number" inputmode="decimal" id="pump_dose_conc" oninput="calcPumpDoseCheck()" placeholder="12.5">
                            <span class="field-hint">Active ingredient %</span>
                        </div>
                        <div>
                            <label>Specific Gravity</label>
                            <input type="number" inputmode="decimal" id="pump_dose_sg" oninput="calcPumpDoseCheck()" placeholder="1.16" step="0.01">
                            <span class="field-hint">Chemical density</span>
                        </div>
                    </div>
                    <div class="result-box" style="margin-top:10px;">
                        <span class="val" id="pump_dose_res">â€” mg/L</span>
                        <div id="pump_dose_status" class="status">Enter pump output and plant flow...</div>
                    </div>
                </div>

                <!-- CALIBRATION PANEL -->
                <div id="pumpPanelCal" style="display:none;">
                    <div class="example-box" style="border-left-color:#f59e0b;background:rgba(245,158,11,0.1);">
                        <b>ðŸ”§ Calibration:</b> Compare calculated vs actual measured output (bucket test).
                    </div>
                    <div class="grid">
                        <div>
                            <label>Pump Capacity (GPD @ 100%)</label>
                            <input type="number" inputmode="decimal" id="pump_cal_capacity" oninput="calcPumpCalibration()" placeholder="24">
                            <span class="field-hint">Nameplate rating</span>
                        </div>
                        <div>
                            <label>Test Stroke (%)</label>
                            <input type="number" inputmode="decimal" id="pump_cal_stroke" oninput="calcPumpCalibration()" placeholder="100">
                            <span class="field-hint">Setting during test</span>
                        </div>
                    </div>
                    <div class="grid">
                        <div>
                            <label>Test Rate (%)</label>
                            <input type="number" inputmode="decimal" id="pump_cal_rate" oninput="calcPumpCalibration()" placeholder="100">
                            <span class="field-hint">Speed during test</span>
                        </div>
                        <div>
                            <label>Test Duration (min)</label>
                            <input type="number" inputmode="decimal" id="pump_cal_time" oninput="calcPumpCalibration()" placeholder="5">
                            <span class="field-hint">How long you ran test</span>
                        </div>
                    </div>
                    <div class="grid">
                        <div>
                            <label>Measured Volume (mL)</label>
                            <input type="number" inputmode="decimal" id="pump_cal_actual" oninput="calcPumpCalibration()" placeholder="350">
                            <span class="field-hint">Actual collected amount</span>
                        </div>
                        <div>
                            <label>Expected (mL) - auto</label>
                            <input type="number" id="pump_cal_expected" readonly style="background:#1e293b;color:#64748b;">
                        </div>
                    </div>
                    <div class="result-box" style="margin-top:10px;">
                        <span class="val" id="pump_cal_res">â€” % accuracy</span>
                        <div id="pump_cal_status" class="status">Enter calibration test data...</div>
                    </div>
                </div>

                <div class="example-box">
                    <b>Common Pump Sizes:</b> Small: 0.5â€“5 GPD | Medium: 5â€“25 GPD | Large: 25â€“100+ GPD
                </div>

                <!-- FORWARD CALC RESULTS -->
                <div id="pumpResultsFwd">
                    <div class="result-box">
                        <span class="val" id="pumpdose_res">â€” mL/hr</span>
                        <div id="pumpdose_status" class="status">Enter pump capacity and settings...</div>
                        <button class="btn-copy" onclick="copyVal('pumpdose_res')">Copy Result</button>
                    </div>

                    <div id="pumpdose_details" style="display:none;background:#1e293b;border-radius:8px;padding:12px;margin-top:10px;">
                        <div style="font-size:0.7rem;color:#94a3b8;font-weight:bold;margin-bottom:8px;">VOLUME OUTPUT</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;font-size:0.8rem;">
                            <div style="background:#0f172a;padding:8px;border-radius:6px;text-align:center;">
                                <div style="color:#64748b;font-size:0.6rem;">mL/hr</div>
                                <div style="color:#34d399;font-weight:bold;font-size:1rem;" id="pump_mlhr">â€”</div>
                            </div>
                            <div style="background:#0f172a;padding:8px;border-radius:6px;text-align:center;">
                                <div style="color:#64748b;font-size:0.6rem;">mL/day</div>
                                <div style="color:#34d399;font-weight:bold;font-size:1rem;" id="pump_mlday">â€”</div>
                            </div>
                            <div style="background:#0f172a;padding:8px;border-radius:6px;text-align:center;">
                                <div style="color:#64748b;font-size:0.6rem;">L/day</div>
                                <div style="color:#34d399;font-weight:bold;font-size:1rem;" id="pump_lpd">â€”</div>
                            </div>
                            <div style="background:#0f172a;padding:8px;border-radius:6px;text-align:center;">
                                <div style="color:#64748b;font-size:0.6rem;">GPD</div>
                                <div style="color:#34d399;font-weight:bold;font-size:1rem;" id="pump_gpd">â€”</div>
                            </div>
                            <div style="background:#0f172a;padding:8px;border-radius:6px;text-align:center;">
                                <div style="color:#64748b;font-size:0.6rem;">GPH</div>
                                <div style="color:#34d399;font-weight:bold;font-size:1rem;" id="pump_gph">â€”</div>
                            </div>
                            <div style="background:#0f172a;padding:8px;border-radius:6px;text-align:center;">
                                <div style="color:#64748b;font-size:0.6rem;">lb/day</div>
                                <div style="color:#34d399;font-weight:bold;font-size:1rem;" id="pump_lbday">â€”</div>
                            </div>
                        </div>
                        
                        <div style="font-size:0.7rem;color:#94a3b8;font-weight:bold;margin:10px 0 8px;">ACTIVE CHEMICAL & COST</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;font-size:0.8rem;">
                            <div style="background:#0f172a;padding:8px;border-radius:6px;text-align:center;">
                                <div style="color:#64748b;font-size:0.6rem;">Active lb/day</div>
                                <div style="color:#fbbf24;font-weight:bold;font-size:1rem;" id="pump_active_lbday">â€”</div>
                            </div>
                            <div style="background:#0f172a;padding:8px;border-radius:6px;text-align:center;">
                                <div style="color:#64748b;font-size:0.6rem;">$/Day</div>
                                <div style="color:#fbbf24;font-weight:bold;font-size:1rem;" id="pump_costday">â€”</div>
                            </div>
                            <div style="background:#0f172a;padding:8px;border-radius:6px;text-align:center;">
                                <div style="color:#64748b;font-size:0.6rem;">$/Month</div>
                                <div style="color:#fbbf24;font-weight:bold;font-size:1rem;" id="pump_costmonth">â€”</div>
                            </div>
                        </div>
                        
                        <div style="font-size:0.7rem;color:#94a3b8;font-weight:bold;margin:10px 0 8px;">USAGE ESTIMATES</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:0.8rem;">
                            <div style="background:#0f172a;padding:8px;border-radius:6px;text-align:center;">
                                <div style="color:#64748b;font-size:0.6rem;">Gal/Month</div>
                                <div style="color:#60a5fa;font-weight:bold;font-size:1rem;" id="pump_galmonth">â€”</div>
                            </div>
                            <div style="background:#0f172a;padding:8px;border-radius:6px;text-align:center;">
                                <div style="color:#64748b;font-size:0.6rem;">Drums/Month</div>
                                <div style="color:#60a5fa;font-weight:bold;font-size:1rem;" id="pump_drums">â€”</div>
                            </div>
                        </div>
                        
                        <div style="background:#0f172a;padding:10px;border-radius:6px;margin-top:10px;">
                            <div style="color:#64748b;font-size:0.6rem;">ðŸ”§ CALIBRATION CHECK (1 min)</div>
                            <div style="color:#f8fafc;font-size:0.85rem;">Collect for 1 min â†’ expect <b id="pump_cal1min">â€”</b> mL</div>
                        </div>
                    </div>
                </div>

                <div class="formula-note">Output = Capacity Ã— Stroke% Ã— Rate% | lb/day = GPD Ã— 8.34 Ã— SG</div>
                
                <!-- Collapsible Guide -->
                <div class="guide-toggle" onclick="this.classList.toggle('open');this.nextElementSibling.classList.toggle('open')">
                    â–¶ How to Use This Calculator
                </div>
                <div class="guide-content">
                    <div style="color:#34d399;font-weight:bold;font-size:0.85rem;margin-bottom:8px;">CHEMICAL DOSING PUMP â€” OPERATOR GUIDE</div>

                    <div style="color:#f8fafc;font-weight:bold;">Four Calculation Modes</div>
                    <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                        â€¢ <b>Forward</b> â€” Pump settings â†’ Output (mL/hr, GPD, lb/day)<br>
                        â€¢ <b>Reverse</b> â€” Target lb/day â†’ Required pump settings<br>
                        â€¢ <b>Dose</b> â€” Verify mg/L dose at plant flow<br>
                        â€¢ <b>Calibrate</b> â€” Compare actual vs calculated
                    </div>

                    <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Chemical Presets</div>
                    <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                        â€¢ <b>Bleach 12.5%</b> â€” SG 1.16<br>
                        â€¢ <b>Ferric 40%</b> â€” SG 1.42<br>
                        â€¢ <b>Caustic 50%</b> â€” SG 1.53
                    </div>

                    <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">TCEQ Exam Tips</div>
                    <div style="background:rgba(16,185,129,0.1);border-radius:6px;padding:8px 10px;margin:4px 0;border-left:3px solid #10b981;">
                        â€¢ <b>lb/day = GPD Ã— 8.34 Ã— SG</b><br>
                        â€¢ <b>Diaphragm pumps</b> â€” Most common<br>
                        â€¢ <b>Always calibrate</b> â€” Pump curves are theoretical
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== NEW COLLECTION SYSTEMS CALCULATORS ========== -->
    
    <!-- 73. Lift Station Capacity -->
    <div class="card" id="card73" data-calc="liftstation" style="border-left-color: #fb923c;">
        <div class="card-header" onclick="toggleCard(73)">
            <h2><span class="card-num" style="background: #fb923c;">73</span> Lift Station Capacity <span class="diagram-badge">DIAGRAM</span></h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #fb923c;">Calculate lift station wet well sizing, pump runtime, and cycle frequency. Critical for collection system design and TCEQ exams.</div>
                <div class="grid">
                    <div>
                        <label>Peak Inflow (GPM)</label>
                        <input type="number" inputmode="decimal" id="lift_inflow" oninput="calcLiftStation()" placeholder="500">
                    </div>
                    <div>
                        <label>Pump Capacity (GPM)</label>
                        <input type="number" inputmode="decimal" id="lift_pump" oninput="calcLiftStation()" placeholder="750">
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>Wet Well Volume (gal)</label>
                        <input type="number" inputmode="decimal" id="lift_volume" oninput="calcLiftStation()" placeholder="2000">
                        <span class="field-hint">Between on/off levels</span>
                    </div>
                    <div>
                        <label>Avg Daily Flow (GPD)</label>
                        <input type="number" inputmode="decimal" id="lift_avgflow" oninput="calcLiftStation()" placeholder="100000">
                    </div>
                </div>
                <div class="example-box"><b>Design:</b> Pump â‰¥ 1.5Ã— peak inflow | Wet well = 10-30 min detention | Target 4-10 cycles/hr</div>
                <div class="result-box">
                    <span class="val" id="lift_res">â€”</span>
                    <div id="lift_status" class="status">Enter lift station data...</div>
                    <button class="btn-copy" onclick="copyVal('lift_res')">Copy Result</button>
                </div>
                <div class="formula-note">Fill Time = V Ã· Q_in | Pump Time = V Ã· (Q_pump - Q_in) | Cycles/hr = 60 Ã· Cycle Time</div>
                <button class="diagram-toggle" onclick="toggleDiagram(73,'lift_station')">ðŸ“Š Show Lift Station Diagram</button>
            </div>
        </div>
    </div>

    <!-- 74. Force Main Velocity -->
    <div class="card" id="card74" data-calc="forcemain" style="border-left-color: #fb923c;">
        <div class="card-header" onclick="toggleCard(74)">
            <h2><span class="card-num" style="background: #fb923c;">74</span> Force Main Velocity <span class="diagram-badge">DIAGRAM</span></h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #fb923c;">Calculate velocity in force mains. Check for scouring (min 2 fps) and erosion limits (max 8 fps). Includes travel time for septicity risk.</div>
                <div class="grid">
                    <div>
                        <label>Flow Rate (GPM)</label>
                        <input type="number" inputmode="decimal" id="fm_flow" oninput="calcForceMain()" placeholder="500">
                    </div>
                    <div>
                        <label>Pipe Diameter (in)</label>
                        <input type="number" inputmode="decimal" id="fm_dia" oninput="calcForceMain()" placeholder="8">
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>Pipe Length (ft)</label>
                        <input type="number" inputmode="decimal" id="fm_length" oninput="calcForceMain()" placeholder="5000">
                        <span class="field-hint">For travel time</span>
                    </div>
                    <div>
                        <label>C Factor</label>
                        <input type="number" inputmode="decimal" id="fm_c" oninput="calcForceMain()" placeholder="140" value="140">
                        <span class="field-hint">PVC=150, DI=140</span>
                    </div>
                </div>
                <div class="example-box"><b>Velocity:</b> Min 2 fps (scouring) | Optimal 3-5 fps | Max 8 fps | <b>Septicity:</b> Risk if travel > 4 hrs</div>
                <div class="result-box">
                    <span class="val" id="fm_res">â€” fps</span>
                    <div id="fm_status" class="status">Enter force main data...</div>
                    <button class="btn-copy" onclick="copyVal('fm_res')">Copy Result</button>
                </div>
                <div class="formula-note">V = 0.408 Ã— Q Ã· DÂ² | Travel Time = Length Ã· (V Ã— 60)</div>
                <button class="diagram-toggle" onclick="toggleDiagram(74,'forcemain')">ðŸ“Š Show Force Main Diagram</button>
            </div>
        </div>
    </div>

    <!-- 75. Pump Station Drawdown -->
    <div class="card" id="card75" data-calc="drawdown" style="border-left-color: #fb923c;">
        <div class="card-header" onclick="toggleCard(75)">
            <h2><span class="card-num" style="background: #fb923c;">75</span> Pump Station Drawdown</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #fb923c;">Calculate time to pump down wet well. Use for emergency planning and overflow prevention timing.</div>
                <div class="grid">
                    <div>
                        <label>Wet Well Volume (gal)</label>
                        <input type="number" inputmode="decimal" id="dd_volume" oninput="calcDrawdown()" placeholder="3000">
                    </div>
                    <div>
                        <label>Pump Rate (GPM)</label>
                        <input type="number" inputmode="decimal" id="dd_pump" oninput="calcDrawdown()" placeholder="500">
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>Inflow Rate (GPM)</label>
                        <input type="number" inputmode="decimal" id="dd_inflow" oninput="calcDrawdown()" placeholder="200">
                    </div>
                    <div>
                        <label>Emergency Storage (gal)</label>
                        <input type="number" inputmode="decimal" id="dd_emergency" oninput="calcDrawdown()" placeholder="5000">
                        <span class="field-hint">Optional</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="dd_res">â€” min</span>
                    <div id="dd_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('dd_res')">Copy Result</button>
                </div>
                <div class="formula-note">Pump Down = V Ã· (Pump - Inflow) | Fill Time = V Ã· Inflow</div>
            </div>
        </div>
    </div>

    <!-- 76. Sewer Line Capacity -->
    <div class="card" id="card76" data-calc="sewercap" style="border-left-color: #fb923c;">
        <div class="card-header" onclick="toggleCard(76)">
            <h2><span class="card-num" style="background: #fb923c;">76</span> Sewer Line Capacity</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #fb923c;">Quick capacity lookup for gravity sewer pipes at TCEQ minimum slopes.</div>
                <div class="grid">
                    <div>
                        <label>Pipe Diameter</label>
                        <select id="sc_dia" onchange="calcSewerCap()" style="width:100%;padding:12px;border-radius:6px;border:2px solid #334155;background:#0f172a;color:#f8fafc;">
                            <option value="8">8 inch</option>
                            <option value="10">10 inch</option>
                            <option value="12" selected>12 inch</option>
                            <option value="15">15 inch</option>
                            <option value="18">18 inch</option>
                            <option value="24">24 inch</option>
                        </select>
                    </div>
                    <div>
                        <label>Slope (ft/ft)</label>
                        <input type="number" inputmode="decimal" id="sc_slope" oninput="calcSewerCap()" placeholder="0.004">
                    </div>
                </div>
                <div class="example-box"><b>TCEQ Min Slopes:</b> 8"=0.0040 | 10"=0.0028 | 12"=0.0022 | 15"=0.0015 | 18"=0.0012</div>
                <div class="result-box">
                    <span class="val" id="sc_res">â€”</span>
                    <div id="sc_status" class="status">Select size...</div>
                    <button class="btn-copy" onclick="copyVal('sc_res')">Copy Result</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== ACTIVATED SLUDGE ADDITIONS ========== -->
    <div class="section-header" data-cat="cas" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(34, 197, 94, 0.15); border-radius: 8px; border-left: 4px solid #22c55e; font-size: 0.85rem; color: #4ade80; font-weight: bold;">ðŸ§« Activated Sludge â€“ Advanced Calculators</div>

    <!-- 77. OUR - Oxygen Uptake Rate -->
    <div class="card" id="card77" data-calc="our" style="border-left-color: #22c55e;">
        <div class="card-header" onclick="toggleCard(77)">
            <h2><span class="card-num" style="background: #22c55e;">77</span> OUR â€“ Oxygen Uptake Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #22c55e;">Calculate Oxygen Uptake Rate from respirometry test. OUR indicates biological activity, toxicity, and process health.</div>
                <div class="grid">
                    <div>
                        <label>Initial DO (mg/L)</label>
                        <input type="number" inputmode="decimal" id="our_do1" oninput="calcOUR()" placeholder="7.0">
                    </div>
                    <div>
                        <label>Final DO (mg/L)</label>
                        <input type="number" inputmode="decimal" id="our_do2" oninput="calcOUR()" placeholder="2.0">
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>Time Interval (min)</label>
                        <input type="number" inputmode="decimal" id="our_time" oninput="calcOUR()" placeholder="15">
                    </div>
                    <div>
                        <label>MLVSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="our_mlvss" oninput="calcOUR()" placeholder="2500">
                        <span class="field-hint">For SOUR calculation</span>
                    </div>
                </div>
                <div class="example-box"><b>Typical OUR:</b> 15-30 mg/L/hr (healthy) | <10 = low activity | >50 = high load or young sludge | Sudden drop = toxicity</div>
                <div class="result-box">
                    <span class="val" id="our_res">â€” mg/L/hr</span>
                    <div id="our_status" class="status">Enter respirometry data...</div>
                    <button class="btn-copy" onclick="copyVal('our_res')">Copy Result</button>
                </div>
                <div class="formula-note">OUR = (DOâ‚ - DOâ‚‚) Ã· Time Ã— 60 | SOUR = OUR Ã· MLVSS Ã— 1000</div>
            </div>
        </div>
    </div>

    <!-- 78. SOUR - Specific Oxygen Uptake Rate -->
    <div class="card" id="card78" data-calc="sour" style="border-left-color: #22c55e;">
        <div class="card-header" onclick="toggleCard(78)">
            <h2><span class="card-num" style="background: #22c55e;">78</span> SOUR â€“ Specific OUR</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #22c55e;">Calculate Specific Oxygen Uptake Rate (per unit biomass). Better for comparing activity across different MLSS levels.</div>
                <div class="grid">
                    <div>
                        <label>OUR (mg Oâ‚‚/L/hr)</label>
                        <input type="number" inputmode="decimal" id="sour_our" oninput="calcSOUR()" placeholder="20">
                    </div>
                    <div>
                        <label>MLVSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="sour_mlvss" oninput="calcSOUR()" placeholder="2500">
                    </div>
                </div>
                <div class="example-box"><b>Typical SOUR:</b> 8-20 mg Oâ‚‚/g MLVSS/hr (CAS) | <3 = old/starved sludge | >25 = young sludge or toxicity recovery</div>
                <div class="result-box">
                    <span class="val" id="sour_res">â€” mg Oâ‚‚/g/hr</span>
                    <div id="sour_status" class="status">Enter OUR and MLVSS...</div>
                    <button class="btn-copy" onclick="copyVal('sour_res')">Copy Result</button>
                </div>
                <div class="formula-note">SOUR = OUR Ã· MLVSS Ã— 1000 (mg Oâ‚‚/g MLVSS/hr)</div>
            </div>
        </div>
    </div>

    <!-- 79. Settleability -->
    <div class="card" id="card79" data-calc="settle" style="border-left-color: #22c55e;">
        <div class="card-header" onclick="toggleCard(79)">
            <h2><span class="card-num" style="background: #22c55e;">79</span> Settleability Test</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #22c55e;">Interpret 30-minute settleability test results. Calculate SSV30, SVI, and settling velocity for sludge quality assessment.</div>
                <div class="grid">
                    <div>
                        <label>30-min Settled Volume (mL/L)</label>
                        <input type="number" inputmode="decimal" id="set_ssv" oninput="calcSettle()" placeholder="250">
                        <span class="field-hint">Read from 1L cylinder</span>
                    </div>
                    <div>
                        <label>MLSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="set_mlss" oninput="calcSettle()" placeholder="3000">
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>5-min Settled Vol (mL/L)</label>
                        <input type="number" inputmode="decimal" id="set_5min" oninput="calcSettle()" placeholder="400">
                        <span class="field-hint">Optional - for rate</span>
                    </div>
                    <div>
                        <label>Initial Height (cm)</label>
                        <input type="number" inputmode="decimal" id="set_height" oninput="calcSettle()" placeholder="36" value="36">
                        <span class="field-hint">1L cylinder â‰ˆ 36 cm</span>
                    </div>
                </div>
                <div class="example-box"><b>SVI targets:</b> 50-150 good | <50 old/pin floc | >150 bulking | >200 severe bulking</div>
                <div class="result-box">
                    <span class="val" id="set_res">â€”</span>
                    <div id="set_status" class="status">Enter settleability data...</div>
                    <button class="btn-copy" onclick="copyVal('set_res')">Copy Result</button>
                </div>
                <div class="formula-note">SVI = (SSV30 Ã— 1000) Ã· MLSS | ISV = settling rate in m/hr</div>
            </div>
        </div>
    </div>

    <!-- ========== DESIGN CRITERIA CALCULATORS ========== -->
    <div class="section-header" data-cat="design" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(99, 102, 241, 0.15); border-radius: 8px; border-left: 4px solid #6366f1; font-size: 0.85rem; color: #a5b4fc; font-weight: bold;">ðŸ“ Design Criteria Calculators</div>

    <!-- 80. Primary Clarifier Design -->
    <div class="card" id="card80" data-calc="primclar" style="border-left-color: #6366f1;">
        <div class="card-header" onclick="toggleCard(80)">
            <h2><span class="card-num" style="background: #6366f1;">80</span> Primary Clarifier Design <span class="diagram-badge">DIAGRAM</span></h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #6366f1;">Calculate primary clarifier design parameters: overflow rate, detention time, and weir loading rate.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="pc_flow" oninput="calcPrimClar()" placeholder="2.0">
                    </div>
                    <div>
                        <label>Diameter (ft)</label>
                        <input type="number" inputmode="decimal" id="pc_dia" oninput="calcPrimClar()" placeholder="60">
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>Side Water Depth (ft)</label>
                        <input type="number" inputmode="decimal" id="pc_swd" oninput="calcPrimClar()" placeholder="10">
                    </div>
                    <div>
                        <label>Weir Length (ft)</label>
                        <input type="number" inputmode="decimal" id="pc_weir" oninput="calcPrimClar()" placeholder="188">
                        <span class="field-hint">Perimeter or inboard</span>
                    </div>
                </div>
                <div class="example-box"><b>Primary Design:</b> SOR 600-1200 GPD/ftÂ² | DT 1.5-2.5 hr | Weir 10,000-20,000 GPD/ft | TSS removal 50-65%</div>
                <div class="result-box">
                    <span class="val" id="pc_res">â€”</span>
                    <div id="pc_status" class="status">Enter clarifier data...</div>
                    <button class="btn-copy" onclick="copyVal('pc_res')">Copy Result</button>
                </div>
                <div class="formula-note">SOR = Flow Ã· Area | DT = Volume Ã· Flow | WLR = Flow Ã· Weir Length</div>
                <button class="diagram-toggle" onclick="toggleDiagram(80,'primary')">ðŸ“Š Show Primary Clarifier Diagram</button>
            </div>
        </div>
    </div>

    <!-- 81. Secondary Clarifier Design -->
    <div class="card" id="card81" data-calc="secclar" style="border-left-color: #6366f1;">
        <div class="card-header" onclick="toggleCard(81)">
            <h2><span class="card-num" style="background: #6366f1;">81</span> Secondary Clarifier Design <span class="diagram-badge">DIAGRAM</span></h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #6366f1;">Calculate secondary clarifier design: SOR, SLR, and RAS requirements for activated sludge settling.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="sc2_flow" oninput="calcSecClar()" placeholder="2.0">
                    </div>
                    <div>
                        <label>RAS Rate (MGD)</label>
                        <input type="number" inputmode="decimal" id="sc2_ras" oninput="calcSecClar()" placeholder="1.0">
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>Diameter (ft)</label>
                        <input type="number" inputmode="decimal" id="sc2_dia" oninput="calcSecClar()" placeholder="80">
                    </div>
                    <div>
                        <label>MLSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="sc2_mlss" oninput="calcSecClar()" placeholder="3000">
                    </div>
                </div>
                <div class="example-box"><b>Secondary Design:</b> SOR 400-800 GPD/ftÂ² | SLR 20-30 lb/day/ftÂ² | Peak SOR â‰¤1200 | RAS typically 25-75% of flow</div>
                <div class="result-box">
                    <span class="val" id="sc2_res">â€”</span>
                    <div id="sc2_status" class="status">Enter clarifier data...</div>
                    <button class="btn-copy" onclick="copyVal('sc2_res')">Copy Result</button>
                </div>
                <div class="formula-note">SLR = (Q + Q_RAS) Ã— MLSS Ã— 8.34 Ã· Area</div>
                <button class="diagram-toggle" onclick="toggleDiagram(81,'clarifier')">ðŸ“Š Show Clarifier Process Diagram</button>
            </div>
        </div>
    </div>

    <!-- 82. Grit Chamber Design -->
    <div class="card" id="card82" data-calc="grit" style="border-left-color: #6366f1;">
        <div class="card-header" onclick="toggleCard(82)">
            <h2><span class="card-num" style="background: #6366f1;">82</span> Grit Chamber Design <span class="diagram-badge">DIAGRAM</span></h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #6366f1;">Calculate grit chamber sizing for horizontal flow or aerated grit removal. Targets 0.21 mm particles.</div>
                <div class="grid">
                    <div>
                        <label>Peak Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="grit_flow" oninput="calcGrit()" placeholder="4.0">
                    </div>
                    <div>
                        <label>Chamber Type</label>
                        <select id="grit_type" onchange="calcGrit()" style="width:100%;padding:12px;border-radius:6px;border:2px solid #334155;background:#0f172a;color:#f8fafc;">
                            <option value="horiz">Horizontal Flow</option>
                            <option value="aerated">Aerated</option>
                            <option value="vortex">Vortex</option>
                        </select>
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>Detention Time (min)</label>
                        <input type="number" inputmode="decimal" id="grit_dt" oninput="calcGrit()" placeholder="3">
                        <span class="field-hint">Horiz: 1 min | Aerated: 2-5 min</span>
                    </div>
                    <div>
                        <label>Velocity (fps)</label>
                        <input type="number" inputmode="decimal" id="grit_vel" oninput="calcGrit()" placeholder="1.0">
                        <span class="field-hint">Horiz: 1.0 fps target</span>
                    </div>
                </div>
                <div class="example-box"><b>Design:</b> Horizontal DT=1min, V=1fps | Aerated DT=2-5min | Remove â‰¥95% of 0.21mm+ particles</div>
                <div class="result-box">
                    <span class="val" id="grit_res">â€”</span>
                    <div id="grit_status" class="status">Enter grit chamber data...</div>
                    <button class="btn-copy" onclick="copyVal('grit_res')">Copy Result</button>
                </div>
                <div class="formula-note">Volume = Flow Ã— DT | Area = Flow Ã· Overflow Rate</div>
                <button class="diagram-toggle" onclick="toggleDiagram(82,'grit_chamber')">ðŸ“Š Show Grit Chamber Diagram</button>
            </div>
        </div>
    </div>

    <!-- 83. Chlorine Contact Chamber -->
    <div class="card" id="card83" data-calc="ccc" style="border-left-color: #6366f1;">
        <div class="card-header" onclick="toggleCard(83)">
            <h2><span class="card-num" style="background: #6366f1;">83</span> Chlorine Contact Chamber</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #6366f1;">Calculate contact chamber sizing to achieve required CT value for disinfection. TCEQ requires minimum 20-min contact at peak flow.</div>
                <div class="grid">
                    <div>
                        <label>Peak Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="ccc_flow" oninput="calcCCC()" placeholder="2.0">
                    </div>
                    <div>
                        <label>Required Contact Time (min)</label>
                        <input type="number" inputmode="decimal" id="ccc_time" oninput="calcCCC()" placeholder="20">
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>Chlorine Residual (mg/L)</label>
                        <input type="number" inputmode="decimal" id="ccc_cl2" oninput="calcCCC()" placeholder="1.0">
                    </div>
                    <div>
                        <label>Baffling Factor</label>
                        <input type="number" inputmode="decimal" id="ccc_bf" oninput="calcCCC()" placeholder="0.7" step="0.1">
                        <span class="field-hint">Poor=0.3 | Avg=0.5 | Good=0.7</span>
                    </div>
                </div>
                <div class="example-box"><b>TCEQ:</b> 20 min @ peak | CT â‰¥ 25-30 mgÂ·min/L typical | Baffling: Serpentine=0.7, Single=0.3</div>
                <div class="result-box">
                    <span class="val" id="ccc_res">â€”</span>
                    <div id="ccc_status" class="status">Enter chamber data...</div>
                    <button class="btn-copy" onclick="copyVal('ccc_res')">Copy Result</button>
                </div>
                <div class="formula-note">Volume = Flow Ã— Time Ã· Baffling | CT = Clâ‚‚ Ã— Time</div>
            </div>
        </div>
    </div>

    <!-- ========== SLUDGE DISPOSAL CALCULATORS ========== -->
    <div class="section-header" data-cat="sludge" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(168, 85, 247, 0.15); border-radius: 8px; border-left: 4px solid #a855f7; font-size: 0.85rem; color: #c084fc; font-weight: bold;">ðŸ’© Sludge Disposal â€“ Advanced Calculators</div>

    <!-- 84. Belt Filter Press -->
    <div class="card" id="card84" data-calc="bfp" style="border-left-color: #a855f7;">
        <div class="card-header" onclick="toggleCard(84)">
            <h2><span class="card-num" style="background: #a855f7;">84</span> Belt Filter Press <span class="diagram-badge">DIAGRAM</span></h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #a855f7;">Calculate belt press performance: hydraulic and solids loading, polymer dose, and cake solids prediction.</div>
                <div class="grid">
                    <div>
                        <label>Sludge Feed (GPM)</label>
                        <input type="number" inputmode="decimal" id="bfp_flow" oninput="calcBFP()" placeholder="100">
                    </div>
                    <div>
                        <label>Feed Solids (%)</label>
                        <input type="number" inputmode="decimal" id="bfp_feed" oninput="calcBFP()" placeholder="3.0">
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>Belt Width (m)</label>
                        <input type="number" inputmode="decimal" id="bfp_width" oninput="calcBFP()" placeholder="2.0">
                    </div>
                    <div>
                        <label>Polymer Dose (lb/DT)</label>
                        <input type="number" inputmode="decimal" id="bfp_poly" oninput="calcBFP()" placeholder="8">
                        <span class="field-hint">lb per dry ton</span>
                    </div>
                </div>
                <div class="example-box"><b>Targets:</b> Hydraulic 50-100 GPM/m | Solids 500-1000 lb/hr/m | Cake 18-25% | Polymer 4-10 lb/DT</div>
                <div class="result-box">
                    <span class="val" id="bfp_res">â€”</span>
                    <div id="bfp_status" class="status">Enter BFP data...</div>
                    <button class="btn-copy" onclick="copyVal('bfp_res')">Copy Result</button>
                </div>
                <div class="formula-note">Solids Load = GPM Ã— 8.34 Ã— %TS Ã— 60 Ã· 2000 (lb DS/hr)</div>
                <button class="diagram-toggle" onclick="toggleDiagram(84,'dewatering')">ðŸ“Š Show Belt Filter Press Diagram</button>
            </div>
        </div>
    </div>

    <!-- 85. Centrifuge Performance -->
    <div class="card" id="card85" data-calc="centrifuge" style="border-left-color: #a855f7;">
        <div class="card-header" onclick="toggleCard(85)">
            <h2><span class="card-num" style="background: #a855f7;">85</span> Centrifuge Performance</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #a855f7;">Calculate centrifuge solids capture rate and recovery. Essential for dewatering optimization.</div>
                <div class="grid">
                    <div>
                        <label>Feed Solids (%)</label>
                        <input type="number" inputmode="decimal" id="cent_feed" oninput="calcCentrifuge()" placeholder="3.0">
                    </div>
                    <div>
                        <label>Cake Solids (%)</label>
                        <input type="number" inputmode="decimal" id="cent_cake" oninput="calcCentrifuge()" placeholder="22">
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>Centrate TSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="cent_centrate" oninput="calcCentrifuge()" placeholder="500">
                    </div>
                    <div>
                        <label>Feed Rate (GPM)</label>
                        <input type="number" inputmode="decimal" id="cent_gpm" oninput="calcCentrifuge()" placeholder="150">
                    </div>
                </div>
                <div class="example-box"><b>Targets:</b> Capture >95% | Cake 20-28% | Centrate <1000 mg/L TSS | Polymer 15-25 lb/DT</div>
                <div class="result-box">
                    <span class="val" id="cent_res">â€” % capture</span>
                    <div id="cent_status" class="status">Enter centrifuge data...</div>
                    <button class="btn-copy" onclick="copyVal('cent_res')">Copy Result</button>
                </div>
                <div class="formula-note">Capture = (Feed - Centrate) Ã· Feed Ã— 100</div>
            </div>
        </div>
    </div>

    <!-- 86. Sludge Drying Beds -->
    <div class="card" id="card86" data-calc="drybed" style="border-left-color: #a855f7;">
        <div class="card-header" onclick="toggleCard(86)">
            <h2><span class="card-num" style="background: #a855f7;">86</span> Sludge Drying Beds</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #a855f7;">Calculate drying bed area requirements based on solids loading and climate conditions.</div>
                <div class="grid">
                    <div>
                        <label>Sludge Production (lb DS/day)</label>
                        <input type="number" inputmode="decimal" id="db_prod" oninput="calcDryBed()" placeholder="1000">
                    </div>
                    <div>
                        <label>Loading Rate (lb/ftÂ²/yr)</label>
                        <input type="number" inputmode="decimal" id="db_load" oninput="calcDryBed()" placeholder="25">
                        <span class="field-hint">15-25 typical</span>
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>Drying Cycle (days)</label>
                        <input type="number" inputmode="decimal" id="db_cycle" oninput="calcDryBed()" placeholder="21">
                    </div>
                    <div>
                        <label>Application Depth (in)</label>
                        <input type="number" inputmode="decimal" id="db_depth" oninput="calcDryBed()" placeholder="9">
                    </div>
                </div>
                <div class="example-box"><b>Loading:</b> Open beds 15-25 lb/ftÂ²/yr | Covered 25-35 | Dry to 25-40% solids | Texas: 20-30 day cycles</div>
                <div class="result-box">
                    <span class="val" id="db_res">â€” ftÂ²</span>
                    <div id="db_status" class="status">Enter drying bed data...</div>
                    <button class="btn-copy" onclick="copyVal('db_res')">Copy Result</button>
                </div>
                <div class="formula-note">Area = (lb DS/day Ã— 365) Ã· Loading Rate</div>
            </div>
        </div>
    </div>

    <!-- 87. Hauling Cost Calculator -->
    <div class="card" id="card87" data-calc="haul" style="border-left-color: #a855f7;">
        <div class="card-header" onclick="toggleCard(87)">
            <h2><span class="card-num" style="background: #a855f7;">87</span> Sludge Hauling Cost</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #a855f7;">Calculate biosolids hauling costs based on cake solids, distance, and disposal fees.</div>
                <div class="grid">
                    <div>
                        <label>Dry Solids (lb/day)</label>
                        <input type="number" inputmode="decimal" id="haul_ds" oninput="calcHauling()" placeholder="2000">
                    </div>
                    <div>
                        <label>Cake Solids (%)</label>
                        <input type="number" inputmode="decimal" id="haul_cake" oninput="calcHauling()" placeholder="22">
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>Hauling Cost ($/wet ton)</label>
                        <input type="number" inputmode="decimal" id="haul_cost" oninput="calcHauling()" placeholder="45">
                    </div>
                    <div>
                        <label>Disposal Fee ($/wet ton)</label>
                        <input type="number" inputmode="decimal" id="haul_disp" oninput="calcHauling()" placeholder="25">
                    </div>
                </div>
                <div class="example-box"><b>Cost impact:</b> Every 1% increase in cake solids â‰ˆ 4-5% reduction in hauling volume!</div>
                <div class="result-box">
                    <span class="val" id="haul_res">â€”</span>
                    <div id="haul_status" class="status">Enter hauling data...</div>
                    <button class="btn-copy" onclick="copyVal('haul_res')">Copy Result</button>
                </div>
                <div class="formula-note">Wet tons = Dry lb Ã· % Cake Ã· 2000 | Cost = Wet tons Ã— (Haul + Disposal)</div>
            </div>
        </div>
    </div>

    <!-- 88. Class A/B Pathogen Reduction -->
    <div class="card" id="card88" data-calc="pathogen" style="border-left-color: #a855f7;">
        <div class="card-header" onclick="toggleCard(88)">
            <h2><span class="card-num" style="background: #a855f7;">88</span> Class A/B Pathogen Reduction</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #a855f7;">Check EPA 503 pathogen reduction requirements for Class A and Class B biosolids.</div>
                <div class="grid">
                    <div>
                        <label>Target Class</label>
                        <select id="path_class" onchange="calcPathogen()" style="width:100%;padding:12px;border-radius:6px;border:2px solid #334155;background:#0f172a;color:#f8fafc;">
                            <option value="A">Class A (Unrestricted Use)</option>
                            <option value="B">Class B (Restricted Use)</option>
                        </select>
                    </div>
                    <div>
                        <label>PFRP Method</label>
                        <select id="path_method" onchange="calcPathogen()" style="width:100%;padding:12px;border-radius:6px;border:2px solid #334155;background:#0f172a;color:#f8fafc;">
                            <option value="thermo">Thermophilic Digestion</option>
                            <option value="lime">Lime Stabilization</option>
                            <option value="compost">Composting</option>
                            <option value="heat">Heat Drying</option>
                            <option value="psrp">PSRP (Class B)</option>
                        </select>
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>Temperature (Â°F)</label>
                        <input type="number" inputmode="decimal" id="path_temp" oninput="calcPathogen()" placeholder="131">
                    </div>
                    <div>
                        <label>Time at Temp (hours)</label>
                        <input type="number" inputmode="decimal" id="path_time" oninput="calcPathogen()" placeholder="24">
                    </div>
                </div>
                <div class="example-box"><b>Class A:</b> <1000 MPN fecal coliform/g OR <3 MPN Salmonella/4g | <b>Class B:</b> <2M MPN fecal coliform/g</div>
                <div class="result-box">
                    <span class="val" id="path_res">â€”</span>
                    <div id="path_status" class="status">Select pathogen reduction method...</div>
                    <button class="btn-copy" onclick="copyVal('path_res')">Copy Result</button>
                </div>
                <div class="formula-note">40 CFR 503 Subpart D requirements</div>
            </div>
        </div>
    </div>

    <!-- ========== LABORATORY CALCULATORS ========== -->
    <div class="section-header" data-cat="lab" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(236, 72, 153, 0.15); border-radius: 8px; border-left: 4px solid #ec4899; font-size: 0.85rem; color: #f472b6; font-weight: bold;">ðŸ”¬ Laboratory Calculators</div>

    <!-- 89. BOD Dilution -->
    <div class="card" id="card89" data-calc="boddil" style="border-left-color: #ec4899;">
        <div class="card-header" onclick="toggleCard(89)">
            <h2><span class="card-num" style="background: #ec4899;">89</span> BOD Dilution Calculator</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #ec4899;">Calculate proper dilutions for BODâ‚… test. Target 2+ mg/L DO depletion and final DO â‰¥1 mg/L for valid test.</div>
                <div class="grid">
                    <div>
                        <label>Expected BOD (mg/L)</label>
                        <input type="number" inputmode="decimal" id="bod_expected" oninput="calcBODDilution()" placeholder="150">
                    </div>
                    <div>
                        <label>BOD Bottle Size (mL)</label>
                        <input type="number" inputmode="decimal" id="bod_bottle" oninput="calcBODDilution()" placeholder="300" value="300">
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>Initial DO (mg/L)</label>
                        <input type="number" inputmode="decimal" id="bod_do1" oninput="calcBODDilution()" placeholder="8.5">
                    </div>
                    <div>
                        <label>Final DO (mg/L)</label>
                        <input type="number" inputmode="decimal" id="bod_do2" oninput="calcBODDilution()" placeholder="3.0">
                    </div>
                </div>
                <div class="example-box"><b>Sample sizes:</b> Effluent (5-20 BOD): 100-300 mL | Primary (100-300): 5-15 mL | Raw (200-400): 2-10 mL</div>
                <div class="result-box">
                    <span class="val" id="bod_res">â€”</span>
                    <div id="bod_status" class="status">Enter expected BOD or test results...</div>
                    <button class="btn-copy" onclick="copyVal('bod_res')">Copy Result</button>
                </div>
                <div class="formula-note">BOD = (DOâ‚ - DOâ‚‚) Ã— Bottle Vol Ã· Sample Vol | Valid: DO depletion â‰¥2 mg/L, Final DO â‰¥1</div>
            </div>
        </div>
    </div>

    <!-- 90. Composite Sample Calculator -->
    <div class="card" id="card90" data-calc="composite" style="border-left-color: #ec4899;">
        <div class="card-header" onclick="toggleCard(90)">
            <h2><span class="card-num" style="background: #ec4899;">90</span> Composite Sample Calculator</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #ec4899;">Calculate flow-proportional composite sample volumes for TCEQ compliance sampling.</div>
                <div class="grid">
                    <div>
                        <label>Sample Interval (hr)</label>
                        <input type="number" inputmode="decimal" id="comp_interval" oninput="calcComposite()" placeholder="1">
                    </div>
                    <div>
                        <label>Total Composite (mL)</label>
                        <input type="number" inputmode="decimal" id="comp_total" oninput="calcComposite()" placeholder="2000">
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>Sample Period (hr)</label>
                        <input type="number" inputmode="decimal" id="comp_period" oninput="calcComposite()" placeholder="24">
                    </div>
                    <div>
                        <label>Avg Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="comp_avgflow" oninput="calcComposite()" placeholder="1.0">
                    </div>
                </div>
                <div style="margin:10px 0;padding:10px;background:#0f172a;border-radius:6px;">
                    <label style="color:#f472b6;font-size:0.75rem;font-weight:bold;">Flow at Sample Times (MGD) - comma separated</label>
                    <input type="text" id="comp_flows" oninput="calcComposite()" placeholder="0.8, 1.0, 1.2, 0.9" style="width:100%;padding:10px;margin-top:6px;border-radius:6px;border:2px solid #334155;background:#1e293b;color:#f8fafc;">
                </div>
                <div class="example-box"><b>TCEQ:</b> 24-hr composite typical | Min 6 aliquots | Flow-proportional preferred | Min 100 mL per aliquot</div>
                <div class="result-box">
                    <span class="val" id="comp_res">â€”</span>
                    <div id="comp_status" class="status">Enter sampling parameters...</div>
                    <button class="btn-copy" onclick="copyVal('comp_res')">Copy Result</button>
                </div>
                <div class="formula-note">Vol per sample = (Flow at time Ã· Total Flow) Ã— Total Composite Vol</div>
            </div>
        </div>
    </div>

    <!-- ========== TCEQ TOOLS ========== -->
    <div class="section-header" data-cat="tceq" style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(220, 38, 38, 0.15); border-radius: 8px; border-left: 4px solid #dc2626; font-size: 0.85rem; color: #fca5a5; font-weight: bold;">ðŸ›ï¸ TCEQ Compliance Tools</div>

    <!-- 91. DMR Calculator -->
    <div class="card" id="card91" data-calc="dmr" style="border-left-color: #dc2626;">
        <div class="card-header" onclick="toggleCard(91)">
            <h2><span class="card-num" style="background: #dc2626;">91</span> DMR Calculator</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #dc2626;">Calculate monthly averages, maximums, and loading for Discharge Monitoring Reports. Automatically flags permit exceedances.</div>
                
                <div style="margin-bottom:10px;">
                    <button onclick="document.getElementById('dmr_guide').style.display = document.getElementById('dmr_guide').style.display === 'none' ? 'block' : 'none'; this.innerText = document.getElementById('dmr_guide').style.display === 'none' ? 'ðŸ“– How to Use â–¸' : 'ðŸ“– How to Use â–¾'" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid #dc2626;background:rgba(220,38,38,0.08);color:#fca5a5;font-weight:bold;font-size:0.82rem;cursor:pointer;text-align:left;">ðŸ“– How to Use â–¸</button>
                    <div id="dmr_guide" style="display:none;margin-top:8px;background:#0c1222;border:1px solid #334155;border-radius:8px;padding:14px;font-size:0.8rem;color:#cbd5e1;line-height:1.7;">
                        <div style="color:#fca5a5;font-weight:bold;font-size:0.85rem;margin-bottom:8px;">DMR CALCULATOR â€” COMPLETE OPERATOR GUIDE</div>
                        
                        <div style="color:#f8fafc;font-weight:bold;">What is a DMR?</div>
                        The Discharge Monitoring Report (DMR) is a required monthly report submitted to TCEQ documenting your effluent quality. It's your proof of permit compliance. Errors on DMRs are one of the top violations cited during inspections.
                        
                        <div style="color:#f8fafc;font-weight:bold;margin-top:12px;">Step-by-Step Instructions</div>
                        <div style="background:#1e293b;border-radius:6px;padding:10px;margin:6px 0;">
                            <b style="color:#60a5fa;">Step 1: Select Parameter</b><br>
                            Choose the parameter you're calculating (BODâ‚…, TSS, NHâ‚ƒ-N, etc.). This helps track which values you're entering.<br><br>
                            
                            <b style="color:#60a5fa;">Step 2: Enter Permit Limits</b><br>
                            â€¢ <b>Permit Limit (Avg)</b> â€” Your monthly average limit from your permit. Example: 30 mg/L for BODâ‚….<br>
                            â€¢ <b>Permit Limit (Max)</b> â€” Your daily maximum limit. Example: 45 mg/L for BODâ‚….<br>
                            Find these in your TPDES permit, Page 2a (Effluent Limitations).<br><br>
                            
                            <b style="color:#60a5fa;">Step 3: Enter Average Flow</b><br>
                            Enter your monthly average flow in MGD. This is used to calculate mass loading (lbs/day). Get this from your flow totalizer or daily logs.<br><br>
                            
                            <b style="color:#60a5fa;">Step 4: Enter Daily Values</b><br>
                            Enter all your sample results for the month. You can:<br>
                            â€¢ Separate with commas: 22, 25, 28, 24, 26<br>
                            â€¢ One value per line<br>
                            â€¢ Mix both formats<br>
                            The calculator will parse them automatically.
                        </div>
                        
                        <div style="color:#f8fafc;font-weight:bold;margin-top:12px;">What the Results Mean</div>
                        <div style="background:#1e293b;border-radius:6px;padding:10px;margin:6px 0;">
                            <b>ðŸ“Š Monthly Avg</b> â€” The arithmetic mean of all values. This is what you report as "Monthly Average" on the DMR.<br><br>
                            <b>ðŸ“ˆ Daily Max</b> â€” The highest single value. Report this as "Daily Maximum."<br><br>
                            <b>ðŸ“‰ Daily Min</b> â€” The lowest value (for reference, not usually reported).<br><br>
                            <b>ðŸ“… Sample Count</b> â€” Number of values entered. Verify this matches your sampling frequency.<br><br>
                            <b>ðŸ“¦ Loading</b> â€” Mass discharge in lbs/day. Calculated as: Concentration Ã— Flow Ã— 8.34. Many permits have mass limits in addition to concentration limits.
                        </div>
                        
                        <div style="color:#f8fafc;font-weight:bold;margin-top:12px;">Exceedance Color Codes</div>
                        <div style="background:#1e293b;border-radius:6px;padding:10px;margin:6px 0;">
                            <span style="color:#22c55e;">âœ“ Green (OK)</span> â€” Below 90% of limit. You're in good shape.<br>
                            <span style="color:#f59e0b;">âš ï¸ Yellow (Approaching)</span> â€” 90-100% of limit. Be careful, take action now.<br>
                            <span style="color:#ef4444;">ðŸ”´ Red (EXCEEDED)</span> â€” Over the limit. This is a permit violation that must be reported.
                        </div>
                        
                        <div style="color:#f8fafc;font-weight:bold;margin-top:12px;">TCEQ DMR Requirements</div>
                        <div style="background:rgba(220,38,38,0.1);border-radius:6px;padding:10px;margin:6px 0;border-left:3px solid #dc2626;">
                            â€¢ <b>Due Date:</b> 20th of the month following the reporting period<br>
                            â€¢ <b>Late DMRs:</b> Violation even if all values are in compliance<br>
                            â€¢ <b>No Data:</b> Enter "NODI" code with explanation (e.g., "NODI-C" = conditional monitoring not triggered)<br>
                            â€¢ <b>Below Detection:</b> Report as "<[detection limit]" or use 1/2 detection limit for averaging<br>
                            â€¢ <b>Significant Figures:</b> Report to same precision as your permit limit<br>
                            â€¢ <b>Exceedances:</b> Must be reported within 24 hours if >40% over limit, then written report within 5 days
                        </div>
                        
                        <div style="color:#f8fafc;font-weight:bold;margin-top:12px;">Common Permit Limits (Texas)</div>
                        <div style="background:#1e293b;border-radius:6px;padding:10px;margin:6px 0;">
                            <table style="width:100%;font-size:0.75rem;color:#cbd5e1;">
                                <tr style="border-bottom:1px solid #475569;"><th style="text-align:left;padding:4px;">Parameter</th><th>Monthly Avg</th><th>Daily Max</th><th>Loading</th></tr>
                                <tr><td style="padding:4px;">BODâ‚…</td><td>20-30 mg/L</td><td>45 mg/L</td><td>Often limited</td></tr>
                                <tr><td style="padding:4px;">TSS</td><td>20-30 mg/L</td><td>45 mg/L</td><td>Often limited</td></tr>
                                <tr><td style="padding:4px;">NHâ‚ƒ-N (summer)</td><td>2-6 mg/L</td><td>â€”</td><td>Sometimes</td></tr>
                                <tr><td style="padding:4px;">NHâ‚ƒ-N (winter)</td><td>4-15 mg/L</td><td>â€”</td><td>â€”</td></tr>
                                <tr><td style="padding:4px;">E. coli</td><td>126 geo mean</td><td>399 single</td><td>â€”</td></tr>
                                <tr><td style="padding:4px;">Clâ‚‚ Residual</td><td>â€”</td><td>0.5 mg/L</td><td>â€”</td></tr>
                                <tr><td style="padding:4px;">DO</td><td>â‰¥4.0 mg/L min</td><td>â€”</td><td>â€”</td></tr>
                                <tr><td style="padding:4px;">pH</td><td>6.0-9.0 SU</td><td>â€”</td><td>â€”</td></tr>
                            </table>
                        </div>
                        
                        <div style="color:#f8fafc;font-weight:bold;margin-top:12px;">Sampling Frequency Requirements</div>
                        <div style="background:#1e293b;border-radius:6px;padding:10px;margin:6px 0;">
                            Your permit specifies minimum sampling frequency:<br>
                            â€¢ <b>1/Week</b> â€” Most common for small plants (&lt;1 MGD)<br>
                            â€¢ <b>2/Week</b> â€” Common for 1-5 MGD plants<br>
                            â€¢ <b>3/Week</b> â€” Larger plants or sensitive receiving waters<br>
                            â€¢ <b>Daily</b> â€” Large plants or parameters like Clâ‚‚, pH, DO<br><br>
                            <span style="color:#f59e0b;">âš ï¸ Missing samples = violation, even if results would have been good</span>
                        </div>
                        
                        <div style="color:#f8fafc;font-weight:bold;margin-top:12px;">Example Calculation</div>
                        <div style="background:#1e293b;border-radius:6px;padding:10px;margin:6px 0;font-family:monospace;font-size:0.75rem;">
                            <b>Given:</b> Weekly BODâ‚… samples: 22, 28, 25, 31 mg/L<br>
                            Flow: 1.5 MGD | Permit: 30 avg / 45 max<br><br>
                            <b>Monthly Avg:</b> (22+28+25+31) Ã· 4 = <span style="color:#4ade80;">26.5 mg/L</span><br>
                            <b>Daily Max:</b> <span style="color:#4ade80;">31 mg/L</span><br>
                            <b>Loading:</b> 26.5 Ã— 1.5 Ã— 8.34 = <span style="color:#4ade80;">331.5 lbs/day</span><br>
                            <b>% of Limit:</b> 26.5 Ã· 30 Ã— 100 = <span style="color:#4ade80;">88%</span> âœ“
                        </div>
                        
                        <div style="color:#f8fafc;font-weight:bold;margin-top:12px;">TCEQ Class A Exam Tips</div>
                        <div style="background:rgba(59,130,246,0.1);border-radius:6px;padding:10px;margin:6px 0;border-left:3px solid #3b82f6;">
                            â€¢ <b>8.34 Factor:</b> Memorize this â€” it converts mg/L Ã— MGD to lbs/day<br>
                            â€¢ <b>Monthly Average:</b> Always arithmetic mean (add and divide)<br>
                            â€¢ <b>E. coli:</b> Uses GEOMETRIC mean, not arithmetic â€” use Calc #94<br>
                            â€¢ <b>pH:</b> Cannot be averaged arithmetically â€” report range or median<br>
                            â€¢ <b>Loading formula:</b> lbs/day = Conc (mg/L) Ã— Flow (MGD) Ã— 8.34<br>
                            â€¢ <b>Trick question:</b> "Weekly average" still uses arithmetic mean for that week<br>
                            â€¢ <b>Below detection:</b> Use Â½ detection limit for averaging (unless permit specifies otherwise)
                        </div>
                        
                        <div style="color:#f8fafc;font-weight:bold;margin-top:12px;">Common Mistakes to Avoid</div>
                        <div style="background:rgba(239,68,68,0.1);border-radius:6px;padding:10px;margin:6px 0;border-left:3px solid #ef4444;">
                            âŒ Forgetting to report exceedances within 24 hours<br>
                            âŒ Using geometric mean for BOD/TSS (only for bacteria)<br>
                            âŒ Averaging pH values arithmetically<br>
                            âŒ Missing the 20th deadline (even by 1 day = violation)<br>
                            âŒ Not keeping lab records to support DMR values<br>
                            âŒ Rounding incorrectly (26.5 â†’ 27 vs 26.5 â†’ 26)
                        </div>
                    </div>
                </div>
                
                <div class="grid">
                    <div>
                        <label>Parameter</label>
                        <select id="dmr_param" onchange="calcDMR()" style="width:100%;padding:10px;border-radius:6px;border:1px solid #475569;background:#0f172a;color:#f8fafc;">
                            <option value="bod">BODâ‚… (mg/L)</option>
                            <option value="tss">TSS (mg/L)</option>
                            <option value="nh3">NHâ‚ƒ-N (mg/L)</option>
                            <option value="ecoli">E. coli (MPN/100mL)</option>
                            <option value="cl2">Clâ‚‚ Residual (mg/L)</option>
                            <option value="ph">pH (SU)</option>
                            <option value="do">DO (mg/L)</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label>Permit Limit (Avg)</label>
                        <input type="number" inputmode="decimal" id="dmr_limit_avg" oninput="calcDMR()" placeholder="30">
                        <span class="field-hint">Monthly average limit</span>
                    </div>
                    <div>
                        <label>Permit Limit (Max)</label>
                        <input type="number" inputmode="decimal" id="dmr_limit_max" oninput="calcDMR()" placeholder="45">
                        <span class="field-hint">Daily maximum limit</span>
                    </div>
                    <div>
                        <label>Avg Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="dmr_flow" oninput="calcDMR()" placeholder="1.5">
                        <span class="field-hint">For loading calc</span>
                    </div>
                </div>
                
                <div style="margin:12px 0;">
                    <label style="display:block;margin-bottom:6px;">Daily Values (comma-separated or one per line)</label>
                    <textarea id="dmr_values" oninput="calcDMR()" placeholder="Enter daily values: 22, 25, 28, 24, 26..." style="width:100%;height:80px;padding:10px;border-radius:6px;border:1px solid #475569;background:#0f172a;color:#f8fafc;font-family:inherit;resize:vertical;"></textarea>
                    <span class="field-hint">Enter all sample results for the month</span>
                </div>
                
                <div class="example-box"><b>DMR Reporting:</b> Monthly Avg = Î£ values Ã· n | Daily Max = highest value | Loading = Conc Ã— Flow Ã— 8.34</div>
                <div class="result-box">
                    <span class="val" id="dmr_res">â€”</span>
                    <div id="dmr_status" class="status">Enter daily values...</div>
                    <button class="btn-copy" onclick="copyVal('dmr_res')">Copy Result</button>
                </div>
                <div class="formula-note">Loading (lbs/day) = Concentration (mg/L) Ã— Flow (MGD) Ã— 8.34</div>
            </div>
        </div>
    </div>

    <!-- 92. Permit Limit Tracker -->
    <div class="card" id="card92" data-calc="permit" style="border-left-color: #dc2626;">
        <div class="card-header" onclick="toggleCard(92)">
            <h2><span class="card-num" style="background: #dc2626;">92</span> Permit Limit Tracker</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #dc2626;">Track your permit limits and current performance. Shows % of limit used and warns when approaching exceedance.</div>
                
                <div id="permitTracker" style="margin-bottom:15px;">
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:12px;">
                        <div style="background:#1e293b;border-radius:8px;padding:12px;border-left:3px solid #22c55e;">
                            <div style="font-size:0.7rem;color:#94a3b8;">BODâ‚… Avg</div>
                            <div style="font-size:1.1rem;font-weight:bold;color:#4ade80;" id="perm_bod">â€”</div>
                            <div style="font-size:0.65rem;color:#64748b;">Limit: 30 mg/L</div>
                        </div>
                        <div style="background:#1e293b;border-radius:8px;padding:12px;border-left:3px solid #22c55e;">
                            <div style="font-size:0.7rem;color:#94a3b8;">TSS Avg</div>
                            <div style="font-size:1.1rem;font-weight:bold;color:#4ade80;" id="perm_tss">â€”</div>
                            <div style="font-size:0.65rem;color:#64748b;">Limit: 30 mg/L</div>
                        </div>
                        <div style="background:#1e293b;border-radius:8px;padding:12px;border-left:3px solid #22c55e;">
                            <div style="font-size:0.7rem;color:#94a3b8;">NHâ‚ƒ-N Avg</div>
                            <div style="font-size:1.1rem;font-weight:bold;color:#4ade80;" id="perm_nh3">â€”</div>
                            <div style="font-size:0.65rem;color:#64748b;">Limit: 3 mg/L</div>
                        </div>
                        <div style="background:#1e293b;border-radius:8px;padding:12px;border-left:3px solid #22c55e;">
                            <div style="font-size:0.7rem;color:#94a3b8;">E. coli Geo</div>
                            <div style="font-size:1.1rem;font-weight:bold;color:#4ade80;" id="perm_ecoli">â€”</div>
                            <div style="font-size:0.65rem;color:#64748b;">Limit: 126/100mL</div>
                        </div>
                    </div>
                </div>
                
                <div class="grid">
                    <div>
                        <label>Parameter</label>
                        <select id="perm_param" style="width:100%;padding:10px;border-radius:6px;border:1px solid #475569;background:#0f172a;color:#f8fafc;">
                            <option value="bod">BODâ‚…</option>
                            <option value="tss">TSS</option>
                            <option value="nh3">NHâ‚ƒ-N</option>
                            <option value="ecoli">E. coli</option>
                        </select>
                    </div>
                    <div>
                        <label>Current Value</label>
                        <input type="number" inputmode="decimal" id="perm_value" placeholder="24">
                    </div>
                    <div>
                        <label>Permit Limit</label>
                        <input type="number" inputmode="decimal" id="perm_limit" placeholder="30">
                    </div>
                </div>
                <button onclick="updatePermitCard()" style="width:100%;margin-top:10px;padding:12px;border-radius:8px;border:none;background:linear-gradient(135deg,#dc2626,#b91c1c);color:#fff;font-weight:bold;cursor:pointer;">Update Tracker</button>
                
                <div class="example-box" style="margin-top:12px;"><b>Status Colors:</b> ðŸŸ¢ <80% of limit | ðŸŸ¡ 80-95% | ðŸ”´ >95% or exceeded</div>
            </div>
        </div>
    </div>

    <!-- 93. TCEQ Inspection Checklist -->
    <div class="card" id="card93" data-calc="inspect" style="border-left-color: #dc2626;">
        <div class="card-header" onclick="toggleCard(93)">
            <h2><span class="card-num" style="background: #dc2626;">93</span> TCEQ Inspection Checklist</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #dc2626;">Comprehensive checklist of what TCEQ inspectors look for. Use before inspections to ensure compliance.</div>
                
                <div style="margin-bottom:10px;">
                    <button onclick="document.getElementById('insp_guide').style.display = document.getElementById('insp_guide').style.display === 'none' ? 'block' : 'none'; this.innerText = document.getElementById('insp_guide').style.display === 'none' ? 'ðŸ“– Inspection Tips â–¸' : 'ðŸ“– Inspection Tips â–¾'" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid #dc2626;background:rgba(220,38,38,0.08);color:#fca5a5;font-weight:bold;font-size:0.82rem;cursor:pointer;text-align:left;">ðŸ“– Inspection Tips â–¸</button>
                    <div id="insp_guide" style="display:none;margin-top:8px;background:#0c1222;border:1px solid #334155;border-radius:8px;padding:14px;font-size:0.8rem;color:#cbd5e1;line-height:1.7;">
                        <div style="color:#fca5a5;font-weight:bold;font-size:0.85rem;margin-bottom:8px;">TCEQ INSPECTION PREPARATION</div>
                        
                        <div style="color:#f8fafc;font-weight:bold;">Before the Inspector Arrives</div>
                        <div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:4px 0;">
                            â€¢ Have permit and all amendments readily available<br>
                            â€¢ DMRs for past 3 years organized<br>
                            â€¢ O&M manual accessible<br>
                            â€¢ Lab QA/QC records ready<br>
                            â€¢ Training records for all operators<br>
                            â€¢ Calibration logs for all meters
                        </div>
                        
                        <div style="color:#f8fafc;font-weight:bold;margin-top:10px;">Common Violations</div>
                        <div style="background:rgba(220,38,38,0.1);border-radius:6px;padding:8px 10px;margin:4px 0;border-left:3px solid #dc2626;">
                            â€¢ Inadequate operator coverage/licensing<br>
                            â€¢ Missing or incomplete logs<br>
                            â€¢ Permit limit exceedances not reported<br>
                            â€¢ Bypasses not properly documented<br>
                            â€¢ SSO reporting failures<br>
                            â€¢ Lab certification issues
                        </div>
                    </div>
                </div>
                
                <div id="inspChecklist" style="background:#0f172a;border-radius:8px;padding:12px;">
                    <div style="font-weight:bold;color:#fca5a5;margin-bottom:10px;font-size:0.9rem;">ðŸ“‹ Pre-Inspection Checklist</div>
                    
                    <div style="font-size:0.8rem;color:#94a3b8;margin:8px 0 4px;font-weight:bold;">PERMITS & RECORDS</div>
                    <label class="insp-item"><input type="checkbox" onchange="updateInspProgress()"> Current permit on-site</label>
                    <label class="insp-item"><input type="checkbox" onchange="updateInspProgress()"> DMRs filed and organized (3 years)</label>
                    <label class="insp-item"><input type="checkbox" onchange="updateInspProgress()"> Daily logs complete and signed</label>
                    <label class="insp-item"><input type="checkbox" onchange="updateInspProgress()"> O&M manual available</label>
                    <label class="insp-item"><input type="checkbox" onchange="updateInspProgress()"> Emergency response plan posted</label>
                    
                    <div style="font-size:0.8rem;color:#94a3b8;margin:12px 0 4px;font-weight:bold;">OPERATOR REQUIREMENTS</div>
                    <label class="insp-item"><input type="checkbox" onchange="updateInspProgress()"> Licensed operator on-site or on-call</label>
                    <label class="insp-item"><input type="checkbox" onchange="updateInspProgress()"> Operator licenses current and posted</label>
                    <label class="insp-item"><input type="checkbox" onchange="updateInspProgress()"> Training records up to date</label>
                    <label class="insp-item"><input type="checkbox" onchange="updateInspProgress()"> Shift coverage documented</label>
                    
                    <div style="font-size:0.8rem;color:#94a3b8;margin:12px 0 4px;font-weight:bold;">LABORATORY & MONITORING</div>
                    <label class="insp-item"><input type="checkbox" onchange="updateInspProgress()"> Lab certified or approved contract lab</label>
                    <label class="insp-item"><input type="checkbox" onchange="updateInspProgress()"> QA/QC records maintained</label>
                    <label class="insp-item"><input type="checkbox" onchange="updateInspProgress()"> Flow meters calibrated annually</label>
                    <label class="insp-item"><input type="checkbox" onchange="updateInspProgress()"> pH/DO meters calibrated daily</label>
                    <label class="insp-item"><input type="checkbox" onchange="updateInspProgress()"> Chlorine residual analyzer calibrated</label>
                    
                    <div style="font-size:0.8rem;color:#94a3b8;margin:12px 0 4px;font-weight:bold;">FACILITY & EQUIPMENT</div>
                    <label class="insp-item"><input type="checkbox" onchange="updateInspProgress()"> Fencing secure, gates locked</label>
                    <label class="insp-item"><input type="checkbox" onchange="updateInspProgress()"> Warning signs posted</label>
                    <label class="insp-item"><input type="checkbox" onchange="updateInspProgress()"> No unauthorized discharges</label>
                    <label class="insp-item"><input type="checkbox" onchange="updateInspProgress()"> Solids disposal records available</label>
                    <label class="insp-item"><input type="checkbox" onchange="updateInspProgress()"> Chemical storage proper (secondary containment)</label>
                    <label class="insp-item"><input type="checkbox" onchange="updateInspProgress()"> No odor complaints documented</label>
                    
                    <div style="font-size:0.8rem;color:#94a3b8;margin:12px 0 4px;font-weight:bold;">COLLECTION SYSTEM</div>
                    <label class="insp-item"><input type="checkbox" onchange="updateInspProgress()"> SSO log maintained</label>
                    <label class="insp-item"><input type="checkbox" onchange="updateInspProgress()"> Lift station inspections current</label>
                    <label class="insp-item"><input type="checkbox" onchange="updateInspProgress()"> I&I assessment documented</label>
                    <label class="insp-item"><input type="checkbox" onchange="updateInspProgress()"> Grease trap program active</label>
                </div>
                
                <div style="margin-top:12px;padding:12px;background:#1e293b;border-radius:8px;display:flex;justify-content:space-between;align-items:center;">
                    <div>
                        <div style="font-size:0.8rem;color:#94a3b8;">Completion</div>
                        <div style="font-size:1.3rem;font-weight:bold;color:#4ade80;" id="inspProgress">0%</div>
                    </div>
                    <div style="flex:1;margin:0 15px;">
                        <div style="height:8px;background:#334155;border-radius:4px;overflow:hidden;">
                            <div id="inspBar" style="height:100%;width:0%;background:linear-gradient(90deg,#dc2626,#22c55e);transition:width 0.3s;"></div>
                        </div>
                    </div>
                    <button onclick="resetInspChecklist()" style="padding:8px 12px;border-radius:6px;border:1px solid #475569;background:transparent;color:#94a3b8;font-size:0.75rem;cursor:pointer;">Reset</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 94. Geometric Mean Calculator -->
    <div class="card" id="card94" data-calc="geomean" style="border-left-color: #dc2626;">
        <div class="card-header" onclick="toggleCard(94)">
            <h2><span class="card-num" style="background: #dc2626;">94</span> Geometric Mean (E. coli)</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #dc2626;">Calculate geometric mean for E. coli or fecal coliform reporting. Required for DMR bacteria reporting.</div>
                
                <div style="margin:12px 0;">
                    <label style="display:block;margin-bottom:6px;">E. coli Values (MPN or CFU/100mL)</label>
                    <textarea id="geo_values" oninput="calcGeoMean()" placeholder="Enter values: 45, 120, 89, 156, 78..." style="width:100%;height:80px;padding:10px;border-radius:6px;border:1px solid #475569;background:#0f172a;color:#f8fafc;font-family:inherit;resize:vertical;"></textarea>
                    <span class="field-hint">Enter all sample results (minimum 5 for monthly)</span>
                </div>
                
                <div class="grid">
                    <div>
                        <label>Permit Limit (Geo Mean)</label>
                        <input type="number" inputmode="decimal" id="geo_limit" oninput="calcGeoMean()" placeholder="126">
                        <span class="field-hint">Typical: 126/100mL</span>
                    </div>
                    <div>
                        <label>Single Sample Max</label>
                        <input type="number" inputmode="decimal" id="geo_ssm" oninput="calcGeoMean()" placeholder="399">
                        <span class="field-hint">Typical: 399/100mL</span>
                    </div>
                </div>
                
                <div class="example-box"><b>Geometric Mean:</b> â¿âˆš(xâ‚ Ã— xâ‚‚ Ã— ... Ã— xâ‚™) â€” Used because bacteria counts are log-normally distributed</div>
                <div class="result-box">
                    <span class="val" id="geo_res">â€”</span>
                    <div id="geo_status" class="status">Enter E. coli values...</div>
                    <button class="btn-copy" onclick="copyVal('geo_res')">Copy Result</button>
                </div>
                <div class="formula-note">Geo Mean = (xâ‚ Ã— xâ‚‚ Ã— ... Ã— xâ‚™)^(1/n) = e^[(Î£ ln(x))/n]</div>
            </div>
        </div>
    </div>

    </div><!-- /card-grid-wrap -->
    <div class="version">
        <div style="font-size: 0.85rem; color: #94a3b8; margin-bottom: 4px;">Built by <b>Armand Frazier Sr.</b> | Houston, TX</div>
        WW Pro-Calc v9.14 â€“ 94 Calculators + 16 Wizards | Search Â· Filter Â· Favorites Â· Exam Mode Â· Trending
    </div>

    <!-- QR Share Section -->
    <div style="text-align:center;margin:10px 0 20px;padding:14px;background:#1e293b;border-radius:10px;">
        <button onclick="document.getElementById('qrModal').classList.add('active')" style="padding:10px 20px;border-radius:8px;border:1px solid #475569;background:transparent;color:#94a3b8;font-size:0.82rem;font-weight:600;cursor:pointer;">ðŸ“² Share This App (QR Code)</button>
    </div>

    <div class="whatsnew-overlay" id="qrModal" onclick="if(event.target===this)this.classList.remove('active')">
        <div class="whatsnew-box" style="max-width:340px;text-align:center;">
            <div class="whatsnew-header">
                <h3>ðŸ“² Share WW Pro-Calc</h3>
                <button onclick="document.getElementById('qrModal').classList.remove('active')" style="background:none;border:none;color:#94a3b8;font-size:1.3rem;cursor:pointer">âœ•</button>
            </div>
            <div style="padding:20px;">
                <canvas id="qrCanvas" width="200" height="200" style="border-radius:8px;background:#fff;padding:10px;"></canvas>
                <div style="margin-top:12px;font-size:0.78rem;color:#94a3b8;">Scan with any phone camera to open the app.<br>Works offline after first load.</div>
                <div style="margin-top:10px;font-size:0.7rem;color:#64748b;" id="qrUrl"></div>
            </div>
        </div>
    </div>
</div>

<!-- TCEQ Exam Mode -->
<button class="help-fab" id="helpFab" onclick="openHelpMenu()" title="Help & Tour">?</button>
<button class="back-to-top" id="backToTop" onclick="scrollToTop()" title="Back to Top">â†‘</button>

<!-- Onboarding Tour Modal -->
<div class="tour-overlay" id="tourOverlay" onclick="if(event.target===this)closeTour()">
    <div class="tour-box">
        <div class="tour-header">
            <h3>ðŸ‘‹ Welcome to WW Pro-Calc!</h3>
            <p>Quick tour to get you started</p>
            <div class="tour-progress">
                <span class="tour-dot active" data-step="1"></span>
                <span class="tour-dot" data-step="2"></span>
                <span class="tour-dot" data-step="3"></span>
                <span class="tour-dot" data-step="4"></span>
                <span class="tour-dot" data-step="5"></span>
                <span class="tour-dot" data-step="6"></span>
            </div>
        </div>
        <div class="tour-body">
            <div class="tour-step active" data-step="1">
                <div class="tour-icon">ðŸ”</div>
                <div class="tour-title">Search & Filter</div>
                <div class="tour-desc">Use the search bar to find any calculator instantly. Filter chips let you browse by category â€” try "Activated Sludge" or "Collection".</div>
                <div class="tour-tip">ðŸ’¡ Pro tip: Search works on formulas too! Try "8.34" or "MCRT".</div>
            </div>
            <div class="tour-step" data-step="2">
                <div class="tour-icon">â­</div>
                <div class="tour-title">Save Favorites</div>
                <div class="tour-desc">Tap the star icon on any calculator header to add it to your favorites. Access them quickly with the â­ Favorites filter chip.</div>
                <div class="tour-tip">ðŸ’¡ Your favorites persist between sessions!</div>
            </div>
            <div class="tour-step" data-step="3">
                <div class="tour-icon">ðŸ“Š</div>
                <div class="tour-title">Process Diagrams</div>
                <div class="tour-desc">Look for the purple "DIAGRAM" badge on calculator headers. These have animated SVG diagrams showing the process flow â€” great for visual learners!</div>
                <div class="tour-tip">ðŸ’¡ Use the ðŸ“Š Diagrams filter to see all 20 calculators with diagrams.</div>
            </div>
            <div class="tour-step" data-step="4">
                <div class="tour-icon">ðŸ“–</div>
                <div class="tour-title">How to Use Guides</div>
                <div class="tour-desc">Many calculators have a "ðŸ“– How to Use" button. These expand to show detailed explanations, input guidance, and TCEQ exam tips.</div>
                <div class="tour-tip">ðŸ’¡ 52 calculators have these guides â€” look for the green button!</div>
            </div>
            <div class="tour-step" data-step="5">
                <div class="tour-icon">ðŸ§™</div>
                <div class="tour-title">Process Wizards</div>
                <div class="tour-desc">Having a process problem? The 16 Process Wizards guide you through troubleshooting step-by-step. Access them via the ðŸ§™ Wizards filter chip.</div>
                <div class="tour-tip">ðŸ’¡ Wizards cover: Foaming, Bulking, Ammonia, Odor, Digester Upset, and more!</div>
            </div>
            <div class="tour-step" data-step="6">
                <div class="tour-icon">ðŸ“</div>
                <div class="tour-title">TCEQ Exam Mode</div>
                <div class="tour-desc">Preparing for your operator exam? Tap the red "Exam" button for practice questions generated from your plant data. Track progress and review explanations.</div>
                <div class="tour-tip">ðŸ’¡ 85 exam questions with detailed explanations!</div>
            </div>
        </div>
        <div class="tour-footer">
            <button class="tour-btn tour-btn-skip" onclick="closeTour()">Skip</button>
            <div>
                <button class="tour-btn tour-btn-prev" id="tourPrev" onclick="prevTourStep()" style="display:none;">Back</button>
                <button class="tour-btn tour-btn-next" id="tourNext" onclick="nextTourStep()">Next â†’</button>
            </div>
        </div>
    </div>
</div>

<!-- Help Menu Modal -->
<div class="whatsnew-overlay" id="helpOverlay" onclick="if(event.target===this)closeHelp()">
    <div class="whatsnew-box" style="max-width:380px;">
        <div class="whatsnew-header">
            <h3>â“ Help & Resources</h3>
            <button onclick="closeHelp()" style="background:none;border:none;color:#94a3b8;font-size:1.5rem;cursor:pointer;">&times;</button>
        </div>
        <div class="whatsnew-body" style="padding:16px;">
            <div class="whatsnew-item" onclick="closeHelp();startTour();">
                <div><span class="wn-badge" style="background:#3b82f6;">ðŸŽ¯</span><span class="wn-title">Take the Tour</span></div>
                <div class="wn-desc">6-step walkthrough of all features</div>
            </div>
            <div class="whatsnew-item" onclick="closeHelp();openWhatsNew();">
                <div><span class="wn-badge" style="background:#8b5cf6;">ðŸš€</span><span class="wn-title">What's New</span></div>
                <div class="wn-desc">See latest features and updates</div>
            </div>
            <div class="whatsnew-item" onclick="closeHelp();filterCat('wizards',document.querySelector('[data-filter=wizards]'));">
                <div><span class="wn-badge" style="background:#f59e0b;">ðŸ§™</span><span class="wn-title">Troubleshooting Wizards</span></div>
                <div class="wn-desc">Step-by-step process problem solving</div>
            </div>
            <div class="whatsnew-item" onclick="closeHelp();openExam();">
                <div><span class="wn-badge" style="background:#dc2626;">ðŸ“</span><span class="wn-title">TCEQ Exam Practice</span></div>
                <div class="wn-desc">85 questions with explanations</div>
            </div>
            <div style="border-top:1px solid #334155;margin-top:12px;padding-top:12px;">
                <div style="font-size:0.75rem;color:#64748b;text-align:center;">
                    <div style="margin-bottom:8px;">ðŸ“§ Feedback or questions?</div>
                    <div style="color:#94a3b8;">Built by ProcessCore Systems</div>
                </div>
            </div>
        </div>
    </div>
</div>
<button class="exam-fab" onclick="openExam()" title="TCEQ Exam Mode">ðŸ“<br>Exam</button>
<div class="exam-overlay" id="examOverlay" onclick="if(event.target===this)closeExam()">
    <div class="exam-box">
        <div class="exam-hdr">
            <h3>ðŸ“ TCEQ Exam Prep</h3>
            <div style="display:flex;align-items:center;gap:10px;">
                <span class="exam-score" id="examScore">0 / 0</span>
                <button class="exam-close" onclick="closeExam()">âœ•</button>
            </div>
        </div>
        <div class="exam-tabs">
            <button class="exam-tab active" onclick="showExamTab('practice',this)">ðŸ“Š Practice</button>
            <button class="exam-tab" onclick="showExamTab('flashcards',this)">ðŸŽ´ Flashcards</button>
            <button class="exam-tab" onclick="showExamTab('progress',this)">ðŸ“ˆ Progress</button>
            <button class="exam-tab" onclick="showExamTab('tips',this)">ðŸ’¡ Tips</button>
        </div>
        <div class="exam-body" id="examBody">
            <!-- Practice Tab Content -->
            <div id="examPractice">
                <div style="margin-bottom:12px;">
                    <div style="font-size:0.75rem;color:#94a3b8;margin-bottom:8px;">ðŸŽ¯ Focus on your weak areas:</div>
                    <div id="weakAreaTags"></div>
                </div>
                <div class="exam-category-grid" id="examCatGrid">
                    <button class="exam-cat-btn active" onclick="setExamCat('all',this)">
                        <span class="cat-icon">ðŸ“š</span>All Topics
                        <div class="cat-score" id="cat-score-all">â€”</div>
                    </button>
                    <button class="exam-cat-btn" onclick="setExamCat('collection',this)">
                        <span class="cat-icon">ðŸ”§</span>Collection Systems
                        <div class="cat-score" id="cat-score-collection">â€”</div>
                    </button>
                    <button class="exam-cat-btn" onclick="setExamCat('activated',this)">
                        <span class="cat-icon">ðŸ¦ </span>Activated Sludge
                        <div class="cat-score" id="cat-score-activated">â€”</div>
                    </button>
                    <button class="exam-cat-btn" onclick="setExamCat('design',this)">
                        <span class="cat-icon">ðŸ“</span>Design Criteria
                        <div class="cat-score" id="cat-score-design">â€”</div>
                    </button>
                    <button class="exam-cat-btn" onclick="setExamCat('sludge',this)">
                        <span class="cat-icon">ðŸš›</span>Sludge Disposal
                        <div class="cat-score" id="cat-score-sludge">â€”</div>
                    </button>
                    <button class="exam-cat-btn" onclick="setExamCat('disinfection',this)">
                        <span class="cat-icon">ðŸ’§</span>Disinfection
                        <div class="cat-score" id="cat-score-disinfection">â€”</div>
                    </button>
                    <button class="exam-cat-btn" onclick="setExamCat('math',this)">
                        <span class="cat-icon">ðŸ”¢</span>Process Math
                        <div class="cat-score" id="cat-score-math">â€”</div>
                    </button>
                    <button class="exam-cat-btn" onclick="setExamCat('hydraulics',this)">
                        <span class="cat-icon">âš¡</span>Hydraulics
                        <div class="cat-score" id="cat-score-hydraulics">â€”</div>
                    </button>
                </div>
                <div style="margin:12px 0;padding:10px;background:#1e293b;border-radius:8px;">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                        <label style="font-size:0.8rem;color:#94a3b8;">â±ï¸ Timed Mode:</label>
                        <select id="timedMode" style="padding:6px 10px;border-radius:6px;border:1px solid #475569;background:#0f172a;color:#f8fafc;font-size:0.8rem;">
                            <option value="0">Off (Practice)</option>
                            <option value="2">2 min/question (Hard)</option>
                            <option value="3">3 min/question (Medium)</option>
                            <option value="5">5 min/question (Easy)</option>
                        </select>
                    </div>
                    <div style="font-size:0.7rem;color:#64748b;">Timed mode simulates exam pressure. Actual TCEQ allows ~2.5 min/question.</div>
                </div>
                <button class="exam-next" onclick="startExamSession()" id="startExamBtn">Start Practice ðŸ’ª</button>
            </div>
            <!-- Flashcards Tab Content -->
            <div id="examFlashcards" style="display:none;">
                <div style="margin-bottom:12px;">
                    <select id="flashcardCat" onchange="loadFlashcards()" style="width:100%;padding:10px;border-radius:8px;border:1px solid #475569;background:#0f172a;color:#f8fafc;font-size:0.85rem;">
                        <option value="formulas">ðŸ“ Key Formulas</option>
                        <option value="definitions">ðŸ“– Definitions</option>
                        <option value="limits">âš ï¸ Permit Limits & Standards</option>
                        <option value="collection">ðŸ”§ Collection Systems</option>
                        <option value="design">ðŸ“ Design Criteria</option>
                        <option value="sludge">ðŸš› Sludge & Biosolids</option>
                    </select>
                </div>
                <div class="flashcard" id="flashcard" onclick="flipFlashcard()">
                    <div class="flashcard-cat" id="flashcardCatLabel">FORMULA</div>
                    <div class="flashcard-front" id="flashcardFront">Loading...</div>
                    <div class="flashcard-back" id="flashcardBack"></div>
                    <div class="flashcard-hint">Tap to flip</div>
                </div>
                <div class="flashcard-counter" id="flashcardCounter">1 / 10</div>
                <div class="flashcard-nav">
                    <button class="flashcard-prev" onclick="prevFlashcard()">â† Previous</button>
                    <button class="flashcard-next" onclick="nextFlashcard()">Next â†’</button>
                </div>
            </div>
            <!-- Progress Tab Content -->
            <div id="examProgress" style="display:none;">
                <div class="exam-stats-row">
                    <div class="exam-stat-box">
                        <div class="exam-stat-label">Sessions</div>
                        <div class="exam-stat-val" id="stat-sessions">0</div>
                    </div>
                    <div class="exam-stat-box">
                        <div class="exam-stat-label">Questions</div>
                        <div class="exam-stat-val" id="stat-total-q">0</div>
                    </div>
                    <div class="exam-stat-box">
                        <div class="exam-stat-label">Correct</div>
                        <div class="exam-stat-val good" id="stat-correct">0</div>
                    </div>
                    <div class="exam-stat-box">
                        <div class="exam-stat-label">Score</div>
                        <div class="exam-stat-val" id="stat-pct">â€”</div>
                    </div>
                </div>
                <div style="margin-bottom:15px;">
                    <div style="font-size:0.75rem;color:#94a3b8;margin-bottom:6px;">Overall Progress to 70% (Passing)</div>
                    <div class="exam-progress-bar">
                        <div class="exam-progress-fill" id="progressFill" style="width:0%"></div>
                    </div>
                </div>
                <div style="font-size:0.8rem;color:#f8fafc;font-weight:bold;margin-bottom:8px;">ðŸ“Š Category Performance</div>
                <div id="catPerformance" style="margin-bottom:15px;"></div>
                <div style="font-size:0.8rem;color:#f8fafc;font-weight:bold;margin-bottom:8px;">ðŸ“… Recent Sessions</div>
                <div class="exam-history-list" id="examHistory">
                    <div style="text-align:center;color:#64748b;padding:20px;">No sessions yet</div>
                </div>
                <button class="exam-next" onclick="resetExamProgress()" style="background:#475569;margin-top:12px;">ðŸ—‘ï¸ Reset All Progress</button>
            </div>
            <!-- Study Tips Tab -->
            <div id="examTips" style="display:none;">
                <div style="font-size:0.85rem;color:#f8fafc;font-weight:bold;margin-bottom:10px;">ðŸ“š TCEQ Class A Study Strategy</div>
                <div style="background:#1e293b;border-radius:8px;padding:12px;margin-bottom:12px;">
                    <div style="color:#fbbf24;font-weight:bold;font-size:0.8rem;margin-bottom:6px;">ðŸŽ¯ Your Weak Areas (from 52% attempt)</div>
                    <ul style="font-size:0.75rem;color:#cbd5e1;padding-left:18px;margin:0;line-height:1.8;">
                        <li><b>Collection Systems</b> â€” Focus on Manning's equation, I/I calculations, lift station sizing</li>
                        <li><b>Activated Sludge</b> â€” Master F:M, SRT, SVI, and process control decisions</li>
                        <li><b>Design Criteria</b> â€” Know typical DT, SOR, WOR, and loading rates</li>
                        <li><b>Sludge Disposal</b> â€” VS reduction, land app rates, digester operations</li>
                    </ul>
                </div>
                <div style="background:#1e293b;border-radius:8px;padding:12px;margin-bottom:12px;">
                    <div style="color:#4ade80;font-weight:bold;font-size:0.8rem;margin-bottom:6px;">âœ… Test-Taking Tips</div>
                    <ul style="font-size:0.75rem;color:#cbd5e1;padding-left:18px;margin:0;line-height:1.8;">
                        <li>Read the question twice before calculating</li>
                        <li>Watch units â€” MGD vs GPD vs GPM is a common trap</li>
                        <li>Use 8.34 only when converting mg/L to lbs (pounds formula)</li>
                        <li>Check if answer is reasonable â€” SVI of 5000 is obviously wrong</li>
                        <li>Circle key numbers before starting math</li>
                        <li>For yes/no questions, work the math first</li>
                    </ul>
                </div>
                <div style="background:#1e293b;border-radius:8px;padding:12px;margin-bottom:12px;">
                    <div style="color:#3b82f6;font-weight:bold;font-size:0.8rem;margin-bottom:6px;">ðŸ“‹ Must-Know Formulas</div>
                    <div style="font-size:0.72rem;color:#cbd5e1;font-family:monospace;line-height:1.9;">
                        <div>lbs/day = MGD Ã— mg/L Ã— 8.34</div>
                        <div>SVI = (mL Ã— 1000) Ã· MLSS</div>
                        <div>F:M = (Q Ã— BOD) Ã· (Vol Ã— MLSS)</div>
                        <div>SRT = solids in system Ã· solids out/day</div>
                        <div>% Removal = (In - Out) Ã· In Ã— 100</div>
                        <div>DT = Volume Ã· Flow</div>
                        <div>V = (1.486/n) Ã— R^â…” Ã— S^Â½</div>
                        <div>BHP = (GPM Ã— TDH) Ã· 3960 Ã· eff</div>
                    </div>
                </div>
                <div style="background:#1e293b;border-radius:8px;padding:12px;">
                    <div style="color:#f97316;font-weight:bold;font-size:0.8rem;margin-bottom:6px;">â° Study Schedule (4 months to June)</div>
                    <ul style="font-size:0.75rem;color:#cbd5e1;padding-left:18px;margin:0;line-height:1.8;">
                        <li><b>Month 1:</b> Collection Systems + Activated Sludge (20 questions/day)</li>
                        <li><b>Month 2:</b> Design Criteria + Sludge Disposal (20 questions/day)</li>
                        <li><b>Month 3:</b> All categories mixed practice (30 questions/day)</li>
                        <li><b>Month 4:</b> Timed practice exams + weak area focus</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bottom Navigation -->
<nav class="bottom-nav">
    <div class="nav-scroll">
        <button class="nav-btn active" onclick="goToCard(1)" id="nav1">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 3v18M5 8l7-5 7 5M5 12h14"/>
            </svg>
            <span>Lbs</span>
        </button>
        <button class="nav-btn" onclick="goToCard(2)" id="nav2">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="4" y="4" width="16" height="16" rx="2"/><path d="M8 20V10M12 20V6M16 20V14"/>
            </svg>
            <span>SVI</span>
        </button>
        <button class="nav-btn" onclick="goToCard(3)" id="nav3">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="8" cy="12" r="4"/><circle cx="16" cy="12" r="4"/>
            </svg>
            <span>Mix</span>
        </button>
        <button class="nav-btn" onclick="goToCard(4)" id="nav4">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
            <span>F/M</span>
        </button>
        <button class="nav-btn" onclick="goToCard(5)" id="nav5">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="16" rx="2"/><path d="M8 2v4M16 2v4M3 10h18"/>
            </svg>
            <span>SRT</span>
        </button>
        <button class="nav-btn" onclick="goToCard(6)" id="nav6">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
            </svg>
            <span>DT</span>
        </button>
        <button class="nav-btn" onclick="goToCard(7)" id="nav7">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 3v18h18"/><path d="M7 16l4-8 4 4 5-9"/>
            </svg>
            <span>Eff%</span>
        </button>
        <button class="nav-btn" onclick="goToCard(8)" id="nav8">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2v20M2 12h20"/><circle cx="12" cy="12" r="3"/>
            </svg>
            <span>WAS</span>
        </button>
        <button class="nav-btn" onclick="goToCard(9)" id="nav9">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 12h16M4 12l4-4M4 12l4 4M20 12l-4-4M20 12l-4 4"/>
            </svg>
            <span>RAS</span>
        </button>
        <button class="nav-btn" onclick="goToCard(10)" id="nav10">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 3v18"/>
            </svg>
            <span>OLR</span>
        </button>
        <button class="nav-btn" onclick="goToCard(11)" id="nav11">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><path d="M2 12h20"/>
            </svg>
            <span>SOR</span>
        </button>
        <button class="nav-btn" onclick="goToCard(12)" id="nav12">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 4h16v4H4zM4 12h16"/><path d="M12 12v8"/>
            </svg>
            <span>WOR</span>
        </button>
        <button class="nav-btn" onclick="goToCard(13)" id="nav13">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="4" y="4" width="16" height="16" rx="2"/><path d="M4 14h16M9 4v16"/>
            </svg>
            <span>SLR</span>
        </button>
        <button class="nav-btn" onclick="goToCard(14)" id="nav14">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 3h6v6H9zM12 9v12M8 21h8"/>
            </svg>
            <span>Chem</span>
        </button>
        <button class="nav-btn" onclick="goToCard(15)" id="nav15">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="6" width="18" height="12" rx="1"/><path d="M3 10h18M3 14h18M7 6v12M11 6v12M15 6v12M19 6v12"/>
            </svg>
            <span>Flux</span>
        </button>
        <button class="nav-btn" onclick="goToCard(16)" id="nav16">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2v20"/><path d="M5 5l14 14"/><path d="M19 5L5 19"/><circle cx="12" cy="12" r="3"/>
            </svg>
            <span>TMP</span>
        </button>
        <button class="nav-btn" onclick="goToCard(17)" id="nav17">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 12h16"/><path d="M4 6h16"/><path d="M4 18h16"/><circle cx="12" cy="12" r="2"/>
            </svg>
            <span>Perm</span>
        </button>
        <button class="nav-btn" onclick="goToCard(18)" id="nav18">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="2" y="4" width="20" height="16" rx="2"/><path d="M2 10h20M8 4v16M14 4v16"/>
            </svg>
            <span>MArea</span>
        </button>
        <button class="nav-btn" onclick="goToCard(19)" id="nav19">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="16" r="2"/><path d="M12 14V4"/><path d="M8 8l4-4 4 4"/><path d="M6 20h12"/>
            </svg>
            <span>SAD</span>
        </button>
        <button class="nav-btn" onclick="goToCard(20)" id="nav20">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 11l3 3 8-8"/><circle cx="12" cy="12" r="10"/>
            </svg>
            <span>MBRâœ“</span>
        </button>
        <button class="nav-btn" onclick="goToCard(21)" id="nav21">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M8 2h8l2 6H6l2-6z"/><rect x="6" y="8" width="12" height="12" rx="1"/><path d="M10 12v4M14 12v4"/>
            </svg>
            <span>CIP</span>
        </button>
        <button class="nav-btn" onclick="goToCard(22)" id="nav22">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 3v18"/>
            </svg>
            <span>SALR</span>
        </button>
        <button class="nav-btn" onclick="goToCard(23)" id="nav23">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="8" cy="8" r="3"/><circle cx="16" cy="8" r="3"/><circle cx="8" cy="16" r="3"/><circle cx="16" cy="16" r="3"/>
            </svg>
            <span>BioA</span>
        </button>
        <button class="nav-btn" onclick="goToCard(24)" id="nav24">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="4" y="4" width="16" height="16" rx="2"/><path d="M8 8h8v8H8z"/>
            </svg>
            <span>MVol</span>
        </button>
        <button class="nav-btn" onclick="goToCard(25)" id="nav25">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="6" width="18" height="12" rx="2"/><path d="M3 12h18"/>
            </svg>
            <span>RSiz</span>
        </button>
        <button class="nav-btn" onclick="goToCard(26)" id="nav26">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="8"/><path d="M12 8v4l2 2"/>
            </svg>
            <span>Oâ‚‚</span>
        </button>
        <button class="nav-btn" onclick="goToCard(27)" id="nav27">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 4v16h16"/><rect x="7" y="10" width="4" height="8"/><rect x="13" y="6" width="4" height="12"/>
            </svg>
            <span>CvM</span>
        </button>
        <button class="nav-btn" onclick="goToCard(28)" id="nav28">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><path d="M12 6v6l3 3"/>
            </svg>
            <span>Cycle</span>
        </button>
        <button class="nav-btn" onclick="goToCard(29)" id="nav29">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="4" y="4" width="16" height="16" rx="2"/><path d="M4 12h16"/>
            </svg>
            <span>SVol</span>
        </button>
        <button class="nav-btn" onclick="goToCard(30)" id="nav30">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2v20"/><path d="M8 18l4 4 4-4"/><path d="M4 8h16"/>
            </svg>
            <span>Dec</span>
        </button>
        <button class="nav-btn" onclick="goToCard(31)" id="nav31">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="16" r="3"/><path d="M12 13V3"/><path d="M8 7l4-4 4 4"/>
            </svg>
            <span>SAer</span>
        </button>
        <button class="nav-btn" onclick="goToCard(32)" id="nav32">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18M6 6l12 12"/><circle cx="12" cy="12" r="2"/>
            </svg>
            <span>SF:M</span>
        </button>
        <button class="nav-btn" onclick="goToCard(33)" id="nav33">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="4" y="2" width="16" height="20" rx="2"/><path d="M4 8h16"/><path d="M4 14h16"/>
            </svg>
            <span>Setâœ“</span>
        </button>
        <button class="nav-btn" onclick="goToCard(34)" id="nav34">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 12h8M12 8v8"/></svg>
            <span>CT</span>
        </button>
        <button class="nav-btn" onclick="goToCard(35)" id="nav35">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18"/><circle cx="6" cy="6" r="3"/><circle cx="18" cy="18" r="3"/></svg>
            <span>DeCl</span>
        </button>
        <button class="nav-btn" onclick="goToCard(36)" id="nav36">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4"/></svg>
            <span>UV</span>
        </button>
        <button class="nav-btn" onclick="goToCard(38)" id="nav37">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="8" width="16" height="12" rx="2"/><path d="M8 8V6a4 4 0 018 0v2"/></svg>
            <span>Sld%</span>
        </button>
        <button class="nav-btn" onclick="goToCard(39)" id="nav38">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M7 16l4-8 4 4 5-9"/></svg>
            <span>VSR</span>
        </button>
        <button class="nav-btn" onclick="goToCard(40)" id="nav39">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6"/><circle cx="12" cy="16" r="1"/></svg>
            <span>DigL</span>
        </button>
        <button class="nav-btn" onclick="goToCard(42)" id="nav40">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 3h6v6H9zM12 9v6"/><circle cx="12" cy="18" r="3"/></svg>
            <span>Poly</span>
        </button>
        <button class="nav-btn" onclick="goToCard(43)" id="nav41">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/></svg>
            <span>Phos</span>
        </button>
        <button class="nav-btn" onclick="goToCard(44)" id="nav42">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 20h16M6 16l6-12 6 12"/><path d="M8.5 12h7"/></svg>
            <span>Alk</span>
        </button>
        <button class="nav-btn" onclick="goToCard(45)" id="nav43">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16v16H4z"/><path d="M4 12h16M12 4v16"/></svg>
            <span>NBal</span>
        </button>
        <button class="nav-btn" onclick="goToCard(46)" id="nav44">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M8 6l4-4 4 4M8 18l4 4 4-4"/></svg>
            <span>TDH</span>
        </button>
        <button class="nav-btn" onclick="goToCard(48)" id="nav45">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12h16M16 8l4 4-4 4"/></svg>
            <span>Pipe</span>
        </button>
        <button class="nav-btn" onclick="goToCard(49)" id="nav46">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
            <span>HP</span>
        </button>
        <button class="nav-btn" onclick="goToCard(50)" id="nav47">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="4" width="16" height="16" rx="2"/><path d="M8 8h8M8 12h5M8 16h8"/></svg>
            <span>Geo</span>
        </button>
        <button class="nav-btn" onclick="goToCard(51)" id="nav48">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6h16M4 10h16M4 14h10M4 18h6"/></svg>
            <span>FWC</span>
        </button>
        <button class="nav-btn" onclick="goToCard(52)" id="nav49">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12h16M12 4v16"/><path d="M8 8l8 8M16 8l-8 8"/></svg>
            <span>Unit</span>
        </button>
        <button class="nav-btn" onclick="goToCard(53)" id="nav50">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 20L12 4l8 16"/><path d="M7 14h10"/></svg>
            <span>Man</span>
        </button>
        <button class="nav-btn" onclick="goToCard(54)" id="nav51">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="8" width="16" height="12" rx="2"/><path d="M8 8V4h8v4"/></svg>
            <span>Well</span>
        </button>
        <button class="nav-btn" onclick="goToCard(55)" id="nav52">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M7 7l10 10M17 7L7 17"/></svg>
            <span>I/I</span>
        </button>
        <button class="nav-btn" onclick="goToCard(56)" id="nav53">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12h16M16 8l4 4-4 4"/><path d="M4 6v12"/></svg>
            <span>HzW</span>
        </button>
        <button class="nav-btn" onclick="goToCard(57)" id="nav54">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 8h16M4 8l4 12M20 8l-4 12"/></svg>
            <span>Weir</span>
        </button>
        <button class="nav-btn" onclick="goToCard(58)" id="nav55">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="4" width="12" height="16" rx="1"/><path d="M10 12l4 0M12 10v4"/></svg>
            <span>AÃ—V</span>
        </button>
        <button class="nav-btn" onclick="goToCard(59)" id="nav56">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 16l4-8 4 8"/></svg>
            <span>NRC</span>
        </button>
        <button class="nav-btn" onclick="goToCard(60)" id="nav57">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v12M6 12h12"/></svg>
            <span>TFH</span>
        </button>
        <button class="nav-btn" onclick="goToCard(61)" id="nav58">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 20c4-4 6-16 10-16s6 12 10 16"/></svg>
            <span>Pond</span>
        </button>
        <button class="nav-btn" onclick="goToCard(62)" id="nav59">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v8M8 6l4 4 4-4"/><circle cx="12" cy="16" r="5"/></svg>
            <span>OTR</span>
        </button>
        <button class="nav-btn" onclick="goToCard(63)" id="nav60">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12c0 0 4-8 8-8s8 8 8 8-4 8-8 8-8-8-8-8"/></svg>
            <span>Dil</span>
        </button>
        <button class="nav-btn" onclick="goToCard(64)" id="nav61">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="8" r="4"/><circle cx="17" cy="8" r="4"/><path d="M4 20c0-4 3-7 8-7s8 3 8 7"/></svg>
            <span>Pop</span>
        </button>
        <button class="nav-btn" onclick="goToCard(65)" id="nav62">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16v16H4z"/><path d="M8 4v16M16 4v16"/></svg>
            <span>Flm</span>
        </button>
        <button class="nav-btn" onclick="goToCard(66)" id="nav63">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="8"/><path d="M12 4v16M4 12h16"/></svg>
            <span>Tank</span>
        </button>
        <button class="nav-btn" onclick="goToCard(67)" id="nav64">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 20c2-6 6-16 16-16"/><path d="M4 20h16"/></svg>
            <span>HRT</span>
        </button>
        <button class="nav-btn" onclick="goToCard(68)" id="nav65">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="14" r="6"/><path d="M12 2v6M8 4h8"/></svg>
            <span>Blwr</span>
        </button>
        <button class="nav-btn" onclick="goToCard(69)" id="nav66">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l2 7h7l-6 4 2 7-5-4-5 4 2-7-6-4h7z"/></svg>
            <span>PAN</span>
        </button>
        <button class="nav-btn" onclick="goToCard(70)" id="nav67">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 20h16M4 20V8l8-6 8 6v12"/></svg>
            <span>Land</span>
        </button>
    </div>
</nav>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Install Prompt -->
<div class="install-prompt" id="installPrompt">
    ðŸ“² Install App
    <button onclick="installApp()">Install</button>
    <button onclick="dismissInstall()" style="background:transparent;color:white;font-size:1.2rem;">Ã—</button>
</div>

<script>
    // ==================== STATE ====================
    const STORAGE_KEY = 'wwProCalcData';
    let currentCard = 1;
    
    // All input IDs for saving/restoring
    const inputIds = [
        'p_flow', 'p_conc',
        'svi_set', 'svi_mlss',
        'mb_qa', 'mb_ca', 'mb_qb', 'mb_cb',
        'fm_flow', 'fm_bod', 'fm_vol', 'fm_mlvss',
        'srt_vol', 'srt_mlss', 'srt_wasq', 'srt_wasc', 'srt_effq', 'srt_effc',
        'dt_vol', 'dt_flow',
        'eff_in', 'eff_out',
        'was_vol', 'was_mlss', 'was_srt', 'was_conc',
        'ras_flow', 'ras_mlss', 'ras_conc',
        'olr_flow', 'olr_bod', 'olr_vol',
        'sor_flow', 'sor_area',
        'wor_flow', 'wor_len',
        'slr_flow', 'slr_mlss', 'slr_area',
        'chem_flow', 'chem_dose', 'chem_purity',
        'flux_flow', 'flux_area',
        'tmp_feed', 'tmp_perm',
        'perm_flux', 'perm_tmp',
        'msize_flow', 'msize_pf', 'msize_flux', 'msize_peak',
        'sad_air', 'sad_area', 'sad_perm',
        'mbrc_mlss', 'mbrc_srt', 'mbrc_fm', 'mbrc_do',
        'cip_vol', 'cip_nacl', 'cip_bleach', 'cip_citric', 'cip_cstr',
        'salr_flow', 'salr_conc', 'salr_area',
        'bio_vol', 'bio_fill', 'bio_ssa',
        'mv_flow', 'mv_conc', 'mv_salr', 'mv_ssa',
        'rsz_media', 'rsz_fill', 'rsz_flow',
        'mdo_flow', 'mdo_bod', 'mdo_nh3',
        'cmp_flow', 'cmp_bod',
        'cyc_fill', 'cyc_react', 'cyc_settle', 'cyc_decant', 'cyc_idle', 'cyc_flow',
        'sv_flow', 'sv_cycles', 'sv_reactor', 'sv_basins',
        'dec_vol', 'dec_time', 'dec_weir',
        'saer_flow', 'saer_bod', 'saer_nh3', 'saer_duty',
        'sfm_fill', 'sfm_bod', 'sfm_vol', 'sfm_mlvss', 'sfm_cycles',
        'ssc_depth', 'ssc_sludge', 'ssc_decant', 'ssc_mlss',
        'ct_res_in', 'ct_time', 'ct_req',
        'dcl_flow', 'dcl_cl2', 'dcl_sf',
        'uv_int', 'uv_time', 'uv_uvt',
        'slv_vol', 'slv_pct',
        'vsr_in', 'vsr_out',
        'dig_flow', 'dig_pct', 'dig_vs', 'dig_vol',
        'poly_flow', 'poly_pct', 'poly_rate', 'poly_conc',
        'phos_flow', 'phos_in', 'phos_out', 'phos_ratio',
        'alk_in', 'alk_nh3', 'alk_flow',
        'nb_tkn', 'nb_nh3', 'nb_no3', 'nb_bio',
        'tdh_static', 'tdh_friction', 'tdh_vel',
        'pv_flow', 'pv_dia',
        'hp_flow', 'hp_tdh', 'hp_eff', 'hp_meff',
        'gm_s1', 'gm_s2', 'gm_s3', 'gm_s4', 'gm_s5', 'gm_s6', 'gm_s7',
        'fw_f1', 'fw_c1', 'fw_f2', 'fw_c2', 'fw_f3', 'fw_c3', 'fw_f4', 'fw_c4',
        'uc_gpm', 'uc_mgd', 'uc_cfs', 'uc_m3d', 'uc_gal', 'uc_ft3', 'uc_m3', 'uc_acft', 'uc_psi', 'uc_fth2o', 'uc_kpa',
        'man_dia', 'man_slope', 'man_n',
        'ww_pump', 'ww_inflow', 'ww_cycle',
        'ii_wet', 'ii_dry', 'ii_dia', 'ii_miles',
        'hz_flow', 'hz_c', 'hz_dia', 'hz_len',
        'weir_type', 'weir_h', 'weir_l',
        'av_type', 'av_vel', 'av_dim1', 'av_dim2',
        'nrc_bod', 'nrc_vol', 'nrc_recirc',
        'tfl_flow', 'tfl_dia', 'tfl_bod', 'tfl_depth',
        'pnd_flow', 'pnd_bod', 'pnd_acres', 'pnd_depth',
        'ao_sotr', 'ao_alpha', 'ao_beta', 'ao_temp', 'ao_do', 'ao_alt',
        'dil_eflow', 'dil_econc', 'dil_sflow', 'dil_sconc',
        'pe_flow', 'pe_bod', 'pe_tss', 'pe_tkn', 'pe_pop', 'pe_permit', 'pe_growth', 'pe_peak',
        'pf_width', 'pf_ha', 'pf_hb',
        'tv_shape', 'tv_dim1', 'tv_dim2', 'tv_depth', 'tv_cone',
        'hrt_acres', 'hrt_depth', 'hrt_sludge', 'hrt_flow', 'hrt_cells',
        'bl_o2', 'bl_depth', 'bl_ote', 'bl_basins', 'bl_sf', 'bl_cost',
        'pan_nh3', 'pan_no3', 'pan_orgn', 'pan_method', 'pan_kmin', 'pan_solids',
        'la_pan', 'la_crop', 'la_solids', 'la_prod', 'la_acres'
    ];

    // ==================== ACCORDION ====================
    // ==================== WHAT'S NEW ====================
    var WN_VERSION = '9.2';
    function openWhatsNew() {
        document.getElementById('wnOverlay').classList.add('active');
    }
    function closeWhatsNew() {
        document.getElementById('wnOverlay').classList.remove('active');
        document.getElementById('wnBadge').style.display = 'none';
        try { localStorage.setItem('wn_seen', WN_VERSION); } catch(e) {}
    }
    function checkWhatsNew() {
        try {
            var seen = localStorage.getItem('wn_seen');
            if (seen !== WN_VERSION) {
                document.getElementById('wnBadge').style.display = 'inline';
                // Auto-open on first visit to this version
                setTimeout(function() { openWhatsNew(); }, 600);
            }
        } catch(e) {
            // localStorage unavailable â€” show badge anyway
            document.getElementById('wnBadge').style.display = 'inline';
        }
    }

    // ==================== INPUT VALIDATION ====================
    var validationRules = {
        // id: [min_error, min_warn, max_warn, max_error, unit_label]
        'p_flow': [0, null, 50, 200, 'MGD'], 'p_conc': [0, null, 1000, 5000, 'mg/L'],
        'fm_flow': [0, null, 50, 200, 'MGD'], 'fm_bod': [0, null, 500, 2000, 'mg/L'],
        'fm_vol': [0, null, 10, 50, 'MG'], 'fm_mlss': [0, 500, 8000, 15000, 'mg/L'],
        'srt_vol': [0, null, 10, 50, 'MG'], 'srt_mlss': [0, 500, 8000, 15000, 'mg/L'],
        'svi_vol': [0, null, null, null, 'mL'], 'svi_mlss': [0, 500, 8000, 15000, 'mg/L'],
        'dt_vol': [0, null, null, null, 'gal'], 'dt_flow': [0, null, null, null, 'GPD'],
        'ct_res_in': [0, null, 10, 20, 'mg/L'],
        'mann_dia': [0, 4, 120, 200, 'inches'], 'mann_slope': [0, null, 0.02, 0.05, 'ft/ft'],
        'mann_n': [0.005, 0.008, 0.025, 0.035, 'n'],
        'bl_ote': [0, 5, 40, 60, '%'], 'bl_sf': [0.5, 1.0, 2.5, 4.0, ''],
        'pf_ha': [0, null, 3, 5, 'ft'],
        'tv_dim1': [0, null, 200, 500, 'ft'], 'tv_depth': [0, null, 30, 50, 'ft'],
        'pe_flow': [0, null, 50, 200, 'MGD'], 'pe_bod': [0, null, 500, 2000, 'mg/L'],
        'pe_tss': [0, null, 500, 2000, 'mg/L'], 'pe_growth': [0, null, 5, 15, '%'],
        'pan_kmin': [0, null, 50, 80, '%'], 'pan_solids': [0, null, 40, 100, '%'],
        'la_solids': [0, null, 40, 100, '%']
    };
    
    function validateInput(el) {
        var id = el.id;
        var rules = validationRules[id];
        if (!rules) return;
        
        // Remove existing validation
        el.classList.remove('input-warn', 'input-error');
        var existing = el.parentElement.querySelector('.input-val-msg');
        if (existing) existing.remove();
        
        var val = parseFloat(el.value);
        if (isNaN(val) || el.value === '') return;
        
        var msg = '', level = '';
        var minErr = rules[0], minWarn = rules[1], maxWarn = rules[2], maxErr = rules[3];
        
        if (minErr !== null && val < minErr) { msg = 'âš  Must be â‰¥ ' + minErr; level = 'error'; }
        else if (minWarn !== null && val < minWarn) { msg = 'âš¡ Low â€” typical min is ' + minWarn; level = 'warn'; }
        else if (maxErr !== null && val > maxErr) { msg = 'âš  Unusually high (>' + maxErr + ')'; level = 'error'; }
        else if (maxWarn !== null && val > maxWarn) { msg = 'âš¡ High â€” typical max ~' + maxWarn; level = 'warn'; }
        
        if (msg) {
            el.classList.add('input-' + level);
            var div = document.createElement('div');
            div.className = 'input-val-msg ' + level;
            div.textContent = msg;
            el.parentElement.appendChild(div);
        }
    }
    
    // Delegated validation listener
    document.addEventListener('input', function(e) {
        if (e.target.tagName === 'INPUT' && e.target.type === 'number') {
            validateInput(e.target);
        }
    });

    // ==================== EXPAND/COLLAPSE ALL ====================
    var allExpanded = false;
    function toggleAll() {
        allExpanded = !allExpanded;
        document.querySelectorAll('.card').forEach(function(card) {
            if (card.classList.contains('search-hidden')) return;
            if (allExpanded) card.classList.add('open');
            else card.classList.remove('open');
        });
        document.getElementById('btnToggleAll').textContent = allExpanded ? 'Collapse All' : 'Expand All';
    }

    // ==================== FAVORITES ====================
    var favorites = [];
    function loadFavorites() {
        try { favorites = JSON.parse(localStorage.getItem('ww_favs') || '[]'); } catch(e) { favorites = []; }
    }
    function saveFavorites() {
        try { localStorage.setItem('ww_favs', JSON.stringify(favorites)); } catch(e) {}
    }
    function initFavStars() {
        document.querySelectorAll('.card-header').forEach(function(hdr) {
            var card = hdr.parentElement;
            var cardId = card.id; // e.g. "card1"
            var num = cardId.replace('card', '');
            var star = document.createElement('button');
            star.className = 'fav-btn';
            star.setAttribute('data-card', num);
            star.textContent = 'â­';
            star.title = 'Add to favorites';
            star.onclick = function(e) {
                e.stopPropagation();
                toggleFav(num);
            };
            hdr.querySelector('h2').appendChild(star);
        });
        updateFavUI();
    }
    function toggleFav(num) {
        var idx = favorites.indexOf(num);
        if (idx > -1) favorites.splice(idx, 1);
        else favorites.push(num);
        saveFavorites();
        updateFavUI();
    }
    function updateFavUI() {
        // Update star states
        document.querySelectorAll('.fav-btn').forEach(function(btn) {
            var num = btn.getAttribute('data-card');
            if (favorites.indexOf(num) > -1) btn.classList.add('favorited');
            else btn.classList.remove('favorited');
        });
        // Build favorites section
        var section = document.getElementById('favSection');
        var links = document.getElementById('favLinks');
        links.innerHTML = '';
        if (favorites.length === 0) {
            section.classList.remove('has-favs');
            return;
        }
        section.classList.add('has-favs');
        favorites.forEach(function(num) {
            var card = document.getElementById('card' + num);
            if (!card) return;
            var title = card.querySelector('h2');
            var name = title ? title.textContent.replace('â­', '').trim() : 'Calc ' + num;
            var link = document.createElement('span');
            link.className = 'fav-link';
            link.textContent = name;
            link.onclick = function() { goToCard(parseInt(num)); };
            links.appendChild(link);
        });
    }

    // ==================== CATEGORY FILTER ====================
    function filterCat(cat, btn) {
        // Update active chip
        document.querySelectorAll('.filter-chip').forEach(function(c) { c.classList.remove('active'); });
        btn.classList.add('active');
        
        // Clear search when filtering
        document.getElementById('searchInput').value = '';
        document.getElementById('searchClear').style.display = 'none';
        document.getElementById('searchCount').textContent = '';
        
        // Show/hide special dashboards
        var chemDash = document.getElementById('chemDashboard');
        var wizardDash = document.getElementById('wizardDashboard');
        if (chemDash) chemDash.style.display = (cat === 'chemicals') ? 'block' : 'none';
        if (wizardDash) wizardDash.style.display = (cat === 'wizards') ? 'block' : 'none';
        
        // If wizards selected, hide all cards and show only wizard dashboard
        if (cat === 'wizards') {
            document.querySelectorAll('.card').forEach(function(c) { c.classList.add('search-hidden'); });
            document.querySelectorAll('.section-header').forEach(function(s) { s.classList.add('search-hidden'); });
            return;
        }
        
        if (cat === 'all') {
            document.querySelectorAll('.card').forEach(function(c) { c.classList.remove('search-hidden'); });
            document.querySelectorAll('.section-header').forEach(function(s) { s.classList.remove('search-hidden'); });
            return;
        }
        
        // Build card-to-category mapping by walking DOM
        var cardCats = {};
        var currentCat = 'cas'; // cards before first section header are CAS Core
        var container = document.querySelector('.card-grid-wrap');
        if (!container) container = document.querySelector('.container');
        var children = container.children;
        for (var i = 0; i < children.length; i++) {
            var el = children[i];
            if (el.classList.contains('section-header') && el.dataset.cat) {
                currentCat = el.dataset.cat;
            }
            if (el.classList.contains('card')) {
                cardCats[el.id] = currentCat;
            }
        }
        
        // Show/hide cards
        document.querySelectorAll('.card').forEach(function(card) {
            if (cardCats[card.id] === cat) {
                card.classList.remove('search-hidden');
            } else {
                card.classList.add('search-hidden');
            }
        });
        
        // Show/hide section headers
        document.querySelectorAll('.section-header').forEach(function(hdr) {
            if (hdr.dataset.cat === cat) {
                hdr.classList.remove('search-hidden');
            } else {
                hdr.classList.add('search-hidden');
            }
        });
    }

    // ==================== FILTER BY DIAGRAMS ====================
    function filterDiagrams(btn) {
        // Update active chip
        document.querySelectorAll('.filter-chip').forEach(function(c) { c.classList.remove('active'); });
        btn.classList.add('active');
        
        // Clear search
        document.getElementById('searchInput').value = '';
        document.getElementById('searchClear').style.display = 'none';
        document.getElementById('searchCount').textContent = '';
        
        // Hide special dashboards
        var chemDash = document.getElementById('chemDashboard');
        var wizardDash = document.getElementById('wizardDashboard');
        if (chemDash) chemDash.style.display = 'none';
        if (wizardDash) wizardDash.style.display = 'none';
        
        // Hide section headers
        document.querySelectorAll('.section-header').forEach(function(s) { s.classList.add('search-hidden'); });
        
        // Show only cards with diagram-badge
        var shown = 0;
        document.querySelectorAll('.card').forEach(function(card) {
            if (card.querySelector('.diagram-badge')) {
                card.classList.remove('search-hidden');
                shown++;
            } else {
                card.classList.add('search-hidden');
            }
        });
        
        document.getElementById('searchCount').textContent = shown + ' with diagrams';
    }

    // ==================== FILTER BY FAVORITES ====================
    function filterFavorites(btn) {
        // Update active chip
        document.querySelectorAll('.filter-chip').forEach(function(c) { c.classList.remove('active'); });
        btn.classList.add('active');
        
        // Clear search
        document.getElementById('searchInput').value = '';
        document.getElementById('searchClear').style.display = 'none';
        document.getElementById('searchCount').textContent = '';
        
        // Hide special dashboards
        var chemDash = document.getElementById('chemDashboard');
        var wizardDash = document.getElementById('wizardDashboard');
        if (chemDash) chemDash.style.display = 'none';
        if (wizardDash) wizardDash.style.display = 'none';
        
        // Hide section headers
        document.querySelectorAll('.section-header').forEach(function(s) { s.classList.add('search-hidden'); });
        
        // Get favorites from localStorage
        var favs = [];
        try {
            favs = JSON.parse(localStorage.getItem('ww_favorites') || '[]');
        } catch(e) {}
        
        // Show only favorited cards
        var shown = 0;
        document.querySelectorAll('.card').forEach(function(card) {
            var cardId = parseInt(card.id.replace('card', ''));
            if (favs.includes(cardId)) {
                card.classList.remove('search-hidden');
                shown++;
            } else {
                card.classList.add('search-hidden');
            }
        });
        
        if (shown === 0) {
            document.getElementById('searchCount').textContent = 'No favorites yet â€” tap â­ on any card';
        } else {
            document.getElementById('searchCount').textContent = shown + ' favorite' + (shown === 1 ? '' : 's');
        }
    }

    // ==================== SEARCH ====================
    function searchCalcs() {
        var term = document.getElementById('searchInput').value.toLowerCase().trim();
        var clearBtn = document.getElementById('searchClear');
        var countEl = document.getElementById('searchCount');
        
        clearBtn.style.display = term ? 'block' : 'none';
        
        // Reset filter chips when typing
        if (term) {
            document.querySelectorAll('.filter-chip').forEach(function(c) { c.classList.remove('active'); });
            document.querySelector('.filter-chip[data-filter="all"]').classList.add('active');
        }
        
        if (!term) {
            // Show everything
            document.querySelectorAll('.card').forEach(function(c) { c.classList.remove('search-hidden'); });
            document.querySelectorAll('.section-header').forEach(function(s) { s.classList.remove('search-hidden'); });
            countEl.textContent = '';
            return;
        }
        
        var terms = term.split(/\s+/);
        var matchCount = 0;
        
        document.querySelectorAll('.card').forEach(function(card) {
            // Build searchable text from card title, data-calc, and input-help
            var title = (card.querySelector('h2') || {}).textContent || '';
            var dataCat = card.getAttribute('data-calc') || '';
            var helpEl = card.querySelector('.input-help');
            var helpText = helpEl ? helpEl.textContent : '';
            var formulaEl = card.querySelector('.formula-note');
            var formulaText = formulaEl ? formulaEl.textContent : '';
            var searchText = (title + ' ' + dataCat + ' ' + helpText + ' ' + formulaText).toLowerCase();
            
            // All terms must match
            var match = terms.every(function(t) { return searchText.indexOf(t) !== -1; });
            
            if (match) {
                card.classList.remove('search-hidden');
                matchCount++;
            } else {
                card.classList.add('search-hidden');
            }
        });
        
        // Show/hide section headers based on whether any following cards are visible
        document.querySelectorAll('.section-header').forEach(function(hdr) {
            var next = hdr.nextElementSibling;
            var hasVisible = false;
            while (next && !next.classList.contains('section-header') && !next.classList.contains('version')) {
                if (next.classList.contains('card') && !next.classList.contains('search-hidden')) {
                    hasVisible = true;
                    break;
                }
                next = next.nextElementSibling;
            }
            if (hasVisible) hdr.classList.remove('search-hidden');
            else hdr.classList.add('search-hidden');
        });
        
        countEl.textContent = matchCount + ' of 67';
    }
    
    function clearSearch() {
        document.getElementById('searchInput').value = '';
        searchCalcs();
        document.getElementById('searchInput').focus();
    }

    // ==================== CARD TOGGLE ====================
    function toggleCard(num) {
        const card = document.getElementById('card' + num);
        const wasOpen = card.classList.contains('open');
        
        // Close all cards
        document.querySelectorAll('.card').forEach(c => c.classList.remove('open'));
        
        // Open clicked card if it wasn't open
        if (!wasOpen) {
            card.classList.add('open');
            currentCard = num;
            updateNav();
            // Scroll to card
            setTimeout(() => {
                card.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }
        
        vibrate();
    }
    
    function goToCard(num) {
        const card = document.getElementById('card' + num);
        document.querySelectorAll('.card').forEach(c => c.classList.remove('open'));
        card.classList.add('open');
        currentCard = num;
        updateNav();
        card.scrollIntoView({ behavior: 'smooth', block: 'start' });
        vibrate();
    }
    
    function updateNav() {
        document.querySelectorAll('.nav-btn').forEach((btn, i) => {
            btn.classList.toggle('active', i + 1 === currentCard);
        });
    }

    // ==================== HAPTIC FEEDBACK ====================
    function vibrate() {
        if (navigator.vibrate) navigator.vibrate(10);
    }

    // ==================== TOAST ====================
    function showToast(message, type = '') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'toast show ' + type;
        setTimeout(() => toast.classList.remove('show'), 2000);
    }

    // ==================== COPY ====================
    function copyVal(id) {
        const text = document.getElementById(id).innerText;
        navigator.clipboard.writeText(text).then(() => {
            showToast('âœ“ Copied: ' + text, 'success');
            vibrate();
        });
    }

    // ==================== CLEAR ALL ====================
    function clearAll() {
        if (confirm('Clear all values?')) {
            inputIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.value = '';
                    el.classList.remove('error');
                }
            });
            localStorage.removeItem(STORAGE_KEY);
            // Reset all results
            document.getElementById('p_res').innerText = '0.00 lbs/day';
            document.getElementById('svi_res').innerText = '0.00 mL/g';
            document.getElementById('mb_res').innerText = '0.00 mg/L';
            document.getElementById('fm_res').innerText = '0.000';
            document.getElementById('srt_res').innerText = '0.0 days';
            document.getElementById('dt_res').innerText = '0.00 hours';
            document.getElementById('eff_res').innerText = '0.0 %';
            document.getElementById('was_res').innerText = '0 GPD';
            document.getElementById('ras_res').innerText = '0.00 MGD';
            document.getElementById('olr_res').innerText = '0.0 lbs/day/1000ftÂ³';
            document.getElementById('sor_res').innerText = '0 GPD/ftÂ²';
            document.getElementById('wor_res').innerText = '0 GPD/ft';
            document.getElementById('slr_res').innerText = '0.0 lbs/day/ftÂ²';
            document.getElementById('chem_res').innerText = '0.00 lbs/day';
            document.getElementById('flux_res').innerText = '0.0 GFD';
            document.getElementById('tmp_res').innerText = '0.0 psi';
            document.getElementById('perm_res').innerText = '0.0 GFD/psi';
            document.getElementById('msize_res').innerText = '0 ftÂ²';
            document.getElementById('sad_res').innerText = 'â€”';
            document.getElementById('mbrc_res').innerText = 'â€”';
            document.getElementById('cip_res').innerText = 'â€”';
            document.getElementById('salr_res').innerText = '0.0 g/mÂ²/d';
            document.getElementById('bio_res').innerText = '0 mÂ²';
            document.getElementById('mv_res').innerText = '0 mÂ³';
            document.getElementById('rsz_res').innerText = '0 mÂ³';
            document.getElementById('mdo_res').innerText = '0 lbs Oâ‚‚/day';
            document.getElementById('cmp_res').innerText = 'â€”';
            document.getElementById('cyc_res').innerText = 'â€”';
            document.getElementById('sv_res').innerText = 'â€”';
            document.getElementById('dec_res').innerText = '0 GPM';
            document.getElementById('saer_res').innerText = 'â€”';
            document.getElementById('sfm_res').innerText = 'â€”';
            document.getElementById('ssc_res').innerText = 'â€”';
            document.getElementById('ct_res').innerText = '0.0 mgÂ·min/L';
            document.getElementById('dcl_res').innerText = 'â€”';
            document.getElementById('uv_res').innerText = '0.0 mJ/cmÂ²';
            document.getElementById('slv_res').innerText = 'â€”';
            document.getElementById('vsr_res').innerText = '0.0 %';
            document.getElementById('dig_res').innerText = '0.00 lbs VS/ftÂ³/d';
            document.getElementById('poly_res').innerText = 'â€”';
            document.getElementById('phos_res').innerText = 'â€”';
            document.getElementById('alk_res').innerText = 'â€”';
            document.getElementById('nb_res').innerText = 'â€”';
            document.getElementById('tdh_res').innerText = '0.0 ft';
            document.getElementById('pv_res').innerText = '0.0 fps';
            document.getElementById('hp_res').innerText = 'â€”';
            document.getElementById('gm_res').innerText = 'â€”';
            document.getElementById('fw_res').innerText = 'â€”';
            document.getElementById('man_res').innerText = 'â€”';
            document.getElementById('ww_res').innerText = 'â€”';
            document.getElementById('ii_res').innerText = 'â€”';
            document.getElementById('hz_res').innerText = 'â€”';
            document.getElementById('weir_res').innerText = 'â€”';
            document.getElementById('av_res').innerText = 'â€”';
            document.getElementById('nrc_res').innerText = 'â€”';
            document.getElementById('tfl_res').innerText = 'â€”';
            document.getElementById('pnd_res').innerText = 'â€”';
            document.getElementById('ao_res').innerText = 'â€”';
            document.getElementById('dil_res').innerText = 'â€”';
            document.getElementById('pe_res').innerText = 'â€”';
            document.getElementById('pe_report').style.display = 'none';
            document.getElementById('pe_report_btn').style.display = 'none';
            document.getElementById('pf_res').innerText = 'â€”';
            document.getElementById('tv_res').innerText = 'â€”';
            document.getElementById('hrt_res').innerText = 'â€”';
            document.getElementById('bl_res').innerText = 'â€”';
            document.getElementById('pan_res').innerText = 'â€”';
            document.getElementById('la_res').innerText = 'â€”';
            // Reset statuses
            document.querySelectorAll('.status').forEach(s => {
                s.innerText = 'Enter data...';
                s.style.color = '#64748b';
            });
            // Reset hints
            document.querySelectorAll('.field-hint').forEach(h => h.classList.remove('error'));
            const sviHint = document.getElementById('svi_set_hint');
            if (sviHint) sviHint.textContent = 'Max 1000 mL/L';
            
            showToast('âœ“ All cleared', 'success');
            vibrate();
        }
    }

    // ==================== SAVE/RESTORE ====================
    function saveData() {
        const data = {};
        inputIds.forEach(id => {
            const el = document.getElementById(id);
            if (el && el.value) data[id] = el.value;
        });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }
    
    function restoreData() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            const data = JSON.parse(saved);
            inputIds.forEach(id => {
                const el = document.getElementById(id);
                if (el && data[id]) el.value = data[id];
            });
            // Trigger all calculations
            calcPounds(); calcSVI(); calcMB(); calcFM(); calcSRT(); calcDT(); calcEff();
            calcWAS(); calcRAS(); calcOLR(); calcSOR(); calcWOR(); calcSLR(); calcChem();
            calcFlux();
            calcTMP();
            calcPerm();
            calcMSize();
            calcSAD();
            calcMBRC();
            calcCIP();
            calcSALR(); calcBioArea(); calcMediaVol(); calcRSZ(); calcMDO(); calcCMP();
            calcCycle(); calcSBRVol(); calcDecant(); calcSBRAer(); calcSBRFM(); calcSSC();
            calcCT(); calcDCL(); calcUV();
            calcSLV(); calcVSR(); calcDIG(); calcPoly();
            calcPhos(); calcALK(); calcNBal();
            calcTDH(); calcPV(); calcHP();
            calcGM(); calcFWC();
            calcManning(); calcWetWell(); calcII(); calcHazen();
            calcWeir(); calcAV();
            calcNRC(); calcTFL();
            calcPond(); calcAOTR(); calcDilute(); calcPE();
            calcParshall(); calcTankVol(); calcPondHRT(); calcBlower(); calcPAN(); calcLandApp();
        }
    }
    
    // Auto-save on input with debounce
    let saveTimeout;
    document.addEventListener('input', () => {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(saveData, 500);
    });

    // ==================== VALIDATION ====================
    function validateInput(inputId, value, min, max, defaultHint) {
        const input = document.getElementById(inputId);
        const hintEl = document.getElementById(inputId + '_hint');
        
        if (value > max) {
            input.classList.add('error');
            if (hintEl) {
                hintEl.classList.add('error');
                hintEl.textContent = 'âš ï¸ Max is ' + max;
            }
            vibrate();
            return false;
        } else if (value < min) {
            input.classList.add('error');
            if (hintEl) {
                hintEl.classList.add('error');
                hintEl.textContent = 'âš ï¸ Min is ' + min;
            }
            vibrate();
            return false;
        } else {
            input.classList.remove('error');
            if (hintEl) {
                hintEl.classList.remove('error');
                hintEl.textContent = defaultHint;
            }
            return true;
        }
    }

    // ==================== CALCULATIONS ====================
    
    // 1. Pounds Formula
    function calcPounds() {
        const f = parseFloat(document.getElementById('p_flow').value) || 0;
        const c = parseFloat(document.getElementById('p_conc').value) || 0;
        const res = f * c * 8.34;
        document.getElementById('p_res').innerText = res.toFixed(2) + " lbs/day";
        const stat = document.getElementById('p_status');
        if (f > 0 && c > 0) {
            stat.innerHTML = "ðŸ“Š <b>" + (c * 8.34).toFixed(1) + " lbs per MG</b> at this concentration";
            stat.style.color = "#94a3b8";
        } else {
            stat.innerText = "Enter data...";
            stat.style.color = "#64748b";
        }
    }

    // 2. SVI with validation
    function calcSVI() {
        const s = parseFloat(document.getElementById('svi_set').value) || 0;
        const m = parseFloat(document.getElementById('svi_mlss').value) || 0;
        
        // Validate settled volume (max 1000 mL/L for a settleometer)
        const valid = validateInput('svi_set', s, 0, 1000, 'Max 1000 mL/L');
        
        if (m > 0 && valid) {
            const res = (s * 1000) / m;
            document.getElementById('svi_res').innerText = res.toFixed(2) + " mL/g";
            const stat = document.getElementById('svi_status');
            
            if (res > 250) { 
                stat.innerHTML = "ðŸš¨ <b>Severe Bulking</b> â€“ Check for Nocardia/M. parvicella. Consider RAS chlorination, reduce SRT."; 
                stat.style.color = "var(--danger)"; 
            } else if (res > 150) { 
                stat.innerHTML = "âš ï¸ <b>Bulking Sludge</b> â€“ Review F/M, DO levels, nutrient balance. Increase wasting."; 
                stat.style.color = "var(--accent)"; 
            } else if (res < 50) { 
                stat.innerHTML = "âš¡ <b>Pin Floc/Dispersed</b> â€“ Old sludge or toxic shock. Reduce SRT."; 
                stat.style.color = "var(--accent)"; 
            } else if (res < 80) { 
                stat.innerHTML = "âš¡ <b>Fast Settling</b> â€“ Monitor for pin floc. May indicate over-wasting."; 
                stat.style.color = "var(--primary)"; 
            } else { 
                stat.innerHTML = "âœ“ <b>Optimal (80-150)</b> â€“ Good floc formation. Maintain operations."; 
                stat.style.color = "#4ade80"; 
            }
        } else if (!valid) {
            document.getElementById('svi_status').innerHTML = "âš ï¸ <b>Check Input</b> â€“ Settled volume cannot exceed 1000 mL/L";
            document.getElementById('svi_status').style.color = "var(--danger)";
        }
    }

    // 3. Mass Balance
    function calcMB() {
        const qa = parseFloat(document.getElementById('mb_qa').value) || 0;
        const ca = parseFloat(document.getElementById('mb_ca').value) || 0;
        const qb = parseFloat(document.getElementById('mb_qb').value) || 0;
        const cb = parseFloat(document.getElementById('mb_cb').value) || 0;
        
        if ((qa + qb) > 0) {
            const res = ((qa * ca) + (qb * cb)) / (qa + qb);
            document.getElementById('mb_res').innerText = res.toFixed(2) + " mg/L";
            const stat = document.getElementById('mb_status');
            const ratioA = (qa / (qa + qb) * 100).toFixed(0);
            const ratioB = (qb / (qa + qb) * 100).toFixed(0);
            stat.innerHTML = "ðŸ“Š <b>Flow Mix:</b> A = " + ratioA + "% | B = " + ratioB + "%";
            stat.style.color = "#94a3b8";
        }
    }

    // 4. F/M Ratio
    function calcFM() {
        const flow = parseFloat(document.getElementById('fm_flow').value) || 0;
        const bod = parseFloat(document.getElementById('fm_bod').value) || 0;
        const vol = parseFloat(document.getElementById('fm_vol').value) || 0;
        const mlvss = parseFloat(document.getElementById('fm_mlvss').value) || 0;
        
        if (vol > 0 && mlvss > 0) {
            const res = (flow * bod) / (vol * mlvss);
            document.getElementById('fm_res').innerText = res.toFixed(3);
            const stat = document.getElementById('fm_status');
            
            if (res < 0.02) { 
                stat.innerHTML = "ðŸš¨ <b>Starvation</b> â€“ Bacteria consuming themselves. Reduce MLSS."; 
                stat.style.color = "var(--danger)"; 
            } else if (res < 0.05) { 
                stat.innerHTML = "âš ï¸ <b>Very Low</b> â€“ Watch for old sludge, denitrification in clarifier."; 
                stat.style.color = "var(--accent)"; 
            } else if (res <= 0.15) { 
                stat.innerHTML = "âœ“ <b>Extended Aeration (0.05-0.15)</b> â€“ Good nitrification potential."; 
                stat.style.color = "#4ade80"; 
            } else if (res <= 0.5) { 
                stat.innerHTML = "âœ“ <b>Conventional (0.15-0.5)</b> â€“ Standard activated sludge."; 
                stat.style.color = "#4ade80"; 
            } else if (res <= 1.0) { 
                stat.innerHTML = "âš¡ <b>High Rate (0.5-1.0)</b> â€“ Short SRT, high sludge yield."; 
                stat.style.color = "var(--accent)"; 
            } else { 
                stat.innerHTML = "ðŸš¨ <b>Overloaded (>1.0)</b> â€“ BOD breakthrough risk. Increase MLSS."; 
                stat.style.color = "var(--danger)"; 
            }
        }
    }

    // 5. SRT
    function calcSRT() {
        const vol = parseFloat(document.getElementById('srt_vol').value) || 0;
        const mlss = parseFloat(document.getElementById('srt_mlss').value) || 0;
        const wasQ = parseFloat(document.getElementById('srt_wasq').value) || 0;
        const wasC = parseFloat(document.getElementById('srt_wasc').value) || 0;
        const effQ = parseFloat(document.getElementById('srt_effq').value) || 0;
        const effC = parseFloat(document.getElementById('srt_effc').value) || 0;
        
        const sludgeIn = vol * mlss * 8.34;
        const sludgeOut = (wasQ * wasC * 8.34) + (effQ * effC * 8.34);
        
        if (sludgeOut > 0) {
            const res = sludgeIn / sludgeOut;
            document.getElementById('srt_res').innerText = res.toFixed(1) + " days";
            const stat = document.getElementById('srt_status');
            
            if (res < 2) { 
                stat.innerHTML = "ðŸš¨ <b>Washout Risk</b> â€“ Reduce WAS immediately!"; 
                stat.style.color = "var(--danger)"; 
            } else if (res < 4) { 
                stat.innerHTML = "âš ï¸ <b>Low (2-4 days)</b> â€“ Young sludge, limited nitrification."; 
                stat.style.color = "var(--accent)"; 
            } else if (res < 8) { 
                stat.innerHTML = "âœ“ <b>Conventional (4-8 days)</b> â€“ Good BOD removal."; 
                stat.style.color = "#4ade80"; 
            } else if (res <= 15) { 
                stat.innerHTML = "âœ“ <b>Extended (8-15 days)</b> â€“ Full nitrification, stable."; 
                stat.style.color = "#4ade80"; 
            } else if (res <= 25) { 
                stat.innerHTML = "âš¡ <b>Long (15-25 days)</b> â€“ Watch for old sludge issues."; 
                stat.style.color = "var(--primary)"; 
            } else { 
                stat.innerHTML = "âš ï¸ <b>Excessive (>25 days)</b> â€“ Increase wasting."; 
                stat.style.color = "var(--accent)"; 
            }
        }
    }

    // 6. Detention Time
    function calcDT() {
        const vol = parseFloat(document.getElementById('dt_vol').value) || 0;
        const flow = parseFloat(document.getElementById('dt_flow').value) || 0;
        
        if (flow > 0) {
            const res = (vol / flow) * 24;
            document.getElementById('dt_res').innerText = res.toFixed(2) + " hours";
            const stat = document.getElementById('dt_status');
            
            if (res < 2) { 
                stat.innerHTML = "âš¡ <b>Very Short (<2 hrs)</b> â€“ Contact tank or high-rate process."; 
                stat.style.color = "var(--accent)"; 
            } else if (res < 4) { 
                stat.innerHTML = "âœ“ <b>Clarifier Range (2-4 hrs)</b> â€“ Typical for secondary clarifiers."; 
                stat.style.color = "#4ade80"; 
            } else if (res < 8) { 
                stat.innerHTML = "âœ“ <b>Conventional (4-8 hrs)</b> â€“ Standard aeration basin."; 
                stat.style.color = "#4ade80"; 
            } else if (res <= 24) { 
                stat.innerHTML = "âœ“ <b>Extended (8-24 hrs)</b> â€“ Good for nitrification."; 
                stat.style.color = "#4ade80"; 
            } else if (res <= 48) { 
                stat.innerHTML = "âš¡ <b>Long (24-48 hrs)</b> â€“ EQ basin or oxidation ditch."; 
                stat.style.color = "var(--primary)"; 
            } else { 
                stat.innerHTML = "âš ï¸ <b>Very Long (>48 hrs)</b> â€“ Lagoon range."; 
                stat.style.color = "var(--accent)"; 
            }
        }
    }

    // 7. Removal Efficiency
    function calcEff() {
        const inf = parseFloat(document.getElementById('eff_in').value) || 0;
        const eff = parseFloat(document.getElementById('eff_out').value) || 0;
        
        if (inf > 0) {
            const res = ((inf - eff) / inf) * 100;
            document.getElementById('eff_res').innerText = res.toFixed(1) + " %";
            const stat = document.getElementById('eff_status');
            
            if (res >= 95) { 
                stat.innerHTML = "ðŸŒŸ <b>Excellent (â‰¥95%)</b> â€“ Outstanding performance."; 
                stat.style.color = "#4ade80"; 
            } else if (res >= 90) { 
                stat.innerHTML = "âœ“ <b>Very Good (90-95%)</b> â€“ Exceeds most permits."; 
                stat.style.color = "#4ade80"; 
            } else if (res >= 85) { 
                stat.innerHTML = "âœ“ <b>Good (85-90%)</b> â€“ Meeting standard goals."; 
                stat.style.color = "#4ade80"; 
            } else if (res >= 75) { 
                stat.innerHTML = "âš¡ <b>Moderate (75-85%)</b> â€“ Review for optimization."; 
                stat.style.color = "var(--accent)"; 
            } else if (res >= 50) { 
                stat.innerHTML = "âš ï¸ <b>Below Target (50-75%)</b> â€“ Investigate cause."; 
                stat.style.color = "var(--danger)"; 
            } else if (res >= 0) { 
                stat.innerHTML = "ðŸš¨ <b>Poor (<50%)</b> â€“ Process upset likely."; 
                stat.style.color = "var(--danger)"; 
            } else { 
                stat.innerHTML = "ðŸš¨ <b>Negative</b> â€“ Effluent worse than influent!"; 
                stat.style.color = "var(--danger)"; 
            }
        }
    }

    // 8. WAS Pumping Rate
    function calcWAS() {
        const vol = parseFloat(document.getElementById('was_vol').value) || 0;
        const mlss = parseFloat(document.getElementById('was_mlss').value) || 0;
        const srt = parseFloat(document.getElementById('was_srt').value) || 0;
        const conc = parseFloat(document.getElementById('was_conc').value) || 0;
        
        if (srt > 0 && conc > 0) {
            // WAS Flow (MG) = (Vol Ã— MLSS) Ã· (SRT Ã— WAS Conc)
            const wasMGD = (vol * mlss) / (srt * conc);
            const wasGPD = wasMGD * 1000000;
            document.getElementById('was_res').innerText = wasGPD.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPD";
            const stat = document.getElementById('was_status');
            const wasGPM = wasGPD / 1440;
            stat.innerHTML = "ðŸ“Š <b>" + wasGPM.toFixed(1) + " GPM</b> continuous, or <b>" + (wasGPM * 2).toFixed(1) + " GPM</b> for 12 hrs/day";
            stat.style.color = "#94a3b8";
        }
    }

    // 9. RAS Return Rate
    function calcRAS() {
        const flow = parseFloat(document.getElementById('ras_flow').value) || 0;
        const mlss = parseFloat(document.getElementById('ras_mlss').value) || 0;
        const conc = parseFloat(document.getElementById('ras_conc').value) || 0;
        
        if (conc > mlss && conc > 0) {
            // RAS = (Q Ã— MLSS) Ã· (RAS Conc - MLSS)
            const ras = (flow * mlss) / (conc - mlss);
            document.getElementById('ras_res').innerText = ras.toFixed(3) + " MGD";
            const stat = document.getElementById('ras_status');
            const ratio = (ras / flow * 100).toFixed(0);
            if (ratio < 25) {
                stat.innerHTML = "âš¡ <b>" + ratio + "% RAS Ratio</b> â€“ Low return rate. Verify blanket depth.";
                stat.style.color = "var(--accent)";
            } else if (ratio <= 100) {
                stat.innerHTML = "âœ“ <b>" + ratio + "% RAS Ratio</b> â€“ Normal operating range (25-100%).";
                stat.style.color = "#4ade80";
            } else {
                stat.innerHTML = "âš ï¸ <b>" + ratio + "% RAS Ratio</b> â€“ High return. Check RAS concentration.";
                stat.style.color = "var(--accent)";
            }
        } else if (conc <= mlss && conc > 0) {
            document.getElementById('ras_status').innerHTML = "âš ï¸ <b>Check Values</b> â€“ RAS conc must be higher than MLSS";
            document.getElementById('ras_status').style.color = "var(--danger)";
        }
    }

    // 10. Organic Loading Rate
    function calcOLR() {
        const flow = parseFloat(document.getElementById('olr_flow').value) || 0;
        const bod = parseFloat(document.getElementById('olr_bod').value) || 0;
        const vol = parseFloat(document.getElementById('olr_vol').value) || 0;
        
        if (vol > 0) {
            // OLR = (Flow Ã— BOD Ã— 8.34) Ã· Volume (1000 ftÂ³)
            const olr = (flow * bod * 8.34) / vol;
            document.getElementById('olr_res').innerText = olr.toFixed(1) + " lbs/day/1000ftÂ³";
            const stat = document.getElementById('olr_status');
            
            if (olr < 5) {
                stat.innerHTML = "âš¡ <b>Low Rate (<5)</b> â€“ Under-loaded, may have operational issues.";
                stat.style.color = "var(--accent)";
            } else if (olr <= 25) {
                stat.innerHTML = "âœ“ <b>Low-Rate TF (5-25)</b> â€“ Standard trickling filter range.";
                stat.style.color = "#4ade80";
            } else if (olr <= 100) {
                stat.innerHTML = "âœ“ <b>High-Rate TF (25-100)</b> â€“ Higher loading, needs recirculation.";
                stat.style.color = "#4ade80";
            } else if (olr <= 300) {
                stat.innerHTML = "âš¡ <b>Roughing Filter (100-300)</b> â€“ Very high rate, partial treatment only.";
                stat.style.color = "var(--accent)";
            } else {
                stat.innerHTML = "âš ï¸ <b>Overloaded (>300)</b> â€“ Exceeds typical design limits.";
                stat.style.color = "var(--danger)";
            }
        }
    }

    // 11. Surface Overflow Rate
    function calcSOR() {
        const flow = parseFloat(document.getElementById('sor_flow').value) || 0;
        const area = parseFloat(document.getElementById('sor_area').value) || 0;
        
        if (area > 0) {
            const sor = flow / area;
            document.getElementById('sor_res').innerText = sor.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPD/ftÂ²";
            const stat = document.getElementById('sor_status');
            
            if (sor < 300) {
                stat.innerHTML = "âš¡ <b>Very Low (<300)</b> â€“ Under-utilized clarifier.";
                stat.style.color = "var(--primary)";
            } else if (sor <= 600) {
                stat.innerHTML = "âœ“ <b>Primary SOR (300-600)</b> â€“ Good for primary settling.";
                stat.style.color = "#4ade80";
            } else if (sor <= 800) {
                stat.innerHTML = "âœ“ <b>Secondary SOR (400-800)</b> â€“ Typical for activated sludge.";
                stat.style.color = "#4ade80";
            } else if (sor <= 1200) {
                stat.innerHTML = "âš ï¸ <b>High (800-1200)</b> â€“ Peak flow range. Monitor effluent TSS.";
                stat.style.color = "var(--accent)";
            } else {
                stat.innerHTML = "ðŸš¨ <b>Overloaded (>1200)</b> â€“ Risk of solids carryover.";
                stat.style.color = "var(--danger)";
            }
        }
    }

    // 12. Weir Overflow Rate
    function calcWOR() {
        const flow = parseFloat(document.getElementById('wor_flow').value) || 0;
        const len = parseFloat(document.getElementById('wor_len').value) || 0;
        
        if (len > 0) {
            const wor = flow / len;
            document.getElementById('wor_res').innerText = wor.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPD/ft";
            const stat = document.getElementById('wor_status');
            
            if (wor <= 10000) {
                stat.innerHTML = "âœ“ <b>Excellent (â‰¤10,000)</b> â€“ Low turbulence, good settling.";
                stat.style.color = "#4ade80";
            } else if (wor <= 15000) {
                stat.innerHTML = "âœ“ <b>Good (10,000-15,000)</b> â€“ Acceptable for most clarifiers.";
                stat.style.color = "#4ade80";
            } else if (wor <= 20000) {
                stat.innerHTML = "âš ï¸ <b>High (15,000-20,000)</b> â€“ May cause turbulence. Monitor TSS.";
                stat.style.color = "var(--accent)";
            } else {
                stat.innerHTML = "ðŸš¨ <b>Excessive (>20,000)</b> â€“ Risk of floc disruption and carryover.";
                stat.style.color = "var(--danger)";
            }
        }
    }

    // 13. Solids Loading Rate
    function calcSLR() {
        const flow = parseFloat(document.getElementById('slr_flow').value) || 0;
        const mlss = parseFloat(document.getElementById('slr_mlss').value) || 0;
        const area = parseFloat(document.getElementById('slr_area').value) || 0;
        
        if (area > 0) {
            // SLR = (Flow Ã— MLSS Ã— 8.34) Ã· Area
            const slr = (flow * mlss * 8.34) / area;
            document.getElementById('slr_res').innerText = slr.toFixed(2) + " lbs/day/ftÂ²";
            const stat = document.getElementById('slr_status');
            
            if (slr < 10) {
                stat.innerHTML = "âš¡ <b>Low (<10)</b> â€“ Under-loaded clarifier. Good settling expected.";
                stat.style.color = "var(--primary)";
            } else if (slr <= 25) {
                stat.innerHTML = "âœ“ <b>Normal (10-25)</b> â€“ Typical for secondary clarifiers.";
                stat.style.color = "#4ade80";
            } else if (slr <= 35) {
                stat.innerHTML = "âš ï¸ <b>High (25-35)</b> â€“ Peak flow range. Watch blanket depth.";
                stat.style.color = "var(--accent)";
            } else {
                stat.innerHTML = "ðŸš¨ <b>Overloaded (>35)</b> â€“ Risk of solids loss. Reduce RAS or increase area.";
                stat.style.color = "var(--danger)";
            }
        }
    }

    // 14. Chemical Dosing
    function calcChem() {
        const flow = parseFloat(document.getElementById('chem_flow').value) || 0;
        const dose = parseFloat(document.getElementById('chem_dose').value) || 0;
        const purity = parseFloat(document.getElementById('chem_purity').value) || 100;
        
        if (purity > 0) {
            // lbs/day = (Flow Ã— Dose Ã— 8.34) Ã· (Purity/100)
            const lbs = (flow * dose * 8.34) / (purity / 100);
            document.getElementById('chem_res').innerText = lbs.toFixed(2) + " lbs/day";
            const stat = document.getElementById('chem_status');
            const gallons = lbs / 8.34; // Approximate for liquids
            stat.innerHTML = "ðŸ“Š <b>" + lbs.toFixed(1) + " lbs/day</b> of chemical product | ~" + gallons.toFixed(1) + " gal/day if liquid";
            stat.style.color = "#94a3b8";
        }
    }

    // ==================== MBR CALCULATIONS ====================

    // 15. Membrane Flux Rate
    function calcFlux() {
        const flow = parseFloat(document.getElementById('flux_flow').value) || 0;
        const area = parseFloat(document.getElementById('flux_area').value) || 0;
        
        if (area > 0) {
            const gfd = flow / area;
            document.getElementById('flux_res').innerText = gfd.toFixed(1) + " GFD";
            const stat = document.getElementById('flux_status');
            
            // Also show LMH for international reference
            const lmh = gfd * 1.6985;
            
            if (gfd < 5) {
                stat.innerHTML = "ðŸš¨ <b>Very Low (<5 GFD)</b> â€“ Severe fouling likely. Initiate recovery clean (CIP). Check TMP.";
                stat.style.color = "var(--danger)";
            } else if (gfd < 8) {
                stat.innerHTML = "âš ï¸ <b>Low (5â€“8 GFD)</b> â€“ Fouling developing. Schedule maintenance clean. (" + lmh.toFixed(1) + " LMH)";
                stat.style.color = "var(--accent)";
            } else if (gfd <= 15) {
                stat.innerHTML = "âœ“ <b>Normal (8â€“15 GFD)</b> â€“ Healthy operating range. (" + lmh.toFixed(1) + " LMH)";
                stat.style.color = "#4ade80";
            } else if (gfd <= 25) {
                stat.innerHTML = "âš¡ <b>High (15â€“25 GFD)</b> â€“ Peak flow range acceptable short-term. (" + lmh.toFixed(1) + " LMH)";
                stat.style.color = "var(--accent)";
            } else {
                stat.innerHTML = "ðŸš¨ <b>Excessive (>25 GFD)</b> â€“ Risk of irreversible membrane damage. Reduce flow immediately.";
                stat.style.color = "var(--danger)";
            }
        }
    }

    // 16. Transmembrane Pressure
    function calcTMP() {
        const feed = parseFloat(document.getElementById('tmp_feed').value) || 0;
        const perm = parseFloat(document.getElementById('tmp_perm').value) || 0;
        
        if (feed > 0 || perm > 0) {
            const tmp = feed - perm;
            const kpa = tmp * 6.895;
            document.getElementById('tmp_res').innerText = tmp.toFixed(1) + " psi";
            const stat = document.getElementById('tmp_status');
            
            if (tmp < 0) {
                stat.innerHTML = "âš ï¸ <b>Negative TMP</b> â€“ Check pressure gauge readings. Feed should be > Permeate.";
                stat.style.color = "var(--danger)";
            } else if (tmp <= 3) {
                stat.innerHTML = "âœ“ <b>Excellent (0â€“3 psi)</b> â€“ Clean membranes, low resistance. (" + kpa.toFixed(1) + " kPa)";
                stat.style.color = "#4ade80";
            } else if (tmp <= 7) {
                stat.innerHTML = "âœ“ <b>Normal (3â€“7 psi)</b> â€“ Typical operating range. Monitor trend. (" + kpa.toFixed(1) + " kPa)";
                stat.style.color = "#4ade80";
            } else if (tmp <= 12) {
                stat.innerHTML = "âš ï¸ <b>Elevated (7â€“12 psi)</b> â€“ Fouling developing. Schedule maintenance clean. (" + kpa.toFixed(1) + " kPa)";
                stat.style.color = "var(--accent)";
            } else {
                stat.innerHTML = "ðŸš¨ <b>High (>12 psi)</b> â€“ Recovery CIP required. Risk of membrane damage if sustained. (" + kpa.toFixed(1) + " kPa)";
                stat.style.color = "var(--danger)";
            }
        }
    }

    // 17. Membrane Permeability
    function calcPerm() {
        const flux = parseFloat(document.getElementById('perm_flux').value) || 0;
        const tmp = parseFloat(document.getElementById('perm_tmp').value) || 0;
        
        if (tmp > 0) {
            const perm = flux / tmp;
            const lmhBar = perm * 1.6985 / 0.0689476; // Convert GFD/psi to LMH/bar
            document.getElementById('perm_res').innerText = perm.toFixed(2) + " GFD/psi";
            const stat = document.getElementById('perm_status');
            
            if (perm >= 5) {
                stat.innerHTML = "âœ“ <b>Excellent (â‰¥5)</b> â€“ Clean membrane performance. (" + lmhBar.toFixed(1) + " LMH/bar)";
                stat.style.color = "#4ade80";
            } else if (perm >= 3) {
                stat.innerHTML = "âœ“ <b>Good (3â€“5)</b> â€“ Normal operating condition. (" + lmhBar.toFixed(1) + " LMH/bar)";
                stat.style.color = "#4ade80";
            } else if (perm >= 1.5) {
                stat.innerHTML = "âš ï¸ <b>Declining (1.5â€“3)</b> â€“ Fouling progressing. Plan maintenance clean. (" + lmhBar.toFixed(1) + " LMH/bar)";
                stat.style.color = "var(--accent)";
            } else {
                stat.innerHTML = "ðŸš¨ <b>Poor (<1.5)</b> â€“ Significant fouling. Recovery CIP required. (" + lmhBar.toFixed(1) + " LMH/bar)";
                stat.style.color = "var(--danger)";
            }
        } else if (flux > 0 && tmp === 0) {
            document.getElementById('perm_status').innerHTML = "âš ï¸ TMP cannot be zero â€” enter measured pressure.";
            document.getElementById('perm_status').style.color = "var(--danger)";
        }
    }

    // 18. Membrane Area Sizing
    function calcMSize() {
        const flow = parseFloat(document.getElementById('msize_flow').value) || 0;
        const pf = parseFloat(document.getElementById('msize_pf').value) || 0;
        const avgFlux = parseFloat(document.getElementById('msize_flux').value) || 0;
        const peakFlux = parseFloat(document.getElementById('msize_peak').value) || 0;
        
        if (flow > 0 && avgFlux > 0) {
            const flowGPD = flow * 1000000;
            const areaAvg = flowGPD / avgFlux;
            let areaPeak = 0;
            let peakCheck = "";
            
            if (pf > 0 && peakFlux > 0) {
                areaPeak = (flowGPD * pf) / peakFlux;
                const actualPeakFlux = (flowGPD * pf) / areaAvg;
                if (actualPeakFlux > 25) {
                    peakCheck = "<br>âš ï¸ Peak flux on avg-sized area = " + actualPeakFlux.toFixed(1) + " GFD â€” exceeds 25 GFD limit!";
                } else {
                    peakCheck = "<br>âœ“ Peak flux on avg-sized area = " + actualPeakFlux.toFixed(1) + " GFD â€” within limits.";
                }
            }
            
            const designArea = Math.max(areaAvg, areaPeak);
            const fmt = designArea.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            document.getElementById('msize_res').innerText = fmt + " ftÂ²";
            const stat = document.getElementById('msize_status');
            
            stat.innerHTML = "ðŸ“Š <b>Avg design:</b> " + areaAvg.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " ftÂ²" +
                (areaPeak > 0 ? " | <b>Peak design:</b> " + areaPeak.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " ftÂ²" : "") +
                peakCheck + "<br>Governing area: <b>" + fmt + " ftÂ²</b> (" + (designArea / 1000).toFixed(1) + "k ftÂ²)";
            stat.style.color = "#94a3b8";
        }
    }

    // 19. Specific Aeration Demand
    function calcSAD() {
        const air = parseFloat(document.getElementById('sad_air').value) || 0;
        const area = parseFloat(document.getElementById('sad_area').value) || 0;
        const perm = parseFloat(document.getElementById('sad_perm').value) || 0;
        
        if (air > 0 && (area > 0 || perm > 0)) {
            let results = [];
            let sadmVal = 0, sadpVal = 0;
            const stat = document.getElementById('sad_status');
            
            if (area > 0) {
                sadmVal = air / area;
                results.push("SADm = " + sadmVal.toFixed(3) + " NmÂ³/mÂ²/hr");
            }
            if (perm > 0) {
                sadpVal = air / perm;
                results.push("SADp = " + sadpVal.toFixed(1) + " mÂ³air/mÂ³perm");
            }
            
            document.getElementById('sad_res').innerText = results.join(" | ");
            
            let assessment = [];
            if (sadmVal > 0) {
                if (sadmVal < 0.2) assessment.push("âš¡ SADm very low â€” verify adequate scouring");
                else if (sadmVal <= 0.5) assessment.push("âœ“ SADm in hollow fiber range (0.2â€“0.5)");
                else if (sadmVal <= 1.0) assessment.push("âœ“ SADm in flat sheet range (0.5â€“1.0)");
                else assessment.push("âš ï¸ SADm high â€” excessive air scouring energy");
            }
            if (sadpVal > 0) {
                if (sadpVal < 10) assessment.push("âœ“ SADp efficient (<10)");
                else if (sadpVal <= 25) assessment.push("âœ“ SADp typical (10â€“25)");
                else assessment.push("âš ï¸ SADp high (>25) â€” energy optimization opportunity");
            }
            
            stat.innerHTML = assessment.join("<br>");
            stat.style.color = (sadmVal > 1.0 || sadpVal > 25) ? "var(--accent)" : "#4ade80";
        }
    }

    // 20. MBR Operating Range Check
    function calcMBRC() {
        const mlss = parseFloat(document.getElementById('mbrc_mlss').value) || 0;
        const srt = parseFloat(document.getElementById('mbrc_srt').value) || 0;
        const fm = parseFloat(document.getElementById('mbrc_fm').value) || 0;
        const doVal = parseFloat(document.getElementById('mbrc_do').value) || 0;
        
        let checks = [];
        let issues = 0;
        let entered = 0;
        
        if (mlss > 0) {
            entered++;
            if (mlss < 6000) { checks.push("ðŸš¨ <b>MLSS " + mlss + "</b> â€“ Too low for MBR. Target 8,000â€“12,000 mg/L."); issues++; }
            else if (mlss < 8000) { checks.push("âš ï¸ <b>MLSS " + mlss + "</b> â€“ Below MBR range. May reduce membrane protection."); issues++; }
            else if (mlss <= 12000) { checks.push("âœ“ <b>MLSS " + mlss + "</b> â€“ Within MBR range (8,000â€“12,000)."); }
            else if (mlss <= 15000) { checks.push("âš ï¸ <b>MLSS " + mlss + "</b> â€“ High. Increases viscosity & TMP."); issues++; }
            else { checks.push("ðŸš¨ <b>MLSS " + mlss + "</b> â€“ Excessive. Rapid fouling risk. Increase wasting."); issues++; }
        }
        
        if (srt > 0) {
            entered++;
            if (srt < 10) { checks.push("ðŸš¨ <b>SRT " + srt + "d</b> â€“ Too low for MBR. Target 15â€“40 days."); issues++; }
            else if (srt < 15) { checks.push("âš ï¸ <b>SRT " + srt + "d</b> â€“ Below typical MBR. May lose nitrifiers."); issues++; }
            else if (srt <= 40) { checks.push("âœ“ <b>SRT " + srt + "d</b> â€“ Within MBR range (15â€“40 days)."); }
            else { checks.push("âš ï¸ <b>SRT " + srt + "d</b> â€“ Very high. Risk of EPS buildup & fouling."); issues++; }
        }
        
        if (fm > 0) {
            entered++;
            if (fm < 0.04) { checks.push("âš ï¸ <b>F:M " + fm + "</b> â€“ Very low. Endogenous conditions, possible pin floc."); issues++; }
            else if (fm <= 0.15) { checks.push("âœ“ <b>F:M " + fm + "</b> â€“ Within MBR range (0.05â€“0.15)."); }
            else if (fm <= 0.25) { checks.push("âš ï¸ <b>F:M " + fm + "</b> â€“ High for MBR. More typical of CAS."); issues++; }
            else { checks.push("ðŸš¨ <b>F:M " + fm + "</b> â€“ Exceeds MBR range. This is CAS territory (>0.2)."); issues++; }
        }
        
        if (doVal > 0) {
            entered++;
            if (doVal < 0.5) { checks.push("ðŸš¨ <b>DO " + doVal + "</b> â€“ Critically low. Risk of filaments & poor nitrification."); issues++; }
            else if (doVal < 1.0) { checks.push("âš ï¸ <b>DO " + doVal + "</b> â€“ Below MBR minimum. Increase aeration."); issues++; }
            else if (doVal <= 3.0) { checks.push("âœ“ <b>DO " + doVal + "</b> â€“ Within MBR range (1.0â€“3.0 mg/L)."); }
            else { checks.push("âš¡ <b>DO " + doVal + "</b> â€“ Higher than needed. Energy savings opportunity."); }
        }
        
        if (entered > 0) {
            const score = entered - issues;
            document.getElementById('mbrc_res').innerText = score + "/" + entered + " In Range";
            const stat = document.getElementById('mbrc_status');
            stat.innerHTML = checks.join("<br>");
            stat.style.color = issues === 0 ? "#4ade80" : (issues >= entered/2 ? "var(--danger)" : "var(--accent)");
        }
    }

    // 21. CIP Chemical Dosing
    function calcCIP() {
        const vol = parseFloat(document.getElementById('cip_vol').value) || 0;
        const naclTarget = parseFloat(document.getElementById('cip_nacl').value) || 0;
        const bleachPct = parseFloat(document.getElementById('cip_bleach').value) || 0;
        const citTarget = parseFloat(document.getElementById('cip_citric').value) || 0;
        const citPct = parseFloat(document.getElementById('cip_cstr').value) || 0;
        
        if (vol > 0) {
            let results = [];
            let details = [];
            const volLiters = vol * 3.785;
            
            // NaOCl calculation
            if (naclTarget > 0 && bleachPct > 0) {
                // Volume (gal) = (Tank gal Ã— Target mg/L) Ã· (Strength% Ã— 10,000)
                const naclGal = (vol * naclTarget) / (bleachPct * 10000);
                const naclOz = naclGal * 128;
                results.push("NaOCl: " + naclGal.toFixed(2) + " gal");
                
                let cleanType = "";
                if (naclTarget <= 500) cleanType = "Maintenance Clean range";
                else if (naclTarget <= 2000) cleanType = "Recovery Clean range";
                else cleanType = "âš ï¸ Exceeds typical â€” verify with membrane manufacturer";
                
                details.push("ðŸ§ª <b>NaOCl:</b> " + naclGal.toFixed(2) + " gal (" + naclOz.toFixed(0) + " fl oz) of " + bleachPct + "% bleach â†’ " + naclTarget + " mg/L â€” " + cleanType);
            }
            
            // Citric acid calculation
            if (citTarget > 0 && citPct > 0) {
                const citGal = (vol * citTarget) / (citPct * 10000);
                const citLbs = citGal * 8.34 * (citPct / 100);
                results.push("Citric: " + citGal.toFixed(2) + " gal");
                
                let cleanType = "";
                if (citTarget <= 2000) cleanType = "Maintenance Clean range";
                else if (citTarget <= 5000) cleanType = "Recovery Clean range";
                else cleanType = "âš ï¸ Exceeds typical â€” verify dosage";
                
                details.push("ðŸ§ª <b>Citric Acid:</b> " + citGal.toFixed(2) + " gal of " + citPct + "% solution â†’ " + citTarget + " mg/L â€” " + cleanType);
            }
            
            if (results.length > 0) {
                document.getElementById('cip_res').innerText = results.join(" | ");
                const stat = document.getElementById('cip_status');
                details.push("<br>âš ï¸ <b>Safety:</b> Never mix NaOCl and citric acid. Rinse between steps. Soak 4â€“6 hrs typical.");
                stat.innerHTML = details.join("<br>");
                stat.style.color = "#94a3b8";
            }
        }
    }

    // ==================== MBBR CALCULATIONS ====================

    // 22. Surface Area Loading Rate
    function calcSALR() {
        const flow = parseFloat(document.getElementById('salr_flow').value) || 0;
        const conc = parseFloat(document.getElementById('salr_conc').value) || 0;
        const area = parseFloat(document.getElementById('salr_area').value) || 0;
        
        if (area > 0 && flow > 0 && conc > 0) {
            // Load (g/day) = Flow (MGD) Ã— Conc (mg/L) Ã— 3,785,412 (L/MG) / 1000 (mg/g)
            // SALR = Load / Area
            const loadGday = flow * conc * 3785.412;
            const salr = loadGday / area;
            document.getElementById('salr_res').innerText = salr.toFixed(1) + " g/mÂ²/d";
            const stat = document.getElementById('salr_status');
            
            const loadLbs = flow * conc * 8.34;
            
            if (conc > 50) {
                // BOD loading interpretation
                if (salr < 5) {
                    stat.innerHTML = "âš¡ <b>Low SALR (<5)</b> â€“ Under-loaded biofilm. Media may be oversized. Load: " + loadLbs.toFixed(0) + " lbs/day";
                    stat.style.color = "var(--primary)";
                } else if (salr <= 10) {
                    stat.innerHTML = "âœ“ <b>Moderate (5â€“10)</b> â€“ Conservative BOD removal. Good for cold climate. Load: " + loadLbs.toFixed(0) + " lbs/day";
                    stat.style.color = "#4ade80";
                } else if (salr <= 20) {
                    stat.innerHTML = "âœ“ <b>Typical (10â€“20)</b> â€“ Standard BOD removal range. Load: " + loadLbs.toFixed(0) + " lbs/day";
                    stat.style.color = "#4ade80";
                } else {
                    stat.innerHTML = "âš ï¸ <b>High (>20)</b> â€“ May exceed biofilm capacity. Check effluent quality. Load: " + loadLbs.toFixed(0) + " lbs/day";
                    stat.style.color = "var(--accent)";
                }
            } else {
                // NH3 loading interpretation
                if (salr < 0.5) {
                    stat.innerHTML = "âš¡ <b>Low (<0.5)</b> â€“ Under-loaded for nitrification. Load: " + loadLbs.toFixed(1) + " lbs/day";
                    stat.style.color = "var(--primary)";
                } else if (salr <= 1.5) {
                    stat.innerHTML = "âœ“ <b>Typical (0.5â€“1.5)</b> â€“ Standard nitrification range. Load: " + loadLbs.toFixed(1) + " lbs/day";
                    stat.style.color = "#4ade80";
                } else {
                    stat.innerHTML = "âš ï¸ <b>High (>1.5)</b> â€“ May need additional area for full nitrification. Load: " + loadLbs.toFixed(1) + " lbs/day";
                    stat.style.color = "var(--accent)";
                }
            }
        }
    }

    // 23. Effective Biofilm Area
    function calcBioArea() {
        const vol = parseFloat(document.getElementById('bio_vol').value) || 0;
        const fill = parseFloat(document.getElementById('bio_fill').value) || 0;
        const ssa = parseFloat(document.getElementById('bio_ssa').value) || 0;
        
        if (vol > 0 && fill > 0 && ssa > 0) {
            const volM3 = vol * 0.0283168; // ftÂ³ to mÂ³
            const mediaM3 = volM3 * (fill / 100);
            const area = mediaM3 * ssa;
            const fmt = area.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            document.getElementById('bio_res').innerText = fmt + " mÂ²";
            const stat = document.getElementById('bio_status');
            
            const areaFt2 = area * 10.764;
            
            let fillCheck = "";
            if (fill < 40) fillCheck = "âš ï¸ Fill below 40% â€” under-utilizing reactor volume.";
            else if (fill <= 67) fillCheck = "âœ“ Fill " + fill + "% within design range (40â€“67%).";
            else fillCheck = "ðŸš¨ Fill " + fill + "% exceeds 67% max â€” media cannot circulate properly!";
            
            stat.innerHTML = "ðŸ“Š <b>" + fmt + " mÂ²</b> (" + areaFt2.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " ftÂ²) protected biofilm area" +
                "<br>Media volume: " + mediaM3.toFixed(1) + " mÂ³ (" + (mediaM3 * 35.3147).toFixed(0) + " ftÂ³)" +
                "<br>" + fillCheck;
            stat.style.color = fill > 67 ? "var(--danger)" : "#4ade80";
        }
    }

    // 24. Media Fill Volume
    function calcMediaVol() {
        const flow = parseFloat(document.getElementById('mv_flow').value) || 0;
        const conc = parseFloat(document.getElementById('mv_conc').value) || 0;
        const salr = parseFloat(document.getElementById('mv_salr').value) || 0;
        const ssa = parseFloat(document.getElementById('mv_ssa').value) || 0;
        
        if (flow > 0 && conc > 0 && salr > 0 && ssa > 0) {
            const loadGday = flow * conc * 3785.412;
            const reqArea = loadGday / salr;
            const mediaVol = reqArea / ssa;
            const mediaFt3 = mediaVol * 35.3147;
            document.getElementById('mv_res').innerText = mediaVol.toFixed(1) + " mÂ³";
            const stat = document.getElementById('mv_status');
            
            // Show reactor sizes at different fill fractions
            const r50 = mediaVol / 0.50;
            const r55 = mediaVol / 0.55;
            const r60 = mediaVol / 0.60;
            
            stat.innerHTML = "ðŸ“Š Required biofilm area: <b>" + reqArea.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " mÂ²</b>" +
                "<br>Media volume: <b>" + mediaVol.toFixed(1) + " mÂ³</b> (" + mediaFt3.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " ftÂ³)" +
                "<br>Reactor needed @ 50% fill: " + r50.toFixed(1) + " mÂ³ | 55%: " + r55.toFixed(1) + " mÂ³ | 60%: " + r60.toFixed(1) + " mÂ³";
            stat.style.color = "#94a3b8";
        }
    }

    // 25. MBBR Reactor Sizing
    function calcRSZ() {
        const media = parseFloat(document.getElementById('rsz_media').value) || 0;
        const fill = parseFloat(document.getElementById('rsz_fill').value) || 0;
        const flow = parseFloat(document.getElementById('rsz_flow').value) || 0;
        
        if (media > 0 && fill > 0) {
            const reactor = media / (fill / 100);
            const reactorFt3 = reactor * 35.3147;
            const reactorGal = reactor * 264.172;
            document.getElementById('rsz_res').innerText = reactor.toFixed(1) + " mÂ³";
            const stat = document.getElementById('rsz_status');
            
            let hrtInfo = "";
            if (flow > 0) {
                const flowM3hr = flow * 3785.412 / 24;
                const hrt = reactor / flowM3hr;
                hrtInfo = "<br>HRT: <b>" + hrt.toFixed(1) + " hrs</b>";
                if (hrt < 1) hrtInfo += " â€” âš ï¸ Very short, may need larger reactor";
                else if (hrt <= 3) hrtInfo += " â€” Typical for BOD removal";
                else if (hrt <= 6) hrtInfo += " â€” Good for nitrification";
                else hrtInfo += " â€” Long HRT, may be oversized";
            }
            
            let fillCheck = "";
            if (fill > 67) fillCheck = "<br>ðŸš¨ Fill " + fill + "% exceeds 67% max â€” media cannot circulate!";
            else if (fill < 40) fillCheck = "<br>âš ï¸ Fill " + fill + "% below 40% â€” reactor volume under-utilized";
            else fillCheck = "<br>âœ“ Fill " + fill + "% in design range";
            
            stat.innerHTML = "ðŸ“Š Reactor: <b>" + reactor.toFixed(1) + " mÂ³</b> (" + reactorFt3.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " ftÂ³ | " + 
                reactorGal.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " gal)" + hrtInfo + fillCheck;
            stat.style.color = fill > 67 ? "var(--danger)" : "#4ade80";
        }
    }

    // 26. MBBR Dissolved Oxygen Demand
    function calcMDO() {
        const flow = parseFloat(document.getElementById('mdo_flow').value) || 0;
        const bod = parseFloat(document.getElementById('mdo_bod').value) || 0;
        const nh3 = parseFloat(document.getElementById('mdo_nh3').value) || 0;
        
        if (flow > 0 && (bod > 0 || nh3 > 0)) {
            const o2bod = flow * bod * 8.34 * 1.5;
            const o2nh3 = flow * nh3 * 8.34 * 4.6;
            const total = o2bod + o2nh3;
            document.getElementById('mdo_res').innerText = total.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs Oâ‚‚/day";
            const stat = document.getElementById('mdo_status');
            
            const totalKg = total / 2.205;
            
            stat.innerHTML = "ðŸ“Š <b>BOD oxidation:</b> " + o2bod.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs/day (1.5Ã— BOD removed)" +
                "<br><b>Nitrification:</b> " + o2nh3.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs/day (4.6Ã— NHâ‚ƒ-N oxidized)" +
                "<br><b>Total:</b> " + total.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs/day (" + totalKg.toFixed(0) + " kg/day)" +
                "<br>âš¡ Maintain DO â‰¥ 4 mg/L in MBBR zone (vs ~2 mg/L for CAS)";
            stat.style.color = "#94a3b8";
        }
    }

    // 27. MBBR vs CAS Comparison
    function calcCMP() {
        const flow = parseFloat(document.getElementById('cmp_flow').value) || 0;
        const bod = parseFloat(document.getElementById('cmp_bod').value) || 0;
        
        if (flow > 0 && bod > 0) {
            // CAS assumptions: F:M=0.3, MLSS=3000 mg/L
            const casLoad = flow * bod * 8.34;
            const casVol = (casLoad / (0.3 * 3000)) * 1000000; // gallons
            const casVolFt3 = casVol / 7.481;
            const casHRT = casVol / (flow * 1000000) * 24;
            
            // MBBR assumptions: SALR=10 g/mÂ²/d, K3 500 mÂ²/mÂ³, 55% fill
            const loadGday = flow * bod * 3785.412;
            const reqArea = loadGday / 10;
            const mediaVol = reqArea / 500;
            const mbbrVol = mediaVol / 0.55;
            const mbbrVolGal = mbbrVol * 264.172;
            const mbbrVolFt3 = mbbrVol * 35.3147;
            const mbbrHRT = mbbrVol / (flow * 3785.412 / 24);
            
            const savings = ((1 - mbbrVolFt3 / casVolFt3) * 100);
            
            document.getElementById('cmp_res').innerText = "MBBR " + (savings > 0 ? savings.toFixed(0) + "% smaller" : Math.abs(savings).toFixed(0) + "% larger");
            const stat = document.getElementById('cmp_status');
            
            stat.innerHTML = "<b>â”â” CAS (Conventional) â”â”</b>" +
                "<br>F:M=0.3 | MLSS=3,000 | SRT~10d" +
                "<br>Volume: " + (casVolFt3/1000).toFixed(1) + "k ftÂ³ (" + (casVol/1000).toFixed(0) + "k gal)" +
                "<br>HRT: " + casHRT.toFixed(1) + " hrs" +
                "<br><br><b>â”â” MBBR (Biofilm) â”â”</b>" +
                "<br>SALR=10 g/mÂ²/d | K3 500 mÂ²/mÂ³ | 55% fill" +
                "<br>Volume: " + (mbbrVolFt3/1000).toFixed(1) + "k ftÂ³ (" + (mbbrVolGal/1000).toFixed(0) + "k gal)" +
                "<br>HRT: " + mbbrHRT.toFixed(1) + " hrs | Media: " + mediaVol.toFixed(0) + " mÂ³" +
                "<br><br>ðŸ”„ <b>MBBR is " + Math.abs(savings).toFixed(0) + "% " + (savings > 0 ? "smaller" : "larger") + " footprint</b> than CAS for same load";
            stat.style.color = "#94a3b8";
        }
    }

    // ==================== SBR CALCULATIONS ====================

    // 28. SBR Cycle Time
    function calcCycle() {
        const fill = parseFloat(document.getElementById('cyc_fill').value) || 0;
        const react = parseFloat(document.getElementById('cyc_react').value) || 0;
        const settle = parseFloat(document.getElementById('cyc_settle').value) || 0;
        const decant = parseFloat(document.getElementById('cyc_decant').value) || 0;
        const idle = parseFloat(document.getElementById('cyc_idle').value) || 0;
        const flow = parseFloat(document.getElementById('cyc_flow').value) || 0;
        
        const total = fill + react + settle + decant + idle;
        
        if (total > 0) {
            const hrs = total / 60;
            const cyclesDay = 1440 / total;
            document.getElementById('cyc_res').innerText = hrs.toFixed(1) + " hrs | " + cyclesDay.toFixed(1) + " cycles/day";
            const stat = document.getElementById('cyc_status');
            
            const fillPct = (fill / total * 100).toFixed(0);
            const reactPct = (react / total * 100).toFixed(0);
            const settlePct = (settle / total * 100).toFixed(0);
            const decantPct = (decant / total * 100).toFixed(0);
            const idlePct = (idle / total * 100).toFixed(0);
            const aeratedPct = ((fill + react) / total * 100).toFixed(0);
            
            let info = "ðŸ“Š <b>Phase Breakdown:</b>" +
                "<br>Fill: " + fill + " min (" + fillPct + "%) | React: " + react + " min (" + reactPct + "%)" +
                "<br>Settle: " + settle + " min (" + settlePct + "%) | Decant: " + decant + " min (" + decantPct + "%)" +
                (idle > 0 ? " | Idle: " + idle + " min (" + idlePct + "%)" : "") +
                "<br>Aeration duty: <b>" + aeratedPct + "%</b> of cycle";
            
            if (flow > 0) {
                const volPerCycle = (flow * 1000000) / cyclesDay;
                info += "<br>Fill volume: " + volPerCycle.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " gal/cycle (1 basin)";
            }
            
            let check = "";
            if (cyclesDay < 3) check = "<br>âš ï¸ Few cycles/day â€” long cycle may limit peak flow capacity";
            else if (cyclesDay <= 6) check = "<br>âœ“ " + cyclesDay.toFixed(1) + " cycles/day â€” typical SBR operation";
            else check = "<br>âš¡ " + cyclesDay.toFixed(1) + " cycles/day â€” short cycles, verify settle time is adequate";
            
            stat.innerHTML = info + check;
            stat.style.color = "#94a3b8";
        }
    }

    // 29. SBR Volume per Cycle
    function calcSBRVol() {
        const flow = parseFloat(document.getElementById('sv_flow').value) || 0;
        const cycles = parseFloat(document.getElementById('sv_cycles').value) || 0;
        const reactor = parseFloat(document.getElementById('sv_reactor').value) || 0;
        const basins = parseFloat(document.getElementById('sv_basins').value) || 1;
        
        if (flow > 0 && cycles > 0) {
            const dailyGal = flow * 1000000;
            const volPerCycle = dailyGal / (cycles * basins);
            const fmt = volPerCycle.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            document.getElementById('sv_res').innerText = fmt + " gal/cycle";
            const stat = document.getElementById('sv_status');
            
            let info = "ðŸ“Š <b>" + fmt + " gal</b> per cycle per basin" +
                "<br>Daily: " + (dailyGal / 1000).toFixed(0) + "k gal across " + basins + " basin(s), " + cycles + " cycles";
            
            if (reactor > 0) {
                const fillRatio = (volPerCycle / reactor * 100);
                info += "<br>Fill ratio: <b>" + fillRatio.toFixed(1) + "%</b> of reactor volume";
                
                if (fillRatio < 15) {
                    info += " â€” âš¡ Low fill ratio. Reactor may be oversized.";
                } else if (fillRatio <= 35) {
                    info += " â€” âœ“ Within design range (15â€“35%)";
                } else if (fillRatio <= 50) {
                    info += " â€” âš ï¸ High fill ratio. Limited freeboard.";
                } else {
                    info += " â€” ðŸš¨ Exceeds 50%! Risk of overflow. Reduce flow or add cycles.";
                }
            }
            
            stat.innerHTML = info;
            stat.style.color = "#94a3b8";
        }
    }

    // 30. SBR Decant Rate
    function calcDecant() {
        const vol = parseFloat(document.getElementById('dec_vol').value) || 0;
        const time = parseFloat(document.getElementById('dec_time').value) || 0;
        const weir = parseFloat(document.getElementById('dec_weir').value) || 0;
        
        if (vol > 0 && time > 0) {
            const gpm = vol / time;
            document.getElementById('dec_res').innerText = gpm.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPM";
            const stat = document.getElementById('dec_status');
            
            let info = "ðŸ“Š <b>Decant rate:</b> " + gpm.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPM";
            
            if (weir > 0) {
                const weirRate = gpm / weir;
                info += "<br>Weir loading: <b>" + weirRate.toFixed(1) + " GPM/ft</b>";
                
                if (weirRate <= 5) {
                    info += " â€” âœ“ Excellent. Low turbulence risk.";
                } else if (weirRate <= 10) {
                    info += " â€” âœ“ Acceptable range (&lt;10 GPM/ft).";
                } else if (weirRate <= 15) {
                    info += " â€” âš ï¸ Elevated. May disturb settled solids.";
                } else {
                    info += " â€” ðŸš¨ Too high. Risk of solids carryover into effluent.";
                }
            }
            
            if (gpm < 500) info += "<br>âš¡ Low decant rate â€” may extend cycle time unnecessarily";
            else if (gpm <= 4000) info += "<br>âœ“ Decant rate within typical range (500â€“4,000 GPM)";
            else info += "<br>âš ï¸ High decant rate â€” verify effluent TSS during decant";
            
            stat.innerHTML = info;
            stat.style.color = "#94a3b8";
        }
    }

    // 31. SBR Aeration Demand
    function calcSBRAer() {
        const flow = parseFloat(document.getElementById('saer_flow').value) || 0;
        const bod = parseFloat(document.getElementById('saer_bod').value) || 0;
        const nh3 = parseFloat(document.getElementById('saer_nh3').value) || 0;
        const duty = parseFloat(document.getElementById('saer_duty').value) || 0;
        
        if (flow > 0 && (bod > 0 || nh3 > 0)) {
            const o2bod = flow * bod * 8.34 * 1.5;
            const o2nh3 = flow * nh3 * 8.34 * 4.6;
            const dailyO2 = o2bod + o2nh3;
            
            document.getElementById('saer_res').innerText = dailyO2.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs Oâ‚‚/day";
            const stat = document.getElementById('saer_status');
            
            let info = "ðŸ“Š <b>Daily Oâ‚‚ demand:</b> " + dailyO2.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs/day" +
                "<br>BOD oxidation: " + o2bod.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs | Nitrification: " + o2nh3.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs";
            
            if (duty > 0) {
                const peakRate = dailyO2 / (duty / 100);
                const peakPerHr = peakRate / 24;
                const multiplier = (100 / duty);
                info += "<br><br>âš¡ <b>SBR Aeration Sizing:</b>" +
                    "<br>Duty cycle: " + duty + "% â†’ Blower must deliver <b>" + multiplier.toFixed(1) + "Ã—</b> continuous rate" +
                    "<br>Peak delivery: <b>" + peakRate.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs/day equiv</b> (" + peakPerHr.toFixed(1) + " lbs/hr during aeration)";
            }
            
            stat.innerHTML = info;
            stat.style.color = "#94a3b8";
        }
    }

    // 32. SBR F:M per Cycle
    function calcSBRFM() {
        const fillVol = parseFloat(document.getElementById('sfm_fill').value) || 0;
        const bod = parseFloat(document.getElementById('sfm_bod').value) || 0;
        const reactorVol = parseFloat(document.getElementById('sfm_vol').value) || 0;
        const mlvss = parseFloat(document.getElementById('sfm_mlvss').value) || 0;
        const cycles = parseFloat(document.getElementById('sfm_cycles').value) || 0;
        
        if (fillVol > 0 && bod > 0 && reactorVol > 0 && mlvss > 0) {
            // Food per cycle (lbs)
            const fillMG = fillVol / 1000000;
            const foodPerCycle = fillMG * bod * 8.34;
            
            // Biomass in reactor (lbs)
            const reactorMG = reactorVol / 1000000;
            const biomass = reactorMG * mlvss * 8.34;
            
            // Instantaneous F:M at start of fill
            const instFM = foodPerCycle / biomass;
            
            // Daily F:M
            let dailyFM = 0;
            let dailyInfo = "";
            if (cycles > 0) {
                dailyFM = (foodPerCycle * cycles) / biomass;
                dailyInfo = "<br>Daily F:M: <b>" + dailyFM.toFixed(3) + "</b> (" + cycles + " cycles Ã— " + foodPerCycle.toFixed(1) + " lbs food)";
            }
            
            document.getElementById('sfm_res').innerText = "Inst: " + instFM.toFixed(3) + " | Daily: " + dailyFM.toFixed(3);
            const stat = document.getElementById('sfm_status');
            
            let assessment = "";
            if (dailyFM > 0) {
                if (dailyFM < 0.04) assessment = "âš¡ Very low daily F:M â€” endogenous conditions, possible pin floc";
                else if (dailyFM <= 0.15) assessment = "âœ“ Daily F:M in typical SBR range (0.05â€“0.15)";
                else if (dailyFM <= 0.3) assessment = "âš ï¸ Elevated daily F:M â€” more typical of CAS";
                else assessment = "ðŸš¨ High F:M â€” may need to increase MLSS or reduce loading";
            }
            
            stat.innerHTML = "ðŸ“Š <b>Instantaneous F:M:</b> " + instFM.toFixed(3) + " (at start of fill)" +
                dailyInfo +
                "<br>Food/cycle: " + foodPerCycle.toFixed(1) + " lbs BOD | Biomass: " + biomass.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs" +
                "<br>" + assessment;
            stat.style.color = "#94a3b8";
        }
    }

    // 33. SBR Settle & Decant Check
    function calcSSC() {
        const depth = parseFloat(document.getElementById('ssc_depth').value) || 0;
        const sludgePct = parseFloat(document.getElementById('ssc_sludge').value) || 0;
        const decantDepth = parseFloat(document.getElementById('ssc_decant').value) || 0;
        const mlss = parseFloat(document.getElementById('ssc_mlss').value) || 0;
        
        if (depth > 0 && sludgePct > 0) {
            const blanketDepth = depth * (sludgePct / 100);
            const clearwater = depth - blanketDepth;
            const buffer = clearwater - decantDepth;
            
            let result = "";
            if (buffer >= 2) result = buffer.toFixed(1) + " ft buffer âœ“";
            else if (buffer > 0) result = buffer.toFixed(1) + " ft buffer âš ï¸";
            else result = "NO BUFFER ðŸš¨";
            
            document.getElementById('ssc_res').innerText = result;
            const stat = document.getElementById('ssc_status');
            
            let svi = "";
            if (mlss > 0) {
                const sviVal = (sludgePct * 10000) / mlss;
                svi = "<br>Estimated SVI: <b>" + sviVal.toFixed(0) + " mL/g</b>";
                if (sviVal < 80) svi += " â€” Excellent settling";
                else if (sviVal <= 150) svi += " â€” Good settling";
                else if (sviVal <= 250) svi += " â€” Fair settling, watch for filaments";
                else svi += " â€” âš ï¸ Poor settling, check for bulking";
            }
            
            let assessment = "";
            if (buffer >= 3) {
                assessment = "âœ“ <b>Safe:</b> " + buffer.toFixed(1) + " ft buffer between blanket and decant zone. Good separation.";
                stat.style.color = "#4ade80";
            } else if (buffer >= 2) {
                assessment = "âœ“ <b>Adequate:</b> " + buffer.toFixed(1) + " ft buffer. Minimum safe margin (â‰¥2 ft).";
                stat.style.color = "#4ade80";
            } else if (buffer > 0) {
                assessment = "âš ï¸ <b>Tight:</b> Only " + buffer.toFixed(1) + " ft buffer. Risk of solids carryover. Consider longer settle or less decant depth.";
                stat.style.color = "var(--accent)";
            } else {
                assessment = "ðŸš¨ <b>Solids Carryover Risk:</b> Blanket (" + blanketDepth.toFixed(1) + " ft) extends into decant zone! Reduce decant depth or increase settle time.";
                stat.style.color = "var(--danger)";
            }
            
            stat.innerHTML = "ðŸ“Š Blanket: <b>" + blanketDepth.toFixed(1) + " ft</b> | Clear water: <b>" + clearwater.toFixed(1) + " ft</b> | Decant: <b>" + decantDepth.toFixed(1) + " ft</b>" +
                svi +
                "<br>" + assessment;
        }
    }

    // ==================== DISINFECTION CALCULATIONS ====================

    // 34. Chlorine CT
    function calcCT() {
        const residual = parseFloat(document.getElementById('ct_res_in').value) || 0;
        const time = parseFloat(document.getElementById('ct_time').value) || 0;
        const req = parseFloat(document.getElementById('ct_req').value) || 0;
        
        if (residual > 0 && time > 0) {
            const ct = residual * time;
            document.getElementById('ct_res').innerText = ct.toFixed(1) + " mgÂ·min/L";
            const stat = document.getElementById('ct_status');
            
            let info = "ðŸ“Š CT = " + residual + " mg/L Ã— " + time + " min = <b>" + ct.toFixed(1) + " mgÂ·min/L</b>";
            
            if (req > 0) {
                const ratio = (ct / req * 100).toFixed(0);
                if (ct >= req) {
                    info += "<br>âœ“ <b>Compliant:</b> " + ratio + "% of required CT (" + req + " mgÂ·min/L)";
                    stat.style.color = "#4ade80";
                } else {
                    info += "<br>ðŸš¨ <b>Non-compliant:</b> Only " + ratio + "% of required CT (" + req + "). Increase residual or contact time.";
                    stat.style.color = "var(--danger)";
                }
            }
            stat.innerHTML = info;
        }
    }

    // 35. Dechlorination
    function calcDCL() {
        const flow = parseFloat(document.getElementById('dcl_flow').value) || 0;
        const cl2 = parseFloat(document.getElementById('dcl_cl2').value) || 0;
        const sf = parseFloat(document.getElementById('dcl_sf').value) || 1.0;
        
        if (flow > 0 && cl2 > 0) {
            const so2 = flow * cl2 * 8.34 * 1.0 * sf;
            const nahso3 = flow * cl2 * 8.34 * 1.46 * sf;
            const na2so3 = flow * cl2 * 8.34 * 0.9 * sf;
            
            document.getElementById('dcl_res').innerText = so2.toFixed(1) + " lbs SOâ‚‚/day";
            const stat = document.getElementById('dcl_status');
            
            stat.innerHTML = "ðŸ“Š <b>Chemical Options (SF=" + sf + "Ã—):</b>" +
                "<br>SOâ‚‚ (gas): <b>" + so2.toFixed(1) + " lbs/day</b>" +
                "<br>NaHSOâ‚ƒ (sodium bisulfite): <b>" + nahso3.toFixed(1) + " lbs/day</b> (" + (nahso3/8.34).toFixed(1) + " gal/day @ SGâ‰ˆ1.0)" +
                "<br>Naâ‚‚SOâ‚ƒ (sodium sulfite): <b>" + na2so3.toFixed(1) + " lbs/day</b>" +
                "<br><br>Neutralizing " + cl2 + " mg/L residual at " + flow + " MGD";
            stat.style.color = "#94a3b8";
        }
    }

    // 36. UV Dose
    function calcUV() {
        const intensity = parseFloat(document.getElementById('uv_int').value) || 0;
        const time = parseFloat(document.getElementById('uv_time').value) || 0;
        const uvt = parseFloat(document.getElementById('uv_uvt').value) || 0;
        
        if (intensity > 0 && time > 0) {
            const dose = intensity * time;
            document.getElementById('uv_res').innerText = dose.toFixed(1) + " mJ/cmÂ²";
            const stat = document.getElementById('uv_status');
            
            let info = "ðŸ“Š UV Dose = " + intensity + " mW/cmÂ² Ã— " + time + " sec = <b>" + dose.toFixed(1) + " mJ/cmÂ²</b>";
            
            if (dose >= 80) info += "<br>âœ“ Adequate for reuse-quality disinfection (â‰¥80 mJ/cmÂ²)";
            else if (dose >= 40) info += "<br>âœ“ Adequate for E. coli/fecal compliance (â‰¥40 mJ/cmÂ²)";
            else if (dose >= 30) info += "<br>âš ï¸ Minimum range â€” may not meet permit during peak flow";
            else info += "<br>ðŸš¨ Below typical TCEQ requirement. Increase intensity or exposure time.";
            
            if (uvt > 0) {
                info += "<br>UVT: <b>" + uvt + "%</b>";
                if (uvt >= 65) info += " â€” âœ“ Good transmittance";
                else if (uvt >= 55) info += " â€” âš ï¸ Marginal. TSS or color may reduce effectiveness.";
                else info += " â€” ðŸš¨ Poor transmittance. Pre-treatment needed.";
            }
            
            stat.innerHTML = info;
            stat.style.color = "#94a3b8";
        }
    }

    // ==================== SLUDGE & BIOSOLIDS CALCULATIONS ====================

    // 37. Sludge Volume & % Solids
    function calcSLV() {
        const vol = parseFloat(document.getElementById('slv_vol').value) || 0;
        const pct = parseFloat(document.getElementById('slv_pct').value) || 0;
        
        if (vol > 0 && pct > 0) {
            const wetLbs = vol * 8.34;
            const dryLbs = wetLbs * (pct / 100);
            const dryTons = dryLbs / 2000;
            const ft3 = vol / 7.48;
            
            document.getElementById('slv_res').innerText = dryLbs.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " dry lbs/day";
            const stat = document.getElementById('slv_status');
            
            stat.innerHTML = "ðŸ“Š <b>Sludge Summary:</b>" +
                "<br>Wet volume: " + vol.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " gal/day (" + ft3.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " ftÂ³)" +
                "<br>Wet weight: " + wetLbs.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs/day (" + (wetLbs/2000).toFixed(2) + " wet tons)" +
                "<br>Dry solids: <b>" + dryLbs.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs/day</b> (" + dryTons.toFixed(2) + " dry tons)" +
                "<br>At " + pct + "% solids | " + (100-pct).toFixed(1) + "% water";
            stat.style.color = "#94a3b8";
        }
    }

    // 38. Volatile Solids Reduction (Van Kleeck)
    function calcVSR() {
        const vsIn = parseFloat(document.getElementById('vsr_in').value) || 0;
        const vsOut = parseFloat(document.getElementById('vsr_out').value) || 0;
        
        if (vsIn > 0 && vsOut > 0 && vsIn > vsOut) {
            const inDec = vsIn / 100;
            const outDec = vsOut / 100;
            const vsr = ((inDec - outDec) / (inDec - (inDec * outDec))) * 100;
            
            document.getElementById('vsr_res').innerText = vsr.toFixed(1) + " %";
            const stat = document.getElementById('vsr_status');
            
            let assessment = "";
            if (vsr >= 50) { assessment = "âœ“ <b>Excellent:</b> Healthy digester performance (â‰¥50%)"; stat.style.color = "#4ade80"; }
            else if (vsr >= 38) { assessment = "âœ“ <b>Meets Class B:</b> â‰¥38% VS reduction (VAR Option 1)"; stat.style.color = "#4ade80"; }
            else { assessment = "ðŸš¨ <b>Below 38%:</b> Does NOT meet Class B vector attraction reduction. Check digester operation."; stat.style.color = "var(--danger)"; }
            
            stat.innerHTML = "ðŸ“Š Van Kleeck VSR: <b>" + vsr.toFixed(1) + "%</b>" +
                "<br>Influent VS: " + vsIn + "% â†’ Effluent VS: " + vsOut + "%" +
                "<br>" + assessment;
        }
    }

    // 39. Digester Loading Rate
    function calcDIG() {
        const flow = parseFloat(document.getElementById('dig_flow').value) || 0;
        const pct = parseFloat(document.getElementById('dig_pct').value) || 0;
        const vs = parseFloat(document.getElementById('dig_vs').value) || 0;
        const vol = parseFloat(document.getElementById('dig_vol').value) || 0;
        
        if (flow > 0 && pct > 0 && vs > 0 && vol > 0) {
            const vsLbs = flow * 8.34 * (pct / 100) * (vs / 100);
            const loading = vsLbs / vol;
            
            document.getElementById('dig_res').innerText = loading.toFixed(3) + " lbs VS/ftÂ³/d";
            const stat = document.getElementById('dig_status');
            
            let assessment = "";
            if (loading <= 0.05) { assessment = "âœ“ Low-rate digester range (0.03â€“0.05)"; stat.style.color = "#4ade80"; }
            else if (loading <= 0.10) { assessment = "âœ“ Moderate loading â€” transitional range"; stat.style.color = "#4ade80"; }
            else if (loading <= 0.20) { assessment = "âœ“ High-rate digester range (0.10â€“0.20)"; stat.style.color = "#4ade80"; }
            else { assessment = "ðŸš¨ <b>Overloaded!</b> Risk of VFA buildup and pH crash. Reduce feed rate."; stat.style.color = "var(--danger)"; }
            
            stat.innerHTML = "ðŸ“Š VS feed: <b>" + vsLbs.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs VS/day</b>" +
                "<br>Loading: <b>" + loading.toFixed(3) + " lbs VS/ftÂ³/day</b>" +
                "<br>HRT: " + (vol * 7.48 / flow).toFixed(0) + " days" +
                "<br>" + assessment;
        }
    }

    // 40. Polymer Dosing
    function calcPoly() {
        const flow = parseFloat(document.getElementById('poly_flow').value) || 0;
        const pct = parseFloat(document.getElementById('poly_pct').value) || 0;
        const rate = parseFloat(document.getElementById('poly_rate').value) || 0;
        const conc = parseFloat(document.getElementById('poly_conc').value) || 0;
        
        if (flow > 0 && pct > 0 && rate > 0 && conc > 0) {
            const activeLbsHr = rate * 8.34 * (conc / 100);
            const activeLbsDay = activeLbsHr * 24;
            const dryTonsDay = (flow * 60 * 8.34 * (pct / 100) * 24) / 2000;
            const lbsPerDT = activeLbsDay / dryTonsDay;
            
            document.getElementById('poly_res').innerText = lbsPerDT.toFixed(1) + " lbs active/DT";
            const stat = document.getElementById('poly_status');
            
            let assessment = "";
            if (lbsPerDT <= 4) { assessment = "âœ“ Low polymer usage â€” cost effective"; stat.style.color = "#4ade80"; }
            else if (lbsPerDT <= 8) { assessment = "âœ“ Typical belt press range (3â€“8 lbs/DT)"; stat.style.color = "#4ade80"; }
            else if (lbsPerDT <= 12) { assessment = "âš ï¸ Typical centrifuge range (5â€“12) â€” high for belt press"; stat.style.color = "var(--accent)"; }
            else { assessment = "ðŸš¨ Excessive polymer. Check conditioning, sludge age, or polymer type."; stat.style.color = "var(--danger)"; }
            
            stat.innerHTML = "ðŸ“Š <b>Polymer Usage:</b>" +
                "<br>Active polymer: " + activeLbsDay.toFixed(1) + " lbs/day (" + activeLbsHr.toFixed(2) + " lbs/hr)" +
                "<br>Dry solids: " + dryTonsDay.toFixed(2) + " DT/day" +
                "<br>Dosage: <b>" + lbsPerDT.toFixed(1) + " lbs active polymer per dry ton</b>" +
                "<br>" + assessment;
        }
    }

    // ==================== NUTRIENT REMOVAL CALCULATIONS ====================

    // 41. Phosphorus Removal
    function calcPhos() {
        const flow = parseFloat(document.getElementById('phos_flow').value) || 0;
        const pIn = parseFloat(document.getElementById('phos_in').value) || 0;
        const pOut = parseFloat(document.getElementById('phos_out').value) || 0;
        const ratio = parseFloat(document.getElementById('phos_ratio').value) || 0;
        
        if (flow > 0 && pIn > pOut && ratio > 0) {
            const deltaP = pIn - pOut;
            // Alum: Al needed = deltaP Ã— ratio Ã— (27/31), then alum = Al Ã— (594/(2Ã—27))
            const alDose = deltaP * ratio * (27/31); // mg/L as Al
            const alumDose = alDose * (594 / 54); // mg/L as alum (Al2(SO4)3Â·14H2O)
            const alumLbs = flow * alumDose * 8.34;
            // Ferric: Fe needed = deltaP Ã— ratio Ã— (55.85/31)
            const feDose = deltaP * ratio * (55.85/31);
            const fecl3Dose = feDose * (162.2/55.85);
            const fecl3Lbs = flow * fecl3Dose * 8.34;
            
            document.getElementById('phos_res').innerText = "Alum: " + alumLbs.toFixed(0) + " | FeClâ‚ƒ: " + fecl3Lbs.toFixed(0) + " lbs/day";
            const stat = document.getElementById('phos_status');
            
            stat.innerHTML = "ðŸ“Š Removing <b>" + deltaP.toFixed(1) + " mg/L P</b> at " + ratio + ":1 molar ratio" +
                "<br><br>ðŸ§ª <b>Alum (Alâ‚‚(SOâ‚„)â‚ƒÂ·14Hâ‚‚O):</b>" +
                "<br>Dose: " + alumDose.toFixed(1) + " mg/L â†’ <b>" + alumLbs.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs/day</b>" +
                " (" + (alumLbs / (8.34 * 1.33)).toFixed(0) + " gal/day @ 48% liquid)" +
                "<br><br>ðŸ§ª <b>Ferric Chloride (FeClâ‚ƒ):</b>" +
                "<br>Dose: " + fecl3Dose.toFixed(1) + " mg/L â†’ <b>" + fecl3Lbs.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs/day</b>" +
                " (" + (fecl3Lbs / (8.34 * 1.42)).toFixed(0) + " gal/day @ 42% liquid)";
            stat.style.color = "#94a3b8";
        }
    }

    // 42. Alkalinity & Nitrification
    function calcALK() {
        const alkIn = parseFloat(document.getElementById('alk_in').value) || 0;
        const nh3 = parseFloat(document.getElementById('alk_nh3').value) || 0;
        const flow = parseFloat(document.getElementById('alk_flow').value) || 0;
        
        if (alkIn > 0 && nh3 > 0) {
            const consumed = nh3 * 7.14;
            const remaining = alkIn - consumed;
            
            document.getElementById('alk_res').innerText = remaining.toFixed(0) + " mg/L remaining";
            const stat = document.getElementById('alk_status');
            
            let assessment = "";
            let supplement = "";
            if (remaining >= 100) { assessment = "âœ“ <b>Adequate alkalinity buffer.</b> No supplement needed."; stat.style.color = "#4ade80"; }
            else if (remaining >= 50) { assessment = "âš ï¸ <b>Low buffer.</b> Monitor pH closely. Consider supplemental alkalinity."; stat.style.color = "var(--accent)"; }
            else {
                assessment = "ðŸš¨ <b>Insufficient alkalinity!</b> Nitrification will crash. Supplement required.";
                stat.style.color = "var(--danger)";
            }
            
            if (remaining < 80 && flow > 0) {
                const deficit = 80 - remaining; // target 80 mg/L remaining
                const limeLbs = flow * deficit * 8.34 / 1.35; // lime effectiveness
                supplement = "<br><br>ðŸ’Š To reach 80 mg/L remaining:" +
                    "<br>Lime (CaO): ~" + limeLbs.toFixed(0) + " lbs/day" +
                    "<br>Soda Ash (Naâ‚‚COâ‚ƒ): ~" + (flow * deficit * 8.34 / 1.06).toFixed(0) + " lbs/day";
            }
            
            stat.innerHTML = "ðŸ“Š Alkalinity consumed: <b>" + consumed.toFixed(0) + " mg/L</b> (from " + nh3 + " mg/L NHâ‚ƒ-N)" +
                "<br>Influent: " + alkIn + " mg/L â†’ Remaining: <b>" + remaining.toFixed(0) + " mg/L</b>" +
                "<br>" + assessment + supplement;
        }
    }

    // 43. Nitrogen Balance
    function calcNBal() {
        const tkn = parseFloat(document.getElementById('nb_tkn').value) || 0;
        const nh3 = parseFloat(document.getElementById('nb_nh3').value) || 0;
        const no3 = parseFloat(document.getElementById('nb_no3').value) || 0;
        const bio = parseFloat(document.getElementById('nb_bio').value) || 0;
        
        if (tkn > 0) {
            const nitrified = tkn - nh3 - bio; // ammonia that was nitrified
            const denitrified = nitrified - no3; // nitrate that was denitrified (removed as N2)
            const effTN = nh3 + no3;
            const removalPct = ((tkn - effTN) / tkn * 100);
            
            document.getElementById('nb_res').innerText = "Eff TN: " + effTN.toFixed(1) + " mg/L | " + removalPct.toFixed(0) + "% removal";
            const stat = document.getElementById('nb_status');
            
            stat.innerHTML = "ðŸ“Š <b>Nitrogen Fate:</b>" +
                "<br>Influent TKN: <b>" + tkn + " mg/L</b>" +
                "<br>â†’ Nitrified (NHâ‚ƒâ†’NOâ‚ƒ): " + Math.max(0, nitrified).toFixed(1) + " mg/L" +
                "<br>â†’ Denitrified (NOâ‚ƒâ†’Nâ‚‚â†‘): <b>" + Math.max(0, denitrified).toFixed(1) + " mg/L</b> (removed as gas)" +
                "<br>â†’ Biomass uptake: " + bio + " mg/L" +
                "<br>â†’ Effluent NHâ‚ƒ: " + nh3 + " mg/L | Effluent NOâ‚ƒ: " + no3 + " mg/L" +
                "<br><br>ðŸ“‹ <b>Effluent TN: " + effTN.toFixed(1) + " mg/L</b> (" + removalPct.toFixed(0) + "% total N removal)" +
                (denitrified < 0 ? "<br>âš ï¸ Negative denitrification â€” check TKN/NOâ‚ƒ values" : "");
            stat.style.color = "#94a3b8";
        }
    }

    // ==================== HYDRAULICS & PUMPING CALCULATIONS ====================

    // 44. Total Dynamic Head
    function calcTDH() {
        const stat_h = parseFloat(document.getElementById('tdh_static').value) || 0;
        const friction = parseFloat(document.getElementById('tdh_friction').value) || 0;
        const vel = parseFloat(document.getElementById('tdh_vel').value) || 0;
        
        const tdh = stat_h + friction + vel;
        if (tdh > 0) {
            const psi = tdh / 2.31;
            document.getElementById('tdh_res').innerText = tdh.toFixed(1) + " ft (" + psi.toFixed(1) + " psi)";
            const stat = document.getElementById('tdh_status');
            
            stat.innerHTML = "ðŸ“Š Static: " + stat_h + " ft + Friction: " + friction + " ft + Velocity: " + vel + " ft" +
                "<br>TDH = <b>" + tdh.toFixed(1) + " ft</b> = <b>" + psi.toFixed(1) + " psi</b> = " + (tdh * 0.3048).toFixed(2) + " m" +
                "<br>Friction is " + (friction / tdh * 100).toFixed(0) + "% of total head";
            stat.style.color = "#94a3b8";
        }
    }

    // 70. Pump HP & Energy Cost
    function calcPumpHP() {
        const flow = parseFloat(document.getElementById('php_flow').value) || 0;
        const tdh = parseFloat(document.getElementById('php_tdh').value) || 0;
        const peff = (parseFloat(document.getElementById('php_peff').value) || 70) / 100;
        const meff = (parseFloat(document.getElementById('php_meff').value) || 90) / 100;
        const hrs = parseFloat(document.getElementById('php_hrs').value) || 24;
        const rate = parseFloat(document.getElementById('php_rate').value) || 0.10;
        
        if (flow > 0 && tdh > 0 && peff > 0 && meff > 0) {
            // Water Horsepower = (GPM Ã— TDH) / 3960
            const whp = (flow * tdh) / 3960;
            // Brake Horsepower = WHP / pump efficiency
            const bhp = whp / peff;
            // Motor Horsepower = BHP / motor efficiency  
            const mhp = bhp / meff;
            // Wire-to-water efficiency
            const wireEff = peff * meff * 100;
            // Power in kW = HP Ã— 0.746
            const kw = mhp * 0.746;
            // Daily energy
            const kwhDay = kw * hrs;
            // Daily cost
            const costDay = kwhDay * rate;
            // Monthly cost
            const costMonth = costDay * 30;
            
            // Next standard motor size
            const stdSizes = [0.5, 0.75, 1, 1.5, 2, 3, 5, 7.5, 10, 15, 20, 25, 30, 40, 50, 60, 75, 100, 125, 150, 200, 250, 300];
            let motorSize = stdSizes.find(s => s >= mhp) || mhp;
            
            document.getElementById('php_res').innerText = bhp.toFixed(2) + " BHP / " + motorSize + " HP Motor";
            const stat = document.getElementById('php_status');
            stat.innerHTML = "âœ“ Water HP: <b>" + whp.toFixed(2) + " WHP</b> | Brake HP: <b>" + bhp.toFixed(2) + " BHP</b>";
            stat.style.color = "#4ade80";
            
            const detail = document.getElementById('php_detail');
            detail.style.display = 'block';
            detail.innerHTML = 
                "<div style='display:grid;grid-template-columns:1fr 1fr;gap:8px;'>" +
                "<div><b>Water HP:</b> " + whp.toFixed(2) + " WHP</div>" +
                "<div><b>Brake HP:</b> " + bhp.toFixed(2) + " BHP</div>" +
                "<div><b>Motor Input:</b> " + mhp.toFixed(2) + " HP</div>" +
                "<div><b>Std Motor Size:</b> " + motorSize + " HP</div>" +
                "<div><b>Wire-to-Water Eff:</b> " + wireEff.toFixed(0) + "%</div>" +
                "<div><b>Power Draw:</b> " + kw.toFixed(2) + " kW</div>" +
                "</div>" +
                "<div style='margin-top:10px;padding:8px;background:rgba(59,130,246,0.15);border-radius:6px;'>" +
                "<b>âš¡ Energy Cost:</b> " + kwhDay.toFixed(1) + " kWh/day = <b>$" + costDay.toFixed(2) + "/day</b> = <b>$" + costMonth.toFixed(0) + "/month</b>" +
                "</div>" +
                "<div style='margin-top:8px;font-size:0.75rem;color:#94a3b8;'>" +
                "ðŸ“ TCEQ: WHP = (GPM Ã— TDH) Ã· 3960 | BHP = WHP Ã· Î·<sub>pump</sub> | 1 HP = 0.746 kW" +
                "</div>";
        } else {
            document.getElementById('php_res').innerText = "â€”";
            document.getElementById('php_status').innerHTML = "Enter flow and TDH...";
            document.getElementById('php_detail').style.display = 'none';
        }
    }

    // 71. Digester Gas Production
    function calcDigesterGas() {
        const flow = parseFloat(document.getElementById('gas_flow').value) || 0;
        const pct = parseFloat(document.getElementById('gas_pct').value) || 0;
        const vs = parseFloat(document.getElementById('gas_vs').value) || 0;
        const vsr = parseFloat(document.getElementById('gas_vsr').value) || 0;
        const yield_rate = parseFloat(document.getElementById('gas_yield').value) || 15;
        const ch4 = parseFloat(document.getElementById('gas_ch4').value) || 65;
        
        if (flow > 0 && pct > 0 && vs > 0 && vsr > 0) {
            // Calculate VS fed per day
            // lbs/day = GPD Ã— 8.34 Ã— %solids Ã— %VS
            const vsFed = flow * 8.34 * (pct/100) * (vs/100);
            
            // VS destroyed per day
            const vsDestroyed = vsFed * (vsr/100);
            
            // Total gas production (ftÂ³/day)
            const totalGas = vsDestroyed * yield_rate;
            
            // Methane production (ftÂ³/day)
            const methane = totalGas * (ch4/100);
            
            // Energy content (BTU/day) - methane is ~1000 BTU/ftÂ³
            const btuDay = methane * 1000;
            
            // Equivalent therms (1 therm = 100,000 BTU)
            const therms = btuDay / 100000;
            
            // Equivalent kWh (1 kWh = 3412 BTU, assuming 30% conversion efficiency for CHP)
            const kwhPotential = (btuDay * 0.30) / 3412;
            
            document.getElementById('gas_res').innerText = totalGas.toFixed(0) + " ftÂ³/day biogas";
            const stat = document.getElementById('gas_status');
            stat.innerHTML = "âœ“ VS destroyed: <b>" + vsDestroyed.toFixed(0) + " lbs/day</b> â†’ <b>" + totalGas.toFixed(0) + " ftÂ³/day</b> biogas";
            stat.style.color = "#4ade80";
            
            const detail = document.getElementById('gas_detail');
            detail.style.display = 'block';
            detail.innerHTML = 
                "<div style='display:grid;grid-template-columns:1fr 1fr;gap:8px;'>" +
                "<div><b>VS Fed:</b> " + vsFed.toFixed(0) + " lbs/day</div>" +
                "<div><b>VS Destroyed:</b> " + vsDestroyed.toFixed(0) + " lbs/day</div>" +
                "<div><b>Total Biogas:</b> " + totalGas.toFixed(0) + " ftÂ³/day</div>" +
                "<div><b>Methane (CHâ‚„):</b> " + methane.toFixed(0) + " ftÂ³/day</div>" +
                "</div>" +
                "<div style='margin-top:10px;padding:8px;background:rgba(168,85,247,0.15);border-radius:6px;'>" +
                "<b>ðŸ”¥ Energy Value:</b> " + (btuDay/1000000).toFixed(2) + " MMBTU/day = " + therms.toFixed(1) + " therms/day" +
                "<br><b>âš¡ CHP Potential:</b> ~" + kwhPotential.toFixed(0) + " kWh/day @ 30% efficiency" +
                "</div>" +
                "<div style='margin-top:8px;font-size:0.75rem;color:#94a3b8;'>" +
                "ðŸ“ Typical: 12-18 ftÂ³ gas per lb VS destroyed | 60-70% CHâ‚„ | ~600 BTU/ftÂ³ biogas" +
                "</div>";
        } else {
            document.getElementById('gas_res').innerText = "â€”";
            document.getElementById('gas_status').innerHTML = "Enter data...";
            document.getElementById('gas_detail').style.display = 'none';
        }
    }

    // 45. Pipe Velocity
    function calcPV() {
        const flow = parseFloat(document.getElementById('pv_flow').value) || 0;
        const dia = parseFloat(document.getElementById('pv_dia').value) || 0;
        
        if (flow > 0 && dia > 0) {
            const area = Math.PI * Math.pow(dia/2, 2); // inÂ²
            const cfs = flow / 448.83;
            const fps = cfs / (area / 144); // convert inÂ² to ftÂ²
            
            document.getElementById('pv_res').innerText = fps.toFixed(2) + " fps";
            const stat = document.getElementById('pv_status');
            
            let assessment = "";
            if (fps < 2) { assessment = "ðŸš¨ <b>Too slow:</b> Solids will settle and accumulate. Increase flow or reduce pipe size."; stat.style.color = "var(--danger)"; }
            else if (fps <= 5) { assessment = "âœ“ <b>Good:</b> Adequate self-cleaning velocity."; stat.style.color = "#4ade80"; }
            else if (fps <= 8) { assessment = "âœ“ <b>Normal range</b> for force mains and pressure pipe."; stat.style.color = "#4ade80"; }
            else if (fps <= 10) { assessment = "âš ï¸ <b>Elevated:</b> Approaching maximum recommended velocity."; stat.style.color = "var(--accent)"; }
            else { assessment = "ðŸš¨ <b>Too fast:</b> Risk of pipe erosion, water hammer, and excessive friction loss."; stat.style.color = "var(--danger)"; }
            
            stat.innerHTML = "ðŸ“Š " + flow + " GPM through " + dia + "\" pipe = <b>" + fps.toFixed(2) + " fps</b>" +
                "<br>Flow: " + cfs.toFixed(3) + " CFS | Pipe area: " + (area/144).toFixed(4) + " ftÂ²" +
                "<br>" + assessment;
        }
    }

    // 46. Horsepower
    function calcHP() {
        const flow = parseFloat(document.getElementById('hp_flow').value) || 0;
        const tdh = parseFloat(document.getElementById('hp_tdh').value) || 0;
        const pEff = parseFloat(document.getElementById('hp_eff').value) || 75;
        const mEff = parseFloat(document.getElementById('hp_meff').value) || 90;
        
        if (flow > 0 && tdh > 0) {
            const whp = (flow * tdh) / 3960;
            const bhp = whp / (pEff / 100);
            const mhp = bhp / (mEff / 100);
            const kw = mhp * 0.746;
            
            document.getElementById('hp_res').innerText = "WHP: " + whp.toFixed(2) + " | BHP: " + bhp.toFixed(2);
            const stat = document.getElementById('hp_status');
            
            stat.innerHTML = "ðŸ“Š <b>Power Chain:</b>" +
                "<br>Water HP: <b>" + whp.toFixed(2) + " HP</b> (theoretical minimum)" +
                "<br>Brake HP: <b>" + bhp.toFixed(2) + " HP</b> (pump " + pEff + "% eff)" +
                "<br>Motor HP: <b>" + mhp.toFixed(2) + " HP</b> (motor " + mEff + "% eff)" +
                "<br>Power draw: <b>" + kw.toFixed(2) + " kW</b>" +
                "<br><br>ðŸ’° Est. energy cost: $" + (kw * 24 * 0.10).toFixed(2) + "/day @ $0.10/kWh (" + (kw * 24 * 30 * 0.10).toFixed(0) + "/month)";
            stat.style.color = "#94a3b8";
        }
    }

    // ==================== COMPLIANCE & REPORTING CALCULATIONS ====================

    // 47. Geometric Mean
    function calcGM() {
        const samples = [];
        for (let i = 1; i <= 7; i++) {
            const v = parseFloat(document.getElementById('gm_s' + i).value);
            if (v > 0) samples.push(v);
        }
        
        if (samples.length >= 2) {
            const logSum = samples.reduce((sum, v) => sum + Math.log(v), 0);
            const geoMean = Math.exp(logSum / samples.length);
            const arithMean = samples.reduce((s, v) => s + v, 0) / samples.length;
            
            document.getElementById('gm_res').innerText = geoMean.toFixed(1) + " CFU/100mL";
            const stat = document.getElementById('gm_status');
            
            let ecoliCheck = "";
            if (geoMean <= 126) ecoliCheck = "<br>âœ“ E. coli: <b>PASS</b> (â‰¤126 CFU/100mL)";
            else ecoliCheck = "<br>ðŸš¨ E. coli: <b>FAIL</b> (>126 CFU/100mL)";
            
            let fecalCheck = "";
            if (geoMean <= 200) fecalCheck = "<br>âœ“ Fecal coliform: <b>PASS</b> (â‰¤200 CFU/100mL)";
            else fecalCheck = "<br>ðŸš¨ Fecal coliform: <b>FAIL</b> (>200 CFU/100mL)";
            
            stat.innerHTML = "ðŸ“Š <b>Geometric Mean: " + geoMean.toFixed(1) + "</b> from " + samples.length + " samples" +
                "<br>Arithmetic mean: " + arithMean.toFixed(1) + " (not used for DMR)" +
                "<br>Values: " + samples.join(", ") +
                ecoliCheck + fecalCheck;
            stat.style.color = "#94a3b8";
        }
    }

    // 48. Flow-Weighted Composite
    function calcFWC() {
        let sumFC = 0, sumF = 0, pairs = 0;
        for (let i = 1; i <= 4; i++) {
            const f = parseFloat(document.getElementById('fw_f' + i).value);
            const c = parseFloat(document.getElementById('fw_c' + i).value);
            if (f > 0 && c >= 0) {
                sumFC += f * c;
                sumF += f;
                pairs++;
            }
        }
        
        if (pairs >= 2 && sumF > 0) {
            const fwAvg = sumFC / sumF;
            document.getElementById('fw_res').innerText = fwAvg.toFixed(2) + " mg/L";
            const stat = document.getElementById('fw_status');
            
            let detail = "";
            for (let i = 1; i <= 4; i++) {
                const f = parseFloat(document.getElementById('fw_f' + i).value);
                const c = parseFloat(document.getElementById('fw_c' + i).value);
                if (f > 0 && c >= 0) {
                    const weight = (f / sumF * 100).toFixed(0);
                    detail += "<br>Sample " + i + ": " + f + " MGD Ã— " + c + " mg/L (weight: " + weight + "%)";
                }
            }
            
            // Arithmetic mean for comparison
            let simpleSum = 0, cnt = 0;
            for (let i = 1; i <= 4; i++) {
                const c = parseFloat(document.getElementById('fw_c' + i).value);
                if (c >= 0 && parseFloat(document.getElementById('fw_f' + i).value) > 0) { simpleSum += c; cnt++; }
            }
            const arith = simpleSum / cnt;
            
            stat.innerHTML = "ðŸ“Š <b>Flow-Weighted Average: " + fwAvg.toFixed(2) + " mg/L</b>" +
                "<br>Simple average: " + arith.toFixed(2) + " mg/L (difference: " + (fwAvg - arith).toFixed(2) + ")" +
                detail +
                "<br><br>Total flow: " + sumF.toFixed(2) + " MGD across " + pairs + " samples";
            stat.style.color = "#94a3b8";
        }
    }

    // ==================== UNIT CONVERTER ====================

    // 49. Unit Converter
    function calcUC(source) {
        const stat = document.getElementById('uc_status');
        
        // Flow conversions
        if (['gpm','mgd','cfs','m3d'].includes(source)) {
            let mgd = 0;
            if (source === 'gpm') mgd = (parseFloat(document.getElementById('uc_gpm').value) || 0) * 0.00144;
            else if (source === 'mgd') mgd = parseFloat(document.getElementById('uc_mgd').value) || 0;
            else if (source === 'cfs') mgd = (parseFloat(document.getElementById('uc_cfs').value) || 0) * 0.6464;
            else if (source === 'm3d') mgd = (parseFloat(document.getElementById('uc_m3d').value) || 0) / 3785.41;
            
            if (source !== 'gpm') document.getElementById('uc_gpm').value = (mgd / 0.00144).toFixed(2);
            if (source !== 'mgd') document.getElementById('uc_mgd').value = mgd.toFixed(6);
            if (source !== 'cfs') document.getElementById('uc_cfs').value = (mgd / 0.6464).toFixed(4);
            if (source !== 'm3d') document.getElementById('uc_m3d').value = (mgd * 3785.41).toFixed(2);
            stat.innerHTML = "âœ“ Flow converted";
        }
        
        // Volume conversions
        if (['gal','ft3','m3','acft'].includes(source)) {
            let gal = 0;
            if (source === 'gal') gal = parseFloat(document.getElementById('uc_gal').value) || 0;
            else if (source === 'ft3') gal = (parseFloat(document.getElementById('uc_ft3').value) || 0) * 7.48052;
            else if (source === 'm3') gal = (parseFloat(document.getElementById('uc_m3').value) || 0) * 264.172;
            else if (source === 'acft') gal = (parseFloat(document.getElementById('uc_acft').value) || 0) * 325851;
            
            if (source !== 'gal') document.getElementById('uc_gal').value = gal.toFixed(2);
            if (source !== 'ft3') document.getElementById('uc_ft3').value = (gal / 7.48052).toFixed(2);
            if (source !== 'm3') document.getElementById('uc_m3').value = (gal / 264.172).toFixed(4);
            if (source !== 'acft') document.getElementById('uc_acft').value = (gal / 325851).toFixed(6);
            stat.innerHTML = "âœ“ Volume converted";
        }
        
        // Pressure conversions
        if (['psi','fth2o','kpa'].includes(source)) {
            let psi = 0;
            if (source === 'psi') psi = parseFloat(document.getElementById('uc_psi').value) || 0;
            else if (source === 'fth2o') psi = (parseFloat(document.getElementById('uc_fth2o').value) || 0) / 2.31;
            else if (source === 'kpa') psi = (parseFloat(document.getElementById('uc_kpa').value) || 0) / 6.895;
            
            if (source !== 'psi') document.getElementById('uc_psi').value = psi.toFixed(4);
            if (source !== 'fth2o') document.getElementById('uc_fth2o').value = (psi * 2.31).toFixed(4);
            if (source !== 'kpa') document.getElementById('uc_kpa').value = (psi * 6.895).toFixed(4);
            stat.innerHTML = "âœ“ Pressure converted";
        }
        
        stat.style.color = "#4ade80";
    }

    // ==================== COLLECTION SYSTEMS CALCULATIONS ====================

    // 50. Manning's Equation
    function calcManning() {
        const dia = parseFloat(document.getElementById('man_dia').value) || 0;
        const slope = parseFloat(document.getElementById('man_slope').value) || 0;
        const n = parseFloat(document.getElementById('man_n').value) || 0;
        
        if (dia > 0 && slope > 0 && n > 0) {
            const dFt = dia / 12;
            const area = Math.PI * Math.pow(dFt/2, 2);
            const r = dFt / 4; // hydraulic radius for full pipe
            const vel = (1.486 / n) * Math.pow(r, 2/3) * Math.pow(slope, 1/2);
            const qCFS = vel * area;
            const qGPM = qCFS * 448.83;
            const qMGD = qGPM * 0.00144;
            
            document.getElementById('man_res').innerText = qGPM.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPM";
            const stat = document.getElementById('man_status');
            
            let velCheck = "";
            if (vel < 2) velCheck = "ðŸš¨ <b>Below 2 fps:</b> Solids will deposit. Increase slope or reduce pipe size.";
            else if (vel <= 10) velCheck = "âœ“ Velocity in acceptable range (2â€“10 fps)";
            else velCheck = "âš ï¸ >10 fps: Risk of erosion and wear on pipe joints";
            
            stat.innerHTML = "ðŸ“Š <b>Full Pipe Capacity:</b>" +
                "<br>Velocity: <b>" + vel.toFixed(2) + " fps</b>" +
                "<br>Flow: <b>" + qGPM.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPM</b> | " + qCFS.toFixed(2) + " CFS | " + qMGD.toFixed(3) + " MGD" +
                "<br>" + dia + "\" pipe | Slope: " + slope + " ft/ft (" + (slope*100).toFixed(2) + "%) | n=" + n +
                "<br>" + velCheck;
            stat.style.color = "#94a3b8";
        }
    }

    // 51. Wet Well Sizing
    function calcWetWell() {
        const pump = parseFloat(document.getElementById('ww_pump').value) || 0;
        const inflow = parseFloat(document.getElementById('ww_inflow').value) || 0;
        const cycle = parseFloat(document.getElementById('ww_cycle').value) || 0;
        
        if (pump > 0 && cycle > 0) {
            const vol = (cycle * pump) / 4; // standard formula for constant speed pump
            const fillTime = inflow > 0 ? vol / inflow : 0;
            const pumpDown = (pump - inflow) > 0 ? vol / (pump - inflow) : 0;
            
            document.getElementById('ww_res').innerText = vol.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " gallons";
            const stat = document.getElementById('ww_status');
            
            let info = "ðŸ“Š <b>Required Wet Well Volume: " + vol.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " gal</b> (" + (vol/7.48).toFixed(1) + " ftÂ³)" +
                "<br>Minimum cycle time: " + cycle + " min | Pump: " + pump + " GPM";
            
            if (inflow > 0) {
                info += "<br>Fill time: " + fillTime.toFixed(1) + " min | Pump-down: " + pumpDown.toFixed(1) + " min";
                if (inflow >= pump) {
                    info += "<br>ðŸš¨ <b>Inflow â‰¥ pump capacity!</b> Pump cannot keep up. Need larger pump or additional pump.";
                } else {
                    const dutyCycle = (inflow / pump * 100).toFixed(0);
                    info += "<br>Pump duty cycle: " + dutyCycle + "% (run time Ã· total cycle)";
                }
            }
            
            if (cycle < 10) info += "<br>âš ï¸ Cycle time <10 min â€” risk of motor overheating and seal wear";
            else info += "<br>âœ“ Cycle time â‰¥10 min â€” within manufacturer recommendations";
            
            stat.innerHTML = info;
            stat.style.color = "#94a3b8";
        }
    }

    // 52. Infiltration & Inflow
    function calcII() {
        const wet = parseFloat(document.getElementById('ii_wet').value) || 0;
        const dry = parseFloat(document.getElementById('ii_dry').value) || 0;
        const dia = parseFloat(document.getElementById('ii_dia').value) || 0;
        const miles = parseFloat(document.getElementById('ii_miles').value) || 0;
        
        if (wet > 0 && dry > 0 && dia > 0 && miles > 0) {
            const ii = (wet - dry) / (dia * miles);
            const iiTotal = wet - dry;
            const pctIncrease = ((wet - dry) / dry * 100);
            
            document.getElementById('ii_res').innerText = ii.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPD/inch-mile";
            const stat = document.getElementById('ii_status');
            
            let assessment = "";
            if (ii <= 250) { assessment = "âœ“ <b>Low I/I:</b> Well-maintained system"; stat.style.color = "#4ade80"; }
            else if (ii <= 500) { assessment = "âœ“ <b>Acceptable:</b> Within typical TCEQ guidance"; stat.style.color = "#4ade80"; }
            else if (ii <= 1000) { assessment = "âš ï¸ <b>Elevated:</b> Rehabilitation recommended. TCEQ may require SSES."; stat.style.color = "var(--accent)"; }
            else { assessment = "ðŸš¨ <b>Excessive I/I:</b> Immediate investigation required. System is a regulatory risk."; stat.style.color = "var(--danger)"; }
            
            stat.innerHTML = "ðŸ“Š Total I/I: <b>" + iiTotal.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPD</b> (" + pctIncrease.toFixed(0) + "% increase over dry weather)" +
                "<br>Rate: <b>" + ii.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPD/inch-mile</b>" +
                "<br>" + dia + "\" pipe | " + miles + " miles | Wet: " + (wet/1000).toFixed(0) + "k GPD | Dry: " + (dry/1000).toFixed(0) + "k GPD" +
                "<br>" + assessment;
        }
    }

    // 53. Force Main Friction Loss (Hazen-Williams)
    function calcHazen() {
        const flow = parseFloat(document.getElementById('hz_flow').value) || 0;
        const c = parseFloat(document.getElementById('hz_c').value) || 0;
        const dia = parseFloat(document.getElementById('hz_dia').value) || 0;
        const len = parseFloat(document.getElementById('hz_len').value) || 0;
        
        if (flow > 0 && c > 0 && dia > 0 && len > 0) {
            // Hazen-Williams: hf/L = (4.52 Ã— Q^1.85) / (C^1.85 Ã— D^4.87) where Q in GPM, D in inches
            const hfPer100 = (4.52 * Math.pow(flow, 1.85)) / (Math.pow(c, 1.85) * Math.pow(dia, 4.87));
            const totalHf = hfPer100 * (len / 1); // hfPer100 is already per foot, multiply by length
            // Actually the formula gives hf in ft per ft of pipe
            // Let me recalculate: standard form gives ft headloss per ft of pipe
            const totalLoss = hfPer100 * len;
            
            document.getElementById('hz_res').innerText = totalLoss.toFixed(2) + " ft loss";
            const stat = document.getElementById('hz_status');
            
            const vel = flow * 0.4085 / (dia * dia);
            const lossPsi = totalLoss / 2.31;
            
            stat.innerHTML = "ðŸ“Š <b>Friction Loss: " + totalLoss.toFixed(2) + " ft</b> (" + lossPsi.toFixed(2) + " psi)" +
                "<br>Loss rate: " + (hfPer100 * 100).toFixed(2) + " ft per 100 ft of pipe" +
                "<br>Velocity: " + vel.toFixed(2) + " fps | C=" + c + " | " + dia + "\" Ã— " + len.toFixed(0) + " ft" +
                "<br><br>ðŸ’¡ Add 10â€“15% for fittings: ~" + (totalLoss * 1.15).toFixed(2) + " ft total estimated";
            stat.style.color = "#94a3b8";
        }
    }

    // ==================== FLOW MEASUREMENT CALCULATIONS ====================

    // 54. Weir Flow
    function calcWeir() {
        const type = document.getElementById('weir_type').value;
        const h = parseFloat(document.getElementById('weir_h').value) || 0;
        const l = parseFloat(document.getElementById('weir_l').value) || 0;
        
        if (h > 0) {
            let qCFS = 0;
            let formula = "";
            
            if (type === 'rect' && l > 0) {
                qCFS = 3.33 * l * Math.pow(h, 1.5);
                formula = "Q = 3.33 Ã— " + l + " Ã— " + h + "^1.5 (suppressed)";
            } else if (type === 'rect_c' && l > 0) {
                const lEff = l - (0.2 * h);
                qCFS = 3.33 * lEff * Math.pow(h, 1.5);
                formula = "Q = 3.33 Ã— (" + l + " âˆ’ 0.2Ã—" + h + ") Ã— " + h + "^1.5 (contracted)";
            } else if (type === 'vnot') {
                qCFS = 2.5 * Math.pow(h, 2.5);
                formula = "Q = 2.5 Ã— " + h + "^2.5 (90Â° V-notch)";
            } else if (type === 'cip' && l > 0) {
                qCFS = 3.367 * l * Math.pow(h, 1.5);
                formula = "Q = 3.367 Ã— " + l + " Ã— " + h + "^1.5 (Cipolletti)";
            } else {
                return;
            }
            
            const qGPM = qCFS * 448.83;
            const qMGD = qGPM * 0.00144;
            
            document.getElementById('weir_res').innerText = qGPM.toFixed(1) + " GPM (" + qMGD.toFixed(4) + " MGD)";
            const stat = document.getElementById('weir_status');
            
            stat.innerHTML = "ðŸ“Š " + formula +
                "<br>Flow: <b>" + qCFS.toFixed(3) + " CFS</b> | " + qGPM.toFixed(1) + " GPM | " + qMGD.toFixed(4) + " MGD" +
                "<br>Head: " + h + " ft (" + (h*12).toFixed(1) + " inches)";
            stat.style.color = "#94a3b8";
        }
    }

    // 55. Area-Velocity Flow
    function calcAV() {
        const type = document.getElementById('av_type').value;
        const vel = parseFloat(document.getElementById('av_vel').value) || 0;
        const dim1 = parseFloat(document.getElementById('av_dim1').value) || 0;
        const dim2 = parseFloat(document.getElementById('av_dim2').value) || 0;
        
        if (vel > 0 && dim1 > 0) {
            let area = 0;
            let desc = "";
            
            if (type === 'pipe') {
                const dFt = dim1 / 12;
                area = Math.PI * Math.pow(dFt/2, 2);
                desc = dim1 + "\" pipe (full) | Area: " + area.toFixed(4) + " ftÂ²";
            } else if (type === 'rect' && dim2 > 0) {
                area = dim1 * dim2;
                desc = dim1 + " ft wide Ã— " + dim2 + " ft deep | Area: " + area.toFixed(2) + " ftÂ²";
            } else {
                return;
            }
            
            const qCFS = area * vel;
            const qGPM = qCFS * 448.83;
            const qMGD = qGPM * 0.00144;
            
            document.getElementById('av_res').innerText = qGPM.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPM";
            const stat = document.getElementById('av_status');
            
            stat.innerHTML = "ðŸ“Š Q = A Ã— V = " + area.toFixed(4) + " ftÂ² Ã— " + vel + " fps" +
                "<br>Flow: <b>" + qCFS.toFixed(2) + " CFS</b> | " + qGPM.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPM | " + qMGD.toFixed(4) + " MGD" +
                "<br>" + desc;
            stat.style.color = "#94a3b8";
        }
    }

    // ==================== TRICKLING FILTER CALCULATIONS ====================

    // 56. NRC Equation
    function calcNRC() {
        const bod = parseFloat(document.getElementById('nrc_bod').value) || 0;
        const vol = parseFloat(document.getElementById('nrc_vol').value) || 0;
        const recirc = parseFloat(document.getElementById('nrc_recirc').value) || 0;
        
        if (bod > 0 && vol > 0) {
            const f = Math.pow(1 + recirc, 2) / Math.pow(1 + 0.1 * recirc, 2); // recirculation factor
            // NRC: E = 1 / (1 + 0.4432 * sqrt(W/(V*F)))
            const e = 1 / (1 + 0.4432 * Math.sqrt(bod / (vol * f)));
            const ePct = e * 100;
            const effBOD = (1 - e) * (bod / (vol > 0 ? 1 : 1)); // This needs influent BOD concentration
            
            document.getElementById('nrc_res').innerText = ePct.toFixed(1) + "% efficiency";
            const stat = document.getElementById('nrc_status');
            
            let assessment = "";
            if (ePct >= 85) assessment = "âœ“ <b>Excellent:</b> High efficiency â€” well within design";
            else if (ePct >= 65) assessment = "âœ“ <b>Typical:</b> Normal TF performance range";
            else if (ePct >= 50) assessment = "âš ï¸ <b>Low:</b> May need increased recirculation or reduced loading";
            else assessment = "ðŸš¨ <b>Poor:</b> Filter is overloaded. Reduce loading or add recirculation.";
            
            stat.innerHTML = "ðŸ“Š NRC Efficiency: <b>" + ePct.toFixed(1) + "%</b>" +
                "<br>BOD loading: " + bod + " lbs/day | Volume: " + vol + " Ã— 1000 ftÂ³" +
                "<br>Recirculation factor (F): " + f.toFixed(2) + " (R=" + recirc + ")" +
                "<br>" + assessment;
            stat.style.color = "#94a3b8";
        }
    }

    // 57. TF Hydraulic Loading
    function calcTFL() {
        const flow = parseFloat(document.getElementById('tfl_flow').value) || 0;
        const dia = parseFloat(document.getElementById('tfl_dia').value) || 0;
        const bod = parseFloat(document.getElementById('tfl_bod').value) || 0;
        const depth = parseFloat(document.getElementById('tfl_depth').value) || 0;
        
        if (flow > 0 && dia > 0) {
            const area = Math.PI * Math.pow(dia/2, 2);
            const flowGPD = flow * 1000000;
            const hydLoad = flowGPD / area;
            
            document.getElementById('tfl_res').innerText = hydLoad.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPD/ftÂ²";
            const stat = document.getElementById('tfl_status');
            
            let classification = "";
            if (hydLoad <= 100) classification = "ðŸ“— <b>Low-rate</b> (25â€“100 GPD/ftÂ²) â€” nitrification possible, no recirc needed";
            else if (hydLoad <= 300) classification = "ðŸ“˜ <b>Standard-rate</b> (100â€“300 GPD/ftÂ²) â€” good BOD removal with recirc";
            else if (hydLoad <= 1000) classification = "ðŸ“™ <b>High-rate</b> (300â€“1000 GPD/ftÂ²) â€” BOD removal, recirc required";
            else classification = "ðŸ“• <b>Super-high-rate</b> (>1000 GPD/ftÂ²) â€” roughing filter only";
            
            let orgInfo = "";
            if (bod > 0 && depth > 0) {
                const vol1000 = (area * depth) / 1000;
                const orgLoad = (flow * bod * 8.34) / vol1000;
                orgInfo = "<br>Organic loading: <b>" + orgLoad.toFixed(1) + " lbs BOD/1000 ftÂ³/day</b>";
                if (orgLoad <= 15) orgInfo += " â€” Low-rate range";
                else if (orgLoad <= 30) orgInfo += " â€” Standard range";
                else if (orgLoad <= 100) orgInfo += " â€” High-rate range";
                else orgInfo += " â€” âš ï¸ Very high loading";
            }
            
            stat.innerHTML = "ðŸ“Š Hydraulic loading: <b>" + hydLoad.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPD/ftÂ²</b>" +
                "<br>Filter: " + dia + " ft diameter | Area: " + area.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " ftÂ²" +
                orgInfo +
                "<br>" + classification;
            stat.style.color = "#94a3b8";
        }
    }

    // ==================== LAGOON CALCULATIONS ====================

    // 58. Pond BOD Loading
    function calcPond() {
        const flow = parseFloat(document.getElementById('pnd_flow').value) || 0;
        const bod = parseFloat(document.getElementById('pnd_bod').value) || 0;
        const acres = parseFloat(document.getElementById('pnd_acres').value) || 0;
        const depth = parseFloat(document.getElementById('pnd_depth').value) || 0;
        
        if (flow > 0 && bod > 0 && acres > 0) {
            const lbsBOD = flow * bod * 8.34;
            const loading = lbsBOD / acres;
            
            document.getElementById('pnd_res').innerText = loading.toFixed(1) + " lbs BOD/acre/day";
            const stat = document.getElementById('pnd_status');
            
            let assessment = "";
            if (loading <= 35) { assessment = "âœ“ <b>Conservative:</b> Well within Texas climate limits"; stat.style.color = "#4ade80"; }
            else if (loading <= 50) { assessment = "âœ“ <b>Normal:</b> Typical facultative pond range for Texas (35â€“50)"; stat.style.color = "#4ade80"; }
            else if (loading <= 80) { assessment = "âš ï¸ <b>Elevated:</b> May develop odor issues. Consider aeration."; stat.style.color = "var(--accent)"; }
            else { assessment = "ðŸš¨ <b>Overloaded:</b> Anaerobic conditions likely. Odor complaints and TCEQ violations."; stat.style.color = "var(--danger)"; }
            
            let hrtInfo = "";
            if (depth > 0) {
                const volGal = acres * 43560 * depth * 7.48;
                const hrt = volGal / (flow * 1000000);
                hrtInfo = "<br>Pond volume: " + (volGal/1000000).toFixed(2) + " MG | HRT: <b>" + hrt.toFixed(0) + " days</b>";
                if (hrt < 90) hrtInfo += " â€” âš ï¸ Short HRT. Risk of short-circuiting.";
                else if (hrt <= 180) hrtInfo += " â€” âœ“ Typical range (90â€“180 days)";
                else hrtInfo += " â€” Long retention â€” good treatment buffer";
            }
            
            stat.innerHTML = "ðŸ“Š BOD load: " + lbsBOD.toFixed(0) + " lbs/day on " + acres + " acres" +
                "<br>Loading: <b>" + loading.toFixed(1) + " lbs BOD/acre/day</b>" +
                hrtInfo +
                "<br>" + assessment;
        }
    }

    // ==================== AERATION CALCULATIONS ====================

    // 59. SOTR to AOTR
    function calcAOTR() {
        const sotr = parseFloat(document.getElementById('ao_sotr').value) || 0;
        const alpha = parseFloat(document.getElementById('ao_alpha').value) || 0;
        const beta = parseFloat(document.getElementById('ao_beta').value) || 0;
        const temp = parseFloat(document.getElementById('ao_temp').value) || 0;
        const dO = parseFloat(document.getElementById('ao_do').value) || 0;
        const alt = parseFloat(document.getElementById('ao_alt').value) || 0;
        
        if (sotr > 0 && alpha > 0 && beta > 0) {
            const theta = 1.024;
            const cs20 = 9.09; // DO saturation at 20Â°C, sea level
            
            // Temperature correction for saturation
            // Approximate CS at different temps
            const csTemp = 14.62 - (0.3898 * temp) + (0.006969 * temp * temp) - (0.00005896 * temp * temp * temp);
            
            // Altitude correction (approx: reduce 3.5% per 1000 ft)
            const altFactor = 1 - (alt * 0.000035);
            const csAlt = csTemp * altFactor;
            
            // AOTR = SOTR Ã— alpha Ã— [(beta Ã— CS_alt Ã— theta^(T-20) - DO) / CS_20]
            const tempFactor = Math.pow(theta, temp - 20);
            const aotr = sotr * alpha * ((beta * csAlt * tempFactor - dO) / cs20);
            const ratio = (aotr / sotr * 100);
            
            document.getElementById('ao_res').innerText = aotr.toFixed(1) + " lbs Oâ‚‚/hr AOTR";
            const stat = document.getElementById('ao_status');
            
            stat.innerHTML = "ðŸ“Š <b>SOTR: " + sotr + " â†’ AOTR: " + aotr.toFixed(1) + " lbs Oâ‚‚/hr</b>" +
                "<br>Actual is <b>" + ratio.toFixed(0) + "%</b> of standard â€” you need " + (100/ratio*100).toFixed(0) + "% more blower capacity than theoretical" +
                "<br><br>ðŸ“‹ <b>Correction Factors:</b>" +
                "<br>Î± (wastewater): " + alpha + " | Î² (salinity): " + beta +
                "<br>CS at " + temp + "Â°C: " + csAlt.toFixed(2) + " mg/L (alt-corrected) | Operating DO: " + dO + " mg/L" +
                "<br>Î¸^(T-20): " + tempFactor.toFixed(3) + " | Altitude factor: " + altFactor.toFixed(4);
            stat.style.color = "#94a3b8";
        }
    }

    // ==================== RECEIVING WATER CALCULATIONS ====================

    // 60. Dilution / Mixing Zone
    function calcDilute() {
        const eFlow = parseFloat(document.getElementById('dil_eflow').value) || 0;
        const eConc = parseFloat(document.getElementById('dil_econc').value) || 0;
        const sFlow = parseFloat(document.getElementById('dil_sflow').value) || 0;
        const sConc = parseFloat(document.getElementById('dil_sconc').value) || 0;
        
        if (eFlow > 0 && sFlow > 0) {
            const mixConc = ((eFlow * eConc) + (sFlow * sConc)) / (eFlow + sFlow);
            const dilRatio = sFlow / eFlow;
            const pctReduction = ((eConc - mixConc) / eConc * 100);
            
            document.getElementById('dil_res').innerText = mixConc.toFixed(2) + " mg/L downstream";
            const stat = document.getElementById('dil_status');
            
            stat.innerHTML = "ðŸ“Š <b>Mixed Concentration: " + mixConc.toFixed(2) + " mg/L</b>" +
                "<br>Effluent: " + eFlow + " MGD Ã— " + eConc + " mg/L" +
                "<br>Stream: " + sFlow + " MGD Ã— " + sConc + " mg/L" +
                "<br>Combined flow: " + (eFlow + sFlow).toFixed(2) + " MGD" +
                "<br><br>Dilution ratio: <b>" + dilRatio.toFixed(1) + ":1</b> (stream:effluent)" +
                "<br>Concentration reduced <b>" + pctReduction.toFixed(1) + "%</b> from effluent to downstream";
            stat.style.color = "#94a3b8";
        }
    }

    // ==================== POPULATION CALCULATIONS ====================

    // 61. Population Equivalent (Enhanced v2)
    function calcPE() {
        const flow = parseFloat(document.getElementById('pe_flow').value) || 0;
        const bod = parseFloat(document.getElementById('pe_bod').value) || 0;
        const tss = parseFloat(document.getElementById('pe_tss').value) || 0;
        const tkn = parseFloat(document.getElementById('pe_tkn').value) || 0;
        const pop = parseFloat(document.getElementById('pe_pop').value) || 0;
        const permit = parseFloat(document.getElementById('pe_permit').value) || 0;
        const growth = parseFloat(document.getElementById('pe_growth').value) || 0;
        const peak = parseFloat(document.getElementById('pe_peak').value) || 0;
        
        if (flow <= 0) return;
        
        const flowGPD = flow * 1000000;
        const peFlow = flowGPD / 100;
        const lbsBOD = flow * bod * 8.34;
        const peBOD = bod > 0 ? lbsBOD / 0.17 : 0;
        const lbsTSS = flow * tss * 8.34;
        const peTSS = tss > 0 ? lbsTSS / 0.20 : 0;
        const lbsTKN = flow * tkn * 8.34;
        const peTKN = tkn > 0 ? lbsTKN / 0.03 : 0;
        
        // Governing PE (highest)
        const peValues = [{val: peFlow, label: 'Flow', color: '#3b82f6'}];
        if (peBOD > 0) peValues.push({val: peBOD, label: 'BOD', color: '#f59e0b'});
        if (peTSS > 0) peValues.push({val: peTSS, label: 'TSS', color: '#8b5cf6'});
        if (peTKN > 0) peValues.push({val: peTKN, label: 'TKN', color: '#10b981'});
        const governing = peValues.reduce((max, pe) => pe.val > max.val ? pe : max, peValues[0]);
        const eduGoverning = governing.val / 3.5;
        
        document.getElementById('pe_res').innerText = "Governing PE: " + Math.round(governing.val).toLocaleString() + " (" + governing.label + ") | " + Math.round(eduGoverning).toLocaleString() + " EDU";
        const stat = document.getElementById('pe_status');
        
        // ===== PE COMPARISON GAUGES =====
        const maxPE = Math.max(peFlow, peBOD, peTSS, peTKN) * 1.15;
        let info = "<div style='margin-bottom:8px'><b>Population Equivalent Comparison:</b></div>";
        
        peValues.forEach(function(pe) {
            const pct = (pe.val / maxPE * 100).toFixed(0);
            const isGov = pe.label === governing.label;
            info += "<div style='display:flex;align-items:center;margin:4px 0;gap:8px'>" +
                "<span style='width:36px;font-size:0.75rem;color:" + pe.color + ";font-weight:bold'>" + pe.label + "</span>" +
                "<div style='flex:1;background:#1e293b;border-radius:4px;height:18px;position:relative;overflow:hidden'>" +
                "<div style='background:" + pe.color + ";height:100%;width:" + pct + "%;border-radius:4px;transition:width 0.3s'></div>" +
                "<span style='position:absolute;right:6px;top:0;line-height:18px;font-size:0.65rem;font-weight:bold;color:#f8fafc'>" + Math.round(pe.val).toLocaleString() + " PE</span>" +
                "</div>" +
                (isGov ? "<span style='font-size:0.65rem;background:#d946ef;color:#fff;padding:1px 5px;border-radius:3px;font-weight:bold'>GOV</span>" : "<span style='width:30px'></span>") +
                "</div>";
        });
        
        // EDU conversion
        info += "<div style='margin-top:6px;padding:6px 8px;background:rgba(217,70,239,0.1);border-radius:4px;font-size:0.8rem'>" +
            "<b>EDU (3.5 persons/unit):</b> " + Math.round(eduGoverning).toLocaleString() + " equivalent dwelling units" +
            "</div>";
        
        // ===== WASTEWATER CHARACTER =====
        if (bod > 0 || tss > 0) {
            info += "<br><b>Wastewater Character Analysis:</b>";
            
            // Industrial vs Domestic split estimate
            if (peBOD > 0) {
                const domesticPE = peFlow; // flow-based = domestic baseline
                const industrialPE = Math.max(0, peBOD - domesticPE);
                const industrialPct = (industrialPE / peBOD * 100);
                const domesticPct = 100 - industrialPct;
                
                if (industrialPct > 5) {
                    info += "<br><div style='margin:4px 0'>" +
                        "<span style='font-size:0.75rem'>Estimated Load Split:</span>" +
                        "<div style='display:flex;height:14px;border-radius:4px;overflow:hidden;margin:3px 0'>" +
                        "<div style='background:#4ade80;width:" + domesticPct.toFixed(0) + "%;display:flex;align-items:center;justify-content:center;font-size:0.6rem;font-weight:bold;color:#0f172a'>" + domesticPct.toFixed(0) + "% Dom</div>" +
                        "<div style='background:#f59e0b;width:" + industrialPct.toFixed(0) + "%;display:flex;align-items:center;justify-content:center;font-size:0.6rem;font-weight:bold;color:#0f172a'>" + industrialPct.toFixed(0) + "% Ind</div>" +
                        "</div>" +
                        "<span style='font-size:0.7rem;color:#94a3b8'>Industrial BOD contribution: ~" + Math.round(industrialPE * 0.17).toLocaleString() + " lbs/day (" + Math.round(industrialPE).toLocaleString() + " PE)</span>" +
                        "</div>";
                } else {
                    info += "<br>Predominantly domestic wastewater (&lt;5% industrial BOD)";
                }
            }
            
            // Ratios
            if (tss > 0 && bod > 0) {
                const btsRatio = bod / tss;
                info += "<br>BOD:TSS = <b>" + btsRatio.toFixed(2) + "</b>";
                if (btsRatio > 1.2) info += " (high organic strength &mdash; food processing/industrial?)";
                else if (btsRatio >= 0.7) info += " (typical domestic: 0.7&ndash;1.2)";
                else info += " (high inerts &mdash; construction runoff, sandy I/I?)";
            }
            if (tkn > 0 && bod > 0) {
                const tknBod = tkn / bod;
                info += "<br>TKN:BOD = <b>" + tknBod.toFixed(2) + "</b>";
                if (tknBod > 0.25) info += " (nitrogen-rich &mdash; septic hauling, food waste?)";
                else if (tknBod >= 0.12) info += " (typical domestic: 0.12&ndash;0.25)";
                else info += " (low nitrogen &mdash; industrial dilution)";
            }
            
            // Strength classification
            info += "<br>Strength: ";
            if (bod < 100) info += "<span style='color:#60a5fa'><b>Weak</b></span> (&lt;100 mg/L)";
            else if (bod <= 200) info += "<span style='color:#4ade80'><b>Medium</b></span> (100&ndash;200)";
            else if (bod <= 300) info += "<span style='color:#fbbf24'><b>Strong</b></span> (200&ndash;300)";
            else info += "<span style='color:#ef4444'><b>Very Strong</b></span> (&gt;300 mg/L)";
        }
        
        // ===== PER CAPITA + VISUAL BARS =====
        if (pop > 0) {
            const perCapFlow = flowGPD / pop;
            const perCapBOD = bod > 0 ? lbsBOD / pop : 0;
            const perCapTSS = tss > 0 ? lbsTSS / pop : 0;
            const perCapTKN = tkn > 0 ? lbsTKN / pop : 0;
            
            info += "<br><br><b>Per Capita Loading (pop: " + Math.round(pop).toLocaleString() + "):</b>";
            
            var metrics = [
                {label:'Flow', val: perCapFlow, std: 100, unit: 'GPD', dec: 0},
                {label:'BOD', val: perCapBOD, std: 0.17, unit: 'lbs', dec: 3},
                {label:'TSS', val: perCapTSS, std: 0.20, unit: 'lbs', dec: 3},
                {label:'TKN', val: perCapTKN, std: 0.03, unit: 'lbs', dec: 4}
            ];
            
            metrics.forEach(function(m) {
                if (m.val <= 0) return;
                var pct = Math.min((m.val / m.std) * 100, 150);
                var ratio = m.val / m.std;
                var barColor = ratio > 1.3 ? 'var(--accent)' : ratio < 0.7 ? '#3b82f6' : '#4ade80';
                info += "<div style='display:flex;align-items:center;gap:6px;margin:3px 0'>" +
                    "<span style='width:32px;font-size:0.7rem;font-weight:bold;color:#94a3b8'>" + m.label + "</span>" +
                    "<div style='flex:1;background:#1e293b;border-radius:4px;height:10px;position:relative'>" +
                    "<div style='position:absolute;left:" + Math.min(100/1.5, 66.7) + "%;top:0;bottom:0;width:1px;background:#94a3b8;opacity:0.5'></div>" +
                    "<div style='background:" + barColor + ";height:100%;border-radius:4px;width:" + Math.min(pct/1.5, 100) + "%'></div>" +
                    "</div>" +
                    "<span style='width:90px;font-size:0.7rem;text-align:right'><b>" + m.val.toFixed(m.dec) + "</b> " + m.unit + " <span style='color:#64748b'>(" + m.std + ")</span></span>" +
                    "</div>";
            });
            info += "<span style='font-size:0.65rem;color:#475569'>Vertical line = per capita standard | Green = normal | Yellow = elevated | Blue = low</span>";
        }
        
        // ===== PEAKING FACTOR DESIGN =====
        if (peak > 0) {
            const peakFlow = flow * peak;
            const peakGPD = flowGPD * peak;
            const peakPE = peakGPD / 100;
            
            info += "<br><br><b>Peaking Factor Design (PF: " + peak + "):</b>";
            info += "<br>Average flow: " + flow.toFixed(3) + " MGD | Peak flow: <b>" + peakFlow.toFixed(3) + " MGD</b>";
            info += "<br>Peak PE: <b>" + Math.round(peakPE).toLocaleString() + "</b> | Peak EDU: <b>" + Math.round(peakPE/3.5).toLocaleString() + "</b>";
            
            if (permit > 0) {
                const peakCapPct = (peakFlow / permit * 100);
                info += "<br>Peak vs permitted: <b>" + peakCapPct.toFixed(0) + "%</b>";
                if (peakCapPct > 100) info += " <span style='color:var(--danger)'>&#128680; PEAK EXCEEDS PERMITTED CAPACITY</span>";
                else if (peakCapPct > 85) info += " <span style='color:var(--accent)'>&#9888;&#65039; Peak near permit limit</span>";
                else info += " <span style='color:#4ade80'>&#9989; Peak within limits</span>";
            }
            
            // Peaking factor assessment
            if (pop > 0) {
                var expectedPF;
                if (pop < 1000) expectedPF = "3.5-4.0 (small system)";
                else if (pop < 10000) expectedPF = "2.5-3.5 (small-medium)";
                else if (pop < 100000) expectedPF = "2.0-2.5 (medium)";
                else expectedPF = "1.5-2.0 (large system)";
                info += "<br>Expected PF for " + Math.round(pop).toLocaleString() + " pop: " + expectedPF;
            }
        }
        
        // ===== CAPACITY ANALYSIS =====
        if (permit > 0) {
            const capPct = (flow / permit * 100);
            const remainMGD = permit - flow;
            const remainPE = (remainMGD * 1000000) / 100;
            const remainEDU = remainPE / 3.5;
            
            info += "<br><br><b>Capacity Analysis:</b>";
            info += "<br>Permitted: " + permit + " MGD | Current: " + flow + " MGD | Remaining: " + remainMGD.toFixed(3) + " MGD";
            
            // Capacity bar with milestone markers
            info += "<div style='position:relative;margin:6px 0'>" +
                "<div style='background:#1e293b;border-radius:4px;height:20px;position:relative;overflow:hidden'>" +
                "<div style='position:absolute;left:75%;top:0;bottom:0;width:1px;background:#fbbf24;z-index:1'></div>" +
                "<div style='position:absolute;left:90%;top:0;bottom:0;width:1px;background:#ef4444;z-index:1'></div>" +
                "<div style='background:" + (capPct > 90 ? "var(--danger)" : capPct > 75 ? "var(--accent)" : "#4ade80") +
                ";height:100%;width:" + Math.min(capPct, 100) + "%;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:0.7rem;font-weight:bold;color:#0f172a'>" + capPct.toFixed(1) + "%</div>" +
                "</div>" +
                "<div style='display:flex;justify-content:space-between;font-size:0.6rem;color:#64748b;margin-top:1px'>" +
                "<span>0%</span><span style='margin-left:50%'>|75% TCEQ</span><span style='margin-left:auto'>|90%</span><span>100%</span>" +
                "</div></div>";
            
            if (capPct >= 95) info += "&#128680; <b>AT CAPACITY</b> &mdash; Expansion required immediately. TCEQ enforcement risk.";
            else if (capPct >= 80) info += "&#9888;&#65039; <b>Approaching capacity.</b> Engineering report and expansion timeline required.";
            else if (capPct >= 75) info += "&#9888;&#65039; <b>75% TCEQ trigger.</b> Capacity planning report required per 30 TAC 217.";
            else info += "&#9989; Within capacity. <b>" + remainMGD.toFixed(3) + " MGD remaining</b> (" + Math.round(remainPE).toLocaleString() + " PE / " + Math.round(remainEDU).toLocaleString() + " EDU)";
            
            // Growth Projection
            if (growth > 0 && capPct < 100) {
                info += "<br><br><b>Growth Projection @ " + growth + "%/yr:</b>";
                
                // Timeline milestones
                var projFlow = flow;
                var yr75 = 0, yr80 = 0, yr90 = 0, yr100 = 0;
                for (var yr = 1; yr <= 50; yr++) {
                    projFlow *= (1 + growth/100);
                    if (projFlow >= permit * 0.75 && yr75 === 0) yr75 = yr;
                    if (projFlow >= permit * 0.80 && yr80 === 0) yr80 = yr;
                    if (projFlow >= permit * 0.90 && yr90 === 0) yr90 = yr;
                    if (projFlow >= permit && yr100 === 0) yr100 = yr;
                }
                
                // Visual timeline bar
                var thisYear = new Date().getFullYear();
                var maxYr = yr100 > 0 ? yr100 : 50;
                var timelineHTML = "<div style='background:#1e293b;border-radius:4px;height:24px;position:relative;margin:6px 0;overflow:hidden'>";
                if (yr75 > 0 && capPct < 75) timelineHTML += "<div style='position:absolute;left:" + (yr75/maxYr*100) + "%;top:0;bottom:0;width:2px;background:#fbbf24;z-index:1' title='75%'></div>" +
                    "<div style='position:absolute;left:" + (yr75/maxYr*100) + "%;top:1px;font-size:0.55rem;color:#fbbf24;padding-left:3px'>75%<br>" + (thisYear+yr75) + "</div>";
                if (yr90 > 0) timelineHTML += "<div style='position:absolute;left:" + (yr90/maxYr*100) + "%;top:0;bottom:0;width:2px;background:#f97316;z-index:1' title='90%'></div>" +
                    "<div style='position:absolute;left:" + (yr90/maxYr*100) + "%;top:1px;font-size:0.55rem;color:#f97316;padding-left:3px'>90%<br>" + (thisYear+yr90) + "</div>";
                if (yr100 > 0) timelineHTML += "<div style='position:absolute;left:" + Math.min(yr100/maxYr*100,98) + "%;top:0;bottom:0;width:2px;background:#ef4444;z-index:1' title='100%'></div>" +
                    "<div style='position:absolute;left:" + Math.min(yr100/maxYr*100,98) + "%;top:1px;font-size:0.55rem;color:#ef4444;padding-left:3px'>100%<br>" + (thisYear+yr100) + "</div>";
                timelineHTML += "</div>";
                info += timelineHTML;
                
                if (capPct < 75 && yr75 > 0) info += "<br>&#128310; 75% TCEQ planning trigger: <b>" + yr75 + " years</b> (" + (thisYear+yr75) + ")";
                if (capPct < 80 && yr80 > 0) info += "<br>&#128992; 80% capacity: <b>" + yr80 + " years</b> (" + (thisYear+yr80) + ")";
                if (yr90 > 0) info += "<br>&#128308; 90% capacity: <b>" + yr90 + " years</b> (" + (thisYear+yr90) + ")";
                if (yr100 > 0) info += "<br>&#9899; 100% capacity: <b>" + yr100 + " years</b> (" + (thisYear+yr100) + ")";
                else info += "<br>100% capacity: &gt;50 years at current growth";
                
                // 5/10/20 year table
                var proj5 = flow * Math.pow(1 + growth/100, 5);
                var proj10 = flow * Math.pow(1 + growth/100, 10);
                var proj20 = flow * Math.pow(1 + growth/100, 20);
                var pop5 = pop > 0 ? pop * Math.pow(1 + growth/100, 5) : 0;
                var pop10 = pop > 0 ? pop * Math.pow(1 + growth/100, 10) : 0;
                var pop20 = pop > 0 ? pop * Math.pow(1 + growth/100, 20) : 0;
                
                info += "<br><div style='margin-top:6px;font-size:0.75rem'>" +
                    "<div style='display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:2px;text-align:center'>" +
                    "<div style='background:#1e293b;padding:3px;border-radius:3px;font-weight:bold;color:#94a3b8'>Year</div>" +
                    "<div style='background:#1e293b;padding:3px;border-radius:3px;font-weight:bold;color:#94a3b8'>5-yr (" + (thisYear+5) + ")</div>" +
                    "<div style='background:#1e293b;padding:3px;border-radius:3px;font-weight:bold;color:#94a3b8'>10-yr (" + (thisYear+10) + ")</div>" +
                    "<div style='background:#1e293b;padding:3px;border-radius:3px;font-weight:bold;color:#94a3b8'>20-yr (" + (thisYear+20) + ")</div>" +
                    "<div style='padding:2px;color:#94a3b8'>Flow</div>" +
                    "<div style='padding:2px'>" + proj5.toFixed(3) + " MGD</div>" +
                    "<div style='padding:2px'>" + proj10.toFixed(3) + " MGD</div>" +
                    "<div style='padding:2px'>" + proj20.toFixed(3) + " MGD</div>" +
                    "<div style='padding:2px;color:#94a3b8'>Cap %</div>" +
                    "<div style='padding:2px;color:" + (proj5/permit*100 > 90 ? "var(--danger)" : proj5/permit*100 > 75 ? "var(--accent)" : "#4ade80") + "'><b>" + (proj5/permit*100).toFixed(0) + "%</b></div>" +
                    "<div style='padding:2px;color:" + (proj10/permit*100 > 90 ? "var(--danger)" : proj10/permit*100 > 75 ? "var(--accent)" : "#4ade80") + "'><b>" + (proj10/permit*100).toFixed(0) + "%</b></div>" +
                    "<div style='padding:2px;color:" + (proj20/permit*100 > 90 ? "var(--danger)" : proj20/permit*100 > 75 ? "var(--accent)" : "#4ade80") + "'><b>" + (proj20/permit*100).toFixed(0) + "%</b></div>";
                if (pop > 0) {
                    info += "<div style='padding:2px;color:#94a3b8'>Pop</div>" +
                        "<div style='padding:2px'>" + Math.round(pop5).toLocaleString() + "</div>" +
                        "<div style='padding:2px'>" + Math.round(pop10).toLocaleString() + "</div>" +
                        "<div style='padding:2px'>" + Math.round(pop20).toLocaleString() + "</div>";
                }
                info += "</div></div>";
            }
        }
        
        // ===== TCEQ REPORT SUMMARY =====
        var reportLines = [];
        reportLines.push("POPULATION EQUIVALENT & CAPACITY ANALYSIS");
        reportLines.push("=========================================");
        reportLines.push("Date: " + new Date().toLocaleDateString());
        reportLines.push("");
        reportLines.push("PLANT LOADING:");
        reportLines.push("  Average Daily Flow:  " + flow.toFixed(3) + " MGD (" + flowGPD.toLocaleString() + " GPD)");
        if (bod > 0) reportLines.push("  Influent BOD:        " + bod + " mg/L (" + lbsBOD.toFixed(0) + " lbs/day)");
        if (tss > 0) reportLines.push("  Influent TSS:        " + tss + " mg/L (" + lbsTSS.toFixed(0) + " lbs/day)");
        if (tkn > 0) reportLines.push("  Influent TKN:        " + tkn + " mg/L (" + lbsTKN.toFixed(0) + " lbs/day)");
        reportLines.push("");
        reportLines.push("POPULATION EQUIVALENTS:");
        reportLines.push("  From Flow (100 GPD/cap):   " + Math.round(peFlow).toLocaleString() + " PE");
        if (peBOD > 0) reportLines.push("  From BOD (0.17 lbs/cap):   " + Math.round(peBOD).toLocaleString() + " PE");
        if (peTSS > 0) reportLines.push("  From TSS (0.20 lbs/cap):   " + Math.round(peTSS).toLocaleString() + " PE");
        if (peTKN > 0) reportLines.push("  From TKN (0.03 lbs/cap):   " + Math.round(peTKN).toLocaleString() + " PE");
        reportLines.push("  GOVERNING PE:              " + Math.round(governing.val).toLocaleString() + " (" + governing.label + ")");
        reportLines.push("  Equivalent Dwelling Units:  " + Math.round(eduGoverning).toLocaleString() + " EDU (3.5 cap/EDU)");
        if (pop > 0) {
            reportLines.push("");
            reportLines.push("SERVICE AREA:");
            reportLines.push("  Actual Population:    " + Math.round(pop).toLocaleString());
            reportLines.push("  Per Capita Flow:      " + (flowGPD/pop).toFixed(0) + " GPD/person (std: 100)");
            if (bod > 0) reportLines.push("  Per Capita BOD:       " + (lbsBOD/pop).toFixed(3) + " lbs/person (std: 0.17)");
            if (tss > 0) reportLines.push("  Per Capita TSS:       " + (lbsTSS/pop).toFixed(3) + " lbs/person (std: 0.20)");
            if (tkn > 0) reportLines.push("  Per Capita TKN:       " + (lbsTKN/pop).toFixed(4) + " lbs/person (std: 0.03)");
        }
        if (permit > 0) {
            var rptCapPct = (flow/permit*100);
            reportLines.push("");
            reportLines.push("CAPACITY:");
            reportLines.push("  Permitted Flow:       " + permit + " MGD");
            reportLines.push("  Current Utilization:  " + rptCapPct.toFixed(1) + "%");
            reportLines.push("  Remaining Capacity:   " + (permit-flow).toFixed(3) + " MGD (" + Math.round((permit-flow)*1000000/100).toLocaleString() + " PE)");
            if (rptCapPct >= 75) reportLines.push("  STATUS: *** EXCEEDS 75% TCEQ PLANNING THRESHOLD ***");
            if (growth > 0) {
                var pf2 = flow;
                var y100 = 0;
                for (var yy = 1; yy <= 50; yy++) { pf2 *= (1+growth/100); if (pf2 >= permit && y100===0) y100 = yy; }
                reportLines.push("");
                reportLines.push("GROWTH PROJECTION (" + growth + "%/yr):");
                var p5 = flow*Math.pow(1+growth/100,5);
                var p10 = flow*Math.pow(1+growth/100,10);
                var p20 = flow*Math.pow(1+growth/100,20);
                reportLines.push("  5-Year:  " + p5.toFixed(3) + " MGD (" + (p5/permit*100).toFixed(0) + "% capacity)");
                reportLines.push("  10-Year: " + p10.toFixed(3) + " MGD (" + (p10/permit*100).toFixed(0) + "% capacity)");
                reportLines.push("  20-Year: " + p20.toFixed(3) + " MGD (" + (p20/permit*100).toFixed(0) + "% capacity)");
                if (y100 > 0) reportLines.push("  Capacity Reached: " + y100 + " years (" + (new Date().getFullYear()+y100) + ")");
            }
        }
        if (peak > 0) {
            reportLines.push("");
            reportLines.push("PEAKING:");
            reportLines.push("  Peaking Factor:       " + peak);
            reportLines.push("  Peak Flow:            " + (flow*peak).toFixed(3) + " MGD");
            if (permit > 0) reportLines.push("  Peak vs Permit:       " + (flow*peak/permit*100).toFixed(1) + "%");
        }
        reportLines.push("");
        reportLines.push("Generated by WW Pro-Calc v9.1 | ProcessCore Systems");
        
        var reportText = reportLines.join("\n");
        var reportEl = document.getElementById('pe_report');
        var reportBtn = document.getElementById('pe_report_btn');
        reportEl.style.display = 'block';
        reportBtn.style.display = 'block';
        reportEl.innerText = reportText;
        reportEl.setAttribute('data-report', reportText);
        
        stat.innerHTML = info;
        stat.style.color = "#94a3b8";
    }

    function copyPEReport() {
        var reportEl = document.getElementById('pe_report');
        var text = reportEl.getAttribute('data-report') || reportEl.innerText;
        navigator.clipboard.writeText(text).then(function() {
            var btn = document.getElementById('pe_report_btn');
            btn.innerText = 'âœ“ Copied to Clipboard!';
            btn.style.background = 'rgba(74, 222, 128, 0.15)';
            btn.style.borderColor = '#4ade80';
            btn.style.color = '#4ade80';
            setTimeout(function() {
                btn.innerHTML = '&#128203; Copy TCEQ Report Summary';
                btn.style.background = 'rgba(217,70,239,0.1)';
                btn.style.borderColor = '#d946ef';
                btn.style.color = '#e879f9';
            }, 2000);
        });
    }

    // ==================== PARSHALL FLUME ====================

    // 62. Parshall Flume
    function calcParshall() {
        const widthIn = parseInt(document.getElementById('pf_width').value) || 0;
        const ha = parseFloat(document.getElementById('pf_ha').value) || 0;
        const hb = parseFloat(document.getElementById('pf_hb').value) || 0;
        
        if (widthIn > 0 && ha > 0) {
            // Parshall flume coefficients: Q = C Ã— Ha^n (CFS)
            var coeffs = {
                3:  {c: 0.992, n: 1.547, subLimit: 0.50},
                6:  {c: 2.06,  n: 1.58,  subLimit: 0.60},
                9:  {c: 3.07,  n: 1.53,  subLimit: 0.60},
                12: {c: 4.00,  n: 1.522, subLimit: 0.70},
                18: {c: 6.00,  n: 1.538, subLimit: 0.70},
                24: {c: 8.00,  n: 1.550, subLimit: 0.70},
                36: {c: 12.00, n: 1.566, subLimit: 0.70},
                48: {c: 16.00, n: 1.578, subLimit: 0.70},
                60: {c: 20.00, n: 1.587, subLimit: 0.70},
                72: {c: 24.00, n: 1.595, subLimit: 0.70},
                96: {c: 32.00, n: 1.607, subLimit: 0.70}
            };
            
            var co = coeffs[widthIn];
            if (!co) return;
            
            var qCFS = co.c * Math.pow(ha, co.n);
            var qGPM = qCFS * 448.83;
            var qMGD = qGPM * 0.00144;
            
            document.getElementById('pf_res').innerText = qGPM.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPM (" + qMGD.toFixed(4) + " MGD)";
            var stat = document.getElementById('pf_status');
            
            var subInfo = "";
            if (hb > 0) {
                var subRatio = hb / ha;
                if (subRatio > co.subLimit) {
                    subInfo = "<br><span style='color:var(--accent)'>âš ï¸ SUBMERGED: Hb/Ha = " + subRatio.toFixed(2) + " (limit: " + co.subLimit + ")</span>" +
                        "<br>Free-flow reading is <b>NOT VALID</b>. Apply submergence correction or clear downstream obstruction.";
                } else {
                    subInfo = "<br>âœ“ Free-flow confirmed: Hb/Ha = " + subRatio.toFixed(2) + " (limit: " + co.subLimit + ")";
                }
            }
            
            stat.innerHTML = "ðŸ“Š <b>Free-Flow Discharge: " + qGPM.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPM</b>" +
                "<br>" + qCFS.toFixed(3) + " CFS | " + qMGD.toFixed(4) + " MGD" +
                "<br>Throat: " + widthIn + "\" | Ha: " + ha + " ft (" + (ha*12).toFixed(1) + " in) | C=" + co.c + " | n=" + co.n +
                subInfo +
                "<br><br>ðŸ“ Q = " + co.c + " Ã— " + ha + "^" + co.n + " = " + qCFS.toFixed(3) + " CFS";
            stat.style.color = "#94a3b8";
        }
    }

    // ==================== TANK VOLUME ====================

    // 63. Tank Volume
    function calcTankVol() {
        var shape = document.getElementById('tv_shape').value;
        var dim1 = parseFloat(document.getElementById('tv_dim1').value) || 0;
        var dim2 = parseFloat(document.getElementById('tv_dim2').value) || 0;
        var depth = parseFloat(document.getElementById('tv_depth').value) || 0;
        var cone = parseFloat(document.getElementById('tv_cone').value) || 0;
        
        if (dim1 > 0 && depth > 0) {
            var volFt3 = 0;
            var desc = "";
            var areaFt2 = 0;
            
            if (shape === 'circ') {
                areaFt2 = Math.PI * Math.pow(dim1/2, 2);
                volFt3 = areaFt2 * depth;
                desc = "Circular: " + dim1 + " ft dia Ã— " + depth + " ft SWD | Area: " + areaFt2.toFixed(1) + " ftÂ²";
            } else if (shape === 'rect' && dim2 > 0) {
                areaFt2 = dim1 * dim2;
                volFt3 = dim1 * dim2 * depth;
                desc = "Rectangular: " + dim1 + " Ã— " + dim2 + " Ã— " + depth + " ft | Area: " + areaFt2.toFixed(1) + " ftÂ²";
            } else if (shape === 'cone') {
                areaFt2 = Math.PI * Math.pow(dim1/2, 2);
                var cylVol = areaFt2 * depth;
                var coneVol = cone > 0 ? (Math.PI / 3) * Math.pow(dim1/2, 2) * cone : 0;
                volFt3 = cylVol + coneVol;
                desc = "Cone-bottom: " + dim1 + " ft dia Ã— " + depth + " ft wall + " + cone + " ft cone";
            } else {
                return;
            }
            
            var volGal = volFt3 * 7.48;
            var volM3 = volFt3 * 0.02832;
            var volMG = volGal / 1000000;
            var volAcFt = volFt3 / 43560;
            
            document.getElementById('tv_res').innerText = volGal.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " gallons";
            var stat = document.getElementById('tv_status');
            
            stat.innerHTML = "ðŸ“Š <b>Volume Results:</b>" +
                "<br>" + desc +
                "<br><br><div style='display:grid;grid-template-columns:1fr 1fr;gap:4px;font-size:0.85rem'>" +
                "<div style='background:#1e293b;padding:6px 8px;border-radius:4px'><span style='color:#94a3b8'>Gallons:</span><br><b>" + volGal.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + "</b></div>" +
                "<div style='background:#1e293b;padding:6px 8px;border-radius:4px'><span style='color:#94a3b8'>ftÂ³:</span><br><b>" + volFt3.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + "</b></div>" +
                "<div style='background:#1e293b;padding:6px 8px;border-radius:4px'><span style='color:#94a3b8'>MG:</span><br><b>" + volMG.toFixed(4) + "</b></div>" +
                "<div style='background:#1e293b;padding:6px 8px;border-radius:4px'><span style='color:#94a3b8'>mÂ³:</span><br><b>" + volM3.toFixed(1) + "</b></div>" +
                "</div>" +
                (shape === 'cone' && cone > 0 ? "<br>Cylinder: " + (areaFt2 * depth * 7.48).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " gal | Cone: " + ((Math.PI/3) * Math.pow(dim1/2,2) * cone * 7.48).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " gal" : "") +
                "<br><br>ðŸ’¡ <b>Quick HRT check:</b> At 1 MGD â†’ HRT = " + (volMG / 1 * 24).toFixed(1) + " hrs | At 0.5 MGD â†’ " + (volMG / 0.5 * 24).toFixed(1) + " hrs";
            stat.style.color = "#94a3b8";
        }
    }

    // ==================== POND HRT ====================

    // 64. Pond Detention Time
    function calcPondHRT() {
        var acres = parseFloat(document.getElementById('hrt_acres').value) || 0;
        var depth = parseFloat(document.getElementById('hrt_depth').value) || 0;
        var sludge = parseFloat(document.getElementById('hrt_sludge').value) || 0;
        var flow = parseFloat(document.getElementById('hrt_flow').value) || 0;
        var cells = parseFloat(document.getElementById('hrt_cells').value) || 1;
        
        if (acres > 0 && depth > 0 && flow > 0) {
            var effDepth = depth - sludge;
            if (effDepth <= 0) {
                document.getElementById('hrt_res').innerText = "ERROR: Sludge â‰¥ Depth!";
                document.getElementById('hrt_status').innerHTML = "ðŸš¨ <b>Sludge depth exceeds water depth â€” pond is full of sludge. Immediate dredging required.</b>";
                document.getElementById('hrt_status').style.color = "var(--danger)";
                return;
            }
            
            var designVol = acres * 43560 * depth * 7.48;
            var actualVol = acres * 43560 * effDepth * 7.48;
            var volLost = designVol - actualVol;
            var pctLost = (volLost / designVol * 100);
            var flowGPD = flow * 1000000;
            
            var designHRT = designVol / flowGPD;
            var actualHRT = actualVol / flowGPD;
            var hrtLost = designHRT - actualHRT;
            
            document.getElementById('hrt_res').innerText = "Actual HRT: " + actualHRT.toFixed(0) + " days (design: " + designHRT.toFixed(0) + ")";
            var stat = document.getElementById('hrt_status');
            
            var assessment = "";
            if (actualHRT >= 90) { assessment = "âœ“ Within typical facultative range (90â€“180 days)"; stat.style.color = "#4ade80"; }
            else if (actualHRT >= 60) { assessment = "âš ï¸ Below 90-day minimum â€” reduced treatment. Consider flow reduction or sludge removal."; stat.style.color = "var(--accent)"; }
            else if (actualHRT >= 30) { assessment = "ðŸš¨ Severely reduced HRT â€” high risk of odors and permit violations"; stat.style.color = "var(--danger)"; }
            else { assessment = "ðŸš¨ CRITICAL â€” HRT far below design. Immediate action required."; stat.style.color = "var(--danger)"; }
            
            var info = "ðŸ“Š <b>Pond Detention Analysis:</b>" +
                "<br>Design volume: " + (designVol/1000000).toFixed(2) + " MG | Actual: " + (actualVol/1000000).toFixed(2) + " MG" +
                "<br>Sludge loss: <b>" + (volLost/1000000).toFixed(2) + " MG (" + pctLost.toFixed(0) + "% of design)</b>" +
                "<br><br><div style='display:flex;gap:6px'>" +
                "<div style='flex:1;background:#1e293b;padding:8px;border-radius:6px;text-align:center'>" +
                "<div style='color:#94a3b8;font-size:0.7rem'>DESIGN HRT</div><div style='font-size:1.2rem;font-weight:bold;color:#4ade80'>" + designHRT.toFixed(0) + " d</div></div>" +
                "<div style='flex:1;background:#1e293b;padding:8px;border-radius:6px;text-align:center'>" +
                "<div style='color:#94a3b8;font-size:0.7rem'>ACTUAL HRT</div><div style='font-size:1.2rem;font-weight:bold;color:" + (actualHRT < 90 ? "var(--accent)" : "#4ade80") + "'>" + actualHRT.toFixed(0) + " d</div></div>" +
                "<div style='flex:1;background:#1e293b;padding:8px;border-radius:6px;text-align:center'>" +
                "<div style='color:#94a3b8;font-size:0.7rem'>LOST</div><div style='font-size:1.2rem;font-weight:bold;color:var(--danger)'>" + hrtLost.toFixed(0) + " d</div></div>" +
                "</div>";
            
            // Sludge depth bar
            info += "<br><div style='margin:4px 0'><span style='font-size:0.75rem;color:#94a3b8'>Cross-section:</span>" +
                "<div style='display:flex;height:40px;border-radius:4px;overflow:hidden;border:1px solid #334155;margin:3px 0'>" +
                "<div style='width:" + ((effDepth/depth)*100) + "%;background:rgba(56,189,248,0.3);display:flex;align-items:center;justify-content:center;font-size:0.65rem;color:#7dd3fc;font-weight:bold'>Water: " + effDepth.toFixed(1) + " ft</div>" +
                "<div style='width:" + ((sludge/depth)*100) + "%;background:rgba(180,83,9,0.4);display:flex;align-items:center;justify-content:center;font-size:0.65rem;color:#fbbf24;font-weight:bold'>Sludge: " + sludge.toFixed(1) + " ft</div>" +
                "</div></div>";
            
            // Short-circuiting estimate
            if (cells > 0) {
                var scFactor = cells === 1 ? 0.3 : cells === 2 ? 0.5 : cells >= 3 ? 0.7 : 0.5;
                var effectiveHRT = actualHRT * scFactor;
                info += "<br><b>Short-Circuiting Estimate (" + cells + " cell" + (cells > 1 ? "s" : "") + " in series):</b>" +
                    "<br>Efficiency factor: " + (scFactor*100).toFixed(0) + "% | Effective HRT: <b>" + effectiveHRT.toFixed(0) + " days</b>" +
                    "<br><span style='font-size:0.7rem;color:#64748b'>1 cell: ~30% efficient | 2 cells: ~50% | 3+ cells: ~70% | Baffles improve performance</span>";
            }
            
            info += "<br><br>" + assessment;
            stat.innerHTML = info;
        }
    }

    // ==================== BLOWER AIR REQUIREMENT ====================

    // 65. Blower Air Requirement
    function calcBlower() {
        var o2 = parseFloat(document.getElementById('bl_o2').value) || 0;
        var depth = parseFloat(document.getElementById('bl_depth').value) || 0;
        var ote = parseFloat(document.getElementById('bl_ote').value) || 0;
        var basins = parseFloat(document.getElementById('bl_basins').value) || 1;
        var sf = parseFloat(document.getElementById('bl_sf').value) || 1;
        var cost = parseFloat(document.getElementById('bl_cost').value) || 0;
        
        if (o2 > 0 && ote > 0) {
            // Air is 0.075 lbs/ftÂ³ at standard conditions, 23.2% Oâ‚‚ by weight
            var o2PerCFAir = 0.075 * 0.232; // 0.0174 lbs Oâ‚‚ per ftÂ³ air
            var totalO2 = o2 * sf; // lbs Oâ‚‚/hr with safety factor
            var cfmTotal = (totalO2 / (o2PerCFAir * (ote/100))) / 60;
            var cfmPerBasin = cfmTotal / basins;
            
            // Blower discharge pressure (approx: 1 psi per 2.31 ft depth + 1-2 psi losses)
            var dischPSI = (depth / 2.31) + 1.5;
            
            // BHP estimate: BHP = (SCFM Ã— discharge PSI) / (6356 Ã— blower eff)
            var blowerEff = 0.70; // typical
            var bhpTotal = (cfmTotal * dischPSI * 144) / (33000 * blowerEff);
            var kw = bhpTotal * 0.746;
            
            // Annual cost
            var annualKWH = kw * 8760 * 0.90; // 90% runtime
            var annualCost = cost > 0 ? annualKWH * cost : 0;
            
            document.getElementById('bl_res').innerText = cfmTotal.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " SCFM total";
            var stat = document.getElementById('bl_status');
            
            var info = "ðŸ“Š <b>Blower Sizing Results:</b>" +
                "<br><div style='display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;margin:6px 0'>" +
                "<div style='background:#1e293b;padding:8px;border-radius:6px;text-align:center'>" +
                "<div style='color:#94a3b8;font-size:0.65rem'>TOTAL SCFM</div><div style='font-size:1.1rem;font-weight:bold;color:#818cf8'>" + cfmTotal.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + "</div></div>" +
                "<div style='background:#1e293b;padding:8px;border-radius:6px;text-align:center'>" +
                "<div style='color:#94a3b8;font-size:0.65rem'>PER BASIN</div><div style='font-size:1.1rem;font-weight:bold;color:#a5b4fc'>" + cfmPerBasin.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + "</div></div>" +
                "<div style='background:#1e293b;padding:8px;border-radius:6px;text-align:center'>" +
                "<div style='color:#94a3b8;font-size:0.65rem'>EST. BHP</div><div style='font-size:1.1rem;font-weight:bold;color:#c4b5fd'>" + bhpTotal.toFixed(0) + "</div></div>" +
                "</div>";
            
            info += "<b>Design Parameters:</b>" +
                "<br>Oâ‚‚ demand: " + o2 + " lbs/hr Ã— " + sf + " SF = <b>" + totalO2.toFixed(0) + " lbs Oâ‚‚/hr</b>" +
                "<br>OTE: " + ote + "% at " + depth + " ft depth | " + basins + " basin" + (basins > 1 ? "s" : "") +
                "<br>Discharge pressure: ~" + dischPSI.toFixed(1) + " psig | Motor: <b>" + kw.toFixed(1) + " kW</b> (" + bhpTotal.toFixed(0) + " BHP)";
            
            if (cost > 0) {
                info += "<br><br><b>Energy Cost Estimate:</b>" +
                    "<br>Annual runtime: 7,884 hrs (90%) | " + annualKWH.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " kWh/yr" +
                    "<br>At $" + cost.toFixed(2) + "/kWh: <b style='color:#fbbf24'>$" + annualCost.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + "/year</b>" +
                    " ($" + (annualCost/12).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + "/month)";
            }
            
            // Diffuser count estimate
            var diffPerSCFM = 3.5; // typical fine bubble: 2-5 SCFM per diffuser
            var estDiffusers = Math.ceil(cfmTotal / diffPerSCFM);
            info += "<br><br>ðŸ’¡ Est. diffuser count: ~" + estDiffusers + " fine bubble (at 3.5 SCFM/disc)";
            
            stat.innerHTML = info;
            stat.style.color = "#94a3b8";
        }
    }

    // ==================== BIOSOLIDS & LAND APPLICATION ====================

    // 66. Plant Available Nitrogen (PAN)
    function calcPAN() {
        var nh3 = parseFloat(document.getElementById('pan_nh3').value) || 0;
        var no3 = parseFloat(document.getElementById('pan_no3').value) || 0;
        var orgN = parseFloat(document.getElementById('pan_orgn').value) || 0;
        var method = document.getElementById('pan_method').value;
        var kmin = parseFloat(document.getElementById('pan_kmin').value) || 0;
        var solids = parseFloat(document.getElementById('pan_solids').value) || 0;
        
        if ((nh3 > 0 || no3 > 0 || orgN > 0) && kmin > 0) {
            // Volatilization factor
            var kvol = method === 'inject' ? 1.0 : 0.5; // injected = 100% available, surface = 50% lost
            
            // PAN (mg/kg) = (Kvol Ã— NHâ‚ƒ-N) + NOâ‚ƒ-N + (Kmin Ã— Org-N)
            var panMgKg = (kvol * nh3) + no3 + ((kmin/100) * orgN);
            
            // Convert to lbs/dry ton: mg/kg Ã— 0.002 = lbs/ton
            var panLbsDT = panMgKg * 0.002;
            
            // Total nitrogen
            var totalN = nh3 + no3 + orgN;
            var pctAvailable = (panMgKg / totalN * 100);
            
            document.getElementById('pan_res').innerText = panLbsDT.toFixed(1) + " lbs PAN / dry ton";
            var stat = document.getElementById('pan_status');
            
            var info = "ðŸ“Š <b>Plant Available Nitrogen Analysis:</b>" +
                "<br><div style='display:grid;grid-template-columns:1fr 1fr;gap:4px;margin:6px 0'>" +
                "<div style='background:#1e293b;padding:8px;border-radius:6px;text-align:center'>" +
                "<div style='color:#94a3b8;font-size:0.65rem'>PAN (mg/kg)</div><div style='font-size:1.1rem;font-weight:bold;color:#fbbf24'>" + panMgKg.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + "</div></div>" +
                "<div style='background:#1e293b;padding:8px;border-radius:6px;text-align:center'>" +
                "<div style='color:#94a3b8;font-size:0.65rem'>PAN (lbs/DT)</div><div style='font-size:1.1rem;font-weight:bold;color:#d97706'>" + panLbsDT.toFixed(1) + "</div></div>" +
                "</div>";
            
            info += "<b>Nitrogen Fractions:</b>" +
                "<br>NHâ‚ƒ-N: " + nh3.toLocaleString() + " mg/kg Ã— " + (kvol*100) + "% available = <b>" + (kvol*nh3).toFixed(0).toLocaleString() + "</b> mg/kg" +
                "<br>NOâ‚ƒ-N: " + no3.toLocaleString() + " mg/kg Ã— 100% available = <b>" + no3.toFixed(0).toLocaleString() + "</b> mg/kg" +
                "<br>Org-N: " + orgN.toLocaleString() + " mg/kg Ã— " + kmin + "% mineralized = <b>" + ((kmin/100)*orgN).toFixed(0).toLocaleString() + "</b> mg/kg";
            
            // N availability bar
            var nh3Pct = (kvol * nh3) / panMgKg * 100;
            var no3Pct = no3 / panMgKg * 100;
            var orgPct = ((kmin/100) * orgN) / panMgKg * 100;
            info += "<br><div style='display:flex;height:16px;border-radius:4px;overflow:hidden;margin:6px 0'>" +
                "<div style='width:" + nh3Pct.toFixed(0) + "%;background:#4ade80;display:flex;align-items:center;justify-content:center;font-size:0.55rem;font-weight:bold;color:#0f172a'>NHâ‚ƒ</div>" +
                "<div style='width:" + no3Pct.toFixed(0) + "%;background:#3b82f6;display:flex;align-items:center;justify-content:center;font-size:0.55rem;font-weight:bold;color:#fff'>NOâ‚ƒ</div>" +
                "<div style='width:" + orgPct.toFixed(0) + "%;background:#d97706;display:flex;align-items:center;justify-content:center;font-size:0.55rem;font-weight:bold;color:#fff'>Org</div>" +
                "</div>";
            
            info += "<br>Total N: " + totalN.toLocaleString() + " mg/kg | PAN: " + panMgKg.toFixed(0).toLocaleString() + " mg/kg | <b>" + pctAvailable.toFixed(0) + "% available</b> in Year 1" +
                "<br>Method: " + (method === 'inject' ? "Injected/incorporated (0% NHâ‚ƒ loss)" : "Surface applied (50% NHâ‚ƒ volatilization loss)");
            
            if (solids > 0) {
                var wetTonLbs = 2000 / (solids/100);
                var panPerWetTon = panLbsDT * (solids/100);
                info += "<br><br>At " + solids + "% solids: <b>" + panPerWetTon.toFixed(2) + " lbs PAN/wet ton</b> (" + (wetTonLbs).toFixed(0).toLocaleString() + " lbs wet per dry ton)";
            }
            
            stat.innerHTML = info;
            stat.style.color = "#94a3b8";
        }
    }

    // 67. Land Application Rate
    function calcLandApp() {
        var pan = parseFloat(document.getElementById('la_pan').value) || 0;
        var crop = parseFloat(document.getElementById('la_crop').value) || 0;
        var solids = parseFloat(document.getElementById('la_solids').value) || 0;
        var prod = parseFloat(document.getElementById('la_prod').value) || 0;
        var acres = parseFloat(document.getElementById('la_acres').value) || 0;
        
        if (pan > 0 && crop > 0) {
            // Agronomic rate: DT/acre = Crop N uptake / PAN per DT
            var dtPerAcre = crop / pan;
            
            // Wet gallons per acre (if solids given)
            var wetGalPerAcre = 0;
            var wetTonsPerAcre = 0;
            if (solids > 0) {
                var lbsWetPerDT = 2000 / (solids/100);
                wetTonsPerAcre = dtPerAcre * (1 / (solids/100));
                wetGalPerAcre = (dtPerAcre * 2000) / (8.34 * (solids/100));
            }
            
            document.getElementById('la_res').innerText = dtPerAcre.toFixed(1) + " dry tons/acre/yr" + (wetGalPerAcre > 0 ? " | " + wetGalPerAcre.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " gal/acre" : "");
            var stat = document.getElementById('la_status');
            
            var info = "ðŸ“Š <b>Agronomic Application Rate:</b>" +
                "<br><div style='display:grid;grid-template-columns:1fr 1fr" + (wetGalPerAcre > 0 ? " 1fr" : "") + ";gap:4px;margin:6px 0'>" +
                "<div style='background:#1e293b;padding:8px;border-radius:6px;text-align:center'>" +
                "<div style='color:#94a3b8;font-size:0.65rem'>DRY TONS/ACRE</div><div style='font-size:1.1rem;font-weight:bold;color:#d97706'>" + dtPerAcre.toFixed(1) + "</div></div>" +
                "<div style='background:#1e293b;padding:8px;border-radius:6px;text-align:center'>" +
                "<div style='color:#94a3b8;font-size:0.65rem'>N APPLIED</div><div style='font-size:1.1rem;font-weight:bold;color:#4ade80'>" + crop + " lbs/ac</div></div>";
            if (wetGalPerAcre > 0) {
                info += "<div style='background:#1e293b;padding:8px;border-radius:6px;text-align:center'>" +
                    "<div style='color:#94a3b8;font-size:0.65rem'>WET GAL/ACRE</div><div style='font-size:1.1rem;font-weight:bold;color:#fbbf24'>" + wetGalPerAcre.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + "</div></div>";
            }
            info += "</div>";
            
            info += "<b>Calculation:</b>" +
                "<br>Crop N uptake: " + crop + " lbs N/acre/yr Ã· PAN: " + pan + " lbs/DT = <b>" + dtPerAcre.toFixed(1) + " DT/acre</b>";
            
            if (solids > 0) {
                info += "<br>At " + solids + "% solids: <b>" + wetTonsPerAcre.toFixed(1) + " wet tons/acre</b> (" + wetGalPerAcre.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " gal/acre)";
                
                // Truck loads estimate
                var galPerTruck = solids < 10 ? 5000 : 20; // liquid tanker vs dump truck (wet tons)
                if (solids < 10) {
                    var trucksPerAcre = wetGalPerAcre / 5000;
                    info += "<br>Est. tanker loads: ~" + trucksPerAcre.toFixed(1) + " per acre (5,000 gal tanker)";
                } else {
                    var trucksPerAcre2 = wetTonsPerAcre / 20;
                    info += "<br>Est. truck loads: ~" + trucksPerAcre2.toFixed(1) + " per acre (20 wet ton truck)";
                }
            }
            
            // Site capacity analysis
            if (prod > 0 && acres > 0) {
                var requiredAcres = prod / dtPerAcre;
                var siteCapDT = acres * dtPerAcre;
                var capPct = (prod / siteCapDT * 100);
                
                info += "<br><br><b>Site Capacity:</b>" +
                    "<br>Annual production: " + prod + " DT/yr | Required: <b>" + requiredAcres.toFixed(0) + " acres</b> | Available: " + acres + " acres";
                
                info += "<br><div style='background:#1e293b;border-radius:4px;height:16px;position:relative;margin:4px 0;overflow:hidden'>" +
                    "<div style='background:" + (capPct > 100 ? "var(--danger)" : capPct > 80 ? "var(--accent)" : "#4ade80") +
                    ";height:100%;width:" + Math.min(capPct, 100) + "%;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:0.65rem;font-weight:bold;color:#0f172a'>" + capPct.toFixed(0) + "% utilized</div></div>";
                
                if (capPct > 100) {
                    info += "ðŸš¨ <b>INSUFFICIENT ACREAGE.</b> Need " + (requiredAcres - acres).toFixed(0) + " more acres or reduce production.";
                } else if (capPct > 80) {
                    info += "âš ï¸ Site at " + capPct.toFixed(0) + "% capacity. Buffer: " + (acres - requiredAcres).toFixed(0) + " surplus acres.";
                } else {
                    info += "âœ“ Adequate. Surplus: " + (acres - requiredAcres).toFixed(0) + " acres (" + (siteCapDT - prod).toFixed(0) + " DT/yr additional capacity)";
                }
                
                // Annual hauling summary
                if (solids > 0) {
                    var totalWetGal = prod * 2000 / (8.34 * (solids/100));
                    info += "<br><br><b>Annual Hauling:</b> " + totalWetGal.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " gallons/yr total";
                    if (solids < 10) {
                        info += " (~" + Math.ceil(totalWetGal/5000) + " tanker loads)";
                    } else {
                        var totalWetTons = prod / (solids/100);
                        info += " (~" + Math.ceil(totalWetTons/20) + " truck loads)";
                    }
                }
            }
            
            stat.innerHTML = info;
            stat.style.color = "#94a3b8";
        }
    }

    // 68. TSS/VSS Lab Calculator
    function calcTSSVSS() {
        var filterWt = parseFloat(document.getElementById('tss_filter').value) || 0;
        var driedWt = parseFloat(document.getElementById('tss_dried').value) || 0;
        var ignitedWt = parseFloat(document.getElementById('tss_ignited').value) || 0;
        var volume = parseFloat(document.getElementById('tss_vol').value) || 0;
        
        var res = document.getElementById('tss_res');
        var stat = document.getElementById('tss_status');
        
        if (filterWt > 0 && driedWt > 0 && volume > 0) {
            // TSS = (dried weight - filter weight) Ã— 1,000,000 / mL
            var tss = (driedWt - filterWt) * 1000000 / volume;
            
            var results = "TSS = <b>" + tss.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " mg/L</b>";
            
            var info = "<b>TSS Calculation:</b><br>" +
                "(" + driedWt.toFixed(4) + " g âˆ’ " + filterWt.toFixed(4) + " g) Ã— 1,000,000 Ã· " + volume + " mL = <b>" + tss.toFixed(0) + " mg/L</b>";
            
            // If ignited weight provided, calculate VSS
            if (ignitedWt > 0 && ignitedWt < driedWt) {
                var vss = (driedWt - ignitedWt) * 1000000 / volume;
                var fss = tss - vss;
                var vssPct = (vss / tss) * 100;
                
                results += " | VSS = <b>" + vss.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " mg/L</b> (" + vssPct.toFixed(0) + "%)";
                
                info += "<br><br><b>VSS Calculation:</b><br>" +
                    "(" + driedWt.toFixed(4) + " g âˆ’ " + ignitedWt.toFixed(4) + " g) Ã— 1,000,000 Ã· " + volume + " mL = <b>" + vss.toFixed(0) + " mg/L</b>";
                
                info += "<br><br><div style='display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin:6px 0;'>" +
                    "<div style='background:#1e293b;padding:10px;border-radius:6px;text-align:center;'>" +
                    "<div style='color:#94a3b8;font-size:0.65rem;'>TSS</div><div style='font-size:1.2rem;font-weight:bold;color:#f97316;'>" + tss.toFixed(0) + "</div><div style='font-size:0.65rem;color:#64748b;'>mg/L</div></div>" +
                    "<div style='background:#1e293b;padding:10px;border-radius:6px;text-align:center;'>" +
                    "<div style='color:#94a3b8;font-size:0.65rem;'>VSS</div><div style='font-size:1.2rem;font-weight:bold;color:#4ade80;'>" + vss.toFixed(0) + "</div><div style='font-size:0.65rem;color:#64748b;'>mg/L</div></div>" +
                    "<div style='background:#1e293b;padding:10px;border-radius:6px;text-align:center;'>" +
                    "<div style='color:#94a3b8;font-size:0.65rem;'>FSS</div><div style='font-size:1.2rem;font-weight:bold;color:#60a5fa;'>" + fss.toFixed(0) + "</div><div style='font-size:0.65rem;color:#64748b;'>mg/L</div></div></div>";
                
                // VSS% interpretation
                info += "<b>VSS/TSS Ratio:</b> " + vssPct.toFixed(1) + "%";
                if (vssPct >= 70 && vssPct <= 85) {
                    info += " âœ“ <span style='color:#4ade80;'>Normal range for activated sludge</span>";
                } else if (vssPct < 70) {
                    info += " âš ï¸ <span style='color:#fbbf24;'>Low â€” possible inert solids buildup or old sludge</span>";
                } else if (vssPct > 85) {
                    info += " âš ï¸ <span style='color:#fbbf24;'>High â€” very young sludge or high organic load</span>";
                }
                
                // If this looks like MLSS range, give guidance
                if (tss >= 1500 && tss <= 6000) {
                    info += "<br><br><b>MLSS/MLVSS Assessment:</b><br>";
                    if (tss >= 2000 && tss <= 4000) {
                        info += "âœ“ MLSS in typical CAS range (2,000â€“4,000 mg/L)";
                    } else if (tss < 2000) {
                        info += "âš ï¸ MLSS below typical range â€” may need to reduce WAS or increase RAS";
                    } else {
                        info += "âš ï¸ MLSS above typical range â€” may need to increase WAS";
                    }
                }
            } else {
                // TSS only display
                info += "<br><br><div style='background:#1e293b;padding:12px;border-radius:6px;text-align:center;display:inline-block;min-width:100px;'>" +
                    "<div style='color:#94a3b8;font-size:0.7rem;'>TSS</div><div style='font-size:1.5rem;font-weight:bold;color:#f97316;'>" + tss.toFixed(0) + "</div><div style='font-size:0.7rem;color:#64748b;'>mg/L</div></div>";
                info += "<br><br><i style='color:#64748b;'>Enter weight after 550Â°C ignition to calculate VSS</i>";
            }
            
            // Common interpretations
            if (tss < 30) {
                info += "<br><br>ðŸ“Š <b>Effluent Quality:</b> TSS < 30 mg/L â€” Meets typical secondary limits";
            }
            
            res.innerHTML = results;
            stat.innerHTML = info;
            stat.style.color = "#94a3b8";
        } else {
            res.innerText = "â€”";
            stat.innerText = "Enter filter weights and sample volume...";
        }
    }

    // 72. Chemical Dosing Pump Output Calculator
    var pumpCapacityMode = 'gpd'; // 'gpd' or 'mlmin'
    var currentPumpTab = 'forward';
    
    // Chemical presets: [SG, concentration %]
    var chemicalPresets = {
        'custom': [1.0, 100],
        'bleach125': [1.16, 12.5],
        'bleach10': [1.10, 10],
        'calhypo65': [1.0, 65],
        'polymer': [1.0, 0.5],
        'polyemul': [1.05, 100],
        'alum48': [1.33, 48],
        'ferric40': [1.42, 40],
        'caustic25': [1.27, 25],
        'caustic50': [1.53, 50],
        'sulfuric93': [1.83, 93],
        'sodium_bisulfite': [1.36, 38],
        'methanol': [0.79, 100]
    };
    
    function setPumpTab(tab) {
        currentPumpTab = tab;
        var tabs = ['forward', 'reverse', 'dose', 'calibrate'];
        var tabIds = ['pumpTabFwd', 'pumpTabRev', 'pumpTabDose', 'pumpTabCal'];
        var panelIds = ['pumpPanelFwd', 'pumpPanelRev', 'pumpPanelDose', 'pumpPanelCal'];
        
        tabs.forEach(function(t, i) {
            var tabEl = document.getElementById(tabIds[i]);
            var panelEl = document.getElementById(panelIds[i]);
            if (t === tab) {
                tabEl.style.background = '#10b981';
                tabEl.style.color = '#fff';
                if (panelEl) panelEl.style.display = 'block';
            } else {
                tabEl.style.background = 'transparent';
                tabEl.style.color = '#94a3b8';
                if (panelEl) panelEl.style.display = 'none';
            }
        });
        
        // Show/hide forward results
        var fwdResults = document.getElementById('pumpResultsFwd');
        if (fwdResults) fwdResults.style.display = (tab === 'forward') ? 'block' : 'none';
    }
    
    function setChemicalPreset() {
        var sel = document.getElementById('pump_chemical').value;
        var preset = chemicalPresets[sel] || [1.0, 100];
        
        // Fill SG and concentration in all panels
        var sgFields = ['pump_sg', 'pump_rev_sg', 'pump_dose_sg'];
        var concFields = ['pump_conc', 'pump_dose_conc'];
        
        sgFields.forEach(function(id) {
            var el = document.getElementById(id);
            if (el) el.value = preset[0];
        });
        concFields.forEach(function(id) {
            var el = document.getElementById(id);
            if (el) el.value = preset[1];
        });
        
        // Trigger recalculation
        if (currentPumpTab === 'forward') calcPumpDose();
        else if (currentPumpTab === 'reverse') calcPumpReverse();
        else if (currentPumpTab === 'dose') calcPumpDoseCheck();
    }
    
    function setPumpMode(mode) {
        pumpCapacityMode = mode;
        var gpdBtn = document.getElementById('pumpModeGPD');
        var mlBtn = document.getElementById('pumpModeML');
        var capLabel = document.getElementById('pumpCapLabel');
        
        if (mode === 'gpd') {
            gpdBtn.style.background = 'rgba(16,185,129,0.2)';
            gpdBtn.style.borderColor = '#10b981';
            gpdBtn.style.color = '#34d399';
            mlBtn.style.background = 'transparent';
            mlBtn.style.borderColor = '#475569';
            mlBtn.style.color = '#94a3b8';
            capLabel.textContent = 'Pump Capacity (GPD @ 100%)';
        } else {
            mlBtn.style.background = 'rgba(16,185,129,0.2)';
            mlBtn.style.borderColor = '#10b981';
            mlBtn.style.color = '#34d399';
            gpdBtn.style.background = 'transparent';
            gpdBtn.style.borderColor = '#475569';
            gpdBtn.style.color = '#94a3b8';
            capLabel.textContent = 'Pump Capacity (mL/min @ 100%)';
        }
        calcPumpDose();
    }
    
    function calcPumpDose() {
        var capacity = parseFloat(document.getElementById('pump_capacity').value) || 0;
        var stroke = parseFloat(document.getElementById('pump_stroke').value) || 0;
        var rate = parseFloat(document.getElementById('pump_rate').value) || 0;
        var sg = parseFloat(document.getElementById('pump_sg').value) || 1.0;
        var conc = parseFloat(document.getElementById('pump_conc').value) || 100;
        var costPerGal = parseFloat(document.getElementById('pump_cost').value) || 0;
        
        var res = document.getElementById('pumpdose_res');
        var stat = document.getElementById('pumpdose_status');
        var details = document.getElementById('pumpdose_details');
        
        if (capacity > 0 && stroke > 0 && rate > 0) {
            var settingFactor = (stroke / 100) * (rate / 100);
            var gpd, mlday, mlhr, lpd, gph, lbday;
            
            if (pumpCapacityMode === 'gpd') {
                gpd = capacity * settingFactor;
                mlday = gpd * 3785.41;
                mlhr = mlday / 24;
                lpd = mlday / 1000;
                gph = gpd / 24;
                lbday = gpd * 8.34 * sg;
            } else {
                var mlmin = capacity * settingFactor;
                mlhr = mlmin * 60;
                mlday = mlhr * 24;
                lpd = mlday / 1000;
                gpd = mlday / 3785.41;
                gph = gpd / 24;
                lbday = gpd * 8.34 * sg;
            }
            
            var activeLbDay = lbday * (conc / 100);
            var costDay = gpd * costPerGal;
            var costMonth = costDay * 30;
            var galMonth = gpd * 30;
            var drums = galMonth / 55;
            
            var fmt = function(n, d) { return n.toFixed(d).replace(/\B(?=(\d{3})+(?!\d))/g, ","); };
            
            res.innerHTML = fmt(mlhr, 1) + " mL/hr";
            
            document.getElementById('pump_mlhr').textContent = fmt(mlhr, 1);
            document.getElementById('pump_mlday').textContent = fmt(mlday, 0);
            document.getElementById('pump_gpd').textContent = fmt(gpd, 3);
            document.getElementById('pump_lpd').textContent = fmt(lpd, 2);
            document.getElementById('pump_gph').textContent = fmt(gph, 4);
            document.getElementById('pump_lbday').textContent = fmt(lbday, 2);
            
            var activeEl = document.getElementById('pump_active_lbday');
            var costDayEl = document.getElementById('pump_costday');
            var costMonthEl = document.getElementById('pump_costmonth');
            var galMonthEl = document.getElementById('pump_galmonth');
            var drumsEl = document.getElementById('pump_drums');
            var cal1minEl = document.getElementById('pump_cal1min');
            
            if (activeEl) activeEl.textContent = fmt(activeLbDay, 2);
            if (costDayEl) costDayEl.textContent = costPerGal > 0 ? '$' + fmt(costDay, 2) : 'â€”';
            if (costMonthEl) costMonthEl.textContent = costPerGal > 0 ? '$' + fmt(costMonth, 0) : 'â€”';
            if (galMonthEl) galMonthEl.textContent = fmt(galMonth, 1);
            if (drumsEl) drumsEl.textContent = fmt(drums, 2);
            if (cal1minEl) cal1minEl.textContent = fmt(mlhr / 60, 1);
            
            details.style.display = 'block';
            
            var info = "<b>Pump Output at " + stroke + "% stroke, " + rate + "% speed:</b><br>";
            info += "â€¢ " + fmt(mlhr, 1) + " mL/hr = " + fmt(gpd, 3) + " GPD<br>";
            info += "â€¢ " + fmt(lbday, 2) + " lb/day product â†’ <b>" + fmt(activeLbDay, 2) + " lb/day active</b>";
            
            stat.innerHTML = info;
        } else {
            res.innerText = "â€” mL/hr";
            stat.innerText = "Enter pump capacity and settings...";
            details.style.display = 'none';
        }
    }
    
    function calcPumpReverse() {
        var targetLbDay = parseFloat(document.getElementById('pump_target_lbday').value) || 0;
        var capacity = parseFloat(document.getElementById('pump_rev_capacity').value) || 0;
        var sg = parseFloat(document.getElementById('pump_rev_sg').value) || 1.0;
        var fixedStroke = parseFloat(document.getElementById('pump_rev_stroke').value) || 100;
        
        var res = document.getElementById('pump_rev_res');
        var stat = document.getElementById('pump_rev_status');
        
        if (targetLbDay > 0 && capacity > 0 && sg > 0) {
            // lb/day = GPD Ã— 8.34 Ã— SG â†’ GPD = lb/day / (8.34 Ã— SG)
            var requiredGPD = targetLbDay / (8.34 * sg);
            
            // GPD = Capacity Ã— (Stroke/100) Ã— (Rate/100)
            // With fixed stroke: Rate = (requiredGPD / Capacity) / (Stroke/100) Ã— 100
            var strokeFactor = fixedStroke / 100;
            var requiredRate = (requiredGPD / capacity) / strokeFactor * 100;
            
            var maxGPD = capacity * (fixedStroke / 100);
            var maxLbDay = maxGPD * 8.34 * sg;
            
            if (requiredRate > 100) {
                res.innerHTML = "<span style='color:#ef4444;'>Exceeds Pump Capacity</span>";
                stat.innerHTML = "<b>Target requires " + requiredRate.toFixed(1) + "% rate</b> â€” pump cannot deliver " + targetLbDay.toFixed(1) + " lb/day.<br>" +
                    "Max output at " + fixedStroke + "% stroke: <b>" + maxLbDay.toFixed(1) + " lb/day</b><br><br>" +
                    "Options: Increase stroke %, use larger pump, or increase concentration.";
            } else if (requiredRate < 5) {
                res.innerHTML = requiredRate.toFixed(1) + "% rate";
                stat.innerHTML = "<b>âš ï¸ Very low setting</b> â€” consider reducing stroke % for better control.<br>" +
                    "At " + fixedStroke + "% stroke, set rate to <b>" + requiredRate.toFixed(1) + "%</b><br>" +
                    "Required pump output: " + requiredGPD.toFixed(3) + " GPD";
            } else {
                res.innerHTML = requiredRate.toFixed(1) + "% rate";
                stat.innerHTML = "At <b>" + fixedStroke + "% stroke</b>, set rate to <b>" + requiredRate.toFixed(1) + "%</b><br><br>" +
                    "This delivers " + requiredGPD.toFixed(3) + " GPD = " + targetLbDay.toFixed(1) + " lb/day<br>" +
                    "Pump capacity usage: " + ((requiredGPD / capacity) * 100).toFixed(0) + "%";
            }
        } else {
            res.innerText = "â€” % setting";
            stat.innerText = "Enter target lb/day and pump capacity...";
        }
    }
    
    function calcPumpDoseCheck() {
        var pumpGPD = parseFloat(document.getElementById('pump_dose_gpd').value) || 0;
        var plantMGD = parseFloat(document.getElementById('pump_dose_flow').value) || 0;
        var conc = parseFloat(document.getElementById('pump_dose_conc').value) || 100;
        var sg = parseFloat(document.getElementById('pump_dose_sg').value) || 1.0;
        
        var res = document.getElementById('pump_dose_res');
        var stat = document.getElementById('pump_dose_status');
        
        if (pumpGPD > 0 && plantMGD > 0) {
            // lb/day of product
            var lbDayProduct = pumpGPD * 8.34 * sg;
            // lb/day of active chemical
            var lbDayActive = lbDayProduct * (conc / 100);
            // mg/L = (lb/day Ã— 1,000,000) / (MGD Ã— 8.34 Ã— 1,000,000)
            // Simplified: mg/L = lb/day / (MGD Ã— 8.34)
            var mgL = lbDayActive / (plantMGD * 8.34);
            
            res.innerHTML = mgL.toFixed(2) + " mg/L";
            
            var info = "<b>Dose Calculation:</b><br>";
            info += "Pump output: " + pumpGPD.toFixed(3) + " GPD Ã— 8.34 Ã— " + sg.toFixed(2) + " = " + lbDayProduct.toFixed(2) + " lb/day product<br>";
            info += "Active chemical (" + conc + "%): " + lbDayActive.toFixed(2) + " lb/day<br>";
            info += "At " + plantMGD.toFixed(3) + " MGD: <b>" + mgL.toFixed(2) + " mg/L</b>";
            
            if (mgL < 0.5) {
                info += "<br><br>âš ï¸ <span style='color:#fbbf24;'>Very low dose</span> â€” verify pump output";
            } else if (mgL > 10) {
                info += "<br><br>âš ï¸ <span style='color:#fbbf24;'>High dose</span> â€” verify this is intended";
            }
            
            stat.innerHTML = info;
        } else {
            res.innerText = "â€” mg/L";
            stat.innerText = "Enter pump output and plant flow...";
        }
    }
    
    function calcPumpCalibration() {
        var capacity = parseFloat(document.getElementById('pump_cal_capacity').value) || 0;
        var stroke = parseFloat(document.getElementById('pump_cal_stroke').value) || 0;
        var rate = parseFloat(document.getElementById('pump_cal_rate').value) || 0;
        var testMinutes = parseFloat(document.getElementById('pump_cal_time').value) || 0;
        var actualML = parseFloat(document.getElementById('pump_cal_actual').value) || 0;
        
        var res = document.getElementById('pump_cal_res');
        var stat = document.getElementById('pump_cal_status');
        var expectedEl = document.getElementById('pump_cal_expected');
        
        if (capacity > 0 && stroke > 0 && rate > 0 && testMinutes > 0) {
            // Calculate expected output
            var gpdAt100 = capacity;
            var settingFactor = (stroke / 100) * (rate / 100);
            var actualGPD = gpdAt100 * settingFactor;
            var mlPerDay = actualGPD * 3785.41;
            var mlPerMin = mlPerDay / 1440;
            var expectedML = mlPerMin * testMinutes;
            
            expectedEl.value = expectedML.toFixed(1);
            
            if (actualML > 0) {
                var accuracy = (actualML / expectedML) * 100;
                var diff = actualML - expectedML;
                var diffPct = ((actualML - expectedML) / expectedML) * 100;
                
                res.innerHTML = accuracy.toFixed(1) + "% of expected";
                
                var info = "<b>Calibration Results:</b><br>";
                info += "Expected: " + expectedML.toFixed(1) + " mL in " + testMinutes + " min<br>";
                info += "Actual: " + actualML.toFixed(1) + " mL<br>";
                info += "Difference: " + (diff > 0 ? '+' : '') + diff.toFixed(1) + " mL (" + (diffPct > 0 ? '+' : '') + diffPct.toFixed(1) + "%)<br><br>";
                
                if (Math.abs(diffPct) <= 5) {
                    info += "âœ… <span style='color:#4ade80;'><b>PASS</b> â€” Pump is within Â±5% tolerance</span>";
                } else if (Math.abs(diffPct) <= 10) {
                    info += "âš ï¸ <span style='color:#fbbf24;'><b>MARGINAL</b> â€” " + Math.abs(diffPct).toFixed(1) + "% off, consider adjustment</span>";
                } else {
                    info += "âŒ <span style='color:#ef4444;'><b>FAIL</b> â€” " + Math.abs(diffPct).toFixed(1) + "% off, recalibration required</span>";
                    if (diffPct < 0) {
                        info += "<br>Pump is <b>under-delivering</b> â€” check for air leaks, worn diaphragm, clogged valves";
                    } else {
                        info += "<br>Pump is <b>over-delivering</b> â€” verify capacity rating, check for siphoning";
                    }
                }
                
                stat.innerHTML = info;
            } else {
                res.innerText = "â€” % accuracy";
                stat.innerHTML = "Expected output: <b>" + expectedML.toFixed(1) + " mL</b> in " + testMinutes + " min<br>Enter measured volume to compare...";
            }
        } else {
            res.innerText = "â€” % accuracy";
            stat.innerText = "Enter pump settings and test duration...";
            expectedEl.value = '';
        }
    }


    // 73. Lift Station Capacity
    function calcLiftStation() {
        var inflow = parseFloat(document.getElementById('lift_inflow').value) || 0;
        var pump = parseFloat(document.getElementById('lift_pump').value) || 0;
        var volume = parseFloat(document.getElementById('lift_volume').value) || 0;
        var avgFlow = parseFloat(document.getElementById('lift_avgflow').value) || 0;
        var res = document.getElementById('lift_res');
        var stat = document.getElementById('lift_status');
        if (inflow > 0 && pump > 0 && volume > 0) {
            var fillTime = volume / inflow;
            var pumpTime = pump > inflow ? volume / (pump - inflow) : Infinity;
            var cycleTime = fillTime + pumpTime;
            var cyclesPerHr = 60 / cycleTime;
            if (pump <= inflow) {
                res.innerHTML = "<span style='color:#ef4444'>Pump < Inflow!</span>";
                stat.innerHTML = "âš ï¸ Pump capacity must exceed inflow!";
            } else {
                res.innerHTML = cyclesPerHr.toFixed(1) + " cycles/hr";
                var info = "<b>Fill:</b> " + fillTime.toFixed(1) + " min | <b>Pump:</b> " + pumpTime.toFixed(1) + " min<br>";
                if (cyclesPerHr < 4) info += "âš ï¸ Low cycles â€” septicity risk";
                else if (cyclesPerHr > 12) info += "âš ï¸ High cycles â€” motor stress";
                else info += "âœ… Good cycle rate (4-10/hr)";
                stat.innerHTML = info;
            }
        } else { res.innerText = "â€”"; stat.innerText = "Enter data..."; }
    }

    // 74. Force Main Velocity
    function calcForceMain() {
        var flow = parseFloat(document.getElementById('fm_flow').value) || 0;
        var dia = parseFloat(document.getElementById('fm_dia').value) || 0;
        var length = parseFloat(document.getElementById('fm_length').value) || 0;
        var res = document.getElementById('fm_res');
        var stat = document.getElementById('fm_status');
        if (flow > 0 && dia > 0) {
            var vel = 0.408 * flow / (dia * dia);
            var travelHr = length > 0 ? (length / (vel * 60)) / 60 : 0;
            res.innerHTML = vel.toFixed(2) + " fps";
            var info = "<b>Velocity:</b> " + vel.toFixed(2) + " fps<br>";
            if (vel < 2) info += "âš ï¸ Below 2 fps min â€” settling risk";
            else if (vel > 8) info += "âš ï¸ Above 8 fps â€” erosion risk";
            else info += "âœ… Good range (2-8 fps)";
            if (length > 0) { info += "<br>Travel: " + (travelHr*60).toFixed(0) + " min"; if (travelHr > 4) info += " âš ï¸ Septicity"; }
            stat.innerHTML = info;
        } else { res.innerText = "â€” fps"; stat.innerText = "Enter data..."; }
    }

    // 75. Pump Drawdown
    function calcDrawdown() {
        var volume = parseFloat(document.getElementById('dd_volume').value) || 0;
        var pump = parseFloat(document.getElementById('dd_pump').value) || 0;
        var inflow = parseFloat(document.getElementById('dd_inflow').value) || 0;
        var emergency = parseFloat(document.getElementById('dd_emergency').value) || 0;
        var res = document.getElementById('dd_res');
        var stat = document.getElementById('dd_status');
        if (volume > 0 && pump > 0) {
            var net = pump - inflow;
            if (net <= 0) { res.innerHTML = "<span style='color:#ef4444'>Cannot pump down!</span>"; stat.innerHTML = "Inflow > pump rate!"; }
            else {
                var pumpTime = volume / net;
                var fillTime = inflow > 0 ? volume / inflow : 0;
                res.innerHTML = pumpTime.toFixed(1) + " min";
                var info = "<b>Pump down:</b> " + pumpTime.toFixed(1) + " min<br><b>Fill time:</b> " + fillTime.toFixed(1) + " min";
                if (emergency > 0 && inflow > 0) info += "<br><b>Emergency:</b> " + (emergency/inflow).toFixed(0) + " min";
                stat.innerHTML = info;
            }
        } else { res.innerText = "â€” min"; stat.innerText = "Enter data..."; }
    }

    // 76. Sewer Capacity
    function calcSewerCap() {
        var dia = parseFloat(document.getElementById('sc_dia').value) || 12;
        var slope = parseFloat(document.getElementById('sc_slope').value) || 0;
        var minSlopes = {8:0.004,10:0.0028,12:0.0022,15:0.0015,18:0.0012,24:0.0008};
        if (!slope) slope = minSlopes[dia] || 0.002;
        var dFt = dia/12, r = dFt/4, n = 0.013;
        var v = (1.486/n) * Math.pow(r,0.667) * Math.pow(slope,0.5);
        var area = Math.PI/4 * dFt * dFt;
        var qGpm = v * area * 448.83;
        document.getElementById('sc_res').innerHTML = qGpm.toFixed(0) + " GPM";
        document.getElementById('sc_status').innerHTML = dia + "\" @ " + (slope*100).toFixed(3) + "% = " + v.toFixed(2) + " fps, " + qGpm.toFixed(0) + " GPM";
    }

    // 77-78. OUR/SOUR
    function calcOUR() {
        var do1 = parseFloat(document.getElementById('our_do1').value) || 0;
        var do2 = parseFloat(document.getElementById('our_do2').value) || 0;
        var time = parseFloat(document.getElementById('our_time').value) || 0;
        var mlvss = parseFloat(document.getElementById('our_mlvss').value) || 0;
        var res = document.getElementById('our_res');
        var stat = document.getElementById('our_status');
        if (do1 > do2 && time > 0) {
            var our = (do1 - do2) / time * 60;
            var sour = mlvss > 0 ? (our / mlvss) * 1000 : 0;
            res.innerHTML = our.toFixed(1) + " mg/L/hr";
            var info = "<b>OUR:</b> " + our.toFixed(1) + " mg/L/hr";
            if (mlvss > 0) info += " | <b>SOUR:</b> " + sour.toFixed(1) + " mg/g/hr";
            info += "<br>" + (our < 10 ? "âš ï¸ Low activity" : our > 30 ? "âš ï¸ High activity" : "âœ… Normal");
            stat.innerHTML = info;
        } else { res.innerText = "â€” mg/L/hr"; stat.innerText = "Enter data..."; }
    }

    function calcSOUR() {
        var our = parseFloat(document.getElementById('sour_our').value) || 0;
        var mlvss = parseFloat(document.getElementById('sour_mlvss').value) || 0;
        var res = document.getElementById('sour_res');
        var stat = document.getElementById('sour_status');
        if (our > 0 && mlvss > 0) {
            var sour = (our / mlvss) * 1000;
            res.innerHTML = sour.toFixed(1) + " mg/g/hr";
            stat.innerHTML = "<b>SOUR:</b> " + sour.toFixed(1) + " | " + (sour < 3 ? "Old sludge" : sour > 25 ? "Young sludge" : "âœ… Normal 8-20");
        } else { res.innerText = "â€”"; stat.innerText = "Enter data..."; }
    }

    // 79. Settleability
    function calcSettle() {
        var ssv = parseFloat(document.getElementById('set_ssv').value) || 0;
        var mlss = parseFloat(document.getElementById('set_mlss').value) || 0;
        var res = document.getElementById('set_res');
        var stat = document.getElementById('set_status');
        if (ssv > 0 && mlss > 0) {
            var svi = (ssv * 1000) / mlss;
            res.innerHTML = "SVI = " + svi.toFixed(0);
            var info = "SSV30: " + ssv + " mL/L | SVI: " + svi.toFixed(0) + " mL/g<br>";
            info += svi < 50 ? "âš ï¸ Pin floc" : svi <= 150 ? "âœ… Good settling" : svi <= 200 ? "âš ï¸ Bulking" : "âŒ Severe bulking";
            stat.innerHTML = info;
        } else { res.innerText = "â€”"; stat.innerText = "Enter data..."; }
    }

    // 80-81. Clarifier Design
    function calcPrimClar() {
        var flow = parseFloat(document.getElementById('pc_flow').value) || 0;
        var dia = parseFloat(document.getElementById('pc_dia').value) || 0;
        var swd = parseFloat(document.getElementById('pc_swd').value) || 0;
        var weir = parseFloat(document.getElementById('pc_weir').value) || 0;
        var res = document.getElementById('pc_res');
        var stat = document.getElementById('pc_status');
        if (flow > 0 && dia > 0) {
            var area = Math.PI/4 * dia * dia;
            var sor = (flow * 1e6) / area;
            var vol = area * swd * 7.48;
            var dt = swd > 0 ? vol / (flow * 1e6 / 1440) / 60 : 0;
            res.innerHTML = "SOR: " + sor.toFixed(0) + " GPD/ftÂ²";
            var info = "SOR: " + sor.toFixed(0) + " | DT: " + dt.toFixed(1) + " hr";
            if (weir > 0) info += " | WLR: " + ((flow*1e6)/weir).toFixed(0);
            info += "<br>" + (sor >= 600 && sor <= 1200 ? "âœ… SOR OK" : "âš ï¸ Check SOR 600-1200");
            stat.innerHTML = info;
        } else { res.innerText = "â€”"; stat.innerText = "Enter data..."; }
    }

    function calcSecClar() {
        var flow = parseFloat(document.getElementById('sc2_flow').value) || 0;
        var ras = parseFloat(document.getElementById('sc2_ras').value) || 0;
        var dia = parseFloat(document.getElementById('sc2_dia').value) || 0;
        var mlss = parseFloat(document.getElementById('sc2_mlss').value) || 0;
        var res = document.getElementById('sc2_res');
        var stat = document.getElementById('sc2_status');
        if (flow > 0 && dia > 0) {
            var area = Math.PI/4 * dia * dia;
            var sor = (flow * 1e6) / area;
            var slr = mlss > 0 ? ((flow + ras) * mlss * 8.34) / area : 0;
            res.innerHTML = "SOR: " + sor.toFixed(0) + " GPD/ftÂ²";
            var info = "SOR: " + sor.toFixed(0) + " | SLR: " + slr.toFixed(1) + " lb/d/ftÂ²<br>";
            info += (sor >= 400 && sor <= 800 ? "âœ… SOR OK" : "âš ï¸ Check 400-800");
            stat.innerHTML = info;
        } else { res.innerText = "â€”"; stat.innerText = "Enter data..."; }
    }

    // 82. Grit Chamber
    function calcGrit() {
        var flow = parseFloat(document.getElementById('grit_flow').value) || 0;
        var dt = parseFloat(document.getElementById('grit_dt').value) || 0;
        var res = document.getElementById('grit_res');
        var stat = document.getElementById('grit_status');
        if (flow > 0 && dt > 0) {
            var volGal = (flow * 1e6 / 1440) * dt;
            res.innerHTML = (volGal/7.48).toFixed(0) + " ftÂ³";
            stat.innerHTML = "Volume: " + volGal.toFixed(0) + " gal (" + (volGal/7.48).toFixed(0) + " ftÂ³) at " + dt + " min DT";
        } else { res.innerText = "â€”"; stat.innerText = "Enter data..."; }
    }

    // 83. Chlorine Contact
    function calcCCC() {
        var flow = parseFloat(document.getElementById('ccc_flow').value) || 0;
        var time = parseFloat(document.getElementById('ccc_time').value) || 0;
        var cl2 = parseFloat(document.getElementById('ccc_cl2').value) || 0;
        var bf = parseFloat(document.getElementById('ccc_bf').value) || 0.7;
        var res = document.getElementById('ccc_res');
        var stat = document.getElementById('ccc_status');
        if (flow > 0 && time > 0) {
            var vol = (flow * 1e6 / 1440) * time / bf;
            var ct = cl2 * time;
            res.innerHTML = vol.toFixed(0) + " gal";
            stat.innerHTML = "Required: " + vol.toFixed(0) + " gal (BF=" + bf + ")" + (cl2 > 0 ? " | CT=" + ct.toFixed(0) : "");
        } else { res.innerText = "â€”"; stat.innerText = "Enter data..."; }
    }

    // 84-85. Dewatering
    function calcBFP() {
        var flow = parseFloat(document.getElementById('bfp_flow').value) || 0;
        var feed = parseFloat(document.getElementById('bfp_feed').value) || 0;
        var width = parseFloat(document.getElementById('bfp_width').value) || 0;
        var res = document.getElementById('bfp_res');
        var stat = document.getElementById('bfp_status');
        if (flow > 0 && feed > 0 && width > 0) {
            var hydLoad = flow / width;
            var solLoad = flow * 8.34 * (feed/100) * 60 / width;
            res.innerHTML = solLoad.toFixed(0) + " lb/hr/m";
            stat.innerHTML = "Hydraulic: " + hydLoad.toFixed(0) + " GPM/m | Solids: " + solLoad.toFixed(0) + " lb/hr/m";
        } else { res.innerText = "â€”"; stat.innerText = "Enter data..."; }
    }

    function calcCentrifuge() {
        var feed = parseFloat(document.getElementById('cent_feed').value) || 0;
        var centrate = parseFloat(document.getElementById('cent_centrate').value) || 0;
        var res = document.getElementById('cent_res');
        var stat = document.getElementById('cent_status');
        if (feed > 0) {
            var capture = ((feed*10000 - centrate) / (feed*10000)) * 100;
            res.innerHTML = capture.toFixed(1) + "% capture";
            stat.innerHTML = "Capture: " + capture.toFixed(1) + "% | " + (capture >= 95 ? "âœ… Excellent" : capture >= 90 ? "OK" : "âš ï¸ Poor");
        } else { res.innerText = "â€”"; stat.innerText = "Enter data..."; }
    }

    // 86. Drying Beds
    function calcDryBed() {
        var prod = parseFloat(document.getElementById('db_prod').value) || 0;
        var load = parseFloat(document.getElementById('db_load').value) || 0;
        var res = document.getElementById('db_res');
        var stat = document.getElementById('db_status');
        if (prod > 0 && load > 0) {
            var area = (prod * 365) / load;
            res.innerHTML = area.toFixed(0) + " ftÂ²";
            stat.innerHTML = "Required: " + area.toFixed(0) + " ftÂ² (" + (area/43560).toFixed(2) + " acres) at " + load + " lb/ftÂ²/yr";
        } else { res.innerText = "â€”"; stat.innerText = "Enter data..."; }
    }

    // 87. Hauling Cost
    function calcHauling() {
        var ds = parseFloat(document.getElementById('haul_ds').value) || 0;
        var cake = parseFloat(document.getElementById('haul_cake').value) || 0;
        var haulCost = parseFloat(document.getElementById('haul_cost').value) || 0;
        var dispCost = parseFloat(document.getElementById('haul_disp').value) || 0;
        var res = document.getElementById('haul_res');
        var stat = document.getElementById('haul_status');
        if (ds > 0 && cake > 0) {
            var wetTon = (ds / (cake/100)) / 2000;
            var costDay = wetTon * (haulCost + dispCost);
            res.innerHTML = "$" + (costDay*30).toFixed(0) + "/mo";
            stat.innerHTML = wetTon.toFixed(1) + " wet tons/day | $" + costDay.toFixed(0) + "/day | $" + (costDay*365/1000).toFixed(0) + "K/yr";
        } else { res.innerText = "â€”"; stat.innerText = "Enter data..."; }
    }

    // 88. Pathogen Reduction
    function calcPathogen() {
        var cls = document.getElementById('path_class').value;
        var method = document.getElementById('path_method').value;
        var temp = parseFloat(document.getElementById('path_temp').value) || 0;
        var res = document.getElementById('path_res');
        var stat = document.getElementById('path_status');
        var info = "<b>Class " + cls + ":</b> ";
        if (cls === 'A') {
            info += "FC <1,000/g OR Salm <3/4g<br>";
            if (method === 'thermo' && temp >= 131) info += "âœ… Thermo >131Â°F qualifies";
            else if (method === 'heat' && temp >= 176) info += "âœ… Heat drying qualifies";
            else info += "âš ï¸ Verify PFRP compliance";
            res.innerHTML = cls === 'A' ? "Class A PFRP" : "Class B";
        } else {
            info += "FC <2,000,000/g + site restrictions";
            res.innerHTML = "Class B PSRP";
        }
        stat.innerHTML = info;
    }

    // 89. BOD Dilution
    function calcBODDilution() {
        var expected = parseFloat(document.getElementById('bod_expected').value) || 0;
        var bottle = parseFloat(document.getElementById('bod_bottle').value) || 300;
        var do1 = parseFloat(document.getElementById('bod_do1').value) || 0;
        var do2 = parseFloat(document.getElementById('bod_do2').value) || 0;
        var res = document.getElementById('bod_res');
        var stat = document.getElementById('bod_status');
        if (expected > 0) {
            var vol = Math.min(Math.max((4 * bottle) / expected, 1), bottle);
            res.innerHTML = vol.toFixed(0) + " mL";
            stat.innerHTML = "Use " + vol.toFixed(0) + " mL sample (target 4 mg/L depletion)<br>Backups: " + (vol*0.5).toFixed(0) + " mL, " + Math.min(vol*2,bottle).toFixed(0) + " mL";
        } else if (do1 > 0 && do2 > 0) {
            var depl = do1 - do2;
            res.innerHTML = depl.toFixed(1) + " mg/L";
            stat.innerHTML = "Depletion: " + depl.toFixed(1) + " | " + (depl >= 2 && do2 >= 1 ? "âœ… Valid" : "âš ï¸ Invalid");
        } else { res.innerText = "â€”"; stat.innerText = "Enter data..."; }
    }

    // 90. Composite Sample
    function calcComposite() {
        var interval = parseFloat(document.getElementById('comp_interval').value) || 0;
        var total = parseFloat(document.getElementById('comp_total').value) || 0;
        var period = parseFloat(document.getElementById('comp_period').value) || 24;
        var res = document.getElementById('comp_res');
        var stat = document.getElementById('comp_status');
        if (interval > 0 && total > 0) {
            var n = Math.floor(period / interval);
            var vol = total / n;
            res.innerHTML = n + " samples @ " + vol.toFixed(0) + " mL";
            stat.innerHTML = "Equal-volume: " + n + " aliquots Ã— " + vol.toFixed(0) + " mL = " + total + " mL total";
        } else { res.innerText = "â€”"; stat.innerText = "Enter data..."; }
    }

    // 69. Hypochlorite Dosing Calculator
    function calcHypoDose() {
        var app = document.getElementById('hypo_app').value;
        var chemType = document.getElementById('hypo_type').value;
        var pctAvail = parseFloat(document.getElementById('hypo_pct').value) || 0;
        var flow = parseFloat(document.getElementById('hypo_flow').value) || 0;
        var dose = parseFloat(document.getElementById('hypo_dose').value) || 0;
        var sg = parseFloat(document.getElementById('hypo_sg').value) || 1.16;
        
        // Show/hide RAS inputs
        var rasInputs = document.getElementById('rasInputs');
        rasInputs.style.display = app === 'ras' ? 'block' : 'none';
        
        // Update defaults based on chemical type
        if (chemType === 'calcium') {
            if (pctAvail === 12.5 || pctAvail === 10) {
                document.getElementById('hypo_pct').value = 65;
                pctAvail = 65;
            }
            document.getElementById('hypo_sg').parentElement.style.display = 'none';
        } else {
            document.getElementById('hypo_sg').parentElement.style.display = 'block';
        }
        
        var res = document.getElementById('hypo_res');
        var stat = document.getElementById('hypo_status');
        
        var lbsCl2PerDay = 0;
        var info = "";
        
        if (app === 'ras') {
            // RAS Chlorination calculation
            var mlss = parseFloat(document.getElementById('hypo_mlss').value) || 0;
            var vol = parseFloat(document.getElementById('hypo_vol').value) || 0;
            var rasDose = parseFloat(document.getElementById('hypo_rasdose').value) || 5;
            
            if (mlss > 0 && vol > 0 && pctAvail > 0) {
                // lbs MLSS in system = vol (MG) Ã— MLSS (mg/L) Ã— 8.34
                var lbsMLSS = vol * mlss * 8.34;
                // lbs Clâ‚‚/day = (lbs MLSS / 1000) Ã— dose rate
                lbsCl2PerDay = (lbsMLSS / 1000) * rasDose;
                
                info = "<b>RAS Chlorination Calculation:</b><br>" +
                    "MLSS in system: " + vol + " MG Ã— " + mlss + " mg/L Ã— 8.34 = <b>" + lbsMLSS.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs MLSS</b><br>" +
                    "Clâ‚‚ required: (" + lbsMLSS.toFixed(0) + " Ã· 1000) Ã— " + rasDose + " = <b>" + lbsCl2PerDay.toFixed(1) + " lbs Clâ‚‚/day</b>";
            }
        } else {
            // Effluent disinfection calculation
            if (flow > 0 && dose > 0 && pctAvail > 0) {
                // lbs Clâ‚‚/day = Flow Ã— Dose Ã— 8.34
                lbsCl2PerDay = flow * dose * 8.34;
                
                info = "<b>Chlorine Demand Calculation:</b><br>" +
                    flow + " MGD Ã— " + dose + " mg/L Ã— 8.34 = <b>" + lbsCl2PerDay.toFixed(1) + " lbs Clâ‚‚/day</b>";
            }
        }
        
        if (lbsCl2PerDay > 0 && pctAvail > 0) {
            // Calculate product required
            var lbsProduct = lbsCl2PerDay / (pctAvail / 100);
            
            info += "<br><br><b>Product Required:</b><br>" +
                lbsCl2PerDay.toFixed(1) + " lbs Clâ‚‚ Ã· " + pctAvail + "% = <b>" + lbsProduct.toFixed(1) + " lbs " + (chemType === 'liquid' ? 'bleach' : 'cal-hypo') + "/day</b>";
            
            var resultText = lbsCl2PerDay.toFixed(1) + " lbs Clâ‚‚/day â†’ <b>" + lbsProduct.toFixed(1) + " lbs product/day</b>";
            
            // For liquid, also calculate gallons
            if (chemType === 'liquid') {
                var galsPerDay = lbsProduct / (8.34 * sg);
                var lbsCl2PerGal = (pctAvail / 100) * 8.34 * sg;
                
                info += "<br>" + lbsProduct.toFixed(1) + " lbs Ã· (8.34 Ã— " + sg + " SG) = <b>" + galsPerDay.toFixed(1) + " gal/day</b>";
                info += "<br><br><div style='display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;'>" +
                    "<div style='background:#1e293b;padding:10px;border-radius:6px;text-align:center;'>" +
                    "<div style='color:#94a3b8;font-size:0.65rem;'>Clâ‚‚ REQUIRED</div><div style='font-size:1.1rem;font-weight:bold;color:#22d3ee;'>" + lbsCl2PerDay.toFixed(1) + "</div><div style='font-size:0.65rem;color:#64748b;'>lbs/day</div></div>" +
                    "<div style='background:#1e293b;padding:10px;border-radius:6px;text-align:center;'>" +
                    "<div style='color:#94a3b8;font-size:0.65rem;'>BLEACH</div><div style='font-size:1.1rem;font-weight:bold;color:#4ade80;'>" + galsPerDay.toFixed(1) + "</div><div style='font-size:0.65rem;color:#64748b;'>gal/day</div></div>" +
                    "<div style='background:#1e293b;padding:10px;border-radius:6px;text-align:center;'>" +
                    "<div style='color:#94a3b8;font-size:0.65rem;'>Clâ‚‚/GALLON</div><div style='font-size:1.1rem;font-weight:bold;color:#fbbf24;'>" + lbsCl2PerGal.toFixed(2) + "</div><div style='font-size:0.65rem;color:#64748b;'>lbs Clâ‚‚/gal</div></div></div>";
                
                resultText = lbsCl2PerDay.toFixed(1) + " lbs Clâ‚‚/day â†’ <b>" + galsPerDay.toFixed(1) + " gal bleach/day</b>";
                
                // GPH and mL/min for pump setting
                var gph = galsPerDay / 24;
                var mlPerMin = (galsPerDay * 3785) / 1440;
                info += "<br><b>Pump Setting:</b> " + gph.toFixed(2) + " GPH | " + mlPerMin.toFixed(0) + " mL/min";
            } else {
                // Cal-hypo - show lbs only
                info += "<br><br><div style='display:grid;grid-template-columns:1fr 1fr;gap:6px;'>" +
                    "<div style='background:#1e293b;padding:10px;border-radius:6px;text-align:center;'>" +
                    "<div style='color:#94a3b8;font-size:0.65rem;'>Clâ‚‚ REQUIRED</div><div style='font-size:1.1rem;font-weight:bold;color:#22d3ee;'>" + lbsCl2PerDay.toFixed(1) + "</div><div style='font-size:0.65rem;color:#64748b;'>lbs/day</div></div>" +
                    "<div style='background:#1e293b;padding:10px;border-radius:6px;text-align:center;'>" +
                    "<div style='color:#94a3b8;font-size:0.65rem;'>CAL-HYPO</div><div style='font-size:1.1rem;font-weight:bold;color:#4ade80;'>" + lbsProduct.toFixed(1) + "</div><div style='font-size:0.65rem;color:#64748b;'>lbs/day</div></div></div>";
            }
            
            // Monthly usage
            var monthlyLbs = lbsProduct * 30;
            info += "<br><b>Monthly Usage:</b> ~" + monthlyLbs.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs/month";
            if (chemType === 'liquid') {
                var monthlyGal = (lbsProduct / (8.34 * sg)) * 30;
                info += " (~" + monthlyGal.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " gal/month)";
            }
            
            res.innerHTML = resultText;
            stat.innerHTML = info;
            stat.style.color = "#94a3b8";
        } else {
            res.innerText = "â€”";
            stat.innerText = "Enter flow, dose, and chemical strength...";
        }
    }

    // ==================== PWA ====================
    let deferredPrompt;
    
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .catch(err => console.log('SW error:', err));
        });
    }

    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        document.getElementById('installPrompt').style.display = 'flex';
    });

    function installApp() {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then(() => {
                deferredPrompt = null;
                document.getElementById('installPrompt').style.display = 'none';
            });
        }
    }

    function dismissInstall() {
        document.getElementById('installPrompt').style.display = 'none';
    }

    // Refresh app - clear cache and reload
    function refreshApp() {
        showToast('Checking for updates...', '');
        vibrate();
        
        if ('serviceWorker' in navigator && 'caches' in window) {
            // Clear all caches
            caches.keys().then(names => {
                names.forEach(name => caches.delete(name));
            });
            
            // Unregister service worker and reload
            navigator.serviceWorker.getRegistrations().then(registrations => {
                registrations.forEach(registration => registration.unregister());
            }).then(() => {
                setTimeout(() => {
                    window.location.reload(true);
                }, 500);
            });
        } else {
            window.location.reload(true);
        }
    }

    // ==================== HOW TO USE GUIDES (JS-injected) ====================
    var guideData = {
        1: { color:'#3b82f6', title:'POUNDS FORMULA', content:
            '<b>What This Calculates</b><br>Converts concentration (mg/L) to mass loading (lbs/day). This is THE fundamental formula in wastewater â€” every other calculation builds on it. If you only memorize one formula for the TCEQ exam, memorize this one.' +
            '<div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:6px 0"><b>Flow (MGD)</b> â€” Average daily flow in million gallons per day. Get from your plant flow meter or monthly DMR.<br><b>Concentration (mg/L)</b> â€” From your lab results: BOD, TSS, NHâ‚ƒ, whatever parameter you need.</div>' +
            '<div style="background:rgba(59,130,246,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #3b82f6"><b>lbs/day = Flow (MGD) Ã— Concentration (mg/L) Ã— 8.34</b><br>â€¢ 8.34 = weight of 1 gallon of water in lbs<br>â€¢ Works for ANY parameter: BOD, TSS, NHâ‚ƒ, POâ‚„, chlorine<br>â€¢ To get lbs/hr: divide by 24<br>â€¢ Exam will sometimes give flow in GPD â€” convert to MGD first (Ã· 1,000,000)</div>' },
        2: { color:'#3b82f6', title:'SVI â€” SLUDGE VOLUME INDEX', content:
            '<b>What This Calculates</b><br>SVI measures how well your activated sludge settles. Lower SVI = denser, better-settling sludge. It\'s the volume (mL) occupied by 1 gram of sludge after 30 minutes of settling.' +
            '<div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:6px 0"><b>Settled Volume (mL)</b> â€” Read from a 1-liter settleometer after exactly 30 minutes. No stirring.<br><b>MLSS (mg/L)</b> â€” Mixed liquor suspended solids from lab.</div>' +
            '<div style="background:rgba(59,130,246,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #3b82f6"><b>SVI = (Settled Vol mL Ã— 1000) Ã· MLSS mg/L</b><br>â€¢ Good settling: 80â€“150 mL/g<br>â€¢ Bulking sludge: >150 (filamentous, light, fluffy)<br>â€¢ Pin floc/old sludge: <80 (too dense, turbid effluent)<br>â€¢ SVI >300 = severe bulking â€” check for filamentous organisms</div>' },
        3: { color:'#3b82f6', title:'MASS BALANCE', content:
            '<b>What This Calculates</b><br>Calculates the resulting concentration when two flows of different concentrations mix together. Common uses: RAS + influent mixing, chemical blending, sidestream return impact.' +
            '<div style="background:rgba(59,130,246,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #3b82f6"><b>C_mix = (Qâ‚Ã—Câ‚ + Qâ‚‚Ã—Câ‚‚) Ã· (Qâ‚ + Qâ‚‚)</b><br>â€¢ This is a weighted average by flow<br>â€¢ Works for any parameter: TSS, BOD, temperature<br>â€¢ Common exam problem: "What is the MLSS in the aeration basin when RAS mixes with influent?"</div>' },
        4: { color:'#10b981', title:'F:M RATIO', content:
            '<b>What This Calculates</b><br>Food-to-Microorganism ratio â€” how much "food" (BOD) you\'re feeding your bugs (MLSS) each day. THE primary process control parameter for activated sludge. Think of it as the menu portion size for your microorganisms.' +
            '<div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:6px 0"><b>Flow (MGD)</b> â€” Plant influent flow<br><b>BOD (mg/L)</b> â€” Influent (or primary effluent) BOD<br><b>Aeration Volume (MG)</b> â€” Total volume of aeration basins. Use Calc #66 if needed.<br><b>MLSS (mg/L)</b> â€” Mixed liquor suspended solids in aeration basin</div>' +
            '<div style="background:rgba(16,185,129,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #10b981"><b>F:M = (Flow Ã— BOD Ã— 8.34) Ã· (Vol Ã— MLSS Ã— 8.34)</b><br>â€¢ Conventional AS: 0.2â€“0.5<br>â€¢ Extended aeration: 0.05â€“0.15<br>â€¢ Contact stab: 0.2â€“0.6<br>â€¢ High F:M = young, active sludge (good settling but less treatment)<br>â€¢ Low F:M = old sludge (great treatment but may bulk)<br>â€¢ Adjust F:M by changing WAS rate</div>' },
        5: { color:'#10b981', title:'SRT â€” SLUDGE AGE', content:
            '<b>What This Calculates</b><br>Solids Retention Time â€” the average number of days a microorganism stays in the system. Controls which organisms can grow: nitrifiers need >8 days SRT. This is your second most important process control parameter after F:M.' +
            '<div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:6px 0"><b>Aeration Volume (MG)</b> â€” Total aeration basin volume<br><b>MLSS (mg/L)</b> â€” Mixed liquor concentration<br><b>WAS Flow & TSS</b> â€” Waste sludge flow rate and concentration<br><b>Effluent Flow & TSS</b> â€” Final effluent (solids lost over the weir)</div>' +
            '<div style="background:rgba(16,185,129,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #10b981"><b>SRT = (Vol Ã— MLSS Ã— 8.34) Ã· [(WAS Q Ã— WAS TSS Ã— 8.34) + (Eff Q Ã— Eff TSS Ã— 8.34)]</b><br>â€¢ Conventional AS: 5â€“15 days<br>â€¢ Extended aeration: 20â€“40 days<br>â€¢ For nitrification: MUST be >8 days (>12 in cold weather)<br>â€¢ Increase SRT â†’ decrease WAS rate. Decrease SRT â†’ increase WAS rate.</div>' },
        6: { color:'#3b82f6', title:'DETENTION TIME', content:
            '<b>What This Calculates</b><br>How long water stays in a tank or process. Critical for disinfection (CT), sedimentation, biological treatment, and chemical reactions. Also called HRT (Hydraulic Retention Time).' +
            '<div style="background:rgba(59,130,246,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #3b82f6"><b>DT = Volume Ã· Flow</b> (match units!)<br>â€¢ Gallons Ã· GPD = days | Gallons Ã· GPM = minutes<br>â€¢ To convert days â†’ hours: Ã— 24 | hours â†’ minutes: Ã— 60<br>â€¢ Primary clarifier: 1.5â€“2.5 hrs<br>â€¢ Aeration basin: 4â€“8 hrs (conventional), 18â€“36 hrs (extended aeration)<br>â€¢ Chlorine contact: 15â€“30 min at peak flow</div>' },
        7: { color:'#3b82f6', title:'REMOVAL EFFICIENCY', content:
            '<b>What This Calculates</b><br>Percent removal of any parameter through a process. Used for permit compliance reporting and process performance tracking.' +
            '<div style="background:rgba(59,130,246,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #3b82f6"><b>% Removal = [(Influent âˆ’ Effluent) Ã· Influent] Ã— 100</b><br>â€¢ Typical BOD removal: 85â€“95%<br>â€¢ Typical TSS removal: 85â€“95%<br>â€¢ NHâ‚ƒ removal (with nitrification): >95%<br>â€¢ Primary clarifier BOD removal: 25â€“40%<br>â€¢ TCEQ permits often require â‰¥85% BOD & TSS removal</div>' },
        8: { color:'#10b981', title:'WAS PUMPING RATE', content:
            '<b>What This Calculates</b><br>Required waste activated sludge flow rate to maintain your target SRT. Wasting is the #1 process control tool â€” it\'s how you control SRT, F:M, MLSS, and sludge age all at once.' +
            '<div style="background:rgba(16,185,129,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #10b981"><b>WAS (GPD) = (Vol Ã— MLSS Ã— 8.34) Ã· (Target SRT Ã— WAS TSS Ã— 8.34)</b><br>â€¢ Simplified: WAS GPD = (Vol MG Ã— MLSS) Ã· (SRT Ã— WAS TSS)<br>â€¢ Convert to GPM: Ã· 1440<br>â€¢ Adjust WAS daily based on SRT trending<br>â€¢ Sudden increase in WAS needed may indicate solids washout or growth</div>' },
        9: { color:'#10b981', title:'RAS RETURN RATE', content:
            '<b>What This Calculates</b><br>Return Activated Sludge flow rate â€” recirculates settled sludge from the clarifier back to the aeration basin to maintain MLSS concentration.' +
            '<div style="background:rgba(16,185,129,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #10b981"><b>Settleability method: RAS % = (SVâ‚ƒâ‚€ Ã· (1000 âˆ’ SVâ‚ƒâ‚€)) Ã— 100</b><br>â€¢ SVâ‚ƒâ‚€ = 30-min settled volume in mL per 1000 mL<br>â€¢ Typical RAS rate: 25â€“100% of influent flow<br>â€¢ Too low RAS â†’ sludge blanket rises in clarifier â†’ solids washout<br>â€¢ Too high RAS â†’ short-circuits clarifier, resuspends settled solids<br>â€¢ Watch sludge blanket depth: keep >2 ft below weir</div>' },
        10: { color:'#3b82f6', title:'ORGANIC LOADING RATE', content:
            '<b>What This Calculates</b><br>BOD applied per unit volume of treatment process. Used for aeration basins, trickling filters, and RBCs. Tells you if your process is overloaded or underloaded.' +
            '<div style="background:rgba(59,130,246,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #3b82f6"><b>OLR = (Flow Ã— BOD Ã— 8.34) Ã· Volume (1000 ftÂ³ or MG)</b><br>â€¢ Conventional AS: 20â€“40 lbs BOD/1000 ftÂ³/day<br>â€¢ Extended aeration: 10â€“25 lbs BOD/1000 ftÂ³/day<br>â€¢ Trickling filter: 15â€“30 lbs BOD/1000 ftÂ³/day (low rate) to 40â€“100 (high rate)<br>â€¢ Overloading causes DO depletion, odors, poor treatment</div>' },
        11: { color:'#3b82f6', title:'SURFACE OVERFLOW RATE', content:
            '<b>What This Calculates</b><br>Flow per unit surface area of a clarifier. THE primary clarifier design parameter â€” determines settling performance.' +
            '<div style="background:rgba(59,130,246,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #3b82f6"><b>SOR = Flow (GPD) Ã· Surface Area (ftÂ²)</b><br>â€¢ Primary clarifier: 600â€“1200 GPD/ftÂ²<br>â€¢ Secondary clarifier: 400â€“800 GPD/ftÂ²<br>â€¢ Area = Ï€/4 Ã— DÂ² for circular<br>â€¢ Higher SOR = less settling time = more solids carryover<br>â€¢ TCEQ exam loves this one â€” watch units!</div>' },
        12: { color:'#3b82f6', title:'WEIR OVERFLOW RATE', content:
            '<b>What This Calculates</b><br>Flow per linear foot of effluent weir. High WOR causes turbulence that resuspends settled solids near the weir.' +
            '<div style="background:rgba(59,130,246,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #3b82f6"><b>WOR = Flow (GPD) Ã· Weir Length (ft)</b><br>â€¢ Design max: 10,000â€“20,000 GPD/ft<br>â€¢ For circular clarifiers: Weir length = Ï€ Ã— Diameter<br>â€¢ V-notch weirs give better flow distribution than flat weirs<br>â€¢ Double-sided weir troughs = double the weir length</div>' },
        13: { color:'#3b82f6', title:'SOLIDS LOADING RATE', content:
            '<b>What This Calculates</b><br>Total solids applied per unit area of the clarifier. More important than SOR for secondary clarifiers because it accounts for RAS solids recycling.' +
            '<div style="background:rgba(59,130,246,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #3b82f6"><b>SLR = [(Q + Q_RAS) Ã— MLSS Ã— 8.34] Ã· Area (ftÂ²)</b><br>â€¢ Design: 20â€“30 lbs/ftÂ²/day (conventional)<br>â€¢ Peak: <50 lbs/ftÂ²/day<br>â€¢ High SLR â†’ rising sludge blanket â†’ solids in effluent<br>â€¢ SLR is often the limiting factor, not SOR</div>' },
        14: { color:'#3b82f6', title:'CHEMICAL DOSING', content:
            '<b>What This Calculates</b><br>Feed rate for any chemical: chlorine, alum, polymer, lime, permanganate. Converts target dose (mg/L) to actual lbs/day or gal/day of chemical product.' +
            '<div style="background:#1e293b;border-radius:6px;padding:8px 10px;margin:6px 0"><b>Flow (MGD)</b> â€” Treatment flow<br><b>Dose (mg/L)</b> â€” Target concentration<br><b>Chemical Strength (%)</b> â€” Product purity/strength. 12.5% sodium hypochlorite, 48% alum, 100% for dry chemicals.</div>' +
            '<div style="background:rgba(59,130,246,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #3b82f6"><b>lbs/day = (Flow Ã— Dose Ã— 8.34) Ã· (% Strength as decimal)</b><br>â€¢ For liquid chemicals: GPD = lbs/day Ã· (8.34 Ã— specific gravity)<br>â€¢ 12.5% NaOCl has SG â‰ˆ 1.17<br>â€¢ 48% alum has SG â‰ˆ 1.33<br>â€¢ Dry chemicals: lbs/day = Flow Ã— Dose Ã— 8.34 (strength = 100%)</div>' },
        15: { color:'#8b5cf6', title:'MEMBRANE FLUX RATE', content:
            '<b>What This Calculates</b><br>Permeate flow per unit membrane area. THE primary MBR performance indicator. Track daily to detect fouling trends before they become emergencies.' +
            '<div style="background:rgba(139,92,246,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #8b5cf6"><b>Flux = Permeate Flow (GPD) Ã· Membrane Area (ftÂ²)</b><br>â€¢ Typical MBR flux: 10â€“20 GFD (gallons/ftÂ²/day)<br>â€¢ Also expressed as LMH (liters/mÂ²/hr): GFD Ã— 1.70 = LMH<br>â€¢ Declining flux at constant TMP = fouling<br>â€¢ Stable flux with rising TMP = also fouling<br>â€¢ Net flux accounts for backwash; gross flux does not</div>' },
        22: { color:'#06b6d4', title:'MBBR â€” SURFACE AREA LOADING RATE', content:
            '<b>What This Calculates</b><br>SALR is the MBBR equivalent of F:M â€” organic or nitrogen load per unit of biofilm surface area. This is the fundamental MBBR design parameter.' +
            '<div style="background:rgba(6,182,212,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #06b6d4"><b>SALR = (Flow Ã— Conc Ã— 8.34) Ã· Biofilm Area (mÂ² or 1000 ftÂ²)</b><br>â€¢ BOD SALR: 3â€“10 g/mÂ²/day (typical municipal)<br>â€¢ NHâ‚ƒ SALR: 0.5â€“2.0 g/mÂ²/day (nitrification)<br>â€¢ Higher SALR = higher loading = need more DO<br>â€¢ Design at the target SALR for your treatment goal</div>' },
        35: { color:'#eab308', title:'DECHLORINATION DOSING', content:
            '<b>What This Calculates</b><br>Required sodium bisulfite or sulfur dioxide dose to neutralize chlorine residual before discharge. Most TPDES permits require <0.1 mg/L Clâ‚‚ in effluent.' +
            '<div style="background:rgba(234,179,8,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #eab308"><b>Stoichiometry:</b> 1.0 mg/L Clâ‚‚ requires:<br>â€¢ 1.46 mg/L sodium bisulfite (NaHSOâ‚ƒ)<br>â€¢ 0.90 mg/L sulfur dioxide (SOâ‚‚)<br>â€¢ 1.34 mg/L sodium sulfite (Naâ‚‚SOâ‚ƒ)<br>â€¢ Always overdose slightly (1.1Ã— stoichiometric) for safety margin<br>â€¢ Too much dechlorination = DO depression in effluent</div>' },
        36: { color:'#eab308', title:'UV DOSE', content:
            '<b>What This Calculates</b><br>UV disinfection dose in mJ/cmÂ². No chemical residual to remove â€” increasingly popular alternative to chlorine.' +
            '<div style="background:rgba(234,179,8,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #eab308"><b>UV Dose = Intensity (mW/cmÂ²) Ã— Contact Time (seconds)</b><br>â€¢ Typical WW dose: 30â€“80 mJ/cmÂ²<br>â€¢ Turbidity and TSS reduce UV penetration<br>â€¢ Lamp aging reduces output â€” track lamp hours<br>â€¢ Clean quartz sleeves regularly for consistent performance</div>' },
        37: { color:'#a855f7', title:'SLUDGE VOLUME & % SOLIDS', content:
            '<b>What This Calculates</b><br>Converts between sludge volume, weight, and % solids. Essential for hauling, disposal, and dewatering calculations.' +
            '<div style="background:rgba(168,85,247,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #a855f7"><b>Dry Solids (lbs) = Wet Volume (gal) Ã— 8.34 Ã— (% Solids Ã· 100)</b><br>â€¢ WAS from clarifier: 0.5â€“1.5% solids<br>â€¢ Thickened WAS: 3â€“6%<br>â€¢ Belt press cake: 15â€“25%<br>â€¢ Centrifuge cake: 18â€“30%<br>â€¢ 1 dry ton = 2,000 lbs dry solids</div>' },
        38: { color:'#a855f7', title:'VOLATILE SOLIDS REDUCTION', content:
            '<b>What This Calculates</b><br>Percent destruction of volatile (organic) solids through digestion. Must achieve â‰¥38% VSR for Class B biosolids under 40 CFR 503.' +
            '<div style="background:rgba(168,85,247,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #a855f7"><b>% VSR = [(VS_in âˆ’ VS_out) Ã· VS_in] Ã— 100</b><br>â€¢ Or Van Kleeck formula: % VSR = [(% VS_in âˆ’ % VS_out) Ã· (% VS_in Ã— (1 âˆ’ % VS_out/100))] Ã— 100<br>â€¢ Class B requirement: â‰¥38% VSR (or equivalent)<br>â€¢ Typical aerobic digestion: 35â€“50%<br>â€¢ Typical anaerobic digestion: 45â€“55%<br>â€¢ Exam almost always uses Van Kleeck â€” memorize it</div>' },
        39: { color:'#a855f7', title:'DIGESTER LOADING RATE', content:
            '<b>What This Calculates</b><br>Volatile solids loading to a digester in lbs VS/ftÂ³/day. Overloading causes acid buildup, pH drop, and digester failure.' +
            '<div style="background:rgba(168,85,247,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #a855f7"><b>Loading = (VS lbs/day) Ã· Digester Volume (ftÂ³)</b><br>â€¢ Anaerobic: 0.04â€“0.10 lbs VS/ftÂ³/day (standard rate), 0.15â€“0.40 (high rate)<br>â€¢ Aerobic: 0.1â€“0.3 lbs VS/ftÂ³/day<br>â€¢ Monitor: pH, alkalinity, VFA, gas production<br>â€¢ VFA:Alk ratio >0.5 = stressed digester</div>' },
        40: { color:'#a855f7', title:'POLYMER DOSING', content:
            '<b>What This Calculates</b><br>Polymer dose for sludge conditioning before dewatering. Expressed in lbs polymer per dry ton of solids or mg/L of sludge.' +
            '<div style="background:rgba(168,85,247,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #a855f7"><b>lbs polymer/DT = (dose mg/L Ã— sludge flow GPD Ã— 8.34) Ã· (dry solids lbs/day)</b><br>â€¢ Typical dose: 5â€“15 lbs active polymer/DT<br>â€¢ Emulsion polymer (30â€“40% active): adjust for strength<br>â€¢ Jar test to optimize dose â€” overdosing wastes money and can impair dewatering<br>â€¢ Cationic polymers are most common for WW sludge</div>' },
        41: { color:'#22c55e', title:'PHOSPHORUS REMOVAL', content:
            '<b>What This Calculates</b><br>Chemical dose for phosphorus precipitation using alum or ferric chloride. P removal is increasingly required as nutrient limits tighten.' +
            '<div style="background:rgba(34,197,94,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #22c55e"><b>Molar ratios (metal:P):</b><br>â€¢ Alum (Al): 1.5â€“3.0 mol Al per mol P (typical 2.0)<br>â€¢ Ferric (Fe): 1.5â€“3.0 mol Fe per mol P (typical 2.5)<br>â€¢ Higher ratios = more removal but more sludge and cost<br>â€¢ Bio-P (EBPR) can reduce chemical costs<br>â€¢ pH impact: alum drops pH, may need alkalinity supplement</div>' },
        42: { color:'#22c55e', title:'ALKALINITY & NITRIFICATION', content:
            '<b>What This Calculates</b><br>Alkalinity consumed by nitrification and whether supplemental alkalinity (lime/soda ash) is needed. Nitrification destroys 7.14 mg/L alkalinity per mg/L NHâ‚ƒ-N oxidized.' +
            '<div style="background:rgba(34,197,94,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #22c55e"><b>Alk consumed = NHâ‚ƒ-N removed (mg/L) Ã— 7.14</b><br>â€¢ Maintain â‰¥50 mg/L as CaCOâ‚ƒ in effluent for stable nitrification<br>â€¢ If influent alk < alk consumed â†’ add lime or soda ash<br>â€¢ Denitrification returns ~3.57 mg/L alk per mg/L NOâ‚ƒ-N reduced (50% recovery)<br>â€¢ Low pH from alk depletion inhibits nitrifiers below pH 6.5</div>' },
        43: { color:'#22c55e', title:'NITROGEN BALANCE', content:
            '<b>What This Calculates</b><br>Tracks nitrogen through the plant: influent TKN â†’ nitrification â†’ denitrification â†’ effluent. Essential for nutrient permit compliance.' +
            '<div style="background:rgba(34,197,94,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #22c55e"><b>TKN = NHâ‚ƒ-N + Organic N</b><br>â€¢ Total N = TKN + NOâ‚ƒ-N + NOâ‚‚-N<br>â€¢ Nitrification: NHâ‚ƒ â†’ NOâ‚‚ â†’ NOâ‚ƒ (needs DO >2 mg/L, SRT >8 days)<br>â€¢ Denitrification: NOâ‚ƒ â†’ Nâ‚‚ gas (needs anoxic zone, carbon source)<br>â€¢ Nitrogen incorporated into biomass: ~5% of BOD removed</div>' },
        45: { color:'#3b82f6', title:'PIPE VELOCITY', content:
            '<b>What This Calculates</b><br>Flow velocity in a pipe from flow rate and pipe diameter. Critical for checking self-cleansing velocity in sewers and avoiding pipe erosion.' +
            '<div style="background:rgba(59,130,246,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #3b82f6"><b>V (fps) = Flow (ftÂ³/s) Ã· Area (ftÂ²)</b><br>â€¢ Or: V = (GPM Ã— 0.002228) Ã· (Ï€/4 Ã— (D in ft)Â²)<br>â€¢ Gravity sewer: 2â€“10 fps<br>â€¢ Force main: 3â€“8 fps<br>â€¢ <2 fps = solids deposition | >10 fps = pipe erosion<br>â€¢ Diameter in inches Ã· 12 = diameter in feet</div>' },
        46: { color:'#3b82f6', title:'HORSEPOWER', content:
            '<b>What This Calculates</b><br>Water horsepower and brake horsepower for pump sizing. WHP is theoretical; BHP accounts for pump inefficiency and is what you actually need from the motor.' +
            '<div style="background:rgba(59,130,246,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #3b82f6"><b>WHP = (GPM Ã— TDH ft) Ã· 3960</b><br><b>BHP = WHP Ã· Pump Efficiency</b><br><b>Motor HP = BHP Ã· Motor Efficiency</b><br>â€¢ Pump efficiency: 60â€“80% typical<br>â€¢ Motor efficiency: 85â€“95%<br>â€¢ kW = BHP Ã— 0.746<br>â€¢ Wire-to-water efficiency = pump eff Ã— motor eff</div>' },
        47: { color:'#f97316', title:'GEOMETRIC MEAN', content:
            '<b>What This Calculates</b><br>TCEQ requires geometric mean (not arithmetic mean) for fecal coliform and E. coli reporting. Geometric mean reduces the influence of outlier spikes.' +
            '<div style="background:rgba(249,115,22,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #f97316"><b>Geo Mean = (xâ‚ Ã— xâ‚‚ Ã— ... Ã— xâ‚™)^(1/n)</b><br>â€¢ Or: 10^(average of logâ‚â‚€ values)<br>â€¢ Always lower than arithmetic mean for bacteria data<br>â€¢ TCEQ limit: 200 CFU/100mL (E. coli, 30-day geo mean)<br>â€¢ Single sample max: 394 CFU/100mL<br>â€¢ You cannot use zero in geometric mean â€” use 1 as minimum</div>' },
        48: { color:'#f97316', title:'FLOW-WEIGHTED COMPOSITE', content:
            '<b>What This Calculates</b><br>True average concentration when flow varies throughout the day. Required for accurate DMR reporting â€” grab samples at constant intervals give misleading averages if flow changes.' +
            '<div style="background:rgba(249,115,22,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #f97316"><b>FWC = Î£(Flow_i Ã— Conc_i) Ã· Î£(Flow_i)</b><br>â€¢ Weight each sample by the flow at time of collection<br>â€¢ Automatic composite samplers do this with flow-paced sampling<br>â€¢ More accurate than time-weighted for variable-flow plants</div>' },
        51: { color:'#fb923c', title:'WET WELL SIZING', content:
            '<b>What This Calculates</b><br>Required wet well volume for pump cycling. Too small = pumps cycle too frequently (motor burnout). Too large = septic conditions and odors.' +
            '<div style="background:rgba(251,146,60,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #fb923c"><b>V (gal) = (Q Ã— T) Ã· 4</b> (for simplex pump)<br>â€¢ Q = pump capacity (GPM), T = minimum cycle time (min)<br>â€¢ Minimum cycle time: 10â€“15 min for small pumps, 5â€“10 for large<br>â€¢ Max starts/hr: 6â€“10 for most motors<br>â€¢ HRT in wet well should be <30 min to avoid septicity<br>â€¢ Must accommodate peak flow + first flush</div>' },
        52: { color:'#fb923c', title:'I/I â€” INFILTRATION & INFLOW', content:
            '<b>What This Calculates</b><br>Estimates how much groundwater (infiltration) and stormwater (inflow) enters your collection system. High I/I wastes treatment capacity and causes SSOs.' +
            '<div style="background:rgba(251,146,60,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #fb923c"><b>I/I = (Wet Weather Flow âˆ’ Dry Weather Flow)</b><br>â€¢ Infiltration: GPD per inch-mile of pipe (groundwater seeping through joints/cracks)<br>â€¢ Inflow: Direct connections â€” roof drains, manhole covers, cross-connections<br>â€¢ TCEQ threshold: Excessive I/I when peak flow >2.5Ã— average DWF<br>â€¢ Smoke testing and dye testing identify inflow sources<br>â€¢ CCTV inspection identifies infiltration sources</div>' },
        53: { color:'#fb923c', title:'FORCE MAIN FRICTION LOSS', content:
            '<b>What This Calculates</b><br>Head loss due to pipe friction in a pressurized force main using Hazen-Williams equation. Friction loss is the biggest component of TDH after static head.' +
            '<div style="background:rgba(251,146,60,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #fb923c"><b>hf = (4.73 Ã— L Ã— Q^1.852) Ã· (C^1.852 Ã— D^4.87)</b><br>â€¢ C = Hazen-Williams roughness coefficient<br>â€¢ PVC/HDPE: C = 140â€“150 | Ductile iron: C = 100â€“130<br>â€¢ Old/tuberculated pipe: C = 60â€“80<br>â€¢ Add 10% for minor losses (fittings, valves, bends)<br>â€¢ Lower C = rougher pipe = more friction loss</div>' },
        54: { color:'#38bdf8', title:'WEIR FLOW', content:
            '<b>What This Calculates</b><br>Flow over a rectangular or V-notch weir. Simple, reliable flow measurement for open channels.' +
            '<div style="background:rgba(56,189,248,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #38bdf8"><b>Rectangular: Q = 3.33 Ã— L Ã— H^1.5</b> (Francis equation, CFS)<br><b>90Â° V-notch: Q = 2.5 Ã— H^2.5</b> (CFS)<br>â€¢ H = head on weir (ft) â€” measured upstream of weir<br>â€¢ L = weir crest length (ft)<br>â€¢ V-notch is more accurate at low flows<br>â€¢ Rectangular is better for high flows</div>' },
        55: { color:'#38bdf8', title:'AREA-VELOCITY FLOW', content:
            '<b>What This Calculates</b><br>Flow rate from pipe cross-sectional area and measured velocity. Used with portable flow meters (Doppler or electromagnetic sensors).' +
            '<div style="background:rgba(56,189,248,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #38bdf8"><b>Q = V Ã— A</b><br>â€¢ V = velocity (fps) from flow sensor<br>â€¢ A = wetted cross-sectional area (ftÂ²)<br>â€¢ For partial pipe flow, area depends on depth ratio (d/D)<br>â€¢ At half-full: A = 0.393 Ã— DÂ²<br>â€¢ Full pipe: A = Ï€/4 Ã— DÂ²</div>' },
        57: { color:'#84cc16', title:'TF HYDRAULIC LOADING', content:
            '<b>What This Calculates</b><br>Hydraulic loading rate on a trickling filter in GPD/ftÂ² or GPM/ftÂ². Controls wetting rate and prevents dry spots on the media.' +
            '<div style="background:rgba(132,204,22,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #84cc16"><b>HLR = (Flow + Recirculation) (GPD) Ã· Filter Area (ftÂ²)</b><br>â€¢ Low-rate TF: 25â€“100 GPD/ftÂ² (no recirculation)<br>â€¢ High-rate TF: 100â€“1000 GPD/ftÂ² (with recirculation)<br>â€¢ Below minimum HLR â†’ media dries out â†’ biofilm dies â†’ odors<br>â€¢ Recirculation ensures complete wetting and dilutes influent BOD</div>' },
        58: { color:'#2dd4bf', title:'POND BOD LOADING', content:
            '<b>What This Calculates</b><br>Organic loading rate on a stabilization pond in lbs BOD/acre/day. Controls odor potential and treatment performance.' +
            '<div style="background:rgba(45,212,191,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #2dd4bf"><b>Loading = (Flow MGD Ã— BOD mg/L Ã— 8.34) Ã· Pond Area (acres)</b><br>â€¢ Facultative pond: 15â€“35 lbs BOD/acre/day (warm climate like TX: up to 50)<br>â€¢ >50 lbs/acre/day = overloaded â†’ anaerobic â†’ odors<br>â€¢ Aerated lagoons can handle 50â€“200+ lbs/acre/day<br>â€¢ Loading varies seasonally â€” algae production drops in winter</div>' },
        60: { color:'#ec4899', title:'DILUTION / MIXING ZONE', content:
            '<b>What This Calculates</b><br>Downstream concentration after plant effluent mixes with receiving stream. Used for permit limit calculations and anti-degradation analysis.' +
            '<div style="background:rgba(236,72,153,0.1);border-radius:6px;padding:8px 10px;margin:6px 0;border-left:3px solid #ec4899"><b>C_mix = (Q_eff Ã— C_eff + Q_stream Ã— C_stream) Ã· (Q_eff + Q_stream)</b><br>â€¢ Same as mass balance â€” weighted average by flow<br>â€¢ Use 7Q2 (7-day, 2-year low flow) for chronic criteria<br>â€¢ Use 1Q10 (1-day, 10-year low flow) for acute criteria<br>â€¢ TCEQ uses these to set permit limits via TMDL/WLA</div>' }
    };
    
    function initJSGuides() {
        Object.keys(guideData).forEach(function(num) {
            var card = document.getElementById('card' + num);
            if (!card) return;
            // Skip if already has a guide
            if (card.querySelector('[id$="_guide"]')) return;
            var helpDiv = card.querySelector('.input-help');
            if (!helpDiv) return;
            var g = guideData[num];
            var guideId = 'jsg_' + num;
            var html = '<div style="margin-bottom:10px;">' +
                '<button onclick="document.getElementById(\'' + guideId + '\').style.display = document.getElementById(\'' + guideId + '\').style.display === \'none\' ? \'block\' : \'none\'; this.innerText = document.getElementById(\'' + guideId + '\').style.display === \'none\' ? \'ðŸ“– How to Use â–¸\' : \'ðŸ“– How to Use â–¾\'" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid ' + g.color + ';background:' + g.color + '14;color:' + g.color + ';font-weight:bold;font-size:0.82rem;cursor:pointer;text-align:left;">ðŸ“– How to Use â–¸</button>' +
                '<div id="' + guideId + '" style="display:none;margin-top:8px;background:#0c1222;border:1px solid #334155;border-radius:8px;padding:14px;font-size:0.8rem;color:#cbd5e1;line-height:1.7;">' +
                '<div style="color:' + g.color + ';font-weight:bold;font-size:0.85rem;margin-bottom:8px;">' + g.title + ' â€” OPERATOR GUIDE</div>' +
                g.content + '</div></div>';
            helpDiv.insertAdjacentHTML('afterend', html);
        });
    }

    // ==================== CALCULATOR INTERLINKING ====================
    var crossRefs = {
        1: [{n:4,t:'F:M Ratio'},{n:10,t:'Organic Loading'},{n:14,t:'Chemical Dosing'}],
        2: [{n:9,t:'RAS Rate'},{n:33,t:'SBR Settle Check'}],
        4: [{n:1,t:'Pounds Formula'},{n:5,t:'SRT'},{n:8,t:'WAS Rate'},{n:32,t:'SBR F:M'}],
        5: [{n:4,t:'F:M Ratio'},{n:8,t:'WAS Rate'}],
        6: [{n:63,t:'Tank Volume'},{n:64,t:'Pond HRT'}],
        8: [{n:5,t:'SRT'},{n:9,t:'RAS Rate'}],
        9: [{n:2,t:'SVI'},{n:8,t:'WAS Rate'}],
        10: [{n:1,t:'Pounds Formula'},{n:56,t:'NRC TF'}],
        11: [{n:63,t:'Tank Volume'},{n:12,t:'Weir Overflow'}],
        14: [{n:1,t:'Pounds Formula'},{n:34,t:'Chlorine CT'},{n:35,t:'Dechlorination'}],
        28: [{n:29,t:'SBR Volume'},{n:31,t:'SBR Aeration'},{n:32,t:'SBR F:M'}],
        29: [{n:28,t:'SBR Cycle'},{n:30,t:'SBR Decant'}],
        34: [{n:6,t:'Detention Time'},{n:35,t:'Dechlorination'},{n:14,t:'Chemical Dosing'}],
        35: [{n:34,t:'Chlorine CT'},{n:14,t:'Chemical Dosing'}],
        37: [{n:38,t:'VS Reduction'},{n:39,t:'Digester Loading'}],
        38: [{n:37,t:'Sludge Volume'},{n:39,t:'Digester Loading'}],
        41: [{n:14,t:'Chemical Dosing'},{n:42,t:'Alkalinity'}],
        42: [{n:41,t:'Phosphorus'},{n:43,t:'Nitrogen Balance'}],
        44: [{n:46,t:'Horsepower'},{n:45,t:'Pipe Velocity'}],
        45: [{n:44,t:'TDH'},{n:50,t:'Manning\'s'}],
        46: [{n:44,t:'TDH'},{n:45,t:'Pipe Velocity'}],
        50: [{n:45,t:'Pipe Velocity'},{n:52,t:'I/I Analysis'}],
        52: [{n:50,t:'Manning\'s'},{n:51,t:'Wet Well'}],
        56: [{n:57,t:'TF Hydraulic'},{n:10,t:'Organic Loading'}],
        57: [{n:56,t:'NRC TF Efficiency'}],
        58: [{n:64,t:'Pond HRT'}],
        59: [{n:65,t:'Blower Air'},{n:1,t:'Pounds Formula'}],
        61: [{n:63,t:'Tank Volume'},{n:6,t:'Detention Time'}],
        62: [{n:54,t:'Weir Flow'},{n:55,t:'Area-Velocity'}],
        63: [{n:6,t:'Detention Time'},{n:11,t:'SOR'},{n:64,t:'Pond HRT'}],
        64: [{n:58,t:'Pond BOD Loading'},{n:63,t:'Tank Volume'}],
        65: [{n:59,t:'SOTRâ†’AOTR'},{n:1,t:'Pounds Formula'}],
        66: [{n:67,t:'Land App Rate'}],
        67: [{n:66,t:'PAN'},{n:37,t:'Sludge Volume'}]
    };
    function initCrossRefs() {
        Object.keys(crossRefs).forEach(function(cardNum) {
            var card = document.getElementById('card' + cardNum);
            if (!card) return;
            var fn = card.querySelector('.formula-note');
            if (!fn) return;
            var refs = crossRefs[cardNum];
            var html = '<div style="margin-top:6px;font-size:0.7rem;color:#64748b;">See also: ';
            refs.forEach(function(r, i) {
                html += '<a onclick="goToCard(' + r.n + ')" style="color:#60a5fa;cursor:pointer;text-decoration:underline">#' + r.n + ' ' + r.t + '</a>';
                if (i < refs.length - 1) html += ' Â· ';
            });
            html += '</div>';
            fn.insertAdjacentHTML('afterend', html);
        });
    }

    // ==================== TCEQ EXAM MODE (ENHANCED) ====================
    const EXAM_STORAGE_KEY = 'ww_exam_progress';
    var examCorrect = 0, examTotal = 0, examAnswered = false;
    var examCategory = 'all';
    var examProgress = { sessions: [], catScores: {} };
    var flashcardIdx = 0, flashcardData = [];

    function loadExamProgress() {
        try {
            const saved = localStorage.getItem(EXAM_STORAGE_KEY);
            if (saved) examProgress = JSON.parse(saved);
        } catch(e) { examProgress = { sessions: [], catScores: {} }; }
    }

    function saveExamProgress() {
        try { localStorage.setItem(EXAM_STORAGE_KEY, JSON.stringify(examProgress)); } catch(e) {}
    }

    function openExam() {
        loadExamProgress();
        updateExamUI();
        document.getElementById('examOverlay').classList.add('active');
    }
    function closeExam() { document.getElementById('examOverlay').classList.remove('active'); }

    function showExamTab(tab, btn) {
        document.querySelectorAll('.exam-tab').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('examPractice').style.display = tab === 'practice' ? 'block' : 'none';
        document.getElementById('examFlashcards').style.display = tab === 'flashcards' ? 'block' : 'none';
        document.getElementById('examProgress').style.display = tab === 'progress' ? 'block' : 'none';
        document.getElementById('examTips').style.display = tab === 'tips' ? 'block' : 'none';
        if (tab === 'flashcards') loadFlashcards();
        if (tab === 'progress') updateProgressTab();
    }

    var examTimerInterval = null;
    var examTimeRemaining = 0;
    var examTimedMode = 0;

    function setExamCat(cat, btn) {
        examCategory = cat;
        document.querySelectorAll('.exam-cat-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function rnd(min, max, dec) {
        var v = min + Math.random() * (max - min);
        return dec !== undefined ? parseFloat(v.toFixed(dec)) : Math.round(v);
    }

    // Comprehensive question bank organized by category - EXPANDED for Class A prep
    const examQuestions = {
        collection: [
            // Manning's equation variations
            () => { var dia = [8,10,12,15,18,24][rnd(0,5)], slope = rnd(0.002, 0.008, 4), n = 0.013;
                var dFt = dia / 12, r = dFt / 4, v = (1.486 / n) * Math.pow(r, 2/3) * Math.pow(slope, 0.5);
                return { cat: 'Collection Systems', q: 'A <b>' + dia + '-inch</b> sewer pipe at <b>' + slope + ' ft/ft</b> slope, n = <b>' + n + '</b>. What is the full-pipe <b>velocity (fps)</b>?', a: v, unit: 'fps', formula: 'V = (1.486/n) Ã— R^(2/3) Ã— S^(1/2) | R = D(ft)/4', tol: 0.1, explanation: 'Manning\'s equation calculates gravity flow velocity. The hydraulic radius R for a full circular pipe equals diameter/4. The 1.486 constant converts metric formula to US units. Steeper slope = faster flow. Lower n (smoother pipe) = faster flow. ALWAYS convert inches to feet first!' }; },
            () => { var dia = [8,12,15,18][rnd(0,3)], slope = rnd(0.003, 0.006, 4), n = 0.013;
                var dFt = dia / 12, r = dFt / 4, v = (1.486 / n) * Math.pow(r, 2/3) * Math.pow(slope, 0.5);
                var area = Math.PI / 4 * dFt * dFt, q = v * area * 7.48 * 60;
                return { cat: 'Collection Systems', q: 'A <b>' + dia + '-inch</b> pipe at <b>' + slope + ' ft/ft</b> slope (n=0.013). What is the <b>full-pipe capacity in GPM</b>?', a: q, unit: 'GPM', formula: 'Q = V Ã— A Ã— 7.48 Ã— 60', tol: 5, explanation: 'Flow = Velocity Ã— Area. First get V from Manning\'s, then A = Ï€/4 Ã— DÂ² (in feet!). The 7.48 converts ftÂ³ to gallons, and 60 converts per-second to per-minute. This is how we size gravity sewers to handle peak flows.' }; },
            () => { var vel = rnd(1.5, 4.0, 1), dia = [8,10,12,15][rnd(0,3)];
                var dFt = dia / 12, area = Math.PI / 4 * dFt * dFt, q = vel * area * 7.48 * 60;
                return { cat: 'Collection Systems', q: 'Velocity = <b>' + vel + ' fps</b> in a <b>' + dia + '-inch</b> pipe flowing full. What is <b>flow (GPM)</b>?', a: q, unit: 'GPM', formula: 'Q = V Ã— A Ã— 7.48 Ã— 60', tol: 3, explanation: 'Classic continuity equation: Q = V Ã— A. When given velocity directly, just multiply by cross-sectional area. Remember: area uses FEET (diameter Ã· 12), not inches. Then convert ftÂ³/sec to GPM with Ã— 7.48 Ã— 60.' }; },
            () => { var n = [0.010, 0.013, 0.015][rnd(0,2)], nOld = n, nNew = 0.010;
                var factor = Math.pow(nNew/nOld, 1) * 100;
                return { cat: 'Collection Systems', q: 'Pipe with n = <b>' + n + '</b> is relined to n = <b>0.010</b>. Velocity will increase by approximately what <b>%</b>? (Enter as decimal, e.g., 30 for 30%)', a: ((1.486/0.010)/(1.486/n) - 1)*100, unit: '%', formula: 'V ratio = (n_old / n_new) since V âˆ 1/n', tol: 3, explanation: 'Since V = (1.486/n)Ã—..., velocity is inversely proportional to n. When you reline a pipe (lower n), velocity increases proportionally. This is why rehab projects can restore capacity without upsizing pipeâ€”the smoother surface lets water flow faster.' }; },
            // I/I calculations
            () => { var peakFlow = rnd(200, 800), avgFlow = rnd(80, 200), ans = peakFlow / avgFlow;
                return { cat: 'Collection Systems', q: 'A lift station has peak flow of <b>' + peakFlow + ' GPM</b> and average flow of <b>' + avgFlow + ' GPM</b>. What is the <b>peaking factor</b>?', a: ans, unit: '', formula: 'Peaking Factor = Peak Flow Ã· Average Flow', tol: 0.1, explanation: 'Peaking factor tells you how much flow spikes above averageâ€”critical for sizing pumps and pipes. A PF of 3-4 is typical for residential. Very high PF (>4) often indicates I/I problems. Pumps must handle peak, but motors sized for average runtime.' }; },
            () => { var area = rnd(50, 200), infRate = rnd(200, 600), ans = area * infRate;
                return { cat: 'Collection Systems', q: 'A collection system serves <b>' + area + ' acres</b>. I/I rate is <b>' + infRate + ' GPD/acre</b>. What is the total <b>I/I flow (GPD)</b>?', a: ans, unit: 'GPD', formula: 'I/I Flow = Area Ã— I/I Rate', tol: 50, explanation: 'I/I (Inflow & Infiltration) is unwanted water entering sewers through cracks (infiltration) or illegal connections (inflow). TCEQ uses GPD/acre to normalize across systems. High I/I wastes treatment capacity and can cause SSOs during rain events.' }; },
            () => { var dwf = rnd(0.5, 2.0, 2), wwf = rnd(1.5, 5.0, 2), ans = wwf - dwf;
                return { cat: 'Collection Systems', q: 'Dry weather flow = <b>' + dwf + ' MGD</b>, wet weather flow = <b>' + wwf + ' MGD</b>. What is <b>I/I (MGD)</b>?', a: ans, unit: 'MGD', formula: 'I/I = Wet Weather Flow âˆ’ Dry Weather Flow', tol: 0.05, explanation: 'The difference between wet and dry weather flow IS your I/I. Dry weather flow = legitimate wastewater (domestic + industrial). The extra flow during rain comes from groundwater leaking in and stormwater connections. Simple subtraction gives you the problem magnitude.' }; },
            () => { var wwf = rnd(2.0, 6.0, 1), dwf = rnd(0.8, 2.0, 1);
                var ratio = wwf / dwf, excessive = ratio > 2.5 ? 1 : 0;
                return { cat: 'Collection Systems', q: 'WWF = <b>' + wwf + ' MGD</b>, DWF = <b>' + dwf + ' MGD</b>. Is I/I excessive per TCEQ (>2.5Ã— DWF)? Enter <b>1</b> for yes, <b>0</b> for no.', a: excessive, unit: '', formula: 'Excessive if Peak WWF > 2.5 Ã— Average DWF', tol: 0, explanation: 'TCEQ uses 2.5Ã— as the threshold for "excessive" I/I requiring corrective action. If your wet weather flow exceeds 2.5Ã— dry weather, you likely have major infrastructure issues. This triggers SSES (Sewer System Evaluation Survey) requirements.' }; },
            () => { var miles = rnd(10, 50), gpd_inchMile = rnd(300, 800), dia = rnd(8, 15);
                var ans = miles * gpd_inchMile * dia;
                return { cat: 'Collection Systems', q: '<b>' + miles + ' miles</b> of <b>' + dia + '-inch</b> sewer. Infiltration rate = <b>' + gpd_inchMile + ' GPD/inch-dia/mile</b>. Total <b>infiltration (GPD)</b>?', a: ans, unit: 'GPD', formula: 'Infiltration = Miles Ã— Rate Ã— Diameter', tol: 500, explanation: 'The GPD/inch-dia/mile rate normalizes infiltration across different pipe sizes. Larger pipes have more surface area for leaks, so we multiply by diameter. This helps identify which sections of the system have the worst problems per unit length.' }; },
            // Lift station calculations
            () => { var vol = rnd(3000, 8000), pumpRate = rnd(150, 400), fillTime = rnd(5, 15);
                var inflowRate = vol / fillTime, ans = pumpRate - inflowRate;
                return { cat: 'Collection Systems', q: 'A wet well with <b>' + vol + ' gal</b> usable volume fills in <b>' + fillTime + ' min</b>. Pump rate is <b>' + pumpRate + ' GPM</b>. What is the <b>net pump-down rate (GPM)</b>?', a: ans, unit: 'GPM', formula: 'Net Rate = Pump Rate âˆ’ Inflow Rate', tol: 2, explanation: 'While pumping, wastewater keeps flowing in! Net pump-down = what you pump out minus what keeps coming in. If inflow exceeds pump rate, the wet well rises. This is why we need pumps sized well above average inflowâ€”to handle peaks and actually draw down.' }; },
            () => { var pumpRate = rnd(200, 500), minCycleTime = rnd(8, 15), ans = (pumpRate * minCycleTime) / 4;
                return { cat: 'Collection Systems', q: 'Pump capacity = <b>' + pumpRate + ' GPM</b>, min cycle time = <b>' + minCycleTime + ' min</b>. What is required <b>wet well volume (gal)</b> for simplex pump?', a: ans, unit: 'gal', formula: 'V = (Q Ã— T) Ã· 4 for simplex', tol: 20, explanation: 'The Ã·4 factor for simplex (single pump) stations comes from the relationship between fill time and pump time. Minimum cycle time protects motor from overheatingâ€”too many starts/stops kills motors. The formula ensures enough storage to space out pump cycles.' }; },
            () => { var pumpCycles = rnd(4, 12), ans = 1440 / pumpCycles;
                return { cat: 'Collection Systems', q: 'A lift station pump cycles <b>' + pumpCycles + ' times per day</b>. What is the average <b>cycle time (minutes)</b>?', a: ans, unit: 'min', formula: 'Cycle Time = 1440 min/day Ã· Cycles/day', tol: 1, explanation: '1440 = minutes in a day. Dividing by cycles gives average cycle length. Target is 4-10 cycles/hour (roughly 6-15 min/cycle). Too frequent = motor stress. Too infrequent = septicity from stagnant sewage. This is a quick way to check if station is operating normally.' }; },
            () => { var runtime = rnd(4, 12), cycles = rnd(15, 40), ans = (runtime * 60) / cycles;
                return { cat: 'Collection Systems', q: 'Pump runs <b>' + runtime + ' hrs/day</b> with <b>' + cycles + ' starts/day</b>. Average <b>run time per cycle (min)</b>?', a: ans, unit: 'min', formula: 'Run Time = Total Runtime Ã· Cycles', tol: 0.5, explanation: 'Convert hours to minutes (Ã—60), then divide by starts. Short run times (<5 min) suggest the pump is oversized or level controls are set too close together. Long run times might indicate undersized pump or high inflow. This helps diagnose operational issues.' }; },
            // Slope and grade
            () => { var diaIn = rnd(6, 15), length = rnd(200, 600), grade = rnd(0.5, 2.0, 1);
                var drop = length * (grade / 100), ans = drop;
                return { cat: 'Collection Systems', q: 'A <b>' + diaIn + '-inch</b> sewer is <b>' + length + ' ft</b> long at <b>' + grade + '%</b> grade. What is the <b>total drop (ft)</b>?', a: ans, unit: 'ft', formula: 'Drop = Length Ã— (Grade% Ã· 100)', tol: 0.1, explanation: 'Grade as percent means "feet of drop per 100 feet of run." So 1% grade over 200 ft = 2 ft drop. This determines invert elevations at manholes. Knowing the drop helps verify you can connect to existing infrastructure and maintain minimum velocity.' }; },
            () => { var upInv = rnd(95, 105, 1), dnInv = rnd(90, 100, 1), length = rnd(200, 500);
                var drop = upInv - dnInv, slope = drop / length;
                return { cat: 'Collection Systems', q: 'Upstream invert = <b>' + upInv + ' ft</b>, downstream = <b>' + dnInv + ' ft</b>, length = <b>' + length + ' ft</b>. What is <b>slope (ft/ft)</b>?', a: slope, unit: 'ft/ft', formula: 'Slope = (Upper Inv âˆ’ Lower Inv) Ã· Length', tol: 0.0005, explanation: 'Slope in ft/ft is simply rise (or drop) divided by run. The invert is the inside bottom of the pipeâ€”water flows downhill from higher to lower invert. This is how you verify as-built drawings match design specs and check for flat spots causing problems.' }; },
            () => { var minVel = 2.0, actVel = rnd(1.2, 3.5, 1), ans = actVel >= minVel ? 1 : 0;
                return { cat: 'Collection Systems', q: 'Minimum self-cleansing velocity is <b>2.0 fps</b>. Actual velocity is <b>' + actVel + ' fps</b>. Is this adequate? Enter <b>1</b> for yes, <b>0</b> for no.', a: ans, unit: '', formula: 'Self-cleansing requires â‰¥2.0 fps', tol: 0, explanation: '2.0 fps is the magic number that keeps solids suspended and moving. Below this, grit and organics settle out â†’ blockages, Hâ‚‚S, odors. This is why TCEQ specifies minimum slopes by pipe sizeâ€”to achieve 2 fps at design flow. Memorize this threshold!' }; },
            // Force main and friction
            () => { var length = rnd(1000, 5000), cFactor = 140, dia = [4,6,8][rnd(0,2)], flow = rnd(100, 400);
                var hf = (4.73 * length * Math.pow(flow, 1.852)) / (Math.pow(cFactor, 1.852) * Math.pow(dia/12, 4.87));
                return { cat: 'Collection Systems', q: 'Force main: <b>' + length + ' ft</b>, <b>' + dia + '-inch</b>, C = <b>' + cFactor + '</b>, flow = <b>' + flow + ' GPM</b>. Friction loss (Hazen-Williams)?', a: hf, unit: 'ft', formula: 'hf = (4.73 Ã— L Ã— Q^1.852) Ã· (C^1.852 Ã— D^4.87)', tol: 2, explanation: 'Hazen-Williams calculates pressure pipe friction loss. Higher C = smoother pipe = less friction. The exponents (1.852, 4.87) are empirical constants. Friction loss must be overcome by pump head. Old pipes (C=100) lose much more head than new PVC (C=150).' }; },
            () => { var staticHead = rnd(20, 60), fricLoss = rnd(5, 20), minorLoss = rnd(2, 8);
                var tdh = staticHead + fricLoss + minorLoss;
                return { cat: 'Collection Systems', q: 'Static head = <b>' + staticHead + ' ft</b>, friction = <b>' + fricLoss + ' ft</b>, minor losses = <b>' + minorLoss + ' ft</b>. What is <b>TDH (ft)</b>?', a: tdh, unit: 'ft', formula: 'TDH = Static + Friction + Minor', tol: 0.5, explanation: 'Total Dynamic Head is what the pump must overcome. Static head = elevation difference. Friction = pipe resistance. Minor losses = fittings, valves, bends. TDH determines pump selectionâ€”the pump must produce this head at design flow. Simple addition but critical for design!' }; },
        ],
        activated: [
            // F:M calculations
            () => { var flow = rnd(1.0, 4.0, 1), bod = rnd(120, 250), vol = rnd(0.3, 1.5, 2), mlss = rnd(2000, 4000);
                var ans = (flow * bod) / (vol * mlss);
                return { cat: 'Activated Sludge', q: 'Flow = <b>' + flow + ' MGD</b>, BOD = <b>' + bod + ' mg/L</b>, aeration vol = <b>' + vol + ' MG</b>, MLSS = <b>' + mlss + ' mg/L</b>. Calculate <b>F:M ratio</b>.', a: ans, unit: '', formula: 'F:M = (Flow Ã— BOD) Ã· (Vol Ã— MLSS)', tol: 0.01, explanation: 'F:M (Food to Microorganism) ratio compares food (BOD load) to bugs (MLSS in aeration basin). High F:M (>0.5) = young, fast-growing sludge. Low F:M (<0.15) = old sludge, extended aeration. CAS targets 0.2-0.4. Control F:M by adjusting WAS rate.' }; },
            () => { var fm = rnd(0.15, 0.45, 2), flow = rnd(1.5, 3.5, 1), bod = rnd(150, 220), vol = rnd(0.4, 1.2, 2);
                var mlss = (flow * bod) / (vol * fm);
                return { cat: 'Activated Sludge', q: 'Target F:M = <b>' + fm + '</b>, flow = <b>' + flow + ' MGD</b>, BOD = <b>' + bod + ' mg/L</b>, vol = <b>' + vol + ' MG</b>. What <b>MLSS (mg/L)</b> is needed?', a: mlss, unit: 'mg/L', formula: 'MLSS = (Flow Ã— BOD) Ã· (Vol Ã— F:M)', tol: 50, explanation: 'Rearranging F:M formula to solve for MLSS. This tells you what MLSS level to maintain for your target F:M given fixed flow, BOD, and tank volume. Adjust WAS to reach target MLSSâ€”less WAS = higher MLSS = lower F:M.' }; },
            // SRT calculations
            () => { var vol = rnd(0.3, 1.2, 2), mlss = rnd(2500, 4000), wasFlow = rnd(0.01, 0.08, 3), wasConc = rnd(6000, 10000), effFlow = rnd(1.0, 3.0, 1), effTSS = rnd(10, 30);
                var num = vol * mlss * 8.34, den = (wasFlow * wasConc * 8.34) + (effFlow * effTSS * 8.34), ans = num / den;
                return { cat: 'Activated Sludge', q: 'Aer vol = <b>' + vol + ' MG</b>, MLSS = <b>' + mlss + '</b>, WAS = <b>' + wasFlow + ' MGD</b> @ <b>' + wasConc + '</b>, Eff = <b>' + effFlow + ' MGD</b> @ <b>' + effTSS + '</b>. Calculate <b>SRT (days)</b>.', a: ans, unit: 'days', formula: 'SRT = (Vol Ã— MLSS Ã— 8.34) Ã· [(WAS Ã— TSS Ã— 8.34) + (Eff Ã— TSS Ã— 8.34)]', tol: 0.5, explanation: 'SRT (Solids Retention Time) = pounds in system Ã· pounds out per day. Numerator = total solids in aeration. Denominator = solids leaving via WAS + effluent. Longer SRT = older sludge = better nitrification but more energy. CAS: 5-15 days. Nitrification needs â‰¥8 days.' }; },
            () => { var targetSRT = rnd(8, 15), vol = rnd(0.4, 1.2, 2), mlss = rnd(2500, 3500), wasConc = rnd(7000, 10000);
                var ans = (vol * mlss) / (targetSRT * wasConc) * 1000000;
                return { cat: 'Activated Sludge', q: 'Target SRT = <b>' + targetSRT + ' days</b>, aer vol = <b>' + vol + ' MG</b>, MLSS = <b>' + mlss + '</b>, WAS conc = <b>' + wasConc + '</b>. Calculate <b>WAS rate (GPD)</b>.', a: ans, unit: 'GPD', formula: 'WAS GPD = (Vol MG Ã— MLSS Ã— 10â¶) Ã· (SRT Ã— WAS Conc)', tol: 500, explanation: 'This solves for the WAS flow needed to maintain target SRT. Higher WAS = shorter SRT = younger sludge. Lower WAS = longer SRT = older sludge. This is how operators control SRTâ€”by adjusting the waste sludge pump rate.' }; },
            // SVI calculations
            () => { var settle = rnd(200, 450), mlss = rnd(2000, 4000), ans = (settle * 1000) / mlss;
                return { cat: 'Activated Sludge', q: '30-min settleometer reading = <b>' + settle + ' mL/L</b>, MLSS = <b>' + mlss + ' mg/L</b>. Calculate <b>SVI</b>.', a: ans, unit: 'mL/g', formula: 'SVI = (Settled Vol Ã— 1000) Ã· MLSS', tol: 2, explanation: 'SVI (Sludge Volume Index) shows how well sludge compacts. It\'s mL of settled sludge per gram of solids. Good: 80-150. Bulking (filaments): >150. Pin floc (too old): <50. Multiply by 1000 to convert mg to g. Run this test dailyâ€”it\'s your early warning system!' }; },
            () => { var svi = rnd(80, 200), ans = 100 / svi * 100;
                return { cat: 'Activated Sludge', q: 'SVI = <b>' + svi + ' mL/g</b>. What is the estimated <b>RAS rate (%)</b> using the SVI rule of thumb?', a: ans, unit: '%', formula: 'RAS% â‰ˆ (100 Ã· SVI) Ã— 100', tol: 5, explanation: 'Quick field estimate: RAS% â‰ˆ 10,000 Ã· SVI. At SVI=100, this gives 100% RAS. At SVI=150 (bulking), you need ~67% RAS. At SVI=50 (dense sludge), only 200% would be neededâ€”but that indicates other problems. Use as starting point, then fine-tune.' }; },
            () => { var svi = rnd(90, 180), goodMin = 80, goodMax = 150;
                var ans = (svi >= goodMin && svi <= goodMax) ? 1 : 0;
                return { cat: 'Activated Sludge', q: 'SVI = <b>' + svi + ' mL/g</b>. Is this in the "good settling" range (80-150)? Enter <b>1</b> for yes, <b>0</b> for no.', a: ans, unit: '', formula: 'Good SVI: 80-150 mL/g', tol: 0, explanation: 'TCEQ loves this range: 80-150 = healthy, well-settling sludge. <50 = sludge too old or pin floc (ash-like). >150 = bulking (filamentous bacteria taking over). >200 = severe bulking, likely to lose sludge over weirs. Memorize these thresholds!' }; },
            // MLSS/MLVSS
            () => { var mlss = rnd(2500, 4000), mlvss = rnd(1800, 3200), ans = (mlvss / mlss) * 100;
                return { cat: 'Activated Sludge', q: 'MLSS = <b>' + mlss + ' mg/L</b>, MLVSS = <b>' + mlvss + ' mg/L</b>. What is the <b>volatile fraction (%)</b>?', a: ans, unit: '%', formula: 'Volatile% = (MLVSS Ã· MLSS) Ã— 100', tol: 1, explanation: 'MLVSS represents the living/organic portion of suspended solids. The rest is inert grit and ash. Healthy systems run 70-85% volatile. Lower volatile% suggests grit accumulation or too much inert material. Higher volatile% = mostly active biomassâ€”good!' }; },
            () => { var mlss = rnd(2500, 4000), volPct = rnd(70, 85), ans = mlss * (volPct / 100);
                return { cat: 'Activated Sludge', q: 'MLSS = <b>' + mlss + ' mg/L</b>, volatile fraction = <b>' + volPct + '%</b>. What is <b>MLVSS (mg/L)</b>?', a: ans, unit: 'mg/L', formula: 'MLVSS = MLSS Ã— Volatile%', tol: 20, explanation: 'MLVSS = MLSS Ã— (volatile%/100). Some formulas (like F:M with MLVSS in denominator) specifically want the active biomass portion, not total suspended solids. MLVSS is more accurate for biological calculations but requires lab analysis via volatile solids testing (550Â°C ignition).' }; },
            // RAS/WAS
            () => { var infFlow = rnd(1.5, 4.0, 1), rasRate = rnd(30, 80), ans = infFlow * (rasRate / 100);
                return { cat: 'Activated Sludge', q: 'Influent flow = <b>' + infFlow + ' MGD</b>, RAS rate = <b>' + rasRate + '%</b>. What is <b>RAS flow (MGD)</b>?', a: ans, unit: 'MGD', formula: 'RAS Flow = Influent Ã— RAS%', tol: 0.05, explanation: 'RAS (Return Activated Sludge) recycles settled solids from clarifier back to aeration. Expressed as % of influent flow. Typical: 25-75%. Higher RAS during peak flows to prevent blanket rising. Lower RAS thickens the sludge in the clarifier. Simple percentage math.' }; },
            () => { var wasFlow = rnd(20000, 80000), wasConc = rnd(7000, 12000), ans = wasFlow * wasConc * 8.34 / 1000000;
                return { cat: 'Activated Sludge', q: 'WAS = <b>' + wasFlow.toLocaleString() + ' GPD</b> @ <b>' + wasConc.toLocaleString() + ' mg/L</b>. How many <b>lbs/day solids</b> wasted?', a: ans, unit: 'lbs/day', formula: 'lbs/day = GPD Ã— mg/L Ã— 8.34 Ã· 1,000,000', tol: 10, explanation: 'The mass balance formula: lbs/day = Flow (MGD) Ã— Conc (mg/L) Ã— 8.34. The 8.34 converts (MG Ã— mg/L) to pounds. This is how much sludge you\'re removing dailyâ€”it must equal the new growth or MLSS will change. Fundamental activated sludge math!' }; },
            // Oxygen and aeration
            () => { var flow = rnd(1.0, 3.0, 1), bodRem = rnd(150, 220), factor = 1.5;
                var lbsBod = flow * bodRem * 8.34, o2 = lbsBod * factor;
                return { cat: 'Activated Sludge', q: 'Flow = <b>' + flow + ' MGD</b>, BOD removed = <b>' + bodRem + ' mg/L</b>. At <b>1.5 lb Oâ‚‚/lb BOD</b>, what is <b>Oâ‚‚ demand (lbs/day)</b>?', a: o2, unit: 'lbs/day', formula: 'Oâ‚‚ = (Flow Ã— BOD removed Ã— 8.34) Ã— 1.5', tol: 20, explanation: 'Bacteria need oxygen to break down BOD. Rule of thumb: 1.0-1.5 lb Oâ‚‚ per lb BOD removed (carbonaceous only). Add 4.6 lb Oâ‚‚ per lb ammonia if nitrifying! This sizes your blowers. Actual oxygen transfer efficiency (5-15%) means you need 10-20Ã— more air than theoretical.' }; },
            () => { var do_target = rnd(1.5, 2.5, 1), do_actual = rnd(0.5, 3.5, 1);
                var action = do_actual < do_target ? 1 : 0;
                return { cat: 'Activated Sludge', q: 'Target DO = <b>' + do_target + ' mg/L</b>, actual DO = <b>' + do_actual + ' mg/L</b>. Should you increase aeration? <b>1</b>=yes, <b>0</b>=no', a: action, unit: '', formula: 'Increase aeration if DO < target', tol: 0, explanation: 'Simple comparison: if actual < target, increase blower speed or open air valves. Target DO typically 1.5-2.5 mg/L in aeration basin. Too low (<1.0) = filaments grow, poor treatment. Too high (>4.0) = wasting energy. This is daily operational decision-making.' }; },
            // Nitrification
            () => { var nh3In = rnd(25, 45), nh3Out = rnd(0.5, 5, 1), ans = ((nh3In - nh3Out) / nh3In) * 100;
                return { cat: 'Activated Sludge', q: 'Influent NHâ‚ƒ = <b>' + nh3In + ' mg/L</b>, effluent = <b>' + nh3Out + ' mg/L</b>. What is <b>nitrification efficiency (%)</b>?', a: ans, unit: '%', formula: '% = [(In âˆ’ Out) Ã· In] Ã— 100', tol: 1, explanation: 'Standard removal efficiency formula: (In - Out) Ã· In Ã— 100. For ammonia, 85-95% removal is typical for a well-operating nitrifying plant. Low efficiency may indicate: SRT too short, low DO, cold temps, or toxic shock. This applies to BOD, TSS, and any other parameter.' }; },
            () => { var srt = rnd(5, 20), minSRT = 8;
                var adequate = srt >= minSRT ? 1 : 0;
                return { cat: 'Activated Sludge', q: 'SRT = <b>' + srt + ' days</b>. Is this adequate for nitrification (need â‰¥8 days)? <b>1</b>=yes, <b>0</b>=no', a: adequate, unit: '', formula: 'Nitrification requires SRT â‰¥ 8 days', tol: 0, explanation: 'Nitrifying bacteria (Nitrosomonas, Nitrobacter) grow slowly. If SRT is too short, you wash them out faster than they reproduce. TCEQ uses ~8 days as minimum (varies with temperatureâ€”colder = longer). This is why high-rate CAS plants often can\'t nitrify but extended aeration can.' }; },
            // Process control scenarios
            () => { var currentFM = rnd(0.25, 0.5, 2), targetFM = 0.3;
                var action = currentFM > targetFM ? 1 : 0;
                return { cat: 'Activated Sludge', q: 'Current F:M = <b>' + currentFM + '</b>, target = <b>0.30</b>. To reach target, should you INCREASE WAS? <b>1</b>=yes, <b>0</b>=no', a: action, unit: '', formula: 'High F:M â†’ increase WAS â†’ lower MLSS â†’ higher F:M. Wait, reverse: to LOWER F:M, increase MLSS by decreasing WAS', tol: 0, explanation: 'Process control logic: F:M = Food/Microorganisms. To LOWER F:M, increase the denominator (MLSS) by DECREASING WAS. To RAISE F:M, decrease MLSS by INCREASING WAS. So if current F:M is too HIGH, you need MORE bugs â†’ DECREASE WAS. Think it through carefully!' }; },
            () => { var sludgeBlanket = rnd(1, 6, 1), weirDepth = 8;
                var ok = sludgeBlanket <= (weirDepth - 2) ? 1 : 0;
                return { cat: 'Activated Sludge', q: 'Sludge blanket = <b>' + sludgeBlanket + ' ft</b> from bottom, weir at <b>8 ft</b>. Is blanket OK (â‰¥2 ft below weir)? <b>1</b>=yes, <b>0</b>=no', a: ok, unit: '', formula: 'Blanket should be â‰¥2 ft below weir', tol: 0, explanation: 'The sludge blanket is the settled solids layer in the clarifier. It must stay well below the effluent weirs or solids escape (high effluent TSS). 2-ft minimum clearance is typical. Rising blanket = increase RAS or WAS. Check blanket depth with Sludge Judgeâ€”it\'s a critical daily task!' }; },
        ],
        design: [
            // Detention time calculations
            () => { var vol = rnd(100000, 500000), flow = rnd(1.0, 4.0, 1);
                var dt = vol / (flow * 1000000) * 24;
                return { cat: 'Design Criteria', q: 'Tank volume = <b>' + vol.toLocaleString() + ' gal</b>, flow = <b>' + flow + ' MGD</b>. What is <b>detention time (hours)</b>?', a: dt, unit: 'hrs', formula: 'DT (hrs) = (Vol gal Ã· Flow GPD) Ã— 24', tol: 0.2, explanation: 'Detention time = how long water stays in a tank. Volume Ã· Flow gives days, then Ã— 24 for hours. Primary clarifiers: 1.5-2.5 hrs. Aeration: 4-8 hrs. Chlorine contact: 20-30 min at peak. Knowing these design criteria helps you verify if equipment is sized correctly.' }; },
            () => { var dtHrs = rnd(1.5, 3.0, 1), flow = rnd(1.0, 3.0, 1);
                var vol = (dtHrs / 24) * flow * 1000000;
                return { cat: 'Design Criteria', q: 'Required detention time = <b>' + dtHrs + ' hrs</b>, flow = <b>' + flow + ' MGD</b>. What <b>tank volume (gal)</b> is needed?', a: vol, unit: 'gal', formula: 'Vol = (DT/24) Ã— Flow MGD Ã— 10â¶', tol: 5000, explanation: 'Rearranging to solve for volume. Convert DT hours to days (Ã·24), multiply by MGD, then by 10â¶ to get gallons. This is how designers size tanks. If you need 2 hrs DT at 2 MGD: (2/24) Ã— 2 Ã— 1,000,000 = 166,667 gallons.' }; },
            () => { var volGal = rnd(30000, 100000), flowGPM = rnd(100, 500);
                var dtMin = volGal / flowGPM;
                return { cat: 'Design Criteria', q: 'Contact tank = <b>' + volGal.toLocaleString() + ' gal</b>, flow = <b>' + flowGPM + ' GPM</b>. What is <b>DT (minutes)</b>?', a: dtMin, unit: 'min', formula: 'DT (min) = Volume (gal) Ã· Flow (GPM)', tol: 1, explanation: 'When flow is in GPM (gallons per minute), dividing volume by flow gives detention in minutes directly. No conversion needed! This is often used for chlorine contact chambers where TCEQ requires minimum 20 minutes at peak flow.' }; },
            // Loading rates
            () => { var flow = rnd(1.0, 3.0, 1), bod = rnd(150, 250), vol1000 = rnd(30, 80);
                var lbs = flow * bod * 8.34, olr = lbs / vol1000;
                return { cat: 'Design Criteria', q: 'Flow = <b>' + flow + ' MGD</b>, BOD = <b>' + bod + ' mg/L</b>, aer basin = <b>' + vol1000 + ' Ã— 1000 ftÂ³</b>. What is <b>OLR (lbs BOD/1000 ftÂ³/day)</b>?', a: olr, unit: 'lbs/1000 ftÂ³/d', formula: 'OLR = (Flow Ã— BOD Ã— 8.34) Ã· (Vol in 1000 ftÂ³)', tol: 2, explanation: 'Organic Loading Rate normalizes BOD load to basin volume. First calculate lb/day BOD: Flow Ã— Conc Ã— 8.34. Then divide by volume in 1000 ftÂ³ units. Typical CAS: 30-50 lb/1000 ftÂ³/day. Too high = overloaded, poor treatment. Too low = oversized, wasting energy.' }; },
            () => { var flow = rnd(0.5, 2.0, 1), dia = rnd(40, 70);
                var area = Math.PI / 4 * dia * dia, sor = (flow * 1000000) / area;
                return { cat: 'Design Criteria', q: 'Clarifier <b>' + dia + ' ft</b> diameter, flow = <b>' + flow + ' MGD</b>. What is <b>SOR (GPD/ftÂ²)</b>?', a: sor, unit: 'GPD/ftÂ²', formula: 'SOR = Flow (GPD) Ã· Area (ftÂ²)', tol: 20, explanation: 'Surface Overflow Rate = hydraulic loading on clarifier surface. Low SOR = more settling time = better solids removal. Primary: 600-1200 GPD/ftÂ². Secondary: 400-800 GPD/ftÂ². Peak flows push SOR higherâ€”design must handle peaks without losing solids over weirs.' }; },
            () => { var sor = rnd(400, 800), flow = rnd(1.0, 3.0, 1);
                var area = (flow * 1000000) / sor, dia = Math.sqrt(area * 4 / Math.PI);
                return { cat: 'Design Criteria', q: 'Required SOR = <b>' + sor + ' GPD/ftÂ²</b>, flow = <b>' + flow + ' MGD</b>. What <b>clarifier diameter (ft)</b> is needed?', a: dia, unit: 'ft', formula: 'Area = Flow/SOR, then D = âˆš(4A/Ï€)', tol: 2, explanation: 'Reverse calculation for sizing. First find required area (Flow Ã· SOR), then solve for diameter using area formula: A = Ï€/4 Ã— DÂ², so D = âˆš(4A/Ï€). This is how designers size new clarifiersâ€”start with target SOR and work backward to tank dimensions.' }; },
            () => { var flow = rnd(0.5, 2.0, 1), dia = rnd(40, 60);
                var weirLen = Math.PI * dia, wor = (flow * 1000000) / weirLen;
                return { cat: 'Design Criteria', q: 'Circular clarifier <b>' + dia + ' ft</b> diameter, flow = <b>' + flow + ' MGD</b>. What is <b>WOR (GPD/ft)</b>?', a: wor, unit: 'GPD/ft', formula: 'WOR = Flow Ã· (Ï€ Ã— D)', tol: 100, explanation: 'Weir Overflow Rate = flow per foot of weir. For circular clarifiers, weir length = circumference = Ï€ Ã— D. High WOR creates turbulence that drags solids over the weir. Target: 10,000-20,000 GPD/ft. Inboard weirs or double weirs increase weir length without larger tanks.' }; },
            // Tank sizing
            () => { var dia = rnd(30, 60), depth = rnd(10, 16);
                var area = Math.PI / 4 * dia * dia, vol = area * depth * 7.48;
                return { cat: 'Design Criteria', q: 'Circular tank: <b>' + dia + ' ft</b> diameter, <b>' + depth + ' ft</b> SWD. What is <b>volume (gallons)</b>?', a: vol, unit: 'gal', formula: 'V = Ï€/4 Ã— DÂ² Ã— Depth Ã— 7.48', tol: 500, explanation: 'Cylinder volume: Area Ã— Height. Area of circle = Ï€/4 Ã— DÂ² (or Ï€rÂ²). Multiply by depth for cubic feet, then Ã— 7.48 to convert to gallons. SWD = Side Water Depth (water surface to floor, excluding sludge hopper). This is fundamental tank geometryâ€”memorize 7.48 gal/ftÂ³!' }; },
            () => { var length = rnd(60, 120), width = rnd(20, 40), depth = rnd(12, 18);
                var vol = length * width * depth * 7.48;
                return { cat: 'Design Criteria', q: 'Rectangular basin: <b>' + length + ' Ã— ' + width + ' Ã— ' + depth + ' ft</b>. What is <b>volume (gallons)</b>?', a: vol, unit: 'gal', formula: 'V = L Ã— W Ã— D Ã— 7.48', tol: 500, explanation: 'Rectangular tank volume = Length Ã— Width Ã— Depth (in feet) gives cubic feet. Ã— 7.48 converts to gallons. Rectangular tanks are common for aeration basins and contact chambers. Always double-check unitsâ€”if dimensions are in inches, convert to feet first!' }; },
            () => { var vol = rnd(200000, 800000), depth = rnd(12, 16);
                var area = vol / 7.48 / depth, dia = Math.sqrt(area * 4 / Math.PI);
                return { cat: 'Design Criteria', q: 'Need <b>' + vol.toLocaleString() + ' gal</b> tank at <b>' + depth + ' ft</b> depth. What <b>diameter (ft)</b> if circular?', a: dia, unit: 'ft', formula: 'Area = Vol/(7.48Ã—D), then Dia = âˆš(4A/Ï€)', tol: 2, explanation: 'Working backward from required volume. Convert gallons to ftÂ³ (Ã·7.48), divide by depth to get area, then solve for diameter. This is the reverse of volume calculationâ€”essential for designing new tanks to meet treatment requirements.' }; },
            // Design standards
            () => { var aer_dt = rnd(3, 10), typeExt = aer_dt >= 18 ? 1 : (aer_dt <= 8 ? 0 : 2);
                return { cat: 'Design Criteria', q: 'Aeration basin HRT = <b>' + aer_dt + ' hours</b>. Is this conventional AS (4-8 hrs)? <b>1</b>=yes, <b>0</b>=no (extended aer or contact stab)', a: (aer_dt >= 4 && aer_dt <= 8) ? 1 : 0, unit: '', formula: 'Conventional: 4-8 hrs, Extended: 18-36 hrs', tol: 0, explanation: 'Different AS modes have characteristic HRTs. Conventional: 4-8 hrs. Contact Stabilization: 0.5-2 hrs contact + 2-4 hrs reaeration. Extended Aeration: 18-36 hrs. Knowing these ranges helps identify what type of plant you\'re operating and expected F:M ratios.' }; },
            () => { var primDT = rnd(1.0, 3.0, 1), adequate = (primDT >= 1.5 && primDT <= 2.5) ? 1 : 0;
                return { cat: 'Design Criteria', q: 'Primary clarifier DT = <b>' + primDT + ' hrs</b>. Is this in typical range (1.5-2.5 hrs)? <b>1</b>=yes, <b>0</b>=no', a: adequate, unit: '', formula: 'Primary clarifier: 1.5-2.5 hrs typical', tol: 0, explanation: 'Primary clarifiers remove 50-65% of settleable solids. 1.5-2.5 hr detention gives adequate settling without going septic. Too short = poor removal. Too long = septicity, rising sludge, odors. These design ranges appear frequently on TCEQ exams.' }; },
            () => { var pe = rnd(5000, 20000), gpcd = 100, ans = pe * gpcd;
                return { cat: 'Design Criteria', q: 'Population equivalent = <b>' + pe.toLocaleString() + '</b>, design flow = <b>' + gpcd + ' GPCD</b>. What is <b>design flow (GPD)</b>?', a: ans, unit: 'GPD', formula: 'Flow = PE Ã— GPCD', tol: 1000, explanation: 'GPCD = gallons per capita per day. Typical residential: 100-120 GPCD. This includes domestic use (60-80) plus I/I allowance. PE accounts for both residential and commercial/industrial loads expressed as equivalent residential population.' }; },
            () => { var flow = rnd(0.8, 2.5, 1), bod = rnd(180, 250), pe = (flow * bod * 8.34) / 0.17;
                return { cat: 'Design Criteria', q: 'Flow = <b>' + flow + ' MGD</b>, BOD = <b>' + bod + ' mg/L</b>. What is <b>population equivalent</b> (0.17 lbs BOD/person/day)?', a: pe, unit: 'persons', formula: 'PE = (Flow Ã— BOD Ã— 8.34) Ã· 0.17', tol: 100, explanation: 'PE based on BOD load. Standard person produces 0.17 lb BOD/day (or 0.20 lb TSS/day). Calculate total BOD load in lb/day, then divide by per-capita load. This standardizes industrial loads to equivalent population for design purposes.' }; },
            // Peaking factors
            () => { var avgFlow = rnd(1.0, 3.0, 1), peakFactor = rnd(2.0, 3.5, 1);
                var peakFlow = avgFlow * peakFactor;
                return { cat: 'Design Criteria', q: 'Average flow = <b>' + avgFlow + ' MGD</b>, peaking factor = <b>' + peakFactor + '</b>. What is <b>peak design flow (MGD)</b>?', a: peakFlow, unit: 'MGD', formula: 'Peak = Average Ã— Peaking Factor', tol: 0.1, explanation: 'Treatment plants must handle peak flows, not just average. Residential PF = 2.5-4.0. Small plants have higher PF. Clarifiers and hydraulic structures sized for peak flow. Biological processes can\'t instantly respond to peaksâ€”that\'s why we need equalization.' }; },
        ],
        sludge: [
            // Sludge volume calculations
            () => { var flow = rnd(1.0, 3.0, 1), tss = rnd(200, 350), removal = rnd(55, 70), pctSolids = rnd(3, 6, 1);
                var lbsSolids = flow * tss * 8.34 * (removal/100);
                var sludgeGPD = lbsSolids / (8.34 * pctSolids/100);
                return { cat: 'Sludge Disposal', q: 'Flow = <b>' + flow + ' MGD</b>, TSS = <b>' + tss + ' mg/L</b>, <b>' + removal + '%</b> removal, sludge = <b>' + pctSolids + '%</b> solids. What is <b>sludge volume (GPD)</b>?', a: sludgeGPD, unit: 'GPD', formula: 'Sludge GPD = (lbs solids) Ã· (8.34 Ã— % solids)', tol: 500, explanation: 'Two-step calculation: 1) Find lb/day solids removed: Flow Ã— TSS Ã— 8.34 Ã— removal%. 2) Convert to sludge volume: lb/day Ã· (8.34 Ã— % solids). Higher solids concentration = less volume to handle. This is why thickening is so valuable!' }; },
            () => { var wetTons = rnd(10, 30), moisture = rnd(75, 85), ans = wetTons * (1 - moisture/100);
                return { cat: 'Sludge Disposal', q: '<b>' + wetTons + ' wet tons</b> of sludge cake at <b>' + moisture + '% moisture</b>. How many <b>dry tons</b>?', a: ans, unit: 'dry tons', formula: 'Dry Tons = Wet Tons Ã— (1 âˆ’ Moisture%/100)', tol: 0.3, explanation: 'If sludge is 75% moisture, it\'s 25% solids. Dry tons = Wet tons Ã— (100% - moisture%)/100. Hauling costs are often per wet ton, so drier cake = huge savings. Going from 20% to 25% solids reduces volume by 20%! This is why dewatering optimization matters.' }; },
            () => { var dryLbs = rnd(5000, 15000), pctSolids = rnd(20, 30);
                var wetLbs = dryLbs / (pctSolids / 100), wetGal = wetLbs / 8.34;
                return { cat: 'Sludge Disposal', q: '<b>' + dryLbs.toLocaleString() + ' lbs</b> dry solids, cake = <b>' + pctSolids + '%</b> solids. What is <b>wet sludge volume (gallons)</b>?', a: wetGal, unit: 'gal', formula: 'Wet lbs = Dry Ã· %solids, then Gal = Wet lbs Ã· 8.34', tol: 50, explanation: 'Working from dry weight to wet volume. Wet weight = Dry weight Ã· (% solids as decimal). Then convert pounds to gallons using 8.34 lb/gal (water densityâ€”sludge is close enough). Use this to estimate truck loads or storage requirements.' }; },
            // Digester operations
            () => { var vol = rnd(40000, 80000), loading = rnd(0.1, 0.2, 2), ans = vol * loading;
                return { cat: 'Sludge Disposal', q: 'Digester volume = <b>' + vol.toLocaleString() + ' ftÂ³</b>, VS loading = <b>' + loading + ' lbs VS/ftÂ³/day</b>. What is max <b>VS load (lbs/day)</b>?', a: ans, unit: 'lbs/day', formula: 'VS Load = Volume Ã— Loading Rate', tol: 100, explanation: 'Volatile Solids loading rate determines digester capacity. Anaerobic digesters: 0.1-0.2 lb VS/ftÂ³/day typical. Overloading causes acid buildup, VFA spike, and digester upset. Loading rate is a key operational parameterâ€”know your limits!' }; },
            () => { var digVol = rnd(30000, 60000), srtDays = rnd(15, 25), ans = digVol / srtDays;
                return { cat: 'Sludge Disposal', q: 'Digester volume = <b>' + digVol.toLocaleString() + ' gal</b>, SRT = <b>' + srtDays + ' days</b>. What is the <b>sludge feed rate (GPD)</b>?', a: ans, unit: 'GPD', formula: 'Feed Rate = Volume Ã· SRT', tol: 50, explanation: 'Digester SRT (same concept as activated sludge SRT) = Volume Ã· Flow. Rearranging: Flow = Volume Ã· SRT. Anaerobic digesters need 15-30 day SRT for Class B. Shorter SRT = more throughput but less stabilization and gas production.' }; },
            () => { var vsIn = rnd(3000, 6000), vsOut = rnd(1200, 2500), ans = ((vsIn - vsOut) / vsIn) * 100;
                return { cat: 'Sludge Disposal', q: 'VS in = <b>' + vsIn + ' lbs/day</b>, VS out = <b>' + vsOut + ' lbs/day</b>. What is <b>VS reduction (%)</b>?', a: ans, unit: '%', formula: 'VS Red = [(In âˆ’ Out) Ã· In] Ã— 100', tol: 1, explanation: 'Standard removal efficiency formula applied to volatile solids. VS destruction = indicator of digestion performance. Good anaerobic: 45-55%. Good aerobic: 35-50%. This measures how much organic matter was converted to gas/COâ‚‚â€”the whole point of digestion.' }; },
            () => { var vsRed = rnd(45, 65), minRed = 38, adequate = vsRed >= minRed ? 1 : 0;
                return { cat: 'Sludge Disposal', q: 'VS reduction = <b>' + vsRed + '%</b>. Does this meet Class B (â‰¥38%)? <b>1</b>=yes, <b>0</b>=no', a: adequate, unit: '', formula: 'Class B requires â‰¥38% VS reduction', tol: 0, explanation: 'EPA 503 Class B biosolids require PSRP (Process to Significantly Reduce Pathogens). One pathway: â‰¥38% VS reduction (or equivalent). Class A requires PFRP with higher standards. Know these thresholdsâ€”they determine what you can do with your biosolids!' }; },
            () => { var gasRate = rnd(12, 18), vsDestroyed = rnd(1000, 3000), ans = gasRate * vsDestroyed;
                return { cat: 'Sludge Disposal', q: 'Gas production = <b>' + gasRate + ' ftÂ³/lb VS</b> destroyed, VS destroyed = <b>' + vsDestroyed.toLocaleString() + ' lbs/day</b>. Daily <b>gas production (ftÂ³)</b>?', a: ans, unit: 'ftÂ³/day', formula: 'Gas = Rate Ã— VS Destroyed', tol: 100, explanation: 'Anaerobic digestion produces biogas (60-65% methane). Typical: 12-18 ftÂ³ gas per lb VS destroyed. This gas can power engines, boilers, or be flared. Gas production dropping? Check for digester upset, low temperature, or toxic slug.' }; },
            // Dewatering
            () => { var polyLbs = rnd(5, 15), dryTons = rnd(1, 4, 1), ans = polyLbs / dryTons;
                return { cat: 'Sludge Disposal', q: 'Polymer used = <b>' + polyLbs + ' lbs</b> to dewater <b>' + dryTons + ' dry tons</b>. What is <b>polymer dose (lbs/dry ton)</b>?', a: ans, unit: 'lbs/DT', formula: 'Dose = Polymer lbs Ã· Dry Tons', tol: 0.5, explanation: 'Polymer dose in lb/dry ton allows comparison across different sludge volumes. Typical BFP: 4-10 lb/DT. Centrifuge: 15-25 lb/DT (needs more polymer due to higher shear). Optimize dosingâ€”too little = poor capture, too much = wasted chemical cost.' }; },
            () => { var feedSolids = rnd(2, 5, 1), cakeSolids = rnd(18, 28), captureEff = rnd(90, 98);
                var solidsCaptured = captureEff;
                return { cat: 'Sludge Disposal', q: 'Feed = <b>' + feedSolids + '%</b> solids, cake = <b>' + cakeSolids + '%</b>, capture = <b>' + captureEff + '%</b>. What <b>%</b> of solids are in the cake?', a: captureEff, unit: '%', formula: 'Solids capture efficiency', tol: 1, explanation: 'Solids capture = % of incoming solids that end up in cake (not recycled in centrate/filtrate). Target >95%. Low capture means solids return to headworks, increasing plant load. Track capture to optimize polymer dose and equipment settings.' }; },
            // Land application
            () => { var dryTons = rnd(2, 8, 1), nPct = rnd(3, 6, 1), cropNeed = rnd(150, 250);
                var nAvail = dryTons * 2000 * (nPct / 100), acres = nAvail / cropNeed;
                return { cat: 'Sludge Disposal', q: '<b>' + dryTons + ' dry tons</b> biosolids, <b>' + nPct + '% N</b>. Crop needs <b>' + cropNeed + ' lbs N/acre</b>. How many <b>acres</b> can be applied?', a: acres, unit: 'acres', formula: 'Acres = (Dry Tons Ã— 2000 Ã— N%) Ã· Crop N Need', tol: 0.5, explanation: 'Land application is nitrogen-limited to prevent groundwater contamination. Calculate total N available (tons Ã— 2000 lb/ton Ã— %N), then divide by agronomic rate (crop N need). This determines how much land you need for beneficial reuse.' }; },
            () => { var pan = rnd(20, 40), cropN = rnd(150, 250), ans = cropN / pan;
                return { cat: 'Sludge Disposal', q: 'PAN = <b>' + pan + ' lbs/dry ton</b>, crop needs <b>' + cropN + ' lbs N/acre/yr</b>. What is <b>application rate (dry tons/acre/yr)</b>?', a: ans, unit: 'DT/acre/yr', formula: 'Rate = Crop N Ã· PAN', tol: 0.3, explanation: 'PAN = Plant Available Nitrogen (accounts for mineralization, not just total N). Application rate must not exceed agronomic rate. Different crops have different N needs: corn 150-200, wheat 100-150, grass 50-100 lb N/acre.' }; },
            () => { var appRate = rnd(4, 10, 1), production = rnd(200, 600), ans = production / appRate;
                return { cat: 'Sludge Disposal', q: 'Application rate = <b>' + appRate + ' DT/acre/yr</b>, annual production = <b>' + production + ' dry tons/yr</b>. How many <b>acres needed</b>?', a: ans, unit: 'acres', formula: 'Acres = Production Ã· App Rate', tol: 2, explanation: 'Simple division to find land requirement. Production Ã· application rate = acres needed. You also need buffer zones, rotation schedules, and weather days. Land-limited plants must find alternative disposal options (landfill, composting, etc.).' }; },
            // Thickening
            () => { var volIn = rnd(20000, 50000), solidsIn = rnd(0.8, 1.5, 1), solidsOut = rnd(4, 6);
                var volOut = (volIn * solidsIn) / solidsOut;
                return { cat: 'Sludge Disposal', q: 'Thickener feed = <b>' + volIn.toLocaleString() + ' GPD</b> @ <b>' + solidsIn + '%</b>. Thickened to <b>' + solidsOut + '%</b>. What is <b>underflow volume (GPD)</b>?', a: volOut, unit: 'GPD', formula: 'Vol_out = (Vol_in Ã— %_in) Ã· %_out', tol: 200, explanation: 'Mass balance: solids in = solids out. Vol_in Ã— %_in = Vol_out Ã— %_out. Rearranging: Vol_out = (Vol_in Ã— %_in) Ã· %_out. Thickening reduces volume dramaticallyâ€”going from 1% to 5% solids cuts volume by 80%! That\'s 80% less digester capacity needed.' }; },
        ],
        disinfection: [
            () => { var res = rnd(1.0, 4.0, 1), vol = rnd(5000, 50000, 0), flow = rnd(100, 1000, 0), bf = rnd(0.3, 0.7, 1);
                var t10 = (vol / flow) * bf, ans = res * t10;
                return { cat: 'Disinfection', q: 'Clâ‚‚ residual = <b>' + res + ' mg/L</b>, tank = <b>' + vol.toLocaleString() + ' gal</b>, flow = <b>' + flow + ' GPM</b>, BF = <b>' + bf + '</b>. Calculate <b>CT</b>.', a: ans, unit: 'mgÂ·min/L', formula: 'T10 = (Vol Ã· GPM) Ã— BF | CT = C Ã— T10', tol: 1, explanation: 'CT = Concentration Ã— Time. T10 = time for 10% of water to pass through (accounts for short-circuiting). BF converts theoretical DT to T10. Higher CT = more disinfection. TCEQ requires specific CT for different organisms. BF: poor baffling=0.3, average=0.5, superior=0.7.' }; },
            () => { var flow = rnd(0.5, 3.0, 1), dose = rnd(5, 15), pct = rnd(10, 15), ans = (flow * dose * 8.34) / (pct / 100);
                return { cat: 'Disinfection', q: 'Flow = <b>' + flow + ' MGD</b>, Clâ‚‚ dose = <b>' + dose + ' mg/L</b>, <b>' + pct + '%</b> solution. How many <b>lbs/day solution</b>?', a: ans, unit: 'lbs/day', formula: 'lbs/day = (Flow Ã— Dose Ã— 8.34) Ã· (% Ã· 100)', tol: 5, explanation: 'Chemical feed calculation. First find pure chemical needed: Flow Ã— Dose Ã— 8.34. Then account for solution strength: divide by (% Ã· 100). 12.5% sodium hypochlorite means you need 8Ã— more solution than pure chlorine equivalent.' }; },
            () => { var clRes = rnd(1.5, 4.0, 1), so2Ratio = 1.0, ans = clRes * so2Ratio;
                return { cat: 'Disinfection', q: 'Chlorine residual = <b>' + clRes + ' mg/L</b>. Using 1:1 ratio, what <b>SOâ‚‚ dose (mg/L)</b> for dechlorination?', a: ans, unit: 'mg/L', formula: 'SOâ‚‚ dose = Clâ‚‚ residual Ã— ratio (typically 1:1)', tol: 0.1, explanation: 'Dechlorination removes toxic chlorine residual before discharge. SOâ‚‚ or sodium bisulfite neutralize chlorine. Stoichiometric ratio is about 0.9:1, but 1:1 is used in practice to ensure complete removal. Must not overdoseâ€”SOâ‚‚ depletes dissolved oxygen!' }; },
            () => { var ctReq = rnd(15, 30), res = rnd(1.5, 3.0, 1), ans = ctReq / res;
                return { cat: 'Disinfection', q: 'Required CT = <b>' + ctReq + ' mgÂ·min/L</b>, Clâ‚‚ residual = <b>' + res + ' mg/L</b>. What <b>contact time (T10)</b> is needed?', a: ans, unit: 'min', formula: 'T10 = CT Ã· C', tol: 0.5, explanation: 'Rearranging CT = C Ã— T. If you have a target CT and know your residual, solve for required T10. This tells you minimum contact tank size needed. Higher residual = shorter time needed (but more chemical cost and potential toxicity).' }; },
            () => { var vol = rnd(10000, 40000), flow = rnd(200, 600), bf = rnd(0.4, 0.7, 1);
                var theoretical = vol / flow, t10 = theoretical * bf;
                return { cat: 'Disinfection', q: 'Contact tank = <b>' + vol.toLocaleString() + ' gal</b>, flow = <b>' + flow + ' GPM</b>, BF = <b>' + bf + '</b>. What is <b>T10 (min)</b>?', a: t10, unit: 'min', formula: 'T10 = (Vol Ã· GPM) Ã— BF', tol: 0.5, explanation: 'T10 = theoretical detention Ã— baffling factor. Theoretical = Vol Ã· Flow. BF accounts for short-circuitingâ€”some water exits faster than average. Serpentine channels get BF ~0.7. Open tanks with inlet/outlet at same end get ~0.3. Baffles improve disinfection efficiency!' }; },
            () => { var demand = rnd(3, 8), residual = rnd(0.5, 2.0, 1), ans = demand + residual;
                return { cat: 'Disinfection', q: 'Chlorine demand = <b>' + demand + ' mg/L</b>, required residual = <b>' + residual + ' mg/L</b>. What <b>dose</b> is needed?', a: ans, unit: 'mg/L', formula: 'Dose = Demand + Residual', tol: 0.2, explanation: 'Chlorine demand = amount consumed by organics, ammonia, and reactions. Residual = what\'s left for disinfection. Total dose must satisfy demand PLUS leave the required residual. Demand varies with water qualityâ€”dirty water has higher demand.' }; },
        ],
        math: [
            () => { var flow = rnd(0.5, 5.0, 1), conc = rnd(50, 300), ans = flow * conc * 8.34;
                return { cat: 'Process Math', q: 'Flow = <b>' + flow + ' MGD</b>, concentration = <b>' + conc + ' mg/L</b>. Calculate <b>lbs/day</b>.', a: ans, unit: 'lbs/day', formula: 'lbs/day = Flow Ã— Conc Ã— 8.34', tol: 1, explanation: 'THE fundamental wastewater calculation! Flow (MGD) Ã— Concentration (mg/L) Ã— 8.34 = mass flow in lb/day. The 8.34 factor makes the units work out. Memorize thisâ€”you\'ll use it for BOD, TSS, chemical doses, sludge production, everything!' }; },
            () => { var vol = rnd(50000, 500000, 0), flow = rnd(200, 2000, 0), ans = vol / (flow * 60);
                return { cat: 'Process Math', q: 'Tank = <b>' + vol.toLocaleString() + ' gal</b>, flow = <b>' + flow + ' GPM</b>. What is <b>detention time (hours)</b>?', a: ans, unit: 'hours', formula: 'DT (hrs) = Vol Ã· (GPM Ã— 60)', tol: 0.1, explanation: 'Volume Ã· Flow = Time. With GPM, divide by 60 to get hours (or just use GPH in denominator). This tells you how long water stays in a tank on average. Watch your unitsâ€”mixing GPD and gallons gives days, GPM gives minutes, etc.' }; },
            () => { var q1 = rnd(1.0, 3.0, 1), c1 = rnd(2000, 4000), q2 = rnd(0.5, 2.0, 1), c2 = rnd(100, 300);
                var ans = (q1 * c1 + q2 * c2) / (q1 + q2);
                return { cat: 'Process Math', q: 'Stream 1: <b>' + q1 + ' MGD @ ' + c1 + ' mg/L</b>. Stream 2: <b>' + q2 + ' MGD @ ' + c2 + ' mg/L</b>. What is <b>mixed concentration</b>?', a: ans, unit: 'mg/L', formula: 'Cmix = (Q1Ã—C1 + Q2Ã—C2) Ã· (Q1 + Q2)', tol: 10, explanation: 'Mass balance mixing equation. Total mass in both streams divided by total flow = mixed concentration. This applies to RAS mixing, chemical dilution, blending streams, etc. It\'s weighted by flowâ€”higher flow stream dominates the result.' }; },
            () => { var inf = rnd(150, 300), eff = rnd(5, 30), ans = ((inf - eff) / inf) * 100;
                return { cat: 'Process Math', q: 'Influent = <b>' + inf + ' mg/L</b>, effluent = <b>' + eff + ' mg/L</b>. What is <b>% removal</b>?', a: ans, unit: '%', formula: '% Removal = [(In âˆ’ Out) Ã· In] Ã— 100', tol: 0.5, explanation: 'Universal removal efficiency formula: (In - Out) Ã· In Ã— 100. Works for BOD, TSS, ammonia, anything. "How much of what came in didn\'t go out?" Primary removes 30-40% BOD, secondary adds to 85-95% total. Know typical ranges!' }; },
            () => { var dia = rnd(20, 60), dep = rnd(10, 18), area = Math.PI / 4 * dia * dia, vol = area * dep * 7.48;
                return { cat: 'Process Math', q: 'Circular tank: <b>' + dia + ' ft</b> diameter, <b>' + dep + ' ft</b> deep. What is <b>volume (gal)</b>?', a: vol, unit: 'gal', formula: 'V = Ï€/4 Ã— DÂ² Ã— Depth Ã— 7.48', tol: 100, explanation: 'Cylinder volume: Ï€/4 Ã— DÂ² Ã— height (or Ï€rÂ² Ã— h). The Ï€/4 â‰ˆ 0.785 is useful to memorize. Multiply ftÂ³ by 7.48 to get gallons. This geometry appears constantlyâ€”clarifiers, digesters, storage tanks. Double-check: diameter, not radius!' }; },
            () => { var gpd = rnd(500000, 3000000), ans = gpd / 1000000;
                return { cat: 'Process Math', q: 'Flow = <b>' + gpd.toLocaleString() + ' GPD</b>. Convert to <b>MGD</b>.', a: ans, unit: 'MGD', formula: 'MGD = GPD Ã· 1,000,000', tol: 0.01, explanation: 'Simple unit conversion but easy to mess up. MGD = Million Gallons per Day. Move the decimal 6 places. 2,500,000 GPD = 2.5 MGD. Most permit limits and design flows use MGD. Always double-check decimal placement!' }; },
            () => { var gpm = rnd(200, 1500), ans = gpm * 1440;
                return { cat: 'Process Math', q: 'Flow = <b>' + gpm + ' GPM</b>. Convert to <b>GPD</b>.', a: ans, unit: 'GPD', formula: 'GPD = GPM Ã— 1440', tol: 100, explanation: 'Minutes per day = 60 min/hr Ã— 24 hr = 1440. So GPM Ã— 1440 = GPD. This conversion is essential when your pump flow meter reads GPM but you need daily totals. Similarly, GPM Ã— 60 = GPH. Know these factors cold!' }; },
            () => { var cuft = rnd(5000, 20000), ans = cuft * 7.48;
                return { cat: 'Process Math', q: 'Volume = <b>' + cuft.toLocaleString() + ' ftÂ³</b>. Convert to <b>gallons</b>.', a: ans, unit: 'gal', formula: '1 ftÂ³ = 7.48 gallons', tol: 50, explanation: '7.48 gallons per cubic footâ€”one of the most important conversion factors in wastewater. Memorize it! Also useful: 1 gallon = 8.34 lbs water, 1 MG = 3.07 acre-feet. These constants appear on every TCEQ exam.' }; },
        ],
        hydraulics: [
            () => { var flow = rnd(200, 1500), tdh = rnd(20, 80), eff = rnd(60, 80) / 100;
                var whp = (flow * tdh) / 3960, bhp = whp / eff;
                return { cat: 'Hydraulics', q: 'Pump: <b>' + flow + ' GPM</b>, <b>' + tdh + ' ft</b> TDH, <b>' + (eff*100).toFixed(0) + '%</b> efficiency. Calculate <b>BHP</b>.', a: bhp, unit: 'BHP', formula: 'WHP = (GPM Ã— TDH) Ã· 3960 | BHP = WHP Ã· Eff', tol: 0.3, explanation: 'Water Horsepower = theoretical power to move water. Brake Horsepower = actual motor output (accounts for pump inefficiency). The 3960 constant comes from unit conversions. Always divide WHP by efficiency to size the motorâ€”pumps are 60-85% efficient.' }; },
            () => { var flow = rnd(100, 800), dia = rnd(4, 10), area = Math.PI / 4 * Math.pow(dia/12, 2);
                var vel = (flow / 7.48 / 60) / area;
                return { cat: 'Hydraulics', q: 'Flow = <b>' + flow + ' GPM</b> through <b>' + dia + '-inch</b> pipe. What is <b>velocity (fps)</b>?', a: vel, unit: 'fps', formula: 'V = Q Ã· A | Q in ftÂ³/sec, A in ftÂ²', tol: 0.2, explanation: 'V = Q/A requires consistent units. Convert GPM to ftÂ³/sec: Ã· 7.48 Ã· 60. Convert pipe diameter to feet (Ã·12) before calculating area. Velocity targets: gravity sewer 2-10 fps, force main 3-8 fps. Too slow = settling, too fast = erosion.' }; },
            () => { var flow = rnd(0.5, 4.0, 1), dia = rnd(40, 80), area = Math.PI / 4 * dia * dia, ans = (flow * 1000000) / area;
                return { cat: 'Hydraulics', q: 'Clarifier: <b>' + dia + ' ft</b> diameter, flow = <b>' + flow + ' MGD</b>. What is <b>SOR (GPD/ftÂ²)</b>?', a: ans, unit: 'GPD/ftÂ²', formula: 'SOR = Flow (GPD) Ã· Area (ftÂ²)', tol: 10, explanation: 'Surface Overflow Rate = flow per unit surface area. Primary clarifiers: 600-1200 GPD/ftÂ². Secondary: 400-800 GPD/ftÂ². Lower SOR = better settling. High SOR during peak flows can carry solids over the weirsâ€”why we design for peak, not average.' }; },
            () => { var head = rnd(30, 80), sg = 1.0, ans = head * sg * 0.433;
                return { cat: 'Hydraulics', q: 'Water column = <b>' + head + ' ft</b>. What is <b>pressure (psi)</b>?', a: ans, unit: 'psi', formula: 'PSI = Head (ft) Ã— 0.433', tol: 0.5, explanation: 'Water exerts 0.433 psi per foot of depth (at SG=1.0). This converts head to pressure. A 100-ft water tower provides 43.3 psi. For heavier liquids (sludge, chemicals), multiply by specific gravity. Essential for pump calculations and pressure gauge interpretation.' }; },
            () => { var psi = rnd(15, 50), ans = psi / 0.433;
                return { cat: 'Hydraulics', q: 'Pressure = <b>' + psi + ' psi</b>. What is equivalent <b>head (ft)</b>?', a: ans, unit: 'ft', formula: 'Head = PSI Ã· 0.433', tol: 1, explanation: 'Reverse of the previous conversion. PSI Ã· 0.433 = feet of head. A pressure gauge showing 30 psi = 69 ft of head. This lets you read a pressure gauge and know how high a pump can push water (minus friction losses).' }; },
            () => { var staticHead = rnd(20, 50), fricLoss = rnd(5, 15), minorLoss = rnd(2, 8);
                var ans = staticHead + fricLoss + minorLoss;
                return { cat: 'Hydraulics', q: 'Static head = <b>' + staticHead + ' ft</b>, friction = <b>' + fricLoss + ' ft</b>, minor losses = <b>' + minorLoss + ' ft</b>. What is <b>TDH</b>?', a: ans, unit: 'ft', formula: 'TDH = Static + Friction + Minor Losses', tol: 0.5, explanation: 'Total Dynamic Head = everything the pump must overcome. Static = elevation change. Friction = pipe resistance (calculate with Hazen-Williams). Minor = valves, fittings, bends. TDH determines pump selection from manufacturer curves.' }; },
            () => { var bhp = rnd(5, 30), eff = rnd(0.85, 0.95, 2), ans = bhp * 0.746 / eff;
                return { cat: 'Hydraulics', q: 'Motor BHP = <b>' + bhp + '</b>, motor efficiency = <b>' + (eff*100).toFixed(0) + '%</b>. What is <b>kW input</b>?', a: ans, unit: 'kW', formula: 'kW = (BHP Ã— 0.746) Ã· Motor Eff', tol: 0.3, explanation: '1 HP = 0.746 kW (or 746 watts). But motors aren\'t 100% efficientâ€”some energy becomes heat. Divide by efficiency to find actual electrical input. This determines your electric bill and wire sizing. Motor efficiency typically 85-95%.' }; },
        ]
    };

    function generateExamQ() {
        let pool = [];
        if (examCategory === 'all') {
            Object.values(examQuestions).forEach(arr => pool = pool.concat(arr));
        } else {
            pool = examQuestions[examCategory] || [];
        }
        if (pool.length === 0) pool = examQuestions.math;
        return pool[Math.floor(Math.random() * pool.length)]();
    }

    function startExamSession() {
        examCorrect = 0;
        examTotal = 0;
        examTimedMode = parseInt(document.getElementById('timedMode').value) || 0;
        document.getElementById('examScore').textContent = '0 / 0';
        nextExamQ();
    }

    function nextExamQ() {
        examAnswered = false;
        if (examTimerInterval) { clearInterval(examTimerInterval); examTimerInterval = null; }
        
        var q = generateExamQ();
        window._examCurrent = q;
        var timerHTML = '';
        if (examTimedMode > 0) {
            examTimeRemaining = examTimedMode * 60;
            timerHTML = '<div id="examTimer" style="text-align:center;font-size:1.2rem;font-weight:bold;color:#4ade80;margin-bottom:10px;">â±ï¸ ' + formatTime(examTimeRemaining) + '</div>';
        }
        var body = document.getElementById('examBody');
        body.innerHTML = timerHTML + '<div class="exam-cat">' + q.cat + '</div>' +
            '<div class="exam-q">' + q.q + '</div>' +
            '<div class="exam-input-row">' +
            '<input class="exam-input" type="number" inputmode="decimal" id="examAns" placeholder="Your answer..." onkeydown="if(event.key===\'Enter\')checkExamAns()">' +
            '<button class="exam-submit" onclick="checkExamAns()">Check</button>' +
            '</div>' +
            '<div id="examFeedback"></div>' +
            '<button onclick="backToExamMenu()" style="margin-top:10px;padding:8px 16px;background:#475569;border:none;border-radius:6px;color:#e2e8f0;font-size:0.8rem;cursor:pointer;">â† Back to Menu</button>';
        document.getElementById('examAns').focus();
        
        if (examTimedMode > 0) {
            examTimerInterval = setInterval(function() {
                examTimeRemaining--;
                var timerEl = document.getElementById('examTimer');
                if (timerEl) {
                    timerEl.textContent = 'â±ï¸ ' + formatTime(examTimeRemaining);
                    if (examTimeRemaining <= 30) timerEl.style.color = '#ef4444';
                    else if (examTimeRemaining <= 60) timerEl.style.color = '#f59e0b';
                }
                if (examTimeRemaining <= 0) {
                    clearInterval(examTimerInterval);
                    if (!examAnswered) {
                        document.getElementById('examFeedback').innerHTML = '<div style="color:#ef4444;font-weight:bold;">â° Time\'s up!</div>';
                        checkExamAns(true); // Force check with timeout
                    }
                }
            }, 1000);
        }
    }
    
    function formatTime(seconds) {
        var m = Math.floor(seconds / 60);
        var s = seconds % 60;
        return m + ':' + (s < 10 ? '0' : '') + s;
    }

    function checkExamAns(timedOut) {
        if (examAnswered) return;
        examAnswered = true;
        if (examTimerInterval) { clearInterval(examTimerInterval); examTimerInterval = null; }
        
        var q = window._examCurrent;
        var userAns = parseFloat(document.getElementById('examAns').value);
        var fb = document.getElementById('examFeedback');
        examTotal++;

        // Track category performance
        var catKey = q.cat.toLowerCase().replace(/[^a-z]/g, '').substring(0, 10);

        var explainHTML = q.explanation ? '<div style="margin-top:10px;padding:10px;background:rgba(99,102,241,0.1);border-radius:6px;border-left:3px solid #6366f1;font-size:0.8rem;color:#cbd5e1;text-align:left"><b style="color:#a5b4fc">ðŸ’¡ Why?</b> ' + q.explanation + '</div>' : '';
        if (timedOut || isNaN(userAns)) {
            fb.className = 'exam-feedback wrong';
            fb.innerHTML = (timedOut ? 'â° Time\'s up! ' : 'âŒ Enter a number.') + '<br><b>Answer: ' + q.a.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + ' ' + q.unit + '</b><br><span style="font-size:0.75rem;color:#94a3b8">' + q.formula + '</span>' + explainHTML;
            updateCatScore(catKey, false);
        } else {
            var diff = Math.abs(userAns - q.a);
            var pctDiff = q.a !== 0 ? (diff / Math.abs(q.a)) * 100 : diff;
            if (diff <= q.tol || pctDiff <= 2) {
                examCorrect++;
                fb.className = 'exam-feedback correct';
                fb.innerHTML = 'âœ… <b>Correct!</b> ' + q.a.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + ' ' + q.unit + '<br><span style="font-size:0.75rem">' + q.formula + '</span>' + explainHTML;
                updateCatScore(catKey, true);
            } else {
                fb.className = 'exam-feedback wrong';
                fb.innerHTML = 'âŒ <b>Your answer:</b> ' + userAns.toFixed(2) + '<br><b>Correct:</b> ' + q.a.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + ' ' + q.unit + '<br><span style="font-size:0.75rem;color:#94a3b8">' + q.formula + '</span>' + explainHTML;
                updateCatScore(catKey, false);
            }
        }

        document.getElementById('examScore').textContent = examCorrect + ' / ' + examTotal;
        fb.innerHTML += '<br><button class="exam-next" onclick="nextExamQ()" style="margin-top:10px">Next Question â†’</button>';

        // Save session after every 5 questions
        if (examTotal % 5 === 0) saveSession();
    }

    function updateCatScore(cat, correct) {
        if (!examProgress.catScores[cat]) {
            examProgress.catScores[cat] = { correct: 0, total: 0 };
        }
        examProgress.catScores[cat].total++;
        if (correct) examProgress.catScores[cat].correct++;
        saveExamProgress();
    }

    function saveSession() {
        if (examTotal > 0) {
            examProgress.sessions.push({
                date: new Date().toISOString(),
                correct: examCorrect,
                total: examTotal,
                category: examCategory
            });
            // Keep only last 50 sessions
            if (examProgress.sessions.length > 50) examProgress.sessions = examProgress.sessions.slice(-50);
            saveExamProgress();
        }
    }

    function backToExamMenu() {
        saveSession();
        updateExamUI();
        document.getElementById('examBody').innerHTML = document.getElementById('examPractice').outerHTML;
        showExamTab('practice', document.querySelector('.exam-tab'));
    }

    function updateExamUI() {
        // Update category scores
        Object.keys(examProgress.catScores).forEach(cat => {
            const score = examProgress.catScores[cat];
            const pct = score.total > 0 ? Math.round((score.correct / score.total) * 100) : 0;
            const el = document.getElementById('cat-score-' + cat);
            if (el) el.textContent = pct + '% (' + score.total + ')';
        });

        // Update weak area tags
        const weakAreas = [];
        Object.keys(examProgress.catScores).forEach(cat => {
            const score = examProgress.catScores[cat];
            if (score.total >= 3) {
                const pct = (score.correct / score.total) * 100;
                if (pct < 50) weakAreas.push({ cat, pct, level: 'critical' });
                else if (pct < 70) weakAreas.push({ cat, pct, level: 'weak' });
            }
        });
        const tagsEl = document.getElementById('weakAreaTags');
        if (tagsEl) {
            if (weakAreas.length === 0) {
                tagsEl.innerHTML = '<span style="color:#64748b;font-size:0.75rem;">Complete 3+ questions per category to identify weak areas</span>';
            } else {
                tagsEl.innerHTML = weakAreas.map(w => 
                    '<span class="weak-area-tag ' + w.level + '">' + w.cat + ' (' + w.pct.toFixed(0) + '%)</span>'
                ).join('');
            }
        }
    }

    function updateProgressTab() {
        const allSessions = examProgress.sessions;
        const totalQ = allSessions.reduce((a, s) => a + s.total, 0);
        const totalCorrect = allSessions.reduce((a, s) => a + s.correct, 0);
        const pct = totalQ > 0 ? (totalCorrect / totalQ * 100) : 0;

        document.getElementById('stat-sessions').textContent = allSessions.length;
        document.getElementById('stat-total-q').textContent = totalQ;
        document.getElementById('stat-correct').textContent = totalCorrect;
        
        const pctEl = document.getElementById('stat-pct');
        pctEl.textContent = pct.toFixed(0) + '%';
        pctEl.className = 'exam-stat-val ' + (pct >= 70 ? 'good' : pct >= 50 ? 'warn' : 'bad');

        document.getElementById('progressFill').style.width = Math.min(100, pct / 70 * 100) + '%';

        // Category performance
        const catPerf = document.getElementById('catPerformance');
        const cats = Object.keys(examProgress.catScores);
        if (cats.length === 0) {
            catPerf.innerHTML = '<div style="color:#64748b;font-size:0.8rem;">No category data yet</div>';
        } else {
            catPerf.innerHTML = cats.map(cat => {
                const s = examProgress.catScores[cat];
                const p = s.total > 0 ? (s.correct / s.total * 100) : 0;
                const color = p >= 70 ? '#4ade80' : p >= 50 ? '#f59e0b' : '#ef4444';
                return '<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">' +
                    '<div style="flex:1;font-size:0.75rem;color:#cbd5e1;text-transform:capitalize;">' + cat + '</div>' +
                    '<div style="width:100px;height:6px;background:#334155;border-radius:3px;overflow:hidden;">' +
                    '<div style="width:' + p + '%;height:100%;background:' + color + '"></div></div>' +
                    '<div style="width:50px;font-size:0.7rem;color:' + color + ';text-align:right;">' + p.toFixed(0) + '%</div></div>';
            }).join('');
        }

        // Recent sessions
        const historyEl = document.getElementById('examHistory');
        if (allSessions.length === 0) {
            historyEl.innerHTML = '<div style="text-align:center;color:#64748b;padding:20px;">No sessions yet</div>';
        } else {
            historyEl.innerHTML = allSessions.slice(-10).reverse().map(s => {
                const d = new Date(s.date);
                const pct = (s.correct / s.total * 100).toFixed(0);
                const color = pct >= 70 ? '#4ade80' : pct >= 50 ? '#f59e0b' : '#ef4444';
                return '<div class="exam-history-item">' +
                    '<span class="exam-history-date">' + d.toLocaleDateString() + '</span>' +
                    '<span>' + (s.category || 'all') + '</span>' +
                    '<span class="exam-history-score" style="color:' + color + '">' + s.correct + '/' + s.total + ' (' + pct + '%)</span></div>';
            }).join('');
        }
    }

    function resetExamProgress() {
        if (confirm('Reset ALL exam progress? This cannot be undone.')) {
            examProgress = { sessions: [], catScores: {} };
            saveExamProgress();
            updateProgressTab();
            updateExamUI();
            showToast('Progress reset', 'success');
        }
    }

    // ==================== FLASHCARD SYSTEM ====================
    const flashcardDecks = {
        formulas: [
            { front: 'Pounds Formula', back: 'lbs/day = Flow (MGD) Ã— Concentration (mg/L) Ã— 8.34', cat: 'FORMULA' },
            { front: 'F:M Ratio', back: 'F:M = (Flow Ã— BOD Ã— 8.34) Ã· (Vol Ã— MLSS Ã— 8.34)\nSimplified: F:M = (Flow Ã— BOD) Ã· (Vol Ã— MLSS)', cat: 'FORMULA' },
            { front: 'SRT (Sludge Age)', back: 'SRT = (Aer Vol Ã— MLSS Ã— 8.34) Ã· [(WAS Ã— TSS Ã— 8.34) + (Eff Ã— TSS Ã— 8.34)]', cat: 'FORMULA' },
            { front: 'SVI', back: 'SVI = (Settled Volume mL Ã— 1000) Ã· MLSS mg/L\nUnits: mL/g', cat: 'FORMULA' },
            { front: 'Detention Time', back: 'DT = Volume Ã· Flow\nMatch units! Gallons Ã· GPD = days', cat: 'FORMULA' },
            { front: 'Surface Overflow Rate', back: 'SOR = Flow (GPD) Ã· Surface Area (ftÂ²)\nUnits: GPD/ftÂ²', cat: 'FORMULA' },
            { front: 'Weir Overflow Rate', back: 'WOR = Flow (GPD) Ã· Weir Length (ft)\nCircular: Weir = Ï€ Ã— D', cat: 'FORMULA' },
            { front: 'Brake Horsepower', back: 'WHP = (GPM Ã— TDH) Ã· 3960\nBHP = WHP Ã· Pump Efficiency', cat: 'FORMULA' },
            { front: 'CT Value', back: 'CT = Residual (mg/L) Ã— Contact Time (min)\nT10 = (Volume Ã· Flow) Ã— Baffling Factor', cat: 'FORMULA' },
            { front: 'Manning\'s Equation', back: 'V = (1.486/n) Ã— R^(2/3) Ã— S^(1/2)\nR = hydraulic radius = D/4 for full pipe', cat: 'FORMULA' },
            { front: '% Removal', back: '% Removal = [(Influent âˆ’ Effluent) Ã· Influent] Ã— 100', cat: 'FORMULA' },
            { front: 'Population Equivalent', back: 'PE = (Flow Ã— BOD Ã— 8.34) Ã· 0.17 lbs/person/day', cat: 'FORMULA' },
            { front: 'Hazen-Williams', back: 'hf = (4.73 Ã— L Ã— Q^1.852) Ã· (C^1.852 Ã— D^4.87)\nC = roughness: PVC=140, DI=100-130', cat: 'FORMULA' },
            { front: 'Wet Well Sizing', back: 'V (gal) = (Q Ã— T) Ã· 4 for simplex\nQ = pump GPM, T = min cycle time', cat: 'FORMULA' },
            { front: 'VS Reduction %', back: '% VS Red = [(VS in âˆ’ VS out) Ã· VS in] Ã— 100\nClass B requires â‰¥38%', cat: 'FORMULA' },
        ],
        definitions: [
            { front: 'MLSS', back: 'Mixed Liquor Suspended Solids - Total suspended solids in the aeration basin. Typical: 2,000-4,000 mg/L for CAS.', cat: 'DEFINITION' },
            { front: 'MLVSS', back: 'Mixed Liquor Volatile Suspended Solids - The organic (living) portion of MLSS. Usually 70-85% of MLSS.', cat: 'DEFINITION' },
            { front: 'SRT vs HRT', back: 'SRT = Solids Retention Time (sludge age in days)\nHRT = Hydraulic Retention Time (water detention time)', cat: 'DEFINITION' },
            { front: 'RAS', back: 'Return Activated Sludge - Settled sludge returned from clarifier to aeration basin. Maintains MLSS.', cat: 'DEFINITION' },
            { front: 'WAS', back: 'Waste Activated Sludge - Excess sludge removed to maintain target SRT. Primary process control.', cat: 'DEFINITION' },
            { front: 'Filamentous Bacteria', back: 'Thread-like bacteria that cause bulking sludge. Thrive in low F:M, low DO, or nutrient-deficient conditions.', cat: 'DEFINITION' },
            { front: 'Nitrification', back: 'Biological conversion of ammonia (NHâ‚ƒ) to nitrate (NOâ‚ƒ). Requires SRT >8 days, DO >2 mg/L.', cat: 'DEFINITION' },
            { front: 'Denitrification', back: 'Biological conversion of nitrate to nitrogen gas. Requires anoxic conditions (no free Oâ‚‚).', cat: 'DEFINITION' },
            { front: 'BODâ‚…', back: 'Biochemical Oxygen Demand - Oâ‚‚ consumed by microbes in 5 days at 20Â°C. Measures organic pollution.', cat: 'DEFINITION' },
            { front: 'COD', back: 'Chemical Oxygen Demand - Oâ‚‚ equivalent of organics that can be chemically oxidized. COD > BOD always.', cat: 'DEFINITION' },
            { front: 'TDH', back: 'Total Dynamic Head - Sum of static head + friction losses + minor losses. Determines pump work required.', cat: 'DEFINITION' },
            { front: 'Baffling Factor (BF)', back: 'Ratio of T10/theoretical DT. Accounts for short-circuiting.\n0.1=unbaffled, 0.5=avg, 0.7=superior, 1.0=plug flow', cat: 'DEFINITION' },
        ],
        limits: [
            { front: 'Typical BOD Limit', back: '30 mg/L monthly average\n45 mg/L weekly average\n(may vary by permit)', cat: 'LIMIT' },
            { front: 'Typical TSS Limit', back: '30 mg/L monthly average\n45 mg/L weekly average\n(may vary by permit)', cat: 'LIMIT' },
            { front: 'Chlorine Residual', back: 'Often 0.5-1.0 mg/L leaving contact tank\nMay have max limit (dechlorination required)', cat: 'LIMIT' },
            { front: 'pH Range', back: 'Typically 6.0-9.0 for discharge\nOptimal for biology: 6.5-8.5', cat: 'LIMIT' },
            { front: 'DO in Aeration', back: 'Maintain 1.5-2.5 mg/L minimum\nFor nitrification: >2.0 mg/L', cat: 'LIMIT' },
            { front: 'Ammonia Limits', back: 'Varies by permit: 2-10 mg/L typical\nMore stringent in summer (warmer receiving water)', cat: 'LIMIT' },
            { front: 'Class A Biosolids', back: 'Fecal coliform <1000 MPN/g OR\nSalmonella <3 MPN/4g dry weight\n38% reduction in pathogens', cat: 'LIMIT' },
            { front: 'Class B Biosolids', back: 'Fecal coliform <2,000,000 MPN/g\nSite restrictions apply for land application', cat: 'LIMIT' },
            { front: 'E. coli Limits', back: '126 CFU/100mL geometric mean (freshwater)\n35 CFU/100mL for primary contact recreation', cat: 'LIMIT' },
            { front: 'Self-Cleansing Velocity', back: 'â‰¥2.0 fps minimum in sewers\nPrevents solids deposition\nMax ~10 fps to prevent erosion', cat: 'LIMIT' },
        ],
        collection: [
            { front: 'Minimum Velocity', back: 'Self-cleansing velocity: â‰¥2.0 fps\nPrevents solids deposition in sewers', cat: 'COLLECTION' },
            { front: 'Maximum Velocity', back: 'Typically â‰¤10 fps\nPrevents erosion and pipe damage', cat: 'COLLECTION' },
            { front: 'Minimum Slope (8")', back: '8-inch sewer: 0.40% minimum\n(0.004 ft/ft)', cat: 'COLLECTION' },
            { front: 'n Value (Manning\'s)', back: 'New concrete/PVC: n = 0.010-0.013\nOld clay/brick: n = 0.013-0.017', cat: 'COLLECTION' },
            { front: 'Lift Station Cycle Time', back: 'Minimum: 5-10 minutes between starts\nPrevents motor overheating', cat: 'COLLECTION' },
            { front: 'I/I Definition', back: 'Inflow: Direct connection (roof drains, foundation drains)\nInfiltration: Groundwater through cracks/joints', cat: 'COLLECTION' },
            { front: 'Excessive I/I', back: 'Peak WWF > 2.5Ã— Average DWF\nOr: >500 GPD/inch-dia/mile', cat: 'COLLECTION' },
            { front: 'Force Main vs Gravity', back: 'Force main: pressurized, pump-driven\nGravity: flows by slope, needs min 2 fps', cat: 'COLLECTION' },
            { front: 'Manhole Spacing', back: 'Max 300-400 ft typically\nAt direction changes, size changes, junctions', cat: 'COLLECTION' },
            { front: 'Wet Well Design', back: 'V = (QÃ—T)/4 for simplex pump\nMax HRT <30 min to prevent septicity', cat: 'COLLECTION' },
            { front: 'Peak Flow Design', back: 'Use 4Ã— avg for small systems\n2.5Ã— avg for large systems\nHigher peaking factor = smaller population', cat: 'COLLECTION' },
            { front: 'Smoke/Dye Testing', back: 'Smoke test: finds inflow sources\nDye test: confirms connections\nCCTV: finds infiltration cracks', cat: 'COLLECTION' },
        ],
        sludge: [
            { front: 'Digester Temperature', back: 'Mesophilic: 95-100Â°F (35-38Â°C)\nThermophilic: 122-140Â°F (50-60Â°C)', cat: 'SLUDGE' },
            { front: 'Digester SRT', back: 'Mesophilic: 15-20 days typical\nThermophilic: 10-15 days\nHigher = better stabilization', cat: 'SLUDGE' },
            { front: 'VS Reduction Target', back: 'Minimum 38% for Class B\nTypical: 50-60% for healthy digester', cat: 'SLUDGE' },
            { front: 'Digester Gas Composition', back: '60-70% methane (CHâ‚„)\n30-40% carbon dioxide (COâ‚‚)\nTrace Hâ‚‚S (toxic!)', cat: 'SLUDGE' },
            { front: 'Gas Production Rate', back: '12-18 ftÂ³ per lb VS destroyed\nHigher = healthier digester', cat: 'SLUDGE' },
            { front: 'Polymer Dosing', back: 'Typical: 5-15 lbs/dry ton\nDepends on solids type and dewatering equipment', cat: 'SLUDGE' },
            { front: 'Primary Sludge %', back: '3-8% solids (thick, gray)\nHigh VS content ~70%\nEasier to dewater than WAS', cat: 'SLUDGE' },
            { front: 'WAS Characteristics', back: '0.5-1.5% solids (thin, brown)\nVS ~75-80%\nHarder to dewater', cat: 'SLUDGE' },
            { front: 'Dewatered Cake %', back: 'Belt press: 15-25% solids\nCentrifuge: 20-28% solids\nFilter press: 25-40% solids', cat: 'SLUDGE' },
            { front: 'Land App N Limits', back: 'Apply at agronomic rate = crop N uptake\nExcess N â†’ groundwater contamination', cat: 'SLUDGE' },
            { front: 'PAN Calculation', back: 'PAN = Org N Ã— min rate + NHâ‚„-N Ã— (1-vol loss)\nPlant-Available Nitrogen', cat: 'SLUDGE' },
            { front: 'Volatile Acids/Alkalinity', back: 'VA/Alk ratio: 0.1-0.25 normal\n>0.5 = digester upset\nAlkalinity buffers pH drops', cat: 'SLUDGE' },
        ],
        design: [
            { front: 'Primary Clarifier DT', back: '1.5-2.5 hours\n25-40% BOD removal\n50-70% TSS removal', cat: 'DESIGN' },
            { front: 'Secondary Clarifier DT', back: '2-4 hours at avg flow\n1.5 hrs minimum at peak', cat: 'DESIGN' },
            { front: 'Aeration Basin DT', back: 'Conventional: 4-8 hours\nExtended aeration: 18-36 hours\nContact stab: 0.5-1 hr contact', cat: 'DESIGN' },
            { front: 'SOR - Clarifiers', back: 'Primary: 600-1000 GPD/ftÂ²\nSecondary: 400-800 GPD/ftÂ² avg\nPeak: 1000-1200 GPD/ftÂ²', cat: 'DESIGN' },
            { front: 'WOR - Clarifiers', back: 'Primary: 10,000-20,000 GPD/ft\nSecondary: 10,000-15,000 GPD/ft\nLower = better settling', cat: 'DESIGN' },
            { front: 'Solids Loading Rate', back: 'Secondary clarifier: 20-30 lbs/ftÂ²/day avg\nPeak: 50 lbs/ftÂ²/day max', cat: 'DESIGN' },
            { front: 'OLR - Aeration', back: 'Conventional: 20-40 lbs BOD/1000 ftÂ³/day\nExtended aer: 10-25 lbs BOD/1000 ftÂ³/day', cat: 'DESIGN' },
            { front: 'Digester Loading', back: 'High-rate: 0.1-0.2 lbs VS/ftÂ³/day\nStandard rate: 0.03-0.1 lbs VS/ftÂ³/day', cat: 'DESIGN' },
            { front: 'Chlorine Contact Time', back: '15-30 min at peak flow\nCT = 15-30 mgÂ·min/L for wastewater', cat: 'DESIGN' },
            { front: 'GPCD Flow Allowance', back: 'Residential: 100-120 GPCD\nCommercial: varies by type\nI/I allowance: add 10-30%', cat: 'DESIGN' },
        ]
    };

    function loadFlashcards() {
        const cat = document.getElementById('flashcardCat').value;
        flashcardData = flashcardDecks[cat] || flashcardDecks.formulas;
        flashcardIdx = 0;
        showFlashcard();
    }

    function showFlashcard() {
        if (flashcardData.length === 0) return;
        const card = flashcardData[flashcardIdx];
        document.getElementById('flashcardCatLabel').textContent = card.cat;
        document.getElementById('flashcardFront').textContent = card.front;
        document.getElementById('flashcardBack').innerHTML = card.back.replace(/\n/g, '<br>');
        document.getElementById('flashcard').classList.remove('flipped');
        document.getElementById('flashcardCounter').textContent = (flashcardIdx + 1) + ' / ' + flashcardData.length;
    }

    function flipFlashcard() {
        document.getElementById('flashcard').classList.toggle('flipped');
    }

    function nextFlashcard() {
        flashcardIdx = (flashcardIdx + 1) % flashcardData.length;
        showFlashcard();
    }

    function prevFlashcard() {
        flashcardIdx = (flashcardIdx - 1 + flashcardData.length) % flashcardData.length;
        showFlashcard();
    }

    // ==================== THEME TOGGLE ====================
    function toggleTheme() {
        var isLight = document.body.classList.toggle('light-theme');
        document.getElementById('themeBtn').textContent = isLight ? 'â˜€ï¸' : 'ðŸŒ™';
        try { localStorage.setItem('ww_theme', isLight ? 'light' : 'dark'); } catch(e) {}
    }
    function loadTheme() {
        try {
            var t = localStorage.getItem('ww_theme');
            if (t === 'light') {
                document.body.classList.add('light-theme');
                document.getElementById('themeBtn').textContent = 'â˜€ï¸';
            }
        } catch(e) {}
    }

    // ==================== UNIT CONVERSION SYSTEM ====================
    var currentUnits = 'us';
    var conversionFactors = {
        // Volume
        'gal': { metric: 3.785, metricUnit: 'L' },
        'MG': { metric: 3785, metricUnit: 'mÂ³' },
        'ftÂ³': { metric: 0.0283, metricUnit: 'mÂ³' },
        // Flow
        'GPM': { metric: 3.785, metricUnit: 'L/min' },
        'GPD': { metric: 3.785, metricUnit: 'L/day' },
        'MGD': { metric: 3785, metricUnit: 'mÂ³/day' },
        // Length
        'ft': { metric: 0.3048, metricUnit: 'm' },
        'in': { metric: 2.54, metricUnit: 'cm' },
        // Mass
        'lb': { metric: 0.4536, metricUnit: 'kg' },
        'lbs': { metric: 0.4536, metricUnit: 'kg' },
        'lbs/day': { metric: 0.4536, metricUnit: 'kg/day' },
        // Concentration stays same (mg/L)
        // Pressure
        'psi': { metric: 6.895, metricUnit: 'kPa' },
        // Area
        'ftÂ²': { metric: 0.0929, metricUnit: 'mÂ²' },
        'acres': { metric: 0.4047, metricUnit: 'ha' }
    };
    
    function setUnits(type) {
        currentUnits = type;
        document.getElementById('unitUS').classList.toggle('active', type === 'us');
        document.getElementById('unitMetric').classList.toggle('active', type === 'metric');
        try { localStorage.setItem('ww_units', type); } catch(e) {}
        updateUnitDisplay();
    }
    
    function loadUnits() {
        try {
            var u = localStorage.getItem('ww_units');
            if (u === 'metric') setUnits('metric');
        } catch(e) {}
    }
    
    function updateUnitDisplay() {
        // Update visible result units
        document.querySelectorAll('.val').forEach(function(el) {
            var text = el.textContent;
            if (currentUnits === 'metric') {
                Object.keys(conversionFactors).forEach(function(unit) {
                    var regex = new RegExp('([\\d,.]+)\\s*' + unit.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '(?![a-zA-Z])', 'gi');
                    if (regex.test(text)) {
                        text = text.replace(regex, function(match, num) {
                            var val = parseFloat(num.replace(/,/g, ''));
                            var converted = val * conversionFactors[unit].metric;
                            return converted.toFixed(2) + ' ' + conversionFactors[unit].metricUnit;
                        });
                    }
                });
            }
            el.setAttribute('data-original', el.getAttribute('data-original') || el.textContent);
            if (currentUnits === 'us') {
                el.textContent = el.getAttribute('data-original');
            }
        });
    }

    // ==================== SCENARIO SAVE/LOAD ====================
    var SCENARIO_KEY = 'ww_scenarios';
    var compareScenarios = [];
    
    function getScenarios() {
        try {
            return JSON.parse(localStorage.getItem(SCENARIO_KEY) || '[]');
        } catch(e) { return []; }
    }
    
    function saveScenarios(scenarios) {
        try {
            localStorage.setItem(SCENARIO_KEY, JSON.stringify(scenarios));
        } catch(e) {}
    }
    
    function openScenarios() {
        document.getElementById('scenarioOverlay').classList.add('active');
        renderScenarioList();
    }
    
    function closeScenarios() {
        document.getElementById('scenarioOverlay').classList.remove('active');
    }
    
    function getCurrentValues() {
        var values = {};
        document.querySelectorAll('.card').forEach(function(card) {
            var cardId = card.id;
            var inputs = card.querySelectorAll('input, select');
            var cardValues = {};
            inputs.forEach(function(inp, idx) {
                if (inp.value) cardValues[idx] = inp.value;
            });
            var resultEl = card.querySelector('.val');
            if (resultEl && resultEl.textContent !== 'â€”') {
                cardValues.result = resultEl.textContent;
            }
            if (Object.keys(cardValues).length > 0) {
                values[cardId] = cardValues;
            }
        });
        return values;
    }
    
    function saveCurrentScenario() {
        var name = document.getElementById('scenarioName').value.trim();
        if (!name) {
            name = 'Scenario ' + new Date().toLocaleDateString();
        }
        var scenarios = getScenarios();
        var newScenario = {
            id: Date.now(),
            name: name,
            date: new Date().toISOString(),
            values: getCurrentValues()
        };
        scenarios.unshift(newScenario);
        if (scenarios.length > 20) scenarios = scenarios.slice(0, 20);
        saveScenarios(scenarios);
        document.getElementById('scenarioName').value = '';
        renderScenarioList();
        showSaveIndicator();
    }
    
    function showSaveIndicator() {
        var ind = document.getElementById('saveIndicator');
        ind.classList.add('show');
        setTimeout(function() { ind.classList.remove('show'); }, 2000);
    }
    
    function loadScenario(id) {
        var scenarios = getScenarios();
        var scenario = scenarios.find(function(s) { return s.id === id; });
        if (!scenario) return;
        
        Object.keys(scenario.values).forEach(function(cardId) {
            var card = document.getElementById(cardId);
            if (!card) return;
            var cardValues = scenario.values[cardId];
            var inputs = card.querySelectorAll('input, select');
            inputs.forEach(function(inp, idx) {
                if (cardValues[idx] !== undefined) {
                    inp.value = cardValues[idx];
                    inp.dispatchEvent(new Event('input', { bubbles: true }));
                }
            });
        });
        closeScenarios();
        showSaveIndicator();
        document.getElementById('saveIndicator').textContent = 'âœ“ Scenario Loaded';
        setTimeout(function() {
            document.getElementById('saveIndicator').textContent = 'âœ“ Scenario Saved';
        }, 2000);
    }
    
    function deleteScenario(id) {
        if (!confirm('Delete this scenario?')) return;
        var scenarios = getScenarios().filter(function(s) { return s.id !== id; });
        saveScenarios(scenarios);
        renderScenarioList();
    }
    
    function addToCompare(id) {
        var scenarios = getScenarios();
        var scenario = scenarios.find(function(s) { return s.id === id; });
        if (!scenario) return;
        
        if (compareScenarios.length >= 2) {
            compareScenarios.shift();
        }
        compareScenarios.push(scenario);
        
        if (compareScenarios.length === 2) {
            showCompare();
        } else {
            alert('Select one more scenario to compare');
        }
    }
    
    function showCompare() {
        if (compareScenarios.length < 2) return;
        
        var panel = document.getElementById('comparePanel');
        var grid = document.getElementById('compareGrid');
        
        var html = '';
        compareScenarios.forEach(function(scenario, idx) {
            html += '<div class="compare-col"><h5>' + scenario.name + '</h5>';
            var count = 0;
            Object.keys(scenario.values).forEach(function(cardId) {
                if (count >= 8) return;
                var cardEl = document.getElementById(cardId);
                if (!cardEl) return;
                var title = cardEl.querySelector('h2');
                var titleText = title ? title.textContent.replace(/[â­\d]/g, '').trim().substring(0, 25) : cardId;
                var result = scenario.values[cardId].result || 'â€”';
                html += '<div class="compare-row"><span class="label">' + titleText + '</span><span>' + result + '</span></div>';
                count++;
            });
            html += '</div>';
        });
        
        grid.innerHTML = html;
        panel.classList.add('active');
        closeScenarios();
    }
    
    function closeCompare() {
        document.getElementById('comparePanel').classList.remove('active');
        compareScenarios = [];
    }
    
    function renderScenarioList() {
        var scenarios = getScenarios();
        var list = document.getElementById('scenarioList');
        
        if (scenarios.length === 0) {
            list.innerHTML = '<div class="scenario-empty"><div style="font-size:2rem;margin-bottom:8px;">ðŸ“</div><b>No saved scenarios yet</b><br><br>Scenarios let you save all calculator inputs and compare different operating conditions.<br><br><b>Quick Start:</b><br>1. Enter values in calculators<br>2. Name your scenario above<br>3. Click "Save Current"<br><br><span style="color:#4ade80;cursor:pointer;" onclick="document.getElementById(\'scenarioGuideBtn\').click()">ðŸ“– Click "How to Use" above for full guide</span></div>';
            return;
        }
        
        var html = '';
        scenarios.forEach(function(s) {
            var date = new Date(s.date).toLocaleDateString();
            var calcCount = Object.keys(s.values).length;
            html += '<div class="scenario-item">' +
                '<div class="scenario-info"><h4>' + s.name + '</h4><p>' + date + ' â€¢ ' + calcCount + ' calculators</p></div>' +
                '<div class="scenario-actions">' +
                '<button class="load-btn" onclick="loadScenario(' + s.id + ')">Load</button>' +
                '<button class="compare-btn" onclick="addToCompare(' + s.id + ')">Compare</button>' +
                '<button class="del-btn" onclick="deleteScenario(' + s.id + ')">âœ•</button>' +
                '</div></div>';
        });
        list.innerHTML = html;
    }

    // ==================== PROCESS DIAGRAMS ====================
    var processDiagrams = {
        activated_sludge: '<svg viewBox="0 0 600 200" xmlns="http://www.w3.org/2000/svg">' +
            '<defs><marker id="arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#3b82f6"/></marker></defs>' +
            '<rect x="20" y="60" width="80" height="80" rx="5" fill="#1e3a5f" stroke="#3b82f6"/><text x="60" y="105" text-anchor="middle" fill="#94a3b8" font-size="11">Primary</text>' +
            '<rect x="140" y="40" width="180" height="120" rx="5" fill="#1e3a5f" stroke="#22c55e"/><text x="230" y="90" text-anchor="middle" fill="#4ade80" font-size="12">Aeration Basin</text><text x="230" y="110" text-anchor="middle" fill="#94a3b8" font-size="10">MLSS â€¢ DO â€¢ F:M</text>' +
            '<circle cx="230" cy="130" r="8" fill="#22c55e" opacity="0.6"><animate attributeName="r" values="6;10;6" dur="2s" repeatCount="indefinite"/></circle>' +
            '<rect x="360" y="50" width="100" height="100" rx="50" fill="#1e3a5f" stroke="#f59e0b"/><text x="410" y="95" text-anchor="middle" fill="#fbbf24" font-size="11">Secondary</text><text x="410" y="110" text-anchor="middle" fill="#94a3b8" font-size="9">Clarifier</text>' +
            '<rect x="500" y="70" width="80" height="60" rx="5" fill="#1e3a5f" stroke="#06b6d4"/><text x="540" y="105" text-anchor="middle" fill="#22d3ee" font-size="11">Effluent</text>' +
            '<line x1="100" y1="100" x2="135" y2="100" stroke="#3b82f6" stroke-width="2" marker-end="url(#arrow)"/>' +
            '<line x1="320" y1="100" x2="355" y2="100" stroke="#22c55e" stroke-width="2" marker-end="url(#arrow)"/>' +
            '<line x1="460" y1="100" x2="495" y2="100" stroke="#f59e0b" stroke-width="2" marker-end="url(#arrow)"/>' +
            '<path d="M410 150 L410 180 L180 180 L180 160" stroke="#a855f7" stroke-width="2" fill="none" marker-end="url(#arrow)"/><text x="295" y="195" text-anchor="middle" fill="#c4b5fd" font-size="10">RAS Return</text>' +
            '<line x1="410" y1="150" x2="410" y2="170" stroke="#ef4444" stroke-width="2"/><line x1="410" y1="170" x2="480" y2="170" stroke="#ef4444" stroke-width="2" marker-end="url(#arrow)"/><text x="445" y="165" fill="#f87171" font-size="9">WAS</text>' +
            '<text x="10" y="25" fill="#64748b" font-size="10">Influent â†’</text>' +
            '</svg>',
        clarifier: '<svg viewBox="0 0 400 200" xmlns="http://www.w3.org/2000/svg">' +
            '<ellipse cx="200" cy="100" rx="150" ry="80" fill="#1e3a5f" stroke="#f59e0b" stroke-width="2"/>' +
            '<line x1="200" y1="20" x2="200" y2="100" stroke="#3b82f6" stroke-width="3"/><text x="210" y="60" fill="#94a3b8" font-size="10">Influent</text>' +
            '<rect x="180" y="90" width="40" height="30" fill="#334155" stroke="#475569"/><text x="200" y="110" text-anchor="middle" fill="#94a3b8" font-size="8">Baffle</text>' +
            '<ellipse cx="200" cy="150" rx="120" ry="20" fill="#7c3aed" opacity="0.3"/><text x="200" y="155" text-anchor="middle" fill="#a78bfa" font-size="10">Sludge Blanket</text>' +
            '<line x1="50" y1="60" x2="20" y2="60" stroke="#22d3ee" stroke-width="2"/><text x="35" y="50" fill="#22d3ee" font-size="9">Effluent</text>' +
            '<line x1="350" y1="60" x2="380" y2="60" stroke="#22d3ee" stroke-width="2"/>' +
            '<line x1="200" y1="170" x2="200" y2="195" stroke="#a855f7" stroke-width="2"/><text x="200" y="198" text-anchor="middle" fill="#c4b5fd" font-size="9">RAS/WAS</text>' +
            '</svg>',
        digester: '<svg viewBox="0 0 400 220" xmlns="http://www.w3.org/2000/svg">' +
            '<defs><marker id="arr2" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#f59e0b"/></marker></defs>' +
            '<ellipse cx="200" cy="45" rx="90" ry="25" fill="#1e3a5f" stroke="#f59e0b" stroke-width="2"/>' +
            '<path d="M110 45 L110 150 Q110 180 140 180 L260 180 Q290 180 290 150 L290 45" fill="#1e3a5f" stroke="#f59e0b" stroke-width="2"/>' +
            '<ellipse cx="200" cy="45" rx="90" ry="25" fill="none" stroke="#f59e0b" stroke-width="2"/>' +
            '<text x="200" y="50" text-anchor="middle" fill="#fbbf24" font-size="11">Gas Dome</text>' +
            '<path d="M200 20 L200 5 L230 5" stroke="#22c55e" stroke-width="2" marker-end="url(#arr2)"/><text x="255" y="10" fill="#4ade80" font-size="9">Biogas</text>' +
            '<ellipse cx="200" cy="120" rx="70" ry="40" fill="#7c3aed" opacity="0.2"/>' +
            '<text x="200" y="115" text-anchor="middle" fill="#a78bfa" font-size="10">Active Zone</text><text x="200" y="130" text-anchor="middle" fill="#94a3b8" font-size="8">95-98Â°F</text>' +
            '<circle cx="170" cy="100" r="4" fill="#f59e0b"><animate attributeName="cy" values="100;80;100" dur="3s" repeatCount="indefinite"/></circle>' +
            '<circle cx="200" cy="110" r="4" fill="#f59e0b"><animate attributeName="cy" values="110;85;110" dur="2.5s" repeatCount="indefinite"/></circle>' +
            '<circle cx="230" cy="95" r="4" fill="#f59e0b"><animate attributeName="cy" values="95;75;95" dur="2.8s" repeatCount="indefinite"/></circle>' +
            '<line x1="60" y1="100" x2="105" y2="100" stroke="#3b82f6" stroke-width="2" marker-end="url(#arr2)"/><text x="50" y="95" fill="#94a3b8" font-size="9">Feed</text>' +
            '<line x1="295" y1="160" x2="340" y2="160" stroke="#a855f7" stroke-width="2" marker-end="url(#arr2)"/><text x="345" y="165" fill="#c4b5fd" font-size="9">Digested</text>' +
            '<rect x="130" y="185" width="140" height="25" rx="4" fill="#334155" stroke="#475569"/><text x="200" y="202" text-anchor="middle" fill="#94a3b8" font-size="9">Heat Exchanger</text>' +
            '</svg>',
        disinfection: '<svg viewBox="0 0 500 180" xmlns="http://www.w3.org/2000/svg">' +
            '<defs><marker id="arr3" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#06b6d4"/></marker></defs>' +
            '<rect x="20" y="40" width="60" height="100" rx="5" fill="#1e3a5f" stroke="#3b82f6"/><text x="50" y="95" text-anchor="middle" fill="#94a3b8" font-size="10">Inlet</text>' +
            '<rect x="100" y="30" width="280" height="120" rx="5" fill="#1e3a5f" stroke="#22c55e" stroke-width="2"/>' +
            '<text x="240" y="55" text-anchor="middle" fill="#4ade80" font-size="12">Chlorine Contact Chamber</text>' +
            '<line x1="120" y1="60" x2="120" y2="130" stroke="#475569" stroke-width="2"/>' +
            '<line x1="180" y1="60" x2="180" y2="130" stroke="#475569" stroke-width="2"/>' +
            '<line x1="240" y1="60" x2="240" y2="130" stroke="#475569" stroke-width="2"/>' +
            '<line x1="300" y1="60" x2="300" y2="130" stroke="#475569" stroke-width="2"/>' +
            '<line x1="360" y1="60" x2="360" y2="130" stroke="#475569" stroke-width="2"/>' +
            '<text x="150" y="100" text-anchor="middle" fill="#64748b" font-size="8">Baffle</text>' +
            '<path d="M90 90 Q105 90 110 75 Q115 60 130 60 Q145 60 150 75 Q155 90 170 90 Q185 90 190 105 Q195 120 210 120" stroke="#06b6d4" stroke-width="2" fill="none" opacity="0.6"><animate attributeName="stroke-dashoffset" from="100" to="0" dur="2s" repeatCount="indefinite"/></path>' +
            '<circle cx="130" cy="80" r="20" fill="#fbbf24" opacity="0.15"><animate attributeName="r" values="15;25;15" dur="2s" repeatCount="indefinite"/></circle>' +
            '<text x="130" y="85" text-anchor="middle" fill="#fbbf24" font-size="8">Clâ‚‚</text>' +
            '<rect x="400" y="40" width="80" height="100" rx="5" fill="#1e3a5f" stroke="#06b6d4"/><text x="440" y="85" text-anchor="middle" fill="#22d3ee" font-size="10">Effluent</text><text x="440" y="100" text-anchor="middle" fill="#94a3b8" font-size="8">Residual</text>' +
            '<line x1="80" y1="90" x2="95" y2="90" stroke="#3b82f6" stroke-width="2" marker-end="url(#arr3)"/>' +
            '<line x1="385" y1="90" x2="395" y2="90" stroke="#22c55e" stroke-width="2" marker-end="url(#arr3)"/>' +
            '<text x="240" y="165" text-anchor="middle" fill="#64748b" font-size="10">CT = Concentration Ã— Contact Time (Tâ‚â‚€)</text>' +
            '</svg>',
        lift_station: '<svg viewBox="0 0 400 240" xmlns="http://www.w3.org/2000/svg">' +
            '<defs><marker id="arr4" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#a855f7"/></marker></defs>' +
            '<rect x="100" y="60" width="200" height="150" rx="5" fill="#1e3a5f" stroke="#475569" stroke-width="2"/>' +
            '<text x="200" y="85" text-anchor="middle" fill="#94a3b8" font-size="11">Wet Well</text>' +
            '<rect x="110" y="140" width="180" height="60" fill="#3b82f6" opacity="0.3"/>' +
            '<line x1="110" y1="140" x2="290" y2="140" stroke="#3b82f6" stroke-width="2" stroke-dasharray="5,3"><animate attributeName="y1" values="140;130;140" dur="4s" repeatCount="indefinite"/><animate attributeName="y2" values="140;130;140" dur="4s" repeatCount="indefinite"/></line>' +
            '<text x="200" y="175" text-anchor="middle" fill="#60a5fa" font-size="9">Water Level</text>' +
            '<ellipse cx="160" cy="180" rx="25" ry="15" fill="#334155" stroke="#f59e0b" stroke-width="2"/><text x="160" y="184" text-anchor="middle" fill="#fbbf24" font-size="8">Pump 1</text>' +
            '<ellipse cx="240" cy="180" rx="25" ry="15" fill="#334155" stroke="#f59e0b" stroke-width="2"/><text x="240" y="184" text-anchor="middle" fill="#fbbf24" font-size="8">Pump 2</text>' +
            '<line x1="40" y1="120" x2="95" y2="120" stroke="#64748b" stroke-width="3"/><text x="30" y="115" fill="#94a3b8" font-size="9">Influent</text>' +
            '<path d="M160 165 L160 50 L320 50" stroke="#a855f7" stroke-width="3" fill="none" marker-end="url(#arr4)"/>' +
            '<path d="M240 165 L240 65 L320 65" stroke="#a855f7" stroke-width="3" fill="none" stroke-dasharray="8,4"/>' +
            '<text x="350" y="60" fill="#c4b5fd" font-size="10">Force Main</text>' +
            '<circle cx="130" cy="105" r="8" fill="#22c55e"/><text x="130" y="108" text-anchor="middle" fill="#fff" font-size="7">H</text>' +
            '<circle cx="170" cy="105" r="8" fill="#f59e0b"/><text x="170" y="108" text-anchor="middle" fill="#fff" font-size="7">L</text>' +
            '<text x="150" y="125" text-anchor="middle" fill="#64748b" font-size="8">Floats</text>' +
            '<text x="200" y="230" text-anchor="middle" fill="#64748b" font-size="9">Duplex Station: Lead/Lag Pumps</text>' +
            '</svg>',
        bnr: '<svg viewBox="0 0 650 200" xmlns="http://www.w3.org/2000/svg">' +
            '<defs><marker id="arr5" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#3b82f6"/></marker></defs>' +
            '<rect x="20" y="60" width="100" height="80" rx="5" fill="#1e3a5f" stroke="#a855f7" stroke-width="2"/><text x="70" y="95" text-anchor="middle" fill="#c4b5fd" font-size="10">Anaerobic</text><text x="70" y="110" text-anchor="middle" fill="#94a3b8" font-size="8">P Release</text>' +
            '<rect x="140" y="60" width="100" height="80" rx="5" fill="#1e3a5f" stroke="#6366f1" stroke-width="2"/><text x="190" y="95" text-anchor="middle" fill="#a5b4fc" font-size="10">Anoxic</text><text x="190" y="110" text-anchor="middle" fill="#94a3b8" font-size="8">Denitrification</text>' +
            '<rect x="260" y="50" width="140" height="100" rx="5" fill="#1e3a5f" stroke="#22c55e" stroke-width="2"/><text x="330" y="90" text-anchor="middle" fill="#4ade80" font-size="11">Aerobic</text><text x="330" y="108" text-anchor="middle" fill="#94a3b8" font-size="8">Nitrification</text><text x="330" y="122" text-anchor="middle" fill="#94a3b8" font-size="8">P Uptake</text>' +
            '<circle cx="330" cy="135" r="6" fill="#22c55e" opacity="0.6"><animate attributeName="r" values="4;8;4" dur="1.5s" repeatCount="indefinite"/></circle>' +
            '<rect x="420" y="60" width="80" height="80" rx="40" fill="#1e3a5f" stroke="#f59e0b" stroke-width="2"/><text x="460" y="100" text-anchor="middle" fill="#fbbf24" font-size="9">Clarifier</text>' +
            '<rect x="520" y="70" width="60" height="60" rx="5" fill="#1e3a5f" stroke="#06b6d4"/><text x="550" y="105" text-anchor="middle" fill="#22d3ee" font-size="10">Effluent</text>' +
            '<line x1="120" y1="100" x2="135" y2="100" stroke="#a855f7" stroke-width="2" marker-end="url(#arr5)"/>' +
            '<line x1="240" y1="100" x2="255" y2="100" stroke="#6366f1" stroke-width="2" marker-end="url(#arr5)"/>' +
            '<line x1="400" y1="100" x2="415" y2="100" stroke="#22c55e" stroke-width="2" marker-end="url(#arr5)"/>' +
            '<line x1="500" y1="100" x2="515" y2="100" stroke="#f59e0b" stroke-width="2" marker-end="url(#arr5)"/>' +
            '<path d="M460 140 L460 170 L70 170 L70 145" stroke="#c4b5fd" stroke-width="2" fill="none" marker-end="url(#arr5)"/><text x="265" y="185" text-anchor="middle" fill="#a78bfa" font-size="9">RAS Return</text>' +
            '<path d="M380 150 L380 160 L210 160 L210 145" stroke="#818cf8" stroke-width="2" fill="none" stroke-dasharray="4,2" marker-end="url(#arr5)"/><text x="295" y="158" fill="#a5b4fc" font-size="8">Internal Recycle (NRCY)</text>' +
            '<text x="10" y="100" fill="#64748b" font-size="9">Inf â†’</text>' +
            '</svg>',
        dewatering: '<svg viewBox="0 0 500 200" xmlns="http://www.w3.org/2000/svg">' +
            '<defs><marker id="arr6" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#f59e0b"/></marker></defs>' +
            '<rect x="20" y="50" width="80" height="100" rx="5" fill="#1e3a5f" stroke="#3b82f6"/><text x="60" y="95" text-anchor="middle" fill="#60a5fa" font-size="10">Sludge</text><text x="60" y="110" text-anchor="middle" fill="#94a3b8" font-size="8">2-4%</text>' +
            '<rect x="130" y="40" width="60" height="50" rx="5" fill="#1e3a5f" stroke="#a855f7"/><text x="160" y="60" text-anchor="middle" fill="#c4b5fd" font-size="8">Polymer</text><text x="160" y="75" text-anchor="middle" fill="#94a3b8" font-size="7">Mixing</text>' +
            '<line x1="160" y1="90" x2="160" y2="100" stroke="#a855f7" stroke-width="2"/>' +
            '<rect x="120" y="100" width="260" height="60" rx="5" fill="#1e3a5f" stroke="#f59e0b" stroke-width="2"/>' +
            '<line x1="140" y1="115" x2="360" y2="115" stroke="#64748b" stroke-width="1"/>' +
            '<line x1="140" y1="145" x2="360" y2="145" stroke="#64748b" stroke-width="1"/>' +
            '<text x="250" y="135" text-anchor="middle" fill="#fbbf24" font-size="11">Belt Filter Press</text>' +
            '<circle cx="150" cy="130" r="12" fill="#334155" stroke="#f59e0b"><animateTransform attributeName="transform" type="rotate" from="0 150 130" to="360 150 130" dur="2s" repeatCount="indefinite"/></circle>' +
            '<circle cx="250" cy="130" r="12" fill="#334155" stroke="#f59e0b"><animateTransform attributeName="transform" type="rotate" from="0 250 130" to="360 250 130" dur="2s" repeatCount="indefinite"/></circle>' +
            '<circle cx="350" cy="130" r="12" fill="#334155" stroke="#f59e0b"><animateTransform attributeName="transform" type="rotate" from="0 350 130" to="360 350 130" dur="2s" repeatCount="indefinite"/></circle>' +
            '<line x1="100" y1="95" x2="115" y2="110" stroke="#3b82f6" stroke-width="2" marker-end="url(#arr6)"/>' +
            '<rect x="400" y="80" width="80" height="80" rx="5" fill="#1e3a5f" stroke="#22c55e"/><text x="440" y="115" text-anchor="middle" fill="#4ade80" font-size="10">Cake</text><text x="440" y="132" text-anchor="middle" fill="#94a3b8" font-size="8">18-25%</text>' +
            '<line x1="385" y1="130" x2="395" y2="130" stroke="#f59e0b" stroke-width="2" marker-end="url(#arr6)"/>' +
            '<path d="M250 165 L250 185 L100 185" stroke="#06b6d4" stroke-width="2" fill="none" marker-end="url(#arr6)"/><text x="175" y="180" fill="#22d3ee" font-size="8">Filtrate Return</text>' +
            '</svg>',
        primary: '<svg viewBox="0 0 450 200" xmlns="http://www.w3.org/2000/svg">' +
            '<defs><marker id="arr7" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#3b82f6"/></marker></defs>' +
            '<rect x="80" y="40" width="280" height="120" rx="5" fill="#1e3a5f" stroke="#3b82f6" stroke-width="2"/>' +
            '<text x="220" y="65" text-anchor="middle" fill="#60a5fa" font-size="12">Primary Clarifier</text>' +
            '<line x1="80" y1="100" x2="360" y2="100" stroke="#475569" stroke-width="1" stroke-dasharray="4,2"/>' +
            '<rect x="100" y="105" width="240" height="45" fill="#7c3aed" opacity="0.2"/>' +
            '<text x="220" y="130" text-anchor="middle" fill="#a78bfa" font-size="9">Settled Solids (Primary Sludge)</text>' +
            '<rect x="200" y="80" width="40" height="30" fill="#334155" stroke="#475569"/><text x="220" y="100" text-anchor="middle" fill="#94a3b8" font-size="8">Baffle</text>' +
            '<path d="M90 60 Q100 60 100 70 L100 90" stroke="#64748b" stroke-width="8" fill="none"/><text x="95" y="55" fill="#94a3b8" font-size="8">Scum</text>' +
            '<line x1="20" y1="85" x2="75" y2="85" stroke="#64748b" stroke-width="3" marker-end="url(#arr7)"/><text x="15" y="80" fill="#94a3b8" font-size="9">Inf</text>' +
            '<line x1="365" y1="85" x2="420" y2="85" stroke="#22c55e" stroke-width="3" marker-end="url(#arr7)"/><text x="425" y="90" fill="#4ade80" font-size="9">Effluent</text>' +
            '<line x1="220" y1="160" x2="220" y2="190" stroke="#a855f7" stroke-width="3" marker-end="url(#arr7)"/><text x="220" y="198" text-anchor="middle" fill="#c4b5fd" font-size="9">Primary Sludge</text>' +
            '<text x="220" y="180" text-anchor="middle" fill="#64748b" font-size="8">25-35% BOD Removal</text>' +
            '</svg>',
        forcemain: '<svg viewBox="0 0 500 180" xmlns="http://www.w3.org/2000/svg">' +
            '<defs><marker id="arr8" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#a855f7"/></marker></defs>' +
            '<rect x="20" y="50" width="80" height="100" rx="5" fill="#1e3a5f" stroke="#3b82f6"/><text x="60" y="95" text-anchor="middle" fill="#60a5fa" font-size="10">Lift</text><text x="60" y="110" text-anchor="middle" fill="#94a3b8" font-size="8">Station</text>' +
            '<ellipse cx="60" cy="125" rx="15" ry="10" fill="#f59e0b" opacity="0.5"/>' +
            '<path d="M100 90 Q150 90 150 70 Q150 50 200 50 L350 50 Q400 50 400 70 Q400 90 450 90" stroke="#a855f7" stroke-width="6" fill="none"/>' +
            '<circle cx="200" cy="50" r="4" fill="#22d3ee"><animate attributeName="cx" values="150;400" dur="3s" repeatCount="indefinite"/></circle>' +
            '<circle cx="280" cy="50" r="4" fill="#22d3ee"><animate attributeName="cx" values="150;400" dur="3s" begin="1s" repeatCount="indefinite"/></circle>' +
            '<text x="275" y="35" text-anchor="middle" fill="#c4b5fd" font-size="11">Force Main</text>' +
            '<rect x="140" y="70" width="30" height="20" fill="#334155" stroke="#f59e0b" rx="3"/><text x="155" y="85" text-anchor="middle" fill="#94a3b8" font-size="7">ARV</text>' +
            '<rect x="320" y="70" width="30" height="20" fill="#334155" stroke="#f59e0b" rx="3"/><text x="335" y="85" text-anchor="middle" fill="#94a3b8" font-size="7">ARV</text>' +
            '<rect x="420" y="60" width="60" height="60" rx="5" fill="#1e3a5f" stroke="#22c55e"/><text x="450" y="95" text-anchor="middle" fill="#4ade80" font-size="10">WWTP</text>' +
            '<text x="155" y="145" fill="#64748b" font-size="9">Velocity: 3-8 fps</text>' +
            '<text x="155" y="160" fill="#64748b" font-size="9">Detention: &lt;4 hrs to prevent septicity</text>' +
            '<text x="275" y="100" text-anchor="middle" fill="#ef4444" font-size="8">âš ï¸ Hâ‚‚S risk if DT &gt; 4 hrs</text>' +
            '</svg>',
        trickling_filter: '<svg viewBox="0 0 400 220" xmlns="http://www.w3.org/2000/svg">' +
            '<defs><marker id="arr9" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#22c55e"/></marker></defs>' +
            '<ellipse cx="200" cy="30" rx="120" ry="20" fill="#1e3a5f" stroke="#3b82f6" stroke-width="2"/>' +
            '<rect x="80" y="30" width="240" height="130" fill="#1e3a5f" stroke="#22c55e" stroke-width="2"/>' +
            '<ellipse cx="200" cy="160" rx="120" ry="20" fill="#1e3a5f" stroke="#22c55e" stroke-width="2"/>' +
            '<line x1="200" y1="10" x2="200" y2="25" stroke="#3b82f6" stroke-width="3"/><text x="215" y="18" fill="#60a5fa" font-size="9">Influent</text>' +
            '<path d="M140 35 L140 45 M160 35 L160 50 M180 35 L180 45 M200 35 L200 50 M220 35 L220 45 M240 35 L240 50 M260 35 L260 45" stroke="#60a5fa" stroke-width="2" opacity="0.6"/>' +
            '<text x="200" y="60" text-anchor="middle" fill="#94a3b8" font-size="9">Rotary Distributor</text>' +
            '<rect x="100" y="70" width="200" height="80" fill="#334155" opacity="0.5"/>' +
            '<text x="200" y="100" text-anchor="middle" fill="#4ade80" font-size="11">Media Bed</text>' +
            '<text x="200" y="115" text-anchor="middle" fill="#94a3b8" font-size="8">Rock/Plastic Media</text>' +
            '<text x="200" y="130" text-anchor="middle" fill="#94a3b8" font-size="8">Biofilm Growth</text>' +
            '<circle cx="130" cy="105" r="4" fill="#22c55e" opacity="0.6"><animate attributeName="cy" values="75;145" dur="4s" repeatCount="indefinite"/></circle>' +
            '<circle cx="200" cy="90" r="4" fill="#22c55e" opacity="0.6"><animate attributeName="cy" values="75;145" dur="3.5s" repeatCount="indefinite"/></circle>' +
            '<circle cx="270" cy="100" r="4" fill="#22c55e" opacity="0.6"><animate attributeName="cy" values="75;145" dur="4.2s" repeatCount="indefinite"/></circle>' +
            '<rect x="90" y="155" width="220" height="15" fill="#1e3a5f" stroke="#475569"/><text x="200" y="166" text-anchor="middle" fill="#94a3b8" font-size="8">Underdrain</text>' +
            '<line x1="200" y1="175" x2="200" y2="200" stroke="#f59e0b" stroke-width="2" marker-end="url(#arr9)"/><text x="200" y="215" text-anchor="middle" fill="#fbbf24" font-size="9">To Clarifier</text>' +
            '<path d="M320" y="180" L350 180 L350 50 L320 50" stroke="#a855f7" stroke-width="2" fill="none" stroke-dasharray="4,2"/><text x="365" y="115" fill="#c4b5fd" font-size="8" transform="rotate(90,365,115)">Recirculation</text>' +
            '</svg>',
        sbr: '<svg viewBox="0 0 550 200" xmlns="http://www.w3.org/2000/svg">' +
            '<defs><marker id="arr10" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#6366f1"/></marker></defs>' +
            '<text x="275" y="20" text-anchor="middle" fill="#a5b4fc" font-size="12" font-weight="bold">SBR Cycle Phases</text>' +
            '<rect x="20" y="40" width="95" height="80" rx="5" fill="#1e3a5f" stroke="#3b82f6" stroke-width="2"/>' +
            '<text x="67" y="75" text-anchor="middle" fill="#60a5fa" font-size="10">1. FILL</text>' +
            '<text x="67" y="90" text-anchor="middle" fill="#94a3b8" font-size="8">Influent enters</text>' +
            '<line x1="67" y1="35" x2="67" y2="50" stroke="#3b82f6" stroke-width="2"/>' +
            '<rect x="130" y="40" width="95" height="80" rx="5" fill="#1e3a5f" stroke="#22c55e" stroke-width="2"/>' +
            '<text x="177" y="75" text-anchor="middle" fill="#4ade80" font-size="10">2. REACT</text>' +
            '<text x="177" y="90" text-anchor="middle" fill="#94a3b8" font-size="8">Aeration ON</text>' +
            '<circle cx="177" cy="105" r="6" fill="#22c55e" opacity="0.6"><animate attributeName="r" values="4;8;4" dur="1s" repeatCount="indefinite"/></circle>' +
            '<rect x="240" y="40" width="95" height="80" rx="5" fill="#1e3a5f" stroke="#f59e0b" stroke-width="2"/>' +
            '<text x="287" y="75" text-anchor="middle" fill="#fbbf24" font-size="10">3. SETTLE</text>' +
            '<text x="287" y="90" text-anchor="middle" fill="#94a3b8" font-size="8">Quiescent</text>' +
            '<rect x="260" y="95" width="55" height="15" fill="#7c3aed" opacity="0.3"/>' +
            '<rect x="350" y="40" width="95" height="80" rx="5" fill="#1e3a5f" stroke="#06b6d4" stroke-width="2"/>' +
            '<text x="397" y="75" text-anchor="middle" fill="#22d3ee" font-size="10">4. DECANT</text>' +
            '<text x="397" y="90" text-anchor="middle" fill="#94a3b8" font-size="8">Effluent out</text>' +
            '<line x1="397" y1="50" x2="397" y2="35" stroke="#06b6d4" stroke-width="2" marker-end="url(#arr10)"/>' +
            '<rect x="460" y="40" width="70" height="80" rx="5" fill="#1e3a5f" stroke="#a855f7" stroke-width="2"/>' +
            '<text x="495" y="75" text-anchor="middle" fill="#c4b5fd" font-size="10">5. IDLE</text>' +
            '<text x="495" y="90" text-anchor="middle" fill="#94a3b8" font-size="8">WAS</text>' +
            '<line x1="115" y1="80" x2="125" y2="80" stroke="#64748b" stroke-width="2" marker-end="url(#arr10)"/>' +
            '<line x1="225" y1="80" x2="235" y2="80" stroke="#64748b" stroke-width="2" marker-end="url(#arr10)"/>' +
            '<line x1="335" y1="80" x2="345" y2="80" stroke="#64748b" stroke-width="2" marker-end="url(#arr10)"/>' +
            '<line x1="445" y1="80" x2="455" y2="80" stroke="#64748b" stroke-width="2" marker-end="url(#arr10)"/>' +
            '<text x="275" y="150" text-anchor="middle" fill="#64748b" font-size="9">Typical cycle: 4-6 hours | Multiple basins operate in sequence</text>' +
            '<text x="275" y="170" text-anchor="middle" fill="#64748b" font-size="9">No separate clarifier needed - settling occurs in same tank</text>' +
            '</svg>',
        oxidation_ditch: '<svg viewBox="0 0 500 200" xmlns="http://www.w3.org/2000/svg">' +
            '<defs><marker id="arr11" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#22c55e"/></marker></defs>' +
            '<path d="M100 50 L350 50 Q450 50 450 100 Q450 150 350 150 L100 150 Q50 150 50 100 Q50 50 100 50" fill="#1e3a5f" stroke="#22c55e" stroke-width="2"/>' +
            '<path d="M130 70 L320 70 Q400 70 400 100 Q400 130 320 130 L130 130 Q80 130 80 100 Q80 70 130 70" fill="#0f172a" stroke="#475569" stroke-width="1"/>' +
            '<text x="250" y="105" text-anchor="middle" fill="#4ade80" font-size="12">Oxidation Ditch</text>' +
            '<ellipse cx="150" cy="100" rx="25" ry="35" fill="none" stroke="#f59e0b" stroke-width="3"/>' +
            '<text x="150" y="105" text-anchor="middle" fill="#fbbf24" font-size="8">Rotor</text>' +
            '<path d="M180 85 Q220 75 260 85 Q300 95 340 85 Q380 75 410 90" stroke="#60a5fa" stroke-width="2" fill="none" opacity="0.6"><animate attributeName="d" values="M180 85 Q220 75 260 85 Q300 95 340 85 Q380 75 410 90;M180 90 Q220 95 260 85 Q300 75 340 90 Q380 95 410 85;M180 85 Q220 75 260 85 Q300 95 340 85 Q380 75 410 90" dur="3s" repeatCount="indefinite"/></path>' +
            '<circle cx="200" cy="90" r="4" fill="#22c55e"><animate attributeName="cx" values="180;420;180" dur="8s" repeatCount="indefinite"/></circle>' +
            '<circle cx="300" cy="110" r="4" fill="#22c55e"><animate attributeName="cx" values="180;420;180" dur="8s" begin="2s" repeatCount="indefinite"/></circle>' +
            '<line x1="50" y1="100" x2="20" y2="100" stroke="#3b82f6" stroke-width="2"/><text x="10" y="95" fill="#60a5fa" font-size="8">Inf</text>' +
            '<line x1="480" y1="100" x2="450" y2="100" stroke="#06b6d4" stroke-width="2" marker-end="url(#arr11)"/><text x="485" y="105" fill="#22d3ee" font-size="8">Eff</text>' +
            '<text x="250" y="175" text-anchor="middle" fill="#64748b" font-size="9">Extended aeration â€¢ Low F:M â€¢ Long SRT â€¢ Complete mix</text>' +
            '<text x="150" y="145" fill="#94a3b8" font-size="7">Aerobic</text><text x="350" y="145" fill="#94a3b8" font-size="7">Anoxic zones</text>' +
            '</svg>',
        mbr: '<svg viewBox="0 0 500 200" xmlns="http://www.w3.org/2000/svg">' +
            '<defs><marker id="arr12" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#ec4899"/></marker></defs>' +
            '<rect x="20" y="50" width="180" height="100" rx="5" fill="#1e3a5f" stroke="#22c55e" stroke-width="2"/>' +
            '<text x="110" y="90" text-anchor="middle" fill="#4ade80" font-size="11">Bioreactor</text>' +
            '<text x="110" y="108" text-anchor="middle" fill="#94a3b8" font-size="8">MLSS 8,000-12,000 mg/L</text>' +
            '<circle cx="60" cy="120" r="6" fill="#22c55e" opacity="0.6"><animate attributeName="r" values="4;8;4" dur="1.5s" repeatCount="indefinite"/></circle>' +
            '<circle cx="110" cy="125" r="6" fill="#22c55e" opacity="0.6"><animate attributeName="r" values="4;8;4" dur="1.5s" begin="0.5s" repeatCount="indefinite"/></circle>' +
            '<circle cx="160" cy="120" r="6" fill="#22c55e" opacity="0.6"><animate attributeName="r" values="4;8;4" dur="1.5s" begin="1s" repeatCount="indefinite"/></circle>' +
            '<rect x="230" y="40" width="120" height="120" rx="5" fill="#1e3a5f" stroke="#ec4899" stroke-width="2"/>' +
            '<text x="290" y="70" text-anchor="middle" fill="#f472b6" font-size="11">Membrane Tank</text>' +
            '<rect x="250" y="80" width="20" height="60" fill="#334155" stroke="#ec4899"/>' +
            '<rect x="280" y="80" width="20" height="60" fill="#334155" stroke="#ec4899"/>' +
            '<rect x="310" y="80" width="20" height="60" fill="#334155" stroke="#ec4899"/>' +
            '<text x="290" y="155" text-anchor="middle" fill="#94a3b8" font-size="8">UF/MF Membranes</text>' +
            '<rect x="380" y="70" width="100" height="60" rx="5" fill="#1e3a5f" stroke="#06b6d4"/>' +
            '<text x="430" y="95" text-anchor="middle" fill="#22d3ee" font-size="10">Permeate</text>' +
            '<text x="430" y="110" text-anchor="middle" fill="#94a3b8" font-size="8">High Quality</text>' +
            '<line x1="200" y1="100" x2="225" y2="100" stroke="#22c55e" stroke-width="2" marker-end="url(#arr12)"/>' +
            '<line x1="350" y1="100" x2="375" y2="100" stroke="#ec4899" stroke-width="2" marker-end="url(#arr12)"/>' +
            '<path d="M290 165 L290 180 L60 180 L60 155" stroke="#a855f7" stroke-width="2" fill="none" marker-end="url(#arr12)"/><text x="175" y="193" text-anchor="middle" fill="#c4b5fd" font-size="8">RAS (high rate)</text>' +
            '<line x1="10" y1="100" x2="25" y2="100" stroke="#3b82f6" stroke-width="2"/><text x="5" y="95" fill="#60a5fa" font-size="8">Inf</text>' +
            '</svg>',
        grit_chamber: '<svg viewBox="0 0 450 180" xmlns="http://www.w3.org/2000/svg">' +
            '<defs><marker id="arr13" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#64748b"/></marker></defs>' +
            '<rect x="80" y="40" width="280" height="100" rx="5" fill="#1e3a5f" stroke="#64748b" stroke-width="2"/>' +
            '<text x="220" y="65" text-anchor="middle" fill="#94a3b8" font-size="11">Aerated Grit Chamber</text>' +
            '<path d="M100 130 L120 110 L340 110 L360 130" fill="#7c3aed" opacity="0.3" stroke="#a855f7"/>' +
            '<text x="220" y="125" text-anchor="middle" fill="#c4b5fd" font-size="9">Grit Collection</text>' +
            '<ellipse cx="140" cy="85" rx="15" ry="10" fill="none" stroke="#22c55e" stroke-width="2"/>' +
            '<path d="M125 85 Q140 70 155 85 Q140 100 125 85" stroke="#22c55e" stroke-width="1" fill="none"><animateTransform attributeName="transform" type="rotate" from="0 140 85" to="360 140 85" dur="2s" repeatCount="indefinite"/></path>' +
            '<text x="140" y="60" fill="#4ade80" font-size="8">Air</text>' +
            '<circle cx="180" cy="100" r="3" fill="#94a3b8"><animate attributeName="cy" values="70;120" dur="2s" repeatCount="indefinite"/></circle>' +
            '<circle cx="220" cy="90" r="3" fill="#94a3b8"><animate attributeName="cy" values="70;120" dur="2.5s" repeatCount="indefinite"/></circle>' +
            '<circle cx="260" cy="95" r="3" fill="#94a3b8"><animate attributeName="cy" values="70;120" dur="2.2s" repeatCount="indefinite"/></circle>' +
            '<line x1="20" y1="80" x2="75" y2="80" stroke="#3b82f6" stroke-width="3" marker-end="url(#arr13)"/><text x="15" y="75" fill="#60a5fa" font-size="9">Inf</text>' +
            '<line x1="365" y1="80" x2="420" y2="80" stroke="#22c55e" stroke-width="3" marker-end="url(#arr13)"/><text x="425" y="85" fill="#4ade80" font-size="9">To Primary</text>' +
            '<line x1="220" y1="140" x2="220" y2="165" stroke="#a855f7" stroke-width="2" marker-end="url(#arr13)"/><text x="220" y="175" text-anchor="middle" fill="#c4b5fd" font-size="8">Grit Removal</text>' +
            '<text x="320" y="55" fill="#64748b" font-size="8">DT: 2-5 min</text>' +
            '</svg>',
        headworks: '<svg viewBox="0 0 550 180" xmlns="http://www.w3.org/2000/svg">' +
            '<defs><marker id="arr14" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#3b82f6"/></marker></defs>' +
            '<text x="275" y="20" text-anchor="middle" fill="#94a3b8" font-size="11">Headworks - Preliminary Treatment</text>' +
            '<rect x="30" y="50" width="80" height="80" rx="5" fill="#1e3a5f" stroke="#64748b" stroke-width="2"/>' +
            '<text x="70" y="85" text-anchor="middle" fill="#94a3b8" font-size="9">Bar Screen</text>' +
            '<line x1="50" y1="95" x2="50" y2="115" stroke="#475569" stroke-width="2"/>' +
            '<line x1="60" y1="95" x2="60" y2="115" stroke="#475569" stroke-width="2"/>' +
            '<line x1="70" y1="95" x2="70" y2="115" stroke="#475569" stroke-width="2"/>' +
            '<line x1="80" y1="95" x2="80" y2="115" stroke="#475569" stroke-width="2"/>' +
            '<line x1="90" y1="95" x2="90" y2="115" stroke="#475569" stroke-width="2"/>' +
            '<rect x="140" y="50" width="100" height="80" rx="5" fill="#1e3a5f" stroke="#64748b" stroke-width="2"/>' +
            '<text x="190" y="85" text-anchor="middle" fill="#94a3b8" font-size="9">Grit Chamber</text>' +
            '<text x="190" y="100" text-anchor="middle" fill="#64748b" font-size="7">2-5 min DT</text>' +
            '<path d="M155 115 L225 115" stroke="#a855f7" stroke-width="3"/>' +
            '<rect x="270" y="50" width="100" height="80" rx="5" fill="#1e3a5f" stroke="#3b82f6" stroke-width="2"/>' +
            '<text x="320" y="85" text-anchor="middle" fill="#60a5fa" font-size="9">Flow Meter</text>' +
            '<text x="320" y="100" text-anchor="middle" fill="#64748b" font-size="7">Parshall Flume</text>' +
            '<rect x="400" y="50" width="100" height="80" rx="5" fill="#1e3a5f" stroke="#22c55e" stroke-width="2"/>' +
            '<text x="450" y="85" text-anchor="middle" fill="#4ade80" font-size="9">To Primary</text>' +
            '<text x="450" y="100" text-anchor="middle" fill="#64748b" font-size="7">Treatment</text>' +
            '<line x1="5" y1="90" x2="25" y2="90" stroke="#64748b" stroke-width="3"/><text x="5" y="80" fill="#64748b" font-size="8">Raw</text>' +
            '<line x1="110" y1="90" x2="135" y2="90" stroke="#64748b" stroke-width="2" marker-end="url(#arr14)"/>' +
            '<line x1="240" y1="90" x2="265" y2="90" stroke="#64748b" stroke-width="2" marker-end="url(#arr14)"/>' +
            '<line x1="370" y1="90" x2="395" y2="90" stroke="#3b82f6" stroke-width="2" marker-end="url(#arr14)"/>' +
            '<text x="70" y="145" fill="#ef4444" font-size="7">Screenings</text><line x1="70" y1="130" x2="70" y2="140" stroke="#ef4444" stroke-width="1"/>' +
            '<text x="190" y="145" fill="#a855f7" font-size="7">Grit</text><line x1="190" y1="130" x2="190" y2="140" stroke="#a855f7" stroke-width="1"/>' +
            '</svg>'
    };
    
    function toggleDiagram(calcId, type) {
        var card = document.getElementById('card' + calcId);
        if (!card) return;
        var existing = card.querySelector('.process-diagram');
        if (existing) {
            existing.remove();
            return;
        }
        var diagram = processDiagrams[type];
        if (!diagram) return;
        var div = document.createElement('div');
        div.className = 'process-diagram';
        div.innerHTML = diagram;
        var body = card.querySelector('.card-body');
        if (body) body.appendChild(div);
    }

    // ==================== EXPORT / PRINT ====================
    function exportResults() {
        // Collect all cards with results
        var results = [];
        document.querySelectorAll('.card').forEach(function(card) {
            var valEl = card.querySelector('.val');
            if (!valEl || valEl.textContent === 'â€”' || valEl.textContent.trim() === '') return;
            var titleEl = card.querySelector('h2');
            var title = titleEl ? titleEl.textContent.replace('â­', '').trim() : '';
            var statusEl = card.querySelector('.status');
            var status = statusEl ? statusEl.textContent.trim() : '';
            if (valEl.textContent !== '0' && valEl.textContent !== '0.0') {
                results.push({ title: title, value: valEl.textContent, detail: status.substring(0, 500) });
            }
        });
        
        if (results.length === 0) {
            alert('No calculated results to export. Run some calculations first!');
            return;
        }
        
        // Build printable HTML
        var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>WW Pro-Calc Results Report</title>' +
            '<style>body{font-family:-apple-system,sans-serif;padding:30px;max-width:800px;margin:auto;color:#333}' +
            'h1{font-size:1.4rem;border-bottom:2px solid #3b82f6;padding-bottom:8px}' +
            '.meta{color:#666;font-size:0.8rem;margin-bottom:20px}' +
            '.item{border:1px solid #ddd;border-radius:8px;padding:12px 16px;margin:10px 0;break-inside:avoid}' +
            '.item-title{font-weight:bold;font-size:0.95rem;color:#1e293b;margin-bottom:4px}' +
            '.item-value{font-size:1.1rem;color:#3b82f6;font-weight:bold;margin-bottom:4px}' +
            '.item-detail{font-size:0.75rem;color:#666;white-space:pre-wrap;line-height:1.4}' +
            '.footer{margin-top:30px;padding-top:10px;border-top:1px solid #ddd;font-size:0.7rem;color:#999;text-align:center}' +
            '@media print{body{padding:10px}}</style></head><body>' +
            '<h1>ðŸ“Š WW Pro-Calc â€” Calculation Results Report</h1>' +
            '<div class="meta">Generated: ' + new Date().toLocaleString() + ' | ' + results.length + ' calculations | ProcessCore Systems</div>';
        
        results.forEach(function(r) {
            html += '<div class="item"><div class="item-title">' + r.title + '</div>' +
                '<div class="item-value">' + r.value + '</div>' +
                (r.detail ? '<div class="item-detail">' + r.detail.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>' : '') +
                '</div>';
        });
        
        html += '<div class="footer">WW Pro-Calc v9.1 | Built by Armand Frazier Sr. | Houston, TX | ProcessCore Systems</div>' +
            '</body></html>';
        
        // Open in new window for print/save
        var win = window.open('', '_blank');
        if (win) {
            win.document.write(html);
            win.document.close();
            setTimeout(function() { win.print(); }, 500);
        } else {
            // Fallback: download as HTML
            var blob = new Blob([html], { type: 'text/html' });
            var a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'WW-ProCalc-Results-' + new Date().toISOString().split('T')[0] + '.html';
            a.click();
        }
    }

    // ==================== QR CODE GENERATOR (minimal) ====================
    function generateQR() {
        var url = window.location.href;
        document.getElementById('qrUrl').textContent = url;
        var canvas = document.getElementById('qrCanvas');
        var ctx = canvas.getContext('2d');
        // Use a simple visual QR approach - encode URL as data pattern
        // For a proper QR, we generate via API-free pixel matrix
        var size = 200, modules = 25, cellSize = size / modules;
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, size, size);
        ctx.fillStyle = '#000000';
        
        // Generate deterministic pattern from URL hash
        var hash = [];
        for (var i = 0; i < url.length; i++) {
            hash.push(url.charCodeAt(i));
        }
        
        // Draw finder patterns (required QR structure)
        function drawFinder(x, y) {
            // 7x7 finder pattern
            for (var r = 0; r < 7; r++) {
                for (var c = 0; c < 7; c++) {
                    var fill = (r === 0 || r === 6 || c === 0 || c === 6 || (r >= 2 && r <= 4 && c >= 2 && c <= 4));
                    if (fill) {
                        ctx.fillRect((x + c) * cellSize, (y + r) * cellSize, cellSize, cellSize);
                    }
                }
            }
        }
        drawFinder(0, 0);
        drawFinder(modules - 7, 0);
        drawFinder(0, modules - 7);
        
        // Draw timing patterns
        for (var i = 8; i < modules - 8; i++) {
            if (i % 2 === 0) {
                ctx.fillRect(i * cellSize, 6 * cellSize, cellSize, cellSize);
                ctx.fillRect(6 * cellSize, i * cellSize, cellSize, cellSize);
            }
        }
        
        // Fill data area with URL-derived pattern
        var seed = 0;
        for (var j = 0; j < hash.length; j++) seed = (seed * 31 + hash[j]) & 0xFFFFFFFF;
        for (var r = 0; r < modules; r++) {
            for (var c = 0; c < modules; c++) {
                // Skip finder and timing areas
                if ((r < 8 && c < 8) || (r < 8 && c >= modules - 8) || (r >= modules - 8 && c < 8)) continue;
                if (r === 6 || c === 6) continue;
                seed = (seed * 1103515245 + 12345) & 0x7FFFFFFF;
                if ((seed >> 16) & 1) {
                    ctx.fillRect(c * cellSize, r * cellSize, cellSize, cellSize);
                }
            }
        }
        
        // Overlay text note
        ctx.fillStyle = '#3b82f6';
        ctx.font = 'bold 9px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('WW Pro-Calc v9.1', size / 2, size - 4);
    }
    
    // Generate QR on modal open  
    var _qrGenerated = false;
    var _origQrOpen = document.querySelector('[onclick*="qrModal"]');
    document.addEventListener('click', function(e) {
        if (e.target.textContent && e.target.textContent.indexOf('Share This App') > -1 && !_qrGenerated) {
            setTimeout(generateQR, 100);
            _qrGenerated = true;
        }
    });

    // ==================== ADVANCED DATA ANALYTICS & TRENDING ====================
    const TREND_STORAGE_KEY = 'ww_trend_data';
    let trendData = [];
    let trendRange = 7;
    let trendCharts = {};

    // Load Chart.js from CDN
    function loadChartJS(callback) {
        if (window.Chart) { callback(); return; }
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js';
        script.onload = callback;
        document.head.appendChild(script);
    }

    // Initialize trending module
    function initTrending() {
        loadTrendData();
        document.getElementById('log_date').valueAsDate = new Date();
        loadChartJS(() => {
            renderAllCharts();
            updateTrendStats();
            checkAlerts();
        });
    }

    // Load/Save trend data
    function loadTrendData() {
        try {
            const saved = localStorage.getItem(TREND_STORAGE_KEY);
            trendData = saved ? JSON.parse(saved) : [];
        } catch(e) { trendData = []; }
    }

    function saveTrendData() {
        try {
            localStorage.setItem(TREND_STORAGE_KEY, JSON.stringify(trendData));
        } catch(e) { console.error('Failed to save trend data'); }
    }

    // Show trending dashboard when filter selected
    function showTrendingDashboard(show) {
        const dash = document.getElementById('trendingDashboard');
        if (dash) {
            dash.style.display = show ? 'block' : 'none';
            if (show) initTrending();
        }
    }

    // Set trend range
    function setTrendRange(days, btn) {
        trendRange = days;
        document.querySelectorAll('.trend-range-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderAllCharts();
        updateTrendStats();
    }

    // Show trend panel
    function showTrendPanel(panelId, btn) {
        document.querySelectorAll('.trend-panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.trend-tab').forEach(t => t.classList.remove('active'));
        document.getElementById('panel-' + panelId).classList.add('active');
        btn.classList.add('active');
    }

    // Get filtered data by range
    function getFilteredData() {
        const cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - trendRange);
        return trendData.filter(d => new Date(d.date) >= cutoff).sort((a,b) => new Date(a.date) - new Date(b.date));
    }

    // Log trend data
    function logTrendData() {
        const date = document.getElementById('log_date').value;
        if (!date) { showToast('Please select a date', 'error'); return; }

        const entry = {
            date: date,
            timestamp: new Date().toISOString(),
            flow: parseFloat(document.getElementById('log_flow').value) || null,
            inf_bod: parseFloat(document.getElementById('log_inf_bod').value) || null,
            eff_bod: parseFloat(document.getElementById('log_eff_bod').value) || null,
            eff_tss: parseFloat(document.getElementById('log_eff_tss').value) || null,
            eff_nh3: parseFloat(document.getElementById('log_eff_nh3').value) || null,
            mlss: parseFloat(document.getElementById('log_mlss').value) || null,
            settle: parseFloat(document.getElementById('log_settle').value) || null,
            do_val: parseFloat(document.getElementById('log_do').value) || null,
            aer_vol: parseFloat(document.getElementById('log_aer_vol').value) || null,
            flux: parseFloat(document.getElementById('log_flux').value) || null,
            tmp: parseFloat(document.getElementById('log_tmp').value) || null
        };

        // Calculate derived values
        if (entry.settle && entry.mlss) {
            entry.svi = (entry.settle * 1000) / entry.mlss;
        }
        if (entry.flow && entry.inf_bod && entry.aer_vol && entry.mlss) {
            entry.fm = (entry.flow * entry.inf_bod) / (entry.aer_vol * entry.mlss);
        }
        if (entry.flux && entry.tmp && entry.tmp > 0) {
            entry.perm = entry.flux / entry.tmp;
        }
        if (entry.inf_bod && entry.eff_bod) {
            entry.removal = ((entry.inf_bod - entry.eff_bod) / entry.inf_bod) * 100;
        }

        // Check if date already exists, update if so
        const existingIdx = trendData.findIndex(d => d.date === date);
        if (existingIdx >= 0) {
            trendData[existingIdx] = entry;
            showToast('âœ“ Entry updated for ' + date, 'success');
        } else {
            trendData.push(entry);
            showToast('âœ“ Data logged for ' + date, 'success');
        }

        saveTrendData();
        renderAllCharts();
        updateTrendStats();
        updateHistoryTable();
        checkAlerts();

        // Clear form
        ['log_flow','log_inf_bod','log_eff_bod','log_eff_tss','log_eff_nh3','log_mlss','log_settle','log_do','log_aer_vol','log_flux','log_tmp'].forEach(id => {
            document.getElementById(id).value = '';
        });
        document.getElementById('log_date').valueAsDate = new Date();
    }

    // Auto-fill from current calculator inputs
    function autoFillFromCalcs() {
        const mappings = {
            'log_flow': ['p_flow', 'fm_flow', 'srt_flow'],
            'log_inf_bod': ['fm_bod'],
            'log_mlss': ['svi_mlss', 'fm_mlss', 'mbrc_mlss'],
            'log_settle': ['svi_set'],
            'log_do': ['mbrc_do'],
            'log_aer_vol': ['fm_vol', 'srt_vol'],
            'log_flux': ['flux_gpd', 'perm_flux'],
            'log_tmp': ['tmp_feed', 'perm_tmp']
        };

        let filled = 0;
        Object.keys(mappings).forEach(logId => {
            const logEl = document.getElementById(logId);
            if (logEl && !logEl.value) {
                for (const srcId of mappings[logId]) {
                    const srcEl = document.getElementById(srcId);
                    if (srcEl && srcEl.value) {
                        logEl.value = srcEl.value;
                        filled++;
                        break;
                    }
                }
            }
        });

        showToast(filled + ' fields auto-filled', 'success');
    }

    // Update statistics
    function updateTrendStats() {
        const data = getFilteredData();
        document.getElementById('stat-datapoints').textContent = data.length;

        if (data.length === 0) return;

        // SVI stats
        const sviData = data.filter(d => d.svi);
        if (sviData.length > 0) {
            const latestSVI = sviData[sviData.length - 1].svi;
            document.getElementById('stat-svi').textContent = latestSVI.toFixed(0);
            document.getElementById('svi-current').textContent = latestSVI.toFixed(0) + ' mL/g';
            
            const avg7 = sviData.slice(-7).reduce((a,b) => a + b.svi, 0) / Math.min(sviData.length, 7);
            document.getElementById('svi-avg7').textContent = avg7.toFixed(0) + ' mL/g';
            
            // Delta
            if (sviData.length > 1) {
                const prevSVI = sviData[sviData.length - 2].svi;
                const delta = latestSVI - prevSVI;
                const deltaEl = document.getElementById('stat-svi-delta');
                deltaEl.textContent = (delta >= 0 ? 'â†‘' : 'â†“') + Math.abs(delta).toFixed(0);
                deltaEl.className = 'trend-stat-delta ' + (delta > 10 ? 'up' : delta < -10 ? 'down' : 'stable');
            }

            // High days count
            const highDays = sviData.filter(d => d.svi > 150).length;
            document.getElementById('svi-highdays').textContent = highDays;
            
            // Trend direction
            if (sviData.length >= 3) {
                const recent = sviData.slice(-3);
                const trend = recent[2].svi - recent[0].svi;
                document.getElementById('svi-trend').textContent = trend > 10 ? 'â†— Rising' : trend < -10 ? 'â†˜ Falling' : 'â†’ Stable';
            }

            // Badge
            const sviBadge = document.getElementById('svi-badge');
            if (latestSVI > 200) {
                sviBadge.textContent = 'BULKING';
                sviBadge.className = 'chart-badge badge-alert';
            } else if (latestSVI > 150) {
                sviBadge.textContent = 'WARNING';
                sviBadge.className = 'chart-badge badge-warn';
            } else if (latestSVI < 80) {
                sviBadge.textContent = 'PIN FLOC';
                sviBadge.className = 'chart-badge badge-warn';
            } else {
                sviBadge.textContent = 'NORMAL';
                sviBadge.className = 'chart-badge badge-good';
            }
        }

        // F/M stats
        const fmData = data.filter(d => d.fm);
        if (fmData.length > 0) {
            const latestFM = fmData[fmData.length - 1].fm;
            document.getElementById('stat-fm').textContent = latestFM.toFixed(2);
            document.getElementById('fm-current').textContent = latestFM.toFixed(3);
            
            // In range %
            const inRange = fmData.filter(d => d.fm >= 0.2 && d.fm <= 0.5).length;
            document.getElementById('fm-inrange').textContent = ((inRange / fmData.length) * 100).toFixed(0) + '%';
            
            // Std dev
            const avg = fmData.reduce((a,b) => a + b.fm, 0) / fmData.length;
            const variance = fmData.reduce((a,b) => a + Math.pow(b.fm - avg, 2), 0) / fmData.length;
            document.getElementById('fm-stddev').textContent = Math.sqrt(variance).toFixed(3);

            // Delta
            if (fmData.length > 1) {
                const delta = latestFM - fmData[fmData.length - 2].fm;
                const deltaEl = document.getElementById('stat-fm-delta');
                deltaEl.textContent = (delta >= 0 ? 'â†‘' : 'â†“') + Math.abs(delta).toFixed(2);
                deltaEl.className = 'trend-stat-delta stable';
            }

            // Badge
            const fmBadge = document.getElementById('fm-badge');
            if (latestFM >= 0.2 && latestFM <= 0.5) {
                fmBadge.textContent = 'IN RANGE';
                fmBadge.className = 'chart-badge badge-good';
            } else {
                fmBadge.textContent = latestFM < 0.2 ? 'LOW' : 'HIGH';
                fmBadge.className = 'chart-badge badge-warn';
            }
        }

        // MLSS stats
        const mlssData = data.filter(d => d.mlss);
        if (mlssData.length > 0) {
            const avg = mlssData.reduce((a,b) => a + b.mlss, 0) / mlssData.length;
            document.getElementById('stat-mlss').textContent = avg.toFixed(0);
        }

        // MBR stats
        const mbrData = data.filter(d => d.flux && d.tmp);
        if (mbrData.length > 0) {
            const latest = mbrData[mbrData.length - 1];
            document.getElementById('mbr-flux').textContent = latest.flux.toFixed(1) + ' GFD';
            document.getElementById('mbr-tmp').textContent = latest.tmp.toFixed(1) + ' psi';
            if (latest.perm) document.getElementById('mbr-perm').textContent = latest.perm.toFixed(2);
            
            // Fouling rate
            if (mbrData.length >= 2) {
                const first = mbrData[0], last = mbrData[mbrData.length - 1];
                const days = (new Date(last.date) - new Date(first.date)) / (1000*60*60*24) || 1;
                const tmpRate = (last.tmp - first.tmp) / days;
                document.getElementById('mbr-fouling').textContent = tmpRate.toFixed(3) + ' psi/d';
                
                const mbrBadge = document.getElementById('mbr-badge');
                if (tmpRate > 0.5) {
                    mbrBadge.textContent = 'FOULING';
                    mbrBadge.className = 'chart-badge badge-alert';
                } else if (tmpRate > 0.2) {
                    mbrBadge.textContent = 'WATCH';
                    mbrBadge.className = 'chart-badge badge-warn';
                } else {
                    mbrBadge.textContent = 'CLEAN';
                    mbrBadge.className = 'chart-badge badge-good';
                }
            }
        }

        // Effluent stats
        const effData = data.filter(d => d.eff_bod || d.eff_tss || d.eff_nh3);
        if (effData.length > 0) {
            const latest = effData[effData.length - 1];
            if (latest.eff_bod) document.getElementById('eff-bod').textContent = latest.eff_bod.toFixed(1) + ' mg/L';
            if (latest.eff_tss) document.getElementById('eff-tss').textContent = latest.eff_tss.toFixed(1) + ' mg/L';
            if (latest.eff_nh3) document.getElementById('eff-nh3').textContent = latest.eff_nh3.toFixed(2) + ' mg/L';
            if (latest.removal) document.getElementById('eff-removal').textContent = latest.removal.toFixed(1) + '%';
        }

        // Process score
        let score = 100;
        const latestData = data[data.length - 1];
        if (latestData) {
            if (latestData.svi && (latestData.svi > 150 || latestData.svi < 80)) score -= 15;
            if (latestData.fm && (latestData.fm < 0.15 || latestData.fm > 0.6)) score -= 10;
            if (latestData.eff_bod && latestData.eff_bod > 20) score -= 20;
            if (latestData.eff_tss && latestData.eff_tss > 20) score -= 15;
        }
        document.getElementById('stat-score').textContent = Math.max(0, score);
        document.getElementById('stat-score').style.color = score >= 80 ? '#4ade80' : score >= 60 ? '#f59e0b' : '#ef4444';
    }

    // Check for alerts
    function checkAlerts() {
        const alertsDiv = document.getElementById('trendAlerts');
        alertsDiv.innerHTML = '';
        const data = getFilteredData();
        if (data.length < 2) return;

        const alerts = [];
        const latest = data[data.length - 1];
        const prev = data[data.length - 2];

        // SVI alerts
        if (latest.svi) {
            if (latest.svi > 200) {
                alerts.push({ type: 'alert', icon: 'ðŸš¨', title: 'Severe Bulking Detected', desc: 'SVI at ' + latest.svi.toFixed(0) + ' mL/g â€” check for filamentous organisms, adjust F/M or chlorinate RAS.' });
            } else if (latest.svi > 150 && prev.svi && prev.svi <= 150) {
                alerts.push({ type: 'warn', icon: 'âš ï¸', title: 'SVI Rising Into Bulking Range', desc: 'SVI crossed 150 threshold. Monitor closely and consider process adjustments.' });
            }
            // Rate of change alert
            if (prev.svi && (latest.svi - prev.svi) > 30) {
                alerts.push({ type: 'warn', icon: 'ðŸ“ˆ', title: 'Rapid SVI Increase', desc: 'SVI increased by ' + (latest.svi - prev.svi).toFixed(0) + ' mL/g â€” unusual spike detected.' });
            }
        }

        // MBR fouling alert
        if (latest.tmp && data.length >= 3) {
            const tmpTrend = data.slice(-3).map(d => d.tmp).filter(Boolean);
            if (tmpTrend.length >= 3 && tmpTrend[2] - tmpTrend[0] > 2) {
                alerts.push({ type: 'warn', icon: 'ðŸ”¬', title: 'Membrane Fouling Trend', desc: 'TMP increased ' + (tmpTrend[2] - tmpTrend[0]).toFixed(1) + ' psi over 3 readings. Schedule maintenance clean.' });
            }
        }

        // Compliance alert
        if (latest.eff_bod && latest.eff_bod > 25) {
            alerts.push({ type: 'alert', icon: 'ðŸ“‹', title: 'Effluent BOD Above Limit', desc: 'Effluent BOD at ' + latest.eff_bod.toFixed(1) + ' mg/L â€” may exceed permit limits.' });
        }

        // Display alerts
        alerts.forEach(a => {
            alertsDiv.innerHTML += `<div class="trend-alert-box ${a.type}">
                <span class="trend-alert-icon">${a.icon}</span>
                <div class="trend-alert-content">
                    <div class="trend-alert-title">${a.title}</div>
                    <div class="trend-alert-desc">${a.desc}</div>
                </div>
            </div>`;
        });
    }

    // Render all charts
    function renderAllCharts() {
        if (!window.Chart) return;
        const data = getFilteredData();

        // Overview chart
        renderOverviewChart(data);
        renderSVIChart(data);
        renderFMChart(data);
        renderMBRChart(data);
        renderEffluentChart(data);
        updateHistoryTable();
    }

    function renderOverviewChart(data) {
        const ctx = document.getElementById('chartOverview');
        if (!ctx) return;
        if (trendCharts.overview) trendCharts.overview.destroy();

        const labels = data.map(d => new Date(d.date).toLocaleDateString('en-US', {month:'short', day:'numeric'}));
        
        trendCharts.overview = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'SVI', data: data.map(d => d.svi || null), borderColor: '#8b5cf6', backgroundColor: 'rgba(139,92,246,0.1)', fill: true, tension: 0.3, spanGaps: true },
                    { label: 'F/M Ã—1000', data: data.map(d => d.fm ? d.fm * 1000 : null), borderColor: '#10b981', fill: false, tension: 0.3, spanGaps: true },
                    { label: 'MLSS Ã·100', data: data.map(d => d.mlss ? d.mlss / 100 : null), borderColor: '#3b82f6', fill: false, tension: 0.3, spanGaps: true },
                    { label: 'DO Ã—10', data: data.map(d => d.do_val ? d.do_val * 10 : null), borderColor: '#f59e0b', fill: false, tension: 0.3, spanGaps: true }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                    x: { grid: { display: false }, ticks: { color: '#94a3b8', maxRotation: 45 } }
                }
            }
        });
    }

    function renderSVIChart(data) {
        const ctx = document.getElementById('chartSVI');
        if (!ctx) return;
        if (trendCharts.svi) trendCharts.svi.destroy();

        const sviData = data.filter(d => d.svi);
        const labels = sviData.map(d => new Date(d.date).toLocaleDateString('en-US', {month:'short', day:'numeric'}));
        
        trendCharts.svi = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'SVI', data: sviData.map(d => d.svi), borderColor: '#8b5cf6', backgroundColor: 'rgba(139,92,246,0.2)', fill: true, tension: 0.3, pointRadius: 4, pointBackgroundColor: '#8b5cf6' },
                    { label: 'Bulking Limit', data: sviData.map(() => 200), borderColor: '#ef4444', borderDash: [5,5], fill: false, pointRadius: 0 },
                    { label: 'Warning', data: sviData.map(() => 150), borderColor: '#f59e0b', borderDash: [5,5], fill: false, pointRadius: 0 },
                    { label: 'Pin Floc', data: sviData.map(() => 80), borderColor: '#3b82f6', borderDash: [5,5], fill: false, pointRadius: 0 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { min: 0, max: 300, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                    x: { grid: { display: false }, ticks: { color: '#94a3b8', maxRotation: 45 } }
                }
            }
        });
    }

    function renderFMChart(data) {
        const ctx = document.getElementById('chartFM');
        if (!ctx) return;
        if (trendCharts.fm) trendCharts.fm.destroy();

        const fmData = data.filter(d => d.fm);
        const labels = fmData.map(d => new Date(d.date).toLocaleDateString('en-US', {month:'short', day:'numeric'}));
        
        // Calculate moving average
        const movingAvg = fmData.map((d, i, arr) => {
            const start = Math.max(0, i - 2);
            const subset = arr.slice(start, i + 1);
            return subset.reduce((a,b) => a + b.fm, 0) / subset.length;
        });

        trendCharts.fm = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'F/M Ratio', data: fmData.map(d => d.fm), borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', fill: true, tension: 0.3, pointRadius: 4 },
                    { label: 'Moving Avg', data: movingAvg, borderColor: '#6366f1', borderDash: [3,3], fill: false, pointRadius: 0, tension: 0.3 },
                    { label: 'Upper Optimal', data: fmData.map(() => 0.5), borderColor: 'rgba(16,185,129,0.3)', fill: false, pointRadius: 0 },
                    { label: 'Lower Optimal', data: fmData.map(() => 0.2), borderColor: 'rgba(16,185,129,0.3)', fill: '-1', backgroundColor: 'rgba(16,185,129,0.1)', pointRadius: 0 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { min: 0, max: 1, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                    x: { grid: { display: false }, ticks: { color: '#94a3b8', maxRotation: 45 } }
                }
            }
        });
    }

    function renderMBRChart(data) {
        const ctx = document.getElementById('chartMBR');
        if (!ctx) return;
        if (trendCharts.mbr) trendCharts.mbr.destroy();

        const mbrData = data.filter(d => d.flux || d.tmp);
        const labels = mbrData.map(d => new Date(d.date).toLocaleDateString('en-US', {month:'short', day:'numeric'}));
        
        trendCharts.mbr = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Flux (GFD)', data: mbrData.map(d => d.flux || null), borderColor: '#3b82f6', fill: false, tension: 0.3, yAxisID: 'y', spanGaps: true },
                    { label: 'TMP (psi)', data: mbrData.map(d => d.tmp || null), borderColor: '#ef4444', fill: false, tension: 0.3, yAxisID: 'y1', spanGaps: true },
                    { label: 'Permeability', data: mbrData.map(d => d.perm || null), borderColor: '#10b981', fill: false, tension: 0.3, yAxisID: 'y', spanGaps: true }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { type: 'linear', position: 'left', grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                    y1: { type: 'linear', position: 'right', grid: { display: false }, ticks: { color: '#ef4444' } },
                    x: { grid: { display: false }, ticks: { color: '#94a3b8', maxRotation: 45 } }
                }
            }
        });
    }

    function renderEffluentChart(data) {
        const ctx = document.getElementById('chartEffluent');
        if (!ctx) return;
        if (trendCharts.effluent) trendCharts.effluent.destroy();

        const effData = data.filter(d => d.eff_bod || d.eff_tss || d.eff_nh3);
        const labels = effData.map(d => new Date(d.date).toLocaleDateString('en-US', {month:'short', day:'numeric'}));
        
        trendCharts.effluent = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'BOD', data: effData.map(d => d.eff_bod || null), borderColor: '#f59e0b', fill: false, tension: 0.3, spanGaps: true },
                    { label: 'TSS', data: effData.map(d => d.eff_tss || null), borderColor: '#8b5cf6', fill: false, tension: 0.3, spanGaps: true },
                    { label: 'NHâ‚ƒ-N', data: effData.map(d => d.eff_nh3 || null), borderColor: '#10b981', fill: false, tension: 0.3, spanGaps: true }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { min: 0, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                    x: { grid: { display: false }, ticks: { color: '#94a3b8', maxRotation: 45 } }
                }
            }
        });
    }

    // Update history table
    function updateHistoryTable() {
        const tbody = document.getElementById('historyBody');
        if (!tbody) return;
        
        const data = [...trendData].sort((a,b) => new Date(b.date) - new Date(a.date));
        
        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#64748b;padding:20px;">No data logged yet</td></tr>';
            return;
        }

        tbody.innerHTML = data.map((d, i) => `
            <tr>
                <td>${new Date(d.date).toLocaleDateString()}</td>
                <td>${d.flow ? d.flow.toFixed(2) : 'â€”'}</td>
                <td>${d.mlss ? d.mlss.toFixed(0) : 'â€”'}</td>
                <td>${d.svi ? d.svi.toFixed(0) : 'â€”'}</td>
                <td>${d.fm ? d.fm.toFixed(3) : 'â€”'}</td>
                <td>${d.eff_bod ? d.eff_bod.toFixed(1) : 'â€”'}</td>
                <td>${d.eff_tss ? d.eff_tss.toFixed(1) : 'â€”'}</td>
                <td><button onclick="deleteTrendEntry(${i})" style="background:none;border:none;color:#ef4444;cursor:pointer;font-size:0.8rem;">âœ•</button></td>
            </tr>
        `).join('');
    }

    function deleteTrendEntry(idx) {
        const sorted = [...trendData].sort((a,b) => new Date(b.date) - new Date(a.date));
        const dateToRemove = sorted[idx].date;
        trendData = trendData.filter(d => d.date !== dateToRemove);
        saveTrendData();
        renderAllCharts();
        updateTrendStats();
        showToast('Entry deleted', 'success');
    }

    function clearTrendData() {
        if (confirm('Clear ALL trend data? This cannot be undone.')) {
            trendData = [];
            saveTrendData();
            renderAllCharts();
            updateTrendStats();
            updateHistoryTable();
            showToast('All trend data cleared', 'success');
        }
    }

    // Export trend data as CSV
    function exportTrendData() {
        if (trendData.length === 0) {
            showToast('No data to export', 'error');
            return;
        }

        const headers = ['Date','Flow_MGD','Inf_BOD','Eff_BOD','Eff_TSS','Eff_NH3','MLSS','Settle_mL','SVI','DO','F/M','Flux','TMP','Perm','Removal%'];
        const rows = trendData.map(d => [
            d.date, d.flow||'', d.inf_bod||'', d.eff_bod||'', d.eff_tss||'', d.eff_nh3||'',
            d.mlss||'', d.settle||'', d.svi ? d.svi.toFixed(1) : '', d.do_val||'',
            d.fm ? d.fm.toFixed(4) : '', d.flux||'', d.tmp||'', d.perm ? d.perm.toFixed(2) : '',
            d.removal ? d.removal.toFixed(1) : ''
        ].join(','));

        const csv = [headers.join(','), ...rows].join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'WWTP_TrendData_' + new Date().toISOString().split('T')[0] + '.csv';
        a.click();
        showToast('Data exported as CSV', 'success');
    }

    // Import CSV
    function importCSV() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.csv';
        input.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const lines = ev.target.result.split('\n');
                    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                    let imported = 0;
                    
                    for (let i = 1; i < lines.length; i++) {
                        const vals = lines[i].split(',');
                        if (vals.length < 2) continue;
                        
                        const entry = { date: vals[0], timestamp: new Date().toISOString() };
                        headers.forEach((h, idx) => {
                            if (idx === 0) return; // skip date
                            const val = parseFloat(vals[idx]);
                            if (!isNaN(val)) {
                                if (h.includes('flow')) entry.flow = val;
                                else if (h.includes('inf') && h.includes('bod')) entry.inf_bod = val;
                                else if (h.includes('eff') && h.includes('bod')) entry.eff_bod = val;
                                else if (h.includes('tss')) entry.eff_tss = val;
                                else if (h.includes('nh3') || h.includes('ammonia')) entry.eff_nh3 = val;
                                else if (h.includes('mlss')) entry.mlss = val;
                                else if (h.includes('settle')) entry.settle = val;
                                else if (h.includes('svi')) entry.svi = val;
                                else if (h === 'do' || h.includes('oxygen')) entry.do_val = val;
                                else if (h.includes('flux')) entry.flux = val;
                                else if (h.includes('tmp')) entry.tmp = val;
                            }
                        });
                        
                        // Calculate derived if possible
                        if (!entry.svi && entry.settle && entry.mlss) {
                            entry.svi = (entry.settle * 1000) / entry.mlss;
                        }
                        
                        // Check if exists
                        const existIdx = trendData.findIndex(d => d.date === entry.date);
                        if (existIdx >= 0) {
                            trendData[existIdx] = { ...trendData[existIdx], ...entry };
                        } else {
                            trendData.push(entry);
                        }
                        imported++;
                    }
                    
                    saveTrendData();
                    renderAllCharts();
                    updateTrendStats();
                    updateHistoryTable();
                    showToast(imported + ' rows imported', 'success');
                } catch(err) {
                    showToast('Import failed: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
        };
        input.click();
    }

    // ==================== PROCESS CONTROL WIZARDS ====================
    var currentWizard = null;
    var wizardStep = 0;
    var wizardAnswers = {};

    var wizardData = {
        svi: {
            name: 'High SVI / Bulking Sludge',
            icon: 'ðŸ¦ ',
            intro: 'Let\'s diagnose your settling problem. Answer a few questions to identify the cause and get corrective actions.',
            questions: [
                {
                    q: 'What is your current SVI?',
                    options: [
                        { text: '150-200 (Moderate bulking)', value: 'moderate' },
                        { text: '200-300 (Severe bulking)', value: 'severe' },
                        { text: '300+ (Critical)', value: 'critical' },
                        { text: 'Not sure / Haven\'t tested', value: 'unknown' }
                    ]
                },
                {
                    q: 'Is sludge rising in the clarifier (floating clumps with gas bubbles)?',
                    options: [
                        { text: 'Yes â€” chunks floating with bubbles attached', value: 'rising' },
                        { text: 'No â€” sludge is fluffy/billowy but not gassy', value: 'bulking' },
                        { text: 'Sludge blanket is just too high', value: 'blanket' }
                    ]
                },
                {
                    q: 'What does the foam/scum look like?',
                    options: [
                        { text: 'Thick brown/tan greasy foam (Nocardia-type)', value: 'nocardia' },
                        { text: 'White/gray billowy foam', value: 'white' },
                        { text: 'Dark foam with solids', value: 'dark' },
                        { text: 'No significant foam', value: 'none' }
                    ]
                },
                {
                    q: 'What is your current F:M ratio?',
                    options: [
                        { text: '< 0.05 (Very low)', value: 'verylow' },
                        { text: '0.05 - 0.15 (Low - extended aeration range)', value: 'low' },
                        { text: '0.15 - 0.5 (Normal CAS range)', value: 'normal' },
                        { text: '> 0.5 (High)', value: 'high' },
                        { text: 'Not sure', value: 'unknown' }
                    ]
                }
            ],
            getDiagnosis: function(answers) {
                var result = { title: '', level: 'warning', actions: [] };
                
                // Rising sludge = denitrification
                if (answers[1] === 'rising') {
                    result.title = 'ðŸŽ¯ Diagnosis: Denitrification in Clarifier (Rising Sludge)';
                    result.level = 'danger';
                    result.actions = [
                        { title: 'Increase RAS rate', desc: 'Get sludge out of clarifier faster to reduce detention time. Target < 1 hour in clarifier.', priority: 'high', calc: 12 },
                        { title: 'Increase WAS rate', desc: 'Lower SRT to reduce nitrification. Less nitrification = less nitrate to denitrify.', priority: 'high', calc: 11 },
                        { title: 'Reduce aeration', desc: 'If fully nitrifying but don\'t need to, reduce DO to limit nitrification.', priority: 'med' },
                        { title: 'Check clarifier sludge blanket', desc: 'Keep blanket below 2 feet. Deep blankets = more time for denitrification.', priority: 'med' }
                    ];
                    result.examTip = 'Rising sludge with gas bubbles = denitrification releasing Nâ‚‚ gas. Fix by reducing SRT or getting sludge out faster.';
                }
                // Nocardia foam = low F:M filaments
                else if (answers[2] === 'nocardia') {
                    result.title = 'ðŸŽ¯ Diagnosis: Nocardia/Microthrix (Low F:M Filaments)';
                    result.level = 'warning';
                    result.actions = [
                        { title: 'Increase F:M ratio', desc: 'Waste more sludge to increase F:M above 0.1. Target 0.15-0.25 for CAS.', priority: 'high', calc: 4 },
                        { title: 'Reduce SRT', desc: 'Shorten sludge age to 5-10 days. Long SRT favors slow-growing filaments.', priority: 'high', calc: 10 },
                        { title: 'RAS chlorination', desc: 'Dose 2-10 lb Clâ‚‚ per 1000 lb MLSS/day to kill filaments.', priority: 'med', calc: 69 },
                        { title: 'Skim and waste foam', desc: 'Remove accumulated Nocardia foam from system. Don\'t return to headworks.', priority: 'med' },
                        { title: 'Check for FOG', desc: 'Nocardia thrives on fats/oils/grease. Improve grease trap enforcement.', priority: 'low' }
                    ];
                    result.examTip = 'Nocardia = thick brown/tan greasy foam. Caused by low F:M, high SRT, and FOG. Chlorinate RAS 2-10 lb Clâ‚‚/1000 lb MLSS/day.';
                }
                // Low F:M bulking
                else if (answers[3] === 'verylow' || answers[3] === 'low') {
                    result.title = 'ðŸŽ¯ Diagnosis: Low F:M Filamentous Bulking';
                    result.level = 'warning';
                    result.actions = [
                        { title: 'Increase WAS rate', desc: 'Reduce MLSS to increase F:M. Target F:M > 0.1 minimum.', priority: 'high', calc: 11 },
                        { title: 'Calculate target MLSS', desc: 'Use loading calcs to find optimal MLSS for your flow/BOD.', priority: 'high', calc: 3 },
                        { title: 'RAS chlorination', desc: 'Dose 2-10 lb Clâ‚‚ per 1000 lb MLSS/day while adjusting F:M.', priority: 'med', calc: 69 },
                        { title: 'Add selector zone', desc: 'Long-term: initial high F:M contact zone selects against filaments.', priority: 'low' }
                    ];
                    result.examTip = 'Low F:M (< 0.05) causes Type 021N, 0041, 0675 filaments. Increase F:M by wasting more sludge.';
                }
                // High F:M / low DO bulking
                else if (answers[3] === 'high') {
                    result.title = 'ðŸŽ¯ Diagnosis: High F:M or Low DO Bulking';
                    result.level = 'warning';
                    result.actions = [
                        { title: 'Increase MLSS', desc: 'Reduce WAS to build up MLSS and lower F:M to normal range.', priority: 'high', calc: 11 },
                        { title: 'Verify DO levels', desc: 'Maintain DO > 2.0 mg/L throughout basin. Low DO favors filaments.', priority: 'high', calc: 17 },
                        { title: 'Check for septicity', desc: 'Septic influent (Hâ‚‚S, black color) promotes Thiothrix/Type 021N.', priority: 'med' },
                        { title: 'Add nutrients if needed', desc: 'Check BOD:N:P ratio is 100:5:1. Nutrient deficiency causes bulking.', priority: 'med', calc: 23 }
                    ];
                    result.examTip = 'Low DO (< 1.0 mg/L) causes Type 1701, S. natans. High F:M with low DO causes Thiothrix (sulfur filaments).';
                }
                // General bulking
                else {
                    result.title = 'ðŸŽ¯ Diagnosis: Filamentous Bulking - Further Testing Needed';
                    result.level = 'warning';
                    result.actions = [
                        { title: 'Perform microscopic exam', desc: 'Identify dominant filament type to determine specific cause.', priority: 'high' },
                        { title: 'Check F:M ratio', desc: 'Calculate current F:M. Most bulking is from F:M imbalance.', priority: 'high', calc: 4 },
                        { title: 'Verify DO profile', desc: 'Check DO at multiple points. Should be > 2.0 mg/L throughout.', priority: 'high' },
                        { title: 'Test for nutrients', desc: 'Check N and P. BOD:N:P should be 100:5:1.', priority: 'med' },
                        { title: 'Begin RAS chlorination', desc: 'Start at 2-3 lb Clâ‚‚/1000 lb MLSS/day while investigating.', priority: 'med', calc: 69 }
                    ];
                    result.examTip = 'SVI > 150 = bulking. Identify cause (low F:M, low DO, nutrients, septicity) before treatment.';
                }
                
                return result;
            }
        },
        
        effluent: {
            name: 'Effluent Quality Issues',
            icon: 'ðŸ’§',
            intro: 'Let\'s troubleshoot your effluent quality problem.',
            questions: [
                {
                    q: 'Which parameter is out of compliance?',
                    options: [
                        { text: 'TSS (high solids)', value: 'tss' },
                        { text: 'BOD/CBOD (high organics)', value: 'bod' },
                        { text: 'Ammonia (NHâ‚ƒ-N)', value: 'ammonia' },
                        { text: 'Multiple parameters', value: 'multiple' }
                    ]
                },
                {
                    q: 'Is the clarifier effluent cloudy or are there visible solids?',
                    options: [
                        { text: 'Yes â€” cloudy/turbid with fine particles', value: 'cloudy' },
                        { text: 'Yes â€” visible floc or clumps escaping', value: 'floc' },
                        { text: 'No â€” looks clear but lab results are high', value: 'clear' }
                    ]
                },
                {
                    q: 'What\'s happening with your sludge blanket?',
                    options: [
                        { text: 'Blanket is high (> 3 ft) or at weirs', value: 'high' },
                        { text: 'Blanket is normal but solids still escaping', value: 'normal' },
                        { text: 'Can\'t find/measure the blanket', value: 'unknown' }
                    ]
                }
            ],
            getDiagnosis: function(answers) {
                var result = { title: '', level: 'warning', actions: [] };
                
                if (answers[0] === 'ammonia') {
                    result.title = 'ðŸŽ¯ Diagnosis: Nitrification Failure';
                    result.level = 'danger';
                    result.actions = [
                        { title: 'Check DO levels', desc: 'Nitrifiers need DO > 2.0 mg/L. They\'re the first to suffer from low DO.', priority: 'high' },
                        { title: 'Verify SRT > 10 days', desc: 'Nitrifiers are slow-growing. SRT must exceed minimum for your temperature.', priority: 'high', calc: 10 },
                        { title: 'Check pH (7.0-8.5)', desc: 'Nitrification consumes alkalinity. If pH < 6.8, add alkalinity.', priority: 'high' },
                        { title: 'Check temperature', desc: 'Below 50Â°F, nitrification slows dramatically. May need longer SRT.', priority: 'med' },
                        { title: 'Look for toxicity', desc: 'Industrial discharge, slug loads, or chlorine in RAS can inhibit nitrifiers.', priority: 'med' }
                    ];
                    result.examTip = 'Nitrification needs: DO > 2, pH 7-8.5, SRT > 10 days (longer when cold), alkalinity > 50 mg/L as CaCOâ‚ƒ.';
                }
                else if (answers[0] === 'tss' && answers[1] === 'floc') {
                    result.title = 'ðŸŽ¯ Diagnosis: Floc Shear / Pin Floc';
                    result.level = 'warning';
                    result.actions = [
                        { title: 'Reduce RAS rate', desc: 'High RAS velocities shear floc. Try reducing RAS flow.', priority: 'high', calc: 12 },
                        { title: 'Check for hydraulic surges', desc: 'Flow spikes break up floc. Equalize if possible.', priority: 'med' },
                        { title: 'Verify polymer dose', desc: 'If using polymer, may need to adjust dose or mixing.', priority: 'med' },
                        { title: 'Check MLSS level', desc: 'Very low MLSS produces weak, small floc.', priority: 'med', calc: 3 }
                    ];
                    result.examTip = 'Pin floc = small weak floc that doesn\'t settle. Often caused by low MLSS, young sludge, or hydraulic shear.';
                }
                else if (answers[2] === 'high') {
                    result.title = 'ðŸŽ¯ Diagnosis: Clarifier Overloaded';
                    result.level = 'danger';
                    result.actions = [
                        { title: 'Increase WAS immediately', desc: 'Reduce inventory to lower blanket. Emergency wasting may be needed.', priority: 'high', calc: 11 },
                        { title: 'Increase RAS rate', desc: 'Move sludge out of clarifier faster.', priority: 'high', calc: 12 },
                        { title: 'Check for bulking (SVI)', desc: 'High SVI makes blanket rise even at normal MLSS.', priority: 'high', calc: 9 },
                        { title: 'Verify clarifier operation', desc: 'Check scraper, skimmer, weir levelness, baffles.', priority: 'med' }
                    ];
                    result.examTip = 'High blanket = too much sludge inventory. Increase WAS to reduce MLSS and blanket depth.';
                }
                else {
                    result.title = 'ðŸŽ¯ Diagnosis: General Effluent Quality - Check Process';
                    result.level = 'warning';
                    result.actions = [
                        { title: 'Review recent changes', desc: 'What changed? Flow? Loading? Chemical doses? Temperature?', priority: 'high' },
                        { title: 'Check MLSS and SRT', desc: 'Verify you have adequate biomass for the loading.', priority: 'high', calc: 10 },
                        { title: 'Monitor DO profile', desc: 'Ensure adequate oxygen throughout aeration basin.', priority: 'med' },
                        { title: 'Perform settleability test', desc: 'Check SVI to rule out settling issues.', priority: 'med', calc: 9 }
                    ];
                    result.examTip = 'Troubleshooting order: Check MLSS â†’ SRT â†’ DO â†’ F:M â†’ Settling â†’ Clarifier operation.';
                }
                
                return result;
            }
        },
        
        do: {
            name: 'DO Problems',
            icon: 'ðŸ’¨',
            intro: 'Let\'s diagnose your dissolved oxygen issue.',
            questions: [
                {
                    q: 'What\'s the main problem?',
                    options: [
                        { text: 'Can\'t get DO above 1-2 mg/L', value: 'low' },
                        { text: 'DO is too high (> 4 mg/L) wasting energy', value: 'high' },
                        { text: 'DO fluctuates wildly', value: 'unstable' },
                        { text: 'DO drops suddenly / crashes', value: 'crash' }
                    ]
                },
                {
                    q: 'Are all blowers/aerators running at capacity?',
                    options: [
                        { text: 'Yes â€” everything maxed out', value: 'maxed' },
                        { text: 'No â€” have capacity remaining', value: 'capacity' },
                        { text: 'Equipment down/under repair', value: 'down' }
                    ]
                },
                {
                    q: 'Has influent loading changed recently?',
                    options: [
                        { text: 'Yes â€” higher flows or stronger waste', value: 'increased' },
                        { text: 'Yes â€” lower than normal', value: 'decreased' },
                        { text: 'No â€” loading is normal', value: 'normal' },
                        { text: 'Not sure', value: 'unknown' }
                    ]
                }
            ],
            getDiagnosis: function(answers) {
                var result = { title: '', level: 'warning', actions: [] };
                
                if (answers[0] === 'low' && answers[1] === 'maxed') {
                    result.title = 'ðŸŽ¯ Diagnosis: Oxygen Demand Exceeds Capacity';
                    result.level = 'danger';
                    result.actions = [
                        { title: 'Reduce MLSS', desc: 'Lower biomass = lower oxygen demand. Increase WAS.', priority: 'high', calc: 11 },
                        { title: 'Check for shock load', desc: 'Industrial discharge or septic hauler dump can spike demand.', priority: 'high' },
                        { title: 'Verify diffuser condition', desc: 'Clogged/fouled diffusers reduce transfer efficiency.', priority: 'med' },
                        { title: 'Calculate Oâ‚‚ demand', desc: 'Verify your system capacity vs. actual demand.', priority: 'med', calc: 17 },
                        { title: 'Consider temporary measures', desc: 'Reduce inflow if possible, add supplemental aeration.', priority: 'med' }
                    ];
                    result.examTip = 'Oâ‚‚ demand = BOD removal + nitrification. If you can\'t meet demand, reduce MLSS or divert flow.';
                }
                else if (answers[0] === 'crash') {
                    result.title = 'ðŸŽ¯ Diagnosis: Sudden DO Crash - Check for Shock Load';
                    result.level = 'danger';
                    result.actions = [
                        { title: 'Check influent immediately', desc: 'Look for color, odor, pH changes. Could be toxic discharge.', priority: 'high' },
                        { title: 'Sample for BOD/COD', desc: 'Slug load will show very high organic loading.', priority: 'high' },
                        { title: 'Maximize aeration', desc: 'Run all available blowers until load passes.', priority: 'high' },
                        { title: 'Consider flow diversion', desc: 'If you have EQ or holding, divert to protect biology.', priority: 'med' }
                    ];
                    result.examTip = 'Sudden DO crash usually = shock load. Check pH (acid/base dump), conductivity (brine), and color (industrial).';
                }
                else if (answers[0] === 'high') {
                    result.title = 'ðŸŽ¯ Diagnosis: Excess Aeration - Energy Waste';
                    result.level = 'warning';
                    result.actions = [
                        { title: 'Reduce blower output', desc: 'Target DO of 2.0 mg/L. Above 3.0 mg/L wastes energy.', priority: 'high' },
                        { title: 'Check DO probes', desc: 'Faulty probe may read low, causing over-aeration.', priority: 'med' },
                        { title: 'Verify loading', desc: 'Low loading = less Oâ‚‚ needed. Reduce aeration to match.', priority: 'med' },
                        { title: 'Use VFDs if available', desc: 'Variable frequency drives can match output to demand.', priority: 'low' }
                    ];
                    result.examTip = 'Optimal DO is 2.0 mg/L. Higher wastes energy and can cause pin floc from over-mixing.';
                }
                else {
                    result.title = 'ðŸŽ¯ Diagnosis: DO Control Issue - Check Equipment';
                    result.level = 'warning';
                    result.actions = [
                        { title: 'Calibrate DO probes', desc: 'Dirty or drifting probes cause control issues.', priority: 'high' },
                        { title: 'Check blower operation', desc: 'Cycling or capacity issues cause DO swings.', priority: 'med' },
                        { title: 'Review control settings', desc: 'PID tuning may need adjustment for stable control.', priority: 'med' },
                        { title: 'Monitor diurnal loading', desc: 'Normal daily load swings may exceed control response.', priority: 'low' }
                    ];
                    result.examTip = 'Unstable DO often = instrumentation issue. Clean and calibrate probes regularly.';
                }
                
                return result;
            }
        },
        
        foam: {
            name: 'Foam & Scum Problems',
            icon: 'ðŸ«§',
            intro: 'Let\'s identify your foam type and solution.',
            questions: [
                {
                    q: 'What does the foam look like?',
                    options: [
                        { text: 'Thick, brown/tan, greasy/sticky', value: 'nocardia' },
                        { text: 'White/gray, billowy, light', value: 'white' },
                        { text: 'Dark brown with lots of solids', value: 'dark' },
                        { text: 'Thin, crispy, or breaking up', value: 'thin' }
                    ]
                },
                {
                    q: 'When did the foam appear?',
                    options: [
                        { text: 'Gradually increased over weeks/months', value: 'gradual' },
                        { text: 'Appeared suddenly (days)', value: 'sudden' },
                        { text: 'Plant startup or after upset', value: 'startup' },
                        { text: 'Seasonal (warmer weather)', value: 'seasonal' }
                    ]
                },
                {
                    q: 'What is your current SRT (sludge age)?',
                    options: [
                        { text: '< 5 days (young sludge)', value: 'young' },
                        { text: '5-15 days (normal)', value: 'normal' },
                        { text: '> 15 days (old sludge)', value: 'old' },
                        { text: 'Not sure', value: 'unknown' }
                    ]
                }
            ],
            getDiagnosis: function(answers) {
                var result = { title: '', level: 'warning', actions: [] };
                
                if (answers[0] === 'nocardia') {
                    result.title = 'ðŸŽ¯ Diagnosis: Nocardia/Microthrix Foam';
                    result.level = 'warning';
                    result.actions = [
                        { title: 'Reduce SRT', desc: 'Target SRT of 5-10 days. Nocardia thrives at long SRT.', priority: 'high', calc: 10 },
                        { title: 'Increase F:M', desc: 'Waste more sludge to increase F:M above 0.1.', priority: 'high', calc: 4 },
                        { title: 'Skim and remove foam', desc: 'Don\'t return foam to headworks â€” remove from system entirely.', priority: 'high' },
                        { title: 'Chlorinate RAS', desc: '5-10 lb Clâ‚‚ per 1000 lb MLSS/day for Nocardia.', priority: 'med', calc: 69 },
                        { title: 'Control FOG', desc: 'Nocardia feeds on fats/oils/grease. Enforce grease traps.', priority: 'med' }
                    ];
                    result.examTip = 'Nocardia = thick brown greasy foam, branching filaments, common at high SRT and low F:M. Takes weeks to control.';
                }
                else if (answers[0] === 'white' && answers[1] === 'startup') {
                    result.title = 'ðŸŽ¯ Diagnosis: Startup/Young Sludge Foam';
                    result.level = 'warning';
                    result.actions = [
                        { title: 'Wait for sludge to mature', desc: 'Young sludge (< 5 day SRT) produces surfactants. Will resolve.', priority: 'med' },
                        { title: 'Reduce WAS temporarily', desc: 'Build up MLSS and SRT to mature the sludge.', priority: 'med', calc: 11 },
                        { title: 'Spray water on foam', desc: 'Temporary control â€” breaks up foam but doesn\'t fix cause.', priority: 'low' },
                        { title: 'Check for detergent load', desc: 'Industrial laundry or car wash discharge can cause foaming.', priority: 'low' }
                    ];
                    result.examTip = 'White billowy foam at startup = young sludge. Will resolve as SRT increases past 5-7 days.';
                }
                else if (answers[0] === 'dark') {
                    result.title = 'ðŸŽ¯ Diagnosis: Old Sludge / Septic Foam';
                    result.level = 'warning';
                    result.actions = [
                        { title: 'Increase WAS', desc: 'Dark foam with solids often indicates old/septic sludge.', priority: 'high', calc: 11 },
                        { title: 'Check clarifier blanket', desc: 'Deep blanket can go septic and cause dark foam.', priority: 'high' },
                        { title: 'Verify DO levels', desc: 'Low DO causes dark/septic sludge conditions.', priority: 'med' },
                        { title: 'Check RAS line', desc: 'Long RAS lines can go septic if sludge sits too long.', priority: 'med' }
                    ];
                    result.examTip = 'Dark foam with solids = old sludge or septicity. Increase wasting and check for dead zones.';
                }
                else {
                    result.title = 'ðŸŽ¯ Diagnosis: General Foaming - Investigate Source';
                    result.level = 'warning';
                    result.actions = [
                        { title: 'Check influent for surfactants', desc: 'Industrial discharge of detergents causes foaming.', priority: 'med' },
                        { title: 'Review SRT and F:M', desc: 'Both extremes (too high or too low) can cause foaming.', priority: 'med', calc: 10 },
                        { title: 'Perform microscopic exam', desc: 'Identify if filaments are present and what type.', priority: 'med' },
                        { title: 'Spray foam as temporary measure', desc: 'Water spray or anti-foam chemicals for temporary relief.', priority: 'low' }
                    ];
                    result.examTip = 'Foam diagnosis: White = young sludge or surfactants. Brown/tan = Nocardia. Dark = old/septic sludge.';
                }
                
                return result;
            }
        },
        
        clarifier: {
            name: 'Clarifier Issues',
            icon: 'ðŸŒ€',
            intro: 'Let\'s troubleshoot your clarifier problem.',
            questions: [
                {
                    q: 'What is the main issue?',
                    options: [
                        { text: 'Solids washing over weirs', value: 'washout' },
                        { text: 'Sludge blanket too high', value: 'blanket' },
                        { text: 'Rising/floating sludge clumps', value: 'rising' },
                        { text: 'Uneven flow or short-circuiting', value: 'hydraulic' }
                    ]
                },
                {
                    q: 'What is the current SVI?',
                    options: [
                        { text: '< 100 (good settling)', value: 'good' },
                        { text: '100-150 (fair)', value: 'fair' },
                        { text: '> 150 (poor - bulking)', value: 'poor' },
                        { text: 'Unknown', value: 'unknown' }
                    ]
                }
            ],
            getDiagnosis: function(answers) {
                var result = { title: '', level: 'warning', actions: [] };
                
                if (answers[0] === 'rising') {
                    result.title = 'ðŸŽ¯ Diagnosis: Rising Sludge (Denitrification)';
                    result.level = 'danger';
                    result.actions = [
                        { title: 'Increase RAS flow', desc: 'Get sludge out of clarifier faster â€” target < 1 hr detention.', priority: 'high', calc: 12 },
                        { title: 'Increase WAS', desc: 'Reduce SRT to limit nitrification if full denit not needed.', priority: 'high', calc: 11 },
                        { title: 'Lower sludge blanket', desc: 'Deep blankets have more time to denitrify. Keep < 2 ft.', priority: 'med' },
                        { title: 'Consider reducing DO', desc: 'Less complete nitrification = less nitrate available.', priority: 'low' }
                    ];
                    result.examTip = 'Rising sludge = Nâ‚‚ gas from denitrification. Sludge sitting too long in clarifier. Speed up RAS.';
                }
                else if (answers[0] === 'blanket' || (answers[0] === 'washout' && answers[1] === 'poor')) {
                    result.title = 'ðŸŽ¯ Diagnosis: Blanket Management / Bulking';
                    result.level = 'warning';
                    result.actions = [
                        { title: 'Increase WAS', desc: 'Reduce system MLSS to lower blanket depth.', priority: 'high', calc: 11 },
                        { title: 'Address bulking if SVI > 150', desc: 'Check F:M, DO, nutrients. Consider RAS chlorination.', priority: 'high', calc: 9 },
                        { title: 'Increase RAS if blanket compressible', desc: 'If sludge settles well, RAS may just be too low.', priority: 'med', calc: 12 },
                        { title: 'Check clarifier equipment', desc: 'Scraper, drive, density current baffles all affect performance.', priority: 'med' }
                    ];
                    result.examTip = 'High blanket = too much MLSS, poor settling, or inadequate RAS. Check SVI first.';
                }
                else if (answers[0] === 'hydraulic') {
                    result.title = 'ðŸŽ¯ Diagnosis: Hydraulic Issues';
                    result.level = 'warning';
                    result.actions = [
                        { title: 'Check weir levelness', desc: 'Uneven weirs cause short-circuiting. Should be level Â± 1/8".', priority: 'high' },
                        { title: 'Verify inlet baffle', desc: 'Damaged or missing baffles cause density currents.', priority: 'med' },
                        { title: 'Check for wind effects', desc: 'Wind can push surface flow to one side. Consider baffling.', priority: 'low' },
                        { title: 'Verify design SOR', desc: 'May be overloaded during peak flows.', priority: 'med', calc: 7 }
                    ];
                    result.examTip = 'Short-circuiting reduces effective detention time. Check weir level and inlet energy dissipation.';
                }
                else {
                    result.title = 'ðŸŽ¯ Diagnosis: General Clarifier Issue';
                    result.level = 'warning';
                    result.actions = [
                        { title: 'Measure blanket depth', desc: 'Should be 1-3 feet typically. Track daily.', priority: 'high' },
                        { title: 'Check SVI', desc: 'SVI > 150 indicates settling problem.', priority: 'high', calc: 9 },
                        { title: 'Verify RAS/WAS rates', desc: 'Balance is critical for clarifier performance.', priority: 'med', calc: 12 },
                        { title: 'Inspect equipment', desc: 'Scraper, skimmer, baffles, weirs â€” all affect performance.', priority: 'med' }
                    ];
                    result.examTip = 'Clarifier troubleshooting: Blanket depth â†’ SVI â†’ RAS rate â†’ Equipment â†’ Hydraulics.';
                }
                
                return result;
            }
        },
        
        nutrients: {
            name: 'Nutrient Removal Issues',
            icon: 'ðŸ§ª',
            intro: 'Let\'s troubleshoot your nutrient removal problem.',
            questions: [
                {
                    q: 'Which nutrient is the problem?',
                    options: [
                        { text: 'Ammonia (NHâ‚ƒ-N) â€” nitrification failure', value: 'ammonia' },
                        { text: 'Total Nitrogen â€” need more denitrification', value: 'tn' },
                        { text: 'Phosphorus', value: 'phos' },
                        { text: 'Both N and P', value: 'both' }
                    ]
                },
                {
                    q: 'What is your current DO in aeration?',
                    options: [
                        { text: '< 1.0 mg/L', value: 'verylow' },
                        { text: '1.0 - 2.0 mg/L', value: 'low' },
                        { text: '2.0 - 3.0 mg/L', value: 'normal' },
                        { text: '> 3.0 mg/L', value: 'high' }
                    ]
                }
            ],
            getDiagnosis: function(answers) {
                var result = { title: '', level: 'warning', actions: [] };
                
                if (answers[0] === 'ammonia') {
                    result.title = 'ðŸŽ¯ Diagnosis: Nitrification Failure';
                    result.level = 'danger';
                    result.actions = [
                        { title: 'Increase DO to > 2.0 mg/L', desc: 'Nitrifiers need oxygen. They fail first when DO drops.', priority: 'high' },
                        { title: 'Verify SRT > 10 days', desc: 'Nitrifiers are slow-growing. Need adequate sludge age.', priority: 'high', calc: 10 },
                        { title: 'Check pH and alkalinity', desc: 'Nitrification needs pH 7-8.5, alk > 50 mg/L as CaCOâ‚ƒ.', priority: 'high' },
                        { title: 'Check temperature', desc: 'Below 50Â°F, nitrification rate drops significantly.', priority: 'med' },
                        { title: 'Test for inhibition', desc: 'Toxics, high ammonia, or low pH can inhibit nitrifiers.', priority: 'med' }
                    ];
                    result.examTip = 'Nitrification requirements: DO > 2, pH 7-8.5, SRT > 10d (min), Alk > 50 mg/L, Temp > 50Â°F.';
                }
                else if (answers[0] === 'tn') {
                    result.title = 'ðŸŽ¯ Diagnosis: Insufficient Denitrification';
                    result.level = 'warning';
                    result.actions = [
                        { title: 'Create/enlarge anoxic zone', desc: 'Need anoxic (no Oâ‚‚) zone with nitrate and carbon.', priority: 'high' },
                        { title: 'Verify carbon source', desc: 'Denitrifiers need BOD. May need to add methanol/glycerin.', priority: 'high' },
                        { title: 'Check internal recycle', desc: 'Need to return nitrate-rich flow to anoxic zone.', priority: 'med' },
                        { title: 'Reduce DO in anoxic zone', desc: 'DO > 0.5 mg/L inhibits denitrification. Check for DO carryover.', priority: 'med' }
                    ];
                    result.examTip = 'Denitrification needs: Anoxic zone (DO < 0.5), carbon source, nitrate. Returns N to atmosphere as Nâ‚‚ gas.';
                }
                else if (answers[0] === 'phos') {
                    result.title = 'ðŸŽ¯ Diagnosis: Phosphorus Removal Issue';
                    result.level = 'warning';
                    result.actions = [
                        { title: 'Check chemical dose', desc: 'Alum or ferric may need adjustment. Target 2:1 to 3:1 Me:P ratio.', priority: 'high', calc: 14 },
                        { title: 'Verify anaerobic zone for Bio-P', desc: 'True anaerobic (no Oâ‚‚ or NOâ‚ƒ) needed for PAO bacteria.', priority: 'med' },
                        { title: 'Check for nitrate in anaerobic zone', desc: 'Nitrate interferes with P release. Keep < 1 mg/L.', priority: 'med' },
                        { title: 'Monitor VFAs', desc: 'Bio-P needs volatile fatty acids in anaerobic zone.', priority: 'low' }
                    ];
                    result.examTip = 'Chemical P removal: Alum/ferric at 2-3 molar ratio. Bio-P needs true anaerobic zone with VFAs.';
                }
                else {
                    result.title = 'ðŸŽ¯ Diagnosis: Multiple Nutrient Issues';
                    result.level = 'warning';
                    result.actions = [
                        { title: 'Fix nitrification first', desc: 'Can\'t denitrify without nitrate. Get ammonia down first.', priority: 'high' },
                        { title: 'Review zone configuration', desc: 'Need anaerobic â†’ anoxic â†’ aerobic sequence for BNR.', priority: 'high' },
                        { title: 'Check recycle ratios', desc: 'Internal recycle and RAS affect all nutrient removal.', priority: 'med' },
                        { title: 'Consider chemical backup', desc: 'Chemical P removal can supplement biological process.', priority: 'med', calc: 14 }
                    ];
                    result.examTip = 'BNR sequence: Anaerobic (P release) â†’ Anoxic (denitrification) â†’ Aerobic (nitrification + P uptake).';
                }
                
                return result;
            }
        },
        
        // ========== NEW WIZARDS v9.11 ==========
        
        ammonia: {
            name: 'Ammonia Breakthrough',
            icon: 'âš—ï¸',
            intro: 'High ammonia in effluent? Let\'s find out why nitrification failed.',
            questions: [
                {
                    q: 'How quickly did the ammonia spike occur?',
                    options: [
                        { text: 'Sudden (within hours/1 day)', value: 'sudden' },
                        { text: 'Gradual (over several days)', value: 'gradual' },
                        { text: 'Seasonal pattern (winter)', value: 'seasonal' },
                        { text: 'After a process change', value: 'change' }
                    ]
                },
                {
                    q: 'What is your current SRT?',
                    options: [
                        { text: '< 5 days', value: 'verylow' },
                        { text: '5-8 days', value: 'low' },
                        { text: '8-15 days', value: 'adequate' },
                        { text: '> 15 days', value: 'high' },
                        { text: 'Unknown', value: 'unknown' }
                    ]
                },
                {
                    q: 'What is the DO in your aeration basin?',
                    options: [
                        { text: '< 1.0 mg/L', value: 'verylow' },
                        { text: '1.0-2.0 mg/L', value: 'low' },
                        { text: '> 2.0 mg/L', value: 'adequate' }
                    ]
                },
                {
                    q: 'What is the pH in aeration?',
                    options: [
                        { text: '< 6.5 (low)', value: 'low' },
                        { text: '6.5-7.5 (normal)', value: 'normal' },
                        { text: '7.5-8.5 (good for nitrification)', value: 'good' },
                        { text: '> 8.5 (high)', value: 'high' }
                    ]
                }
            ],
            getDiagnosis: function(answers) {
                var result = { title: '', level: 'danger', actions: [] };
                
                if (answers[0] === 'sudden') {
                    result.title = 'ðŸŽ¯ Diagnosis: Toxic Shock or Nitrifier Washout';
                    result.actions = [
                        { title: 'Check for industrial discharge', desc: 'Heavy metals, high ammonia slug, or toxic chemicals can kill nitrifiers instantly.', priority: 'high' },
                        { title: 'Review WAS rates', desc: 'Excessive wasting can wash out slow-growing nitrifiers. Stop WAS temporarily.', priority: 'high', calc: 11 },
                        { title: 'Check alkalinity', desc: 'Nitrification consumes 7.1 lb alk per lb NH3-N. May have crashed pH.', priority: 'high' },
                        { title: 'Add seed sludge if available', desc: 'Borrow nitrifying sludge from nearby plant to speed recovery.', priority: 'med' }
                    ];
                    result.examTip = 'Sudden ammonia spike = toxic shock or nitrifier washout. Stop WAS, find the source, may need 2-3 weeks to recover.';
                }
                else if (answers[1] === 'verylow' || answers[1] === 'low') {
                    result.title = 'ðŸŽ¯ Diagnosis: Insufficient SRT for Nitrification';
                    result.actions = [
                        { title: 'Reduce WAS immediately', desc: 'Need SRT > 8 days minimum (10-15 better). Stop wasting until SRT increases.', priority: 'high', calc: 11 },
                        { title: 'Calculate required SRT', desc: 'Cold water needs even longer SRT. At 50Â°F, may need 15+ days.', priority: 'high', calc: 10 },
                        { title: 'Monitor MLSS trend', desc: 'MLSS should increase as you reduce WAS. Target higher MLSS.', priority: 'med' }
                    ];
                    result.examTip = 'Nitrifiers double every 1-2 days vs. 4-8 hrs for heterotrophs. SRT < 8 days = nitrifier washout.';
                }
                else if (answers[2] === 'verylow' || answers[2] === 'low') {
                    result.title = 'ðŸŽ¯ Diagnosis: Low DO Limiting Nitrification';
                    result.actions = [
                        { title: 'Increase aeration', desc: 'Nitrifiers need DO > 2.0 mg/L. They fail before heterotrophs.', priority: 'high' },
                        { title: 'Check blower capacity', desc: 'May be at max output. Consider additional blower or repairs.', priority: 'high', calc: 68 },
                        { title: 'Check diffuser condition', desc: 'Fouled diffusers reduce transfer efficiency. May need cleaning.', priority: 'med' },
                        { title: 'Reduce organic load if possible', desc: 'High BOD consumes oxygen. Primary treatment helps.', priority: 'low' }
                    ];
                    result.examTip = 'Nitrification is oxygen-intensive: 4.6 lb Oâ‚‚ per lb NHâ‚ƒ-N oxidized. Low DO = nitrification stops first.';
                }
                else if (answers[3] === 'low') {
                    result.title = 'ðŸŽ¯ Diagnosis: Low pH Inhibiting Nitrification';
                    result.actions = [
                        { title: 'Add alkalinity', desc: 'Add lime, soda ash, or caustic to raise pH and alkalinity.', priority: 'high' },
                        { title: 'Check influent alkalinity', desc: 'Need ~7.1 lb alk destroyed per lb NHâ‚ƒ-N nitrified.', priority: 'high' },
                        { title: 'Target pH 7.5-8.0', desc: 'Optimal nitrification pH range. Below 6.5, rate drops 90%.', priority: 'med' }
                    ];
                    result.examTip = 'Nitrification destroys alkalinity: 7.1 lb as CaCOâ‚ƒ per lb NHâ‚ƒ-N. Must supplement if alk < 50 mg/L.';
                }
                else {
                    result.title = 'ðŸŽ¯ Diagnosis: Nitrification Issue - Multiple Factors';
                    result.actions = [
                        { title: 'Verify all requirements', desc: 'DO > 2, SRT > 10d, pH 7-8.5, Alk > 50, Temp > 55Â°F', priority: 'high' },
                        { title: 'Check for inhibitors', desc: 'High ammonia (>100), metals, chlorine can inhibit.', priority: 'med' },
                        { title: 'Consider temperature', desc: 'Nitrification rate halves for every 10Â°C drop.', priority: 'med' }
                    ];
                    result.examTip = 'The 5 requirements for nitrification: Oxygen, Time (SRT), pH/Alkalinity, Temperature, No toxics.';
                }
                
                return result;
            }
        },
        
        odor: {
            name: 'Odor / Hâ‚‚S Control',
            icon: 'ðŸ‘ƒ',
            intro: 'Rotten egg smell or odor complaints? Let\'s identify the source and solution.',
            questions: [
                {
                    q: 'Where is the odor strongest?',
                    options: [
                        { text: 'Headworks / influent', value: 'headworks' },
                        { text: 'Primary clarifiers', value: 'primary' },
                        { text: 'Collection system / lift stations', value: 'collection' },
                        { text: 'Sludge handling / digesters', value: 'sludge' },
                        { text: 'Aeration basins', value: 'aeration' }
                    ]
                },
                {
                    q: 'What does the odor smell like?',
                    options: [
                        { text: 'Rotten eggs (Hâ‚‚S)', value: 'h2s' },
                        { text: 'Septic / sewage', value: 'septic' },
                        { text: 'Musty / earthy', value: 'musty' },
                        { text: 'Ammonia / fishy', value: 'ammonia' }
                    ]
                },
                {
                    q: 'Is the wastewater black or gray?',
                    options: [
                        { text: 'Yes - black/dark gray', value: 'black' },
                        { text: 'No - normal brown/tan', value: 'normal' }
                    ]
                }
            ],
            getDiagnosis: function(answers) {
                var result = { title: '', level: 'warning', actions: [] };
                
                if (answers[0] === 'collection' || (answers[1] === 'h2s' && answers[2] === 'black')) {
                    result.title = 'ðŸŽ¯ Diagnosis: Septic Collection System / Hâ‚‚S Generation';
                    result.level = 'danger';
                    result.actions = [
                        { title: 'Check force main detention time', desc: 'If > 4 hours, wastewater goes septic. Consider chemical addition.', priority: 'high', calc: 74 },
                        { title: 'Add chemical treatment', desc: 'Calcium nitrate, iron salts, or bioxide can prevent/treat Hâ‚‚S.', priority: 'high' },
                        { title: 'Increase lift station cycling', desc: 'More frequent pumping = less detention = less septicity.', priority: 'med', calc: 73 },
                        { title: 'Ventilate manholes', desc: 'Passive or active ventilation reduces Hâ‚‚S buildup and crown corrosion.', priority: 'med' },
                        { title: 'Monitor Hâ‚‚S levels', desc: 'OSHA limit is 10 ppm. > 100 ppm is immediately dangerous.', priority: 'high' }
                    ];
                    result.examTip = 'Hâ‚‚S forms in septic conditions (no oxygen). It causes odor, crown corrosion, and is toxic. Force main > 4 hr detention = septicity risk.';
                }
                else if (answers[0] === 'headworks') {
                    result.title = 'ðŸŽ¯ Diagnosis: Headworks Odor';
                    result.actions = [
                        { title: 'Cover and ventilate', desc: 'Capture odorous air and treat with scrubber or biofilter.', priority: 'high' },
                        { title: 'Add chemical oxidant', desc: 'Chlorine, hydrogen peroxide, or permanganate at headworks.', priority: 'med' },
                        { title: 'Clean screens frequently', desc: 'Accumulated screenings generate odor. Remove promptly.', priority: 'med' },
                        { title: 'Flush grit chamber', desc: 'Settled organic matter in grit goes septic.', priority: 'low' }
                    ];
                    result.examTip = 'Headworks odor: Cover + ventilate + chemical treatment. Most cost-effective is capturing and treating air.';
                }
                else if (answers[0] === 'sludge') {
                    result.title = 'ðŸŽ¯ Diagnosis: Sludge Handling Odor';
                    result.actions = [
                        { title: 'Check digester health', desc: 'Upset digesters produce more odor. Check pH, VFA, gas production.', priority: 'high' },
                        { title: 'Minimize sludge storage', desc: 'Dewater and remove sludge promptly. Don\'t let it sit.', priority: 'med' },
                        { title: 'Add lime to cake', desc: 'Raises pH and reduces odor. Also aids pathogen reduction.', priority: 'med' },
                        { title: 'Cover storage', desc: 'Sludge drying beds and storage areas should be covered.', priority: 'low' }
                    ];
                    result.examTip = 'Sludge odor = anaerobic decomposition. Stabilize properly, minimize storage time, consider lime addition.';
                }
                else {
                    result.title = 'ðŸŽ¯ Diagnosis: General Odor Issue';
                    result.actions = [
                        { title: 'Identify point sources', desc: 'Walk plant to find strongest odor locations.', priority: 'high' },
                        { title: 'Check DO throughout plant', desc: 'Low DO anywhere = potential odor source.', priority: 'med' },
                        { title: 'Review housekeeping', desc: 'Clean spills, remove debris, wash down areas.', priority: 'med' },
                        { title: 'Consider odor treatment', desc: 'Biofilters, scrubbers, or masking agents.', priority: 'low' }
                    ];
                    result.examTip = 'Odor troubleshooting: Find source first, then choose treatment. Prevention (DO, turnover) better than treatment.';
                }
                
                return result;
            }
        },
        
        dewatering: {
            name: 'Dewatering Problems',
            icon: 'ðŸ—œï¸',
            intro: 'Poor cake solids or high polymer use? Let\'s optimize your dewatering.',
            questions: [
                {
                    q: 'What is your dewatering equipment?',
                    options: [
                        { text: 'Belt filter press', value: 'bfp' },
                        { text: 'Centrifuge', value: 'centrifuge' },
                        { text: 'Screw press', value: 'screw' },
                        { text: 'Drying beds', value: 'beds' }
                    ]
                },
                {
                    q: 'What is the main problem?',
                    options: [
                        { text: 'Low cake solids (too wet)', value: 'wet' },
                        { text: 'High polymer consumption', value: 'polymer' },
                        { text: 'Blinding / poor drainage', value: 'blinding' },
                        { text: 'Solids in filtrate/centrate', value: 'capture' }
                    ]
                },
                {
                    q: 'What is the feed sludge type?',
                    options: [
                        { text: 'Primary sludge', value: 'primary' },
                        { text: 'WAS (secondary)', value: 'was' },
                        { text: 'Digested sludge', value: 'digested' },
                        { text: 'Mixed (primary + WAS)', value: 'mixed' }
                    ]
                }
            ],
            getDiagnosis: function(answers) {
                var result = { title: '', level: 'warning', actions: [] };
                
                if (answers[1] === 'wet') {
                    result.title = 'ðŸŽ¯ Diagnosis: Low Cake Solids';
                    result.actions = [
                        { title: 'Optimize polymer dose', desc: 'Run jar tests. Too little OR too much polymer hurts dewatering.', priority: 'high' },
                        { title: 'Check feed solids', desc: 'Thicken feed to 3-6%. Higher feed = better cake. But not too high.', priority: 'high', calc: 84 },
                        { title: 'Adjust equipment settings', desc: 'BFP: belt tension, speed. Centrifuge: bowl speed, differential.', priority: 'med' },
                        { title: 'Check sludge conditioning', desc: 'Digested sludge often dewaters better than raw.', priority: 'low' }
                    ];
                    result.examTip = 'Target cake solids: BFP 18-25%, Centrifuge 20-28%. Every 1% increase = ~5% less hauling volume!';
                }
                else if (answers[1] === 'polymer') {
                    result.title = 'ðŸŽ¯ Diagnosis: High Polymer Consumption';
                    result.actions = [
                        { title: 'Run jar tests', desc: 'Find minimum effective dose. Often using 2-3Ã— more than needed.', priority: 'high' },
                        { title: 'Check polymer mixing', desc: 'Improper mixing/aging wastes polymer. Follow manufacturer specs.', priority: 'high' },
                        { title: 'Try different polymer', desc: 'Sludge characteristics change. May need different charge/MW.', priority: 'med' },
                        { title: 'Check feed consistency', desc: 'Variable feed = variable dose. Equalize if possible.', priority: 'med' }
                    ];
                    result.examTip = 'Polymer dose: BFP 4-10 lb/DT, Centrifuge 15-25 lb/DT. Always verify with jar test before changing.';
                }
                else if (answers[1] === 'blinding') {
                    result.title = 'ðŸŽ¯ Diagnosis: Belt/Media Blinding';
                    result.actions = [
                        { title: 'Clean belts thoroughly', desc: 'High-pressure wash. Check spray nozzles are clear.', priority: 'high' },
                        { title: 'Reduce polymer', desc: 'Excess polymer causes blinding. Cut dose and observe.', priority: 'high' },
                        { title: 'Check belt condition', desc: 'Worn or damaged belts blind easier. May need replacement.', priority: 'med' },
                        { title: 'Adjust feed rate', desc: 'Overloading causes blinding. Reduce GPM to belt.', priority: 'med' }
                    ];
                    result.examTip = 'Blinding = polymer or fines clogging belt pores. Clean frequently, optimize polymer, check belt condition.';
                }
                else if (answers[1] === 'capture') {
                    result.title = 'ðŸŽ¯ Diagnosis: Poor Solids Capture';
                    result.level = 'danger';
                    result.actions = [
                        { title: 'Increase polymer dose', desc: 'Poor capture usually = not enough polymer conditioning.', priority: 'high' },
                        { title: 'Check floc quality', desc: 'Should see large, clear-draining floc. Small floc = adjust polymer.', priority: 'high' },
                        { title: 'Reduce feed rate', desc: 'Overloading blows solids through. Slow down.', priority: 'med' },
                        { title: 'Check equipment condition', desc: 'Worn seals, screens, or scrolls reduce capture.', priority: 'med', calc: 85 }
                    ];
                    result.examTip = 'Target capture >95%. Poor capture = solids return to headworks, increasing plant load. Check centrate/filtrate TSS.';
                }
                else {
                    result.title = 'ðŸŽ¯ Diagnosis: General Dewatering Issue';
                    result.actions = [
                        { title: 'Review all parameters', desc: 'Feed %, polymer dose, equipment settings, capture.', priority: 'high' },
                        { title: 'Run jar tests', desc: 'Optimize polymer selection and dose.', priority: 'med' },
                        { title: 'Check equipment condition', desc: 'Preventive maintenance is key.', priority: 'med' }
                    ];
                    result.examTip = 'Dewatering optimization: feed concentration â†’ polymer dose â†’ equipment settings â†’ monitor capture and cake %.';
                }
                
                return result;
            }
        },
        
        digester: {
            name: 'Digester Upset',
            icon: 'ðŸ”¥',
            intro: 'Low gas? VFA spike? pH dropping? Let\'s diagnose your digester problem.',
            questions: [
                {
                    q: 'What type of digester?',
                    options: [
                        { text: 'Anaerobic (heated, covered)', value: 'anaerobic' },
                        { text: 'Aerobic', value: 'aerobic' },
                        { text: 'Facultative (open)', value: 'facultative' }
                    ]
                },
                {
                    q: 'What symptoms are you seeing?',
                    options: [
                        { text: 'Low gas production', value: 'lowgas' },
                        { text: 'Foaming', value: 'foam' },
                        { text: 'pH dropping / high VFA', value: 'acid' },
                        { text: 'Poor VS reduction', value: 'poorvs' },
                        { text: 'Bad odor (more than usual)', value: 'odor' }
                    ]
                },
                {
                    q: 'Any recent changes?',
                    options: [
                        { text: 'Increased loading', value: 'loading' },
                        { text: 'Temperature change', value: 'temp' },
                        { text: 'Industrial slug/spill', value: 'toxic' },
                        { text: 'No recent changes', value: 'none' }
                    ]
                }
            ],
            getDiagnosis: function(answers) {
                var result = { title: '', level: 'warning', actions: [] };
                
                if (answers[1] === 'acid' || (answers[1] === 'lowgas' && answers[2] === 'loading')) {
                    result.title = 'ðŸŽ¯ Diagnosis: Acid Phase Upset (VFA Buildup)';
                    result.level = 'danger';
                    result.actions = [
                        { title: 'STOP or reduce feeding', desc: 'Immediately reduce sludge input. Let methanogens catch up.', priority: 'high' },
                        { title: 'Check and adjust pH', desc: 'Add lime or soda ash if pH < 6.8. Target 7.0-7.5.', priority: 'high' },
                        { title: 'Monitor VFA and alkalinity', desc: 'VFA:Alk ratio should be < 0.3. Higher = upset.', priority: 'high' },
                        { title: 'Check temperature', desc: 'Mesophilic: 95-98Â°F. Variation > 2Â°F/day causes stress.', priority: 'med' },
                        { title: 'Reseed if necessary', desc: 'Severe upsets may need healthy sludge from another digester.', priority: 'low' }
                    ];
                    result.examTip = 'VFA:Alkalinity > 0.3-0.5 = upset. Acid formers outpace methanogens. STOP feeding, add alkalinity, stabilize temperature.';
                }
                else if (answers[1] === 'foam') {
                    result.title = 'ðŸŽ¯ Diagnosis: Digester Foaming';
                    result.actions = [
                        { title: 'Reduce loading rate', desc: 'Overloading causes foam. Cut feed by 25-50%.', priority: 'high' },
                        { title: 'Check for FOG', desc: 'Grease causes severe foaming. Improve FOG removal upstream.', priority: 'high' },
                        { title: 'Add antifoam', desc: 'Temporary solution. Silicone-based antifoam products work.', priority: 'med' },
                        { title: 'Improve mixing', desc: 'Stratification contributes to foaming. Check mixers.', priority: 'med' }
                    ];
                    result.examTip = 'Digester foam: Usually from overloading, FOG, or filaments. Reduce feed, spray foam with water, add antifoam.';
                }
                else if (answers[2] === 'temp') {
                    result.title = 'ðŸŽ¯ Diagnosis: Temperature Stress';
                    result.actions = [
                        { title: 'Stabilize temperature', desc: 'Keep within 2Â°F of setpoint. Avoid rapid changes.', priority: 'high' },
                        { title: 'Check heating system', desc: 'Heat exchangers, boiler, hot water circulation.', priority: 'high' },
                        { title: 'Verify thermometer calibration', desc: 'Bad readings cause bad control.', priority: 'med' },
                        { title: 'Insulate if needed', desc: 'Heat loss affects smaller digesters more.', priority: 'low' }
                    ];
                    result.examTip = 'Temperature: Mesophilic 95-98Â°F, Thermophilic 122-131Â°F. Changes > 2Â°F/day stress the system.';
                }
                else if (answers[2] === 'toxic') {
                    result.title = 'ðŸŽ¯ Diagnosis: Toxic Inhibition';
                    result.level = 'danger';
                    result.actions = [
                        { title: 'Identify and eliminate source', desc: 'Heavy metals, solvents, pesticides, antibiotics can inhibit.', priority: 'high' },
                        { title: 'Stop feeding', desc: 'Don\'t add more toxics. Let system recover.', priority: 'high' },
                        { title: 'Dilute if possible', desc: 'Reduce concentration of toxic by dilution.', priority: 'med' },
                        { title: 'Reseed with healthy sludge', desc: 'May need to restart with fresh seed.', priority: 'med' }
                    ];
                    result.examTip = 'Toxic inhibitors: Heavy metals, sulfide > 200 mg/L, ammonia > 1500 mg/L, solvents. Prevention is best.';
                }
                else {
                    result.title = 'ðŸŽ¯ Diagnosis: General Digester Issue';
                    result.actions = [
                        { title: 'Review operating parameters', desc: 'Loading, temperature, pH, mixing, detention time.', priority: 'high' },
                        { title: 'Monitor key indicators', desc: 'Gas production, VFA, alkalinity, VS reduction.', priority: 'med' },
                        { title: 'Check equipment', desc: 'Mixers, heat exchangers, gas handling system.', priority: 'med' }
                    ];
                    result.examTip = 'Healthy digester: pH 7-7.5, VFA:Alk < 0.3, gas 12-18 ftÂ³/lb VS, VS reduction 45-55%.';
                }
                
                return result;
            }
        },
        
        liftstation: {
            name: 'Lift Station Issues',
            icon: 'â¬†ï¸',
            intro: 'Pump problems, odor, or alarms? Let\'s troubleshoot your lift station.',
            questions: [
                {
                    q: 'What is the main issue?',
                    options: [
                        { text: 'Pump cycling too frequently', value: 'cycling' },
                        { text: 'Pump won\'t start or run', value: 'nostart' },
                        { text: 'Odor complaints', value: 'odor' },
                        { text: 'High wet well level / overflow risk', value: 'highlevel' },
                        { text: 'Ragging / clogging', value: 'ragging' }
                    ]
                },
                {
                    q: 'What type of pump?',
                    options: [
                        { text: 'Submersible', value: 'submersible' },
                        { text: 'Dry pit', value: 'drypit' },
                        { text: 'Suction lift', value: 'suction' },
                        { text: 'Grinder pump', value: 'grinder' }
                    ]
                },
                {
                    q: 'How many pumps in the station?',
                    options: [
                        { text: 'Simplex (1 pump)', value: 'simplex' },
                        { text: 'Duplex (2 pumps)', value: 'duplex' },
                        { text: '3 or more pumps', value: 'multiple' }
                    ]
                }
            ],
            getDiagnosis: function(answers) {
                var result = { title: '', level: 'warning', actions: [] };
                
                if (answers[0] === 'cycling') {
                    result.title = 'ðŸŽ¯ Diagnosis: Excessive Pump Cycling';
                    result.actions = [
                        { title: 'Check float/level settings', desc: 'ON and OFF levels may be too close together. Increase spread.', priority: 'high' },
                        { title: 'Verify wet well volume', desc: 'Small wet wells cycle more. May need modification.', priority: 'med', calc: 73 },
                        { title: 'Check for I/I', desc: 'High inflow = rapid fill = rapid cycling. Investigate sources.', priority: 'med' },
                        { title: 'Evaluate pump sizing', desc: 'Oversized pump empties too fast. Consider VFD or smaller pump.', priority: 'low' }
                    ];
                    result.examTip = 'Target 4-10 cycles/hour. Too frequent = motor overheating. Too infrequent = septicity. Wet well volume = (Q Ã— T) Ã· 4 for simplex.';
                }
                else if (answers[0] === 'nostart') {
                    result.title = 'ðŸŽ¯ Diagnosis: Pump Failure to Start';
                    result.level = 'danger';
                    result.actions = [
                        { title: 'Check power supply', desc: 'Verify voltage at motor. Check breakers, fuses, contacts.', priority: 'high' },
                        { title: 'Check floats/controls', desc: 'Float stuck? Level sensor failed? Wiring issues?', priority: 'high' },
                        { title: 'Check for mechanical jam', desc: 'Debris may have locked impeller. Manual rotation test.', priority: 'med' },
                        { title: 'Test thermal overloads', desc: 'Overload may have tripped. Reset after checking current draw.', priority: 'med' },
                        { title: 'Inspect motor/seals', desc: 'Submersibles can have water intrusion. Check insulation resistance.', priority: 'med' }
                    ];
                    result.examTip = 'Pump troubleshooting: Power â†’ Controls â†’ Mechanical â†’ Motor. Work from simple to complex.';
                }
                else if (answers[0] === 'odor') {
                    result.title = 'ðŸŽ¯ Diagnosis: Lift Station Odor';
                    result.actions = [
                        { title: 'Reduce detention time', desc: 'Pump more frequently to keep sewage fresh.', priority: 'high', calc: 73 },
                        { title: 'Add chemical treatment', desc: 'Calcium nitrate or iron salts in wet well.', priority: 'med' },
                        { title: 'Improve ventilation', desc: 'Passive vents or forced air to disperse odors.', priority: 'med' },
                        { title: 'Clean wet well', desc: 'Grease and debris buildup generates odor.', priority: 'med' }
                    ];
                    result.examTip = 'Lift station odor = septic conditions. Reduce detention time, add oxidant or nitrate, ventilate.';
                }
                else if (answers[0] === 'highlevel') {
                    result.title = 'ðŸŽ¯ Diagnosis: High Level / Capacity Issue';
                    result.level = 'danger';
                    result.actions = [
                        { title: 'Check pump operation', desc: 'Are both/all pumps running? Lead-lag working?', priority: 'high' },
                        { title: 'Check for blockage', desc: 'Force main blocked? Valve closed? Impeller clogged?', priority: 'high' },
                        { title: 'Evaluate I/I', desc: 'Wet weather overwhelming capacity? Address sources.', priority: 'med' },
                        { title: 'Review pump performance', desc: 'Worn impeller reduces output. Check actual vs. design GPM.', priority: 'med', calc: 75 }
                    ];
                    result.examTip = 'High level alarm: Verify pump operation first, then check for blockages. SSO prevention is critical.';
                }
                else if (answers[0] === 'ragging') {
                    result.title = 'ðŸŽ¯ Diagnosis: Ragging / Clogging';
                    result.actions = [
                        { title: 'Install or upgrade grinder', desc: 'Grinder pumps handle rags better. Or add upstream grinder.', priority: 'med' },
                        { title: 'Public outreach', desc: 'Educate users about wipes, rags, FOG. These are the cause.', priority: 'med' },
                        { title: 'Regular cleaning schedule', desc: 'Periodic pump pulls and wet well cleaning.', priority: 'med' },
                        { title: 'Consider chopper pump', desc: 'Or non-clog impeller design if frequent problem.', priority: 'low' }
                    ];
                    result.examTip = 'Ragging: "Flushable" wipes are NOT flushable. Main cause of pump clogs. Public education + grinders.';
                }
                else {
                    result.title = 'ðŸŽ¯ Diagnosis: General Lift Station Issue';
                    result.actions = [
                        { title: 'Complete station audit', desc: 'Check pumps, controls, wet well, force main.', priority: 'high' },
                        { title: 'Review PM schedule', desc: 'Regular maintenance prevents most issues.', priority: 'med' },
                        { title: 'Document and trend', desc: 'Runtime, cycles, amp draw help predict failures.', priority: 'med' }
                    ];
                    result.examTip = 'Lift station maintenance: Weekly checks, monthly cleaning, annual pump inspection. Document everything.';
                }
                
                return result;
            }
        },
        
        septicity: {
            name: 'Septicity & Corrosion',
            icon: 'ðŸ’€',
            intro: 'Black wastewater or crown corrosion? Let\'s address the septicity problem.',
            questions: [
                {
                    q: 'Where is septicity occurring?',
                    options: [
                        { text: 'Force main discharge', value: 'forcemain' },
                        { text: 'Gravity sewer manholes', value: 'manhole' },
                        { text: 'Headworks/influent', value: 'headworks' },
                        { text: 'Primary clarifier', value: 'primary' }
                    ]
                },
                {
                    q: 'What signs are you seeing?',
                    options: [
                        { text: 'Black wastewater with Hâ‚‚S odor', value: 'black' },
                        { text: 'Crown corrosion in pipes/manholes', value: 'corrosion' },
                        { text: 'High oxygen demand at plant', value: 'demand' },
                        { text: 'Complaints from downstream plant', value: 'complaints' }
                    ]
                },
                {
                    q: 'What is the force main detention time?',
                    options: [
                        { text: '< 2 hours', value: 'short' },
                        { text: '2-4 hours', value: 'moderate' },
                        { text: '> 4 hours', value: 'long' },
                        { text: 'No force main / gravity system', value: 'gravity' }
                    ]
                }
            ],
            getDiagnosis: function(answers) {
                var result = { title: '', level: 'warning', actions: [] };
                
                if (answers[2] === 'long' || answers[0] === 'forcemain') {
                    result.title = 'ðŸŽ¯ Diagnosis: Force Main Septicity';
                    result.level = 'danger';
                    result.actions = [
                        { title: 'Add chemical oxidant', desc: 'Calcium nitrate, oxygen, or hydrogen peroxide injection.', priority: 'high' },
                        { title: 'Reduce detention time', desc: 'If possible, pump more frequently. Evaluate parallel main.', priority: 'med', calc: 74 },
                        { title: 'Add iron salts', desc: 'Ferric or ferrous chloride binds sulfide. Inject at lift station.', priority: 'med' },
                        { title: 'Consider air/Oâ‚‚ injection', desc: 'Maintain aerobic conditions in force main.', priority: 'med' },
                        { title: 'Protect downstream', desc: 'Ventilate receiving manhole, coat crown with epoxy.', priority: 'low' }
                    ];
                    result.examTip = 'Force main septicity occurs when detention > 4 hours. Prevention: chemicals (nitrate, iron, oxygen) or reduce detention.';
                }
                else if (answers[1] === 'corrosion') {
                    result.title = 'ðŸŽ¯ Diagnosis: Crown Corrosion / Biogenic Sulfuric Acid';
                    result.level = 'danger';
                    result.actions = [
                        { title: 'Address Hâ‚‚S source', desc: 'Corrosion is symptom. Fix septicity causing Hâ‚‚S.', priority: 'high' },
                        { title: 'Ventilate problem areas', desc: 'Remove Hâ‚‚S before bacteria convert to acid.', priority: 'high' },
                        { title: 'Apply protective coating', desc: 'Epoxy or calcium aluminate liner on concrete.', priority: 'med' },
                        { title: 'Monitor and document', desc: 'Track corrosion rate, plan rehabilitation.', priority: 'med' }
                    ];
                    result.examTip = 'Crown corrosion: Hâ‚‚S rises, Thiobacillus bacteria convert to Hâ‚‚SOâ‚„ on crown. Can destroy concrete in years.';
                }
                else if (answers[0] === 'gravity') {
                    result.title = 'ðŸŽ¯ Diagnosis: Gravity Sewer Septicity';
                    result.actions = [
                        { title: 'Check for flat grades', desc: 'Flat sections allow settling and septic conditions.', priority: 'high' },
                        { title: 'Flush problem sections', desc: 'Regular flushing keeps flow moving.', priority: 'med' },
                        { title: 'Address debris/deposits', desc: 'Grease, grit, roots restrict flow and cause ponding.', priority: 'med' },
                        { title: 'Evaluate ventilation', desc: 'Natural air flow in sewers reduces Hâ‚‚S buildup.', priority: 'low' }
                    ];
                    result.examTip = 'Gravity sewers go septic from: flat grades, low flow, debris buildup. Maintain minimum 2 fps velocity.';
                }
                else {
                    result.title = 'ðŸŽ¯ Diagnosis: General Septicity Issue';
                    result.actions = [
                        { title: 'Identify septic sources', desc: 'Map where black wastewater first appears.', priority: 'high' },
                        { title: 'Test for sulfide', desc: 'Measure dissolved and total sulfide. Hâ‚‚S in air.', priority: 'med' },
                        { title: 'Develop treatment plan', desc: 'Chemical addition points, ventilation, infrastructure.', priority: 'med' }
                    ];
                    result.examTip = 'Septicity indicators: black color, Hâ‚‚S odor, negative ORP, low/no DO. Prevention is cheaper than treatment.';
                }
                
                return result;
            }
        },
        
        toxicity: {
            name: 'Toxic Shock Recovery',
            icon: 'â˜ ï¸',
            intro: 'Industrial spill or sudden process upset? Let\'s recover your biology.',
            questions: [
                {
                    q: 'What happened?',
                    options: [
                        { text: 'Known industrial discharge', value: 'industrial' },
                        { text: 'Unknown cause but biology crashed', value: 'unknown' },
                        { text: 'Chemical spill at plant', value: 'spill' },
                        { text: 'Sudden effluent violation', value: 'violation' }
                    ]
                },
                {
                    q: 'What effects are you seeing?',
                    options: [
                        { text: 'Loss of nitrification only', value: 'nitrification' },
                        { text: 'Total biological failure (BOD & ammonia)', value: 'total' },
                        { text: 'Sludge die-off (brown foam, odor)', value: 'dieoff' },
                        { text: 'Gradual decline in performance', value: 'gradual' }
                    ]
                },
                {
                    q: 'Do you have seed sludge available?',
                    options: [
                        { text: 'Yes - from nearby plant', value: 'yes' },
                        { text: 'No - must recover on own', value: 'no' },
                        { text: 'Can purchase commercial seed', value: 'commercial' }
                    ]
                }
            ],
            getDiagnosis: function(answers) {
                var result = { title: '', level: 'danger', actions: [] };
                
                if (answers[1] === 'total' || answers[1] === 'dieoff') {
                    result.title = 'ðŸŽ¯ Diagnosis: Severe Biological Upset';
                    result.actions = [
                        { title: 'STOP toxic source immediately', desc: 'Find and eliminate what caused the upset.', priority: 'high' },
                        { title: 'Maximize RAS, stop WAS', desc: 'Keep what biology you have. Don\'t waste any sludge.', priority: 'high' },
                        { title: 'Get seed sludge if possible', desc: 'Borrow from nearby plant. Greatly speeds recovery.', priority: 'high' },
                        { title: 'Maintain DO > 2 mg/L', desc: 'Surviving organisms need oxygen to recover.', priority: 'high' },
                        { title: 'Reduce loading if possible', desc: 'Bypass primary to reduce BOD load during recovery.', priority: 'med' },
                        { title: 'Notify TCEQ', desc: 'May need to report upset and projected recovery time.', priority: 'med' }
                    ];
                    result.examTip = 'Recovery from toxic shock: 2-4 weeks typical. Keep surviving bugs (max RAS, no WAS), add seed, maintain DO.';
                }
                else if (answers[1] === 'nitrification') {
                    result.title = 'ðŸŽ¯ Diagnosis: Nitrifier Kill';
                    result.actions = [
                        { title: 'Identify and eliminate cause', desc: 'Heavy metals, chlorine, or other nitrifier toxics.', priority: 'high' },
                        { title: 'Stop WAS completely', desc: 'Nitrifiers are slow-growing. Keep what you have.', priority: 'high' },
                        { title: 'Maintain conditions for recovery', desc: 'DO > 2, pH 7-8.5, temperature stable.', priority: 'high' },
                        { title: 'Get nitrifying seed if available', desc: 'Speeds recovery from weeks to days.', priority: 'med' },
                        { title: 'Monitor ammonia daily', desc: 'Track recovery progress. May take 2-4 weeks without seed.', priority: 'med' }
                    ];
                    result.examTip = 'Nitrifier recovery without seed: 2-4 weeks. With good seed sludge: 3-7 days. Protect your nitrifiers!';
                }
                else if (answers[0] === 'industrial') {
                    result.title = 'ðŸŽ¯ Diagnosis: Industrial Discharge Impact';
                    result.actions = [
                        { title: 'Document everything', desc: 'Sample, photograph, record times. You may need for enforcement.', priority: 'high' },
                        { title: 'Contact industry', desc: 'Notify responsible party. May need to stop discharge.', priority: 'high' },
                        { title: 'Evaluate pretreatment', desc: 'May need permit modification, limits, or monitoring.', priority: 'med' },
                        { title: 'Review pretreatment program', desc: 'Are IU permits adequate? Monitoring frequency?', priority: 'med' }
                    ];
                    result.examTip = 'Industrial upsets: Document, notify industry, evaluate pretreatment program. Prevention > recovery.';
                }
                else {
                    result.title = 'ðŸŽ¯ Diagnosis: Unknown Upset - Investigation Needed';
                    result.actions = [
                        { title: 'Sample and analyze', desc: 'Influent composite, grab samples. Test for metals, toxics.', priority: 'high' },
                        { title: 'Review recent discharge records', desc: 'Check industrial users, truck haulers.', priority: 'high' },
                        { title: 'Check plant chemical use', desc: 'Overdose of polymer, chlorine, etc. could cause upset.', priority: 'med' },
                        { title: 'Support recovery', desc: 'Stop WAS, maximize RAS, maintain DO while investigating.', priority: 'med' }
                    ];
                    result.examTip = 'Unknown upsets: Start recovery immediately while investigating cause. Document everything for future prevention.';
                }
                
                return result;
            }
        },
        
        phosphorus: {
            name: 'Phosphorus Removal',
            icon: 'ðŸ…¿ï¸',
            intro: 'High effluent phosphorus? Let\'s optimize removal.',
            questions: [
                {
                    q: 'What P removal method are you using?',
                    options: [
                        { text: 'Chemical only (alum, ferric)', value: 'chemical' },
                        { text: 'Biological (Bio-P)', value: 'biological' },
                        { text: 'Both (bio + chemical polish)', value: 'both' },
                        { text: 'No P removal currently', value: 'none' }
                    ]
                },
                {
                    q: 'What is your effluent TP?',
                    options: [
                        { text: '< 0.5 mg/L', value: 'excellent' },
                        { text: '0.5 - 1.0 mg/L', value: 'good' },
                        { text: '1.0 - 2.0 mg/L', value: 'moderate' },
                        { text: '> 2.0 mg/L', value: 'high' }
                    ]
                },
                {
                    q: 'What is your permit limit?',
                    options: [
                        { text: '< 0.5 mg/L (stringent)', value: 'stringent' },
                        { text: '0.5 - 1.0 mg/L', value: 'moderate' },
                        { text: '1 - 2 mg/L', value: 'typical' },
                        { text: 'No limit / monitoring only', value: 'none' }
                    ]
                }
            ],
            getDiagnosis: function(answers) {
                var result = { title: '', level: 'warning', actions: [] };
                
                if (answers[0] === 'chemical') {
                    result.title = 'ðŸŽ¯ Diagnosis: Chemical P Removal Optimization';
                    result.actions = [
                        { title: 'Optimize dose and feed point', desc: 'Jar tests to find minimum dose. Multiple feed points may help.', priority: 'high', calc: 14 },
                        { title: 'Check mixing/contact time', desc: 'Metal salts need good mixing and adequate contact.', priority: 'med' },
                        { title: 'Consider polymer aid', desc: 'Anionic polymer can improve floc settling.', priority: 'med' },
                        { title: 'Monitor sludge increase', desc: 'Chemical P removal increases sludge 30-50%.', priority: 'low' }
                    ];
                    result.examTip = 'Chemical P: 1.5-3 moles metal per mole P. Alum/ferric most common. Pre, simultaneous, or post precipitation.';
                }
                else if (answers[0] === 'biological') {
                    result.title = 'ðŸŽ¯ Diagnosis: Bio-P Troubleshooting';
                    result.actions = [
                        { title: 'Check anaerobic zone', desc: 'Must be truly anaerobic (no DO, no nitrate) for P release.', priority: 'high' },
                        { title: 'Verify VFA availability', desc: 'PAOs need VFAs. Fermenter or primary effluent may help.', priority: 'high' },
                        { title: 'Check for nitrate recycle', desc: 'RAS nitrate kills anaerobic zone. May need anoxic selector.', priority: 'med' },
                        { title: 'Secondary P release', desc: 'Sludge sitting in clarifier releases P. Increase RAS.', priority: 'med' }
                    ];
                    result.examTip = 'Bio-P needs: True anaerobic zone, VFAs (food), NO nitrate/DO intrusion. PAOs release P anaerobic, uptake aerobic.';
                }
                else if (answers[0] === 'both') {
                    result.title = 'ðŸŽ¯ Diagnosis: Combined P Removal';
                    result.actions = [
                        { title: 'Maximize bio-P first', desc: 'Cheaper than chemicals. Optimize anaerobic conditions.', priority: 'high' },
                        { title: 'Use chemical as polish', desc: 'Add at secondary clarifier effluent for final trim.', priority: 'med' },
                        { title: 'Consider tertiary filter', desc: 'For < 0.5 mg/L limits, filtration often needed.', priority: 'med' },
                        { title: 'Optimize overall system', desc: 'Balance bio uptake with chemical polishing.', priority: 'low' }
                    ];
                    result.examTip = 'Stringent P limits (< 0.5): Usually need bio-P + chemical + filtration. Optimize each step.';
                }
                else {
                    result.title = 'ðŸŽ¯ Diagnosis: P Removal Implementation Needed';
                    result.actions = [
                        { title: 'Evaluate options', desc: 'Chemical is quickest. Bio-P needs anaerobic zone.', priority: 'high' },
                        { title: 'Start with chemical', desc: 'Can implement immediately. Alum or ferric at secondary.', priority: 'high', calc: 14 },
                        { title: 'Plan bio-P if feasible', desc: 'Lower long-term cost if you can create anaerobic zone.', priority: 'med' },
                        { title: 'Budget for sludge increase', desc: 'P removal increases sludge production 30-60%.', priority: 'low' }
                    ];
                    result.examTip = 'P removal methods: Chemical (quick, flexible), Biological (cheaper O&M), Combined (for strict limits).';
                }
                
                return result;
            }
        },
        
        startup: {
            name: 'Plant Startup',
            icon: 'ðŸš€',
            intro: 'Starting up a new plant or restarting after shutdown? Let\'s get biology established.',
            questions: [
                {
                    q: 'What is the startup situation?',
                    options: [
                        { text: 'Brand new plant', value: 'new' },
                        { text: 'Seasonal restart', value: 'seasonal' },
                        { text: 'After extended shutdown', value: 'shutdown' },
                        { text: 'New basin/train added', value: 'expansion' }
                    ]
                },
                {
                    q: 'Do you have seed sludge?',
                    options: [
                        { text: 'Yes - from operating basin/plant', value: 'good' },
                        { text: 'Yes - commercial product', value: 'commercial' },
                        { text: 'No - must grow from scratch', value: 'none' }
                    ]
                },
                {
                    q: 'What is the treatment process?',
                    options: [
                        { text: 'Conventional activated sludge', value: 'cas' },
                        { text: 'Extended aeration', value: 'extended' },
                        { text: 'MBR', value: 'mbr' },
                        { text: 'SBR', value: 'sbr' },
                        { text: 'Lagoon', value: 'lagoon' }
                    ]
                }
            ],
            getDiagnosis: function(answers) {
                var result = { title: '', level: 'warning', actions: [] };
                
                if (answers[1] === 'good') {
                    result.title = 'ðŸŽ¯ Startup Plan: With Seed Sludge';
                    result.level = 'success';
                    result.actions = [
                        { title: 'Transfer seed sludge', desc: 'Fill basin 25-50% with seed. Target initial MLSS 1000-1500 mg/L.', priority: 'high' },
                        { title: 'Start aeration', desc: 'Maintain DO > 2 mg/L. Don\'t waste any sludge initially.', priority: 'high' },
                        { title: 'Begin feeding gradually', desc: 'Start at 25-50% of design flow, increase as MLSS builds.', priority: 'high' },
                        { title: 'Monitor daily', desc: 'MLSS, settleability, effluent quality. Expect 2-4 weeks to stabilize.', priority: 'med' },
                        { title: 'Begin WAS when MLSS adequate', desc: 'Start wasting when MLSS reaches target (usually 2500-3500).', priority: 'med' }
                    ];
                    result.examTip = 'Startup with seed: 2-4 weeks to full operation. Without seed: 4-8 weeks. Nitrification takes longest.';
                }
                else if (answers[1] === 'none') {
                    result.title = 'ðŸŽ¯ Startup Plan: Without Seed (Growing From Scratch)';
                    result.actions = [
                        { title: 'Be patient - takes 4-8 weeks', desc: 'Building biology from scratch is slow. Plan accordingly.', priority: 'high' },
                        { title: 'Start with low loading', desc: 'Feed 10-25% of design. Let bacteria grow gradually.', priority: 'high' },
                        { title: 'Don\'t waste sludge', desc: 'No WAS until MLSS is adequate. Keep all the bugs you grow.', priority: 'high' },
                        { title: 'Maintain optimal conditions', desc: 'DO > 2, pH 7-8, temperature stable. Nutrients available.', priority: 'high' },
                        { title: 'Expect nitrification last', desc: 'Nitrifiers are slowest. May take 6-8 weeks without seed.', priority: 'med' }
                    ];
                    result.examTip = 'No seed startup: Heterotrophs grow first (days), then nitrifiers (weeks). MLSS growth: ~0.5 lb/lb BOD removed.';
                }
                else if (answers[0] === 'seasonal') {
                    result.title = 'ðŸŽ¯ Startup Plan: Seasonal Restart';
                    result.actions = [
                        { title: 'Assess existing biomass', desc: 'Check what survived shutdown. May have viable seed.', priority: 'high' },
                        { title: 'Gradually increase load', desc: 'Start slow even if some biology exists.', priority: 'high' },
                        { title: 'Verify equipment function', desc: 'Check all equipment after sitting idle.', priority: 'med' },
                        { title: 'Plan for 2-4 week acclimation', desc: 'Even with existing bugs, takes time to reach full performance.', priority: 'med' }
                    ];
                    result.examTip = 'Seasonal restart: Check surviving biomass, start slow, ramp up over 2-4 weeks. Faster than cold start.';
                }
                else {
                    result.title = 'ðŸŽ¯ Startup Plan: General Guidance';
                    result.actions = [
                        { title: 'Get seed if at all possible', desc: 'Dramatically reduces startup time.', priority: 'high' },
                        { title: 'Start low, go slow', desc: 'Gradual loading is key. Don\'t rush.', priority: 'high' },
                        { title: 'No WAS until established', desc: 'Keep all the bugs you grow or add.', priority: 'high' },
                        { title: 'Monitor closely', desc: 'Daily testing during startup. Adjust as needed.', priority: 'med' }
                    ];
                    result.examTip = 'Startup success factors: Seed sludge > gradual loading > no WAS > optimal conditions. Patience is essential.';
                }
                
                return result;
            }
        },
        
        energy: {
            name: 'Energy Optimization',
            icon: 'âš¡',
            intro: 'High power bills? Let\'s find energy savings opportunities.',
            questions: [
                {
                    q: 'What is your biggest energy use?',
                    options: [
                        { text: 'Aeration blowers', value: 'blowers' },
                        { text: 'Pumping (lift stations, RAS, etc.)', value: 'pumps' },
                        { text: 'Not sure', value: 'unknown' }
                    ]
                },
                {
                    q: 'Do you have DO control?',
                    options: [
                        { text: 'Yes - automatic DO control', value: 'auto' },
                        { text: 'Manual - operator adjusts', value: 'manual' },
                        { text: 'No control - runs constant', value: 'none' }
                    ]
                },
                {
                    q: 'What is your typical aeration basin DO?',
                    options: [
                        { text: '< 1.5 mg/L', value: 'low' },
                        { text: '1.5 - 2.5 mg/L', value: 'optimal' },
                        { text: '2.5 - 4.0 mg/L', value: 'high' },
                        { text: '> 4.0 mg/L', value: 'veryhigh' }
                    ]
                }
            ],
            getDiagnosis: function(answers) {
                var result = { title: '', level: 'warning', actions: [] };
                
                if (answers[2] === 'high' || answers[2] === 'veryhigh') {
                    result.title = 'ðŸŽ¯ Diagnosis: Over-Aeration (Major Energy Waste)';
                    result.actions = [
                        { title: 'Reduce DO setpoint', desc: 'Target 1.5-2.0 mg/L for CAS. You\'re wasting energy above 2.5.', priority: 'high' },
                        { title: 'Install DO control', desc: 'VFD on blowers with DO feedback can save 20-40%.', priority: 'high', calc: 68 },
                        { title: 'Check diffuser efficiency', desc: 'Clean or replace fouled diffusers to improve transfer.', priority: 'med' },
                        { title: 'Evaluate blower efficiency', desc: 'Old blowers may be inefficient. Modern high-speed turbos save 30%.', priority: 'med' }
                    ];
                    result.examTip = 'Aeration is 40-60% of plant energy. Every 0.5 mg/L reduction in DO â‰ˆ 5-10% energy savings. Don\'t over-aerate!';
                }
                else if (answers[1] === 'none') {
                    result.title = 'ðŸŽ¯ Diagnosis: No Aeration Control';
                    result.actions = [
                        { title: 'Install VFDs on blowers', desc: 'Single biggest energy saver. ROI often < 2 years.', priority: 'high' },
                        { title: 'Add DO monitoring', desc: 'Can\'t control what you don\'t measure.', priority: 'high' },
                        { title: 'Implement DO control strategy', desc: 'Cascade control with feed-forward for best results.', priority: 'med' },
                        { title: 'Consider time-of-use operation', desc: 'Shift load to off-peak hours if possible.', priority: 'low' }
                    ];
                    result.examTip = 'DO control with VFDs typically saves 20-40% on aeration energy. Usually best single improvement.';
                }
                else if (answers[0] === 'pumps') {
                    result.title = 'ðŸŽ¯ Diagnosis: Pumping Energy Optimization';
                    result.actions = [
                        { title: 'Check pump efficiency', desc: 'Pumps degrade over time. Test actual vs. design performance.', priority: 'high', calc: 47 },
                        { title: 'Optimize pump scheduling', desc: 'Run fewer pumps at higher efficiency point.', priority: 'med' },
                        { title: 'Consider VFDs on large pumps', desc: 'Variable speed saves energy when flow varies.', priority: 'med' },
                        { title: 'Reduce head where possible', desc: 'Lower head = less energy. Check for throttled valves.', priority: 'low' }
                    ];
                    result.examTip = 'Pump energy âˆ Flow Ã— Head. Run pumps at BEP (best efficiency point). VFDs help match varying flow.';
                }
                else {
                    result.title = 'ðŸŽ¯ Diagnosis: General Energy Optimization';
                    result.actions = [
                        { title: 'Conduct energy audit', desc: 'Measure actual consumption by process area.', priority: 'high' },
                        { title: 'Focus on aeration first', desc: 'Usually 40-60% of plant energy. Best ROI.', priority: 'high' },
                        { title: 'Check motors and drives', desc: 'Premium efficiency motors, VFDs where applicable.', priority: 'med' },
                        { title: 'Consider demand management', desc: 'Peak demand charges can be 30-50% of bill.', priority: 'med' }
                    ];
                    result.examTip = 'Typical plant energy: Aeration 50%, Pumping 20%, Solids handling 15%, Other 15%. Prioritize accordingly.';
                }
                
                return result;
            }
        }
    };

    function startWizard(type) {
        currentWizard = type;
        wizardStep = 0;
        wizardAnswers = {};
        
        // Highlight selected card
        document.querySelectorAll('.wizard-card').forEach(c => c.classList.remove('active'));
        event.target.closest('.wizard-card').classList.add('active');
        
        var wizard = wizardData[type];
        var content = document.getElementById('wizardContent');
        content.style.display = 'block';
        
        content.innerHTML = '<div class="wizard-content-box">' +
            '<div style="font-size:1.1rem;font-weight:bold;color:#f8fafc;margin-bottom:10px;">' + wizard.icon + ' ' + wizard.name + '</div>' +
            '<div style="font-size:0.8rem;color:#94a3b8;margin-bottom:15px;">' + wizard.intro + '</div>' +
            '<div id="wizardQuestion"></div>' +
            '</div>';
        
        showWizardQuestion();
    }

    function showWizardQuestion() {
        var wizard = wizardData[currentWizard];
        var q = wizard.questions[wizardStep];
        var qDiv = document.getElementById('wizardQuestion');
        
        var html = '<div class="wizard-question">' +
            '<div class="wizard-question-text">' + (wizardStep + 1) + '. ' + q.q + '</div>' +
            '<div class="wizard-options">';
        
        q.options.forEach(function(opt, i) {
            html += '<div class="wizard-option" onclick="selectWizardOption(' + i + ',\'' + opt.value + '\')">' + opt.text + '</div>';
        });
        
        html += '</div></div>';
        
        if (wizardStep > 0) {
            html += '<button class="wizard-back-btn" onclick="wizardBack()">â† Back</button>';
        }
        
        qDiv.innerHTML = html;
    }

    function selectWizardOption(index, value) {
        wizardAnswers[wizardStep] = value;
        
        // Highlight selected
        var options = document.querySelectorAll('.wizard-option');
        options.forEach((o, i) => {
            o.classList.toggle('selected', i === index);
        });
        
        // Move to next question or show results
        setTimeout(function() {
            wizardStep++;
            if (wizardStep < wizardData[currentWizard].questions.length) {
                showWizardQuestion();
            } else {
                showWizardResults();
            }
        }, 200);
    }

    function wizardBack() {
        if (wizardStep > 0) {
            wizardStep--;
            showWizardQuestion();
        }
    }

    function showWizardResults() {
        var wizard = wizardData[currentWizard];
        var diagnosis = wizard.getDiagnosis(wizardAnswers);
        
        var html = '<div class="wizard-result ' + diagnosis.level + '">' +
            '<div class="wizard-result-title">' + diagnosis.title + '</div>';
        
        html += '<div style="font-size:0.8rem;color:#94a3b8;margin-bottom:12px;"><b>Recommended Actions:</b></div>';
        
        diagnosis.actions.forEach(function(action) {
            var priorityClass = action.priority === 'high' ? 'priority-high' : (action.priority === 'med' ? 'priority-med' : '');
            html += '<div class="wizard-action ' + priorityClass + '">' +
                '<div class="wizard-action-title">' + 
                (action.priority === 'high' ? 'ðŸ”´ ' : (action.priority === 'med' ? 'ðŸŸ¡ ' : 'ðŸŸ¢ ')) + 
                action.title + '</div>' +
                '<div class="wizard-action-desc">' + action.desc + '</div>';
            
            if (action.calc) {
                html += '<span class="wizard-calc-link" onclick="wizardGoToCalc(' + action.calc + ')">ðŸ“Š Open Calculator #' + action.calc + '</span>';
            }
            
            html += '</div>';
        });
        
        if (diagnosis.examTip) {
            html += '<div style="background:rgba(245,158,11,0.1);border-radius:6px;padding:10px;margin-top:12px;border-left:3px solid #f59e0b;">' +
                '<div style="font-size:0.75rem;color:#fbbf24;font-weight:bold;">ðŸ“ TCEQ Exam Tip:</div>' +
                '<div style="font-size:0.75rem;color:#fcd34d;margin-top:4px;">' + diagnosis.examTip + '</div></div>';
        }
        
        html += '<button class="wizard-back-btn" onclick="startWizard(\'' + currentWizard + '\')" style="margin-right:8px;">ðŸ”„ Start Over</button>' +
            '<button class="wizard-back-btn" onclick="closeWizard()">âœ• Close Wizard</button>';
        
        html += '</div>';
        
        document.getElementById('wizardQuestion').innerHTML = html;
    }

    function wizardGoToCalc(num) {
        closeWizard();
        // Reset filter to show all
        filterCat('all', document.querySelector('[data-filter="all"]'));
        goToCard(num);
    }

    function closeWizard() {
        document.getElementById('wizardContent').style.display = 'none';
        document.querySelectorAll('.wizard-card').forEach(c => c.classList.remove('active'));
        currentWizard = null;
    }

    // ==================== CHEMICAL INVENTORY MODULE ====================
    const CHEM_STORAGE_KEY = 'ww_chemical_inventory';
    let chemInventory = [];
    let chemHistory = [];

    function loadChemData() {
        try {
            const saved = localStorage.getItem(CHEM_STORAGE_KEY);
            if (saved) {
                const data = JSON.parse(saved);
                chemInventory = data.inventory || [];
                chemHistory = data.history || [];
            }
        } catch(e) {
            chemInventory = [];
            chemHistory = [];
        }
    }

    function saveChemData() {
        try {
            localStorage.setItem(CHEM_STORAGE_KEY, JSON.stringify({
                inventory: chemInventory,
                history: chemHistory
            }));
        } catch(e) {}
    }

    function initChemicals() {
        loadChemData();
        renderChemInventory();
        updateChemAlerts();
        updateChemSummary();
        populateUsageDropdown();
        document.getElementById('usage_date').valueAsDate = new Date();
    }

    function showChemPanel(panel, btn) {
        document.querySelectorAll('.chem-panel').forEach(p => p.style.display = 'none');
        document.querySelectorAll('.chem-tab').forEach(t => t.classList.remove('active'));
        document.getElementById('chem-panel-' + panel).style.display = 'block';
        btn.classList.add('active');
    }

    function showChemDashboard(show) {
        const dash = document.getElementById('chemDashboard');
        dash.style.display = show ? 'block' : 'none';
        if (show) initChemicals();
    }

    function renderChemInventory() {
        const grid = document.getElementById('chemGrid');
        if (chemInventory.length === 0) {
            grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#64748b;">' +
                '<div style="font-size:2.5rem;opacity:0.5;margin-bottom:10px;">ðŸ§ª</div>' +
                '<div>No chemicals added yet. Click "âž• Add Chemical" to get started.</div></div>';
            return;
        }
        
        grid.innerHTML = chemInventory.map((chem, idx) => {
            const pct = chem.maxQty > 0 ? (chem.qty / chem.maxQty) * 100 : 0;
            const status = chem.qty <= chem.criticalLevel ? 'critical' : 
                          chem.qty <= chem.reorderLevel ? 'low-stock' : '';
            const badge = chem.qty <= chem.criticalLevel ? '<span class="chem-card-badge chem-badge-critical">CRITICAL</span>' :
                         chem.qty <= chem.reorderLevel ? '<span class="chem-card-badge chem-badge-low">LOW</span>' :
                         '<span class="chem-card-badge chem-badge-ok">OK</span>';
            const progressClass = chem.qty <= chem.criticalLevel ? 'chem-progress-critical' :
                                 chem.qty <= chem.reorderLevel ? 'chem-progress-low' : 'chem-progress-ok';
            
            const daysLeft = chem.avgUsage > 0 ? Math.floor(chem.qty / chem.avgUsage) : 'â€”';
            
            return '<div class="chem-card ' + status + '">' +
                '<div class="chem-card-header">' +
                    '<div><div class="chem-card-name">' + chem.name + '</div>' +
                    '<div class="chem-card-type">' + chem.type + '</div></div>' +
                    badge +
                '</div>' +
                '<div class="chem-card-row"><span class="chem-card-label">Current Stock</span>' +
                    '<span class="chem-card-value">' + chem.qty.toLocaleString() + ' ' + chem.unit + '</span></div>' +
                '<div class="chem-card-row"><span class="chem-card-label">Reorder Level</span>' +
                    '<span class="chem-card-value">' + chem.reorderLevel.toLocaleString() + ' ' + chem.unit + '</span></div>' +
                '<div class="chem-card-row"><span class="chem-card-label">Days Supply</span>' +
                    '<span class="chem-card-value">' + daysLeft + '</span></div>' +
                '<div class="chem-card-row"><span class="chem-card-label">Unit Cost</span>' +
                    '<span class="chem-card-value">$' + (chem.unitCost || 0).toFixed(2) + '</span></div>' +
                '<div class="chem-progress-bar"><div class="chem-progress-fill ' + progressClass + '" style="width:' + Math.min(100, pct) + '%"></div></div>' +
                '<div class="chem-card-actions">' +
                    '<button class="chem-card-btn chem-btn-add" onclick="quickAddStock(' + idx + ')">+ Add</button>' +
                    '<button class="chem-card-btn chem-btn-use" onclick="quickUseStock(' + idx + ')">- Use</button>' +
                    '<button class="chem-card-btn chem-btn-edit" onclick="editChemical(' + idx + ')">âœï¸</button>' +
                '</div>' +
            '</div>';
        }).join('');
    }

    function updateChemSummary() {
        document.getElementById('chem-total').textContent = chemInventory.length;
        const lowCount = chemInventory.filter(c => c.qty <= c.reorderLevel && c.qty > c.criticalLevel).length;
        const critCount = chemInventory.filter(c => c.qty <= c.criticalLevel).length;
        document.getElementById('chem-low').textContent = lowCount;
        document.getElementById('chem-critical').textContent = critCount;
        
        // Calculate monthly cost estimate
        const monthlyCost = chemInventory.reduce((sum, c) => {
            return sum + (c.avgUsage || 0) * 30 * (c.unitCost || 0);
        }, 0);
        document.getElementById('chem-cost').textContent = '$' + monthlyCost.toFixed(0);
    }

    function updateChemAlerts() {
        const alertsDiv = document.getElementById('chemAlerts');
        const alerts = [];
        
        chemInventory.forEach(chem => {
            if (chem.qty <= chem.criticalLevel) {
                alerts.push({
                    type: 'critical',
                    title: chem.name + ' - CRITICAL LEVEL',
                    desc: 'Only ' + chem.qty + ' ' + chem.unit + ' remaining. Order immediately!'
                });
            } else if (chem.qty <= chem.reorderLevel) {
                const daysLeft = chem.avgUsage > 0 ? Math.floor(chem.qty / chem.avgUsage) : null;
                alerts.push({
                    type: 'warn',
                    title: chem.name + ' - Low Stock',
                    desc: chem.qty + ' ' + chem.unit + ' remaining' + (daysLeft ? ' (~' + daysLeft + ' days supply)' : '') + '. Consider reordering.'
                });
            }
        });
        
        if (alerts.length === 0) {
            alertsDiv.innerHTML = '';
            return;
        }
        
        alertsDiv.innerHTML = alerts.map(a => 
            '<div class="chem-alert ' + (a.type === 'warn' ? 'warn' : '') + '">' +
            '<span class="chem-alert-icon">' + (a.type === 'critical' ? 'ðŸš¨' : 'âš ï¸') + '</span>' +
            '<div class="chem-alert-content"><div class="chem-alert-title">' + a.title + '</div>' +
            '<div class="chem-alert-desc">' + a.desc + '</div></div></div>'
        ).join('');
    }

    function populateUsageDropdown() {
        const sel = document.getElementById('usage_chem');
        sel.innerHTML = '<option value="">Select chemical...</option>' +
            chemInventory.map((c, i) => '<option value="' + i + '">' + c.name + '</option>').join('');
    }

    function addChemical() {
        const name = document.getElementById('chem_name').value.trim();
        if (!name) { alert('Enter chemical name'); return; }
        
        const chem = {
            id: Date.now(),
            name: name,
            type: document.getElementById('chem_type').value,
            qty: parseFloat(document.getElementById('chem_qty').value) || 0,
            unit: document.getElementById('chem_unit').value,
            reorderLevel: parseFloat(document.getElementById('chem_reorder').value) || 0,
            criticalLevel: parseFloat(document.getElementById('chem_critical').value) || 0,
            maxQty: parseFloat(document.getElementById('chem_max').value) || 0,
            unitCost: parseFloat(document.getElementById('chem_cost').value) || 0,
            supplier: document.getElementById('chem_supplier').value,
            leadTime: parseInt(document.getElementById('chem_lead').value) || 0,
            avgUsage: 0,
            lastUpdated: new Date().toISOString()
        };
        
        chemInventory.push(chem);
        saveChemData();
        
        // Log initial stock as delivery
        logChemTransaction(chemInventory.length - 1, 'delivery', chem.qty, 'Initial stock');
        
        // Clear form
        ['chem_name','chem_qty','chem_reorder','chem_critical','chem_max','chem_cost','chem_supplier','chem_lead'].forEach(id => {
            document.getElementById(id).value = '';
        });
        
        renderChemInventory();
        updateChemSummary();
        updateChemAlerts();
        populateUsageDropdown();
        showToast('Chemical added!', 'success');
        showChemPanel('inventory', document.querySelector('.chem-tab'));
    }

    function presetChem(type) {
        const presets = {
            chlorine: { name: 'Sodium Hypochlorite (12.5%)', type: 'disinfection', unit: 'gal', reorder: 200, critical: 50, max: 1000, cost: 1.50 },
            polymer: { name: 'Cationic Polymer', type: 'polymer', unit: 'lbs', reorder: 100, critical: 25, max: 500, cost: 3.50 },
            alum: { name: 'Aluminum Sulfate', type: 'coagulant', unit: 'lbs', reorder: 500, critical: 100, max: 2000, cost: 0.25 },
            caustic: { name: 'Sodium Hydroxide (50%)', type: 'pH', unit: 'gal', reorder: 150, critical: 30, max: 500, cost: 2.00 },
            ferric: { name: 'Ferric Chloride', type: 'coagulant', unit: 'gal', reorder: 200, critical: 50, max: 800, cost: 1.25 },
            bisulfite: { name: 'Sodium Bisulfite', type: 'disinfection', unit: 'gal', reorder: 100, critical: 25, max: 400, cost: 1.75 }
        };
        const p = presets[type];
        if (!p) return;
        
        document.getElementById('chem_name').value = p.name;
        document.getElementById('chem_type').value = p.type;
        document.getElementById('chem_unit').value = p.unit;
        document.getElementById('chem_reorder').value = p.reorder;
        document.getElementById('chem_critical').value = p.critical;
        document.getElementById('chem_max').value = p.max;
        document.getElementById('chem_cost').value = p.cost;
    }

    function quickAddStock(idx) {
        const chem = chemInventory[idx];
        const amount = prompt('Add ' + chem.name + ' stock (' + chem.unit + '):', '100');
        if (!amount) return;
        const qty = parseFloat(amount);
        if (isNaN(qty) || qty <= 0) return;
        
        chem.qty += qty;
        chem.lastUpdated = new Date().toISOString();
        saveChemData();
        logChemTransaction(idx, 'delivery', qty, 'Stock added');
        renderChemInventory();
        updateChemSummary();
        updateChemAlerts();
        showToast('Added ' + qty + ' ' + chem.unit, 'success');
    }

    function quickUseStock(idx) {
        const chem = chemInventory[idx];
        const amount = prompt('Use ' + chem.name + ' (' + chem.unit + '):', '10');
        if (!amount) return;
        const qty = parseFloat(amount);
        if (isNaN(qty) || qty <= 0) return;
        
        chem.qty = Math.max(0, chem.qty - qty);
        chem.lastUpdated = new Date().toISOString();
        
        // Update average usage (simple rolling average)
        if (!chem.usageHistory) chem.usageHistory = [];
        chem.usageHistory.push({ date: new Date().toISOString(), qty: qty });
        if (chem.usageHistory.length > 30) chem.usageHistory.shift();
        chem.avgUsage = chem.usageHistory.reduce((s, u) => s + u.qty, 0) / chem.usageHistory.length;
        
        saveChemData();
        logChemTransaction(idx, 'usage', -qty, 'Stock used');
        renderChemInventory();
        updateChemSummary();
        updateChemAlerts();
        showToast('Used ' + qty + ' ' + chem.unit, 'success');
    }

    function editChemical(idx) {
        const chem = chemInventory[idx];
        const action = prompt('Edit ' + chem.name + ':\n1 = Update quantity\n2 = Edit reorder level\n3 = Delete chemical', '1');
        
        if (action === '1') {
            const newQty = prompt('New quantity (' + chem.unit + '):', chem.qty);
            if (newQty !== null) {
                const diff = parseFloat(newQty) - chem.qty;
                chem.qty = parseFloat(newQty) || 0;
                saveChemData();
                logChemTransaction(idx, 'adjustment', diff, 'Manual adjustment');
                renderChemInventory();
                updateChemSummary();
                updateChemAlerts();
            }
        } else if (action === '2') {
            const newLevel = prompt('New reorder level:', chem.reorderLevel);
            if (newLevel !== null) {
                chem.reorderLevel = parseFloat(newLevel) || 0;
                saveChemData();
                renderChemInventory();
                updateChemAlerts();
            }
        } else if (action === '3') {
            if (confirm('Delete ' + chem.name + '?')) {
                chemInventory.splice(idx, 1);
                saveChemData();
                renderChemInventory();
                updateChemSummary();
                updateChemAlerts();
                populateUsageDropdown();
                showToast('Chemical deleted', 'success');
            }
        }
    }

    function logChemTransaction(idx, type, amount, notes) {
        const chem = chemInventory[idx];
        chemHistory.unshift({
            date: new Date().toISOString(),
            chemName: chem.name,
            type: type,
            amount: amount,
            balance: chem.qty,
            unit: chem.unit,
            notes: notes || ''
        });
        if (chemHistory.length > 500) chemHistory = chemHistory.slice(0, 500);
        saveChemData();
        renderChemHistory();
    }

    function logChemUsage() {
        const idx = parseInt(document.getElementById('usage_chem').value);
        if (isNaN(idx)) { alert('Select a chemical'); return; }
        const amount = parseFloat(document.getElementById('usage_amount').value);
        if (!amount || amount <= 0) { alert('Enter valid amount'); return; }
        
        const chem = chemInventory[idx];
        chem.qty = Math.max(0, chem.qty - amount);
        if (!chem.usageHistory) chem.usageHistory = [];
        chem.usageHistory.push({ date: new Date().toISOString(), qty: amount });
        if (chem.usageHistory.length > 30) chem.usageHistory.shift();
        chem.avgUsage = chem.usageHistory.reduce((s, u) => s + u.qty, 0) / chem.usageHistory.length;
        
        saveChemData();
        logChemTransaction(idx, 'usage', -amount, document.getElementById('usage_notes').value);
        
        document.getElementById('usage_amount').value = '';
        document.getElementById('usage_notes').value = '';
        
        renderChemInventory();
        updateChemSummary();
        updateChemAlerts();
        showToast('Usage logged', 'success');
    }

    function autoCalcFromDosing() {
        // Try to auto-calculate from calculator #13 (Chemical Dosing)
        const flowEl = document.getElementById('chem_flow');
        const doseEl = document.getElementById('chem_dose');
        if (flowEl && doseEl && flowEl.value && doseEl.value) {
            const flow = parseFloat(flowEl.value);
            const dose = parseFloat(doseEl.value);
            const lbsDay = flow * dose * 8.34;
            document.getElementById('usage_amount').value = lbsDay.toFixed(1);
            showToast('Calculated: ' + lbsDay.toFixed(1) + ' lbs/day', 'success');
        } else {
            showToast('Enter values in Chemical Dosing calc (#13) first', 'warning');
        }
    }

    function renderChemHistory() {
        const tbody = document.getElementById('chemHistoryBody');
        if (chemHistory.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#64748b;padding:20px;">No transactions yet</td></tr>';
            return;
        }
        
        tbody.innerHTML = chemHistory.slice(0, 100).map(h => {
            const d = new Date(h.date);
            const typeIcon = h.type === 'delivery' ? 'ðŸ“¦' : h.type === 'usage' ? 'ðŸ“‰' : 'âš™ï¸';
            const amtColor = h.amount >= 0 ? '#4ade80' : '#f87171';
            return '<tr>' +
                '<td>' + d.toLocaleDateString() + '</td>' +
                '<td>' + h.chemName + '</td>' +
                '<td>' + typeIcon + ' ' + h.type + '</td>' +
                '<td style="color:' + amtColor + '">' + (h.amount >= 0 ? '+' : '') + h.amount + ' ' + h.unit + '</td>' +
                '<td>' + h.balance + ' ' + h.unit + '</td>' +
                '<td>' + (h.notes || 'â€”') + '</td></tr>';
        }).join('');
    }

    function exportChemHistory() {
        if (chemHistory.length === 0) { alert('No history to export'); return; }
        const headers = ['Date', 'Chemical', 'Type', 'Amount', 'Balance', 'Unit', 'Notes'];
        const rows = chemHistory.map(h => [
            new Date(h.date).toLocaleDateString(),
            h.chemName, h.type, h.amount, h.balance, h.unit, h.notes || ''
        ]);
        const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'chemical-history-' + new Date().toISOString().split('T')[0] + '.csv';
        a.click();
        showToast('History exported', 'success');
    }

    function clearChemHistory() {
        if (confirm('Clear ALL transaction history?')) {
            chemHistory = [];
            saveChemData();
            renderChemHistory();
            showToast('History cleared', 'success');
        }
    }

    // Modify filterCat to show trending and chemicals dashboards
    const _origFilterCat = typeof filterCat === 'function' ? filterCat : null;
    filterCat = function(cat, btn) {
        showTrendingDashboard(cat === 'trending');
        showChemDashboard(cat === 'chemicals');
        
        // Hide/show cards based on filter
        document.querySelectorAll('.card').forEach(card => {
            if (cat === 'trending' || cat === 'chemicals') {
                card.classList.add('search-hidden');
            } else {
                card.classList.remove('search-hidden');
            }
        });
        
        // Update chip styles
        document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        
        // If not trending or chemicals, call original filter
        if (cat !== 'trending' && cat !== 'chemicals' && _origFilterCat) {
            _origFilterCat(cat, btn);
        }
    };

    // ==================== BACK TO TOP ====================
    function scrollToTop() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    function handleScroll() {
        var btn = document.getElementById('backToTop');
        if (!btn) return;
        if (window.scrollY > 400) {
            btn.classList.add('visible');
        } else {
            btn.classList.remove('visible');
        }
    }
    
    window.addEventListener('scroll', handleScroll, { passive: true });

    // ==================== UPDATE CHECKER ====================
    var currentVersion = 'v9.14';
    
    function checkForUpdates() {
        var btn = document.getElementById('btnUpdate');
        btn.classList.add('checking');
        btn.innerHTML = '<span class="update-icon">â†»</span> Checking...';
        
        // Simulate update check (in production, this would fetch from server)
        setTimeout(function() {
            btn.classList.remove('checking');
            
            // Check localStorage for cached version
            var cachedVer = localStorage.getItem('ww_version');
            var lastCheck = localStorage.getItem('ww_last_update_check');
            var now = Date.now();
            
            // Save current version and check time
            localStorage.setItem('ww_version', currentVersion);
            localStorage.setItem('ww_last_update_check', now);
            
            if (cachedVer && cachedVer !== currentVersion) {
                // New version detected
                btn.innerHTML = '<span class="update-icon">âœ“</span> Updated!';
                btn.style.background = 'linear-gradient(135deg, #22c55e, #16a34a)';
                showUpdateToast('Updated to ' + currentVersion + '!');
                setTimeout(function() {
                    location.reload(true);
                }, 1500);
            } else {
                // Already up to date - just refresh
                btn.innerHTML = '<span class="update-icon">âœ“</span> Current';
                btn.style.background = 'linear-gradient(135deg, #22c55e, #16a34a)';
                showUpdateToast('You have the latest version (' + currentVersion + ')');
                setTimeout(function() {
                    btn.innerHTML = '<span class="update-icon">â†»</span> Update';
                    btn.style.background = '';
                }, 2000);
            }
        }, 800);
    }
    
    function showUpdateToast(msg) {
        // Create toast if doesn't exist
        var toast = document.getElementById('updateToast');
        if (!toast) {
            toast = document.createElement('div');
            toast.id = 'updateToast';
            toast.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#1e293b;color:#f8fafc;padding:12px 20px;border-radius:8px;font-size:0.85rem;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,0.3);border:1px solid #334155;opacity:0;transition:opacity 0.3s;';
            document.body.appendChild(toast);
        }
        
        toast.textContent = msg;
        toast.style.opacity = '1';
        
        setTimeout(function() {
            toast.style.opacity = '0';
        }, 2500);
    }
    
    function forceRefresh() {
        // Clear cache and reload
        if ('caches' in window) {
            caches.keys().then(function(names) {
                names.forEach(function(name) {
                    caches.delete(name);
                });
            }).then(function() {
                location.reload(true);
            });
        } else {
            location.reload(true);
        }
    }

    // ==================== TCEQ TOOLS ====================
    
    // 91. DMR Calculator
    function calcDMR() {
        var valuesText = document.getElementById('dmr_values').value;
        var limitAvg = parseFloat(document.getElementById('dmr_limit_avg').value);
        var limitMax = parseFloat(document.getElementById('dmr_limit_max').value);
        var flow = parseFloat(document.getElementById('dmr_flow').value);
        var param = document.getElementById('dmr_param').value;
        
        // Parse values
        var values = valuesText.split(/[,\n\s]+/).map(function(v) {
            return parseFloat(v.trim());
        }).filter(function(v) {
            return !isNaN(v) && v >= 0;
        });
        
        if (values.length === 0) {
            document.getElementById('dmr_res').innerHTML = 'â€”';
            document.getElementById('dmr_status').innerHTML = 'Enter daily values...';
            return;
        }
        
        var sum = values.reduce(function(a, b) { return a + b; }, 0);
        var avg = sum / values.length;
        var max = Math.max.apply(null, values);
        var min = Math.min.apply(null, values);
        
        // Calculate loading if flow provided
        var loading = '';
        if (flow > 0) {
            var loadLbs = avg * flow * 8.34;
            loading = '<br>ðŸ“¦ <b>Loading:</b> ' + loadLbs.toFixed(1) + ' lbs/day';
        }
        
        // Check exceedances
        var avgStatus = '', maxStatus = '';
        if (limitAvg > 0) {
            var avgPct = (avg / limitAvg * 100).toFixed(0);
            if (avg > limitAvg) {
                avgStatus = ' <span style="color:#ef4444;">âš ï¸ EXCEEDS LIMIT</span>';
            } else if (avg > limitAvg * 0.9) {
                avgStatus = ' <span style="color:#f59e0b;">(' + avgPct + '% of limit)</span>';
            } else {
                avgStatus = ' <span style="color:#22c55e;">âœ“ (' + avgPct + '%)</span>';
            }
        }
        if (limitMax > 0) {
            if (max > limitMax) {
                maxStatus = ' <span style="color:#ef4444;">âš ï¸ EXCEEDS LIMIT</span>';
            } else if (max > limitMax * 0.9) {
                maxStatus = ' <span style="color:#f59e0b;">(approaching)</span>';
            } else {
                maxStatus = ' <span style="color:#22c55e;">âœ“</span>';
            }
        }
        
        var res = 'ðŸ“Š <b>Monthly Avg:</b> ' + avg.toFixed(2) + avgStatus +
                  '<br>ðŸ“ˆ <b>Daily Max:</b> ' + max.toFixed(2) + maxStatus +
                  '<br>ðŸ“‰ <b>Daily Min:</b> ' + min.toFixed(2) +
                  '<br>ðŸ“… <b>Sample Count:</b> ' + values.length +
                  loading;
        
        document.getElementById('dmr_res').innerHTML = res;
        document.getElementById('dmr_status').innerHTML = 'DMR values calculated';
        document.getElementById('dmr_status').style.color = '#4ade80';
    }
    
    // 92. Permit Limit Tracker
    function updatePermitCard() {
        var param = document.getElementById('perm_param').value;
        var value = parseFloat(document.getElementById('perm_value').value);
        var limit = parseFloat(document.getElementById('perm_limit').value);
        
        if (isNaN(value) || isNaN(limit) || limit <= 0) return;
        
        var pct = (value / limit * 100);
        var color = '#4ade80'; // green
        var borderColor = '#22c55e';
        
        if (pct >= 95) {
            color = '#ef4444';
            borderColor = '#dc2626';
        } else if (pct >= 80) {
            color = '#fbbf24';
            borderColor = '#f59e0b';
        }
        
        var display = value.toFixed(1) + ' (' + pct.toFixed(0) + '%)';
        var card = document.getElementById('perm_' + param);
        if (card) {
            card.innerHTML = display;
            card.style.color = color;
            card.parentElement.style.borderLeftColor = borderColor;
        }
        
        // Save to localStorage
        try {
            var permits = JSON.parse(localStorage.getItem('ww_permits') || '{}');
            permits[param] = { value: value, limit: limit, date: new Date().toISOString() };
            localStorage.setItem('ww_permits', JSON.stringify(permits));
        } catch(e) {}
    }
    
    function loadPermitData() {
        try {
            var permits = JSON.parse(localStorage.getItem('ww_permits') || '{}');
            ['bod', 'tss', 'nh3', 'ecoli'].forEach(function(param) {
                if (permits[param]) {
                    var p = permits[param];
                    var pct = (p.value / p.limit * 100);
                    var color = pct >= 95 ? '#ef4444' : (pct >= 80 ? '#fbbf24' : '#4ade80');
                    var borderColor = pct >= 95 ? '#dc2626' : (pct >= 80 ? '#f59e0b' : '#22c55e');
                    var card = document.getElementById('perm_' + param);
                    if (card) {
                        card.innerHTML = p.value.toFixed(1) + ' (' + pct.toFixed(0) + '%)';
                        card.style.color = color;
                        card.parentElement.style.borderLeftColor = borderColor;
                    }
                }
            });
        } catch(e) {}
    }
    
    // 93. Inspection Checklist
    function updateInspProgress() {
        var checks = document.querySelectorAll('#inspChecklist input[type="checkbox"]');
        var total = checks.length;
        var checked = 0;
        checks.forEach(function(c) { if (c.checked) checked++; });
        
        var pct = Math.round(checked / total * 100);
        document.getElementById('inspProgress').textContent = pct + '%';
        document.getElementById('inspBar').style.width = pct + '%';
        
        // Save state
        var state = [];
        checks.forEach(function(c, i) { state.push(c.checked ? 1 : 0); });
        try { localStorage.setItem('ww_insp_checklist', JSON.stringify(state)); } catch(e) {}
    }
    
    function loadInspChecklist() {
        try {
            var state = JSON.parse(localStorage.getItem('ww_insp_checklist') || '[]');
            var checks = document.querySelectorAll('#inspChecklist input[type="checkbox"]');
            checks.forEach(function(c, i) {
                if (state[i]) c.checked = true;
            });
            updateInspProgress();
        } catch(e) {}
    }
    
    function resetInspChecklist() {
        var checks = document.querySelectorAll('#inspChecklist input[type="checkbox"]');
        checks.forEach(function(c) { c.checked = false; });
        updateInspProgress();
        try { localStorage.removeItem('ww_insp_checklist'); } catch(e) {}
    }
    
    // 94. Geometric Mean Calculator
    function calcGeoMean() {
        var valuesText = document.getElementById('geo_values').value;
        var limit = parseFloat(document.getElementById('geo_limit').value) || 126;
        var ssm = parseFloat(document.getElementById('geo_ssm').value) || 399;
        
        // Parse values
        var values = valuesText.split(/[,\n\s]+/).map(function(v) {
            return parseFloat(v.trim());
        }).filter(function(v) {
            return !isNaN(v) && v > 0;
        });
        
        if (values.length === 0) {
            document.getElementById('geo_res').innerHTML = 'â€”';
            document.getElementById('geo_status').innerHTML = 'Enter E. coli values...';
            return;
        }
        
        // Calculate geometric mean using log method
        var sumLn = values.reduce(function(a, v) { return a + Math.log(v); }, 0);
        var geoMean = Math.exp(sumLn / values.length);
        
        // Find max for single sample check
        var max = Math.max.apply(null, values);
        
        // Status checks
        var geoStatus = '', ssmStatus = '';
        var geoColor = '#4ade80';
        
        if (geoMean > limit) {
            geoStatus = ' <span style="color:#ef4444;">âš ï¸ EXCEEDS LIMIT</span>';
            geoColor = '#ef4444';
        } else if (geoMean > limit * 0.9) {
            geoStatus = ' <span style="color:#f59e0b;">(approaching limit)</span>';
            geoColor = '#fbbf24';
        } else {
            geoStatus = ' <span style="color:#22c55e;">âœ“ OK</span>';
        }
        
        if (max > ssm) {
            ssmStatus = ' <span style="color:#ef4444;">âš ï¸ SSM EXCEEDED</span>';
        } else {
            ssmStatus = ' <span style="color:#22c55e;">âœ“</span>';
        }
        
        var res = 'ðŸ“Š <b>Geometric Mean:</b> <span style="color:' + geoColor + '">' + geoMean.toFixed(0) + '</span> MPN/100mL' + geoStatus +
                  '<br>ðŸ“ˆ <b>Single Sample Max:</b> ' + max.toFixed(0) + ssmStatus +
                  '<br>ðŸ“… <b>Sample Count:</b> ' + values.length +
                  '<br>ðŸ“‹ <b>Limit:</b> ' + limit + ' (geo) / ' + ssm + ' (SSM)';
        
        document.getElementById('geo_res').innerHTML = res;
        document.getElementById('geo_status').innerHTML = 'Geometric mean calculated';
        document.getElementById('geo_status').style.color = '#4ade80';
    }

    // ==================== ONBOARDING TOUR ====================
    var currentTourStep = 1;
    var totalTourSteps = 6;
    
    function startTour() {
        currentTourStep = 1;
        updateTourStep();
        document.getElementById('tourOverlay').classList.add('active');
        localStorage.setItem('ww_tour_seen', 'true');
    }
    
    function closeTour() {
        document.getElementById('tourOverlay').classList.remove('active');
    }
    
    function nextTourStep() {
        if (currentTourStep < totalTourSteps) {
            currentTourStep++;
            updateTourStep();
        } else {
            closeTour();
        }
    }
    
    function prevTourStep() {
        if (currentTourStep > 1) {
            currentTourStep--;
            updateTourStep();
        }
    }
    
    function updateTourStep() {
        // Update step visibility
        document.querySelectorAll('.tour-step').forEach(function(step) {
            step.classList.remove('active');
            if (parseInt(step.dataset.step) === currentTourStep) {
                step.classList.add('active');
            }
        });
        
        // Update progress dots
        document.querySelectorAll('.tour-dot').forEach(function(dot) {
            dot.classList.remove('active');
            if (parseInt(dot.dataset.step) === currentTourStep) {
                dot.classList.add('active');
            }
        });
        
        // Update buttons
        var prevBtn = document.getElementById('tourPrev');
        var nextBtn = document.getElementById('tourNext');
        
        prevBtn.style.display = currentTourStep > 1 ? 'inline-block' : 'none';
        nextBtn.textContent = currentTourStep === totalTourSteps ? 'Get Started! ðŸš€' : 'Next â†’';
    }
    
    function checkFirstVisit() {
        var tourSeen = localStorage.getItem('ww_tour_seen');
        if (!tourSeen) {
            // First visit - show tour after a short delay
            setTimeout(function() {
                startTour();
            }, 1500);
        }
    }
    
    // ==================== HELP MENU ====================
    function openHelpMenu() {
        document.getElementById('helpOverlay').classList.add('active');
    }
    
    function closeHelp() {
        document.getElementById('helpOverlay').classList.remove('active');
    }
    
    // ==================== PERFORMANCE: LAZY LOADING ====================
    var lazyObserver = null;
    
    function initLazyLoading() {
        if (!('IntersectionObserver' in window)) return;
        
        lazyObserver = new IntersectionObserver(function(entries) {
            entries.forEach(function(entry) {
                if (entry.isIntersecting) {
                    var card = entry.target;
                    card.classList.add('lazy-loaded');
                    lazyObserver.unobserve(card);
                }
            });
        }, { rootMargin: '100px', threshold: 0.01 });
        
        // Observe all cards except first 10
        var cards = document.querySelectorAll('.card');
        cards.forEach(function(card, i) {
            if (i < 10) {
                card.classList.add('lazy-loaded');
            } else {
                lazyObserver.observe(card);
            }
        });
    }
    
    // ==================== PERFORMANCE: INDEXEDDB ====================
    var wwDB = null;
    var DB_NAME = 'WWProCalcDB';
    var DB_VERSION = 1;
    
    function initIndexedDB() {
        return new Promise(function(resolve, reject) {
            if (!('indexedDB' in window)) {
                console.log('IndexedDB not supported, using localStorage');
                resolve(null);
                return;
            }
            
            var request = indexedDB.open(DB_NAME, DB_VERSION);
            
            request.onerror = function() {
                console.log('IndexedDB error, falling back to localStorage');
                resolve(null);
            };
            
            request.onsuccess = function(e) {
                wwDB = e.target.result;
                console.log('IndexedDB ready');
                resolve(wwDB);
            };
            
            request.onupgradeneeded = function(e) {
                var db = e.target.result;
                
                // Scenarios store
                if (!db.objectStoreNames.contains('scenarios')) {
                    var scenarioStore = db.createObjectStore('scenarios', { keyPath: 'id' });
                    scenarioStore.createIndex('name', 'name', { unique: false });
                    scenarioStore.createIndex('date', 'date', { unique: false });
                }
                
                // Trending data store
                if (!db.objectStoreNames.contains('trendingData')) {
                    var trendStore = db.createObjectStore('trendingData', { keyPath: 'id', autoIncrement: true });
                    trendStore.createIndex('date', 'date', { unique: false });
                    trendStore.createIndex('type', 'type', { unique: false });
                }
                
                // Exam progress store
                if (!db.objectStoreNames.contains('examProgress')) {
                    db.createObjectStore('examProgress', { keyPath: 'id' });
                }
            };
        });
    }
    
    // IndexedDB helpers
    function dbPut(storeName, data) {
        return new Promise(function(resolve, reject) {
            if (!wwDB) {
                // Fallback to localStorage
                try {
                    var key = 'ww_' + storeName;
                    var existing = JSON.parse(localStorage.getItem(key) || '[]');
                    if (Array.isArray(existing)) {
                        var idx = existing.findIndex(function(item) { return item.id === data.id; });
                        if (idx >= 0) existing[idx] = data;
                        else existing.push(data);
                        localStorage.setItem(key, JSON.stringify(existing));
                    }
                    resolve(data);
                } catch(e) { reject(e); }
                return;
            }
            
            var tx = wwDB.transaction(storeName, 'readwrite');
            var store = tx.objectStore(storeName);
            var req = store.put(data);
            req.onsuccess = function() { resolve(data); };
            req.onerror = function() { reject(req.error); };
        });
    }
    
    function dbGet(storeName, id) {
        return new Promise(function(resolve, reject) {
            if (!wwDB) {
                try {
                    var key = 'ww_' + storeName;
                    var existing = JSON.parse(localStorage.getItem(key) || '[]');
                    var item = existing.find(function(i) { return i.id === id; });
                    resolve(item || null);
                } catch(e) { reject(e); }
                return;
            }
            
            var tx = wwDB.transaction(storeName, 'readonly');
            var store = tx.objectStore(storeName);
            var req = store.get(id);
            req.onsuccess = function() { resolve(req.result); };
            req.onerror = function() { reject(req.error); };
        });
    }
    
    function dbGetAll(storeName) {
        return new Promise(function(resolve, reject) {
            if (!wwDB) {
                try {
                    var key = 'ww_' + storeName;
                    var existing = JSON.parse(localStorage.getItem(key) || '[]');
                    resolve(existing);
                } catch(e) { reject(e); }
                return;
            }
            
            var tx = wwDB.transaction(storeName, 'readonly');
            var store = tx.objectStore(storeName);
            var req = store.getAll();
            req.onsuccess = function() { resolve(req.result || []); };
            req.onerror = function() { reject(req.error); };
        });
    }
    
    function dbDelete(storeName, id) {
        return new Promise(function(resolve, reject) {
            if (!wwDB) {
                try {
                    var key = 'ww_' + storeName;
                    var existing = JSON.parse(localStorage.getItem(key) || '[]');
                    existing = existing.filter(function(i) { return i.id !== id; });
                    localStorage.setItem(key, JSON.stringify(existing));
                    resolve(true);
                } catch(e) { reject(e); }
                return;
            }
            
            var tx = wwDB.transaction(storeName, 'readwrite');
            var store = tx.objectStore(storeName);
            var req = store.delete(id);
            req.onsuccess = function() { resolve(true); };
            req.onerror = function() { reject(req.error); };
        });
    }
    
    // ==================== PERFORMANCE: OFFLINE DETECTION ====================
    var isOnline = navigator.onLine;
    
    function updateOnlineStatus() {
        isOnline = navigator.onLine;
        var indicator = document.getElementById('offlineIndicator');
        if (indicator) {
            indicator.style.display = isOnline ? 'none' : 'flex';
        }
    }
    
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    
    // ==================== PERFORMANCE: DEBOUNCE/THROTTLE ====================
    function debounce(func, wait) {
        var timeout;
        return function() {
            var context = this, args = arguments;
            clearTimeout(timeout);
            timeout = setTimeout(function() { func.apply(context, args); }, wait);
        };
    }
    
    function throttle(func, limit) {
        var inThrottle;
        return function() {
            var context = this, args = arguments;
            if (!inThrottle) {
                func.apply(context, args);
                inThrottle = true;
                setTimeout(function() { inThrottle = false; }, limit);
            }
        };
    }
    
    // Optimized scroll handler
    var optimizedScroll = throttle(handleScroll, 100);
    window.removeEventListener('scroll', handleScroll);
    window.addEventListener('scroll', optimizedScroll, { passive: true });
    
    // ==================== PERFORMANCE: REQUEST IDLE CALLBACK ====================
    var idleCallbackQueue = [];
    
    function scheduleIdleTask(task) {
        if ('requestIdleCallback' in window) {
            requestIdleCallback(task, { timeout: 2000 });
        } else {
            setTimeout(task, 100);
        }
    }
    
    // ==================== PERFORMANCE: MEMORY CLEANUP ====================
    function cleanupOldData() {
        scheduleIdleTask(function() {
            // Clean old trending data (keep last 90 days)
            var cutoff = Date.now() - (90 * 24 * 60 * 60 * 1000);
            
            ['trendSVI', 'trendFM', 'trendMBR'].forEach(function(key) {
                try {
                    var data = JSON.parse(localStorage.getItem(key) || '[]');
                    if (data.length > 100) {
                        data = data.filter(function(item) {
                            return new Date(item.date).getTime() > cutoff;
                        }).slice(-100);
                        localStorage.setItem(key, JSON.stringify(data));
                    }
                } catch(e) {}
            });
            
            console.log('Memory cleanup complete');
        });
    }
    
    // ==================== INIT ====================
    window.addEventListener('load', () => {
        // Core init
        restoreData();
        updateNav();
        checkWhatsNew();
        loadFavorites();
        initFavStars();
        initCrossRefs();
        initJSGuides();
        loadTheme();
        loadUnits();
        
        // Performance init
        initLazyLoading();
        initIndexedDB().then(function() {
            console.log('Database initialized');
        });
        updateOnlineStatus();
        
        // Deferred cleanup
        scheduleIdleTask(cleanupOldData);
        
        // Check for first visit (show tour)
        checkFirstVisit();
        
        // TCEQ Tools init
        loadPermitData();
        loadInspChecklist();
    });
    
    // ==================== SERVICE WORKER REGISTRATION ====================
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            // Create inline service worker
            var swCode = `
                var CACHE_NAME = 'ww-pro-calc-v9.14';
                var urlsToCache = [self.location.href];
                
                self.addEventListener('install', function(e) {
                    e.waitUntil(
                        caches.open(CACHE_NAME).then(function(cache) {
                            return cache.addAll(urlsToCache);
                        })
                    );
                    self.skipWaiting();
                });
                
                self.addEventListener('activate', function(e) {
                    e.waitUntil(
                        caches.keys().then(function(names) {
                            return Promise.all(
                                names.filter(function(name) {
                                    return name !== CACHE_NAME;
                                }).map(function(name) {
                                    return caches.delete(name);
                                })
                            );
                        })
                    );
                    self.clients.claim();
                });
                
                self.addEventListener('fetch', function(e) {
                    e.respondWith(
                        caches.match(e.request).then(function(response) {
                            if (response) return response;
                            return fetch(e.request).then(function(response) {
                                if (!response || response.status !== 200) return response;
                                var responseClone = response.clone();
                                caches.open(CACHE_NAME).then(function(cache) {
                                    cache.put(e.request, responseClone);
                                });
                                return response;
                            }).catch(function() {
                                return caches.match(self.location.href);
                            });
                        })
                    );
                });
            `;
            
            var blob = new Blob([swCode], { type: 'application/javascript' });
            var swUrl = URL.createObjectURL(blob);
            
            navigator.serviceWorker.register(swUrl, { scope: './' }).then(function(reg) {
                console.log('Service Worker registered');
            }).catch(function(err) {
                console.log('SW registration failed (expected in some contexts):', err.message);
            });
        });
    }
</script>
</body>
</html>
