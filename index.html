<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="description" content="Essential wastewater treatment calculations for operators">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="WW Pro-Calc">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>WW Operator Pro-Calc</title>
    <style>
        :root {
            --bg: #0f172a; --card: #1e293b; --text: #f8fafc;
            --primary: #3b82f6; --accent: #f59e0b; --danger: #ef4444;
            --success: #10b981; --card-header: #334155;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            padding: 15px; 
            padding-top: env(safe-area-inset-top, 15px);
            padding-bottom: calc(80px + env(safe-area-inset-bottom, 15px));
            margin: 0; 
            min-height: 100vh;
        }
        .container { max-width: 600px; margin: auto; }
        
        /* Header */
        header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px;
            position: sticky;
            top: 0;
            background: var(--bg);
            padding: 10px 0;
            z-index: 100;
        }
        h1 { font-size: 1.3rem; color: var(--primary); margin: 0; }
        .offline-badge {
            background: var(--success);
            color: white;
            font-size: 0.65rem;
            padding: 3px 6px;
            border-radius: 4px;
            margin-left: 8px;
        }
        .btn-clear { 
            background: var(--danger); 
            color: white; 
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
        }

        /* Accordion Cards */
        .card { 
            background: var(--card); 
            border-radius: 12px; 
            margin-bottom: 10px; 
            border-left: 4px solid var(--primary); 
            overflow: hidden;
        }
        .card.accent { border-left-color: var(--accent); }
        .card.success { border-left-color: var(--success); }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 18px;
            background: var(--card-header);
            cursor: pointer;
            user-select: none;
        }
        .card-header:active { background: #3d4a5c; }
        .card-header h2 { 
            font-size: 1rem; 
            margin: 0; 
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card-num {
            background: var(--primary);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            flex-shrink: 0;
        }
        .card.accent .card-num { background: var(--accent); }
        .card.success .card-num { background: var(--success); }
        
        .chevron {
            width: 20px;
            height: 20px;
            transition: transform 0.3s ease;
            color: #94a3b8;
            flex-shrink: 0;
        }
        .card.open .chevron { transform: rotate(180deg); }
        
        .card-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .card.open .card-body { max-height: 1000px; }
        .card-content { padding: 18px; padding-top: 10px; }

        /* Form Elements */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        label { font-size: 0.8rem; color: #94a3b8; display: block; margin-bottom: 4px; }
        input { 
            width: 100%; 
            padding: 12px; 
            border-radius: 6px; 
            border: 2px solid #334155; 
            background: #0f172a; 
            color: white; 
            box-sizing: border-box; 
            font-size: 16px;
            transition: border-color 0.2s;
        }
        input:focus { outline: none; border-color: var(--primary); }
        input.error { border-color: var(--danger); animation: shake 0.3s; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .field-hint { font-size: 0.7rem; color: #64748b; display: block; margin-top: 3px; }
        .field-hint.error { color: var(--danger); font-weight: bold; }
        
        .input-help { 
            font-size: 0.8rem; 
            color: #94a3b8; 
            margin-bottom: 12px; 
            padding: 8px; 
            background: rgba(59, 130, 246, 0.1); 
            border-radius: 6px; 
            border-left: 3px solid var(--primary); 
        }
        .example-box { 
            font-size: 0.75rem; 
            color: #94a3b8; 
            margin: 10px 0; 
            padding: 8px; 
            background: rgba(245, 158, 11, 0.1); 
            border-radius: 6px; 
            border-left: 3px solid var(--accent); 
        }

        /* Results */
        .result-box { 
            background: #334155; 
            padding: 15px; 
            border-radius: 8px; 
            text-align: center; 
        }
        .val { display: block; font-size: 1.5rem; font-weight: bold; color: var(--accent); }
        .status { 
            font-size: 0.85rem; 
            margin-top: 8px; 
            color: #cbd5e1; 
            line-height: 1.4; 
            text-align: left; 
            padding: 0 5px; 
        }
        .btn-copy { 
            background: var(--primary); 
            color: white; 
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-top: 10px;
            cursor: pointer;
        }
        .btn-copy:active { background: #2563eb; }
        .formula-note { 
            font-size: 0.7rem; 
            color: #64748b; 
            margin-top: 10px; 
            text-align: center; 
            font-style: italic; 
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card);
            border-top: 1px solid #334155;
            padding: 6px 0;
            padding-bottom: calc(6px + env(safe-area-inset-bottom, 0px));
            z-index: 1000;
        }
        .nav-scroll {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            padding: 0 5px;
            gap: 2px;
        }
        .nav-scroll::-webkit-scrollbar { display: none; }
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            background: none;
            border: none;
            color: #64748b;
            font-size: 0.55rem;
            padding: 4px 6px;
            border-radius: 8px;
            cursor: pointer;
            min-width: 42px;
            flex-shrink: 0;
            scroll-snap-align: start;
        }
        .nav-btn:active, .nav-btn.active { 
            color: var(--primary); 
            background: rgba(59, 130, 246, 0.1);
        }
        .nav-icon {
            width: 18px;
            height: 18px;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #334155;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 0.9rem;
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }

        /* Install Prompt */
        .install-prompt {
            display: none;
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            font-size: 0.85rem;
            align-items: center;
            gap: 10px;
        }
        .install-prompt button { 
            background: white; 
            color: var(--primary); 
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-weight: bold;
            cursor: pointer;
        }

        .version { 
            font-size: 0.7rem; 
            color: #475569; 
            text-align: center; 
            padding: 15px 0; 
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <div style="display: flex; align-items: center;">
            <h1>WW Pro-Calc</h1>
            <span class="offline-badge" id="offlineBadge" style="display:none;">‚úì Offline</span>
        </div>
        <button class="btn-clear" onclick="clearAll()">Clear All</button>
    </header>

    <!-- 1. Pounds Formula -->
    <div class="card open" id="card1" data-calc="pounds">
        <div class="card-header" onclick="toggleCard(1)">
            <h2><span class="card-num">1</span> Pounds Formula</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Convert concentration to mass loading. Use for BOD, TSS, ammonia, phosphorus.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="p_flow" oninput="calcPounds()" placeholder="1.5">
                        <span class="field-hint">Million gallons per day</span>
                    </div>
                    <div>
                        <label>Concentration (mg/L)</label>
                        <input type="number" inputmode="decimal" id="p_conc" oninput="calcPounds()" placeholder="200">
                        <span class="field-hint">Lab result</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="p_res">0.00 lbs/day</span>
                    <div id="p_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('p_res')">Copy Result</button>
                </div>
                <div class="formula-note">Flow √ó Conc √ó 8.34</div>
            </div>
        </div>
    </div>

    <!-- 2. SVI -->
    <div class="card" id="card2" data-calc="svi">
        <div class="card-header" onclick="toggleCard(2)">
            <h2><span class="card-num">2</span> SVI ‚Äì Sludge Volume Index</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Measures sludge settleability. Perform 30-min settleometer test.</div>
                <div class="grid">
                    <div>
                        <label>30-min Settled (mL/L)</label>
                        <input type="number" inputmode="decimal" id="svi_set" oninput="calcSVI()" placeholder="250">
                        <span class="field-hint" id="svi_set_hint">Max 1000 mL/L</span>
                    </div>
                    <div>
                        <label>MLSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="svi_mlss" oninput="calcSVI()" placeholder="2500">
                        <span class="field-hint">From lab</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="svi_res">0.00 mL/g</span>
                    <div id="svi_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('svi_res')">Copy Result</button>
                </div>
                <div class="formula-note">(Settled Vol √ó 1000) √∑ MLSS</div>
            </div>
        </div>
    </div>

    <!-- 3. Mass Balance -->
    <div class="card accent" id="card3" data-calc="mass">
        <div class="card-header" onclick="toggleCard(3)">
            <h2><span class="card-num">3</span> Mass Balance</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Calculate mixed concentration when two flows combine (RAS + Influent, blending).</div>
                <div class="grid">
                    <div>
                        <label>Stream A ‚Äì Flow</label>
                        <input type="number" inputmode="decimal" id="mb_qa" oninput="calcMB()" placeholder="1.0">
                        <span class="field-hint">Any flow unit</span>
                    </div>
                    <div>
                        <label>Stream A ‚Äì Conc</label>
                        <input type="number" inputmode="decimal" id="mb_ca" oninput="calcMB()" placeholder="200">
                        <span class="field-hint">mg/L</span>
                    </div>
                    <div>
                        <label>Stream B ‚Äì Flow</label>
                        <input type="number" inputmode="decimal" id="mb_qb" oninput="calcMB()" placeholder="0.5">
                        <span class="field-hint">Same unit as A</span>
                    </div>
                    <div>
                        <label>Stream B ‚Äì Conc</label>
                        <input type="number" inputmode="decimal" id="mb_cb" oninput="calcMB()" placeholder="8000">
                        <span class="field-hint">mg/L</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="mb_res">0.00 mg/L</span>
                    <div id="mb_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('mb_res')">Copy Result</button>
                </div>
                <div class="formula-note">(Q‚ÇÅ√óC‚ÇÅ + Q‚ÇÇ√óC‚ÇÇ) √∑ (Q‚ÇÅ + Q‚ÇÇ)</div>
            </div>
        </div>
    </div>

    <!-- 4. F/M Ratio -->
    <div class="card success" id="card4" data-calc="fm">
        <div class="card-header" onclick="toggleCard(4)">
            <h2><span class="card-num">4</span> F/M Ratio</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Food to Microorganism ratio. Key process control parameter.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="fm_flow" oninput="calcFM()" placeholder="1.5">
                        <span class="field-hint">Influent flow</span>
                    </div>
                    <div>
                        <label>BOD (mg/L)</label>
                        <input type="number" inputmode="decimal" id="fm_bod" oninput="calcFM()" placeholder="200">
                        <span class="field-hint">Influent BOD‚ÇÖ</span>
                    </div>
                    <div>
                        <label>Aeration Vol (MG)</label>
                        <input type="number" inputmode="decimal" id="fm_vol" oninput="calcFM()" placeholder="0.5">
                        <span class="field-hint">Million gallons</span>
                    </div>
                    <div>
                        <label>MLVSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="fm_mlvss" oninput="calcFM()" placeholder="2000">
                        <span class="field-hint">Or MLSS √ó 0.75</span>
                    </div>
                </div>
                <div class="example-box"><b>Tip:</b> MLVSS ‚âà MLSS √ó 0.75 if not measured directly</div>
                <div class="result-box">
                    <span class="val" id="fm_res">0.000</span>
                    <div id="fm_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('fm_res')">Copy Result</button>
                </div>
                <div class="formula-note">(Flow √ó BOD √ó 8.34) √∑ (Vol √ó MLVSS √ó 8.34)</div>
            </div>
        </div>
    </div>

    <!-- 5. SRT -->
    <div class="card success" id="card5" data-calc="srt">
        <div class="card-header" onclick="toggleCard(5)">
            <h2><span class="card-num">5</span> SRT ‚Äì Sludge Age</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Solids Retention Time. Critical for nitrification (need >8 days).</div>
                <div class="grid">
                    <div>
                        <label>Aeration Vol (MG)</label>
                        <input type="number" inputmode="decimal" id="srt_vol" oninput="calcSRT()" placeholder="0.5">
                        <span class="field-hint">Basin volume</span>
                    </div>
                    <div>
                        <label>MLSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="srt_mlss" oninput="calcSRT()" placeholder="3000">
                        <span class="field-hint">In aeration</span>
                    </div>
                    <div>
                        <label>WAS Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="srt_wasq" oninput="calcSRT()" placeholder="0.015">
                        <span class="field-hint">Waste sludge flow</span>
                    </div>
                    <div>
                        <label>WAS Conc (mg/L)</label>
                        <input type="number" inputmode="decimal" id="srt_wasc" oninput="calcSRT()" placeholder="8000">
                        <span class="field-hint">WAS or RAS conc</span>
                    </div>
                    <div>
                        <label>Effluent Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="srt_effq" oninput="calcSRT()" placeholder="1.5">
                        <span class="field-hint">Discharge flow</span>
                    </div>
                    <div>
                        <label>Effluent TSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="srt_effc" oninput="calcSRT()" placeholder="10">
                        <span class="field-hint">Solids over weirs</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="srt_res">0.0 days</span>
                    <div id="srt_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('srt_res')">Copy Result</button>
                </div>
                <div class="formula-note">Solids in System √∑ Solids Out per Day</div>
            </div>
        </div>
    </div>

    <!-- 6. Detention Time -->
    <div class="card success" id="card6" data-calc="dt">
        <div class="card-header" onclick="toggleCard(6)">
            <h2><span class="card-num">6</span> Detention Time</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Hydraulic retention time in any tank or process.</div>
                <div class="grid">
                    <div>
                        <label>Volume (gallons)</label>
                        <input type="number" inputmode="decimal" id="dt_vol" oninput="calcDT()" placeholder="500000">
                        <span class="field-hint">Tank volume</span>
                    </div>
                    <div>
                        <label>Flow (GPD)</label>
                        <input type="number" inputmode="decimal" id="dt_flow" oninput="calcDT()" placeholder="1500000">
                        <span class="field-hint">Gallons per day</span>
                    </div>
                </div>
                <div class="example-box"><b>Volume:</b> Rect = L√óW√óD√ó7.48 | Circ = 0.785√óD¬≤√óH√ó7.48</div>
                <div class="result-box">
                    <span class="val" id="dt_res">0.00 hours</span>
                    <div id="dt_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('dt_res')">Copy Result</button>
                </div>
                <div class="formula-note">(Volume √∑ Flow) √ó 24</div>
            </div>
        </div>
    </div>

    <!-- 7. Removal Efficiency -->
    <div class="card success" id="card7" data-calc="eff">
        <div class="card-header" onclick="toggleCard(7)">
            <h2><span class="card-num">7</span> Removal Efficiency</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Percent removal for BOD, TSS, ammonia, or any parameter.</div>
                <div class="grid">
                    <div>
                        <label>Influent (mg/L)</label>
                        <input type="number" inputmode="decimal" id="eff_in" oninput="calcEff()" placeholder="200">
                        <span class="field-hint">Before treatment</span>
                    </div>
                    <div>
                        <label>Effluent (mg/L)</label>
                        <input type="number" inputmode="decimal" id="eff_out" oninput="calcEff()" placeholder="15">
                        <span class="field-hint">After treatment</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="eff_res">0.0 %</span>
                    <div id="eff_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('eff_res')">Copy Result</button>
                </div>
                <div class="formula-note">(In - Out) √∑ In √ó 100</div>
            </div>
        </div>
    </div>

    <!-- 8. WAS Pumping Rate -->
    <div class="card" id="card8" data-calc="was">
        <div class="card-header" onclick="toggleCard(8)">
            <h2><span class="card-num">8</span> WAS Pumping Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Calculate required WAS flow to achieve target SRT. Solve for wasting rate.</div>
                <div class="grid">
                    <div>
                        <label>Aeration Vol (MG)</label>
                        <input type="number" inputmode="decimal" id="was_vol" oninput="calcWAS()" placeholder="0.5">
                        <span class="field-hint">Basin volume</span>
                    </div>
                    <div>
                        <label>MLSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="was_mlss" oninput="calcWAS()" placeholder="3000">
                        <span class="field-hint">In aeration</span>
                    </div>
                    <div>
                        <label>Target SRT (days)</label>
                        <input type="number" inputmode="decimal" id="was_srt" oninput="calcWAS()" placeholder="10">
                        <span class="field-hint">Desired sludge age</span>
                    </div>
                    <div>
                        <label>WAS Conc (mg/L)</label>
                        <input type="number" inputmode="decimal" id="was_conc" oninput="calcWAS()" placeholder="8000">
                        <span class="field-hint">WAS/RAS solids</span>
                    </div>
                </div>
                <div class="example-box"><b>Note:</b> This simplified calc ignores effluent TSS loss. For precise SRT, account for solids over weirs.</div>
                <div class="result-box">
                    <span class="val" id="was_res">0 GPD</span>
                    <div id="was_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('was_res')">Copy Result</button>
                </div>
                <div class="formula-note">WAS Flow = (Vol √ó MLSS) √∑ (SRT √ó WAS Conc)</div>
            </div>
        </div>
    </div>

    <!-- 9. RAS Return Rate -->
    <div class="card" id="card9" data-calc="ras">
        <div class="card-header" onclick="toggleCard(9)">
            <h2><span class="card-num">9</span> RAS Return Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Calculate RAS flow rate based on sludge blanket or settleability method.</div>
                <div class="grid">
                    <div>
                        <label>Influent Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="ras_flow" oninput="calcRAS()" placeholder="1.5">
                        <span class="field-hint">Plant flow</span>
                    </div>
                    <div>
                        <label>MLSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="ras_mlss" oninput="calcRAS()" placeholder="3000">
                        <span class="field-hint">In aeration</span>
                    </div>
                    <div>
                        <label>RAS Conc (mg/L)</label>
                        <input type="number" inputmode="decimal" id="ras_conc" oninput="calcRAS()" placeholder="8000">
                        <span class="field-hint">Return sludge TSS</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="ras_res">0.00 MGD</span>
                    <div id="ras_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('ras_res')">Copy Result</button>
                </div>
                <div class="formula-note">RAS = (Q √ó MLSS) √∑ (RAS Conc - MLSS)</div>
            </div>
        </div>
    </div>

    <!-- 10. Organic Loading Rate -->
    <div class="card accent" id="card10" data-calc="olr">
        <div class="card-header" onclick="toggleCard(10)">
            <h2><span class="card-num">10</span> Organic Loading Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">BOD loading per unit volume. Used for trickling filters, RBCs, and aeration basins.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="olr_flow" oninput="calcOLR()" placeholder="1.5">
                        <span class="field-hint">Influent flow</span>
                    </div>
                    <div>
                        <label>BOD (mg/L)</label>
                        <input type="number" inputmode="decimal" id="olr_bod" oninput="calcOLR()" placeholder="200">
                        <span class="field-hint">Influent BOD</span>
                    </div>
                    <div>
                        <label>Volume (1000 ft¬≥)</label>
                        <input type="number" inputmode="decimal" id="olr_vol" oninput="calcOLR()" placeholder="50">
                        <span class="field-hint">Media or basin volume</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="olr_res">0.0 lbs/day/1000ft¬≥</span>
                    <div id="olr_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('olr_res')">Copy Result</button>
                </div>
                <div class="formula-note">(Flow √ó BOD √ó 8.34) √∑ Volume in 1000 ft¬≥</div>
            </div>
        </div>
    </div>

    <!-- 11. Surface Overflow Rate -->
    <div class="card accent" id="card11" data-calc="sor">
        <div class="card-header" onclick="toggleCard(11)">
            <h2><span class="card-num">11</span> Surface Overflow Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Hydraulic loading rate for clarifiers. Flow per unit surface area.</div>
                <div class="grid">
                    <div>
                        <label>Flow (GPD)</label>
                        <input type="number" inputmode="decimal" id="sor_flow" oninput="calcSOR()" placeholder="1500000">
                        <span class="field-hint">Gallons per day</span>
                    </div>
                    <div>
                        <label>Surface Area (ft¬≤)</label>
                        <input type="number" inputmode="decimal" id="sor_area" oninput="calcSOR()" placeholder="3000">
                        <span class="field-hint">Clarifier surface area</span>
                    </div>
                </div>
                <div class="example-box"><b>Circular:</b> Area = 0.785 √ó D¬≤ | <b>Rectangular:</b> Area = L √ó W</div>
                <div class="result-box">
                    <span class="val" id="sor_res">0 GPD/ft¬≤</span>
                    <div id="sor_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('sor_res')">Copy Result</button>
                </div>
                <div class="formula-note">Flow (GPD) √∑ Surface Area (ft¬≤)</div>
            </div>
        </div>
    </div>

    <!-- 12. Weir Overflow Rate -->
    <div class="card accent" id="card12" data-calc="wor">
        <div class="card-header" onclick="toggleCard(12)">
            <h2><span class="card-num">12</span> Weir Overflow Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Flow per linear foot of weir. Important for clarifier performance.</div>
                <div class="grid">
                    <div>
                        <label>Flow (GPD)</label>
                        <input type="number" inputmode="decimal" id="wor_flow" oninput="calcWOR()" placeholder="1500000">
                        <span class="field-hint">Gallons per day</span>
                    </div>
                    <div>
                        <label>Weir Length (ft)</label>
                        <input type="number" inputmode="decimal" id="wor_len" oninput="calcWOR()" placeholder="150">
                        <span class="field-hint">Total weir length</span>
                    </div>
                </div>
                <div class="example-box"><b>Circular weir:</b> Length = œÄ √ó Diameter (3.14 √ó D)</div>
                <div class="result-box">
                    <span class="val" id="wor_res">0 GPD/ft</span>
                    <div id="wor_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('wor_res')">Copy Result</button>
                </div>
                <div class="formula-note">Flow (GPD) √∑ Weir Length (ft)</div>
            </div>
        </div>
    </div>

    <!-- 13. Solids Loading Rate -->
    <div class="card success" id="card13" data-calc="slr">
        <div class="card-header" onclick="toggleCard(13)">
            <h2><span class="card-num">13</span> Solids Loading Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Solids applied per unit clarifier area. Key for secondary clarifier design.</div>
                <div class="grid">
                    <div>
                        <label>Influent + RAS Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="slr_flow" oninput="calcSLR()" placeholder="2.0">
                        <span class="field-hint">Total flow to clarifier</span>
                    </div>
                    <div>
                        <label>MLSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="slr_mlss" oninput="calcSLR()" placeholder="3000">
                        <span class="field-hint">Mixed liquor solids</span>
                    </div>
                    <div>
                        <label>Surface Area (ft¬≤)</label>
                        <input type="number" inputmode="decimal" id="slr_area" oninput="calcSLR()" placeholder="3000">
                        <span class="field-hint">Clarifier area</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="slr_res">0.0 lbs/day/ft¬≤</span>
                    <div id="slr_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('slr_res')">Copy Result</button>
                </div>
                <div class="formula-note">(Flow √ó MLSS √ó 8.34) √∑ Surface Area</div>
            </div>
        </div>
    </div>

    <!-- 14. Chemical Dosing -->
    <div class="card success" id="card14" data-calc="chem">
        <div class="card-header" onclick="toggleCard(14)">
            <h2><span class="card-num">14</span> Chemical Dosing</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Calculate chemical feed rate. Works for chlorine, alum, polymer, lime, etc.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="chem_flow" oninput="calcChem()" placeholder="1.5">
                        <span class="field-hint">Treatment flow</span>
                    </div>
                    <div>
                        <label>Dose (mg/L)</label>
                        <input type="number" inputmode="decimal" id="chem_dose" oninput="calcChem()" placeholder="2.0">
                        <span class="field-hint">Target dosage</span>
                    </div>
                    <div>
                        <label>Chemical % Purity</label>
                        <input type="number" inputmode="decimal" id="chem_purity" oninput="calcChem()" placeholder="100">
                        <span class="field-hint">65% for HTH, 12% for bleach</span>
                    </div>
                </div>
                <div class="example-box"><b>Common:</b> Gas Cl‚ÇÇ = 100% | HTH = 65% | Bleach = 12% | Alum = 48%</div>
                <div class="result-box">
                    <span class="val" id="chem_res">0.00 lbs/day</span>
                    <div id="chem_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('chem_res')">Copy Result</button>
                </div>
                <div class="formula-note">(Flow √ó Dose √ó 8.34) √∑ (Purity √∑ 100)</div>
            </div>
        </div>
    </div>

    <div class="version">WW Pro-Calc v3.0 ‚Äì 14 Calculators</div>
</div>

<!-- Bottom Navigation -->
<nav class="bottom-nav">
    <div class="nav-scroll">
        <button class="nav-btn active" onclick="goToCard(1)" id="nav1">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 3v18M5 8l7-5 7 5M5 12h14"/>
            </svg>
            <span>Lbs</span>
        </button>
        <button class="nav-btn" onclick="goToCard(2)" id="nav2">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="4" y="4" width="16" height="16" rx="2"/><path d="M8 20V10M12 20V6M16 20V14"/>
            </svg>
            <span>SVI</span>
        </button>
        <button class="nav-btn" onclick="goToCard(3)" id="nav3">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="8" cy="12" r="4"/><circle cx="16" cy="12" r="4"/>
            </svg>
            <span>Mix</span>
        </button>
        <button class="nav-btn" onclick="goToCard(4)" id="nav4">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
            <span>F/M</span>
        </button>
        <button class="nav-btn" onclick="goToCard(5)" id="nav5">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="16" rx="2"/><path d="M8 2v4M16 2v4M3 10h18"/>
            </svg>
            <span>SRT</span>
        </button>
        <button class="nav-btn" onclick="goToCard(6)" id="nav6">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
            </svg>
            <span>DT</span>
        </button>
        <button class="nav-btn" onclick="goToCard(7)" id="nav7">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 3v18h18"/><path d="M7 16l4-8 4 4 5-9"/>
            </svg>
            <span>Eff%</span>
        </button>
        <button class="nav-btn" onclick="goToCard(8)" id="nav8">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2v20M2 12h20"/><circle cx="12" cy="12" r="3"/>
            </svg>
            <span>WAS</span>
        </button>
        <button class="nav-btn" onclick="goToCard(9)" id="nav9">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 12h16M4 12l4-4M4 12l4 4M20 12l-4-4M20 12l-4 4"/>
            </svg>
            <span>RAS</span>
        </button>
        <button class="nav-btn" onclick="goToCard(10)" id="nav10">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 3v18"/>
            </svg>
            <span>OLR</span>
        </button>
        <button class="nav-btn" onclick="goToCard(11)" id="nav11">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><path d="M2 12h20"/>
            </svg>
            <span>SOR</span>
        </button>
        <button class="nav-btn" onclick="goToCard(12)" id="nav12">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 4h16v4H4zM4 12h16"/><path d="M12 12v8"/>
            </svg>
            <span>WOR</span>
        </button>
        <button class="nav-btn" onclick="goToCard(13)" id="nav13">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="4" y="4" width="16" height="16" rx="2"/><path d="M4 14h16M9 4v16"/>
            </svg>
            <span>SLR</span>
        </button>
        <button class="nav-btn" onclick="goToCard(14)" id="nav14">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 3h6v6H9zM12 9v12M8 21h8"/>
            </svg>
            <span>Chem</span>
        </button>
    </div>
</nav>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Install Prompt -->
<div class="install-prompt" id="installPrompt">
    üì≤ Install App
    <button onclick="installApp()">Install</button>
    <button onclick="dismissInstall()" style="background:transparent;color:white;font-size:1.2rem;">√ó</button>
</div>

<script>
    // ==================== STATE ====================
    const STORAGE_KEY = 'wwProCalcData';
    let currentCard = 1;
    
    // All input IDs for saving/restoring
    const inputIds = [
        'p_flow', 'p_conc',
        'svi_set', 'svi_mlss',
        'mb_qa', 'mb_ca', 'mb_qb', 'mb_cb',
        'fm_flow', 'fm_bod', 'fm_vol', 'fm_mlvss',
        'srt_vol', 'srt_mlss', 'srt_wasq', 'srt_wasc', 'srt_effq', 'srt_effc',
        'dt_vol', 'dt_flow',
        'eff_in', 'eff_out',
        'was_vol', 'was_mlss', 'was_srt', 'was_conc',
        'ras_flow', 'ras_mlss', 'ras_conc',
        'olr_flow', 'olr_bod', 'olr_vol',
        'sor_flow', 'sor_area',
        'wor_flow', 'wor_len',
        'slr_flow', 'slr_mlss', 'slr_area',
        'chem_flow', 'chem_dose', 'chem_purity'
    ];

    // ==================== ACCORDION ====================
    function toggleCard(num) {
        const card = document.getElementById('card' + num);
        const wasOpen = card.classList.contains('open');
        
        // Close all cards
        document.querySelectorAll('.card').forEach(c => c.classList.remove('open'));
        
        // Open clicked card if it wasn't open
        if (!wasOpen) {
            card.classList.add('open');
            currentCard = num;
            updateNav();
            // Scroll to card
            setTimeout(() => {
                card.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }
        
        vibrate();
    }
    
    function goToCard(num) {
        const card = document.getElementById('card' + num);
        document.querySelectorAll('.card').forEach(c => c.classList.remove('open'));
        card.classList.add('open');
        currentCard = num;
        updateNav();
        card.scrollIntoView({ behavior: 'smooth', block: 'start' });
        vibrate();
    }
    
    function updateNav() {
        document.querySelectorAll('.nav-btn').forEach((btn, i) => {
            btn.classList.toggle('active', i + 1 === currentCard);
        });
    }

    // ==================== HAPTIC FEEDBACK ====================
    function vibrate() {
        if (navigator.vibrate) navigator.vibrate(10);
    }

    // ==================== TOAST ====================
    function showToast(message, type = '') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'toast show ' + type;
        setTimeout(() => toast.classList.remove('show'), 2000);
    }

    // ==================== COPY ====================
    function copyVal(id) {
        const text = document.getElementById(id).innerText;
        navigator.clipboard.writeText(text).then(() => {
            showToast('‚úì Copied: ' + text, 'success');
            vibrate();
        });
    }

    // ==================== CLEAR ALL ====================
    function clearAll() {
        if (confirm('Clear all values?')) {
            inputIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.value = '';
                    el.classList.remove('error');
                }
            });
            localStorage.removeItem(STORAGE_KEY);
            // Reset all results
            document.getElementById('p_res').innerText = '0.00 lbs/day';
            document.getElementById('svi_res').innerText = '0.00 mL/g';
            document.getElementById('mb_res').innerText = '0.00 mg/L';
            document.getElementById('fm_res').innerText = '0.000';
            document.getElementById('srt_res').innerText = '0.0 days';
            document.getElementById('dt_res').innerText = '0.00 hours';
            document.getElementById('eff_res').innerText = '0.0 %';
            document.getElementById('was_res').innerText = '0 GPD';
            document.getElementById('ras_res').innerText = '0.00 MGD';
            document.getElementById('olr_res').innerText = '0.0 lbs/day/1000ft¬≥';
            document.getElementById('sor_res').innerText = '0 GPD/ft¬≤';
            document.getElementById('wor_res').innerText = '0 GPD/ft';
            document.getElementById('slr_res').innerText = '0.0 lbs/day/ft¬≤';
            document.getElementById('chem_res').innerText = '0.00 lbs/day';
            // Reset statuses
            document.querySelectorAll('.status').forEach(s => {
                s.innerText = 'Enter data...';
                s.style.color = '#64748b';
            });
            // Reset hints
            document.querySelectorAll('.field-hint').forEach(h => h.classList.remove('error'));
            const sviHint = document.getElementById('svi_set_hint');
            if (sviHint) sviHint.textContent = 'Max 1000 mL/L';
            
            showToast('‚úì All cleared', 'success');
            vibrate();
        }
    }

    // ==================== SAVE/RESTORE ====================
    function saveData() {
        const data = {};
        inputIds.forEach(id => {
            const el = document.getElementById(id);
            if (el && el.value) data[id] = el.value;
        });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }
    
    function restoreData() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            const data = JSON.parse(saved);
            inputIds.forEach(id => {
                const el = document.getElementById(id);
                if (el && data[id]) el.value = data[id];
            });
            // Trigger all calculations
            calcPounds(); calcSVI(); calcMB(); calcFM(); calcSRT(); calcDT(); calcEff();
            calcWAS(); calcRAS(); calcOLR(); calcSOR(); calcWOR(); calcSLR(); calcChem();
        }
    }
    
    // Auto-save on input with debounce
    let saveTimeout;
    document.addEventListener('input', () => {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(saveData, 500);
    });

    // ==================== VALIDATION ====================
    function validateInput(inputId, value, min, max, defaultHint) {
        const input = document.getElementById(inputId);
        const hintEl = document.getElementById(inputId + '_hint');
        
        if (value > max) {
            input.classList.add('error');
            if (hintEl) {
                hintEl.classList.add('error');
                hintEl.textContent = '‚ö†Ô∏è Max is ' + max;
            }
            vibrate();
            return false;
        } else if (value < min) {
            input.classList.add('error');
            if (hintEl) {
                hintEl.classList.add('error');
                hintEl.textContent = '‚ö†Ô∏è Min is ' + min;
            }
            vibrate();
            return false;
        } else {
            input.classList.remove('error');
            if (hintEl) {
                hintEl.classList.remove('error');
                hintEl.textContent = defaultHint;
            }
            return true;
        }
    }

    // ==================== CALCULATIONS ====================
    
    // 1. Pounds Formula
    function calcPounds() {
        const f = parseFloat(document.getElementById('p_flow').value) || 0;
        const c = parseFloat(document.getElementById('p_conc').value) || 0;
        const res = f * c * 8.34;
        document.getElementById('p_res').innerText = res.toFixed(2) + " lbs/day";
        const stat = document.getElementById('p_status');
        if (f > 0 && c > 0) {
            stat.innerHTML = "üìä <b>" + (c * 8.34).toFixed(1) + " lbs per MG</b> at this concentration";
            stat.style.color = "#94a3b8";
        } else {
            stat.innerText = "Enter data...";
            stat.style.color = "#64748b";
        }
    }

    // 2. SVI with validation
    function calcSVI() {
        const s = parseFloat(document.getElementById('svi_set').value) || 0;
        const m = parseFloat(document.getElementById('svi_mlss').value) || 0;
        
        // Validate settled volume (max 1000 mL/L for a settleometer)
        const valid = validateInput('svi_set', s, 0, 1000, 'Max 1000 mL/L');
        
        if (m > 0 && valid) {
            const res = (s * 1000) / m;
            document.getElementById('svi_res').innerText = res.toFixed(2) + " mL/g";
            const stat = document.getElementById('svi_status');
            
            if (res > 250) { 
                stat.innerHTML = "üö® <b>Severe Bulking</b> ‚Äì Check for Nocardia/M. parvicella. Consider RAS chlorination, reduce SRT."; 
                stat.style.color = "var(--danger)"; 
            } else if (res > 150) { 
                stat.innerHTML = "‚ö†Ô∏è <b>Bulking Sludge</b> ‚Äì Review F/M, DO levels, nutrient balance. Increase wasting."; 
                stat.style.color = "var(--accent)"; 
            } else if (res < 50) { 
                stat.innerHTML = "‚ö° <b>Pin Floc/Dispersed</b> ‚Äì Old sludge or toxic shock. Reduce SRT."; 
                stat.style.color = "var(--accent)"; 
            } else if (res < 80) { 
                stat.innerHTML = "‚ö° <b>Fast Settling</b> ‚Äì Monitor for pin floc. May indicate over-wasting."; 
                stat.style.color = "var(--primary)"; 
            } else { 
                stat.innerHTML = "‚úì <b>Optimal (80-150)</b> ‚Äì Good floc formation. Maintain operations."; 
                stat.style.color = "#4ade80"; 
            }
        } else if (!valid) {
            document.getElementById('svi_status').innerHTML = "‚ö†Ô∏è <b>Check Input</b> ‚Äì Settled volume cannot exceed 1000 mL/L";
            document.getElementById('svi_status').style.color = "var(--danger)";
        }
    }

    // 3. Mass Balance
    function calcMB() {
        const qa = parseFloat(document.getElementById('mb_qa').value) || 0;
        const ca = parseFloat(document.getElementById('mb_ca').value) || 0;
        const qb = parseFloat(document.getElementById('mb_qb').value) || 0;
        const cb = parseFloat(document.getElementById('mb_cb').value) || 0;
        
        if ((qa + qb) > 0) {
            const res = ((qa * ca) + (qb * cb)) / (qa + qb);
            document.getElementById('mb_res').innerText = res.toFixed(2) + " mg/L";
            const stat = document.getElementById('mb_status');
            const ratioA = (qa / (qa + qb) * 100).toFixed(0);
            const ratioB = (qb / (qa + qb) * 100).toFixed(0);
            stat.innerHTML = "üìä <b>Flow Mix:</b> A = " + ratioA + "% | B = " + ratioB + "%";
            stat.style.color = "#94a3b8";
        }
    }

    // 4. F/M Ratio
    function calcFM() {
        const flow = parseFloat(document.getElementById('fm_flow').value) || 0;
        const bod = parseFloat(document.getElementById('fm_bod').value) || 0;
        const vol = parseFloat(document.getElementById('fm_vol').value) || 0;
        const mlvss = parseFloat(document.getElementById('fm_mlvss').value) || 0;
        
        if (vol > 0 && mlvss > 0) {
            const res = (flow * bod) / (vol * mlvss);
            document.getElementById('fm_res').innerText = res.toFixed(3);
            const stat = document.getElementById('fm_status');
            
            if (res < 0.02) { 
                stat.innerHTML = "üö® <b>Starvation</b> ‚Äì Bacteria consuming themselves. Reduce MLSS."; 
                stat.style.color = "var(--danger)"; 
            } else if (res < 0.05) { 
                stat.innerHTML = "‚ö†Ô∏è <b>Very Low</b> ‚Äì Watch for old sludge, denitrification in clarifier."; 
                stat.style.color = "var(--accent)"; 
            } else if (res <= 0.15) { 
                stat.innerHTML = "‚úì <b>Extended Aeration (0.05-0.15)</b> ‚Äì Good nitrification potential."; 
                stat.style.color = "#4ade80"; 
            } else if (res <= 0.5) { 
                stat.innerHTML = "‚úì <b>Conventional (0.15-0.5)</b> ‚Äì Standard activated sludge."; 
                stat.style.color = "#4ade80"; 
            } else if (res <= 1.0) { 
                stat.innerHTML = "‚ö° <b>High Rate (0.5-1.0)</b> ‚Äì Short SRT, high sludge yield."; 
                stat.style.color = "var(--accent)"; 
            } else { 
                stat.innerHTML = "üö® <b>Overloaded (>1.0)</b> ‚Äì BOD breakthrough risk. Increase MLSS."; 
                stat.style.color = "var(--danger)"; 
            }
        }
    }

    // 5. SRT
    function calcSRT() {
        const vol = parseFloat(document.getElementById('srt_vol').value) || 0;
        const mlss = parseFloat(document.getElementById('srt_mlss').value) || 0;
        const wasQ = parseFloat(document.getElementById('srt_wasq').value) || 0;
        const wasC = parseFloat(document.getElementById('srt_wasc').value) || 0;
        const effQ = parseFloat(document.getElementById('srt_effq').value) || 0;
        const effC = parseFloat(document.getElementById('srt_effc').value) || 0;
        
        const sludgeIn = vol * mlss * 8.34;
        const sludgeOut = (wasQ * wasC * 8.34) + (effQ * effC * 8.34);
        
        if (sludgeOut > 0) {
            const res = sludgeIn / sludgeOut;
            document.getElementById('srt_res').innerText = res.toFixed(1) + " days";
            const stat = document.getElementById('srt_status');
            
            if (res < 2) { 
                stat.innerHTML = "üö® <b>Washout Risk</b> ‚Äì Reduce WAS immediately!"; 
                stat.style.color = "var(--danger)"; 
            } else if (res < 4) { 
                stat.innerHTML = "‚ö†Ô∏è <b>Low (2-4 days)</b> ‚Äì Young sludge, limited nitrification."; 
                stat.style.color = "var(--accent)"; 
            } else if (res < 8) { 
                stat.innerHTML = "‚úì <b>Conventional (4-8 days)</b> ‚Äì Good BOD removal."; 
                stat.style.color = "#4ade80"; 
            } else if (res <= 15) { 
                stat.innerHTML = "‚úì <b>Extended (8-15 days)</b> ‚Äì Full nitrification, stable."; 
                stat.style.color = "#4ade80"; 
            } else if (res <= 25) { 
                stat.innerHTML = "‚ö° <b>Long (15-25 days)</b> ‚Äì Watch for old sludge issues."; 
                stat.style.color = "var(--primary)"; 
            } else { 
                stat.innerHTML = "‚ö†Ô∏è <b>Excessive (>25 days)</b> ‚Äì Increase wasting."; 
                stat.style.color = "var(--accent)"; 
            }
        }
    }

    // 6. Detention Time
    function calcDT() {
        const vol = parseFloat(document.getElementById('dt_vol').value) || 0;
        const flow = parseFloat(document.getElementById('dt_flow').value) || 0;
        
        if (flow > 0) {
            const res = (vol / flow) * 24;
            document.getElementById('dt_res').innerText = res.toFixed(2) + " hours";
            const stat = document.getElementById('dt_status');
            
            if (res < 2) { 
                stat.innerHTML = "‚ö° <b>Very Short (<2 hrs)</b> ‚Äì Contact tank or high-rate process."; 
                stat.style.color = "var(--accent)"; 
            } else if (res < 4) { 
                stat.innerHTML = "‚úì <b>Clarifier Range (2-4 hrs)</b> ‚Äì Typical for secondary clarifiers."; 
                stat.style.color = "#4ade80"; 
            } else if (res < 8) { 
                stat.innerHTML = "‚úì <b>Conventional (4-8 hrs)</b> ‚Äì Standard aeration basin."; 
                stat.style.color = "#4ade80"; 
            } else if (res <= 24) { 
                stat.innerHTML = "‚úì <b>Extended (8-24 hrs)</b> ‚Äì Good for nitrification."; 
                stat.style.color = "#4ade80"; 
            } else if (res <= 48) { 
                stat.innerHTML = "‚ö° <b>Long (24-48 hrs)</b> ‚Äì EQ basin or oxidation ditch."; 
                stat.style.color = "var(--primary)"; 
            } else { 
                stat.innerHTML = "‚ö†Ô∏è <b>Very Long (>48 hrs)</b> ‚Äì Lagoon range."; 
                stat.style.color = "var(--accent)"; 
            }
        }
    }

    // 7. Removal Efficiency
    function calcEff() {
        const inf = parseFloat(document.getElementById('eff_in').value) || 0;
        const eff = parseFloat(document.getElementById('eff_out').value) || 0;
        
        if (inf > 0) {
            const res = ((inf - eff) / inf) * 100;
            document.getElementById('eff_res').innerText = res.toFixed(1) + " %";
            const stat = document.getElementById('eff_status');
            
            if (res >= 95) { 
                stat.innerHTML = "üåü <b>Excellent (‚â•95%)</b> ‚Äì Outstanding performance."; 
                stat.style.color = "#4ade80"; 
            } else if (res >= 90) { 
                stat.innerHTML = "‚úì <b>Very Good (90-95%)</b> ‚Äì Exceeds most permits."; 
                stat.style.color = "#4ade80"; 
            } else if (res >= 85) { 
                stat.innerHTML = "‚úì <b>Good (85-90%)</b> ‚Äì Meeting standard goals."; 
                stat.style.color = "#4ade80"; 
            } else if (res >= 75) { 
                stat.innerHTML = "‚ö° <b>Moderate (75-85%)</b> ‚Äì Review for optimization."; 
                stat.style.color = "var(--accent)"; 
            } else if (res >= 50) { 
                stat.innerHTML = "‚ö†Ô∏è <b>Below Target (50-75%)</b> ‚Äì Investigate cause."; 
                stat.style.color = "var(--danger)"; 
            } else if (res >= 0) { 
                stat.innerHTML = "üö® <b>Poor (<50%)</b> ‚Äì Process upset likely."; 
                stat.style.color = "var(--danger)"; 
            } else { 
                stat.innerHTML = "üö® <b>Negative</b> ‚Äì Effluent worse than influent!"; 
                stat.style.color = "var(--danger)"; 
            }
        }
    }

    // 8. WAS Pumping Rate
    function calcWAS() {
        const vol = parseFloat(document.getElementById('was_vol').value) || 0;
        const mlss = parseFloat(document.getElementById('was_mlss').value) || 0;
        const srt = parseFloat(document.getElementById('was_srt').value) || 0;
        const conc = parseFloat(document.getElementById('was_conc').value) || 0;
        
        if (srt > 0 && conc > 0) {
            // WAS Flow (MG) = (Vol √ó MLSS) √∑ (SRT √ó WAS Conc)
            const wasMGD = (vol * mlss) / (srt * conc);
            const wasGPD = wasMGD * 1000000;
            document.getElementById('was_res').innerText = wasGPD.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPD";
            const stat = document.getElementById('was_status');
            const wasGPM = wasGPD / 1440;
            stat.innerHTML = "üìä <b>" + wasGPM.toFixed(1) + " GPM</b> continuous, or <b>" + (wasGPM * 2).toFixed(1) + " GPM</b> for 12 hrs/day";
            stat.style.color = "#94a3b8";
        }
    }

    // 9. RAS Return Rate
    function calcRAS() {
        const flow = parseFloat(document.getElementById('ras_flow').value) || 0;
        const mlss = parseFloat(document.getElementById('ras_mlss').value) || 0;
        const conc = parseFloat(document.getElementById('ras_conc').value) || 0;
        
        if (conc > mlss && conc > 0) {
            // RAS = (Q √ó MLSS) √∑ (RAS Conc - MLSS)
            const ras = (flow * mlss) / (conc - mlss);
            document.getElementById('ras_res').innerText = ras.toFixed(3) + " MGD";
            const stat = document.getElementById('ras_status');
            const ratio = (ras / flow * 100).toFixed(0);
            if (ratio < 25) {
                stat.innerHTML = "‚ö° <b>" + ratio + "% RAS Ratio</b> ‚Äì Low return rate. Verify blanket depth.";
                stat.style.color = "var(--accent)";
            } else if (ratio <= 100) {
                stat.innerHTML = "‚úì <b>" + ratio + "% RAS Ratio</b> ‚Äì Normal operating range (25-100%).";
                stat.style.color = "#4ade80";
            } else {
                stat.innerHTML = "‚ö†Ô∏è <b>" + ratio + "% RAS Ratio</b> ‚Äì High return. Check RAS concentration.";
                stat.style.color = "var(--accent)";
            }
        } else if (conc <= mlss && conc > 0) {
            document.getElementById('ras_status').innerHTML = "‚ö†Ô∏è <b>Check Values</b> ‚Äì RAS conc must be higher than MLSS";
            document.getElementById('ras_status').style.color = "var(--danger)";
        }
    }

    // 10. Organic Loading Rate
    function calcOLR() {
        const flow = parseFloat(document.getElementById('olr_flow').value) || 0;
        const bod = parseFloat(document.getElementById('olr_bod').value) || 0;
        const vol = parseFloat(document.getElementById('olr_vol').value) || 0;
        
        if (vol > 0) {
            // OLR = (Flow √ó BOD √ó 8.34) √∑ Volume (1000 ft¬≥)
            const olr = (flow * bod * 8.34) / vol;
            document.getElementById('olr_res').innerText = olr.toFixed(1) + " lbs/day/1000ft¬≥";
            const stat = document.getElementById('olr_status');
            
            if (olr < 5) {
                stat.innerHTML = "‚ö° <b>Low Rate (<5)</b> ‚Äì Under-loaded, may have operational issues.";
                stat.style.color = "var(--accent)";
            } else if (olr <= 25) {
                stat.innerHTML = "‚úì <b>Low-Rate TF (5-25)</b> ‚Äì Standard trickling filter range.";
                stat.style.color = "#4ade80";
            } else if (olr <= 100) {
                stat.innerHTML = "‚úì <b>High-Rate TF (25-100)</b> ‚Äì Higher loading, needs recirculation.";
                stat.style.color = "#4ade80";
            } else if (olr <= 300) {
                stat.innerHTML = "‚ö° <b>Roughing Filter (100-300)</b> ‚Äì Very high rate, partial treatment only.";
                stat.style.color = "var(--accent)";
            } else {
                stat.innerHTML = "‚ö†Ô∏è <b>Overloaded (>300)</b> ‚Äì Exceeds typical design limits.";
                stat.style.color = "var(--danger)";
            }
        }
    }

    // 11. Surface Overflow Rate
    function calcSOR() {
        const flow = parseFloat(document.getElementById('sor_flow').value) || 0;
        const area = parseFloat(document.getElementById('sor_area').value) || 0;
        
        if (area > 0) {
            const sor = flow / area;
            document.getElementById('sor_res').innerText = sor.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPD/ft¬≤";
            const stat = document.getElementById('sor_status');
            
            if (sor < 300) {
                stat.innerHTML = "‚ö° <b>Very Low (<300)</b> ‚Äì Under-utilized clarifier.";
                stat.style.color = "var(--primary)";
            } else if (sor <= 600) {
                stat.innerHTML = "‚úì <b>Primary Clarifier (300-600)</b> ‚Äì Good for primary settling.";
                stat.style.color = "#4ade80";
            } else if (sor <= 800) {
                stat.innerHTML = "‚úì <b>Secondary Clarifier (400-800)</b> ‚Äì Typical for activated sludge.";
                stat.style.color = "#4ade80";
            } else if (sor <= 1200) {
                stat.innerHTML = "‚ö†Ô∏è <b>High (800-1200)</b> ‚Äì Peak flow range. Monitor effluent TSS.";
                stat.style.color = "var(--accent)";
            } else {
                stat.innerHTML = "üö® <b>Overloaded (>1200)</b> ‚Äì Risk of solids carryover.";
                stat.style.color = "var(--danger)";
            }
        }
    }

    // 12. Weir Overflow Rate
    function calcWOR() {
        const flow = parseFloat(document.getElementById('wor_flow').value) || 0;
        const len = parseFloat(document.getElementById('wor_len').value) || 0;
        
        if (len > 0) {
            const wor = flow / len;
            document.getElementById('wor_res').innerText = wor.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPD/ft";
            const stat = document.getElementById('wor_status');
            
            if (wor <= 10000) {
                stat.innerHTML = "‚úì <b>Excellent (‚â§10,000)</b> ‚Äì Low turbulence, good settling.";
                stat.style.color = "#4ade80";
            } else if (wor <= 15000) {
                stat.innerHTML = "‚úì <b>Good (10,000-15,000)</b> ‚Äì Acceptable for most clarifiers.";
                stat.style.color = "#4ade80";
            } else if (wor <= 20000) {
                stat.innerHTML = "‚ö†Ô∏è <b>High (15,000-20,000)</b> ‚Äì May cause turbulence. Monitor TSS.";
                stat.style.color = "var(--accent)";
            } else {
                stat.innerHTML = "üö® <b>Excessive (>20,000)</b> ‚Äì Risk of floc disruption and carryover.";
                stat.style.color = "var(--danger)";
            }
        }
    }

    // 13. Solids Loading Rate
    function calcSLR() {
        const flow = parseFloat(document.getElementById('slr_flow').value) || 0;
        const mlss = parseFloat(document.getElementById('slr_mlss').value) || 0;
        const area = parseFloat(document.getElementById('slr_area').value) || 0;
        
        if (area > 0) {
            // SLR = (Flow √ó MLSS √ó 8.34) √∑ Area
            const slr = (flow * mlss * 8.34) / area;
            document.getElementById('slr_res').innerText = slr.toFixed(2) + " lbs/day/ft¬≤";
            const stat = document.getElementById('slr_status');
            
            if (slr < 10) {
                stat.innerHTML = "‚ö° <b>Low (<10)</b> ‚Äì Under-loaded clarifier. Good settling expected.";
                stat.style.color = "var(--primary)";
            } else if (slr <= 25) {
                stat.innerHTML = "‚úì <b>Normal (10-25)</b> ‚Äì Typical for secondary clarifiers.";
                stat.style.color = "#4ade80";
            } else if (slr <= 35) {
                stat.innerHTML = "‚ö†Ô∏è <b>High (25-35)</b> ‚Äì Peak flow range. Watch blanket depth.";
                stat.style.color = "var(--accent)";
            } else {
                stat.innerHTML = "üö® <b>Overloaded (>35)</b> ‚Äì Risk of solids loss. Reduce RAS or increase area.";
                stat.style.color = "var(--danger)";
            }
        }
    }

    // 14. Chemical Dosing
    function calcChem() {
        const flow = parseFloat(document.getElementById('chem_flow').value) || 0;
        const dose = parseFloat(document.getElementById('chem_dose').value) || 0;
        const purity = parseFloat(document.getElementById('chem_purity').value) || 100;
        
        if (purity > 0) {
            // lbs/day = (Flow √ó Dose √ó 8.34) √∑ (Purity/100)
            const lbs = (flow * dose * 8.34) / (purity / 100);
            document.getElementById('chem_res').innerText = lbs.toFixed(2) + " lbs/day";
            const stat = document.getElementById('chem_status');
            const gallons = lbs / 8.34; // Approximate for liquids
            stat.innerHTML = "üìä <b>" + lbs.toFixed(1) + " lbs/day</b> of chemical product | ~" + gallons.toFixed(1) + " gal/day if liquid";
            stat.style.color = "#94a3b8";
        }
    }

    // ==================== PWA ====================
    let deferredPrompt;
    
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(() => {
                    document.getElementById('offlineBadge').style.display = 'inline';
                })
                .catch(err => console.log('SW error:', err));
        });
    }

    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        document.getElementById('installPrompt').style.display = 'flex';
    });

    function installApp() {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then(() => {
                deferredPrompt = null;
                document.getElementById('installPrompt').style.display = 'none';
            });
        }
    }

    function dismissInstall() {
        document.getElementById('installPrompt').style.display = 'none';
    }

    // ==================== INIT ====================
    window.addEventListener('load', () => {
        restoreData();
        updateNav();
    });
</script>
</body>
</html>
