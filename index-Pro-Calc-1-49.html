<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="description" content="Essential wastewater treatment calculations for operators">
    <meta name="author" content="Armand Frazier Sr.">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="WW Pro-Calc">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>WW Operator Pro-Calc</title>
    <style>
        :root {
            --bg: #0f172a; --card: #1e293b; --text: #f8fafc;
            --primary: #3b82f6; --accent: #f59e0b; --danger: #ef4444;
            --success: #10b981; --card-header: #334155;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            padding: 15px; 
            padding-top: env(safe-area-inset-top, 15px);
            padding-bottom: calc(80px + env(safe-area-inset-bottom, 15px));
            margin: 0; 
            min-height: 100vh;
        }
        .container { max-width: 600px; margin: auto; }
        
        /* Header */
        header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px;
            position: sticky;
            top: 0;
            background: var(--bg);
            padding: 10px 0;
            z-index: 100;
        }
        h1 { font-size: 1.3rem; color: var(--primary); margin: 0; }
        .btn-clear { 
            background: var(--danger); 
            color: white; 
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
        }
        .btn-refresh {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
        }
        .btn-refresh:active { background: #1d4ed8; }

        /* Accordion Cards */
        .card { 
            background: var(--card); 
            border-radius: 12px; 
            margin-bottom: 10px; 
            border-left: 4px solid var(--primary); 
            overflow: hidden;
        }
        .card.accent { border-left-color: var(--accent); }
        .card.success { border-left-color: var(--success); }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 18px;
            background: var(--card-header);
            cursor: pointer;
            user-select: none;
        }
        .card-header:active { background: #3d4a5c; }
        .card-header h2 { 
            font-size: 1rem; 
            margin: 0; 
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card-num {
            background: var(--primary);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            flex-shrink: 0;
        }
        .card.accent .card-num { background: var(--accent); }
        .card.success .card-num { background: var(--success); }
        
        .chevron {
            width: 20px;
            height: 20px;
            transition: transform 0.3s ease;
            color: #94a3b8;
            flex-shrink: 0;
        }
        .card.open .chevron { transform: rotate(180deg); }
        
        .card-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .card.open .card-body { max-height: 1000px; }
        .card-content { padding: 18px; padding-top: 10px; }

        /* Form Elements */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        label { font-size: 0.8rem; color: #94a3b8; display: block; margin-bottom: 4px; }
        input { 
            width: 100%; 
            padding: 12px; 
            border-radius: 6px; 
            border: 2px solid #334155; 
            background: #0f172a; 
            color: white; 
            box-sizing: border-box; 
            font-size: 16px;
            transition: border-color 0.2s;
        }
        input:focus { outline: none; border-color: var(--primary); }
        input.error { border-color: var(--danger); animation: shake 0.3s; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .field-hint { font-size: 0.7rem; color: #64748b; display: block; margin-top: 3px; }
        .field-hint.error { color: var(--danger); font-weight: bold; }
        
        .input-help { 
            font-size: 0.8rem; 
            color: #94a3b8; 
            margin-bottom: 12px; 
            padding: 8px; 
            background: rgba(59, 130, 246, 0.1); 
            border-radius: 6px; 
            border-left: 3px solid var(--primary); 
        }
        .example-box { 
            font-size: 0.75rem; 
            color: #94a3b8; 
            margin: 10px 0; 
            padding: 8px; 
            background: rgba(245, 158, 11, 0.1); 
            border-radius: 6px; 
            border-left: 3px solid var(--accent); 
        }

        /* Results */
        .result-box { 
            background: #334155; 
            padding: 15px; 
            border-radius: 8px; 
            text-align: center; 
        }
        .val { display: block; font-size: 1.5rem; font-weight: bold; color: var(--accent); }
        .status { 
            font-size: 0.85rem; 
            margin-top: 8px; 
            color: #cbd5e1; 
            line-height: 1.4; 
            text-align: left; 
            padding: 0 5px; 
        }
        .btn-copy { 
            background: var(--primary); 
            color: white; 
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-top: 10px;
            cursor: pointer;
        }
        .btn-copy:active { background: #2563eb; }
        .formula-note { 
            font-size: 0.7rem; 
            color: #64748b; 
            margin-top: 10px; 
            text-align: center; 
            font-style: italic; 
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card);
            border-top: 1px solid #334155;
            padding: 6px 0;
            padding-bottom: calc(6px + env(safe-area-inset-bottom, 0px));
            z-index: 1000;
        }
        .nav-scroll {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            padding: 0 5px;
            gap: 2px;
        }
        .nav-scroll::-webkit-scrollbar { display: none; }
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            background: none;
            border: none;
            color: #64748b;
            font-size: 0.55rem;
            padding: 4px 6px;
            border-radius: 8px;
            cursor: pointer;
            min-width: 42px;
            flex-shrink: 0;
            scroll-snap-align: start;
        }
        .nav-btn:active, .nav-btn.active { 
            color: var(--primary); 
            background: rgba(59, 130, 246, 0.1);
        }
        .nav-icon {
            width: 18px;
            height: 18px;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #334155;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 0.9rem;
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }

        /* Install Prompt */
        .install-prompt {
            display: none;
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            font-size: 0.85rem;
            align-items: center;
            gap: 10px;
        }
        .install-prompt button { 
            background: white; 
            color: var(--primary); 
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-weight: bold;
            cursor: pointer;
        }

        .version { 
            font-size: 0.7rem; 
            color: #475569; 
            text-align: center; 
            padding: 15px 0; 
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>WW Pro-Calc</h1>
        <div style="display: flex; gap: 8px;">
            <button class="btn-refresh" onclick="refreshApp()" title="Check for updates">‚Üª</button>
            <button class="btn-clear" onclick="clearAll()">Clear All</button>
        </div>
    </header>

    <!-- 1. Pounds Formula -->
    <div class="card open" id="card1" data-calc="pounds">
        <div class="card-header" onclick="toggleCard(1)">
            <h2><span class="card-num">1</span> Pounds Formula</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Convert concentration to mass loading. Use for BOD, TSS, ammonia, phosphorus.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="p_flow" oninput="calcPounds()" placeholder="1.5">
                        <span class="field-hint">Million gallons per day</span>
                    </div>
                    <div>
                        <label>Concentration (mg/L)</label>
                        <input type="number" inputmode="decimal" id="p_conc" oninput="calcPounds()" placeholder="200">
                        <span class="field-hint">Lab result</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="p_res">0.00 lbs/day</span>
                    <div id="p_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('p_res')">Copy Result</button>
                </div>
                <div class="formula-note">Flow √ó Conc √ó 8.34</div>
            </div>
        </div>
    </div>

    <!-- 2. SVI -->
    <div class="card" id="card2" data-calc="svi">
        <div class="card-header" onclick="toggleCard(2)">
            <h2><span class="card-num">2</span> SVI ‚Äì Sludge Volume Index</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Measures sludge settleability. Perform 30-min settleometer test.</div>
                <div class="grid">
                    <div>
                        <label>30-min Settled (mL/L)</label>
                        <input type="number" inputmode="decimal" id="svi_set" oninput="calcSVI()" placeholder="250">
                        <span class="field-hint" id="svi_set_hint">Max 1000 mL/L</span>
                    </div>
                    <div>
                        <label>MLSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="svi_mlss" oninput="calcSVI()" placeholder="2500">
                        <span class="field-hint">From lab</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="svi_res">0.00 mL/g</span>
                    <div id="svi_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('svi_res')">Copy Result</button>
                </div>
                <div class="formula-note">(Settled Vol √ó 1000) √∑ MLSS</div>
            </div>
        </div>
    </div>

    <!-- 3. Mass Balance -->
    <div class="card accent" id="card3" data-calc="mass">
        <div class="card-header" onclick="toggleCard(3)">
            <h2><span class="card-num">3</span> Mass Balance</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Calculate mixed concentration when two flows combine (RAS + Influent, blending).</div>
                <div class="grid">
                    <div>
                        <label>Stream A ‚Äì Flow</label>
                        <input type="number" inputmode="decimal" id="mb_qa" oninput="calcMB()" placeholder="1.0">
                        <span class="field-hint">Any flow unit</span>
                    </div>
                    <div>
                        <label>Stream A ‚Äì Conc</label>
                        <input type="number" inputmode="decimal" id="mb_ca" oninput="calcMB()" placeholder="200">
                        <span class="field-hint">mg/L</span>
                    </div>
                    <div>
                        <label>Stream B ‚Äì Flow</label>
                        <input type="number" inputmode="decimal" id="mb_qb" oninput="calcMB()" placeholder="0.5">
                        <span class="field-hint">Same unit as A</span>
                    </div>
                    <div>
                        <label>Stream B ‚Äì Conc</label>
                        <input type="number" inputmode="decimal" id="mb_cb" oninput="calcMB()" placeholder="8000">
                        <span class="field-hint">mg/L</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="mb_res">0.00 mg/L</span>
                    <div id="mb_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('mb_res')">Copy Result</button>
                </div>
                <div class="formula-note">(Q‚ÇÅ√óC‚ÇÅ + Q‚ÇÇ√óC‚ÇÇ) √∑ (Q‚ÇÅ + Q‚ÇÇ)</div>
            </div>
        </div>
    </div>

    <!-- 4. F/M Ratio -->
    <div class="card success" id="card4" data-calc="fm">
        <div class="card-header" onclick="toggleCard(4)">
            <h2><span class="card-num">4</span> F/M Ratio</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Food to Microorganism ratio. Key process control parameter.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="fm_flow" oninput="calcFM()" placeholder="1.5">
                        <span class="field-hint">Influent flow</span>
                    </div>
                    <div>
                        <label>BOD (mg/L)</label>
                        <input type="number" inputmode="decimal" id="fm_bod" oninput="calcFM()" placeholder="200">
                        <span class="field-hint">Influent BOD‚ÇÖ</span>
                    </div>
                    <div>
                        <label>Aeration Vol (MG)</label>
                        <input type="number" inputmode="decimal" id="fm_vol" oninput="calcFM()" placeholder="0.5">
                        <span class="field-hint">Million gallons</span>
                    </div>
                    <div>
                        <label>MLVSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="fm_mlvss" oninput="calcFM()" placeholder="2000">
                        <span class="field-hint">Or MLSS √ó 0.75</span>
                    </div>
                </div>
                <div class="example-box"><b>Tip:</b> MLVSS ‚âà MLSS √ó 0.75 if not measured directly</div>
                <div class="result-box">
                    <span class="val" id="fm_res">0.000</span>
                    <div id="fm_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('fm_res')">Copy Result</button>
                </div>
                <div class="formula-note">(Flow √ó BOD √ó 8.34) √∑ (Vol √ó MLVSS √ó 8.34)</div>
            </div>
        </div>
    </div>

    <!-- 5. SRT -->
    <div class="card success" id="card5" data-calc="srt">
        <div class="card-header" onclick="toggleCard(5)">
            <h2><span class="card-num">5</span> SRT ‚Äì Sludge Age</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Solids Retention Time. Critical for nitrification (need >8 days).</div>
                <div class="grid">
                    <div>
                        <label>Aeration Vol (MG)</label>
                        <input type="number" inputmode="decimal" id="srt_vol" oninput="calcSRT()" placeholder="0.5">
                        <span class="field-hint">Basin volume</span>
                    </div>
                    <div>
                        <label>MLSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="srt_mlss" oninput="calcSRT()" placeholder="3000">
                        <span class="field-hint">In aeration</span>
                    </div>
                    <div>
                        <label>WAS Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="srt_wasq" oninput="calcSRT()" placeholder="0.015">
                        <span class="field-hint">Waste sludge flow</span>
                    </div>
                    <div>
                        <label>WAS Conc (mg/L)</label>
                        <input type="number" inputmode="decimal" id="srt_wasc" oninput="calcSRT()" placeholder="8000">
                        <span class="field-hint">WAS or RAS conc</span>
                    </div>
                    <div>
                        <label>Effluent Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="srt_effq" oninput="calcSRT()" placeholder="1.5">
                        <span class="field-hint">Discharge flow</span>
                    </div>
                    <div>
                        <label>Effluent TSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="srt_effc" oninput="calcSRT()" placeholder="10">
                        <span class="field-hint">Solids over weirs</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="srt_res">0.0 days</span>
                    <div id="srt_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('srt_res')">Copy Result</button>
                </div>
                <div class="formula-note">Solids in System √∑ Solids Out per Day</div>
            </div>
        </div>
    </div>

    <!-- 6. Detention Time -->
    <div class="card success" id="card6" data-calc="dt">
        <div class="card-header" onclick="toggleCard(6)">
            <h2><span class="card-num">6</span> Detention Time</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Hydraulic retention time in any tank or process.</div>
                <div class="grid">
                    <div>
                        <label>Volume (gallons)</label>
                        <input type="number" inputmode="decimal" id="dt_vol" oninput="calcDT()" placeholder="500000">
                        <span class="field-hint">Tank volume</span>
                    </div>
                    <div>
                        <label>Flow (GPD)</label>
                        <input type="number" inputmode="decimal" id="dt_flow" oninput="calcDT()" placeholder="1500000">
                        <span class="field-hint">Gallons per day</span>
                    </div>
                </div>
                <div class="example-box"><b>Volume:</b> Rect = L√óW√óD√ó7.48 | Circ = 0.785√óD¬≤√óH√ó7.48</div>
                <div class="result-box">
                    <span class="val" id="dt_res">0.00 hours</span>
                    <div id="dt_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('dt_res')">Copy Result</button>
                </div>
                <div class="formula-note">(Volume √∑ Flow) √ó 24</div>
            </div>
        </div>
    </div>

    <!-- 7. Removal Efficiency -->
    <div class="card success" id="card7" data-calc="eff">
        <div class="card-header" onclick="toggleCard(7)">
            <h2><span class="card-num">7</span> Removal Efficiency</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Percent removal for BOD, TSS, ammonia, or any parameter.</div>
                <div class="grid">
                    <div>
                        <label>Influent (mg/L)</label>
                        <input type="number" inputmode="decimal" id="eff_in" oninput="calcEff()" placeholder="200">
                        <span class="field-hint">Before treatment</span>
                    </div>
                    <div>
                        <label>Effluent (mg/L)</label>
                        <input type="number" inputmode="decimal" id="eff_out" oninput="calcEff()" placeholder="15">
                        <span class="field-hint">After treatment</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="eff_res">0.0 %</span>
                    <div id="eff_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('eff_res')">Copy Result</button>
                </div>
                <div class="formula-note">(In - Out) √∑ In √ó 100</div>
            </div>
        </div>
    </div>

    <!-- 8. WAS Pumping Rate -->
    <div class="card" id="card8" data-calc="was">
        <div class="card-header" onclick="toggleCard(8)">
            <h2><span class="card-num">8</span> WAS Pumping Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Calculate required WAS flow to achieve target SRT. Solve for wasting rate.</div>
                <div class="grid">
                    <div>
                        <label>Aeration Vol (MG)</label>
                        <input type="number" inputmode="decimal" id="was_vol" oninput="calcWAS()" placeholder="0.5">
                        <span class="field-hint">Basin volume</span>
                    </div>
                    <div>
                        <label>MLSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="was_mlss" oninput="calcWAS()" placeholder="3000">
                        <span class="field-hint">In aeration</span>
                    </div>
                    <div>
                        <label>Target SRT (days)</label>
                        <input type="number" inputmode="decimal" id="was_srt" oninput="calcWAS()" placeholder="10">
                        <span class="field-hint">Desired sludge age</span>
                    </div>
                    <div>
                        <label>WAS Conc (mg/L)</label>
                        <input type="number" inputmode="decimal" id="was_conc" oninput="calcWAS()" placeholder="8000">
                        <span class="field-hint">WAS/RAS solids</span>
                    </div>
                </div>
                <div class="example-box"><b>Note:</b> This simplified calc ignores effluent TSS loss. For precise SRT, account for solids over weirs.</div>
                <div class="result-box">
                    <span class="val" id="was_res">0 GPD</span>
                    <div id="was_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('was_res')">Copy Result</button>
                </div>
                <div class="formula-note">WAS Flow = (Vol √ó MLSS) √∑ (SRT √ó WAS Conc)</div>
            </div>
        </div>
    </div>

    <!-- 9. RAS Return Rate -->
    <div class="card" id="card9" data-calc="ras">
        <div class="card-header" onclick="toggleCard(9)">
            <h2><span class="card-num">9</span> RAS Return Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Calculate RAS flow rate based on sludge blanket or settleability method.</div>
                <div class="grid">
                    <div>
                        <label>Influent Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="ras_flow" oninput="calcRAS()" placeholder="1.5">
                        <span class="field-hint">Plant flow</span>
                    </div>
                    <div>
                        <label>MLSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="ras_mlss" oninput="calcRAS()" placeholder="3000">
                        <span class="field-hint">In aeration</span>
                    </div>
                    <div>
                        <label>RAS Conc (mg/L)</label>
                        <input type="number" inputmode="decimal" id="ras_conc" oninput="calcRAS()" placeholder="8000">
                        <span class="field-hint">Return sludge TSS</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="ras_res">0.00 MGD</span>
                    <div id="ras_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('ras_res')">Copy Result</button>
                </div>
                <div class="formula-note">RAS = (Q √ó MLSS) √∑ (RAS Conc - MLSS)</div>
            </div>
        </div>
    </div>

    <!-- 10. Organic Loading Rate -->
    <div class="card accent" id="card10" data-calc="olr">
        <div class="card-header" onclick="toggleCard(10)">
            <h2><span class="card-num">10</span> Organic Loading Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">BOD loading per unit volume. Used for trickling filters, RBCs, and aeration basins.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="olr_flow" oninput="calcOLR()" placeholder="1.5">
                        <span class="field-hint">Influent flow</span>
                    </div>
                    <div>
                        <label>BOD (mg/L)</label>
                        <input type="number" inputmode="decimal" id="olr_bod" oninput="calcOLR()" placeholder="200">
                        <span class="field-hint">Influent BOD</span>
                    </div>
                    <div>
                        <label>Volume (1000 ft¬≥)</label>
                        <input type="number" inputmode="decimal" id="olr_vol" oninput="calcOLR()" placeholder="50">
                        <span class="field-hint">Media or basin volume</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="olr_res">0.0 lbs/day/1000ft¬≥</span>
                    <div id="olr_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('olr_res')">Copy Result</button>
                </div>
                <div class="formula-note">(Flow √ó BOD √ó 8.34) √∑ Volume in 1000 ft¬≥</div>
            </div>
        </div>
    </div>

    <!-- 11. Surface Overflow Rate -->
    <div class="card accent" id="card11" data-calc="sor">
        <div class="card-header" onclick="toggleCard(11)">
            <h2><span class="card-num">11</span> Surface Overflow Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Hydraulic loading rate for clarifiers. Flow per unit surface area.</div>
                <div class="grid">
                    <div>
                        <label>Flow (GPD)</label>
                        <input type="number" inputmode="decimal" id="sor_flow" oninput="calcSOR()" placeholder="1500000">
                        <span class="field-hint">Gallons per day</span>
                    </div>
                    <div>
                        <label>Surface Area (ft¬≤)</label>
                        <input type="number" inputmode="decimal" id="sor_area" oninput="calcSOR()" placeholder="3000">
                        <span class="field-hint">Clarifier surface area</span>
                    </div>
                </div>
                <div class="example-box"><b>Circular:</b> Area = 0.785 √ó D¬≤ | <b>Rectangular:</b> Area = L √ó W</div>
                <div class="result-box">
                    <span class="val" id="sor_res">0 GPD/ft¬≤</span>
                    <div id="sor_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('sor_res')">Copy Result</button>
                </div>
                <div class="formula-note">Flow (GPD) √∑ Surface Area (ft¬≤)</div>
            </div>
        </div>
    </div>

    <!-- 12. Weir Overflow Rate -->
    <div class="card accent" id="card12" data-calc="wor">
        <div class="card-header" onclick="toggleCard(12)">
            <h2><span class="card-num">12</span> Weir Overflow Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Flow per linear foot of weir. Important for clarifier performance.</div>
                <div class="grid">
                    <div>
                        <label>Flow (GPD)</label>
                        <input type="number" inputmode="decimal" id="wor_flow" oninput="calcWOR()" placeholder="1500000">
                        <span class="field-hint">Gallons per day</span>
                    </div>
                    <div>
                        <label>Weir Length (ft)</label>
                        <input type="number" inputmode="decimal" id="wor_len" oninput="calcWOR()" placeholder="150">
                        <span class="field-hint">Total weir length</span>
                    </div>
                </div>
                <div class="example-box"><b>Circular weir:</b> Length = œÄ √ó Diameter (3.14 √ó D)</div>
                <div class="result-box">
                    <span class="val" id="wor_res">0 GPD/ft</span>
                    <div id="wor_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('wor_res')">Copy Result</button>
                </div>
                <div class="formula-note">Flow (GPD) √∑ Weir Length (ft)</div>
            </div>
        </div>
    </div>

    <!-- 13. Solids Loading Rate -->
    <div class="card success" id="card13" data-calc="slr">
        <div class="card-header" onclick="toggleCard(13)">
            <h2><span class="card-num">13</span> Solids Loading Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Solids applied per unit clarifier area. Key for secondary clarifier design.</div>
                <div class="grid">
                    <div>
                        <label>Influent + RAS Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="slr_flow" oninput="calcSLR()" placeholder="2.0">
                        <span class="field-hint">Total flow to clarifier</span>
                    </div>
                    <div>
                        <label>MLSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="slr_mlss" oninput="calcSLR()" placeholder="3000">
                        <span class="field-hint">Mixed liquor solids</span>
                    </div>
                    <div>
                        <label>Surface Area (ft¬≤)</label>
                        <input type="number" inputmode="decimal" id="slr_area" oninput="calcSLR()" placeholder="3000">
                        <span class="field-hint">Clarifier area</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="slr_res">0.0 lbs/day/ft¬≤</span>
                    <div id="slr_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('slr_res')">Copy Result</button>
                </div>
                <div class="formula-note">(Flow √ó MLSS √ó 8.34) √∑ Surface Area</div>
            </div>
        </div>
    </div>

    <!-- 14. Chemical Dosing -->
    <div class="card success" id="card14" data-calc="chem">
        <div class="card-header" onclick="toggleCard(14)">
            <h2><span class="card-num">14</span> Chemical Dosing</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Calculate chemical feed rate. Works for chlorine, alum, polymer, lime, etc.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="chem_flow" oninput="calcChem()" placeholder="1.5">
                        <span class="field-hint">Treatment flow</span>
                    </div>
                    <div>
                        <label>Dose (mg/L)</label>
                        <input type="number" inputmode="decimal" id="chem_dose" oninput="calcChem()" placeholder="2.0">
                        <span class="field-hint">Target dosage</span>
                    </div>
                    <div>
                        <label>Chemical % Purity</label>
                        <input type="number" inputmode="decimal" id="chem_purity" oninput="calcChem()" placeholder="100">
                        <span class="field-hint">65% for HTH, 12% for bleach</span>
                    </div>
                </div>
                <div class="example-box"><b>Common:</b> Gas Cl‚ÇÇ = 100% | HTH = 65% | Bleach = 12% | Alum = 48%</div>
                <div class="result-box">
                    <span class="val" id="chem_res">0.00 lbs/day</span>
                    <div id="chem_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('chem_res')">Copy Result</button>
                </div>
                <div class="formula-note">(Flow √ó Dose √ó 8.34) √∑ (Purity √∑ 100)</div>
            </div>
        </div>
    </div>

    <!-- ========== MBR SECTION ========== -->
    <div style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(139, 92, 246, 0.15); border-radius: 8px; border-left: 4px solid #8b5cf6; font-size: 0.85rem; color: #a78bfa; font-weight: bold;">üî¨ MBR ‚Äì Membrane Bioreactor Calculators</div>

    <!-- 15. Membrane Flux Rate -->
    <div class="card" id="card15" data-calc="flux" style="border-left-color: #8b5cf6;">
        <div class="card-header" onclick="toggleCard(15)">
            <h2><span class="card-num" style="background: #8b5cf6;">15</span> Membrane Flux Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #8b5cf6;">Calculate permeate flux through the membrane. Primary MBR performance indicator ‚Äî check daily to detect fouling trends.</div>
                <div class="grid">
                    <div>
                        <label>Permeate Flow (GPD)</label>
                        <input type="number" inputmode="decimal" id="flux_flow" oninput="calcFlux()" placeholder="500000">
                        <span class="field-hint">Gallons per day through membranes</span>
                    </div>
                    <div>
                        <label>Membrane Area (ft¬≤)</label>
                        <input type="number" inputmode="decimal" id="flux_area" oninput="calcFlux()" placeholder="50000">
                        <span class="field-hint">Total active membrane area</span>
                    </div>
                </div>
                <div class="example-box"><b>Typical MBR Flux:</b> 10‚Äì15 GFD (avg) | 20‚Äì25 GFD (peak) | &lt;8 GFD = likely fouled | &gt;25 GFD = risk of damage</div>
                <div class="result-box">
                    <span class="val" id="flux_res">0.0 GFD</span>
                    <div id="flux_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('flux_res')">Copy Result</button>
                </div>
                <div class="formula-note">Flux (GFD) = Permeate Flow (GPD) √∑ Membrane Area (ft¬≤)</div>
            </div>
        </div>
    </div>

    <!-- 16. Transmembrane Pressure -->
    <div class="card" id="card16" data-calc="tmp" style="border-left-color: #8b5cf6;">
        <div class="card-header" onclick="toggleCard(16)">
            <h2><span class="card-num" style="background: #8b5cf6;">16</span> Transmembrane Pressure</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #8b5cf6;">Calculate pressure driving permeate through the membrane. TMP trending is the #1 fouling indicator and triggers CIP decisions.</div>
                <div class="grid">
                    <div>
                        <label>Feed Pressure (psi)</label>
                        <input type="number" inputmode="decimal" id="tmp_feed" oninput="calcTMP()" placeholder="6.0">
                        <span class="field-hint">Upstream of membrane</span>
                    </div>
                    <div>
                        <label>Permeate Pressure (psi)</label>
                        <input type="number" inputmode="decimal" id="tmp_perm" oninput="calcTMP()" placeholder="1.0">
                        <span class="field-hint">Downstream (often ~0 or vacuum)</span>
                    </div>
                </div>
                <div class="example-box"><b>Typical MBR TMP:</b> 1‚Äì7 psi (normal) | 7‚Äì12 psi (fouling) | >12 psi = CIP required | Submerged membranes often read in kPa (1 psi = 6.895 kPa)</div>
                <div class="result-box">
                    <span class="val" id="tmp_res">0.0 psi</span>
                    <div id="tmp_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('tmp_res')">Copy Result</button>
                </div>
                <div class="formula-note">TMP = Feed Pressure ‚àí Permeate Pressure</div>
            </div>
        </div>
    </div>

    <!-- 17. Membrane Permeability -->
    <div class="card" id="card17" data-calc="perm" style="border-left-color: #8b5cf6;">
        <div class="card-header" onclick="toggleCard(17)">
            <h2><span class="card-num" style="background: #8b5cf6;">17</span> Membrane Permeability</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #8b5cf6;">Normalizes flux per unit of driving pressure. Detects fouling even when flux appears stable ‚Äî declining permeability confirms membrane fouling.</div>
                <div class="grid">
                    <div>
                        <label>Flux (GFD)</label>
                        <input type="number" inputmode="decimal" id="perm_flux" oninput="calcPerm()" placeholder="12.0">
                        <span class="field-hint">From Flux calculator or known</span>
                    </div>
                    <div>
                        <label>TMP (psi)</label>
                        <input type="number" inputmode="decimal" id="perm_tmp" oninput="calcPerm()" placeholder="5.0">
                        <span class="field-hint">From TMP calculator or gauge</span>
                    </div>
                </div>
                <div class="example-box"><b>Typical Permeability:</b> 3‚Äì6 GFD/psi (good) | 1.5‚Äì3 GFD/psi (fouling) | &lt;1.5 GFD/psi = CIP needed | New membranes: 5‚Äì8+ GFD/psi</div>
                <div class="result-box">
                    <span class="val" id="perm_res">0.0 GFD/psi</span>
                    <div id="perm_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('perm_res')">Copy Result</button>
                </div>
                <div class="formula-note">Permeability = Flux (GFD) √∑ TMP (psi)</div>
            </div>
        </div>
    </div>

    <!-- 18. Membrane Area Sizing -->
    <div class="card" id="card18" data-calc="msize" style="border-left-color: #8b5cf6;">
        <div class="card-header" onclick="toggleCard(18)">
            <h2><span class="card-num" style="background: #8b5cf6;">18</span> Membrane Area Sizing</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #8b5cf6;">Calculate total membrane area needed for design flow. Essential for MBR retrofits, expansions, and new system evaluations.</div>
                <div class="grid">
                    <div>
                        <label>Design Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="msize_flow" oninput="calcMSize()" placeholder="1.5">
                        <span class="field-hint">Average day permitted flow</span>
                    </div>
                    <div>
                        <label>Peak Hour Factor</label>
                        <input type="number" inputmode="decimal" id="msize_pf" oninput="calcMSize()" placeholder="2.0">
                        <span class="field-hint">Typical: 1.5‚Äì3.0√ó</span>
                    </div>
                    <div>
                        <label>Target Avg Flux (GFD)</label>
                        <input type="number" inputmode="decimal" id="msize_flux" oninput="calcMSize()" placeholder="12">
                        <span class="field-hint">Design: 10‚Äì14 GFD avg</span>
                    </div>
                    <div>
                        <label>Peak Flux (GFD)</label>
                        <input type="number" inputmode="decimal" id="msize_peak" oninput="calcMSize()" placeholder="20">
                        <span class="field-hint">Peak: 18‚Äì25 GFD</span>
                    </div>
                </div>
                <div class="example-box"><b>Rule of thumb:</b> Design to avg flux for daily operation. Verify peak flux ‚â§ 25 GFD. Larger area = lower flux = longer membrane life.</div>
                <div class="result-box">
                    <span class="val" id="msize_res">0 ft¬≤</span>
                    <div id="msize_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('msize_res')">Copy Result</button>
                </div>
                <div class="formula-note">Area = Design Flow (GPD) √∑ Target Flux (GFD) ‚Äî checked against peak</div>
            </div>
        </div>
    </div>

    <!-- 19. Specific Aeration Demand -->
    <div class="card" id="card19" data-calc="sad" style="border-left-color: #8b5cf6;">
        <div class="card-header" onclick="toggleCard(19)">
            <h2><span class="card-num" style="background: #8b5cf6;">19</span> Specific Aeration Demand</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #8b5cf6;">Calculate membrane air scouring efficiency. SADm = air per membrane area. SADp = air per permeate volume. Membrane aeration is 30‚Äì50% of MBR energy cost.</div>
                <div class="grid">
                    <div>
                        <label>Air Flow (Nm¬≥/hr)</label>
                        <input type="number" inputmode="decimal" id="sad_air" oninput="calcSAD()" placeholder="500">
                        <span class="field-hint">Coarse bubble to membranes</span>
                    </div>
                    <div>
                        <label>Membrane Area (m¬≤)</label>
                        <input type="number" inputmode="decimal" id="sad_area" oninput="calcSAD()" placeholder="5000">
                        <span class="field-hint">Total active area</span>
                    </div>
                    <div>
                        <label>Permeate Flow (m¬≥/hr)</label>
                        <input type="number" inputmode="decimal" id="sad_perm" oninput="calcSAD()" placeholder="100">
                        <span class="field-hint">Permeate production rate</span>
                    </div>
                </div>
                <div class="example-box"><b>Targets:</b> SADm = 0.2‚Äì0.5 Nm¬≥/m¬≤/hr (flat sheet: 0.5‚Äì1.0) | SADp = 10‚Äì25 m¬≥air/m¬≥permeate | Lower = more efficient</div>
                <div class="result-box">
                    <span class="val" id="sad_res">‚Äî</span>
                    <div id="sad_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('sad_res')">Copy Result</button>
                </div>
                <div class="formula-note">SADm = Air Flow √∑ Membrane Area | SADp = Air Flow √∑ Permeate Flow</div>
            </div>
        </div>
    </div>

    <!-- 20. MBR Operating Range Check -->
    <div class="card" id="card20" data-calc="mbrcheck" style="border-left-color: #8b5cf6;">
        <div class="card-header" onclick="toggleCard(20)">
            <h2><span class="card-num" style="background: #8b5cf6;">20</span> MBR Operating Range Check</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #8b5cf6;">Verify MLSS, SRT, F:M, and DO are within MBR-appropriate ranges. MBR operates at drastically different setpoints than conventional activated sludge.</div>
                <div class="grid">
                    <div>
                        <label>MLSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="mbrc_mlss" oninput="calcMBRC()" placeholder="10000">
                        <span class="field-hint">MBR typical: 8,000‚Äì12,000</span>
                    </div>
                    <div>
                        <label>SRT (days)</label>
                        <input type="number" inputmode="decimal" id="mbrc_srt" oninput="calcMBRC()" placeholder="20">
                        <span class="field-hint">MBR typical: 15‚Äì40 days</span>
                    </div>
                    <div>
                        <label>F:M Ratio</label>
                        <input type="number" inputmode="decimal" id="mbrc_fm" oninput="calcMBRC()" placeholder="0.08">
                        <span class="field-hint">MBR typical: 0.05‚Äì0.15</span>
                    </div>
                    <div>
                        <label>DO (mg/L)</label>
                        <input type="number" inputmode="decimal" id="mbrc_do" oninput="calcMBRC()" placeholder="2.0">
                        <span class="field-hint">MBR typical: 1.0‚Äì3.0</span>
                    </div>
                </div>
                <div class="example-box"><b>CAS vs MBR:</b> CAS MLSS 1,500‚Äì4,000 ‚Üí MBR 8,000‚Äì12,000 | CAS SRT 5‚Äì15 d ‚Üí MBR 15‚Äì40 d | CAS F:M 0.2‚Äì0.5 ‚Üí MBR 0.05‚Äì0.15</div>
                <div class="result-box">
                    <span class="val" id="mbrc_res">‚Äî</span>
                    <div id="mbrc_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('mbrc_res')">Copy Result</button>
                </div>
                <div class="formula-note">Compares inputs against MBR-specific operating ranges</div>
            </div>
        </div>
    </div>

    <!-- 21. CIP Chemical Dosing -->
    <div class="card" id="card21" data-calc="cip" style="border-left-color: #8b5cf6;">
        <div class="card-header" onclick="toggleCard(21)">
            <h2><span class="card-num" style="background: #8b5cf6;">21</span> CIP Chemical Dosing</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #8b5cf6;">Calculate sodium hypochlorite (NaOCl) and citric acid volumes for membrane maintenance and recovery cleans. Wrong dosing can damage membranes.</div>
                <div class="grid">
                    <div>
                        <label>CIP Tank Volume (gal)</label>
                        <input type="number" inputmode="decimal" id="cip_vol" oninput="calcCIP()" placeholder="500">
                        <span class="field-hint">Membrane train clean volume</span>
                    </div>
                    <div>
                        <label>Target NaOCl (mg/L)</label>
                        <input type="number" inputmode="decimal" id="cip_nacl" oninput="calcCIP()" placeholder="1000">
                        <span class="field-hint">Maint: 200‚Äì500 | Recovery: 1000‚Äì2000</span>
                    </div>
                    <div>
                        <label>Bleach Strength (%)</label>
                        <input type="number" inputmode="decimal" id="cip_bleach" oninput="calcCIP()" placeholder="12.5">
                        <span class="field-hint">Typical: 12.5% (trade) or 10%</span>
                    </div>
                    <div>
                        <label>Target Citric Acid (mg/L)</label>
                        <input type="number" inputmode="decimal" id="cip_citric" oninput="calcCIP()" placeholder="2000">
                        <span class="field-hint">Maint: 1000‚Äì2000 | Recovery: 2000‚Äì5000</span>
                    </div>
                    <div>
                        <label>Citric Acid Strength (%)</label>
                        <input type="number" inputmode="decimal" id="cip_cstr" oninput="calcCIP()" placeholder="50">
                        <span class="field-hint">Powder dissolved: 50% typical</span>
                    </div>
                </div>
                <div class="example-box"><b>CIP Schedule:</b> Maintenance clean (MC): weekly‚Äìbiweekly | Recovery clean (RC): monthly‚Äìquarterly | Always NaOCl first, then citric acid. Never mix!</div>
                <div class="result-box">
                    <span class="val" id="cip_res">‚Äî</span>
                    <div id="cip_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('cip_res')">Copy Result</button>
                </div>
                <div class="formula-note">Volume = (Tank Vol √ó Target Conc) √∑ (Solution Strength √ó 10,000)</div>
            </div>
        </div>
    </div>

    <!-- ========== MBBR SECTION ========== -->
    <div style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(6, 182, 212, 0.15); border-radius: 8px; border-left: 4px solid #06b6d4; font-size: 0.85rem; color: #22d3ee; font-weight: bold;">üß¨ MBBR ‚Äì Moving Bed Biofilm Reactor Calculators</div>

    <!-- 22. Surface Area Loading Rate -->
    <div class="card" id="card22" data-calc="salr" style="border-left-color: #06b6d4;">
        <div class="card-header" onclick="toggleCard(22)">
            <h2><span class="card-num" style="background: #06b6d4;">22</span> Surface Area Loading Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #06b6d4;">The fundamental MBBR design parameter ‚Äî equivalent of F:M for suspended growth. Calculates organic or nitrogen load applied per unit of biofilm surface area.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="salr_flow" oninput="calcSALR()" placeholder="1.5">
                        <span class="field-hint">Influent flow to MBBR</span>
                    </div>
                    <div>
                        <label>Concentration (mg/L)</label>
                        <input type="number" inputmode="decimal" id="salr_conc" oninput="calcSALR()" placeholder="150">
                        <span class="field-hint">BOD‚ÇÖ or NH‚ÇÉ-N</span>
                    </div>
                    <div>
                        <label>Biofilm Area (m¬≤)</label>
                        <input type="number" inputmode="decimal" id="salr_area" oninput="calcSALR()" placeholder="50000">
                        <span class="field-hint">Total protected surface area</span>
                    </div>
                </div>
                <div class="example-box"><b>SALR Targets:</b> BOD removal: 5‚Äì20 g/m¬≤/d | Nitrification: 0.5‚Äì1.5 g NH‚ÇÉ-N/m¬≤/d | Pre-denitrification: 1‚Äì3 g NO‚ÇÉ-N/m¬≤/d</div>
                <div class="result-box">
                    <span class="val" id="salr_res">0.0 g/m¬≤/d</span>
                    <div id="salr_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('salr_res')">Copy Result</button>
                </div>
                <div class="formula-note">SALR = (Flow √ó Conc √ó 3.785) √∑ Biofilm Area (g/m¬≤/day)</div>
            </div>
        </div>
    </div>

    <!-- 23. Effective Biofilm Area -->
    <div class="card" id="card23" data-calc="bioarea" style="border-left-color: #06b6d4;">
        <div class="card-header" onclick="toggleCard(23)">
            <h2><span class="card-num" style="background: #06b6d4;">23</span> Effective Biofilm Area</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #06b6d4;">Calculate total protected biofilm surface area from reactor volume, media fill fraction, and carrier specific surface area. Needed to verify actual loading rates.</div>
                <div class="grid">
                    <div>
                        <label>Reactor Volume (ft¬≥)</label>
                        <input type="number" inputmode="decimal" id="bio_vol" oninput="calcBioArea()" placeholder="10000">
                        <span class="field-hint">Liquid volume of MBBR zone</span>
                    </div>
                    <div>
                        <label>Fill Fraction (%)</label>
                        <input type="number" inputmode="decimal" id="bio_fill" oninput="calcBioArea()" placeholder="50">
                        <span class="field-hint">Typical: 40‚Äì67%</span>
                    </div>
                    <div>
                        <label>Specific Surface Area (m¬≤/m¬≥)</label>
                        <input type="number" inputmode="decimal" id="bio_ssa" oninput="calcBioArea()" placeholder="500">
                        <span class="field-hint">From media spec sheet</span>
                    </div>
                </div>
                <div class="example-box"><b>Common Media SSA:</b> K1 Kaldnes = 500 m¬≤/m¬≥ | K3 = 500 | K5 = 800 | AnoxKaldnes‚Ñ¢ BiofilmChip‚Ñ¢ = 900+ | Typical fill: 50‚Äì60%</div>
                <div class="result-box">
                    <span class="val" id="bio_res">0 m¬≤</span>
                    <div id="bio_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('bio_res')">Copy Result</button>
                </div>
                <div class="formula-note">Area = Reactor Vol (m¬≥) √ó Fill% √ó Specific Surface Area (m¬≤/m¬≥)</div>
            </div>
        </div>
    </div>

    <!-- 24. Media Fill Volume -->
    <div class="card" id="card24" data-calc="mediavol" style="border-left-color: #06b6d4;">
        <div class="card-header" onclick="toggleCard(24)">
            <h2><span class="card-num" style="background: #06b6d4;">24</span> Media Fill Volume</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #06b6d4;">Calculate required carrier media volume from target SALR, influent load, and media specific surface area. Critical for sizing new MBBR systems or expansions.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="mv_flow" oninput="calcMediaVol()" placeholder="1.5">
                        <span class="field-hint">Influent flow</span>
                    </div>
                    <div>
                        <label>Concentration (mg/L)</label>
                        <input type="number" inputmode="decimal" id="mv_conc" oninput="calcMediaVol()" placeholder="150">
                        <span class="field-hint">BOD‚ÇÖ or NH‚ÇÉ-N</span>
                    </div>
                    <div>
                        <label>Target SALR (g/m¬≤/d)</label>
                        <input type="number" inputmode="decimal" id="mv_salr" oninput="calcMediaVol()" placeholder="10">
                        <span class="field-hint">BOD: 5‚Äì20 | NH‚ÇÉ: 0.5‚Äì1.5</span>
                    </div>
                    <div>
                        <label>Media SSA (m¬≤/m¬≥)</label>
                        <input type="number" inputmode="decimal" id="mv_ssa" oninput="calcMediaVol()" placeholder="500">
                        <span class="field-hint">From spec sheet</span>
                    </div>
                </div>
                <div class="example-box"><b>Sizing Logic:</b> Required area = Load √∑ SALR ‚Üí Media volume = Area √∑ SSA ‚Üí Check fill fraction stays 40‚Äì67%</div>
                <div class="result-box">
                    <span class="val" id="mv_res">0 m¬≥</span>
                    <div id="mv_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('mv_res')">Copy Result</button>
                </div>
                <div class="formula-note">Media Vol = (Flow √ó Conc √ó 3.785) √∑ (Target SALR √ó SSA)</div>
            </div>
        </div>
    </div>

    <!-- 25. MBBR Reactor Sizing -->
    <div class="card" id="card25" data-calc="mbbrsz" style="border-left-color: #06b6d4;">
        <div class="card-header" onclick="toggleCard(25)">
            <h2><span class="card-num" style="background: #06b6d4;">25</span> MBBR Reactor Sizing</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #06b6d4;">Calculate required reactor volume from media volume and fill fraction. Verifies HRT and ensures adequate empty-bed volume for proper media circulation.</div>
                <div class="grid">
                    <div>
                        <label>Media Volume (m¬≥)</label>
                        <input type="number" inputmode="decimal" id="rsz_media" oninput="calcRSZ()" placeholder="150">
                        <span class="field-hint">From Media Fill calc or known</span>
                    </div>
                    <div>
                        <label>Fill Fraction (%)</label>
                        <input type="number" inputmode="decimal" id="rsz_fill" oninput="calcRSZ()" placeholder="55">
                        <span class="field-hint">Target: 40‚Äì67% max</span>
                    </div>
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="rsz_flow" oninput="calcRSZ()" placeholder="1.5">
                        <span class="field-hint">For HRT calculation</span>
                    </div>
                </div>
                <div class="example-box"><b>Design Notes:</b> Max fill 67% ‚Äî above this media cannot circulate. Typical HRT: 1‚Äì3 hrs BOD removal | 3‚Äì6 hrs nitrification. Provide adequate mixing energy.</div>
                <div class="result-box">
                    <span class="val" id="rsz_res">0 m¬≥</span>
                    <div id="rsz_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('rsz_res')">Copy Result</button>
                </div>
                <div class="formula-note">Reactor Vol = Media Vol √∑ (Fill% √∑ 100)</div>
            </div>
        </div>
    </div>

    <!-- 26. MBBR Dissolved Oxygen Demand -->
    <div class="card" id="card26" data-calc="mbbrdo" style="border-left-color: #06b6d4;">
        <div class="card-header" onclick="toggleCard(26)">
            <h2><span class="card-num" style="background: #06b6d4;">26</span> MBBR Oxygen Demand</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #06b6d4;">Calculate O‚ÇÇ transfer needed for BOD removal and nitrification in MBBR. Biofilm systems need higher DO (4‚Äì6 mg/L) than CAS (~2 mg/L) due to boundary layer diffusion.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="mdo_flow" oninput="calcMDO()" placeholder="1.5">
                        <span class="field-hint">Influent flow</span>
                    </div>
                    <div>
                        <label>BOD Removed (mg/L)</label>
                        <input type="number" inputmode="decimal" id="mdo_bod" oninput="calcMDO()" placeholder="130">
                        <span class="field-hint">Influent ‚Äì Effluent BOD</span>
                    </div>
                    <div>
                        <label>NH‚ÇÉ-N Removed (mg/L)</label>
                        <input type="number" inputmode="decimal" id="mdo_nh3" oninput="calcMDO()" placeholder="20">
                        <span class="field-hint">0 if no nitrification</span>
                    </div>
                </div>
                <div class="example-box"><b>O‚ÇÇ Factors:</b> ~1.5 lb O‚ÇÇ/lb BOD removed | ~4.6 lb O‚ÇÇ/lb NH‚ÇÉ-N oxidized | MBBR target DO: 4‚Äì6 mg/L (vs CAS 1.5‚Äì2.5 mg/L)</div>
                <div class="result-box">
                    <span class="val" id="mdo_res">0 lbs O‚ÇÇ/day</span>
                    <div id="mdo_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('mdo_res')">Copy Result</button>
                </div>
                <div class="formula-note">O‚ÇÇ = (Flow √ó ŒîBOD √ó 8.34 √ó 1.5) + (Flow √ó ŒîNH‚ÇÉ √ó 8.34 √ó 4.6)</div>
            </div>
        </div>
    </div>

    <!-- 27. MBBR vs CAS Comparison -->
    <div class="card" id="card27" data-calc="mbbrcas" style="border-left-color: #06b6d4;">
        <div class="card-header" onclick="toggleCard(27)">
            <h2><span class="card-num" style="background: #06b6d4;">27</span> MBBR vs CAS Comparison</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #06b6d4;">Side-by-side comparison of MBBR vs conventional activated sludge for the same flow and load. Useful for technology selection and consulting evaluations.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="cmp_flow" oninput="calcCMP()" placeholder="1.5">
                        <span class="field-hint">Design flow</span>
                    </div>
                    <div>
                        <label>Influent BOD (mg/L)</label>
                        <input type="number" inputmode="decimal" id="cmp_bod" oninput="calcCMP()" placeholder="200">
                        <span class="field-hint">Raw or primary effluent BOD</span>
                    </div>
                </div>
                <div class="example-box"><b>Comparison basis:</b> CAS: F:M=0.3, MLSS=3000, SRT=10d | MBBR: SALR=10 g/m¬≤/d, K3 media 500 m¬≤/m¬≥, 55% fill</div>
                <div class="result-box">
                    <span class="val" id="cmp_res">‚Äî</span>
                    <div id="cmp_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('cmp_res')">Copy Result</button>
                </div>
                <div class="formula-note">CAS Vol = (Flow √ó BOD √ó 8.34) √∑ (F:M √ó MLSS) | MBBR Vol = Media √∑ Fill%</div>
            </div>
        </div>
    </div>

    <!-- ========== SBR SECTION ========== -->
    <div style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(244, 63, 94, 0.15); border-radius: 8px; border-left: 4px solid #f43f5e; font-size: 0.85rem; color: #fb7185; font-weight: bold;">‚è±Ô∏è SBR ‚Äì Sequencing Batch Reactor Calculators</div>

    <!-- 28. SBR Cycle Time -->
    <div class="card" id="card28" data-calc="sbrcycle" style="border-left-color: #f43f5e;">
        <div class="card-header" onclick="toggleCard(28)">
            <h2><span class="card-num" style="background: #f43f5e;">28</span> SBR Cycle Time</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #f43f5e;">Calculate total cycle time, cycles per day, and effective treatment capacity. Every SBR process decision flows from cycle timing.</div>
                <div class="grid">
                    <div>
                        <label>Fill (min)</label>
                        <input type="number" inputmode="decimal" id="cyc_fill" oninput="calcCycle()" placeholder="60">
                        <span class="field-hint">Static or aerated fill</span>
                    </div>
                    <div>
                        <label>React (min)</label>
                        <input type="number" inputmode="decimal" id="cyc_react" oninput="calcCycle()" placeholder="120">
                        <span class="field-hint">Aeration + mixing</span>
                    </div>
                    <div>
                        <label>Settle (min)</label>
                        <input type="number" inputmode="decimal" id="cyc_settle" oninput="calcCycle()" placeholder="60">
                        <span class="field-hint">Quiescent settling</span>
                    </div>
                    <div>
                        <label>Decant (min)</label>
                        <input type="number" inputmode="decimal" id="cyc_decant" oninput="calcCycle()" placeholder="30">
                        <span class="field-hint">Effluent withdrawal</span>
                    </div>
                    <div>
                        <label>Idle (min)</label>
                        <input type="number" inputmode="decimal" id="cyc_idle" oninput="calcCycle()" placeholder="10">
                        <span class="field-hint">Buffer / WAS (can be 0)</span>
                    </div>
                    <div>
                        <label>Design Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="cyc_flow" oninput="calcCycle()" placeholder="1.0">
                        <span class="field-hint">For capacity check</span>
                    </div>
                </div>
                <div class="example-box"><b>Typical Cycles:</b> 4‚Äì6 hrs total | 4‚Äì6 cycles/day | Fill 25‚Äì30% of cycle | React 30‚Äì40% | Settle 20‚Äì25% | Decant 15‚Äì20%</div>
                <div class="result-box">
                    <span class="val" id="cyc_res">‚Äî</span>
                    <div id="cyc_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('cyc_res')">Copy Result</button>
                </div>
                <div class="formula-note">Cycle = Fill + React + Settle + Decant + Idle | Cycles/day = 1440 √∑ Cycle</div>
            </div>
        </div>
    </div>

    <!-- 29. SBR Volume per Cycle -->
    <div class="card" id="card29" data-calc="sbrvol" style="border-left-color: #f43f5e;">
        <div class="card-header" onclick="toggleCard(29)">
            <h2><span class="card-num" style="background: #f43f5e;">29</span> SBR Volume per Cycle</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #f43f5e;">Calculate fill volume per cycle and verify reactor can handle the hydraulic load. Determines decant volume and checks against reactor capacity.</div>
                <div class="grid">
                    <div>
                        <label>Daily Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="sv_flow" oninput="calcSBRVol()" placeholder="1.0">
                        <span class="field-hint">Average daily flow</span>
                    </div>
                    <div>
                        <label>Cycles per Day</label>
                        <input type="number" inputmode="decimal" id="sv_cycles" oninput="calcSBRVol()" placeholder="4">
                        <span class="field-hint">From Cycle Time calc</span>
                    </div>
                    <div>
                        <label>Reactor Volume (gal)</label>
                        <input type="number" inputmode="decimal" id="sv_reactor" oninput="calcSBRVol()" placeholder="500000">
                        <span class="field-hint">Total basin volume</span>
                    </div>
                    <div>
                        <label># of Basins</label>
                        <input type="number" inputmode="decimal" id="sv_basins" oninput="calcSBRVol()" placeholder="2">
                        <span class="field-hint">Parallel SBR basins</span>
                    </div>
                </div>
                <div class="example-box"><b>Design Rule:</b> Decant volume (fill vol) should be 15‚Äì35% of total reactor volume. Freeboard must remain above max water level at all times.</div>
                <div class="result-box">
                    <span class="val" id="sv_res">‚Äî</span>
                    <div id="sv_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('sv_res')">Copy Result</button>
                </div>
                <div class="formula-note">Vol/Cycle = Daily Flow √∑ (Cycles √ó Basins) | Fill Ratio = Vol/Cycle √∑ Reactor Vol</div>
            </div>
        </div>
    </div>

    <!-- 30. SBR Decant Rate -->
    <div class="card" id="card30" data-calc="sbrdecant" style="border-left-color: #f43f5e;">
        <div class="card-header" onclick="toggleCard(30)">
            <h2><span class="card-num" style="background: #f43f5e;">30</span> SBR Decant Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #f43f5e;">Calculate decant withdrawal rate. Too fast = turbulence pulls solids into effluent. Too slow = steals time from react phase.</div>
                <div class="grid">
                    <div>
                        <label>Decant Volume (gal)</label>
                        <input type="number" inputmode="decimal" id="dec_vol" oninput="calcDecant()" placeholder="125000">
                        <span class="field-hint">Volume removed per cycle</span>
                    </div>
                    <div>
                        <label>Decant Time (min)</label>
                        <input type="number" inputmode="decimal" id="dec_time" oninput="calcDecant()" placeholder="30">
                        <span class="field-hint">Available decant period</span>
                    </div>
                    <div>
                        <label>Weir Length (ft)</label>
                        <input type="number" inputmode="decimal" id="dec_weir" oninput="calcDecant()" placeholder="20">
                        <span class="field-hint">Decanter weir length</span>
                    </div>
                </div>
                <div class="example-box"><b>Decant Limits:</b> Typical rate: 1,000‚Äì4,000 GPM total | Weir loading: &lt;10 GPM/ft preferred | Floating decanters adjust with water level</div>
                <div class="result-box">
                    <span class="val" id="dec_res">0 GPM</span>
                    <div id="dec_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('dec_res')">Copy Result</button>
                </div>
                <div class="formula-note">Rate (GPM) = Decant Vol √∑ Decant Time | Weir Rate = GPM √∑ Weir Length</div>
            </div>
        </div>
    </div>

    <!-- 31. SBR Aeration Demand -->
    <div class="card" id="card31" data-calc="sbraer" style="border-left-color: #f43f5e;">
        <div class="card-header" onclick="toggleCard(31)">
            <h2><span class="card-num" style="background: #f43f5e;">31</span> SBR Aeration Demand</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #f43f5e;">Calculate O‚ÇÇ required during react phase. In SBR, aeration only runs during fill+react ‚Äî blowers must deliver the full daily O‚ÇÇ demand in less time than continuous-flow plants.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="saer_flow" oninput="calcSBRAer()" placeholder="1.0">
                        <span class="field-hint">Daily flow</span>
                    </div>
                    <div>
                        <label>BOD Removed (mg/L)</label>
                        <input type="number" inputmode="decimal" id="saer_bod" oninput="calcSBRAer()" placeholder="150">
                        <span class="field-hint">Influent ‚Äì Effluent BOD</span>
                    </div>
                    <div>
                        <label>NH‚ÇÉ-N Removed (mg/L)</label>
                        <input type="number" inputmode="decimal" id="saer_nh3" oninput="calcSBRAer()" placeholder="20">
                        <span class="field-hint">0 if no nitrification</span>
                    </div>
                    <div>
                        <label>Aeration Duty (%)</label>
                        <input type="number" inputmode="decimal" id="saer_duty" oninput="calcSBRAer()" placeholder="50">
                        <span class="field-hint">(Fill + React) √∑ Total Cycle √ó 100</span>
                    </div>
                </div>
                <div class="example-box"><b>SBR Aeration:</b> If cycle = 4 hrs and aerated phases = 2 hrs ‚Üí 50% duty. Blower must deliver 2√ó the continuous rate. Size blowers for peak duty, not daily average.</div>
                <div class="result-box">
                    <span class="val" id="saer_res">‚Äî</span>
                    <div id="saer_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('saer_res')">Copy Result</button>
                </div>
                <div class="formula-note">Daily O‚ÇÇ = (BOD √ó 1.5 + NH‚ÇÉ √ó 4.6) √ó Flow √ó 8.34 | Peak = Daily √∑ Duty%</div>
            </div>
        </div>
    </div>

    <!-- 32. SBR F:M per Cycle -->
    <div class="card" id="card32" data-calc="sbrfm" style="border-left-color: #f43f5e;">
        <div class="card-header" onclick="toggleCard(32)">
            <h2><span class="card-num" style="background: #f43f5e;">32</span> SBR F:M per Cycle</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #f43f5e;">SBR F:M differs from CAS ‚Äî the food slug arrives all at once during fill, creating a high instantaneous F:M that drops to near-zero by end of react.</div>
                <div class="grid">
                    <div>
                        <label>Fill Volume (gal)</label>
                        <input type="number" inputmode="decimal" id="sfm_fill" oninput="calcSBRFM()" placeholder="125000">
                        <span class="field-hint">Volume added per cycle</span>
                    </div>
                    <div>
                        <label>Influent BOD (mg/L)</label>
                        <input type="number" inputmode="decimal" id="sfm_bod" oninput="calcSBRFM()" placeholder="200">
                        <span class="field-hint">Incoming BOD concentration</span>
                    </div>
                    <div>
                        <label>Reactor Volume (gal)</label>
                        <input type="number" inputmode="decimal" id="sfm_vol" oninput="calcSBRFM()" placeholder="500000">
                        <span class="field-hint">Total basin volume</span>
                    </div>
                    <div>
                        <label>MLVSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="sfm_mlvss" oninput="calcSBRFM()" placeholder="2500">
                        <span class="field-hint">Volatile suspended solids</span>
                    </div>
                    <div>
                        <label>Cycles per Day</label>
                        <input type="number" inputmode="decimal" id="sfm_cycles" oninput="calcSBRFM()" placeholder="4">
                        <span class="field-hint">For daily F:M</span>
                    </div>
                </div>
                <div class="example-box"><b>SBR F:M:</b> Daily avg: 0.05‚Äì0.15 typical | Instantaneous at start of fill is much higher | CAS equivalent would be 0.2‚Äì0.5</div>
                <div class="result-box">
                    <span class="val" id="sfm_res">‚Äî</span>
                    <div id="sfm_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('sfm_res')">Copy Result</button>
                </div>
                <div class="formula-note">Daily F:M = (Fill √ó BOD √ó 8.34 √ó Cycles) √∑ (Reactor √ó MLVSS √ó 8.34)</div>
            </div>
        </div>
    </div>

    <!-- 33. SBR Settle & Decant Check -->
    <div class="card" id="card33" data-calc="sbrsettle" style="border-left-color: #f43f5e;">
        <div class="card-header" onclick="toggleCard(33)">
            <h2><span class="card-num" style="background: #f43f5e;">33</span> SBR Settle & Decant Check</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #f43f5e;">Verify adequate separation before decant begins. Flags risk of solids carryover if sludge blanket is too close to decant withdrawal level.</div>
                <div class="grid">
                    <div>
                        <label>Total Water Depth (ft)</label>
                        <input type="number" inputmode="decimal" id="ssc_depth" oninput="calcSSC()" placeholder="16">
                        <span class="field-hint">Max water level at end of fill</span>
                    </div>
                    <div>
                        <label>Settled Sludge (%)</label>
                        <input type="number" inputmode="decimal" id="ssc_sludge" oninput="calcSSC()" placeholder="30">
                        <span class="field-hint">30-min settleometer (% of total)</span>
                    </div>
                    <div>
                        <label>Decant Depth (ft)</label>
                        <input type="number" inputmode="decimal" id="ssc_decant" oninput="calcSSC()" placeholder="4">
                        <span class="field-hint">Water removed during decant</span>
                    </div>
                    <div>
                        <label>MLSS (mg/L)</label>
                        <input type="number" inputmode="decimal" id="ssc_mlss" oninput="calcSSC()" placeholder="3500">
                        <span class="field-hint">Mixed liquor concentration</span>
                    </div>
                </div>
                <div class="example-box"><b>Safety Rule:</b> Sludge blanket must be ‚â•2 ft below decant weir at start of decant. Blanket depth = Water depth √ó Settled%. Good settling = &lt;30% in 30 min.</div>
                <div class="result-box">
                    <span class="val" id="ssc_res">‚Äî</span>
                    <div id="ssc_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('ssc_res')">Copy Result</button>
                </div>
                <div class="formula-note">Blanket = Depth √ó Settle% | Clearwater = Depth ‚àí Blanket | Buffer = Clearwater ‚àí Decant</div>
            </div>
        </div>
    </div>

    <!-- ========== DISINFECTION SECTION ========== -->
    <div style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(234, 179, 8, 0.15); border-radius: 8px; border-left: 4px solid #eab308; font-size: 0.85rem; color: #facc15; font-weight: bold;">üß™ Disinfection Calculators</div>

    <!-- 34. Chlorine Contact Time (CT) -->
    <div class="card" id="card34" data-calc="ct" style="border-left-color: #eab308;">
        <div class="card-header" onclick="toggleCard(34)">
            <h2><span class="card-num" style="background: #eab308;">34</span> Chlorine CT Value</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #eab308;">Calculate CT value for disinfection compliance. CT = chlorine residual √ó contact time. TCEQ requires specific CT for pathogen inactivation.</div>
                <div class="grid">
                    <div>
                        <label>Cl‚ÇÇ Residual (mg/L)</label>
                        <input type="number" inputmode="decimal" id="ct_res_in" oninput="calcCT()" placeholder="2.0">
                        <span class="field-hint">At end of contact chamber</span>
                    </div>
                    <div>
                        <label>Contact Time (min)</label>
                        <input type="number" inputmode="decimal" id="ct_time" oninput="calcCT()" placeholder="30">
                        <span class="field-hint">T10 actual contact time</span>
                    </div>
                    <div>
                        <label>Required CT (mg¬∑min/L)</label>
                        <input type="number" inputmode="decimal" id="ct_req" oninput="calcCT()" placeholder="450">
                        <span class="field-hint">From permit or tables</span>
                    </div>
                </div>
                <div class="example-box"><b>Common CT Requirements:</b> 2-log virus: 6 mg¬∑min/L (free Cl‚ÇÇ) | 3-log Giardia: 104‚Äì150+ depending on temp/pH | TCEQ Surface Water: 450+ typical</div>
                <div class="result-box">
                    <span class="val" id="ct_res">0.0 mg¬∑min/L</span>
                    <div id="ct_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('ct_res')">Copy Result</button>
                </div>
                <div class="formula-note">CT = Residual (mg/L) √ó Contact Time (min)</div>
            </div>
        </div>
    </div>

    <!-- 35. Dechlorination Dosing -->
    <div class="card" id="card35" data-calc="dechlor" style="border-left-color: #eab308;">
        <div class="card-header" onclick="toggleCard(35)">
            <h2><span class="card-num" style="background: #eab308;">35</span> Dechlorination Dosing</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #eab308;">Calculate sodium bisulfite (NaHSO‚ÇÉ) or sulfur dioxide needed to neutralize chlorine residual before discharge. Required at most Texas plants.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="dcl_flow" oninput="calcDCL()" placeholder="1.5">
                        <span class="field-hint">Effluent flow</span>
                    </div>
                    <div>
                        <label>Cl‚ÇÇ Residual (mg/L)</label>
                        <input type="number" inputmode="decimal" id="dcl_cl2" oninput="calcDCL()" placeholder="2.0">
                        <span class="field-hint">Before dechlorination</span>
                    </div>
                    <div>
                        <label>Safety Factor</label>
                        <input type="number" inputmode="decimal" id="dcl_sf" oninput="calcDCL()" placeholder="1.2">
                        <span class="field-hint">Typical: 1.1‚Äì1.5√ó</span>
                    </div>
                </div>
                <div class="example-box"><b>Stoichiometry:</b> 1.0 mg SO‚ÇÇ per 1.0 mg Cl‚ÇÇ | 1.46 mg NaHSO‚ÇÉ per 1.0 mg Cl‚ÇÇ | 0.9 mg Na‚ÇÇSO‚ÇÉ per 1.0 mg Cl‚ÇÇ</div>
                <div class="result-box">
                    <span class="val" id="dcl_res">‚Äî</span>
                    <div id="dcl_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('dcl_res')">Copy Result</button>
                </div>
                <div class="formula-note">SO‚ÇÇ lbs/day = Flow √ó Cl‚ÇÇ √ó 8.34 √ó 1.0 √ó SF | NaHSO‚ÇÉ = √ó 1.46</div>
            </div>
        </div>
    </div>

    <!-- 36. UV Dose -->
    <div class="card" id="card36" data-calc="uv" style="border-left-color: #eab308;">
        <div class="card-header" onclick="toggleCard(36)">
            <h2><span class="card-num" style="background: #eab308;">36</span> UV Dose</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #eab308;">Calculate UV dose from intensity and exposure time. Verify adequate disinfection for permit compliance. UV increasingly replacing chlorine in Texas.</div>
                <div class="grid">
                    <div>
                        <label>UV Intensity (mW/cm¬≤)</label>
                        <input type="number" inputmode="decimal" id="uv_int" oninput="calcUV()" placeholder="40">
                        <span class="field-hint">Measured by UV sensor</span>
                    </div>
                    <div>
                        <label>Exposure Time (sec)</label>
                        <input type="number" inputmode="decimal" id="uv_time" oninput="calcUV()" placeholder="10">
                        <span class="field-hint">Chamber volume √∑ flow rate</span>
                    </div>
                    <div>
                        <label>UV Transmittance (%)</label>
                        <input type="number" inputmode="decimal" id="uv_uvt" oninput="calcUV()" placeholder="65">
                        <span class="field-hint">Lab UVT result</span>
                    </div>
                </div>
                <div class="example-box"><b>Required Doses:</b> E. coli/fecal: 30‚Äì40 mJ/cm¬≤ | TCEQ typical: 30+ mJ/cm¬≤ | Reuse water: 80‚Äì100+ mJ/cm¬≤ | Good UVT: &gt;65%</div>
                <div class="result-box">
                    <span class="val" id="uv_res">0.0 mJ/cm¬≤</span>
                    <div id="uv_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('uv_res')">Copy Result</button>
                </div>
                <div class="formula-note">Dose (mJ/cm¬≤) = Intensity (mW/cm¬≤) √ó Time (sec)</div>
            </div>
        </div>
    </div>

    <!-- ========== SLUDGE & BIOSOLIDS SECTION ========== -->
    <div style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(168, 85, 247, 0.15); border-radius: 8px; border-left: 4px solid #a855f7; font-size: 0.85rem; color: #c084fc; font-weight: bold;">üí© Sludge & Biosolids Calculators</div>

    <!-- 37. Sludge Volume & Percent Solids -->
    <div class="card" id="card37" data-calc="sldvol" style="border-left-color: #a855f7;">
        <div class="card-header" onclick="toggleCard(37)">
            <h2><span class="card-num" style="background: #a855f7;">37</span> Sludge Volume & % Solids</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #a855f7;">Convert between wet volume, dry weight, and percent solids. Used daily for hauling, land application, and biosolids reporting.</div>
                <div class="grid">
                    <div>
                        <label>Sludge Volume (gal/day)</label>
                        <input type="number" inputmode="decimal" id="slv_vol" oninput="calcSLV()" placeholder="10000">
                        <span class="field-hint">Wet sludge pumped</span>
                    </div>
                    <div>
                        <label>% Solids</label>
                        <input type="number" inputmode="decimal" id="slv_pct" oninput="calcSLV()" placeholder="3.0">
                        <span class="field-hint">Lab result or estimate</span>
                    </div>
                </div>
                <div class="example-box"><b>Typical:</b> WAS 0.5‚Äì1.5% | Thickened WAS 3‚Äì6% | Belt press cake 15‚Äì25% | Centrifuge cake 20‚Äì30% | 1 gal sludge ‚âà 8.34 lbs</div>
                <div class="result-box">
                    <span class="val" id="slv_res">‚Äî</span>
                    <div id="slv_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('slv_res')">Copy Result</button>
                </div>
                <div class="formula-note">Dry lbs = Volume √ó 8.34 √ó (%Solids √∑ 100) | Dry tons = Dry lbs √∑ 2000</div>
            </div>
        </div>
    </div>

    <!-- 38. Volatile Solids Reduction -->
    <div class="card" id="card38" data-calc="vsr" style="border-left-color: #a855f7;">
        <div class="card-header" onclick="toggleCard(38)">
            <h2><span class="card-num" style="background: #a855f7;">38</span> Volatile Solids Reduction</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #a855f7;">Calculate VS destruction in digesters using Van Kleeck equation. 38% minimum required for Class B biosolids (vector attraction reduction).</div>
                <div class="grid">
                    <div>
                        <label>Influent VS (%)</label>
                        <input type="number" inputmode="decimal" id="vsr_in" oninput="calcVSR()" placeholder="75">
                        <span class="field-hint">Raw sludge volatile fraction</span>
                    </div>
                    <div>
                        <label>Effluent VS (%)</label>
                        <input type="number" inputmode="decimal" id="vsr_out" oninput="calcVSR()" placeholder="55">
                        <span class="field-hint">Digested sludge volatile fraction</span>
                    </div>
                </div>
                <div class="example-box"><b>Van Kleeck:</b> VSR = (VSin ‚àí VSout) √∑ (VSin ‚àí (VSin √ó VSout)) √ó 100 | Class B minimum: 38% | Healthy digester: 50‚Äì60%</div>
                <div class="result-box">
                    <span class="val" id="vsr_res">0.0 %</span>
                    <div id="vsr_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('vsr_res')">Copy Result</button>
                </div>
                <div class="formula-note">VSR = (VSin ‚àí VSout) √∑ [VSin ‚àí (VSin √ó VSout)] √ó 100</div>
            </div>
        </div>
    </div>

    <!-- 39. Digester Loading Rate -->
    <div class="card" id="card39" data-calc="diglr" style="border-left-color: #a855f7;">
        <div class="card-header" onclick="toggleCard(39)">
            <h2><span class="card-num" style="background: #a855f7;">39</span> Digester Loading Rate</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #a855f7;">Calculate volatile solids loading to anaerobic digester. Overloading causes pH drop, VFA buildup, and digester upset ‚Äî common and costly operator mistake.</div>
                <div class="grid">
                    <div>
                        <label>Sludge Flow (GPD)</label>
                        <input type="number" inputmode="decimal" id="dig_flow" oninput="calcDIG()" placeholder="15000">
                        <span class="field-hint">Volume fed to digester</span>
                    </div>
                    <div>
                        <label>% Solids</label>
                        <input type="number" inputmode="decimal" id="dig_pct" oninput="calcDIG()" placeholder="4.0">
                        <span class="field-hint">Feed sludge solids</span>
                    </div>
                    <div>
                        <label>% Volatile</label>
                        <input type="number" inputmode="decimal" id="dig_vs" oninput="calcDIG()" placeholder="72">
                        <span class="field-hint">VS as % of TS</span>
                    </div>
                    <div>
                        <label>Digester Volume (ft¬≥)</label>
                        <input type="number" inputmode="decimal" id="dig_vol" oninput="calcDIG()" placeholder="50000">
                        <span class="field-hint">Active digester volume</span>
                    </div>
                </div>
                <div class="example-box"><b>Loading Limits:</b> Low-rate: 0.03‚Äì0.05 lbs VS/ft¬≥/d | High-rate: 0.10‚Äì0.20 lbs VS/ft¬≥/d | Overloaded: &gt;0.20</div>
                <div class="result-box">
                    <span class="val" id="dig_res">0.00 lbs VS/ft¬≥/d</span>
                    <div id="dig_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('dig_res')">Copy Result</button>
                </div>
                <div class="formula-note">Loading = (Flow √ó 8.34 √ó %Solids √ó %VS) √∑ Digester Volume</div>
            </div>
        </div>
    </div>

    <!-- 40. Polymer Dosing for Dewatering -->
    <div class="card" id="card40" data-calc="poly" style="border-left-color: #a855f7;">
        <div class="card-header" onclick="toggleCard(40)">
            <h2><span class="card-num" style="background: #a855f7;">40</span> Polymer Dosing</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #a855f7;">Calculate active polymer per dry ton of solids for belt press or centrifuge. Polymer is one of the biggest chemical costs at any plant.</div>
                <div class="grid">
                    <div>
                        <label>Sludge Flow (GPM)</label>
                        <input type="number" inputmode="decimal" id="poly_flow" oninput="calcPoly()" placeholder="75">
                        <span class="field-hint">Feed to dewatering unit</span>
                    </div>
                    <div>
                        <label>% Solids</label>
                        <input type="number" inputmode="decimal" id="poly_pct" oninput="calcPoly()" placeholder="3.0">
                        <span class="field-hint">Feed sludge concentration</span>
                    </div>
                    <div>
                        <label>Polymer Solution (GPH)</label>
                        <input type="number" inputmode="decimal" id="poly_rate" oninput="calcPoly()" placeholder="20">
                        <span class="field-hint">Neat or diluted solution fed</span>
                    </div>
                    <div>
                        <label>Polymer Conc (% active)</label>
                        <input type="number" inputmode="decimal" id="poly_conc" oninput="calcPoly()" placeholder="0.5">
                        <span class="field-hint">Active polymer in solution</span>
                    </div>
                </div>
                <div class="example-box"><b>Targets:</b> Belt press: 3‚Äì8 lbs/DT | Centrifuge: 5‚Äì12 lbs/DT | Gravity thickener: 1‚Äì4 lbs/DT | Lower = more cost effective</div>
                <div class="result-box">
                    <span class="val" id="poly_res">‚Äî</span>
                    <div id="poly_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('poly_res')">Copy Result</button>
                </div>
                <div class="formula-note">lbs/DT = (Polymer GPH √ó 8.34 √ó %Active √ó 24) √∑ (Sludge GPM √ó 8.34 √ó %Solids √ó 60 √ó 24 √∑ 2000)</div>
            </div>
        </div>
    </div>

    <!-- ========== NUTRIENT REMOVAL SECTION ========== -->
    <div style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(34, 197, 94, 0.15); border-radius: 8px; border-left: 4px solid #22c55e; font-size: 0.85rem; color: #4ade80; font-weight: bold;">üåø Nutrient Removal Calculators</div>

    <!-- 41. Phosphorus Removal -->
    <div class="card" id="card41" data-calc="phos" style="border-left-color: #22c55e;">
        <div class="card-header" onclick="toggleCard(41)">
            <h2><span class="card-num" style="background: #22c55e;">41</span> Phosphorus Removal</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #22c55e;">Calculate alum or ferric chloride dose for chemical phosphorus precipitation. TCEQ phosphorus limits are tightening across Texas watersheds.</div>
                <div class="grid">
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="phos_flow" oninput="calcPhos()" placeholder="1.5">
                        <span class="field-hint">Treatment flow</span>
                    </div>
                    <div>
                        <label>Influent P (mg/L)</label>
                        <input type="number" inputmode="decimal" id="phos_in" oninput="calcPhos()" placeholder="5.0">
                        <span class="field-hint">Total phosphorus in</span>
                    </div>
                    <div>
                        <label>Target Effluent P (mg/L)</label>
                        <input type="number" inputmode="decimal" id="phos_out" oninput="calcPhos()" placeholder="1.0">
                        <span class="field-hint">Permit limit</span>
                    </div>
                    <div>
                        <label>Molar Ratio (Me:P)</label>
                        <input type="number" inputmode="decimal" id="phos_ratio" oninput="calcPhos()" placeholder="2.0">
                        <span class="field-hint">Alum: 1.5‚Äì2.5 | Ferric: 1.5‚Äì3.0</span>
                    </div>
                </div>
                <div class="example-box"><b>Chemical MW:</b> Alum (Al‚ÇÇ(SO‚ÇÑ)‚ÇÉ¬∑14H‚ÇÇO) = 594 | Ferric Chloride (FeCl‚ÇÉ) = 162.2 | P = 31 | Al = 27 | Fe = 55.85</div>
                <div class="result-box">
                    <span class="val" id="phos_res">‚Äî</span>
                    <div id="phos_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('phos_res')">Copy Result</button>
                </div>
                <div class="formula-note">Metal dose = ŒîP √ó Molar Ratio √ó (Metal MW √∑ P MW) | lbs/day = Flow √ó Dose √ó 8.34</div>
            </div>
        </div>
    </div>

    <!-- 42. Alkalinity Consumed by Nitrification -->
    <div class="card" id="card42" data-calc="alk" style="border-left-color: #22c55e;">
        <div class="card-header" onclick="toggleCard(42)">
            <h2><span class="card-num" style="background: #22c55e;">42</span> Alkalinity & Nitrification</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #22c55e;">Calculate alkalinity destroyed by nitrification (7.14 mg alk per mg NH‚ÇÉ-N). Low alkalinity causes nitrification crash and pH drop.</div>
                <div class="grid">
                    <div>
                        <label>Influent Alkalinity (mg/L as CaCO‚ÇÉ)</label>
                        <input type="number" inputmode="decimal" id="alk_in" oninput="calcALK()" placeholder="200">
                        <span class="field-hint">Lab alkalinity result</span>
                    </div>
                    <div>
                        <label>NH‚ÇÉ-N Oxidized (mg/L)</label>
                        <input type="number" inputmode="decimal" id="alk_nh3" oninput="calcALK()" placeholder="25">
                        <span class="field-hint">Influent NH‚ÇÉ ‚àí Effluent NH‚ÇÉ</span>
                    </div>
                    <div>
                        <label>Flow (MGD)</label>
                        <input type="number" inputmode="decimal" id="alk_flow" oninput="calcALK()" placeholder="1.5">
                        <span class="field-hint">For lime dosing calc</span>
                    </div>
                </div>
                <div class="example-box"><b>Rule:</b> 7.14 mg alk consumed per 1 mg NH‚ÇÉ-N oxidized | Maintain effluent alk &gt;50 mg/L | Lime adds ~1.35 mg alk per mg lime (as CaCO‚ÇÉ)</div>
                <div class="result-box">
                    <span class="val" id="alk_res">‚Äî</span>
                    <div id="alk_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('alk_res')">Copy Result</button>
                </div>
                <div class="formula-note">Alk consumed = NH‚ÇÉ-N √ó 7.14 | Remaining = Influent ‚àí Consumed</div>
            </div>
        </div>
    </div>

    <!-- 43. Nitrogen Balance -->
    <div class="card" id="card43" data-calc="nbal" style="border-left-color: #22c55e;">
        <div class="card-header" onclick="toggleCard(43)">
            <h2><span class="card-num" style="background: #22c55e;">43</span> Nitrogen Balance</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #22c55e;">Track where nitrogen goes in the treatment process. Essential for TN permit compliance and process optimization.</div>
                <div class="grid">
                    <div>
                        <label>Influent TKN (mg/L)</label>
                        <input type="number" inputmode="decimal" id="nb_tkn" oninput="calcNBal()" placeholder="35">
                        <span class="field-hint">Total Kjeldahl nitrogen in</span>
                    </div>
                    <div>
                        <label>Effluent NH‚ÇÉ-N (mg/L)</label>
                        <input type="number" inputmode="decimal" id="nb_nh3" oninput="calcNBal()" placeholder="1.0">
                        <span class="field-hint">Ammonia in effluent</span>
                    </div>
                    <div>
                        <label>Effluent NO‚ÇÉ-N (mg/L)</label>
                        <input type="number" inputmode="decimal" id="nb_no3" oninput="calcNBal()" placeholder="8.0">
                        <span class="field-hint">Nitrate in effluent</span>
                    </div>
                    <div>
                        <label>Biomass N Uptake (mg/L)</label>
                        <input type="number" inputmode="decimal" id="nb_bio" oninput="calcNBal()" placeholder="2.0">
                        <span class="field-hint">Typically 1‚Äì3 mg/L</span>
                    </div>
                </div>
                <div class="example-box"><b>N Pathways:</b> Nitrification (NH‚ÇÉ‚ÜíNO‚ÇÉ) | Denitrification (NO‚ÇÉ‚ÜíN‚ÇÇ gas) | Biomass uptake | Effluent TN = NH‚ÇÉ + NO‚ÇÉ + Org-N</div>
                <div class="result-box">
                    <span class="val" id="nb_res">‚Äî</span>
                    <div id="nb_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('nb_res')">Copy Result</button>
                </div>
                <div class="formula-note">Denitrified = TKN ‚àí Eff NH‚ÇÉ ‚àí Eff NO‚ÇÉ ‚àí Biomass N</div>
            </div>
        </div>
    </div>

    <!-- ========== HYDRAULICS & PUMPING SECTION ========== -->
    <div style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(59, 130, 246, 0.15); border-radius: 8px; border-left: 4px solid #3b82f6; font-size: 0.85rem; color: #60a5fa; font-weight: bold;">üíß Hydraulics & Pumping Calculators</div>

    <!-- 44. Pump TDH -->
    <div class="card" id="card44" data-calc="tdh" style="border-left-color: #3b82f6;">
        <div class="card-header" onclick="toggleCard(44)">
            <h2><span class="card-num" style="background: #3b82f6;">44</span> Total Dynamic Head</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #3b82f6;">Calculate total dynamic head from static lift, friction loss, and velocity head. Determines pump operating point and energy requirements.</div>
                <div class="grid">
                    <div>
                        <label>Static Head (ft)</label>
                        <input type="number" inputmode="decimal" id="tdh_static" oninput="calcTDH()" placeholder="25">
                        <span class="field-hint">Elevation difference</span>
                    </div>
                    <div>
                        <label>Friction Loss (ft)</label>
                        <input type="number" inputmode="decimal" id="tdh_friction" oninput="calcTDH()" placeholder="8">
                        <span class="field-hint">Pipe friction + fittings</span>
                    </div>
                    <div>
                        <label>Velocity Head (ft)</label>
                        <input type="number" inputmode="decimal" id="tdh_vel" oninput="calcTDH()" placeholder="2">
                        <span class="field-hint">v¬≤/2g (often small)</span>
                    </div>
                </div>
                <div class="example-box"><b>Typical TDH:</b> Influent lift station: 20‚Äì40 ft | RAS/WAS: 5‚Äì15 ft | Transfer pumps: 10‚Äì30 ft | 1 psi = 2.31 ft head</div>
                <div class="result-box">
                    <span class="val" id="tdh_res">0.0 ft</span>
                    <div id="tdh_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('tdh_res')">Copy Result</button>
                </div>
                <div class="formula-note">TDH = Static Head + Friction Loss + Velocity Head</div>
            </div>
        </div>
    </div>

    <!-- 45. Pipe Velocity -->
    <div class="card" id="card45" data-calc="pipev" style="border-left-color: #3b82f6;">
        <div class="card-header" onclick="toggleCard(45)">
            <h2><span class="card-num" style="background: #3b82f6;">45</span> Pipe Velocity</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #3b82f6;">Calculate flow velocity from flow rate and pipe diameter. Flags settling (&lt;2 fps) and scouring (&gt;10 fps) conditions.</div>
                <div class="grid">
                    <div>
                        <label>Flow (GPM)</label>
                        <input type="number" inputmode="decimal" id="pv_flow" oninput="calcPV()" placeholder="500">
                        <span class="field-hint">Pump or pipe flow</span>
                    </div>
                    <div>
                        <label>Pipe Diameter (inches)</label>
                        <input type="number" inputmode="decimal" id="pv_dia" oninput="calcPV()" placeholder="8">
                        <span class="field-hint">Internal diameter</span>
                    </div>
                </div>
                <div class="example-box"><b>Velocity Targets:</b> Gravity sewer: 2‚Äì10 fps | Force main: 3‚Äì8 fps | Suction pipe: 3‚Äì6 fps | &lt;2 fps = settling | &gt;10 fps = erosion</div>
                <div class="result-box">
                    <span class="val" id="pv_res">0.0 fps</span>
                    <div id="pv_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('pv_res')">Copy Result</button>
                </div>
                <div class="formula-note">V (fps) = Flow (GPM) √ó 0.4085 √∑ Diameter¬≤ (in¬≤)</div>
            </div>
        </div>
    </div>

    <!-- 46. Horsepower -->
    <div class="card" id="card46" data-calc="hp" style="border-left-color: #3b82f6;">
        <div class="card-header" onclick="toggleCard(46)">
            <h2><span class="card-num" style="background: #3b82f6;">46</span> Horsepower (WHP & BHP)</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #3b82f6;">Calculate water horsepower and brake horsepower from flow, head, and pump efficiency. Used for energy costs and pump selection.</div>
                <div class="grid">
                    <div>
                        <label>Flow (GPM)</label>
                        <input type="number" inputmode="decimal" id="hp_flow" oninput="calcHP()" placeholder="500">
                        <span class="field-hint">Pump flow rate</span>
                    </div>
                    <div>
                        <label>TDH (ft)</label>
                        <input type="number" inputmode="decimal" id="hp_tdh" oninput="calcHP()" placeholder="35">
                        <span class="field-hint">Total dynamic head</span>
                    </div>
                    <div>
                        <label>Pump Efficiency (%)</label>
                        <input type="number" inputmode="decimal" id="hp_eff" oninput="calcHP()" placeholder="75">
                        <span class="field-hint">From pump curve: 60‚Äì85%</span>
                    </div>
                    <div>
                        <label>Motor Efficiency (%)</label>
                        <input type="number" inputmode="decimal" id="hp_meff" oninput="calcHP()" placeholder="90">
                        <span class="field-hint">Typical: 85‚Äì95%</span>
                    </div>
                </div>
                <div class="example-box"><b>Formulas:</b> WHP = (Flow √ó TDH) √∑ 3960 | BHP = WHP √∑ Pump Eff | MHP = BHP √∑ Motor Eff | 1 HP = 0.746 kW</div>
                <div class="result-box">
                    <span class="val" id="hp_res">‚Äî</span>
                    <div id="hp_status" class="status">Enter data...</div>
                    <button class="btn-copy" onclick="copyVal('hp_res')">Copy Result</button>
                </div>
                <div class="formula-note">WHP = (GPM √ó TDH) √∑ 3960 | BHP = WHP √∑ Efficiency</div>
            </div>
        </div>
    </div>

    <!-- ========== COMPLIANCE & REPORTING SECTION ========== -->
    <div style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(249, 115, 22, 0.15); border-radius: 8px; border-left: 4px solid #f97316; font-size: 0.85rem; color: #fb923c; font-weight: bold;">üìã Compliance & Reporting Calculators</div>

    <!-- 47. Geometric Mean -->
    <div class="card" id="card47" data-calc="geomean" style="border-left-color: #f97316;">
        <div class="card-header" onclick="toggleCard(47)">
            <h2><span class="card-num" style="background: #f97316;">47</span> Geometric Mean</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #f97316;">Calculate geometric mean for E. coli or fecal coliform DMR reporting. TCEQ requires geometric mean ‚Äî not arithmetic mean. Operators frequently get this wrong.</div>
                <div class="grid">
                    <div>
                        <label>Sample 1</label>
                        <input type="number" inputmode="decimal" id="gm_s1" oninput="calcGM()" placeholder="50">
                    </div>
                    <div>
                        <label>Sample 2</label>
                        <input type="number" inputmode="decimal" id="gm_s2" oninput="calcGM()" placeholder="120">
                    </div>
                    <div>
                        <label>Sample 3</label>
                        <input type="number" inputmode="decimal" id="gm_s3" oninput="calcGM()" placeholder="30">
                    </div>
                    <div>
                        <label>Sample 4</label>
                        <input type="number" inputmode="decimal" id="gm_s4" oninput="calcGM()" placeholder="">
                        <span class="field-hint">Optional</span>
                    </div>
                    <div>
                        <label>Sample 5</label>
                        <input type="number" inputmode="decimal" id="gm_s5" oninput="calcGM()" placeholder="">
                        <span class="field-hint">Optional</span>
                    </div>
                    <div>
                        <label>Sample 6</label>
                        <input type="number" inputmode="decimal" id="gm_s6" oninput="calcGM()" placeholder="">
                        <span class="field-hint">Optional</span>
                    </div>
                    <div>
                        <label>Sample 7</label>
                        <input type="number" inputmode="decimal" id="gm_s7" oninput="calcGM()" placeholder="">
                        <span class="field-hint">Optional</span>
                    </div>
                </div>
                <div class="example-box"><b>TCEQ Limits:</b> E. coli: 126 CFU/100mL (geomean) / 399 single | Fecal: 200 CFU/100mL (geomean) / 400 single</div>
                <div class="result-box">
                    <span class="val" id="gm_res">‚Äî</span>
                    <div id="gm_status" class="status">Enter at least 2 samples...</div>
                    <button class="btn-copy" onclick="copyVal('gm_res')">Copy Result</button>
                </div>
                <div class="formula-note">Geomean = (S1 √ó S2 √ó ... √ó Sn) ^ (1/n)</div>
            </div>
        </div>
    </div>

    <!-- 48. Flow-Weighted Composite -->
    <div class="card" id="card48" data-calc="fwc" style="border-left-color: #f97316;">
        <div class="card-header" onclick="toggleCard(48)">
            <h2><span class="card-num" style="background: #f97316;">48</span> Flow-Weighted Composite</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help" style="border-left-color: #f97316;">Calculate flow-proportional average concentration from grab samples at different flows. Required for accurate DMR reporting at many plants.</div>
                <div class="grid">
                    <div>
                        <label>Flow 1 (MGD)</label>
                        <input type="number" inputmode="decimal" id="fw_f1" oninput="calcFWC()" placeholder="1.2">
                    </div>
                    <div>
                        <label>Conc 1 (mg/L)</label>
                        <input type="number" inputmode="decimal" id="fw_c1" oninput="calcFWC()" placeholder="15">
                    </div>
                    <div>
                        <label>Flow 2 (MGD)</label>
                        <input type="number" inputmode="decimal" id="fw_f2" oninput="calcFWC()" placeholder="1.8">
                    </div>
                    <div>
                        <label>Conc 2 (mg/L)</label>
                        <input type="number" inputmode="decimal" id="fw_c2" oninput="calcFWC()" placeholder="20">
                    </div>
                    <div>
                        <label>Flow 3 (MGD)</label>
                        <input type="number" inputmode="decimal" id="fw_f3" oninput="calcFWC()" placeholder="1.0">
                        <span class="field-hint">Optional</span>
                    </div>
                    <div>
                        <label>Conc 3 (mg/L)</label>
                        <input type="number" inputmode="decimal" id="fw_c3" oninput="calcFWC()" placeholder="12">
                        <span class="field-hint">Optional</span>
                    </div>
                    <div>
                        <label>Flow 4 (MGD)</label>
                        <input type="number" inputmode="decimal" id="fw_f4" oninput="calcFWC()" placeholder="">
                        <span class="field-hint">Optional</span>
                    </div>
                    <div>
                        <label>Conc 4 (mg/L)</label>
                        <input type="number" inputmode="decimal" id="fw_c4" oninput="calcFWC()" placeholder="">
                        <span class="field-hint">Optional</span>
                    </div>
                </div>
                <div class="result-box">
                    <span class="val" id="fw_res">‚Äî</span>
                    <div id="fw_status" class="status">Enter at least 2 flow-concentration pairs...</div>
                    <button class="btn-copy" onclick="copyVal('fw_res')">Copy Result</button>
                </div>
                <div class="formula-note">FW Avg = Œ£(Flow √ó Conc) √∑ Œ£(Flow)</div>
            </div>
        </div>
    </div>

    <!-- ========== QUICK CONVERSIONS SECTION ========== -->
    <div style="margin: 20px 0 10px; padding: 10px 15px; background: rgba(148, 163, 184, 0.15); border-radius: 8px; border-left: 4px solid #94a3b8; font-size: 0.85rem; color: #cbd5e1; font-weight: bold;">üîÑ Quick Conversions</div>

    <!-- 49. Unit Converter -->
    <div class="card" id="card49" data-calc="convert" style="border-left-color: #94a3b8;">
        <div class="card-header" onclick="toggleCard(49)">
            <h2><span class="card-num" style="background: #94a3b8;">49</span> Unit Converter</h2>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="card-body">
            <div class="card-content">
                <div class="input-help">Enter a value in any field to convert. One-stop conversion for common wastewater units.</div>
                <div style="font-size:0.8rem;color:#94a3b8;margin-bottom:8px;font-weight:bold;">‚îÅ‚îÅ Flow ‚îÅ‚îÅ</div>
                <div class="grid">
                    <div>
                        <label>GPM</label>
                        <input type="number" inputmode="decimal" id="uc_gpm" oninput="calcUC('gpm')" placeholder="GPM">
                    </div>
                    <div>
                        <label>MGD</label>
                        <input type="number" inputmode="decimal" id="uc_mgd" oninput="calcUC('mgd')" placeholder="MGD">
                    </div>
                    <div>
                        <label>CFS</label>
                        <input type="number" inputmode="decimal" id="uc_cfs" oninput="calcUC('cfs')" placeholder="ft¬≥/sec">
                    </div>
                    <div>
                        <label>m¬≥/day</label>
                        <input type="number" inputmode="decimal" id="uc_m3d" oninput="calcUC('m3d')" placeholder="m¬≥/day">
                    </div>
                </div>
                <div style="font-size:0.8rem;color:#94a3b8;margin-bottom:8px;font-weight:bold;">‚îÅ‚îÅ Volume ‚îÅ‚îÅ</div>
                <div class="grid">
                    <div>
                        <label>Gallons</label>
                        <input type="number" inputmode="decimal" id="uc_gal" oninput="calcUC('gal')" placeholder="gal">
                    </div>
                    <div>
                        <label>ft¬≥</label>
                        <input type="number" inputmode="decimal" id="uc_ft3" oninput="calcUC('ft3')" placeholder="ft¬≥">
                    </div>
                    <div>
                        <label>m¬≥</label>
                        <input type="number" inputmode="decimal" id="uc_m3" oninput="calcUC('m3')" placeholder="m¬≥">
                    </div>
                    <div>
                        <label>Acre-ft</label>
                        <input type="number" inputmode="decimal" id="uc_acft" oninput="calcUC('acft')" placeholder="ac-ft">
                    </div>
                </div>
                <div style="font-size:0.8rem;color:#94a3b8;margin-bottom:8px;font-weight:bold;">‚îÅ‚îÅ Pressure ‚îÅ‚îÅ</div>
                <div class="grid">
                    <div>
                        <label>PSI</label>
                        <input type="number" inputmode="decimal" id="uc_psi" oninput="calcUC('psi')" placeholder="psi">
                    </div>
                    <div>
                        <label>ft H‚ÇÇO</label>
                        <input type="number" inputmode="decimal" id="uc_fth2o" oninput="calcUC('fth2o')" placeholder="ft H‚ÇÇO">
                    </div>
                    <div>
                        <label>kPa</label>
                        <input type="number" inputmode="decimal" id="uc_kpa" oninput="calcUC('kpa')" placeholder="kPa">
                    </div>
                </div>
                <div class="result-box">
                    <div id="uc_status" class="status" style="text-align:center;color:#94a3b8;">Enter a value in any field to convert</div>
                </div>
            </div>
        </div>
    </div>

    <div class="version">
        <div style="font-size: 0.85rem; color: #94a3b8; margin-bottom: 4px;">Built by <b>Armand Frazier Sr.</b> | Houston, TX</div>
        WW Pro-Calc v7.0 ‚Äì 49 Calculators
    </div>
</div>

<!-- Bottom Navigation -->
<nav class="bottom-nav">
    <div class="nav-scroll">
        <button class="nav-btn active" onclick="goToCard(1)" id="nav1">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 3v18M5 8l7-5 7 5M5 12h14"/>
            </svg>
            <span>Lbs</span>
        </button>
        <button class="nav-btn" onclick="goToCard(2)" id="nav2">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="4" y="4" width="16" height="16" rx="2"/><path d="M8 20V10M12 20V6M16 20V14"/>
            </svg>
            <span>SVI</span>
        </button>
        <button class="nav-btn" onclick="goToCard(3)" id="nav3">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="8" cy="12" r="4"/><circle cx="16" cy="12" r="4"/>
            </svg>
            <span>Mix</span>
        </button>
        <button class="nav-btn" onclick="goToCard(4)" id="nav4">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
            <span>F/M</span>
        </button>
        <button class="nav-btn" onclick="goToCard(5)" id="nav5">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="16" rx="2"/><path d="M8 2v4M16 2v4M3 10h18"/>
            </svg>
            <span>SRT</span>
        </button>
        <button class="nav-btn" onclick="goToCard(6)" id="nav6">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
            </svg>
            <span>DT</span>
        </button>
        <button class="nav-btn" onclick="goToCard(7)" id="nav7">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 3v18h18"/><path d="M7 16l4-8 4 4 5-9"/>
            </svg>
            <span>Eff%</span>
        </button>
        <button class="nav-btn" onclick="goToCard(8)" id="nav8">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2v20M2 12h20"/><circle cx="12" cy="12" r="3"/>
            </svg>
            <span>WAS</span>
        </button>
        <button class="nav-btn" onclick="goToCard(9)" id="nav9">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 12h16M4 12l4-4M4 12l4 4M20 12l-4-4M20 12l-4 4"/>
            </svg>
            <span>RAS</span>
        </button>
        <button class="nav-btn" onclick="goToCard(10)" id="nav10">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 3v18"/>
            </svg>
            <span>OLR</span>
        </button>
        <button class="nav-btn" onclick="goToCard(11)" id="nav11">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><path d="M2 12h20"/>
            </svg>
            <span>SOR</span>
        </button>
        <button class="nav-btn" onclick="goToCard(12)" id="nav12">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 4h16v4H4zM4 12h16"/><path d="M12 12v8"/>
            </svg>
            <span>WOR</span>
        </button>
        <button class="nav-btn" onclick="goToCard(13)" id="nav13">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="4" y="4" width="16" height="16" rx="2"/><path d="M4 14h16M9 4v16"/>
            </svg>
            <span>SLR</span>
        </button>
        <button class="nav-btn" onclick="goToCard(14)" id="nav14">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 3h6v6H9zM12 9v12M8 21h8"/>
            </svg>
            <span>Chem</span>
        </button>
        <button class="nav-btn" onclick="goToCard(15)" id="nav15">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="6" width="18" height="12" rx="1"/><path d="M3 10h18M3 14h18M7 6v12M11 6v12M15 6v12M19 6v12"/>
            </svg>
            <span>Flux</span>
        </button>
        <button class="nav-btn" onclick="goToCard(16)" id="nav16">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2v20"/><path d="M5 5l14 14"/><path d="M19 5L5 19"/><circle cx="12" cy="12" r="3"/>
            </svg>
            <span>TMP</span>
        </button>
        <button class="nav-btn" onclick="goToCard(17)" id="nav17">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 12h16"/><path d="M4 6h16"/><path d="M4 18h16"/><circle cx="12" cy="12" r="2"/>
            </svg>
            <span>Perm</span>
        </button>
        <button class="nav-btn" onclick="goToCard(18)" id="nav18">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="2" y="4" width="20" height="16" rx="2"/><path d="M2 10h20M8 4v16M14 4v16"/>
            </svg>
            <span>MArea</span>
        </button>
        <button class="nav-btn" onclick="goToCard(19)" id="nav19">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="16" r="2"/><path d="M12 14V4"/><path d="M8 8l4-4 4 4"/><path d="M6 20h12"/>
            </svg>
            <span>SAD</span>
        </button>
        <button class="nav-btn" onclick="goToCard(20)" id="nav20">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 11l3 3 8-8"/><circle cx="12" cy="12" r="10"/>
            </svg>
            <span>MBR‚úì</span>
        </button>
        <button class="nav-btn" onclick="goToCard(21)" id="nav21">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M8 2h8l2 6H6l2-6z"/><rect x="6" y="8" width="12" height="12" rx="1"/><path d="M10 12v4M14 12v4"/>
            </svg>
            <span>CIP</span>
        </button>
        <button class="nav-btn" onclick="goToCard(22)" id="nav22">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 3v18"/>
            </svg>
            <span>SALR</span>
        </button>
        <button class="nav-btn" onclick="goToCard(23)" id="nav23">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="8" cy="8" r="3"/><circle cx="16" cy="8" r="3"/><circle cx="8" cy="16" r="3"/><circle cx="16" cy="16" r="3"/>
            </svg>
            <span>BioA</span>
        </button>
        <button class="nav-btn" onclick="goToCard(24)" id="nav24">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="4" y="4" width="16" height="16" rx="2"/><path d="M8 8h8v8H8z"/>
            </svg>
            <span>MVol</span>
        </button>
        <button class="nav-btn" onclick="goToCard(25)" id="nav25">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="6" width="18" height="12" rx="2"/><path d="M3 12h18"/>
            </svg>
            <span>RSiz</span>
        </button>
        <button class="nav-btn" onclick="goToCard(26)" id="nav26">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="8"/><path d="M12 8v4l2 2"/>
            </svg>
            <span>O‚ÇÇ</span>
        </button>
        <button class="nav-btn" onclick="goToCard(27)" id="nav27">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 4v16h16"/><rect x="7" y="10" width="4" height="8"/><rect x="13" y="6" width="4" height="12"/>
            </svg>
            <span>CvM</span>
        </button>
        <button class="nav-btn" onclick="goToCard(28)" id="nav28">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><path d="M12 6v6l3 3"/>
            </svg>
            <span>Cycle</span>
        </button>
        <button class="nav-btn" onclick="goToCard(29)" id="nav29">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="4" y="4" width="16" height="16" rx="2"/><path d="M4 12h16"/>
            </svg>
            <span>SVol</span>
        </button>
        <button class="nav-btn" onclick="goToCard(30)" id="nav30">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2v20"/><path d="M8 18l4 4 4-4"/><path d="M4 8h16"/>
            </svg>
            <span>Dec</span>
        </button>
        <button class="nav-btn" onclick="goToCard(31)" id="nav31">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="16" r="3"/><path d="M12 13V3"/><path d="M8 7l4-4 4 4"/>
            </svg>
            <span>SAer</span>
        </button>
        <button class="nav-btn" onclick="goToCard(32)" id="nav32">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18M6 6l12 12"/><circle cx="12" cy="12" r="2"/>
            </svg>
            <span>SF:M</span>
        </button>
        <button class="nav-btn" onclick="goToCard(33)" id="nav33">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="4" y="2" width="16" height="20" rx="2"/><path d="M4 8h16"/><path d="M4 14h16"/>
            </svg>
            <span>Set‚úì</span>
        </button>
        <button class="nav-btn" onclick="goToCard(34)" id="nav34">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 12h8M12 8v8"/></svg>
            <span>CT</span>
        </button>
        <button class="nav-btn" onclick="goToCard(35)" id="nav35">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18"/><circle cx="6" cy="6" r="3"/><circle cx="18" cy="18" r="3"/></svg>
            <span>DeCl</span>
        </button>
        <button class="nav-btn" onclick="goToCard(36)" id="nav36">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4"/></svg>
            <span>UV</span>
        </button>
        <button class="nav-btn" onclick="goToCard(37)" id="nav37">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="8" width="16" height="12" rx="2"/><path d="M8 8V6a4 4 0 018 0v2"/></svg>
            <span>Sld%</span>
        </button>
        <button class="nav-btn" onclick="goToCard(38)" id="nav38">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M7 16l4-8 4 4 5-9"/></svg>
            <span>VSR</span>
        </button>
        <button class="nav-btn" onclick="goToCard(39)" id="nav39">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6"/><circle cx="12" cy="16" r="1"/></svg>
            <span>DigL</span>
        </button>
        <button class="nav-btn" onclick="goToCard(40)" id="nav40">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 3h6v6H9zM12 9v6"/><circle cx="12" cy="18" r="3"/></svg>
            <span>Poly</span>
        </button>
        <button class="nav-btn" onclick="goToCard(41)" id="nav41">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/></svg>
            <span>Phos</span>
        </button>
        <button class="nav-btn" onclick="goToCard(42)" id="nav42">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 20h16M6 16l6-12 6 12"/><path d="M8.5 12h7"/></svg>
            <span>Alk</span>
        </button>
        <button class="nav-btn" onclick="goToCard(43)" id="nav43">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16v16H4z"/><path d="M4 12h16M12 4v16"/></svg>
            <span>NBal</span>
        </button>
        <button class="nav-btn" onclick="goToCard(44)" id="nav44">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M8 6l4-4 4 4M8 18l4 4 4-4"/></svg>
            <span>TDH</span>
        </button>
        <button class="nav-btn" onclick="goToCard(45)" id="nav45">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12h16M16 8l4 4-4 4"/></svg>
            <span>Pipe</span>
        </button>
        <button class="nav-btn" onclick="goToCard(46)" id="nav46">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
            <span>HP</span>
        </button>
        <button class="nav-btn" onclick="goToCard(47)" id="nav47">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="4" width="16" height="16" rx="2"/><path d="M8 8h8M8 12h5M8 16h8"/></svg>
            <span>Geo</span>
        </button>
        <button class="nav-btn" onclick="goToCard(48)" id="nav48">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6h16M4 10h16M4 14h10M4 18h6"/></svg>
            <span>FWC</span>
        </button>
        <button class="nav-btn" onclick="goToCard(49)" id="nav49">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12h16M12 4v16"/><path d="M8 8l8 8M16 8l-8 8"/></svg>
            <span>Unit</span>
        </button>
    </div>
</nav>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Install Prompt -->
<div class="install-prompt" id="installPrompt">
    üì≤ Install App
    <button onclick="installApp()">Install</button>
    <button onclick="dismissInstall()" style="background:transparent;color:white;font-size:1.2rem;">√ó</button>
</div>

<script>
    // ==================== STATE ====================
    const STORAGE_KEY = 'wwProCalcData';
    let currentCard = 1;
    
    // All input IDs for saving/restoring
    const inputIds = [
        'p_flow', 'p_conc',
        'svi_set', 'svi_mlss',
        'mb_qa', 'mb_ca', 'mb_qb', 'mb_cb',
        'fm_flow', 'fm_bod', 'fm_vol', 'fm_mlvss',
        'srt_vol', 'srt_mlss', 'srt_wasq', 'srt_wasc', 'srt_effq', 'srt_effc',
        'dt_vol', 'dt_flow',
        'eff_in', 'eff_out',
        'was_vol', 'was_mlss', 'was_srt', 'was_conc',
        'ras_flow', 'ras_mlss', 'ras_conc',
        'olr_flow', 'olr_bod', 'olr_vol',
        'sor_flow', 'sor_area',
        'wor_flow', 'wor_len',
        'slr_flow', 'slr_mlss', 'slr_area',
        'chem_flow', 'chem_dose', 'chem_purity',
        'flux_flow', 'flux_area',
        'tmp_feed', 'tmp_perm',
        'perm_flux', 'perm_tmp',
        'msize_flow', 'msize_pf', 'msize_flux', 'msize_peak',
        'sad_air', 'sad_area', 'sad_perm',
        'mbrc_mlss', 'mbrc_srt', 'mbrc_fm', 'mbrc_do',
        'cip_vol', 'cip_nacl', 'cip_bleach', 'cip_citric', 'cip_cstr',
        'salr_flow', 'salr_conc', 'salr_area',
        'bio_vol', 'bio_fill', 'bio_ssa',
        'mv_flow', 'mv_conc', 'mv_salr', 'mv_ssa',
        'rsz_media', 'rsz_fill', 'rsz_flow',
        'mdo_flow', 'mdo_bod', 'mdo_nh3',
        'cmp_flow', 'cmp_bod',
        'cyc_fill', 'cyc_react', 'cyc_settle', 'cyc_decant', 'cyc_idle', 'cyc_flow',
        'sv_flow', 'sv_cycles', 'sv_reactor', 'sv_basins',
        'dec_vol', 'dec_time', 'dec_weir',
        'saer_flow', 'saer_bod', 'saer_nh3', 'saer_duty',
        'sfm_fill', 'sfm_bod', 'sfm_vol', 'sfm_mlvss', 'sfm_cycles',
        'ssc_depth', 'ssc_sludge', 'ssc_decant', 'ssc_mlss',
        'ct_res_in', 'ct_time', 'ct_req',
        'dcl_flow', 'dcl_cl2', 'dcl_sf',
        'uv_int', 'uv_time', 'uv_uvt',
        'slv_vol', 'slv_pct',
        'vsr_in', 'vsr_out',
        'dig_flow', 'dig_pct', 'dig_vs', 'dig_vol',
        'poly_flow', 'poly_pct', 'poly_rate', 'poly_conc',
        'phos_flow', 'phos_in', 'phos_out', 'phos_ratio',
        'alk_in', 'alk_nh3', 'alk_flow',
        'nb_tkn', 'nb_nh3', 'nb_no3', 'nb_bio',
        'tdh_static', 'tdh_friction', 'tdh_vel',
        'pv_flow', 'pv_dia',
        'hp_flow', 'hp_tdh', 'hp_eff', 'hp_meff',
        'gm_s1', 'gm_s2', 'gm_s3', 'gm_s4', 'gm_s5', 'gm_s6', 'gm_s7',
        'fw_f1', 'fw_c1', 'fw_f2', 'fw_c2', 'fw_f3', 'fw_c3', 'fw_f4', 'fw_c4',
        'uc_gpm', 'uc_mgd', 'uc_cfs', 'uc_m3d', 'uc_gal', 'uc_ft3', 'uc_m3', 'uc_acft', 'uc_psi', 'uc_fth2o', 'uc_kpa'
    ];

    // ==================== ACCORDION ====================
    function toggleCard(num) {
        const card = document.getElementById('card' + num);
        const wasOpen = card.classList.contains('open');
        
        // Close all cards
        document.querySelectorAll('.card').forEach(c => c.classList.remove('open'));
        
        // Open clicked card if it wasn't open
        if (!wasOpen) {
            card.classList.add('open');
            currentCard = num;
            updateNav();
            // Scroll to card
            setTimeout(() => {
                card.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }
        
        vibrate();
    }
    
    function goToCard(num) {
        const card = document.getElementById('card' + num);
        document.querySelectorAll('.card').forEach(c => c.classList.remove('open'));
        card.classList.add('open');
        currentCard = num;
        updateNav();
        card.scrollIntoView({ behavior: 'smooth', block: 'start' });
        vibrate();
    }
    
    function updateNav() {
        document.querySelectorAll('.nav-btn').forEach((btn, i) => {
            btn.classList.toggle('active', i + 1 === currentCard);
        });
    }

    // ==================== HAPTIC FEEDBACK ====================
    function vibrate() {
        if (navigator.vibrate) navigator.vibrate(10);
    }

    // ==================== TOAST ====================
    function showToast(message, type = '') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'toast show ' + type;
        setTimeout(() => toast.classList.remove('show'), 2000);
    }

    // ==================== COPY ====================
    function copyVal(id) {
        const text = document.getElementById(id).innerText;
        navigator.clipboard.writeText(text).then(() => {
            showToast('‚úì Copied: ' + text, 'success');
            vibrate();
        });
    }

    // ==================== CLEAR ALL ====================
    function clearAll() {
        if (confirm('Clear all values?')) {
            inputIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.value = '';
                    el.classList.remove('error');
                }
            });
            localStorage.removeItem(STORAGE_KEY);
            // Reset all results
            document.getElementById('p_res').innerText = '0.00 lbs/day';
            document.getElementById('svi_res').innerText = '0.00 mL/g';
            document.getElementById('mb_res').innerText = '0.00 mg/L';
            document.getElementById('fm_res').innerText = '0.000';
            document.getElementById('srt_res').innerText = '0.0 days';
            document.getElementById('dt_res').innerText = '0.00 hours';
            document.getElementById('eff_res').innerText = '0.0 %';
            document.getElementById('was_res').innerText = '0 GPD';
            document.getElementById('ras_res').innerText = '0.00 MGD';
            document.getElementById('olr_res').innerText = '0.0 lbs/day/1000ft¬≥';
            document.getElementById('sor_res').innerText = '0 GPD/ft¬≤';
            document.getElementById('wor_res').innerText = '0 GPD/ft';
            document.getElementById('slr_res').innerText = '0.0 lbs/day/ft¬≤';
            document.getElementById('chem_res').innerText = '0.00 lbs/day';
            document.getElementById('flux_res').innerText = '0.0 GFD';
            document.getElementById('tmp_res').innerText = '0.0 psi';
            document.getElementById('perm_res').innerText = '0.0 GFD/psi';
            document.getElementById('msize_res').innerText = '0 ft¬≤';
            document.getElementById('sad_res').innerText = '‚Äî';
            document.getElementById('mbrc_res').innerText = '‚Äî';
            document.getElementById('cip_res').innerText = '‚Äî';
            document.getElementById('salr_res').innerText = '0.0 g/m¬≤/d';
            document.getElementById('bio_res').innerText = '0 m¬≤';
            document.getElementById('mv_res').innerText = '0 m¬≥';
            document.getElementById('rsz_res').innerText = '0 m¬≥';
            document.getElementById('mdo_res').innerText = '0 lbs O‚ÇÇ/day';
            document.getElementById('cmp_res').innerText = '‚Äî';
            document.getElementById('cyc_res').innerText = '‚Äî';
            document.getElementById('sv_res').innerText = '‚Äî';
            document.getElementById('dec_res').innerText = '0 GPM';
            document.getElementById('saer_res').innerText = '‚Äî';
            document.getElementById('sfm_res').innerText = '‚Äî';
            document.getElementById('ssc_res').innerText = '‚Äî';
            document.getElementById('ct_res').innerText = '0.0 mg¬∑min/L';
            document.getElementById('dcl_res').innerText = '‚Äî';
            document.getElementById('uv_res').innerText = '0.0 mJ/cm¬≤';
            document.getElementById('slv_res').innerText = '‚Äî';
            document.getElementById('vsr_res').innerText = '0.0 %';
            document.getElementById('dig_res').innerText = '0.00 lbs VS/ft¬≥/d';
            document.getElementById('poly_res').innerText = '‚Äî';
            document.getElementById('phos_res').innerText = '‚Äî';
            document.getElementById('alk_res').innerText = '‚Äî';
            document.getElementById('nb_res').innerText = '‚Äî';
            document.getElementById('tdh_res').innerText = '0.0 ft';
            document.getElementById('pv_res').innerText = '0.0 fps';
            document.getElementById('hp_res').innerText = '‚Äî';
            document.getElementById('gm_res').innerText = '‚Äî';
            document.getElementById('fw_res').innerText = '‚Äî';
            // Reset statuses
            document.querySelectorAll('.status').forEach(s => {
                s.innerText = 'Enter data...';
                s.style.color = '#64748b';
            });
            // Reset hints
            document.querySelectorAll('.field-hint').forEach(h => h.classList.remove('error'));
            const sviHint = document.getElementById('svi_set_hint');
            if (sviHint) sviHint.textContent = 'Max 1000 mL/L';
            
            showToast('‚úì All cleared', 'success');
            vibrate();
        }
    }

    // ==================== SAVE/RESTORE ====================
    function saveData() {
        const data = {};
        inputIds.forEach(id => {
            const el = document.getElementById(id);
            if (el && el.value) data[id] = el.value;
        });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }
    
    function restoreData() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            const data = JSON.parse(saved);
            inputIds.forEach(id => {
                const el = document.getElementById(id);
                if (el && data[id]) el.value = data[id];
            });
            // Trigger all calculations
            calcPounds(); calcSVI(); calcMB(); calcFM(); calcSRT(); calcDT(); calcEff();
            calcWAS(); calcRAS(); calcOLR(); calcSOR(); calcWOR(); calcSLR(); calcChem();
            calcFlux();
            calcTMP();
            calcPerm();
            calcMSize();
            calcSAD();
            calcMBRC();
            calcCIP();
            calcSALR(); calcBioArea(); calcMediaVol(); calcRSZ(); calcMDO(); calcCMP();
            calcCycle(); calcSBRVol(); calcDecant(); calcSBRAer(); calcSBRFM(); calcSSC();
            calcCT(); calcDCL(); calcUV();
            calcSLV(); calcVSR(); calcDIG(); calcPoly();
            calcPhos(); calcALK(); calcNBal();
            calcTDH(); calcPV(); calcHP();
            calcGM(); calcFWC();
        }
    }
    
    // Auto-save on input with debounce
    let saveTimeout;
    document.addEventListener('input', () => {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(saveData, 500);
    });

    // ==================== VALIDATION ====================
    function validateInput(inputId, value, min, max, defaultHint) {
        const input = document.getElementById(inputId);
        const hintEl = document.getElementById(inputId + '_hint');
        
        if (value > max) {
            input.classList.add('error');
            if (hintEl) {
                hintEl.classList.add('error');
                hintEl.textContent = '‚ö†Ô∏è Max is ' + max;
            }
            vibrate();
            return false;
        } else if (value < min) {
            input.classList.add('error');
            if (hintEl) {
                hintEl.classList.add('error');
                hintEl.textContent = '‚ö†Ô∏è Min is ' + min;
            }
            vibrate();
            return false;
        } else {
            input.classList.remove('error');
            if (hintEl) {
                hintEl.classList.remove('error');
                hintEl.textContent = defaultHint;
            }
            return true;
        }
    }

    // ==================== CALCULATIONS ====================
    
    // 1. Pounds Formula
    function calcPounds() {
        const f = parseFloat(document.getElementById('p_flow').value) || 0;
        const c = parseFloat(document.getElementById('p_conc').value) || 0;
        const res = f * c * 8.34;
        document.getElementById('p_res').innerText = res.toFixed(2) + " lbs/day";
        const stat = document.getElementById('p_status');
        if (f > 0 && c > 0) {
            stat.innerHTML = "üìä <b>" + (c * 8.34).toFixed(1) + " lbs per MG</b> at this concentration";
            stat.style.color = "#94a3b8";
        } else {
            stat.innerText = "Enter data...";
            stat.style.color = "#64748b";
        }
    }

    // 2. SVI with validation
    function calcSVI() {
        const s = parseFloat(document.getElementById('svi_set').value) || 0;
        const m = parseFloat(document.getElementById('svi_mlss').value) || 0;
        
        // Validate settled volume (max 1000 mL/L for a settleometer)
        const valid = validateInput('svi_set', s, 0, 1000, 'Max 1000 mL/L');
        
        if (m > 0 && valid) {
            const res = (s * 1000) / m;
            document.getElementById('svi_res').innerText = res.toFixed(2) + " mL/g";
            const stat = document.getElementById('svi_status');
            
            if (res > 250) { 
                stat.innerHTML = "üö® <b>Severe Bulking</b> ‚Äì Check for Nocardia/M. parvicella. Consider RAS chlorination, reduce SRT."; 
                stat.style.color = "var(--danger)"; 
            } else if (res > 150) { 
                stat.innerHTML = "‚ö†Ô∏è <b>Bulking Sludge</b> ‚Äì Review F/M, DO levels, nutrient balance. Increase wasting."; 
                stat.style.color = "var(--accent)"; 
            } else if (res < 50) { 
                stat.innerHTML = "‚ö° <b>Pin Floc/Dispersed</b> ‚Äì Old sludge or toxic shock. Reduce SRT."; 
                stat.style.color = "var(--accent)"; 
            } else if (res < 80) { 
                stat.innerHTML = "‚ö° <b>Fast Settling</b> ‚Äì Monitor for pin floc. May indicate over-wasting."; 
                stat.style.color = "var(--primary)"; 
            } else { 
                stat.innerHTML = "‚úì <b>Optimal (80-150)</b> ‚Äì Good floc formation. Maintain operations."; 
                stat.style.color = "#4ade80"; 
            }
        } else if (!valid) {
            document.getElementById('svi_status').innerHTML = "‚ö†Ô∏è <b>Check Input</b> ‚Äì Settled volume cannot exceed 1000 mL/L";
            document.getElementById('svi_status').style.color = "var(--danger)";
        }
    }

    // 3. Mass Balance
    function calcMB() {
        const qa = parseFloat(document.getElementById('mb_qa').value) || 0;
        const ca = parseFloat(document.getElementById('mb_ca').value) || 0;
        const qb = parseFloat(document.getElementById('mb_qb').value) || 0;
        const cb = parseFloat(document.getElementById('mb_cb').value) || 0;
        
        if ((qa + qb) > 0) {
            const res = ((qa * ca) + (qb * cb)) / (qa + qb);
            document.getElementById('mb_res').innerText = res.toFixed(2) + " mg/L";
            const stat = document.getElementById('mb_status');
            const ratioA = (qa / (qa + qb) * 100).toFixed(0);
            const ratioB = (qb / (qa + qb) * 100).toFixed(0);
            stat.innerHTML = "üìä <b>Flow Mix:</b> A = " + ratioA + "% | B = " + ratioB + "%";
            stat.style.color = "#94a3b8";
        }
    }

    // 4. F/M Ratio
    function calcFM() {
        const flow = parseFloat(document.getElementById('fm_flow').value) || 0;
        const bod = parseFloat(document.getElementById('fm_bod').value) || 0;
        const vol = parseFloat(document.getElementById('fm_vol').value) || 0;
        const mlvss = parseFloat(document.getElementById('fm_mlvss').value) || 0;
        
        if (vol > 0 && mlvss > 0) {
            const res = (flow * bod) / (vol * mlvss);
            document.getElementById('fm_res').innerText = res.toFixed(3);
            const stat = document.getElementById('fm_status');
            
            if (res < 0.02) { 
                stat.innerHTML = "üö® <b>Starvation</b> ‚Äì Bacteria consuming themselves. Reduce MLSS."; 
                stat.style.color = "var(--danger)"; 
            } else if (res < 0.05) { 
                stat.innerHTML = "‚ö†Ô∏è <b>Very Low</b> ‚Äì Watch for old sludge, denitrification in clarifier."; 
                stat.style.color = "var(--accent)"; 
            } else if (res <= 0.15) { 
                stat.innerHTML = "‚úì <b>Extended Aeration (0.05-0.15)</b> ‚Äì Good nitrification potential."; 
                stat.style.color = "#4ade80"; 
            } else if (res <= 0.5) { 
                stat.innerHTML = "‚úì <b>Conventional (0.15-0.5)</b> ‚Äì Standard activated sludge."; 
                stat.style.color = "#4ade80"; 
            } else if (res <= 1.0) { 
                stat.innerHTML = "‚ö° <b>High Rate (0.5-1.0)</b> ‚Äì Short SRT, high sludge yield."; 
                stat.style.color = "var(--accent)"; 
            } else { 
                stat.innerHTML = "üö® <b>Overloaded (>1.0)</b> ‚Äì BOD breakthrough risk. Increase MLSS."; 
                stat.style.color = "var(--danger)"; 
            }
        }
    }

    // 5. SRT
    function calcSRT() {
        const vol = parseFloat(document.getElementById('srt_vol').value) || 0;
        const mlss = parseFloat(document.getElementById('srt_mlss').value) || 0;
        const wasQ = parseFloat(document.getElementById('srt_wasq').value) || 0;
        const wasC = parseFloat(document.getElementById('srt_wasc').value) || 0;
        const effQ = parseFloat(document.getElementById('srt_effq').value) || 0;
        const effC = parseFloat(document.getElementById('srt_effc').value) || 0;
        
        const sludgeIn = vol * mlss * 8.34;
        const sludgeOut = (wasQ * wasC * 8.34) + (effQ * effC * 8.34);
        
        if (sludgeOut > 0) {
            const res = sludgeIn / sludgeOut;
            document.getElementById('srt_res').innerText = res.toFixed(1) + " days";
            const stat = document.getElementById('srt_status');
            
            if (res < 2) { 
                stat.innerHTML = "üö® <b>Washout Risk</b> ‚Äì Reduce WAS immediately!"; 
                stat.style.color = "var(--danger)"; 
            } else if (res < 4) { 
                stat.innerHTML = "‚ö†Ô∏è <b>Low (2-4 days)</b> ‚Äì Young sludge, limited nitrification."; 
                stat.style.color = "var(--accent)"; 
            } else if (res < 8) { 
                stat.innerHTML = "‚úì <b>Conventional (4-8 days)</b> ‚Äì Good BOD removal."; 
                stat.style.color = "#4ade80"; 
            } else if (res <= 15) { 
                stat.innerHTML = "‚úì <b>Extended (8-15 days)</b> ‚Äì Full nitrification, stable."; 
                stat.style.color = "#4ade80"; 
            } else if (res <= 25) { 
                stat.innerHTML = "‚ö° <b>Long (15-25 days)</b> ‚Äì Watch for old sludge issues."; 
                stat.style.color = "var(--primary)"; 
            } else { 
                stat.innerHTML = "‚ö†Ô∏è <b>Excessive (>25 days)</b> ‚Äì Increase wasting."; 
                stat.style.color = "var(--accent)"; 
            }
        }
    }

    // 6. Detention Time
    function calcDT() {
        const vol = parseFloat(document.getElementById('dt_vol').value) || 0;
        const flow = parseFloat(document.getElementById('dt_flow').value) || 0;
        
        if (flow > 0) {
            const res = (vol / flow) * 24;
            document.getElementById('dt_res').innerText = res.toFixed(2) + " hours";
            const stat = document.getElementById('dt_status');
            
            if (res < 2) { 
                stat.innerHTML = "‚ö° <b>Very Short (<2 hrs)</b> ‚Äì Contact tank or high-rate process."; 
                stat.style.color = "var(--accent)"; 
            } else if (res < 4) { 
                stat.innerHTML = "‚úì <b>Clarifier Range (2-4 hrs)</b> ‚Äì Typical for secondary clarifiers."; 
                stat.style.color = "#4ade80"; 
            } else if (res < 8) { 
                stat.innerHTML = "‚úì <b>Conventional (4-8 hrs)</b> ‚Äì Standard aeration basin."; 
                stat.style.color = "#4ade80"; 
            } else if (res <= 24) { 
                stat.innerHTML = "‚úì <b>Extended (8-24 hrs)</b> ‚Äì Good for nitrification."; 
                stat.style.color = "#4ade80"; 
            } else if (res <= 48) { 
                stat.innerHTML = "‚ö° <b>Long (24-48 hrs)</b> ‚Äì EQ basin or oxidation ditch."; 
                stat.style.color = "var(--primary)"; 
            } else { 
                stat.innerHTML = "‚ö†Ô∏è <b>Very Long (>48 hrs)</b> ‚Äì Lagoon range."; 
                stat.style.color = "var(--accent)"; 
            }
        }
    }

    // 7. Removal Efficiency
    function calcEff() {
        const inf = parseFloat(document.getElementById('eff_in').value) || 0;
        const eff = parseFloat(document.getElementById('eff_out').value) || 0;
        
        if (inf > 0) {
            const res = ((inf - eff) / inf) * 100;
            document.getElementById('eff_res').innerText = res.toFixed(1) + " %";
            const stat = document.getElementById('eff_status');
            
            if (res >= 95) { 
                stat.innerHTML = "üåü <b>Excellent (‚â•95%)</b> ‚Äì Outstanding performance."; 
                stat.style.color = "#4ade80"; 
            } else if (res >= 90) { 
                stat.innerHTML = "‚úì <b>Very Good (90-95%)</b> ‚Äì Exceeds most permits."; 
                stat.style.color = "#4ade80"; 
            } else if (res >= 85) { 
                stat.innerHTML = "‚úì <b>Good (85-90%)</b> ‚Äì Meeting standard goals."; 
                stat.style.color = "#4ade80"; 
            } else if (res >= 75) { 
                stat.innerHTML = "‚ö° <b>Moderate (75-85%)</b> ‚Äì Review for optimization."; 
                stat.style.color = "var(--accent)"; 
            } else if (res >= 50) { 
                stat.innerHTML = "‚ö†Ô∏è <b>Below Target (50-75%)</b> ‚Äì Investigate cause."; 
                stat.style.color = "var(--danger)"; 
            } else if (res >= 0) { 
                stat.innerHTML = "üö® <b>Poor (<50%)</b> ‚Äì Process upset likely."; 
                stat.style.color = "var(--danger)"; 
            } else { 
                stat.innerHTML = "üö® <b>Negative</b> ‚Äì Effluent worse than influent!"; 
                stat.style.color = "var(--danger)"; 
            }
        }
    }

    // 8. WAS Pumping Rate
    function calcWAS() {
        const vol = parseFloat(document.getElementById('was_vol').value) || 0;
        const mlss = parseFloat(document.getElementById('was_mlss').value) || 0;
        const srt = parseFloat(document.getElementById('was_srt').value) || 0;
        const conc = parseFloat(document.getElementById('was_conc').value) || 0;
        
        if (srt > 0 && conc > 0) {
            // WAS Flow (MG) = (Vol √ó MLSS) √∑ (SRT √ó WAS Conc)
            const wasMGD = (vol * mlss) / (srt * conc);
            const wasGPD = wasMGD * 1000000;
            document.getElementById('was_res').innerText = wasGPD.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPD";
            const stat = document.getElementById('was_status');
            const wasGPM = wasGPD / 1440;
            stat.innerHTML = "üìä <b>" + wasGPM.toFixed(1) + " GPM</b> continuous, or <b>" + (wasGPM * 2).toFixed(1) + " GPM</b> for 12 hrs/day";
            stat.style.color = "#94a3b8";
        }
    }

    // 9. RAS Return Rate
    function calcRAS() {
        const flow = parseFloat(document.getElementById('ras_flow').value) || 0;
        const mlss = parseFloat(document.getElementById('ras_mlss').value) || 0;
        const conc = parseFloat(document.getElementById('ras_conc').value) || 0;
        
        if (conc > mlss && conc > 0) {
            // RAS = (Q √ó MLSS) √∑ (RAS Conc - MLSS)
            const ras = (flow * mlss) / (conc - mlss);
            document.getElementById('ras_res').innerText = ras.toFixed(3) + " MGD";
            const stat = document.getElementById('ras_status');
            const ratio = (ras / flow * 100).toFixed(0);
            if (ratio < 25) {
                stat.innerHTML = "‚ö° <b>" + ratio + "% RAS Ratio</b> ‚Äì Low return rate. Verify blanket depth.";
                stat.style.color = "var(--accent)";
            } else if (ratio <= 100) {
                stat.innerHTML = "‚úì <b>" + ratio + "% RAS Ratio</b> ‚Äì Normal operating range (25-100%).";
                stat.style.color = "#4ade80";
            } else {
                stat.innerHTML = "‚ö†Ô∏è <b>" + ratio + "% RAS Ratio</b> ‚Äì High return. Check RAS concentration.";
                stat.style.color = "var(--accent)";
            }
        } else if (conc <= mlss && conc > 0) {
            document.getElementById('ras_status').innerHTML = "‚ö†Ô∏è <b>Check Values</b> ‚Äì RAS conc must be higher than MLSS";
            document.getElementById('ras_status').style.color = "var(--danger)";
        }
    }

    // 10. Organic Loading Rate
    function calcOLR() {
        const flow = parseFloat(document.getElementById('olr_flow').value) || 0;
        const bod = parseFloat(document.getElementById('olr_bod').value) || 0;
        const vol = parseFloat(document.getElementById('olr_vol').value) || 0;
        
        if (vol > 0) {
            // OLR = (Flow √ó BOD √ó 8.34) √∑ Volume (1000 ft¬≥)
            const olr = (flow * bod * 8.34) / vol;
            document.getElementById('olr_res').innerText = olr.toFixed(1) + " lbs/day/1000ft¬≥";
            const stat = document.getElementById('olr_status');
            
            if (olr < 5) {
                stat.innerHTML = "‚ö° <b>Low Rate (<5)</b> ‚Äì Under-loaded, may have operational issues.";
                stat.style.color = "var(--accent)";
            } else if (olr <= 25) {
                stat.innerHTML = "‚úì <b>Low-Rate TF (5-25)</b> ‚Äì Standard trickling filter range.";
                stat.style.color = "#4ade80";
            } else if (olr <= 100) {
                stat.innerHTML = "‚úì <b>High-Rate TF (25-100)</b> ‚Äì Higher loading, needs recirculation.";
                stat.style.color = "#4ade80";
            } else if (olr <= 300) {
                stat.innerHTML = "‚ö° <b>Roughing Filter (100-300)</b> ‚Äì Very high rate, partial treatment only.";
                stat.style.color = "var(--accent)";
            } else {
                stat.innerHTML = "‚ö†Ô∏è <b>Overloaded (>300)</b> ‚Äì Exceeds typical design limits.";
                stat.style.color = "var(--danger)";
            }
        }
    }

    // 11. Surface Overflow Rate
    function calcSOR() {
        const flow = parseFloat(document.getElementById('sor_flow').value) || 0;
        const area = parseFloat(document.getElementById('sor_area').value) || 0;
        
        if (area > 0) {
            const sor = flow / area;
            document.getElementById('sor_res').innerText = sor.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPD/ft¬≤";
            const stat = document.getElementById('sor_status');
            
            if (sor < 300) {
                stat.innerHTML = "‚ö° <b>Very Low (<300)</b> ‚Äì Under-utilized clarifier.";
                stat.style.color = "var(--primary)";
            } else if (sor <= 600) {
                stat.innerHTML = "‚úì <b>Primary SOR (300-600)</b> ‚Äì Good for primary settling.";
                stat.style.color = "#4ade80";
            } else if (sor <= 800) {
                stat.innerHTML = "‚úì <b>Secondary SOR (400-800)</b> ‚Äì Typical for activated sludge.";
                stat.style.color = "#4ade80";
            } else if (sor <= 1200) {
                stat.innerHTML = "‚ö†Ô∏è <b>High (800-1200)</b> ‚Äì Peak flow range. Monitor effluent TSS.";
                stat.style.color = "var(--accent)";
            } else {
                stat.innerHTML = "üö® <b>Overloaded (>1200)</b> ‚Äì Risk of solids carryover.";
                stat.style.color = "var(--danger)";
            }
        }
    }

    // 12. Weir Overflow Rate
    function calcWOR() {
        const flow = parseFloat(document.getElementById('wor_flow').value) || 0;
        const len = parseFloat(document.getElementById('wor_len').value) || 0;
        
        if (len > 0) {
            const wor = flow / len;
            document.getElementById('wor_res').innerText = wor.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPD/ft";
            const stat = document.getElementById('wor_status');
            
            if (wor <= 10000) {
                stat.innerHTML = "‚úì <b>Excellent (‚â§10,000)</b> ‚Äì Low turbulence, good settling.";
                stat.style.color = "#4ade80";
            } else if (wor <= 15000) {
                stat.innerHTML = "‚úì <b>Good (10,000-15,000)</b> ‚Äì Acceptable for most clarifiers.";
                stat.style.color = "#4ade80";
            } else if (wor <= 20000) {
                stat.innerHTML = "‚ö†Ô∏è <b>High (15,000-20,000)</b> ‚Äì May cause turbulence. Monitor TSS.";
                stat.style.color = "var(--accent)";
            } else {
                stat.innerHTML = "üö® <b>Excessive (>20,000)</b> ‚Äì Risk of floc disruption and carryover.";
                stat.style.color = "var(--danger)";
            }
        }
    }

    // 13. Solids Loading Rate
    function calcSLR() {
        const flow = parseFloat(document.getElementById('slr_flow').value) || 0;
        const mlss = parseFloat(document.getElementById('slr_mlss').value) || 0;
        const area = parseFloat(document.getElementById('slr_area').value) || 0;
        
        if (area > 0) {
            // SLR = (Flow √ó MLSS √ó 8.34) √∑ Area
            const slr = (flow * mlss * 8.34) / area;
            document.getElementById('slr_res').innerText = slr.toFixed(2) + " lbs/day/ft¬≤";
            const stat = document.getElementById('slr_status');
            
            if (slr < 10) {
                stat.innerHTML = "‚ö° <b>Low (<10)</b> ‚Äì Under-loaded clarifier. Good settling expected.";
                stat.style.color = "var(--primary)";
            } else if (slr <= 25) {
                stat.innerHTML = "‚úì <b>Normal (10-25)</b> ‚Äì Typical for secondary clarifiers.";
                stat.style.color = "#4ade80";
            } else if (slr <= 35) {
                stat.innerHTML = "‚ö†Ô∏è <b>High (25-35)</b> ‚Äì Peak flow range. Watch blanket depth.";
                stat.style.color = "var(--accent)";
            } else {
                stat.innerHTML = "üö® <b>Overloaded (>35)</b> ‚Äì Risk of solids loss. Reduce RAS or increase area.";
                stat.style.color = "var(--danger)";
            }
        }
    }

    // 14. Chemical Dosing
    function calcChem() {
        const flow = parseFloat(document.getElementById('chem_flow').value) || 0;
        const dose = parseFloat(document.getElementById('chem_dose').value) || 0;
        const purity = parseFloat(document.getElementById('chem_purity').value) || 100;
        
        if (purity > 0) {
            // lbs/day = (Flow √ó Dose √ó 8.34) √∑ (Purity/100)
            const lbs = (flow * dose * 8.34) / (purity / 100);
            document.getElementById('chem_res').innerText = lbs.toFixed(2) + " lbs/day";
            const stat = document.getElementById('chem_status');
            const gallons = lbs / 8.34; // Approximate for liquids
            stat.innerHTML = "üìä <b>" + lbs.toFixed(1) + " lbs/day</b> of chemical product | ~" + gallons.toFixed(1) + " gal/day if liquid";
            stat.style.color = "#94a3b8";
        }
    }

    // ==================== MBR CALCULATIONS ====================

    // 15. Membrane Flux Rate
    function calcFlux() {
        const flow = parseFloat(document.getElementById('flux_flow').value) || 0;
        const area = parseFloat(document.getElementById('flux_area').value) || 0;
        
        if (area > 0) {
            const gfd = flow / area;
            document.getElementById('flux_res').innerText = gfd.toFixed(1) + " GFD";
            const stat = document.getElementById('flux_status');
            
            // Also show LMH for international reference
            const lmh = gfd * 1.6985;
            
            if (gfd < 5) {
                stat.innerHTML = "üö® <b>Very Low (<5 GFD)</b> ‚Äì Severe fouling likely. Initiate recovery clean (CIP). Check TMP.";
                stat.style.color = "var(--danger)";
            } else if (gfd < 8) {
                stat.innerHTML = "‚ö†Ô∏è <b>Low (5‚Äì8 GFD)</b> ‚Äì Fouling developing. Schedule maintenance clean. (" + lmh.toFixed(1) + " LMH)";
                stat.style.color = "var(--accent)";
            } else if (gfd <= 15) {
                stat.innerHTML = "‚úì <b>Normal (8‚Äì15 GFD)</b> ‚Äì Healthy operating range. (" + lmh.toFixed(1) + " LMH)";
                stat.style.color = "#4ade80";
            } else if (gfd <= 25) {
                stat.innerHTML = "‚ö° <b>High (15‚Äì25 GFD)</b> ‚Äì Peak flow range acceptable short-term. (" + lmh.toFixed(1) + " LMH)";
                stat.style.color = "var(--accent)";
            } else {
                stat.innerHTML = "üö® <b>Excessive (>25 GFD)</b> ‚Äì Risk of irreversible membrane damage. Reduce flow immediately.";
                stat.style.color = "var(--danger)";
            }
        }
    }

    // 16. Transmembrane Pressure
    function calcTMP() {
        const feed = parseFloat(document.getElementById('tmp_feed').value) || 0;
        const perm = parseFloat(document.getElementById('tmp_perm').value) || 0;
        
        if (feed > 0 || perm > 0) {
            const tmp = feed - perm;
            const kpa = tmp * 6.895;
            document.getElementById('tmp_res').innerText = tmp.toFixed(1) + " psi";
            const stat = document.getElementById('tmp_status');
            
            if (tmp < 0) {
                stat.innerHTML = "‚ö†Ô∏è <b>Negative TMP</b> ‚Äì Check pressure gauge readings. Feed should be > Permeate.";
                stat.style.color = "var(--danger)";
            } else if (tmp <= 3) {
                stat.innerHTML = "‚úì <b>Excellent (0‚Äì3 psi)</b> ‚Äì Clean membranes, low resistance. (" + kpa.toFixed(1) + " kPa)";
                stat.style.color = "#4ade80";
            } else if (tmp <= 7) {
                stat.innerHTML = "‚úì <b>Normal (3‚Äì7 psi)</b> ‚Äì Typical operating range. Monitor trend. (" + kpa.toFixed(1) + " kPa)";
                stat.style.color = "#4ade80";
            } else if (tmp <= 12) {
                stat.innerHTML = "‚ö†Ô∏è <b>Elevated (7‚Äì12 psi)</b> ‚Äì Fouling developing. Schedule maintenance clean. (" + kpa.toFixed(1) + " kPa)";
                stat.style.color = "var(--accent)";
            } else {
                stat.innerHTML = "üö® <b>High (>12 psi)</b> ‚Äì Recovery CIP required. Risk of membrane damage if sustained. (" + kpa.toFixed(1) + " kPa)";
                stat.style.color = "var(--danger)";
            }
        }
    }

    // 17. Membrane Permeability
    function calcPerm() {
        const flux = parseFloat(document.getElementById('perm_flux').value) || 0;
        const tmp = parseFloat(document.getElementById('perm_tmp').value) || 0;
        
        if (tmp > 0) {
            const perm = flux / tmp;
            const lmhBar = perm * 1.6985 / 0.0689476; // Convert GFD/psi to LMH/bar
            document.getElementById('perm_res').innerText = perm.toFixed(2) + " GFD/psi";
            const stat = document.getElementById('perm_status');
            
            if (perm >= 5) {
                stat.innerHTML = "‚úì <b>Excellent (‚â•5)</b> ‚Äì Clean membrane performance. (" + lmhBar.toFixed(1) + " LMH/bar)";
                stat.style.color = "#4ade80";
            } else if (perm >= 3) {
                stat.innerHTML = "‚úì <b>Good (3‚Äì5)</b> ‚Äì Normal operating condition. (" + lmhBar.toFixed(1) + " LMH/bar)";
                stat.style.color = "#4ade80";
            } else if (perm >= 1.5) {
                stat.innerHTML = "‚ö†Ô∏è <b>Declining (1.5‚Äì3)</b> ‚Äì Fouling progressing. Plan maintenance clean. (" + lmhBar.toFixed(1) + " LMH/bar)";
                stat.style.color = "var(--accent)";
            } else {
                stat.innerHTML = "üö® <b>Poor (<1.5)</b> ‚Äì Significant fouling. Recovery CIP required. (" + lmhBar.toFixed(1) + " LMH/bar)";
                stat.style.color = "var(--danger)";
            }
        } else if (flux > 0 && tmp === 0) {
            document.getElementById('perm_status').innerHTML = "‚ö†Ô∏è TMP cannot be zero ‚Äî enter measured pressure.";
            document.getElementById('perm_status').style.color = "var(--danger)";
        }
    }

    // 18. Membrane Area Sizing
    function calcMSize() {
        const flow = parseFloat(document.getElementById('msize_flow').value) || 0;
        const pf = parseFloat(document.getElementById('msize_pf').value) || 0;
        const avgFlux = parseFloat(document.getElementById('msize_flux').value) || 0;
        const peakFlux = parseFloat(document.getElementById('msize_peak').value) || 0;
        
        if (flow > 0 && avgFlux > 0) {
            const flowGPD = flow * 1000000;
            const areaAvg = flowGPD / avgFlux;
            let areaPeak = 0;
            let peakCheck = "";
            
            if (pf > 0 && peakFlux > 0) {
                areaPeak = (flowGPD * pf) / peakFlux;
                const actualPeakFlux = (flowGPD * pf) / areaAvg;
                if (actualPeakFlux > 25) {
                    peakCheck = "<br>‚ö†Ô∏è Peak flux on avg-sized area = " + actualPeakFlux.toFixed(1) + " GFD ‚Äî exceeds 25 GFD limit!";
                } else {
                    peakCheck = "<br>‚úì Peak flux on avg-sized area = " + actualPeakFlux.toFixed(1) + " GFD ‚Äî within limits.";
                }
            }
            
            const designArea = Math.max(areaAvg, areaPeak);
            const fmt = designArea.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            document.getElementById('msize_res').innerText = fmt + " ft¬≤";
            const stat = document.getElementById('msize_status');
            
            stat.innerHTML = "üìä <b>Avg design:</b> " + areaAvg.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " ft¬≤" +
                (areaPeak > 0 ? " | <b>Peak design:</b> " + areaPeak.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " ft¬≤" : "") +
                peakCheck + "<br>Governing area: <b>" + fmt + " ft¬≤</b> (" + (designArea / 1000).toFixed(1) + "k ft¬≤)";
            stat.style.color = "#94a3b8";
        }
    }

    // 19. Specific Aeration Demand
    function calcSAD() {
        const air = parseFloat(document.getElementById('sad_air').value) || 0;
        const area = parseFloat(document.getElementById('sad_area').value) || 0;
        const perm = parseFloat(document.getElementById('sad_perm').value) || 0;
        
        if (air > 0 && (area > 0 || perm > 0)) {
            let results = [];
            let sadmVal = 0, sadpVal = 0;
            const stat = document.getElementById('sad_status');
            
            if (area > 0) {
                sadmVal = air / area;
                results.push("SADm = " + sadmVal.toFixed(3) + " Nm¬≥/m¬≤/hr");
            }
            if (perm > 0) {
                sadpVal = air / perm;
                results.push("SADp = " + sadpVal.toFixed(1) + " m¬≥air/m¬≥perm");
            }
            
            document.getElementById('sad_res').innerText = results.join(" | ");
            
            let assessment = [];
            if (sadmVal > 0) {
                if (sadmVal < 0.2) assessment.push("‚ö° SADm very low ‚Äî verify adequate scouring");
                else if (sadmVal <= 0.5) assessment.push("‚úì SADm in hollow fiber range (0.2‚Äì0.5)");
                else if (sadmVal <= 1.0) assessment.push("‚úì SADm in flat sheet range (0.5‚Äì1.0)");
                else assessment.push("‚ö†Ô∏è SADm high ‚Äî excessive air scouring energy");
            }
            if (sadpVal > 0) {
                if (sadpVal < 10) assessment.push("‚úì SADp efficient (<10)");
                else if (sadpVal <= 25) assessment.push("‚úì SADp typical (10‚Äì25)");
                else assessment.push("‚ö†Ô∏è SADp high (>25) ‚Äî energy optimization opportunity");
            }
            
            stat.innerHTML = assessment.join("<br>");
            stat.style.color = (sadmVal > 1.0 || sadpVal > 25) ? "var(--accent)" : "#4ade80";
        }
    }

    // 20. MBR Operating Range Check
    function calcMBRC() {
        const mlss = parseFloat(document.getElementById('mbrc_mlss').value) || 0;
        const srt = parseFloat(document.getElementById('mbrc_srt').value) || 0;
        const fm = parseFloat(document.getElementById('mbrc_fm').value) || 0;
        const doVal = parseFloat(document.getElementById('mbrc_do').value) || 0;
        
        let checks = [];
        let issues = 0;
        let entered = 0;
        
        if (mlss > 0) {
            entered++;
            if (mlss < 6000) { checks.push("üö® <b>MLSS " + mlss + "</b> ‚Äì Too low for MBR. Target 8,000‚Äì12,000 mg/L."); issues++; }
            else if (mlss < 8000) { checks.push("‚ö†Ô∏è <b>MLSS " + mlss + "</b> ‚Äì Below MBR range. May reduce membrane protection."); issues++; }
            else if (mlss <= 12000) { checks.push("‚úì <b>MLSS " + mlss + "</b> ‚Äì Within MBR range (8,000‚Äì12,000)."); }
            else if (mlss <= 15000) { checks.push("‚ö†Ô∏è <b>MLSS " + mlss + "</b> ‚Äì High. Increases viscosity & TMP."); issues++; }
            else { checks.push("üö® <b>MLSS " + mlss + "</b> ‚Äì Excessive. Rapid fouling risk. Increase wasting."); issues++; }
        }
        
        if (srt > 0) {
            entered++;
            if (srt < 10) { checks.push("üö® <b>SRT " + srt + "d</b> ‚Äì Too low for MBR. Target 15‚Äì40 days."); issues++; }
            else if (srt < 15) { checks.push("‚ö†Ô∏è <b>SRT " + srt + "d</b> ‚Äì Below typical MBR. May lose nitrifiers."); issues++; }
            else if (srt <= 40) { checks.push("‚úì <b>SRT " + srt + "d</b> ‚Äì Within MBR range (15‚Äì40 days)."); }
            else { checks.push("‚ö†Ô∏è <b>SRT " + srt + "d</b> ‚Äì Very high. Risk of EPS buildup & fouling."); issues++; }
        }
        
        if (fm > 0) {
            entered++;
            if (fm < 0.04) { checks.push("‚ö†Ô∏è <b>F:M " + fm + "</b> ‚Äì Very low. Endogenous conditions, possible pin floc."); issues++; }
            else if (fm <= 0.15) { checks.push("‚úì <b>F:M " + fm + "</b> ‚Äì Within MBR range (0.05‚Äì0.15)."); }
            else if (fm <= 0.25) { checks.push("‚ö†Ô∏è <b>F:M " + fm + "</b> ‚Äì High for MBR. More typical of CAS."); issues++; }
            else { checks.push("üö® <b>F:M " + fm + "</b> ‚Äì Exceeds MBR range. This is CAS territory (>0.2)."); issues++; }
        }
        
        if (doVal > 0) {
            entered++;
            if (doVal < 0.5) { checks.push("üö® <b>DO " + doVal + "</b> ‚Äì Critically low. Risk of filaments & poor nitrification."); issues++; }
            else if (doVal < 1.0) { checks.push("‚ö†Ô∏è <b>DO " + doVal + "</b> ‚Äì Below MBR minimum. Increase aeration."); issues++; }
            else if (doVal <= 3.0) { checks.push("‚úì <b>DO " + doVal + "</b> ‚Äì Within MBR range (1.0‚Äì3.0 mg/L)."); }
            else { checks.push("‚ö° <b>DO " + doVal + "</b> ‚Äì Higher than needed. Energy savings opportunity."); }
        }
        
        if (entered > 0) {
            const score = entered - issues;
            document.getElementById('mbrc_res').innerText = score + "/" + entered + " In Range";
            const stat = document.getElementById('mbrc_status');
            stat.innerHTML = checks.join("<br>");
            stat.style.color = issues === 0 ? "#4ade80" : (issues >= entered/2 ? "var(--danger)" : "var(--accent)");
        }
    }

    // 21. CIP Chemical Dosing
    function calcCIP() {
        const vol = parseFloat(document.getElementById('cip_vol').value) || 0;
        const naclTarget = parseFloat(document.getElementById('cip_nacl').value) || 0;
        const bleachPct = parseFloat(document.getElementById('cip_bleach').value) || 0;
        const citTarget = parseFloat(document.getElementById('cip_citric').value) || 0;
        const citPct = parseFloat(document.getElementById('cip_cstr').value) || 0;
        
        if (vol > 0) {
            let results = [];
            let details = [];
            const volLiters = vol * 3.785;
            
            // NaOCl calculation
            if (naclTarget > 0 && bleachPct > 0) {
                // Volume (gal) = (Tank gal √ó Target mg/L) √∑ (Strength% √ó 10,000)
                const naclGal = (vol * naclTarget) / (bleachPct * 10000);
                const naclOz = naclGal * 128;
                results.push("NaOCl: " + naclGal.toFixed(2) + " gal");
                
                let cleanType = "";
                if (naclTarget <= 500) cleanType = "Maintenance Clean range";
                else if (naclTarget <= 2000) cleanType = "Recovery Clean range";
                else cleanType = "‚ö†Ô∏è Exceeds typical ‚Äî verify with membrane manufacturer";
                
                details.push("üß™ <b>NaOCl:</b> " + naclGal.toFixed(2) + " gal (" + naclOz.toFixed(0) + " fl oz) of " + bleachPct + "% bleach ‚Üí " + naclTarget + " mg/L ‚Äî " + cleanType);
            }
            
            // Citric acid calculation
            if (citTarget > 0 && citPct > 0) {
                const citGal = (vol * citTarget) / (citPct * 10000);
                const citLbs = citGal * 8.34 * (citPct / 100);
                results.push("Citric: " + citGal.toFixed(2) + " gal");
                
                let cleanType = "";
                if (citTarget <= 2000) cleanType = "Maintenance Clean range";
                else if (citTarget <= 5000) cleanType = "Recovery Clean range";
                else cleanType = "‚ö†Ô∏è Exceeds typical ‚Äî verify dosage";
                
                details.push("üß™ <b>Citric Acid:</b> " + citGal.toFixed(2) + " gal of " + citPct + "% solution ‚Üí " + citTarget + " mg/L ‚Äî " + cleanType);
            }
            
            if (results.length > 0) {
                document.getElementById('cip_res').innerText = results.join(" | ");
                const stat = document.getElementById('cip_status');
                details.push("<br>‚ö†Ô∏è <b>Safety:</b> Never mix NaOCl and citric acid. Rinse between steps. Soak 4‚Äì6 hrs typical.");
                stat.innerHTML = details.join("<br>");
                stat.style.color = "#94a3b8";
            }
        }
    }

    // ==================== MBBR CALCULATIONS ====================

    // 22. Surface Area Loading Rate
    function calcSALR() {
        const flow = parseFloat(document.getElementById('salr_flow').value) || 0;
        const conc = parseFloat(document.getElementById('salr_conc').value) || 0;
        const area = parseFloat(document.getElementById('salr_area').value) || 0;
        
        if (area > 0 && flow > 0 && conc > 0) {
            // Load (g/day) = Flow (MGD) √ó Conc (mg/L) √ó 3,785,412 (L/MG) / 1000 (mg/g)
            // SALR = Load / Area
            const loadGday = flow * conc * 3785.412;
            const salr = loadGday / area;
            document.getElementById('salr_res').innerText = salr.toFixed(1) + " g/m¬≤/d";
            const stat = document.getElementById('salr_status');
            
            const loadLbs = flow * conc * 8.34;
            
            if (conc > 50) {
                // BOD loading interpretation
                if (salr < 5) {
                    stat.innerHTML = "‚ö° <b>Low SALR (<5)</b> ‚Äì Under-loaded biofilm. Media may be oversized. Load: " + loadLbs.toFixed(0) + " lbs/day";
                    stat.style.color = "var(--primary)";
                } else if (salr <= 10) {
                    stat.innerHTML = "‚úì <b>Moderate (5‚Äì10)</b> ‚Äì Conservative BOD removal. Good for cold climate. Load: " + loadLbs.toFixed(0) + " lbs/day";
                    stat.style.color = "#4ade80";
                } else if (salr <= 20) {
                    stat.innerHTML = "‚úì <b>Typical (10‚Äì20)</b> ‚Äì Standard BOD removal range. Load: " + loadLbs.toFixed(0) + " lbs/day";
                    stat.style.color = "#4ade80";
                } else {
                    stat.innerHTML = "‚ö†Ô∏è <b>High (>20)</b> ‚Äì May exceed biofilm capacity. Check effluent quality. Load: " + loadLbs.toFixed(0) + " lbs/day";
                    stat.style.color = "var(--accent)";
                }
            } else {
                // NH3 loading interpretation
                if (salr < 0.5) {
                    stat.innerHTML = "‚ö° <b>Low (<0.5)</b> ‚Äì Under-loaded for nitrification. Load: " + loadLbs.toFixed(1) + " lbs/day";
                    stat.style.color = "var(--primary)";
                } else if (salr <= 1.5) {
                    stat.innerHTML = "‚úì <b>Typical (0.5‚Äì1.5)</b> ‚Äì Standard nitrification range. Load: " + loadLbs.toFixed(1) + " lbs/day";
                    stat.style.color = "#4ade80";
                } else {
                    stat.innerHTML = "‚ö†Ô∏è <b>High (>1.5)</b> ‚Äì May need additional area for full nitrification. Load: " + loadLbs.toFixed(1) + " lbs/day";
                    stat.style.color = "var(--accent)";
                }
            }
        }
    }

    // 23. Effective Biofilm Area
    function calcBioArea() {
        const vol = parseFloat(document.getElementById('bio_vol').value) || 0;
        const fill = parseFloat(document.getElementById('bio_fill').value) || 0;
        const ssa = parseFloat(document.getElementById('bio_ssa').value) || 0;
        
        if (vol > 0 && fill > 0 && ssa > 0) {
            const volM3 = vol * 0.0283168; // ft¬≥ to m¬≥
            const mediaM3 = volM3 * (fill / 100);
            const area = mediaM3 * ssa;
            const fmt = area.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            document.getElementById('bio_res').innerText = fmt + " m¬≤";
            const stat = document.getElementById('bio_status');
            
            const areaFt2 = area * 10.764;
            
            let fillCheck = "";
            if (fill < 40) fillCheck = "‚ö†Ô∏è Fill below 40% ‚Äî under-utilizing reactor volume.";
            else if (fill <= 67) fillCheck = "‚úì Fill " + fill + "% within design range (40‚Äì67%).";
            else fillCheck = "üö® Fill " + fill + "% exceeds 67% max ‚Äî media cannot circulate properly!";
            
            stat.innerHTML = "üìä <b>" + fmt + " m¬≤</b> (" + areaFt2.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " ft¬≤) protected biofilm area" +
                "<br>Media volume: " + mediaM3.toFixed(1) + " m¬≥ (" + (mediaM3 * 35.3147).toFixed(0) + " ft¬≥)" +
                "<br>" + fillCheck;
            stat.style.color = fill > 67 ? "var(--danger)" : "#4ade80";
        }
    }

    // 24. Media Fill Volume
    function calcMediaVol() {
        const flow = parseFloat(document.getElementById('mv_flow').value) || 0;
        const conc = parseFloat(document.getElementById('mv_conc').value) || 0;
        const salr = parseFloat(document.getElementById('mv_salr').value) || 0;
        const ssa = parseFloat(document.getElementById('mv_ssa').value) || 0;
        
        if (flow > 0 && conc > 0 && salr > 0 && ssa > 0) {
            const loadGday = flow * conc * 3785.412;
            const reqArea = loadGday / salr;
            const mediaVol = reqArea / ssa;
            const mediaFt3 = mediaVol * 35.3147;
            document.getElementById('mv_res').innerText = mediaVol.toFixed(1) + " m¬≥";
            const stat = document.getElementById('mv_status');
            
            // Show reactor sizes at different fill fractions
            const r50 = mediaVol / 0.50;
            const r55 = mediaVol / 0.55;
            const r60 = mediaVol / 0.60;
            
            stat.innerHTML = "üìä Required biofilm area: <b>" + reqArea.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " m¬≤</b>" +
                "<br>Media volume: <b>" + mediaVol.toFixed(1) + " m¬≥</b> (" + mediaFt3.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " ft¬≥)" +
                "<br>Reactor needed @ 50% fill: " + r50.toFixed(1) + " m¬≥ | 55%: " + r55.toFixed(1) + " m¬≥ | 60%: " + r60.toFixed(1) + " m¬≥";
            stat.style.color = "#94a3b8";
        }
    }

    // 25. MBBR Reactor Sizing
    function calcRSZ() {
        const media = parseFloat(document.getElementById('rsz_media').value) || 0;
        const fill = parseFloat(document.getElementById('rsz_fill').value) || 0;
        const flow = parseFloat(document.getElementById('rsz_flow').value) || 0;
        
        if (media > 0 && fill > 0) {
            const reactor = media / (fill / 100);
            const reactorFt3 = reactor * 35.3147;
            const reactorGal = reactor * 264.172;
            document.getElementById('rsz_res').innerText = reactor.toFixed(1) + " m¬≥";
            const stat = document.getElementById('rsz_status');
            
            let hrtInfo = "";
            if (flow > 0) {
                const flowM3hr = flow * 3785.412 / 24;
                const hrt = reactor / flowM3hr;
                hrtInfo = "<br>HRT: <b>" + hrt.toFixed(1) + " hrs</b>";
                if (hrt < 1) hrtInfo += " ‚Äî ‚ö†Ô∏è Very short, may need larger reactor";
                else if (hrt <= 3) hrtInfo += " ‚Äî Typical for BOD removal";
                else if (hrt <= 6) hrtInfo += " ‚Äî Good for nitrification";
                else hrtInfo += " ‚Äî Long HRT, may be oversized";
            }
            
            let fillCheck = "";
            if (fill > 67) fillCheck = "<br>üö® Fill " + fill + "% exceeds 67% max ‚Äî media cannot circulate!";
            else if (fill < 40) fillCheck = "<br>‚ö†Ô∏è Fill " + fill + "% below 40% ‚Äî reactor volume under-utilized";
            else fillCheck = "<br>‚úì Fill " + fill + "% in design range";
            
            stat.innerHTML = "üìä Reactor: <b>" + reactor.toFixed(1) + " m¬≥</b> (" + reactorFt3.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " ft¬≥ | " + 
                reactorGal.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " gal)" + hrtInfo + fillCheck;
            stat.style.color = fill > 67 ? "var(--danger)" : "#4ade80";
        }
    }

    // 26. MBBR Dissolved Oxygen Demand
    function calcMDO() {
        const flow = parseFloat(document.getElementById('mdo_flow').value) || 0;
        const bod = parseFloat(document.getElementById('mdo_bod').value) || 0;
        const nh3 = parseFloat(document.getElementById('mdo_nh3').value) || 0;
        
        if (flow > 0 && (bod > 0 || nh3 > 0)) {
            const o2bod = flow * bod * 8.34 * 1.5;
            const o2nh3 = flow * nh3 * 8.34 * 4.6;
            const total = o2bod + o2nh3;
            document.getElementById('mdo_res').innerText = total.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs O‚ÇÇ/day";
            const stat = document.getElementById('mdo_status');
            
            const totalKg = total / 2.205;
            
            stat.innerHTML = "üìä <b>BOD oxidation:</b> " + o2bod.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs/day (1.5√ó BOD removed)" +
                "<br><b>Nitrification:</b> " + o2nh3.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs/day (4.6√ó NH‚ÇÉ-N oxidized)" +
                "<br><b>Total:</b> " + total.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs/day (" + totalKg.toFixed(0) + " kg/day)" +
                "<br>‚ö° Maintain DO ‚â• 4 mg/L in MBBR zone (vs ~2 mg/L for CAS)";
            stat.style.color = "#94a3b8";
        }
    }

    // 27. MBBR vs CAS Comparison
    function calcCMP() {
        const flow = parseFloat(document.getElementById('cmp_flow').value) || 0;
        const bod = parseFloat(document.getElementById('cmp_bod').value) || 0;
        
        if (flow > 0 && bod > 0) {
            // CAS assumptions: F:M=0.3, MLSS=3000 mg/L
            const casLoad = flow * bod * 8.34;
            const casVol = (casLoad / (0.3 * 3000)) * 1000000; // gallons
            const casVolFt3 = casVol / 7.481;
            const casHRT = casVol / (flow * 1000000) * 24;
            
            // MBBR assumptions: SALR=10 g/m¬≤/d, K3 500 m¬≤/m¬≥, 55% fill
            const loadGday = flow * bod * 3785.412;
            const reqArea = loadGday / 10;
            const mediaVol = reqArea / 500;
            const mbbrVol = mediaVol / 0.55;
            const mbbrVolGal = mbbrVol * 264.172;
            const mbbrVolFt3 = mbbrVol * 35.3147;
            const mbbrHRT = mbbrVol / (flow * 3785.412 / 24);
            
            const savings = ((1 - mbbrVolFt3 / casVolFt3) * 100);
            
            document.getElementById('cmp_res').innerText = "MBBR " + (savings > 0 ? savings.toFixed(0) + "% smaller" : Math.abs(savings).toFixed(0) + "% larger");
            const stat = document.getElementById('cmp_status');
            
            stat.innerHTML = "<b>‚îÅ‚îÅ CAS (Conventional) ‚îÅ‚îÅ</b>" +
                "<br>F:M=0.3 | MLSS=3,000 | SRT~10d" +
                "<br>Volume: " + (casVolFt3/1000).toFixed(1) + "k ft¬≥ (" + (casVol/1000).toFixed(0) + "k gal)" +
                "<br>HRT: " + casHRT.toFixed(1) + " hrs" +
                "<br><br><b>‚îÅ‚îÅ MBBR (Biofilm) ‚îÅ‚îÅ</b>" +
                "<br>SALR=10 g/m¬≤/d | K3 500 m¬≤/m¬≥ | 55% fill" +
                "<br>Volume: " + (mbbrVolFt3/1000).toFixed(1) + "k ft¬≥ (" + (mbbrVolGal/1000).toFixed(0) + "k gal)" +
                "<br>HRT: " + mbbrHRT.toFixed(1) + " hrs | Media: " + mediaVol.toFixed(0) + " m¬≥" +
                "<br><br>üîÑ <b>MBBR is " + Math.abs(savings).toFixed(0) + "% " + (savings > 0 ? "smaller" : "larger") + " footprint</b> than CAS for same load";
            stat.style.color = "#94a3b8";
        }
    }

    // ==================== SBR CALCULATIONS ====================

    // 28. SBR Cycle Time
    function calcCycle() {
        const fill = parseFloat(document.getElementById('cyc_fill').value) || 0;
        const react = parseFloat(document.getElementById('cyc_react').value) || 0;
        const settle = parseFloat(document.getElementById('cyc_settle').value) || 0;
        const decant = parseFloat(document.getElementById('cyc_decant').value) || 0;
        const idle = parseFloat(document.getElementById('cyc_idle').value) || 0;
        const flow = parseFloat(document.getElementById('cyc_flow').value) || 0;
        
        const total = fill + react + settle + decant + idle;
        
        if (total > 0) {
            const hrs = total / 60;
            const cyclesDay = 1440 / total;
            document.getElementById('cyc_res').innerText = hrs.toFixed(1) + " hrs | " + cyclesDay.toFixed(1) + " cycles/day";
            const stat = document.getElementById('cyc_status');
            
            const fillPct = (fill / total * 100).toFixed(0);
            const reactPct = (react / total * 100).toFixed(0);
            const settlePct = (settle / total * 100).toFixed(0);
            const decantPct = (decant / total * 100).toFixed(0);
            const idlePct = (idle / total * 100).toFixed(0);
            const aeratedPct = ((fill + react) / total * 100).toFixed(0);
            
            let info = "üìä <b>Phase Breakdown:</b>" +
                "<br>Fill: " + fill + " min (" + fillPct + "%) | React: " + react + " min (" + reactPct + "%)" +
                "<br>Settle: " + settle + " min (" + settlePct + "%) | Decant: " + decant + " min (" + decantPct + "%)" +
                (idle > 0 ? " | Idle: " + idle + " min (" + idlePct + "%)" : "") +
                "<br>Aeration duty: <b>" + aeratedPct + "%</b> of cycle";
            
            if (flow > 0) {
                const volPerCycle = (flow * 1000000) / cyclesDay;
                info += "<br>Fill volume: " + volPerCycle.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " gal/cycle (1 basin)";
            }
            
            let check = "";
            if (cyclesDay < 3) check = "<br>‚ö†Ô∏è Few cycles/day ‚Äî long cycle may limit peak flow capacity";
            else if (cyclesDay <= 6) check = "<br>‚úì " + cyclesDay.toFixed(1) + " cycles/day ‚Äî typical SBR operation";
            else check = "<br>‚ö° " + cyclesDay.toFixed(1) + " cycles/day ‚Äî short cycles, verify settle time is adequate";
            
            stat.innerHTML = info + check;
            stat.style.color = "#94a3b8";
        }
    }

    // 29. SBR Volume per Cycle
    function calcSBRVol() {
        const flow = parseFloat(document.getElementById('sv_flow').value) || 0;
        const cycles = parseFloat(document.getElementById('sv_cycles').value) || 0;
        const reactor = parseFloat(document.getElementById('sv_reactor').value) || 0;
        const basins = parseFloat(document.getElementById('sv_basins').value) || 1;
        
        if (flow > 0 && cycles > 0) {
            const dailyGal = flow * 1000000;
            const volPerCycle = dailyGal / (cycles * basins);
            const fmt = volPerCycle.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            document.getElementById('sv_res').innerText = fmt + " gal/cycle";
            const stat = document.getElementById('sv_status');
            
            let info = "üìä <b>" + fmt + " gal</b> per cycle per basin" +
                "<br>Daily: " + (dailyGal / 1000).toFixed(0) + "k gal across " + basins + " basin(s), " + cycles + " cycles";
            
            if (reactor > 0) {
                const fillRatio = (volPerCycle / reactor * 100);
                info += "<br>Fill ratio: <b>" + fillRatio.toFixed(1) + "%</b> of reactor volume";
                
                if (fillRatio < 15) {
                    info += " ‚Äî ‚ö° Low fill ratio. Reactor may be oversized.";
                } else if (fillRatio <= 35) {
                    info += " ‚Äî ‚úì Within design range (15‚Äì35%)";
                } else if (fillRatio <= 50) {
                    info += " ‚Äî ‚ö†Ô∏è High fill ratio. Limited freeboard.";
                } else {
                    info += " ‚Äî üö® Exceeds 50%! Risk of overflow. Reduce flow or add cycles.";
                }
            }
            
            stat.innerHTML = info;
            stat.style.color = "#94a3b8";
        }
    }

    // 30. SBR Decant Rate
    function calcDecant() {
        const vol = parseFloat(document.getElementById('dec_vol').value) || 0;
        const time = parseFloat(document.getElementById('dec_time').value) || 0;
        const weir = parseFloat(document.getElementById('dec_weir').value) || 0;
        
        if (vol > 0 && time > 0) {
            const gpm = vol / time;
            document.getElementById('dec_res').innerText = gpm.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPM";
            const stat = document.getElementById('dec_status');
            
            let info = "üìä <b>Decant rate:</b> " + gpm.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " GPM";
            
            if (weir > 0) {
                const weirRate = gpm / weir;
                info += "<br>Weir loading: <b>" + weirRate.toFixed(1) + " GPM/ft</b>";
                
                if (weirRate <= 5) {
                    info += " ‚Äî ‚úì Excellent. Low turbulence risk.";
                } else if (weirRate <= 10) {
                    info += " ‚Äî ‚úì Acceptable range (&lt;10 GPM/ft).";
                } else if (weirRate <= 15) {
                    info += " ‚Äî ‚ö†Ô∏è Elevated. May disturb settled solids.";
                } else {
                    info += " ‚Äî üö® Too high. Risk of solids carryover into effluent.";
                }
            }
            
            if (gpm < 500) info += "<br>‚ö° Low decant rate ‚Äî may extend cycle time unnecessarily";
            else if (gpm <= 4000) info += "<br>‚úì Decant rate within typical range (500‚Äì4,000 GPM)";
            else info += "<br>‚ö†Ô∏è High decant rate ‚Äî verify effluent TSS during decant";
            
            stat.innerHTML = info;
            stat.style.color = "#94a3b8";
        }
    }

    // 31. SBR Aeration Demand
    function calcSBRAer() {
        const flow = parseFloat(document.getElementById('saer_flow').value) || 0;
        const bod = parseFloat(document.getElementById('saer_bod').value) || 0;
        const nh3 = parseFloat(document.getElementById('saer_nh3').value) || 0;
        const duty = parseFloat(document.getElementById('saer_duty').value) || 0;
        
        if (flow > 0 && (bod > 0 || nh3 > 0)) {
            const o2bod = flow * bod * 8.34 * 1.5;
            const o2nh3 = flow * nh3 * 8.34 * 4.6;
            const dailyO2 = o2bod + o2nh3;
            
            document.getElementById('saer_res').innerText = dailyO2.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs O‚ÇÇ/day";
            const stat = document.getElementById('saer_status');
            
            let info = "üìä <b>Daily O‚ÇÇ demand:</b> " + dailyO2.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs/day" +
                "<br>BOD oxidation: " + o2bod.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs | Nitrification: " + o2nh3.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs";
            
            if (duty > 0) {
                const peakRate = dailyO2 / (duty / 100);
                const peakPerHr = peakRate / 24;
                const multiplier = (100 / duty);
                info += "<br><br>‚ö° <b>SBR Aeration Sizing:</b>" +
                    "<br>Duty cycle: " + duty + "% ‚Üí Blower must deliver <b>" + multiplier.toFixed(1) + "√ó</b> continuous rate" +
                    "<br>Peak delivery: <b>" + peakRate.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs/day equiv</b> (" + peakPerHr.toFixed(1) + " lbs/hr during aeration)";
            }
            
            stat.innerHTML = info;
            stat.style.color = "#94a3b8";
        }
    }

    // 32. SBR F:M per Cycle
    function calcSBRFM() {
        const fillVol = parseFloat(document.getElementById('sfm_fill').value) || 0;
        const bod = parseFloat(document.getElementById('sfm_bod').value) || 0;
        const reactorVol = parseFloat(document.getElementById('sfm_vol').value) || 0;
        const mlvss = parseFloat(document.getElementById('sfm_mlvss').value) || 0;
        const cycles = parseFloat(document.getElementById('sfm_cycles').value) || 0;
        
        if (fillVol > 0 && bod > 0 && reactorVol > 0 && mlvss > 0) {
            // Food per cycle (lbs)
            const fillMG = fillVol / 1000000;
            const foodPerCycle = fillMG * bod * 8.34;
            
            // Biomass in reactor (lbs)
            const reactorMG = reactorVol / 1000000;
            const biomass = reactorMG * mlvss * 8.34;
            
            // Instantaneous F:M at start of fill
            const instFM = foodPerCycle / biomass;
            
            // Daily F:M
            let dailyFM = 0;
            let dailyInfo = "";
            if (cycles > 0) {
                dailyFM = (foodPerCycle * cycles) / biomass;
                dailyInfo = "<br>Daily F:M: <b>" + dailyFM.toFixed(3) + "</b> (" + cycles + " cycles √ó " + foodPerCycle.toFixed(1) + " lbs food)";
            }
            
            document.getElementById('sfm_res').innerText = "Inst: " + instFM.toFixed(3) + " | Daily: " + dailyFM.toFixed(3);
            const stat = document.getElementById('sfm_status');
            
            let assessment = "";
            if (dailyFM > 0) {
                if (dailyFM < 0.04) assessment = "‚ö° Very low daily F:M ‚Äî endogenous conditions, possible pin floc";
                else if (dailyFM <= 0.15) assessment = "‚úì Daily F:M in typical SBR range (0.05‚Äì0.15)";
                else if (dailyFM <= 0.3) assessment = "‚ö†Ô∏è Elevated daily F:M ‚Äî more typical of CAS";
                else assessment = "üö® High F:M ‚Äî may need to increase MLSS or reduce loading";
            }
            
            stat.innerHTML = "üìä <b>Instantaneous F:M:</b> " + instFM.toFixed(3) + " (at start of fill)" +
                dailyInfo +
                "<br>Food/cycle: " + foodPerCycle.toFixed(1) + " lbs BOD | Biomass: " + biomass.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs" +
                "<br>" + assessment;
            stat.style.color = "#94a3b8";
        }
    }

    // 33. SBR Settle & Decant Check
    function calcSSC() {
        const depth = parseFloat(document.getElementById('ssc_depth').value) || 0;
        const sludgePct = parseFloat(document.getElementById('ssc_sludge').value) || 0;
        const decantDepth = parseFloat(document.getElementById('ssc_decant').value) || 0;
        const mlss = parseFloat(document.getElementById('ssc_mlss').value) || 0;
        
        if (depth > 0 && sludgePct > 0) {
            const blanketDepth = depth * (sludgePct / 100);
            const clearwater = depth - blanketDepth;
            const buffer = clearwater - decantDepth;
            
            let result = "";
            if (buffer >= 2) result = buffer.toFixed(1) + " ft buffer ‚úì";
            else if (buffer > 0) result = buffer.toFixed(1) + " ft buffer ‚ö†Ô∏è";
            else result = "NO BUFFER üö®";
            
            document.getElementById('ssc_res').innerText = result;
            const stat = document.getElementById('ssc_status');
            
            let svi = "";
            if (mlss > 0) {
                const sviVal = (sludgePct * 10000) / mlss;
                svi = "<br>Estimated SVI: <b>" + sviVal.toFixed(0) + " mL/g</b>";
                if (sviVal < 80) svi += " ‚Äî Excellent settling";
                else if (sviVal <= 150) svi += " ‚Äî Good settling";
                else if (sviVal <= 250) svi += " ‚Äî Fair settling, watch for filaments";
                else svi += " ‚Äî ‚ö†Ô∏è Poor settling, check for bulking";
            }
            
            let assessment = "";
            if (buffer >= 3) {
                assessment = "‚úì <b>Safe:</b> " + buffer.toFixed(1) + " ft buffer between blanket and decant zone. Good separation.";
                stat.style.color = "#4ade80";
            } else if (buffer >= 2) {
                assessment = "‚úì <b>Adequate:</b> " + buffer.toFixed(1) + " ft buffer. Minimum safe margin (‚â•2 ft).";
                stat.style.color = "#4ade80";
            } else if (buffer > 0) {
                assessment = "‚ö†Ô∏è <b>Tight:</b> Only " + buffer.toFixed(1) + " ft buffer. Risk of solids carryover. Consider longer settle or less decant depth.";
                stat.style.color = "var(--accent)";
            } else {
                assessment = "üö® <b>Solids Carryover Risk:</b> Blanket (" + blanketDepth.toFixed(1) + " ft) extends into decant zone! Reduce decant depth or increase settle time.";
                stat.style.color = "var(--danger)";
            }
            
            stat.innerHTML = "üìä Blanket: <b>" + blanketDepth.toFixed(1) + " ft</b> | Clear water: <b>" + clearwater.toFixed(1) + " ft</b> | Decant: <b>" + decantDepth.toFixed(1) + " ft</b>" +
                svi +
                "<br>" + assessment;
        }
    }

    // ==================== DISINFECTION CALCULATIONS ====================

    // 34. Chlorine CT
    function calcCT() {
        const residual = parseFloat(document.getElementById('ct_res_in').value) || 0;
        const time = parseFloat(document.getElementById('ct_time').value) || 0;
        const req = parseFloat(document.getElementById('ct_req').value) || 0;
        
        if (residual > 0 && time > 0) {
            const ct = residual * time;
            document.getElementById('ct_res').innerText = ct.toFixed(1) + " mg¬∑min/L";
            const stat = document.getElementById('ct_status');
            
            let info = "üìä CT = " + residual + " mg/L √ó " + time + " min = <b>" + ct.toFixed(1) + " mg¬∑min/L</b>";
            
            if (req > 0) {
                const ratio = (ct / req * 100).toFixed(0);
                if (ct >= req) {
                    info += "<br>‚úì <b>Compliant:</b> " + ratio + "% of required CT (" + req + " mg¬∑min/L)";
                    stat.style.color = "#4ade80";
                } else {
                    info += "<br>üö® <b>Non-compliant:</b> Only " + ratio + "% of required CT (" + req + "). Increase residual or contact time.";
                    stat.style.color = "var(--danger)";
                }
            }
            stat.innerHTML = info;
        }
    }

    // 35. Dechlorination
    function calcDCL() {
        const flow = parseFloat(document.getElementById('dcl_flow').value) || 0;
        const cl2 = parseFloat(document.getElementById('dcl_cl2').value) || 0;
        const sf = parseFloat(document.getElementById('dcl_sf').value) || 1.0;
        
        if (flow > 0 && cl2 > 0) {
            const so2 = flow * cl2 * 8.34 * 1.0 * sf;
            const nahso3 = flow * cl2 * 8.34 * 1.46 * sf;
            const na2so3 = flow * cl2 * 8.34 * 0.9 * sf;
            
            document.getElementById('dcl_res').innerText = so2.toFixed(1) + " lbs SO‚ÇÇ/day";
            const stat = document.getElementById('dcl_status');
            
            stat.innerHTML = "üìä <b>Chemical Options (SF=" + sf + "√ó):</b>" +
                "<br>SO‚ÇÇ (gas): <b>" + so2.toFixed(1) + " lbs/day</b>" +
                "<br>NaHSO‚ÇÉ (sodium bisulfite): <b>" + nahso3.toFixed(1) + " lbs/day</b> (" + (nahso3/8.34).toFixed(1) + " gal/day @ SG‚âà1.0)" +
                "<br>Na‚ÇÇSO‚ÇÉ (sodium sulfite): <b>" + na2so3.toFixed(1) + " lbs/day</b>" +
                "<br><br>Neutralizing " + cl2 + " mg/L residual at " + flow + " MGD";
            stat.style.color = "#94a3b8";
        }
    }

    // 36. UV Dose
    function calcUV() {
        const intensity = parseFloat(document.getElementById('uv_int').value) || 0;
        const time = parseFloat(document.getElementById('uv_time').value) || 0;
        const uvt = parseFloat(document.getElementById('uv_uvt').value) || 0;
        
        if (intensity > 0 && time > 0) {
            const dose = intensity * time;
            document.getElementById('uv_res').innerText = dose.toFixed(1) + " mJ/cm¬≤";
            const stat = document.getElementById('uv_status');
            
            let info = "üìä UV Dose = " + intensity + " mW/cm¬≤ √ó " + time + " sec = <b>" + dose.toFixed(1) + " mJ/cm¬≤</b>";
            
            if (dose >= 80) info += "<br>‚úì Adequate for reuse-quality disinfection (‚â•80 mJ/cm¬≤)";
            else if (dose >= 40) info += "<br>‚úì Adequate for E. coli/fecal compliance (‚â•40 mJ/cm¬≤)";
            else if (dose >= 30) info += "<br>‚ö†Ô∏è Minimum range ‚Äî may not meet permit during peak flow";
            else info += "<br>üö® Below typical TCEQ requirement. Increase intensity or exposure time.";
            
            if (uvt > 0) {
                info += "<br>UVT: <b>" + uvt + "%</b>";
                if (uvt >= 65) info += " ‚Äî ‚úì Good transmittance";
                else if (uvt >= 55) info += " ‚Äî ‚ö†Ô∏è Marginal. TSS or color may reduce effectiveness.";
                else info += " ‚Äî üö® Poor transmittance. Pre-treatment needed.";
            }
            
            stat.innerHTML = info;
            stat.style.color = "#94a3b8";
        }
    }

    // ==================== SLUDGE & BIOSOLIDS CALCULATIONS ====================

    // 37. Sludge Volume & % Solids
    function calcSLV() {
        const vol = parseFloat(document.getElementById('slv_vol').value) || 0;
        const pct = parseFloat(document.getElementById('slv_pct').value) || 0;
        
        if (vol > 0 && pct > 0) {
            const wetLbs = vol * 8.34;
            const dryLbs = wetLbs * (pct / 100);
            const dryTons = dryLbs / 2000;
            const ft3 = vol / 7.48;
            
            document.getElementById('slv_res').innerText = dryLbs.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " dry lbs/day";
            const stat = document.getElementById('slv_status');
            
            stat.innerHTML = "üìä <b>Sludge Summary:</b>" +
                "<br>Wet volume: " + vol.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " gal/day (" + ft3.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " ft¬≥)" +
                "<br>Wet weight: " + wetLbs.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs/day (" + (wetLbs/2000).toFixed(2) + " wet tons)" +
                "<br>Dry solids: <b>" + dryLbs.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs/day</b> (" + dryTons.toFixed(2) + " dry tons)" +
                "<br>At " + pct + "% solids | " + (100-pct).toFixed(1) + "% water";
            stat.style.color = "#94a3b8";
        }
    }

    // 38. Volatile Solids Reduction (Van Kleeck)
    function calcVSR() {
        const vsIn = parseFloat(document.getElementById('vsr_in').value) || 0;
        const vsOut = parseFloat(document.getElementById('vsr_out').value) || 0;
        
        if (vsIn > 0 && vsOut > 0 && vsIn > vsOut) {
            const inDec = vsIn / 100;
            const outDec = vsOut / 100;
            const vsr = ((inDec - outDec) / (inDec - (inDec * outDec))) * 100;
            
            document.getElementById('vsr_res').innerText = vsr.toFixed(1) + " %";
            const stat = document.getElementById('vsr_status');
            
            let assessment = "";
            if (vsr >= 50) { assessment = "‚úì <b>Excellent:</b> Healthy digester performance (‚â•50%)"; stat.style.color = "#4ade80"; }
            else if (vsr >= 38) { assessment = "‚úì <b>Meets Class B:</b> ‚â•38% VS reduction (VAR Option 1)"; stat.style.color = "#4ade80"; }
            else { assessment = "üö® <b>Below 38%:</b> Does NOT meet Class B vector attraction reduction. Check digester operation."; stat.style.color = "var(--danger)"; }
            
            stat.innerHTML = "üìä Van Kleeck VSR: <b>" + vsr.toFixed(1) + "%</b>" +
                "<br>Influent VS: " + vsIn + "% ‚Üí Effluent VS: " + vsOut + "%" +
                "<br>" + assessment;
        }
    }

    // 39. Digester Loading Rate
    function calcDIG() {
        const flow = parseFloat(document.getElementById('dig_flow').value) || 0;
        const pct = parseFloat(document.getElementById('dig_pct').value) || 0;
        const vs = parseFloat(document.getElementById('dig_vs').value) || 0;
        const vol = parseFloat(document.getElementById('dig_vol').value) || 0;
        
        if (flow > 0 && pct > 0 && vs > 0 && vol > 0) {
            const vsLbs = flow * 8.34 * (pct / 100) * (vs / 100);
            const loading = vsLbs / vol;
            
            document.getElementById('dig_res').innerText = loading.toFixed(3) + " lbs VS/ft¬≥/d";
            const stat = document.getElementById('dig_status');
            
            let assessment = "";
            if (loading <= 0.05) { assessment = "‚úì Low-rate digester range (0.03‚Äì0.05)"; stat.style.color = "#4ade80"; }
            else if (loading <= 0.10) { assessment = "‚úì Moderate loading ‚Äî transitional range"; stat.style.color = "#4ade80"; }
            else if (loading <= 0.20) { assessment = "‚úì High-rate digester range (0.10‚Äì0.20)"; stat.style.color = "#4ade80"; }
            else { assessment = "üö® <b>Overloaded!</b> Risk of VFA buildup and pH crash. Reduce feed rate."; stat.style.color = "var(--danger)"; }
            
            stat.innerHTML = "üìä VS feed: <b>" + vsLbs.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs VS/day</b>" +
                "<br>Loading: <b>" + loading.toFixed(3) + " lbs VS/ft¬≥/day</b>" +
                "<br>HRT: " + (vol * 7.48 / flow).toFixed(0) + " days" +
                "<br>" + assessment;
        }
    }

    // 40. Polymer Dosing
    function calcPoly() {
        const flow = parseFloat(document.getElementById('poly_flow').value) || 0;
        const pct = parseFloat(document.getElementById('poly_pct').value) || 0;
        const rate = parseFloat(document.getElementById('poly_rate').value) || 0;
        const conc = parseFloat(document.getElementById('poly_conc').value) || 0;
        
        if (flow > 0 && pct > 0 && rate > 0 && conc > 0) {
            const activeLbsHr = rate * 8.34 * (conc / 100);
            const activeLbsDay = activeLbsHr * 24;
            const dryTonsDay = (flow * 60 * 8.34 * (pct / 100) * 24) / 2000;
            const lbsPerDT = activeLbsDay / dryTonsDay;
            
            document.getElementById('poly_res').innerText = lbsPerDT.toFixed(1) + " lbs active/DT";
            const stat = document.getElementById('poly_status');
            
            let assessment = "";
            if (lbsPerDT <= 4) { assessment = "‚úì Low polymer usage ‚Äî cost effective"; stat.style.color = "#4ade80"; }
            else if (lbsPerDT <= 8) { assessment = "‚úì Typical belt press range (3‚Äì8 lbs/DT)"; stat.style.color = "#4ade80"; }
            else if (lbsPerDT <= 12) { assessment = "‚ö†Ô∏è Typical centrifuge range (5‚Äì12) ‚Äî high for belt press"; stat.style.color = "var(--accent)"; }
            else { assessment = "üö® Excessive polymer. Check conditioning, sludge age, or polymer type."; stat.style.color = "var(--danger)"; }
            
            stat.innerHTML = "üìä <b>Polymer Usage:</b>" +
                "<br>Active polymer: " + activeLbsDay.toFixed(1) + " lbs/day (" + activeLbsHr.toFixed(2) + " lbs/hr)" +
                "<br>Dry solids: " + dryTonsDay.toFixed(2) + " DT/day" +
                "<br>Dosage: <b>" + lbsPerDT.toFixed(1) + " lbs active polymer per dry ton</b>" +
                "<br>" + assessment;
        }
    }

    // ==================== NUTRIENT REMOVAL CALCULATIONS ====================

    // 41. Phosphorus Removal
    function calcPhos() {
        const flow = parseFloat(document.getElementById('phos_flow').value) || 0;
        const pIn = parseFloat(document.getElementById('phos_in').value) || 0;
        const pOut = parseFloat(document.getElementById('phos_out').value) || 0;
        const ratio = parseFloat(document.getElementById('phos_ratio').value) || 0;
        
        if (flow > 0 && pIn > pOut && ratio > 0) {
            const deltaP = pIn - pOut;
            // Alum: Al needed = deltaP √ó ratio √ó (27/31), then alum = Al √ó (594/(2√ó27))
            const alDose = deltaP * ratio * (27/31); // mg/L as Al
            const alumDose = alDose * (594 / 54); // mg/L as alum (Al2(SO4)3¬∑14H2O)
            const alumLbs = flow * alumDose * 8.34;
            // Ferric: Fe needed = deltaP √ó ratio √ó (55.85/31)
            const feDose = deltaP * ratio * (55.85/31);
            const fecl3Dose = feDose * (162.2/55.85);
            const fecl3Lbs = flow * fecl3Dose * 8.34;
            
            document.getElementById('phos_res').innerText = "Alum: " + alumLbs.toFixed(0) + " | FeCl‚ÇÉ: " + fecl3Lbs.toFixed(0) + " lbs/day";
            const stat = document.getElementById('phos_status');
            
            stat.innerHTML = "üìä Removing <b>" + deltaP.toFixed(1) + " mg/L P</b> at " + ratio + ":1 molar ratio" +
                "<br><br>üß™ <b>Alum (Al‚ÇÇ(SO‚ÇÑ)‚ÇÉ¬∑14H‚ÇÇO):</b>" +
                "<br>Dose: " + alumDose.toFixed(1) + " mg/L ‚Üí <b>" + alumLbs.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs/day</b>" +
                " (" + (alumLbs / (8.34 * 1.33)).toFixed(0) + " gal/day @ 48% liquid)" +
                "<br><br>üß™ <b>Ferric Chloride (FeCl‚ÇÉ):</b>" +
                "<br>Dose: " + fecl3Dose.toFixed(1) + " mg/L ‚Üí <b>" + fecl3Lbs.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " lbs/day</b>" +
                " (" + (fecl3Lbs / (8.34 * 1.42)).toFixed(0) + " gal/day @ 42% liquid)";
            stat.style.color = "#94a3b8";
        }
    }

    // 42. Alkalinity & Nitrification
    function calcALK() {
        const alkIn = parseFloat(document.getElementById('alk_in').value) || 0;
        const nh3 = parseFloat(document.getElementById('alk_nh3').value) || 0;
        const flow = parseFloat(document.getElementById('alk_flow').value) || 0;
        
        if (alkIn > 0 && nh3 > 0) {
            const consumed = nh3 * 7.14;
            const remaining = alkIn - consumed;
            
            document.getElementById('alk_res').innerText = remaining.toFixed(0) + " mg/L remaining";
            const stat = document.getElementById('alk_status');
            
            let assessment = "";
            let supplement = "";
            if (remaining >= 100) { assessment = "‚úì <b>Adequate alkalinity buffer.</b> No supplement needed."; stat.style.color = "#4ade80"; }
            else if (remaining >= 50) { assessment = "‚ö†Ô∏è <b>Low buffer.</b> Monitor pH closely. Consider supplemental alkalinity."; stat.style.color = "var(--accent)"; }
            else {
                assessment = "üö® <b>Insufficient alkalinity!</b> Nitrification will crash. Supplement required.";
                stat.style.color = "var(--danger)";
            }
            
            if (remaining < 80 && flow > 0) {
                const deficit = 80 - remaining; // target 80 mg/L remaining
                const limeLbs = flow * deficit * 8.34 / 1.35; // lime effectiveness
                supplement = "<br><br>üíä To reach 80 mg/L remaining:" +
                    "<br>Lime (CaO): ~" + limeLbs.toFixed(0) + " lbs/day" +
                    "<br>Soda Ash (Na‚ÇÇCO‚ÇÉ): ~" + (flow * deficit * 8.34 / 1.06).toFixed(0) + " lbs/day";
            }
            
            stat.innerHTML = "üìä Alkalinity consumed: <b>" + consumed.toFixed(0) + " mg/L</b> (from " + nh3 + " mg/L NH‚ÇÉ-N)" +
                "<br>Influent: " + alkIn + " mg/L ‚Üí Remaining: <b>" + remaining.toFixed(0) + " mg/L</b>" +
                "<br>" + assessment + supplement;
        }
    }

    // 43. Nitrogen Balance
    function calcNBal() {
        const tkn = parseFloat(document.getElementById('nb_tkn').value) || 0;
        const nh3 = parseFloat(document.getElementById('nb_nh3').value) || 0;
        const no3 = parseFloat(document.getElementById('nb_no3').value) || 0;
        const bio = parseFloat(document.getElementById('nb_bio').value) || 0;
        
        if (tkn > 0) {
            const nitrified = tkn - nh3 - bio; // ammonia that was nitrified
            const denitrified = nitrified - no3; // nitrate that was denitrified (removed as N2)
            const effTN = nh3 + no3;
            const removalPct = ((tkn - effTN) / tkn * 100);
            
            document.getElementById('nb_res').innerText = "Eff TN: " + effTN.toFixed(1) + " mg/L | " + removalPct.toFixed(0) + "% removal";
            const stat = document.getElementById('nb_status');
            
            stat.innerHTML = "üìä <b>Nitrogen Fate:</b>" +
                "<br>Influent TKN: <b>" + tkn + " mg/L</b>" +
                "<br>‚Üí Nitrified (NH‚ÇÉ‚ÜíNO‚ÇÉ): " + Math.max(0, nitrified).toFixed(1) + " mg/L" +
                "<br>‚Üí Denitrified (NO‚ÇÉ‚ÜíN‚ÇÇ‚Üë): <b>" + Math.max(0, denitrified).toFixed(1) + " mg/L</b> (removed as gas)" +
                "<br>‚Üí Biomass uptake: " + bio + " mg/L" +
                "<br>‚Üí Effluent NH‚ÇÉ: " + nh3 + " mg/L | Effluent NO‚ÇÉ: " + no3 + " mg/L" +
                "<br><br>üìã <b>Effluent TN: " + effTN.toFixed(1) + " mg/L</b> (" + removalPct.toFixed(0) + "% total N removal)" +
                (denitrified < 0 ? "<br>‚ö†Ô∏è Negative denitrification ‚Äî check TKN/NO‚ÇÉ values" : "");
            stat.style.color = "#94a3b8";
        }
    }

    // ==================== HYDRAULICS & PUMPING CALCULATIONS ====================

    // 44. Total Dynamic Head
    function calcTDH() {
        const stat_h = parseFloat(document.getElementById('tdh_static').value) || 0;
        const friction = parseFloat(document.getElementById('tdh_friction').value) || 0;
        const vel = parseFloat(document.getElementById('tdh_vel').value) || 0;
        
        const tdh = stat_h + friction + vel;
        if (tdh > 0) {
            const psi = tdh / 2.31;
            document.getElementById('tdh_res').innerText = tdh.toFixed(1) + " ft (" + psi.toFixed(1) + " psi)";
            const stat = document.getElementById('tdh_status');
            
            stat.innerHTML = "üìä Static: " + stat_h + " ft + Friction: " + friction + " ft + Velocity: " + vel + " ft" +
                "<br>TDH = <b>" + tdh.toFixed(1) + " ft</b> = <b>" + psi.toFixed(1) + " psi</b> = " + (tdh * 0.3048).toFixed(2) + " m" +
                "<br>Friction is " + (friction / tdh * 100).toFixed(0) + "% of total head";
            stat.style.color = "#94a3b8";
        }
    }

    // 45. Pipe Velocity
    function calcPV() {
        const flow = parseFloat(document.getElementById('pv_flow').value) || 0;
        const dia = parseFloat(document.getElementById('pv_dia').value) || 0;
        
        if (flow > 0 && dia > 0) {
            const area = Math.PI * Math.pow(dia/2, 2); // in¬≤
            const cfs = flow / 448.83;
            const fps = cfs / (area / 144); // convert in¬≤ to ft¬≤
            
            document.getElementById('pv_res').innerText = fps.toFixed(2) + " fps";
            const stat = document.getElementById('pv_status');
            
            let assessment = "";
            if (fps < 2) { assessment = "üö® <b>Too slow:</b> Solids will settle and accumulate. Increase flow or reduce pipe size."; stat.style.color = "var(--danger)"; }
            else if (fps <= 5) { assessment = "‚úì <b>Good:</b> Adequate self-cleaning velocity."; stat.style.color = "#4ade80"; }
            else if (fps <= 8) { assessment = "‚úì <b>Normal range</b> for force mains and pressure pipe."; stat.style.color = "#4ade80"; }
            else if (fps <= 10) { assessment = "‚ö†Ô∏è <b>Elevated:</b> Approaching maximum recommended velocity."; stat.style.color = "var(--accent)"; }
            else { assessment = "üö® <b>Too fast:</b> Risk of pipe erosion, water hammer, and excessive friction loss."; stat.style.color = "var(--danger)"; }
            
            stat.innerHTML = "üìä " + flow + " GPM through " + dia + "\" pipe = <b>" + fps.toFixed(2) + " fps</b>" +
                "<br>Flow: " + cfs.toFixed(3) + " CFS | Pipe area: " + (area/144).toFixed(4) + " ft¬≤" +
                "<br>" + assessment;
        }
    }

    // 46. Horsepower
    function calcHP() {
        const flow = parseFloat(document.getElementById('hp_flow').value) || 0;
        const tdh = parseFloat(document.getElementById('hp_tdh').value) || 0;
        const pEff = parseFloat(document.getElementById('hp_eff').value) || 75;
        const mEff = parseFloat(document.getElementById('hp_meff').value) || 90;
        
        if (flow > 0 && tdh > 0) {
            const whp = (flow * tdh) / 3960;
            const bhp = whp / (pEff / 100);
            const mhp = bhp / (mEff / 100);
            const kw = mhp * 0.746;
            
            document.getElementById('hp_res').innerText = "WHP: " + whp.toFixed(2) + " | BHP: " + bhp.toFixed(2);
            const stat = document.getElementById('hp_status');
            
            stat.innerHTML = "üìä <b>Power Chain:</b>" +
                "<br>Water HP: <b>" + whp.toFixed(2) + " HP</b> (theoretical minimum)" +
                "<br>Brake HP: <b>" + bhp.toFixed(2) + " HP</b> (pump " + pEff + "% eff)" +
                "<br>Motor HP: <b>" + mhp.toFixed(2) + " HP</b> (motor " + mEff + "% eff)" +
                "<br>Power draw: <b>" + kw.toFixed(2) + " kW</b>" +
                "<br><br>üí∞ Est. energy cost: $" + (kw * 24 * 0.10).toFixed(2) + "/day @ $0.10/kWh (" + (kw * 24 * 30 * 0.10).toFixed(0) + "/month)";
            stat.style.color = "#94a3b8";
        }
    }

    // ==================== COMPLIANCE & REPORTING CALCULATIONS ====================

    // 47. Geometric Mean
    function calcGM() {
        const samples = [];
        for (let i = 1; i <= 7; i++) {
            const v = parseFloat(document.getElementById('gm_s' + i).value);
            if (v > 0) samples.push(v);
        }
        
        if (samples.length >= 2) {
            const logSum = samples.reduce((sum, v) => sum + Math.log(v), 0);
            const geoMean = Math.exp(logSum / samples.length);
            const arithMean = samples.reduce((s, v) => s + v, 0) / samples.length;
            
            document.getElementById('gm_res').innerText = geoMean.toFixed(1) + " CFU/100mL";
            const stat = document.getElementById('gm_status');
            
            let ecoliCheck = "";
            if (geoMean <= 126) ecoliCheck = "<br>‚úì E. coli: <b>PASS</b> (‚â§126 CFU/100mL)";
            else ecoliCheck = "<br>üö® E. coli: <b>FAIL</b> (>126 CFU/100mL)";
            
            let fecalCheck = "";
            if (geoMean <= 200) fecalCheck = "<br>‚úì Fecal coliform: <b>PASS</b> (‚â§200 CFU/100mL)";
            else fecalCheck = "<br>üö® Fecal coliform: <b>FAIL</b> (>200 CFU/100mL)";
            
            stat.innerHTML = "üìä <b>Geometric Mean: " + geoMean.toFixed(1) + "</b> from " + samples.length + " samples" +
                "<br>Arithmetic mean: " + arithMean.toFixed(1) + " (not used for DMR)" +
                "<br>Values: " + samples.join(", ") +
                ecoliCheck + fecalCheck;
            stat.style.color = "#94a3b8";
        }
    }

    // 48. Flow-Weighted Composite
    function calcFWC() {
        let sumFC = 0, sumF = 0, pairs = 0;
        for (let i = 1; i <= 4; i++) {
            const f = parseFloat(document.getElementById('fw_f' + i).value);
            const c = parseFloat(document.getElementById('fw_c' + i).value);
            if (f > 0 && c >= 0) {
                sumFC += f * c;
                sumF += f;
                pairs++;
            }
        }
        
        if (pairs >= 2 && sumF > 0) {
            const fwAvg = sumFC / sumF;
            document.getElementById('fw_res').innerText = fwAvg.toFixed(2) + " mg/L";
            const stat = document.getElementById('fw_status');
            
            let detail = "";
            for (let i = 1; i <= 4; i++) {
                const f = parseFloat(document.getElementById('fw_f' + i).value);
                const c = parseFloat(document.getElementById('fw_c' + i).value);
                if (f > 0 && c >= 0) {
                    const weight = (f / sumF * 100).toFixed(0);
                    detail += "<br>Sample " + i + ": " + f + " MGD √ó " + c + " mg/L (weight: " + weight + "%)";
                }
            }
            
            // Arithmetic mean for comparison
            let simpleSum = 0, cnt = 0;
            for (let i = 1; i <= 4; i++) {
                const c = parseFloat(document.getElementById('fw_c' + i).value);
                if (c >= 0 && parseFloat(document.getElementById('fw_f' + i).value) > 0) { simpleSum += c; cnt++; }
            }
            const arith = simpleSum / cnt;
            
            stat.innerHTML = "üìä <b>Flow-Weighted Average: " + fwAvg.toFixed(2) + " mg/L</b>" +
                "<br>Simple average: " + arith.toFixed(2) + " mg/L (difference: " + (fwAvg - arith).toFixed(2) + ")" +
                detail +
                "<br><br>Total flow: " + sumF.toFixed(2) + " MGD across " + pairs + " samples";
            stat.style.color = "#94a3b8";
        }
    }

    // ==================== UNIT CONVERTER ====================

    // 49. Unit Converter
    function calcUC(source) {
        const stat = document.getElementById('uc_status');
        
        // Flow conversions
        if (['gpm','mgd','cfs','m3d'].includes(source)) {
            let mgd = 0;
            if (source === 'gpm') mgd = (parseFloat(document.getElementById('uc_gpm').value) || 0) * 0.00144;
            else if (source === 'mgd') mgd = parseFloat(document.getElementById('uc_mgd').value) || 0;
            else if (source === 'cfs') mgd = (parseFloat(document.getElementById('uc_cfs').value) || 0) * 0.6464;
            else if (source === 'm3d') mgd = (parseFloat(document.getElementById('uc_m3d').value) || 0) / 3785.41;
            
            if (source !== 'gpm') document.getElementById('uc_gpm').value = (mgd / 0.00144).toFixed(2);
            if (source !== 'mgd') document.getElementById('uc_mgd').value = mgd.toFixed(6);
            if (source !== 'cfs') document.getElementById('uc_cfs').value = (mgd / 0.6464).toFixed(4);
            if (source !== 'm3d') document.getElementById('uc_m3d').value = (mgd * 3785.41).toFixed(2);
            stat.innerHTML = "‚úì Flow converted";
        }
        
        // Volume conversions
        if (['gal','ft3','m3','acft'].includes(source)) {
            let gal = 0;
            if (source === 'gal') gal = parseFloat(document.getElementById('uc_gal').value) || 0;
            else if (source === 'ft3') gal = (parseFloat(document.getElementById('uc_ft3').value) || 0) * 7.48052;
            else if (source === 'm3') gal = (parseFloat(document.getElementById('uc_m3').value) || 0) * 264.172;
            else if (source === 'acft') gal = (parseFloat(document.getElementById('uc_acft').value) || 0) * 325851;
            
            if (source !== 'gal') document.getElementById('uc_gal').value = gal.toFixed(2);
            if (source !== 'ft3') document.getElementById('uc_ft3').value = (gal / 7.48052).toFixed(2);
            if (source !== 'm3') document.getElementById('uc_m3').value = (gal / 264.172).toFixed(4);
            if (source !== 'acft') document.getElementById('uc_acft').value = (gal / 325851).toFixed(6);
            stat.innerHTML = "‚úì Volume converted";
        }
        
        // Pressure conversions
        if (['psi','fth2o','kpa'].includes(source)) {
            let psi = 0;
            if (source === 'psi') psi = parseFloat(document.getElementById('uc_psi').value) || 0;
            else if (source === 'fth2o') psi = (parseFloat(document.getElementById('uc_fth2o').value) || 0) / 2.31;
            else if (source === 'kpa') psi = (parseFloat(document.getElementById('uc_kpa').value) || 0) / 6.895;
            
            if (source !== 'psi') document.getElementById('uc_psi').value = psi.toFixed(4);
            if (source !== 'fth2o') document.getElementById('uc_fth2o').value = (psi * 2.31).toFixed(4);
            if (source !== 'kpa') document.getElementById('uc_kpa').value = (psi * 6.895).toFixed(4);
            stat.innerHTML = "‚úì Pressure converted";
        }
        
        stat.style.color = "#4ade80";
    }

    // ==================== PWA ====================
    let deferredPrompt;
    
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .catch(err => console.log('SW error:', err));
        });
    }

    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        document.getElementById('installPrompt').style.display = 'flex';
    });

    function installApp() {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then(() => {
                deferredPrompt = null;
                document.getElementById('installPrompt').style.display = 'none';
            });
        }
    }

    function dismissInstall() {
        document.getElementById('installPrompt').style.display = 'none';
    }

    // Refresh app - clear cache and reload
    function refreshApp() {
        showToast('Checking for updates...', '');
        vibrate();
        
        if ('serviceWorker' in navigator && 'caches' in window) {
            // Clear all caches
            caches.keys().then(names => {
                names.forEach(name => caches.delete(name));
            });
            
            // Unregister service worker and reload
            navigator.serviceWorker.getRegistrations().then(registrations => {
                registrations.forEach(registration => registration.unregister());
            }).then(() => {
                setTimeout(() => {
                    window.location.reload(true);
                }, 500);
            });
        } else {
            window.location.reload(true);
        }
    }

    // ==================== INIT ====================
    window.addEventListener('load', () => {
        restoreData();
        updateNav();
    });
</script>
</body>
</html>
